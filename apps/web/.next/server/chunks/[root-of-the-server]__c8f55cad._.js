module.exports=[60438,(e,t,r)=>{t.exports=e.x("perf_hooks",()=>require("perf_hooks"))},363890,(e,t,r)=>{t.exports=e.x("stream/web",()=>require("stream/web"))},150040,(e,t,r)=>{"use strict";let a="undefined"!=typeof Buffer,s=/"(?:_|\\u005[Ff])(?:_|\\u005[Ff])(?:p|\\u0070)(?:r|\\u0072)(?:o|\\u006[Ff])(?:t|\\u0074)(?:o|\\u006[Ff])(?:_|\\u005[Ff])(?:_|\\u005[Ff])"\s*:/,n=/"(?:c|\\u0063)(?:o|\\u006[Ff])(?:n|\\u006[Ee])(?:s|\\u0073)(?:t|\\u0074)(?:r|\\u0072)(?:u|\\u0075)(?:c|\\u0063)(?:t|\\u0074)(?:o|\\u006[Ff])(?:r|\\u0072)"\s*:/;function i(e,t,r){null==r&&null!==t&&"object"==typeof t&&(r=t,t=void 0),a&&Buffer.isBuffer(e)&&(e=e.toString()),e&&65279===e.charCodeAt(0)&&(e=e.slice(1));let i=JSON.parse(e,t);if(null===i||"object"!=typeof i)return i;let l=r&&r.protoAction||"error",u=r&&r.constructorAction||"error";if("ignore"===l&&"ignore"===u)return i;if("ignore"!==l&&"ignore"!==u){if(!1===s.test(e)&&!1===n.test(e))return i}else if("ignore"!==l&&"ignore"===u){if(!1===s.test(e))return i}else if(!1===n.test(e))return i;return o(i,{protoAction:l,constructorAction:u,safe:r&&r.safe})}function o(e,{protoAction:t="error",constructorAction:r="error",safe:a}={}){let s=[e];for(;s.length;){let e=s;for(let n of(s=[],e)){if("ignore"!==t&&Object.prototype.hasOwnProperty.call(n,"__proto__")){if(!0===a)return null;if("error"===t)throw SyntaxError("Object contains forbidden prototype property");delete n.__proto__}if("ignore"!==r&&Object.prototype.hasOwnProperty.call(n,"constructor")&&Object.prototype.hasOwnProperty.call(n.constructor,"prototype")){if(!0===a)return null;if("error"===r)throw SyntaxError("Object contains forbidden prototype property");delete n.constructor}for(let e in n){let t=n[e];t&&"object"==typeof t&&s.push(t)}}}return e}function l(e,t,r){let a=Error.stackTraceLimit;Error.stackTraceLimit=0;try{return i(e,t,r)}finally{Error.stackTraceLimit=a}}t.exports=l,t.exports.default=l,t.exports.parse=l,t.exports.safeParse=function(e,t){let r=Error.stackTraceLimit;Error.stackTraceLimit=0;try{return i(e,t,{safe:!0})}catch(e){return null}finally{Error.stackTraceLimit=r}},t.exports.scan=o},493661,(e,t,r)=>{let a="object"==typeof performance&&performance&&"function"==typeof performance.now?performance:Date,s=()=>a.now(),n=e=>e===1/0||e&&e===Math.floor(e)&&e>0&&isFinite(e);class i{constructor({max:e=1/0,ttl:t,updateAgeOnGet:r=!1,checkAgeOnGet:a=!1,noUpdateTTL:s=!1,dispose:i,noDisposeOnSet:o=!1}={}){if(this.expirations=Object.create(null),this.data=new Map,this.expirationMap=new Map,void 0!==t&&!n(t))throw TypeError("ttl must be positive integer or Infinity if set");if(!n(e))throw TypeError("max must be positive integer or Infinity");if(this.ttl=t,this.max=e,this.updateAgeOnGet=!!r,this.checkAgeOnGet=!!a,this.noUpdateTTL=!!s,this.noDisposeOnSet=!!o,void 0!==i){if("function"!=typeof i)throw TypeError("dispose must be function if set");this.dispose=i}this.timer=void 0,this.timerExpiration=void 0}setTimer(e,t){if(this.timerExpiration<e)return;this.timer&&clearTimeout(this.timer);let r=setTimeout(()=>{for(let e in this.timer=void 0,this.timerExpiration=void 0,this.purgeStale(),this.expirations){this.setTimer(e,e-s());break}},t);r.unref&&r.unref(),this.timerExpiration=e,this.timer=r}cancelTimer(){this.timer&&(clearTimeout(this.timer),this.timerExpiration=void 0,this.timer=void 0)}cancelTimers(){return process.emitWarning('TTLCache.cancelTimers has been renamed to TTLCache.cancelTimer (no "s"), and will be removed in the next major version update'),this.cancelTimer()}clear(){let e=this.dispose!==i.prototype.dispose?[...this]:[];for(let[t,r]of(this.data.clear(),this.expirationMap.clear(),this.cancelTimer(),this.expirations=Object.create(null),e))this.dispose(r,t,"delete")}setTTL(e,t=this.ttl){let r=this.expirationMap.get(e);if(void 0!==r){let t=this.expirations[r];!t||t.length<=1?delete this.expirations[r]:this.expirations[r]=t.filter(t=>t!==e)}if(t!==1/0){let r=Math.floor(s()+t);this.expirationMap.set(e,r),this.expirations[r]||(this.expirations[r]=[],this.setTimer(r,t)),this.expirations[r].push(e)}else this.expirationMap.set(e,1/0)}set(e,t,{ttl:r=this.ttl,noUpdateTTL:a=this.noUpdateTTL,noDisposeOnSet:s=this.noDisposeOnSet}={}){if(!n(r))throw TypeError("ttl must be positive integer or Infinity");if(this.expirationMap.has(e)){a||this.setTTL(e,r);let n=this.data.get(e);n!==t&&(this.data.set(e,t),s||this.dispose(n,e,"set"))}else this.setTTL(e,r),this.data.set(e,t);for(;this.size>this.max;)this.purgeToCapacity();return this}has(e){return this.data.has(e)}getRemainingTTL(e){let t=this.expirationMap.get(e);return t===1/0?t:void 0!==t?Math.max(0,Math.ceil(t-s())):0}get(e,{updateAgeOnGet:t=this.updateAgeOnGet,ttl:r=this.ttl,checkAgeOnGet:a=this.checkAgeOnGet}={}){let s=this.data.get(e);return a&&0===this.getRemainingTTL(e)?void this.delete(e):(t&&this.setTTL(e,r),s)}dispose(e,t){}delete(e){let t=this.expirationMap.get(e);if(void 0!==t){let r=this.data.get(e);this.data.delete(e),this.expirationMap.delete(e);let a=this.expirations[t];return a&&(a.length<=1?delete this.expirations[t]:this.expirations[t]=a.filter(t=>t!==e)),this.dispose(r,e,"delete"),0===this.size&&this.cancelTimer(),!0}return!1}purgeToCapacity(){for(let e in this.expirations){let t=this.expirations[e];if(this.size-t.length>=this.max){delete this.expirations[e];let r=[];for(let e of t)r.push([e,this.data.get(e)]),this.data.delete(e),this.expirationMap.delete(e);for(let[e,t]of r)this.dispose(t,e,"evict")}else{let e=this.size-this.max,r=[];for(let a of t.splice(0,e))r.push([a,this.data.get(a)]),this.data.delete(a),this.expirationMap.delete(a);for(let[e,t]of r)this.dispose(t,e,"evict");return}}}get size(){return this.data.size}purgeStale(){let e=Math.ceil(s());for(let t in this.expirations){if("Infinity"===t||t>e)return;let r=[...this.expirations[t]||[]],a=[];for(let e of(delete this.expirations[t],r))a.push([e,this.data.get(e)]),this.data.delete(e),this.expirationMap.delete(e);for(let[e,t]of a)this.dispose(t,e,"stale")}0===this.size&&this.cancelTimer()}*entries(){for(let e in this.expirations)for(let t of this.expirations[e])yield[t,this.data.get(t)]}*keys(){for(let e in this.expirations)for(let t of this.expirations[e])yield t}*values(){for(let e in this.expirations)for(let t of this.expirations[e])yield this.data.get(t)}[Symbol.iterator](){return this.entries()}}t.exports=i},483938,(e,t,r)=>{"use strict";var a=Object.defineProperty,s=Object.getOwnPropertyDescriptor,n=Object.getOwnPropertyNames,i=Object.prototype.hasOwnProperty,o={},l={SYMBOL_FOR_REQ_CONTEXT:()=>d,getContext:()=>p};for(var u in l)a(o,u,{get:l[u],enumerable:!0});t.exports=((e,t,r,o)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let l of n(t))i.call(e,l)||l===r||a(e,l,{get:()=>t[l],enumerable:!(o=s(t,l))||o.enumerable});return e})(a({},"__esModule",{value:!0}),o);let d=Symbol.for("@vercel/request-context");function p(){let e=globalThis;return e[d]?.get?.()??{}}},890229,(e,t,r)=>{"use strict";var a=Object.defineProperty,s=Object.getOwnPropertyDescriptor,n=Object.getOwnPropertyNames,i=Object.prototype.hasOwnProperty,o={},l={getVercelOidcToken:()=>c,getVercelOidcTokenSync:()=>h};for(var u in l)a(o,u,{get:l[u],enumerable:!0});t.exports=((e,t,r,o)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let l of n(t))i.call(e,l)||l===r||a(e,l,{get:()=>t[l],enumerable:!(o=s(t,l))||o.enumerable});return e})(a({},"__esModule",{value:!0}),o);var d=e.r(483938),p=e.r(484199);async function c(){let t,r="";try{r=h()}catch(e){t=e}try{let[{getTokenPayload:t,isExpired:a},{refreshToken:s}]=await Promise.all([await e.A(967030),await e.A(683671)]);(!r||a(t(r)))&&(await s(),r=h())}catch(e){throw t?.message&&e instanceof Error&&(e.message=`${t.message}
${e.message}`),new p.VercelOidcTokenError("Failed to refresh OIDC token",e)}return r}function h(){let e=(0,d.getContext)().headers?.["x-vercel-oidc-token"]??process.env.VERCEL_OIDC_TOKEN;if(!e)throw Error("The 'x-vercel-oidc-token' header is missing from the request. Do you have the OIDC option enabled in the Vercel project settings?");return e}},190536,(e,t,r)=>{"use strict";var a=Object.defineProperty,s=Object.getOwnPropertyDescriptor,n=Object.getOwnPropertyNames,i=Object.prototype.hasOwnProperty,o={},l={getContext:()=>p.getContext,getVercelOidcToken:()=>d.getVercelOidcToken,getVercelOidcTokenSync:()=>d.getVercelOidcTokenSync};for(var u in l)a(o,u,{get:l[u],enumerable:!0});t.exports=((e,t,r,o)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let l of n(t))i.call(e,l)||l===r||a(e,l,{get:()=>t[l],enumerable:!(o=s(t,l))||o.enumerable});return e})(a({},"__esModule",{value:!0}),o);var d=e.r(890229),p=e.r(483938)},906920,(e,t,r)=>{"use strict";r.byteLength=function(e){var t=u(e),r=t[0],a=t[1];return(r+a)*3/4-a},r.toByteArray=function(e){var t,r,a=u(e),i=a[0],o=a[1],l=new n((i+o)*3/4-o),d=0,p=o>0?i-4:i;for(r=0;r<p;r+=4)t=s[e.charCodeAt(r)]<<18|s[e.charCodeAt(r+1)]<<12|s[e.charCodeAt(r+2)]<<6|s[e.charCodeAt(r+3)],l[d++]=t>>16&255,l[d++]=t>>8&255,l[d++]=255&t;return 2===o&&(t=s[e.charCodeAt(r)]<<2|s[e.charCodeAt(r+1)]>>4,l[d++]=255&t),1===o&&(t=s[e.charCodeAt(r)]<<10|s[e.charCodeAt(r+1)]<<4|s[e.charCodeAt(r+2)]>>2,l[d++]=t>>8&255,l[d++]=255&t),l},r.fromByteArray=function(e){for(var t,r=e.length,s=r%3,n=[],i=0,o=r-s;i<o;i+=16383)n.push(function(e,t,r){for(var s,n=[],i=t;i<r;i+=3)s=(e[i]<<16&0xff0000)+(e[i+1]<<8&65280)+(255&e[i+2]),n.push(a[s>>18&63]+a[s>>12&63]+a[s>>6&63]+a[63&s]);return n.join("")}(e,i,i+16383>o?o:i+16383));return 1===s?n.push(a[(t=e[r-1])>>2]+a[t<<4&63]+"=="):2===s&&n.push(a[(t=(e[r-2]<<8)+e[r-1])>>10]+a[t>>4&63]+a[t<<2&63]+"="),n.join("")};for(var a=[],s=[],n="undefined"!=typeof Uint8Array?Uint8Array:Array,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",o=0,l=i.length;o<l;++o)a[o]=i[o],s[i.charCodeAt(o)]=o;function u(e){var t=e.length;if(t%4>0)throw Error("Invalid string. Length must be a multiple of 4");var r=e.indexOf("=");-1===r&&(r=t);var a=r===t?0:4-r%4;return[r,a]}s[45]=62,s[95]=63},713439,(e,t,r)=>{!function(r,a){if("function"==typeof define&&define.amd){let t;void 0!==(t=a())&&e.v(t)}else t.exports=a()}(e.e,function t(){"use strict";var r="undefined"!=typeof self?self:void 0!==r?r:{},a=!r.document&&!!r.postMessage,s=r.IS_PAPA_WORKER||!1,n={},i=0,o={};if(o.parse=function(e,a){var s,l=(a=a||{}).dynamicTyping||!1;if(I(l)&&(a.dynamicTypingFunction=l,l={}),a.dynamicTyping=l,a.transform=!!I(a.transform)&&a.transform,a.worker&&o.WORKERS_SUPPORTED){var u=function(){if(!o.WORKERS_SUPPORTED)return!1;var e,a,s=(e=r.URL||r.webkitURL||null,a=t.toString(),o.BLOB_URL||(o.BLOB_URL=e.createObjectURL(new Blob(["var global = (function() { if (typeof self !== 'undefined') { return self; } if (typeof window !== 'undefined') { return window; } if (typeof global !== 'undefined') { return global; } return {}; })(); global.IS_PAPA_WORKER=true; ","(",a,")();"],{type:"text/javascript"})))),l=new r.Worker(s);return l.onmessage=v,l.id=i++,n[l.id]=l,l}();u.userStep=a.step,u.userChunk=a.chunk,u.userComplete=a.complete,u.userError=a.error,a.step=I(a.step),a.chunk=I(a.chunk),a.complete=I(a.complete),a.error=I(a.error),delete a.worker,u.postMessage({input:e,config:a,workerId:u.id});return}var g=null;return e===o.NODE_STREAM_INPUT&&"undefined"==typeof PAPA_BROWSER_CONTEXT?(g=new m(a)).getStream():("string"==typeof e?(e=65279===(s=e).charCodeAt(0)?s.slice(1):s,g=a.download?new d(a):new c(a)):!0===e.readable&&I(e.read)&&I(e.on)?g=new h(a):(r.File&&e instanceof File||e instanceof Object)&&(g=new p(a)),g.stream(e))},o.unparse=function(e,t){var r=!1,a=!0,s=",",n="\r\n",i='"',l=i+i,u=!1,d=null,p=!1;if("object"==typeof t){if("string"!=typeof t.delimiter||o.BAD_DELIMITERS.filter(function(e){return -1!==t.delimiter.indexOf(e)}).length||(s=t.delimiter),("boolean"==typeof t.quotes||"function"==typeof t.quotes||Array.isArray(t.quotes))&&(r=t.quotes),("boolean"==typeof t.skipEmptyLines||"string"==typeof t.skipEmptyLines)&&(u=t.skipEmptyLines),"string"==typeof t.newline&&(n=t.newline),"string"==typeof t.quoteChar&&(i=t.quoteChar),"boolean"==typeof t.header&&(a=t.header),Array.isArray(t.columns)){if(0===t.columns.length)throw Error("Option columns is empty");d=t.columns}void 0!==t.escapeChar&&(l=t.escapeChar+i),t.escapeFormulae instanceof RegExp?p=t.escapeFormulae:"boolean"==typeof t.escapeFormulae&&t.escapeFormulae&&(p=/^[=+\-@\t\r].*$/)}var c=RegExp(f(i),"g");if("string"==typeof e&&(e=JSON.parse(e)),Array.isArray(e)){if(!e.length||Array.isArray(e[0]))return h(null,e,u);else if("object"==typeof e[0])return h(d||Object.keys(e[0]),e,u)}else if("object"==typeof e)return"string"==typeof e.data&&(e.data=JSON.parse(e.data)),Array.isArray(e.data)&&(e.fields||(e.fields=e.meta&&e.meta.fields||d),e.fields||(e.fields=Array.isArray(e.data[0])?e.fields:"object"==typeof e.data[0]?Object.keys(e.data[0]):[]),Array.isArray(e.data[0])||"object"==typeof e.data[0]||(e.data=[e.data])),h(e.fields||[],e.data||[],u);throw Error("Unable to serialize unrecognized input");function h(e,t,r){var i="";"string"==typeof e&&(e=JSON.parse(e)),"string"==typeof t&&(t=JSON.parse(t));var o=Array.isArray(e)&&e.length>0,l=!Array.isArray(t[0]);if(o&&a){for(var u=0;u<e.length;u++)u>0&&(i+=s),i+=m(e[u],u);t.length>0&&(i+=n)}for(var d=0;d<t.length;d++){var p=o?e.length:t[d].length,c=!1,h=o?0===Object.keys(t[d]).length:0===t[d].length;if(r&&!o&&(c="greedy"===r?""===t[d].join("").trim():1===t[d].length&&0===t[d][0].length),"greedy"===r&&o){for(var g=[],f=0;f<p;f++){var y=l?e[f]:f;g.push(t[d][y])}c=""===g.join("").trim()}if(!c){for(var v=0;v<p;v++){v>0&&!h&&(i+=s);var b=o&&l?e[v]:v;i+=m(t[d][b],v)}d<t.length-1&&(!r||p>0&&!h)&&(i+=n)}}return i}function m(e,t){if(null==e)return"";if(e.constructor===Date)return JSON.stringify(e).slice(1,25);var a=!1;p&&"string"==typeof e&&p.test(e)&&(e="'"+e,a=!0);var n=e.toString().replace(c,l);return(a=a||!0===r||"function"==typeof r&&r(e,t)||Array.isArray(r)&&r[t]||function(e,t){for(var r=0;r<t.length;r++)if(e.indexOf(t[r])>-1)return!0;return!1}(n,o.BAD_DELIMITERS)||n.indexOf(s)>-1||" "===n.charAt(0)||" "===n.charAt(n.length-1))?i+n+i:n}},o.RECORD_SEP="\x1e",o.UNIT_SEP="\x1f",o.BYTE_ORDER_MARK="\uFEFF",o.BAD_DELIMITERS=["\r","\n",'"',o.BYTE_ORDER_MARK],o.WORKERS_SUPPORTED=!a&&!!r.Worker,o.NODE_STREAM_INPUT=1,o.LocalChunkSize=0xa00000,o.RemoteChunkSize=5242880,o.DefaultDelimiter=",",o.Parser=y,o.ParserHandle=g,o.NetworkStreamer=d,o.FileStreamer=p,o.StringStreamer=c,o.ReadableStreamStreamer=h,"undefined"==typeof PAPA_BROWSER_CONTEXT&&(o.DuplexStreamStreamer=m),r.jQuery){var l=r.jQuery;l.fn.parse=function(e){var t=e.config||{},a=[];return this.each(function(e){if(!("INPUT"===l(this).prop("tagName").toUpperCase()&&"file"===l(this).attr("type").toLowerCase()&&r.FileReader)||!this.files||0===this.files.length)return!0;for(var s=0;s<this.files.length;s++)a.push({file:this.files[s],inputElem:this,instanceConfig:l.extend({},t)})}),s(),this;function s(){if(0===a.length){I(e.complete)&&e.complete();return}var t=a[0];if(I(e.before)){var r,s,i,u,d=e.before(t.file,t.inputElem);if("object"==typeof d)if("abort"===d.action){return void(r="AbortError",s=t.file,i=t.inputElem,u=d.reason,I(e.error)&&e.error({name:r},s,i,u))}else{if("skip"===d.action)return void n();"object"==typeof d.config&&(t.instanceConfig=l.extend(t.instanceConfig,d.config))}else if("skip"===d)return void n()}var p=t.instanceConfig.complete;t.instanceConfig.complete=function(e){I(p)&&p(e,t.file,t.inputElem),n()},o.parse(t.file,t.instanceConfig)}function n(){a.splice(0,1),s()}}}function u(e){this._handle=null,this._finished=!1,this._completed=!1,this._halted=!1,this._input=null,this._baseIndex=0,this._partialLine="",this._rowCount=0,this._start=0,this._nextChunk=null,this.isFirstChunk=!0,this._completeResults={data:[],errors:[],meta:{}},(function(e){var t=_(e);t.chunkSize=parseInt(t.chunkSize),e.step||e.chunk||(t.chunkSize=null),this._handle=new g(t),this._handle.streamer=this,this._config=t}).call(this,e),this.parseChunk=function(e,t){let a=parseInt(this._config.skipFirstNLines)||0;if(this.isFirstChunk&&a>0){let t=this._config.newline;if(!t){let r=this._config.quoteChar||'"';t=this._handle.guessLineEndings(e,r)}e=[...e.split(t).slice(a)].join(t)}if(this.isFirstChunk&&I(this._config.beforeFirstChunk)){var n=this._config.beforeFirstChunk(e);void 0!==n&&(e=n)}this.isFirstChunk=!1,this._halted=!1;var i=this._partialLine+e;this._partialLine="";var l=this._handle.parse(i,this._baseIndex,!this._finished);if(this._handle.paused()||this._handle.aborted()){this._halted=!0;return}var u=l.meta.cursor;this._finished||(this._partialLine=i.substring(u-this._baseIndex),this._baseIndex=u),l&&l.data&&(this._rowCount+=l.data.length);var d=this._finished||this._config.preview&&this._rowCount>=this._config.preview;if(s)r.postMessage({results:l,workerId:o.WORKER_ID,finished:d});else if(I(this._config.chunk)&&!t){if(this._config.chunk(l,this._handle),this._handle.paused()||this._handle.aborted()){this._halted=!0;return}l=void 0,this._completeResults=void 0}return this._config.step||this._config.chunk||(this._completeResults.data=this._completeResults.data.concat(l.data),this._completeResults.errors=this._completeResults.errors.concat(l.errors),this._completeResults.meta=l.meta),!this._completed&&d&&I(this._config.complete)&&(!l||!l.meta.aborted)&&(this._config.complete(this._completeResults,this._input),this._completed=!0),d||l&&l.meta.paused||this._nextChunk(),l},this._sendError=function(e){I(this._config.error)?this._config.error(e):s&&this._config.error&&r.postMessage({workerId:o.WORKER_ID,error:e,finished:!1})}}function d(e){var t;(e=e||{}).chunkSize||(e.chunkSize=o.RemoteChunkSize),u.call(this,e),a?this._nextChunk=function(){this._readChunk(),this._chunkLoaded()}:this._nextChunk=function(){this._readChunk()},this.stream=function(e){this._input=e,this._nextChunk()},this._readChunk=function(){if(this._finished)return void this._chunkLoaded();if(t=new XMLHttpRequest,this._config.withCredentials&&(t.withCredentials=this._config.withCredentials),a||(t.onload=S(this._chunkLoaded,this),t.onerror=S(this._chunkError,this)),t.open(this._config.downloadRequestBody?"POST":"GET",this._input,!a),this._config.downloadRequestHeaders){var e=this._config.downloadRequestHeaders;for(var r in e)t.setRequestHeader(r,e[r])}if(this._config.chunkSize){var s=this._start+this._config.chunkSize-1;t.setRequestHeader("Range","bytes="+this._start+"-"+s)}try{t.send(this._config.downloadRequestBody)}catch(e){this._chunkError(e.message)}a&&0===t.status&&this._chunkError()},this._chunkLoaded=function(){if(4===t.readyState){var e;if(t.status<200||t.status>=400)return void this._chunkError();this._start+=this._config.chunkSize?this._config.chunkSize:t.responseText.length,this._finished=!this._config.chunkSize||this._start>=(null===(e=t.getResponseHeader("Content-Range"))?-1:parseInt(e.substring(e.lastIndexOf("/")+1))),this.parseChunk(t.responseText)}},this._chunkError=function(e){var r=t.statusText||e;this._sendError(Error(r))}}function p(e){(e=e||{}).chunkSize||(e.chunkSize=o.LocalChunkSize),u.call(this,e);var t,r,a="undefined"!=typeof FileReader;this.stream=function(e){this._input=e,r=e.slice||e.webkitSlice||e.mozSlice,a?((t=new FileReader).onload=S(this._chunkLoaded,this),t.onerror=S(this._chunkError,this)):t=new FileReaderSync,this._nextChunk()},this._nextChunk=function(){this._finished||this._config.preview&&!(this._rowCount<this._config.preview)||this._readChunk()},this._readChunk=function(){var e=this._input;if(this._config.chunkSize){var s=Math.min(this._start+this._config.chunkSize,this._input.size);e=r.call(e,this._start,s)}var n=t.readAsText(e,this._config.encoding);a||this._chunkLoaded({target:{result:n}})},this._chunkLoaded=function(e){this._start+=this._config.chunkSize,this._finished=!this._config.chunkSize||this._start>=this._input.size,this.parseChunk(e.target.result)},this._chunkError=function(){this._sendError(t.error)}}function c(e){var t;e=e||{},u.call(this,e),this.stream=function(e){return t=e,this._nextChunk()},this._nextChunk=function(){if(!this._finished){var e,r=this._config.chunkSize;return r?(e=t.substring(0,r),t=t.substring(r)):(e=t,t=""),this._finished=!t,this.parseChunk(e)}}}function h(e){e=e||{},u.call(this,e);var t=[],r=!0,a=!1;this.pause=function(){u.prototype.pause.apply(this,arguments),this._input.pause()},this.resume=function(){u.prototype.resume.apply(this,arguments),this._input.resume()},this.stream=function(e){this._input=e,this._input.on("data",this._streamData),this._input.on("end",this._streamEnd),this._input.on("error",this._streamError)},this._checkIsFinished=function(){a&&1===t.length&&(this._finished=!0)},this._nextChunk=function(){this._checkIsFinished(),t.length?this.parseChunk(t.shift()):r=!0},this._streamData=S(function(e){try{t.push("string"==typeof e?e:e.toString(this._config.encoding)),r&&(r=!1,this._checkIsFinished(),this.parseChunk(t.shift()))}catch(e){this._streamError(e)}},this),this._streamError=S(function(e){this._streamCleanUp(),this._sendError(e)},this),this._streamEnd=S(function(){this._streamCleanUp(),a=!0,this._streamData("")},this),this._streamCleanUp=S(function(){this._input.removeListener("data",this._streamData),this._input.removeListener("end",this._streamEnd),this._input.removeListener("error",this._streamError)},this)}function m(t){var r=e.r(688947).Duplex,a=_(t),s=!0,n=!1,i=[],o=null;this._onCsvData=function(e){var t=e.data;o.push(t)||this._handle.paused()||this._handle.pause()},this._onCsvComplete=function(){o.push(null)},a.step=S(this._onCsvData,this),a.complete=S(this._onCsvComplete,this),u.call(this,a),this._nextChunk=function(){n&&1===i.length&&(this._finished=!0),i.length?i.shift()():s=!0},this._addToParseQueue=function(e,t){i.push(S(function(){if(this.parseChunk("string"==typeof e?e:e.toString(a.encoding)),I(t))return t()},this)),s&&(s=!1,this._nextChunk())},this._onRead=function(){this._handle.paused()&&this._handle.resume()},this._onWrite=function(e,t,r){this._addToParseQueue(e,r)},this._onWriteComplete=function(){n=!0,this._addToParseQueue("")},this.getStream=function(){return o},(o=new r({readableObjectMode:!0,decodeStrings:!1,read:S(this._onRead,this),write:S(this._onWrite,this)})).once("finish",S(this._onWriteComplete,this))}function g(e){var t,r,a,s=/^\s*-?(\d+\.?|\.\d+|\d+\.\d+)([eE][-+]?\d+)?\s*$/,n=/^((\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d\.\d+([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z)))$/,i=this,l=0,u=0,d=!1,p=!1,c=[],h={data:[],errors:[],meta:{}};if(I(e.step)){var m=e.step;e.step=function(t){if(h=t,b())v();else{if(v(),0===h.data.length)return;l+=t.data.length,e.preview&&l>e.preview?r.abort():(h.data=h.data[0],m(h,i))}}}function g(t){return"greedy"===e.skipEmptyLines?""===t.join("").trim():1===t.length&&0===t[0].length}function v(){return h&&a&&(w("Delimiter","UndetectableDelimiter","Unable to auto-detect delimiting character; defaulted to '"+o.DefaultDelimiter+"'"),a=!1),e.skipEmptyLines&&(h.data=h.data.filter(function(e){return!g(e)})),b()&&function(){if(h)if(Array.isArray(h.data[0])){for(var t=0;b()&&t<h.data.length;t++)h.data[t].forEach(r);h.data.splice(0,1)}else h.data.forEach(r);function r(t,r){I(e.transformHeader)&&(t=e.transformHeader(t,r)),c.push(t)}}(),function(){if(!h||!e.header&&!e.dynamicTyping&&!e.transform)return h;function t(t,r){var a,i=e.header?{}:[];for(a=0;a<t.length;a++){var o=a,l=t[a];e.header&&(o=a>=c.length?"__parsed_extra":c[a]),e.transform&&(l=e.transform(l,o)),l=function(t,r){if(e.dynamicTypingFunction&&void 0===e.dynamicTyping[t]&&(e.dynamicTyping[t]=e.dynamicTypingFunction(t)),!0===(e.dynamicTyping[t]||e.dynamicTyping))if("true"===r||"TRUE"===r)return!0;else if("false"===r||"FALSE"===r)return!1;else if(function(e){if(s.test(e)){var t=parseFloat(e);if(t>-0x20000000000000&&t<0x20000000000000)return!0}return!1}(r))return parseFloat(r);else if(n.test(r))return new Date(r);else return""===r?null:r;return r}(o,l),"__parsed_extra"===o?(i[o]=i[o]||[],i[o].push(l)):i[o]=l}return e.header&&(a>c.length?w("FieldMismatch","TooManyFields","Too many fields: expected "+c.length+" fields but parsed "+a,u+r):a<c.length&&w("FieldMismatch","TooFewFields","Too few fields: expected "+c.length+" fields but parsed "+a,u+r)),i}var r=1;return!h.data.length||Array.isArray(h.data[0])?(h.data=h.data.map(t),r=h.data.length):h.data=t(h.data,0),e.header&&h.meta&&(h.meta.fields=c),u+=r,h}()}function b(){return e.header&&0===c.length}function w(e,t,r,a){var s={type:e,code:t,message:r};void 0!==a&&(s.row=a),h.errors.push(s)}this.parse=function(s,n,i){var l=e.quoteChar||'"';if(e.newline||(e.newline=this.guessLineEndings(s,l)),a=!1,e.delimiter)I(e.delimiter)&&(e.delimiter=e.delimiter(s),h.meta.delimiter=e.delimiter);else{var u=function(t,r,a,s,n){var i,l,u,d;n=n||[",","	","|",";",o.RECORD_SEP,o.UNIT_SEP];for(var p=0;p<n.length;p++){var c=n[p],h=0,m=0,f=0;u=void 0;for(var v=new y({comments:s,delimiter:c,newline:r,preview:10}).parse(t),b=0;b<v.data.length;b++){if(a&&g(v.data[b])){f++;continue}var w=v.data[b].length;if(m+=w,void 0===u){u=w;continue}w>0&&(h+=Math.abs(w-u),u=w)}v.data.length>0&&(m/=v.data.length-f),(void 0===l||h<=l)&&(void 0===d||m>d)&&m>1.99&&(l=h,i=c,d=m)}return e.delimiter=i,{successful:!!i,bestDelimiter:i}}(s,e.newline,e.skipEmptyLines,e.comments,e.delimitersToGuess);u.successful?e.delimiter=u.bestDelimiter:(a=!0,e.delimiter=o.DefaultDelimiter),h.meta.delimiter=e.delimiter}var p=_(e);return e.preview&&e.header&&p.preview++,t=s,h=(r=new y(p)).parse(t,n,i),v(),d?{meta:{paused:!0}}:h||{meta:{paused:!1}}},this.paused=function(){return d},this.pause=function(){d=!0,r.abort(),t=I(e.chunk)?"":t.substring(r.getCharIndex())},this.resume=function(){i.streamer._halted?(d=!1,i.streamer.parseChunk(t,!0)):setTimeout(i.resume,3)},this.aborted=function(){return p},this.abort=function(){p=!0,r.abort(),h.meta.aborted=!0,I(e.complete)&&e.complete(h),t=""},this.guessLineEndings=function(e,t){e=e.substring(0,1048576);var r=RegExp(f(t)+"([^]*?)"+f(t),"gm"),a=(e=e.replace(r,"")).split("\r"),s=e.split("\n"),n=s.length>1&&s[0].length<a[0].length;if(1===a.length||n)return"\n";for(var i=0,o=0;o<a.length;o++)"\n"===a[o][0]&&i++;return i>=a.length/2?"\r\n":"\r"}}function f(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function y(e){var t,r=(e=e||{}).delimiter,a=e.newline,s=e.comments,n=e.step,i=e.preview,l=e.fastMode,u=null,d=!1,p=t=void 0===e.quoteChar||null===e.quoteChar?'"':e.quoteChar;if(void 0!==e.escapeChar&&(p=e.escapeChar),("string"!=typeof r||o.BAD_DELIMITERS.indexOf(r)>-1)&&(r=","),s===r)throw Error("Comment character same as delimiter");!0===s?s="#":("string"!=typeof s||o.BAD_DELIMITERS.indexOf(s)>-1)&&(s=!1),"\n"!==a&&"\r"!==a&&"\r\n"!==a&&(a="\n");var c=0,h=!1;this.parse=function(o,m,g){if("string"!=typeof o)throw Error("Input must be a string");var y=o.length,v=r.length,b=a.length,w=s.length,_=I(n);c=0;var S=[],k=[],T=[],E=0;if(!o)return z();if(l||!1!==l&&-1===o.indexOf(t)){for(var A=o.split(a),O=0;O<A.length;O++){if(T=A[O],c+=T.length,O!==A.length-1)c+=a.length;else if(g)break;if(!s||T.substring(0,w)!==s){if(_){if(S=[],$(T.split(r)),q(),h)return z()}else $(T.split(r));if(i&&O>=i)return S=S.slice(0,i),z(!0)}}return z()}for(var C=o.indexOf(r,c),R=o.indexOf(a,c),M=RegExp(f(p)+f(t),"g"),N=o.indexOf(t,c);;){if(o[c]===t){for(N=c,c++;;){if(-1===(N=o.indexOf(t,N+1)))return g||k.push({type:"Quotes",code:"MissingQuotes",message:"Quoted field unterminated",row:S.length,index:c}),L();if(N===y-1)return L(o.substring(c,N).replace(M,t));if(t===p&&o[N+1]===p){N++;continue}if(t===p||0===N||o[N-1]!==p){-1!==C&&C<N+1&&(C=o.indexOf(r,N+1)),-1!==R&&R<N+1&&(R=o.indexOf(a,N+1));var j=D(-1===R?C:Math.min(C,R));if(o.substr(N+1+j,v)===r){T.push(o.substring(c,N).replace(M,t)),c=N+1+j+v,o[N+1+j+v]!==t&&(N=o.indexOf(t,c)),C=o.indexOf(r,c),R=o.indexOf(a,c);break}var P=D(R);if(o.substring(N+1+P,N+1+P+b)===a){if(T.push(o.substring(c,N).replace(M,t)),U(N+1+P+b),C=o.indexOf(r,c),N=o.indexOf(t,c),_&&(q(),h))return z();if(i&&S.length>=i)return z(!0);break}k.push({type:"Quotes",code:"InvalidQuotes",message:"Trailing quote on quoted field is malformed",row:S.length,index:c}),N++;continue}}continue}if(s&&0===T.length&&o.substring(c,c+w)===s){if(-1===R)return z();c=R+b,R=o.indexOf(a,c),C=o.indexOf(r,c);continue}if(-1!==C&&(C<R||-1===R)){T.push(o.substring(c,C)),c=C+v,C=o.indexOf(r,c);continue}if(-1!==R){if(T.push(o.substring(c,R)),U(R+b),_&&(q(),h))return z();if(i&&S.length>=i)return z(!0);continue}break}return L();function $(e){S.push(e),E=c}function D(e){var t=0;if(-1!==e){var r=o.substring(N+1,e);r&&""===r.trim()&&(t=r.length)}return t}function L(e){return g||(void 0===e&&(e=o.substring(c)),T.push(e),c=y,$(T),_&&q()),z()}function U(e){c=e,$(T),T=[],R=o.indexOf(a,c)}function z(t){if(e.header&&!m&&S.length&&!d){let t=S[0],r=Object.create(null),a=new Set(t),s=!1;for(let n=0;n<t.length;n++){let i=t[n];if(I(e.transformHeader)&&(i=e.transformHeader(i,n)),r[i]){let e,o=r[i];do e=`${i}_${o}`,o++;while(a.has(e))a.add(e),t[n]=e,r[i]++,s=!0,null===u&&(u={}),u[e]=i}else r[i]=1,t[n]=i;a.add(i)}s&&console.warn("Duplicate headers found and renamed."),d=!0}return{data:S,errors:k,meta:{delimiter:r,linebreak:a,aborted:h,truncated:!!t,cursor:E+(m||0),renamedHeaders:u}}}function q(){n(z()),S=[],k=[]}},this.abort=function(){h=!0},this.getCharIndex=function(){return c}}function v(e){var t=e.data,r=n[t.workerId],a=!1;if(t.error)r.userError(t.error,t.file);else if(t.results&&t.results.data){var s={abort:function(){a=!0,b(t.workerId,{data:[],errors:[],meta:{aborted:!0}})},pause:w,resume:w};if(I(r.userStep)){for(var i=0;i<t.results.data.length&&(r.userStep({data:t.results.data[i],errors:t.results.errors,meta:t.results.meta},s),!a);i++);delete t.results}else I(r.userChunk)&&(r.userChunk(t.results,s,t.file),delete t.results)}t.finished&&!a&&b(t.workerId,t.results)}function b(e,t){var r=n[e];I(r.userComplete)&&r.userComplete(t),r.terminate(),delete n[e]}function w(){throw Error("Not implemented.")}function _(e){if("object"!=typeof e||null===e)return e;var t=Array.isArray(e)?[]:{};for(var r in e)t[r]=_(e[r]);return t}function S(e,t){return function(){e.apply(t,arguments)}}function I(e){return"function"==typeof e}return s&&(r.onmessage=function(e){var t=e.data;if(void 0===o.WORKER_ID&&t&&(o.WORKER_ID=t.workerId),"string"==typeof t.input)r.postMessage({workerId:o.WORKER_ID,results:o.parse(t.input,t.config),finished:!0});else if(r.File&&t.input instanceof File||t.input instanceof Object){var a=o.parse(t.input,t.config);a&&r.postMessage({workerId:o.WORKER_ID,results:a,finished:!0})}}),d.prototype=Object.create(u.prototype),d.prototype.constructor=d,p.prototype=Object.create(u.prototype),p.prototype.constructor=p,c.prototype=Object.create(c.prototype),c.prototype.constructor=c,h.prototype=Object.create(u.prototype),h.prototype.constructor=h,"undefined"==typeof PAPA_BROWSER_CONTEXT&&(m.prototype=Object.create(u.prototype),m.prototype.constructor=m),o})},805201,e=>{"use strict";let t,r,a,s,n,i;var o,l,u,d,p,c,h,m,g,f,y,v,b,w,_,S,I,k,T,E,A,O,C,R,M,N,j,P,$,D,L,U,z,q,V,F,Z,W,G,B,K,J,H,Y,Q,X,ee,et,er,ea,es,en,ei,eo,el,eu,ed,ep,ec,eh,em,eg,ef,ey,ev,eb,ew,e_,eS,ex,eI,ek,eT,eE,eA,eO,eC,eR,eM,eN,ej,eP,e$,eD,eL,eU,ez,eq,eV,eF,eZ,eW,eG,eB,eK,eJ,eH,eY,eQ,eX,e0,e1,e2,e4,e5,e3=e.i(747909),e9=e.i(174017),e6=e.i(996250),e8=e.i(759756),e7=e.i(561916),te=e.i(114444),tt=e.i(837092),tr=e.i(869741),ta=e.i(316795),ts=e.i(487718),tn=e.i(995169),ti=e.i(47587),to=e.i(666012),tl=e.i(570101),tu=e.i(626937),td=e.i(10372),tp=e.i(193695);e.i(52474);var tc=e.i(600220),th=e.i(89171);function tm(e){if("object"!=typeof e||null===e)return String(e);try{let t=JSON.stringify(e);if("{}"===t)return String(e);return t}catch{return String(e)}}var tg=((o=tg||{}).TOOL="TOOL",o.AGENT="AGENT",o.MCP="MCP",o.AGENT_NETWORK="AGENT_NETWORK",o.MASTRA_SERVER="MASTRA_SERVER",o.MASTRA_TELEMETRY="MASTRA_TELEMETRY",o.MASTRA_OBSERVABILITY="MASTRA_OBSERVABILITY",o.MASTRA_WORKFLOW="MASTRA_WORKFLOW",o.MASTRA_VOICE="MASTRA_VOICE",o.MASTRA_VECTOR="MASTRA_VECTOR",o.LLM="LLM",o.EVAL="EVAL",o.SCORER="SCORER",o.A2A="A2A",o.MASTRA_INSTANCE="MASTRA_INSTANCE",o.MASTRA="MASTRA",o.DEPLOYER="DEPLOYER",o.STORAGE="STORAGE",o.MODEL_ROUTER="MODEL_ROUTER",o),tf=((l=tf||{}).UNKNOWN="UNKNOWN",l.USER="USER",l.SYSTEM="SYSTEM",l.THIRD_PARTY="THIRD_PARTY",l),ty=class extends Error{id;domain;category;details={};message;constructor(e,t){let r;t instanceof Error?r=t:t&&(r=Error(tm(t)));const a=e.text??r?.message??"Unknown error";super(a,{cause:r}),this.id=e.id,this.domain=e.domain,this.category=e.category,this.details=e.details??{},this.message=a,Object.setPrototypeOf(this,new.target.prototype)}toJSONDetails(){return{message:this.message,domain:this.domain,category:this.category,details:this.details}}toJSON(){return{message:this.message,details:this.toJSONDetails(),code:this.id}}toString(){return JSON.stringify(this.toJSON())}},tv=class extends ty{},tb=e.i(984886),tw=e.i(278596),t_=e.i(344467),tS=e.i(419798),tx=e.i(385656);(u=C||(C={}))[u.SUCCESS=0]="SUCCESS",u[u.FAILED=1]="FAILED";e.i(60438).performance;function tI(e="default-tracer"){try{return!!tb.trace.getTracer(e)}catch{return!1}}function tk(e){let t=tw.propagation.getBaggage(e),r=t?.getEntry("http.request_id")?.value,a=t?.getEntry("componentName")?.value,s=t?.getEntry("runId")?.value;return{requestId:r,componentName:a,runId:s,threadId:t?.getEntry("threadId")?.value,resourceId:t?.getEntry("resourceId")?.value}}function tT(e,t){return"stream"===t||"streamLegacy"===t||!!e&&"object"==typeof e&&null!==e&&("textStream"in e||"objectStream"in e||"usagePromise"in e||"finishReasonPromise"in e)}function tE(e){return function(t){return Object.getOwnPropertyNames(t.prototype).forEach(r=>{var a;if(e?.excludeMethods?.includes(r)||"constructor"===r||e?.methodFilter&&!e.methodFilter(r))return;let s=Object.getOwnPropertyDescriptor(t.prototype,r);s&&"function"==typeof s.value&&Object.defineProperty(t.prototype,r,(a={spanName:e?.prefix?`${e.prefix}.${r}`:r,skipIfNoTelemetry:!0,spanKind:e?.spanKind||tx.SpanKind.INTERNAL,tracerName:e?.tracerName},function(e,t,r){if(!r||"number"==typeof r)return;let s=r.value,n=String(t);return r.value=function(...e){let t,r,i;if(a?.skipIfNoTelemetry&&!tI(a?.tracerName))return s.apply(this,e);let o=tb.trace.getTracer(a?.tracerName??"default-tracer");"string"==typeof a?t=a:a?(t=a.spanName||n,r=a.spanKind):t=n;let l=o.startSpan(t,{kind:r}),u=tb.trace.setSpan(t_.context.active(),l);e.forEach((e,r)=>{try{l.setAttribute(`${t}.argument.${r}`,JSON.stringify(e))}catch{l.setAttribute(`${t}.argument.${r}`,"[Not Serializable]")}});let{requestId:d,componentName:p,runId:c,threadId:h,resourceId:m}=tk(u);d&&l.setAttribute("http.request_id",d),h&&l.setAttribute("threadId",h),m&&l.setAttribute("resourceId",m),p?(l.setAttribute("componentName",p),l.setAttribute("runId",c)):this&&"object"==typeof this&&"name"in this&&(l.setAttribute("componentName",this.name),this.runId&&l.setAttribute("runId",this.runId),u=tw.propagation.setBaggage(u,tw.propagation.createBaggage({componentName:{value:this.name},runId:{value:this.runId},"http.request_id":{value:d},threadId:{value:h},resourceId:{value:m}})));try{let r=tT(i,n)?function(e,t,r,a){if("stream"===a||"streamLegacy"===a){let a=[...e],s={...a.length>1&&a[1]||{}},n=s.onFinish;return s.onFinish=async e=>{try{let a={text:e.text,usage:e.usage,finishReason:e.finishReason,toolCalls:e.toolCalls,toolResults:e.toolResults,warnings:e.warnings,...void 0!==e.object&&{object:e.object}};t.setAttribute(`${r}.result`,JSON.stringify(a)),t.setStatus({code:tS.SpanStatusCode.OK}),t.end()}catch(e){console.warn("Telemetry capture failed:",e),t.setAttribute(`${r}.result`,"[Telemetry Capture Error]"),t.setStatus({code:tS.SpanStatusCode.ERROR}),t.end()}if(n)return await n(e)},s.onFinish.__hasOriginalOnFinish=!!n,a[1]=s,t.__mastraStreamingSpan=!0,a}return e}(e,l,t,n):e;if((i=t_.context.with(u,()=>s.apply(this,r)))instanceof Promise)return i.then(e=>{if(tT(e,n))return e;try{l.setAttribute(`${t}.result`,JSON.stringify(e))}catch{l.setAttribute(`${t}.result`,"[Not Serializable]")}return e}).finally(()=>{l.__mastraStreamingSpan||l.end()});if(!tT(i,n))try{l.setAttribute(`${t}.result`,JSON.stringify(i))}catch{l.setAttribute(`${t}.result`,"[Not Serializable]")}return i}catch(e){throw l.setStatus({code:tS.SpanStatusCode.ERROR,message:e instanceof Error?e.message:"Unknown error"}),e instanceof Error&&l.recordException(e),e}finally{i instanceof Promise||tT(i,n)||l.end()}},r})(t,r,s))}),t}}var tA=class e{tracer=tb.trace.getTracer("default");name="default-service";constructor(e){this.name=e.serviceName??"default-service",this.tracer=tb.trace.getTracer(this.name)}async shutdown(){}static init(t={}){try{return globalThis.__TELEMETRY__||(globalThis.__TELEMETRY__=new e(t)),globalThis.__TELEMETRY__}catch(e){throw new tv({id:"TELEMETRY_INIT_FAILED",text:"Failed to initialize telemetry",domain:"MASTRA_TELEMETRY",category:"SYSTEM"},e)}}static getActiveSpan(){return tb.trace.getActiveSpan()}static get(){if(!globalThis.__TELEMETRY__)throw new tv({id:"TELEMETRY_GETTER_FAILED_GLOBAL_TELEMETRY_NOT_INITIALIZED",text:"Telemetry not initialized",domain:"MASTRA_TELEMETRY",category:"USER"});return globalThis.__TELEMETRY__}traceClass(e,t={}){let{skipIfNoTelemetry:r=!0}=t;if(r&&!tI())return e;let{spanNamePrefix:a=e.constructor.name.toLowerCase(),attributes:s={},excludeMethods:n=[]}=t;return new Proxy(e,{get:(e,t)=>{let r=e[t];return"function"!=typeof r||"constructor"===t||t.toString().startsWith("_")||n.includes(t.toString())?r:this.traceMethod(r.bind(e),{spanName:`${a}.${t.toString()}`,attributes:{...s,[`${a}.name`]:e.constructor.name,[`${a}.method.name`]:t.toString()}})}})}static setBaggage(e,t=t_.context.active()){let r=Object.fromEntries(tw.propagation.getBaggage(t)?.getAllEntries()??[]);return tw.propagation.setBaggage(t,tw.propagation.createBaggage({...r,...e}))}static withContext(e,t){return t_.context.with(e,t)}traceMethod(e,t){let r=t_.context.active(),{skipIfNoTelemetry:a=!0}=t;return a&&!tI()?e:(...a)=>{let s=this.tracer.startSpan(t.spanName);function n(e){throw s.recordException(e),s.setStatus({code:tS.SpanStatusCode.ERROR,message:e.message}),s.end(),e}try{let i,o=function(e){try{s.setAttribute(`${t.spanName}.result`,JSON.stringify(e))}catch{s.setAttribute(`${t.spanName}.result`,"[Not Serializable]")}return s.end(),e},{requestId:l,componentName:u,runId:d,threadId:p,resourceId:c}=tk(r);if(t.attributes&&s.setAttributes(t.attributes),l&&s.setAttribute("http.request_id",l),p&&s.setAttribute("threadId",p),c&&s.setAttribute("resourceId",c),t.attributes?.componentName?r=tw.propagation.setBaggage(r,tw.propagation.createBaggage({componentName:{value:t.attributes.componentName},runId:{value:t.attributes.runId},"http.request_id":{value:l}})):u?(s.setAttribute("componentName",u),s.setAttribute("runId",d)):this&&this.name&&(s.setAttribute("componentName",this.name),s.setAttribute("runId",this.runId),r=tw.propagation.setBaggage(r,tw.propagation.createBaggage({componentName:{value:this.name},runId:{value:this.runId},"http.request_id":{value:l},threadId:{value:p},resourceId:{value:c}}))),a.forEach((e,r)=>{try{s.setAttribute(`${t.spanName}.argument.${r}`,JSON.stringify(e))}catch{s.setAttribute(`${t.spanName}.argument.${r}`,"[Not Serializable]")}}),t_.context.with(tb.trace.setSpan(r,s),()=>{i=e(...a)}),i instanceof Promise)return i.then(o).catch(n);return o(i)}catch(e){n(e)}}}getBaggageTracer(){return new tO(this.tracer)}},tO=class{_tracer;constructor(e){this._tracer=e}startSpan(e,t={},r){r=r??t_.context.active();let a=this._tracer.startSpan(e,t,r),{componentName:s,runId:n,requestId:i,threadId:o,resourceId:l}=tk(r);return a.setAttribute("componentName",s),a.setAttribute("runId",n),a.setAttribute("http.request_id",i),a.setAttribute("threadId",o),a.setAttribute("resourceId",l),a}startActiveSpan(e,t,r,a){return"function"==typeof t?this._tracer.startActiveSpan(e,{},t_.context.active(),e=>{let{componentName:r,runId:a,requestId:s,threadId:n,resourceId:i}=tk(t_.context.active());return e.setAttribute("componentName",r),e.setAttribute("runId",a),e.setAttribute("http.request_id",s),e.setAttribute("threadId",n),e.setAttribute("resourceId",i),t(e)}):"function"==typeof r?this._tracer.startActiveSpan(e,t,t_.context.active(),e=>{let{componentName:t,runId:a,requestId:s,threadId:n,resourceId:i}=tk(t_.context.active());return e.setAttribute("componentName",t),e.setAttribute("runId",a),e.setAttribute("http.request_id",s),e.setAttribute("threadId",n),e.setAttribute("resourceId",i),r(e)}):this._tracer.startActiveSpan(e,t,r,e=>{let{componentName:t,runId:s,requestId:n,threadId:i,resourceId:o}=tk(r??t_.context.active());return e.setAttribute("componentName",t),e.setAttribute("runId",s),e.setAttribute("http.request_id",n),e.setAttribute("threadId",i),e.setAttribute("resourceId",o),a(e)})}},tC="WORKFLOW",tR="debug",tM="info",tN="warn",tj="error",tP=class{name;level;transports;constructor(e={}){this.name=e.name||"Mastra",this.level=e.level||tj,this.transports=new Map(Object.entries(e.transports||{}))}getTransports(){return this.transports}trackException(e){}async getLogs(e,t){return e&&this.transports.has(e)?this.transports.get(e).getLogs(t)??{logs:[],total:0,page:t?.page??1,perPage:t?.perPage??100,hasMore:!1}:{logs:[],total:0,page:t?.page??1,perPage:t?.perPage??100,hasMore:!1}}async getLogsByRunId({transportId:e,runId:t,fromDate:r,toDate:a,logLevel:s,filters:n,page:i,perPage:o}){return e&&this.transports.has(e)&&t?this.transports.get(e).getLogsByRunId({runId:t,fromDate:r,toDate:a,logLevel:s,filters:n,page:i,perPage:o})??{logs:[],total:0,page:i??1,perPage:o??100,hasMore:!1}:{logs:[],total:0,page:i??1,perPage:o??100,hasMore:!1}}},t$=class extends tP{constructor(e={}){super(e)}debug(e,...t){this.level===tR&&console.info(e,...t)}info(e,...t){(this.level===tM||this.level===tR)&&console.info(e,...t)}warn(e,...t){(this.level===tN||this.level===tM||this.level===tR)&&console.warn(e,...t)}error(e,...t){(this.level===tj||this.level===tN||this.level===tM||this.level===tR)&&console.error(e,...t)}async getLogs(e,t){return{logs:[],total:0,page:t?.page??1,perPage:t?.perPage??100,hasMore:!1}}async getLogsByRunId(e){return{logs:[],total:0,page:e.page??1,perPage:e.perPage??100,hasMore:!1}}},tD=class{component="LLM";logger;name;telemetry;constructor({component:e,name:t}){this.component=e||"LLM",this.name=t,this.logger=new t$({name:`${this.component} - ${this.name}`})}__setLogger(e){this.logger=e,"LLM"!==this.component&&this.logger.debug(`Logger updated [component=${this.component}] [name=${this.name}]`)}__setTelemetry(e){this.telemetry=e,"LLM"!==this.component&&this.logger.debug(`Telemetry updated [component=${this.component}] [name=${this.telemetry.name}]`)}__getTelemetry(){return this.telemetry}get experimental_telemetry(){return this.telemetry?{tracer:this.telemetry.getBaggageTracer(),isEnabled:!!this.telemetry.tracer}:void 0}},tL=Object.create,tU=Object.defineProperty,tz=Object.getOwnPropertyDescriptor,tq=Object.getOwnPropertyNames,tV=Object.getPrototypeOf,tF=Object.prototype.hasOwnProperty,tZ=(e,t)=>(t=Symbol[e])?t:Symbol.for("Symbol."+e),tW=e=>{throw TypeError(e)},tG=(e,t)=>tU(e,"name",{value:t,configurable:!0}),tB=(e,t,r)=>(r=null!=e?tL(tV(e)):{},((e,t,r,a)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let s of tq(t))tF.call(e,s)||s===r||tU(e,s,{get:()=>t[s],enumerable:!(a=tz(t,s))||a.enumerable});return e})(!t&&e&&e.__esModule?r:tU(r,"default",{value:e,enumerable:!0}),e)),tK=e=>[,,,tL(e?.[tZ("metadata")]??null)],tJ=["class","method","getter","setter","accessor","field","value","get","set"],tH=e=>void 0!==e&&"function"!=typeof e?tW("Function expected"):e,tY=(e,t,r,a,s)=>({kind:tJ[e],name:t,metadata:a,addInitializer:e=>r._?tW("Already initialized"):s.push(tH(e||null))}),tQ=(e,t,r,a)=>{for(var s=0,n=e[t>>1],i=n&&n.length;s<i;s++)1&t?n[s].call(r):a=n[s].call(r,a);return a},tX=(e,t,r,a,s,n)=>{let i,o,l;var u,d,p,c,h,m=7&t,g=!!(8&t),f=!!(16&t),y=m>3?e.length+1:m?g?1:2:0,v=tJ[m+5],b=m>3&&(e[y-1]=[]),w=e[y]||(e[y]=[]),_=m&&(f||g||(s=s.prototype),m<5&&(m>3||!f)&&tz(m<4?s:{get[r](){return t2(this,n)},set[r](x){return t4(this,n,x)}},r));m?f&&m<4&&tG(n,(m>2?"set ":m>1?"get ":"")+r):tG(s,r);for(var S=a.length-1;S>=0;S--)c=tY(m,r,p={},e[3],w),m&&(c.static=g,c.private=f,h=c.access={has:f?e=>t1(s,e):e=>r in e},3^m&&(h.get=f?e=>(1^m?t2:t5)(e,s,4^m?n:_.get):e=>e[r]),m>2&&(h.set=f?(e,t)=>t4(e,s,t,4^m?n:_.set):(e,t)=>e[r]=t)),d=(0,a[S])(m?m<4?f?n:_[v]:m>4?void 0:{get:_.get,set:_.set}:s,c),p._=1,4^m||void 0===d?tH(d)&&(m>4?b.unshift(d):m?f?n=d:_[v]=d:s=d):"object"!=typeof d||null===d?tW("Object expected"):(tH(u=d.get)&&(_.get=u),tH(u=d.set)&&(_.set=u),tH(u=d.init)&&b.unshift(u));return m||(i=s,o=tZ("metadata"),l=e[3],o in i?tU(i,o,{enumerable:!0,configurable:!0,writable:!0,value:l}):i[o]=l),_&&tU(s,r,_),f?4^m?n:_:s},t0=(e,t,r)=>t.has(e)||tW("Cannot "+r),t1=(e,t)=>Object(t)!==t?tW('Cannot use the "in" operator on this value'):e.has(t),t2=(e,t,r)=>(t0(e,t,"read from private field"),r?r.call(e):t.get(e)),t4=(e,t,r,a)=>(t0(e,t,"write to private field"),a?a.call(e,r):t.set(e,r),r),t5=(e,t,r)=>(t0(e,t,"access private method"),r);R=[tE({prefix:"voice",excludeMethods:["__setTools","__setLogger","__setTelemetry","#log"]})];var t3=class extends(N=tD){listeningModel;speechModel;speaker;realtimeConfig;constructor({listeningModel:e,speechModel:t,speaker:r,realtimeConfig:a,name:s}={}){super({component:"VOICE",name:s}),this.listeningModel=e,this.speechModel=t,this.speaker=r,this.realtimeConfig=a}traced(e,t){return this.telemetry?.traceMethod(e,{spanName:`voice.${t}`,attributes:{"voice.type":this.speechModel?.name||this.listeningModel?.name||"unknown"}})??e}updateConfig(e){this.logger.warn("updateConfig not implemented by this voice provider")}connect(e){return this.logger.warn("connect not implemented by this voice provider"),Promise.resolve()}send(e){return this.logger.warn("relay not implemented by this voice provider"),Promise.resolve()}answer(e){return this.logger.warn("answer not implemented by this voice provider"),Promise.resolve()}addInstructions(e){}addTools(e){}close(){this.logger.warn("close not implemented by this voice provider")}on(e,t){this.logger.warn("on not implemented by this voice provider")}off(e,t){this.logger.warn("off not implemented by this voice provider")}getSpeakers(){return this.logger.warn("getSpeakers not implemented by this voice provider"),Promise.resolve([])}getListener(){return this.logger.warn("getListener not implemented by this voice provider"),Promise.resolve({enabled:!1})}};t3=tX(M=tK(N),0,"MastraVoice",R,t3),tQ(M,1,t3);var t9=class extends t3{constructor(){super()}async speak(e){throw new tv({id:"VOICE_DEFAULT_NO_SPEAK_PROVIDER",text:"No voice provider configured",domain:"MASTRA_VOICE",category:"USER"})}async listen(e){throw new tv({id:"VOICE_DEFAULT_NO_LISTEN_PROVIDER",text:"No voice provider configured",domain:"MASTRA_VOICE",category:"USER"})}async getSpeakers(){throw new tv({id:"VOICE_DEFAULT_NO_SPEAKERS_PROVIDER",text:"No voice provider configured",domain:"MASTRA_VOICE",category:"USER"})}async getListener(){throw new tv({id:"VOICE_DEFAULT_NO_LISTENER_PROVIDER",text:"No voice provider configured",domain:"MASTRA_VOICE",category:"USER"})}},t6=Symbol("emitter"),t8=Symbol("stream_format"),t7=class{registry=new Map;constructor(e){this.registry=new Map(e)}set(e,t){this.registry.set(e,t)}get(e){return this.registry.get(e)}has(e){return this.registry.has(e)}delete(e){return this.registry.delete(e)}clear(){this.registry.clear()}keys(){return this.registry.keys()}values(){return this.registry.values()}entries(){return this.registry.entries()}size(){return this.registry.size}forEach(e){this.registry.forEach(e)}toJSON(){return Object.fromEntries(this.registry)}},re=e.i(363890),rt=class extends re.WritableStream{constructor({prefix:e,callId:t,name:r,runId:a},s){super({async write(n){let i=s?.getWriter();try{await i?.write({type:`${e}-output`,runId:a,from:"USER",payload:{output:n,..."workflow-step"===e?{runId:a,stepName:r}:{[`${e}CallId`]:t,[`${e}Name`]:r}}})}finally{i?.releaseLock()}}})}async write(e){let t=this.getWriter();try{await t.write(e)}finally{t.releaseLock()}}};function rr(e,t,r){if(!e||!("safeParse"in e))return{data:t};let a=[],s=e.safeParse(t);if(a.push({result:s,data:t,structure:"direct"}),s.success)return{data:t};if(t&&"object"==typeof t&&"context"in t){let r=t.context,s=e.safeParse(r);if(a.push({result:s,data:r,structure:"context"}),s.success)return{data:{...t,context:s.data}};if(r&&"object"==typeof r&&"inputData"in r){let s=r.inputData,n=e.safeParse(s);if(a.push({result:n,data:s,structure:"inputData"}),n.success){let e=Object.keys(r);return 1===e.length&&"inputData"===e[0]?{data:{...t,context:{inputData:n.data}}}:{data:n.data}}}}let n=a[0];for(let e of a)!e.result.success&&e.result.error.issues.length>0&&(n=e);if(n&&!n.result.success){let e=n.result.error.issues.map(e=>`- ${e.path?.join(".")||"root"}: ${e.message}`).join("\n");return{data:t,error:{error:!0,message:`Tool validation failed${r?` for ${r}`:""}. Please fix the following errors and try again:
${e}

Provided arguments: ${JSON.stringify(n.data,null,2)}`,validationErrors:n.result.error.format()}}}return{data:t}}var ra=class{id;description;inputSchema;outputSchema;suspendSchema;resumeSchema;execute;mastra;requireApproval;constructor(e){if(this.id=e.id,this.description=e.description,this.inputSchema=e.inputSchema,this.outputSchema=e.outputSchema,this.suspendSchema=e.suspendSchema,this.resumeSchema=e.resumeSchema,this.mastra=e.mastra,this.requireApproval=e.requireApproval||!1,e.execute){const t=e.execute;this.execute=async(e,r)=>{let{resumeData:a,suspend:s}=r??{},{data:n,error:i}=rr(this.inputSchema,e,this.id);return i||t({...n,suspend:s,resumeData:a},r)}}}};function rs(e){return new ra(e)}function rn(e){return!!(e&&!(e instanceof ra)&&"parameters"in e)}var ri=e.i(254799);let ro=(e,t)=>e.anyOf.length?1===e.anyOf.length?rh(e.anyOf[0],{...t,path:[...t.path,"anyOf",0]}):`z.union([${e.anyOf.map((e,r)=>rh(e,{...t,path:[...t.path,"anyOf",r]})).join(", ")}])`:"z.any()",rl=Symbol("Original index");function ru(e,t){if(0===e.allOf.length)return"z.never()";if(1===e.allOf.length){let r=e.allOf[0];return rh(r,{...t,path:[...t.path,"allOf",r[rl]]})}{let r,[a,s]=[(r=(e=>{let t=[];for(let r=0;r<e.length;r++){let a=e[r];if("boolean"==typeof a)t.push(a?{[rl]:r}:{[rl]:r,not:{}});else{if(rl in a)return e;t.push({...a,[rl]:r})}}return t})(e.allOf)).slice(0,r.length/2),r.slice(r.length/2)];return`z.intersection(${ru({allOf:a},t)}, ${ru({allOf:s},t)})`}}function rd(e,t,r){let a=e[t],s="";if(void 0!==a){let n=r({value:a,json:JSON.stringify(a)});if(n){let r=n[0],a=3===n.length?n[1]:"",i=3===n.length?n[2]:n[1];s+=r,e.errorMessage?.[t]!==void 0&&(s+=a+JSON.stringify(e.errorMessage[t])),s+=i}}return s}let rp=(e,t)=>e.oneOf.length?1===e.oneOf.length?rh(e.oneOf[0],{...t,path:[...t.path,"oneOf",0]}):`z.any().superRefine((x, ctx) => {
    const schemas = [${e.oneOf.map((e,r)=>rh(e,{...t,path:[...t.path,"oneOf",r]})).join(", ")}];
    const errors = schemas.reduce<z.ZodError[]>(
      (errors, schema) =>
        ((result) =>
          result.error ? [...errors, result.error] : errors)(
          schema.safeParse(x),
        ),
      [],
    );
    if (schemas.length - errors.length !== 1) {
      ctx.addIssue({
        path: ctx.path,
        code: "invalid_union",
        unionErrors: errors,
        message: "Invalid input: Should pass single schema",
      });
    }
  })`:"z.any()",rc=e=>{let t=e.split("\n"),r=1===t.length?t[0]:`
${t.map(e=>`* ${e}`).join("\n")}
`;return`/**${r}*/
`},rh=(e,t={seen:new Map,path:[]},r)=>{if("object"!=typeof e)return e?"z.any()":"z.never()";if(t.parserOverride){let r=t.parserOverride(e,t);if("string"==typeof r)return r}let a=t.seen.get(e);if(a){if(void 0!==a.r)return a.r;if(void 0===t.depth||a.n>=t.depth)return"z.any()";a.n+=1}else a={r:void 0,n:0},t.seen.set(e,a);let s=ry(e,t);return r||(t.withoutDescribes||(s=rm(e,s)),t.withoutDefaults||(s=rg(e,s)),s=rf(e,s)),a.r=s,s},rm=(e,t)=>(e.description&&(t+=`.describe(${JSON.stringify(e.description)})`),t),rg=(e,t)=>(void 0!==e.default&&(t+=`.default(${JSON.stringify(e.default)})`),t),rf=(e,t)=>(e.readOnly&&(t+=".readonly()"),t),ry=(e,t)=>{if(rv.a.nullable(e))return`${rh(((e,...t)=>Object.keys(e).reduce((r,a)=>(t.includes(a)||(r[a]=e[a]),r),{}))(e,"nullable"),t,!0)}.nullable()`;if(rv.an.object(e))return function(e,t){let r,a;e.properties&&(r=Object.keys(e.properties).length?"z.object({ "+Object.keys(e.properties).map(r=>{var a;let s,n=e.properties[r],i=`${JSON.stringify(r)}: ${rh(n,{...t,path:[...t.path,"properties",r]})}`;t.withJsdocs&&"object"==typeof n&&(a=i,i=(s=n.description)?`
${rc(s)}${a}`:a);let o="object"==typeof n&&void 0!==n.default,l=Array.isArray(e.required)?e.required.includes(r):"object"==typeof n&&!0===n.required;return o||l?i:`${i}.optional()`}).join(", ")+" })":"z.object({})");let s=void 0!==e.additionalProperties?rh(e.additionalProperties,{...t,path:[...t.path,"additionalProperties"]}):void 0;if(e.patternProperties){let n=Object.fromEntries(Object.entries(e.patternProperties).map(([e,r])=>[e,rh(r,{...t,path:[...t.path,"patternProperties",e]})],{}));for(let t in a="",r?s?a+=`.catchall(z.union([${[...Object.values(n),s].join(", ")}]))`:Object.keys(n).length>1?a+=`.catchall(z.union([${Object.values(n).join(", ")}]))`:a+=`.catchall(${Object.values(n)})`:s?a+=`z.record(z.union([${[...Object.values(n),s].join(", ")}]))`:Object.keys(n).length>1?a+=`z.record(z.union([${Object.values(n).join(", ")}]))`:a+=`z.record(${Object.values(n)})`,a+=".superRefine((value, ctx) => {\nfor (const key in value) {\n",s&&(e.properties?a+=`let evaluated = [${Object.keys(e.properties).map(e=>JSON.stringify(e)).join(", ")}].includes(key)
`:a+=`let evaluated = false
`),e.patternProperties)a+="if (key.match(new RegExp("+JSON.stringify(t)+"))) {\n",s&&(a+="evaluated = true\n"),a+="const result = "+n[t]+".safeParse(value[key])\nif (!result.success) {\n"+`ctx.addIssue({
          path: [...ctx.path, key],
          code: 'custom',
          message: \`Invalid input: Key matching regex /\${key}/ must match schema\`,
          params: {
            issues: result.error.issues
          }
        })
`+"}\n}\n";s&&(a+="if (!evaluated) {\n"+("const result = "+s+".safeParse(value[key])\n")+"if (!result.success) {\n"+`ctx.addIssue({
          path: [...ctx.path, key],
          code: 'custom',
          message: \`Invalid input: must match catchall schema\`,
          params: {
            issues: result.error.issues
          }
        })
`+"}\n}\n"),a+="}\n})"}let n=r?a?r+a:s?"z.never()"===s?r+".strict()":r+`.catchall(${s})`:r:a||(s?`z.record(${s})`:"z.record(z.any())");return rv.an.anyOf(e)&&(n+=`.and(${ro({...e,anyOf:e.anyOf.map(e=>"object"==typeof e&&!e.type&&(e.properties||e.additionalProperties||e.patternProperties)?{...e,type:"object"}:e)},t)})`),rv.a.oneOf(e)&&(n+=`.and(${rp({...e,oneOf:e.oneOf.map(e=>"object"==typeof e&&!e.type&&(e.properties||e.additionalProperties||e.patternProperties)?{...e,type:"object"}:e)},t)})`),rv.an.allOf(e)&&(n+=`.and(${ru({...e,allOf:e.allOf.map(e=>"object"==typeof e&&!e.type&&(e.properties||e.additionalProperties||e.patternProperties)?{...e,type:"object"}:e)},t)})`),n}(e,t);if(rv.an.array(e)){if(Array.isArray(e.items))return`z.tuple([${e.items.map((e,r)=>rh(e,{...t,path:[...t.path,"items",r]}))}])`;let r=e.items?`z.array(${rh(e.items,{...t,path:[...t.path,"items"]})})`:"z.array(z.any())";return r+=rd(e,"minItems",({json:e})=>[`.min(${e}`,", ",")"]),r+=rd(e,"maxItems",({json:e})=>[`.max(${e}`,", ",")"]),!0===e.uniqueItems&&(r+=rd(e,"uniqueItems",()=>[".unique(","",")"])),r}if(rv.an.anyOf(e))return ro(e,t);if(rv.an.allOf(e))return ru(e,t);else if(rv.a.simpleDiscriminatedOneOf(e))return e.oneOf.length?1===e.oneOf.length?rh(e.oneOf[0],{...t,path:[...t.path,"oneOf",0]}):`z.discriminatedUnion("${e.discriminator.propertyName}", [${e.oneOf.map((e,r)=>rh(e,{...t,path:[...t.path,"oneOf",r]})).join(", ")}])`:"z.any()";else if(rv.a.oneOf(e))return rp(e,t);else if(rv.a.not(e))return`z.any().refine((value) => !${rh(e.not,{...t,path:[...t.path,"not"]})}.safeParse(value).success, "Invalid input: Should NOT be valid against schema")`;else if(rv.an.enum(e))return 0===e.enum.length?"z.never()":1===e.enum.length?`z.literal(${JSON.stringify(e.enum[0])})`:e.enum.every(e=>"string"==typeof e)?`z.enum([${e.enum.map(e=>JSON.stringify(e))}])`:`z.union([${e.enum.map(e=>`z.literal(${JSON.stringify(e)})`).join(", ")}])`;else if(rv.a.const(e))return`z.literal(${JSON.stringify(e.const)})`;else if(rv.a.multipleType(e))return`z.union([${e.type.map(r=>rh({...e,type:r},{...t,withoutDefaults:!0})).join(", ")}])`;else if(rv.a.primitive(e,"string")){let t,r;return t="z.string()"+rd(e,"format",({value:e})=>{switch(e){case"email":return[".email(",")"];case"ip":return[".ip(",")"];case"ipv4":return['.ip({ version: "v4"',", message: "," })"];case"ipv6":return['.ip({ version: "v6"',", message: "," })"];case"uri":return[".url(",")"];case"uuid":return[".uuid(",")"];case"date-time":return[".datetime({ offset: true",", message: "," })"];case"time":return[".time(",")"];case"date":return[".date(",")"];case"binary":return[".base64(",")"];case"duration":return[".duration(",")"]}})+rd(e,"pattern",({json:e})=>[`.regex(new RegExp(${e})`,", ",")"])+rd(e,"minLength",({json:e})=>[`.min(${e}`,", ",")"])+rd(e,"maxLength",({json:e})=>[`.max(${e}`,", ",")"])+rd(e,"contentEncoding",({value:e})=>{if("base64"===e)return[".base64(",")"]}),""!=(r=rd(e,"contentMediaType",({value:e})=>{if("application/json"===e)return['.transform((str, ctx) => { try { return JSON.parse(str); } catch (err) { ctx.addIssue({ code: "custom", message: "Invalid JSON" }); }}',", ",")"]}))&&(t+=r,t+=rd(e,"contentSchema",({value:e})=>{if(e&&e instanceof Object)return[`.pipe(${rh(e)}`,", ",")"]})),t}else if(rv.a.primitive(e,"number")||rv.a.primitive(e,"integer")){let t;return t="z.number()","integer"===e.type?t+=rd(e,"type",()=>[".int(",")"]):t+=rd(e,"format",({value:e})=>{if("int64"===e)return[".int(",")"]}),t+=rd(e,"multipleOf",({value:e,json:r})=>{if(1===e){if(t.startsWith("z.number().int("))return;return[".int(",")"]}return[`.multipleOf(${r}`,", ",")"]}),"number"==typeof e.minimum?!0===e.exclusiveMinimum?t+=rd(e,"minimum",({json:e})=>[`.gt(${e}`,", ",")"]):t+=rd(e,"minimum",({json:e})=>[`.gte(${e}`,", ",")"]):"number"==typeof e.exclusiveMinimum&&(t+=rd(e,"exclusiveMinimum",({json:e})=>[`.gt(${e}`,", ",")"])),"number"==typeof e.maximum?!0===e.exclusiveMaximum?t+=rd(e,"maximum",({json:e})=>[`.lt(${e}`,", ",")"]):t+=rd(e,"maximum",({json:e})=>[`.lte(${e}`,", ",")"]):"number"==typeof e.exclusiveMaximum&&(t+=rd(e,"exclusiveMaximum",({json:e})=>[`.lt(${e}`,", ",")"])),t}else{if(rv.a.primitive(e,"boolean"))return"z.boolean()";if(rv.a.primitive(e,"null"))return"z.null()";if(!rv.a.conditional(e))return"z.any()";let r,a,s;return r=rh(e.if,{...t,path:[...t.path,"if"]}),a=rh(e.then,{...t,path:[...t.path,"then"]}),s=rh(e.else,{...t,path:[...t.path,"else"]}),`z.union([${a}, ${s}]).superRefine((value,ctx) => {
  const result = ${r}.safeParse(value).success
    ? ${a}.safeParse(value)
    : ${s}.safeParse(value);
  if (!result.success) {
    result.error.errors.forEach((error) => ctx.addIssue(error))
  }
})`}},rv={an:{object:e=>"object"===e.type,array:e=>"array"===e.type,anyOf:e=>void 0!==e.anyOf,allOf:e=>void 0!==e.allOf,enum:e=>void 0!==e.enum},a:{nullable:e=>!0===e.nullable,multipleType:e=>Array.isArray(e.type),not:e=>void 0!==e.not,const:e=>void 0!==e.const,primitive:(e,t)=>e.type===t,conditional:e=>!!("if"in e&&e.if&&"then"in e&&"else"in e&&e.then&&e.else),simpleDiscriminatedOneOf:e=>{if(!e.oneOf||!Array.isArray(e.oneOf)||0===e.oneOf.length||!e.discriminator||"object"!=typeof e.discriminator||!("propertyName"in e.discriminator)||"string"!=typeof e.discriminator.propertyName)return!1;let t=e.discriminator.propertyName;return e.oneOf.every(e=>{if(!e||"object"!=typeof e||"object"!==e.type||!e.properties||"object"!=typeof e.properties||!(t in e.properties))return!1;let r=e.properties[t];return r&&"object"==typeof r&&"string"===r.type&&(void 0!==r.const||r.enum&&Array.isArray(r.enum)&&1===r.enum.length)&&Array.isArray(e.required)&&e.required.includes(t)})},oneOf:e=>void 0!==e.oneOf}};var rb=e.i(469719);let rw=Symbol("Let zodToJsonSchema decide on which parser to use"),r_={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",allowedAdditionalProperties:!0,rejectedAdditionalProperties:!1,definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref",openAiAnyTypeName:"OpenAiAnyType"};function rS(e,t,r,a){a?.errorMessages&&r&&(e.errorMessage={...e.errorMessage,[t]:r})}function rx(e,t,r,a,s){e[t]=r,rS(e,t,a,s)}let rI=(e,t)=>{let r=0;for(;r<e.length&&r<t.length&&e[r]===t[r];r++);return[(e.length-r).toString(),...t.slice(r)].join("/")};(d=j||(j={})).assertEqual=e=>{},d.assertIs=function(e){},d.assertNever=function(e){throw Error()},d.arrayToEnum=e=>{let t={};for(let r of e)t[r]=r;return t},d.getValidEnumValues=e=>{let t=d.objectKeys(e).filter(t=>"number"!=typeof e[e[t]]),r={};for(let a of t)r[a]=e[a];return d.objectValues(r)},d.objectValues=e=>d.objectKeys(e).map(function(t){return e[t]}),d.objectKeys="function"==typeof Object.keys?e=>Object.keys(e):e=>{let t=[];for(let r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.push(r);return t},d.find=(e,t)=>{for(let r of e)if(t(r))return r},d.isInteger="function"==typeof Number.isInteger?e=>Number.isInteger(e):e=>"number"==typeof e&&Number.isFinite(e)&&Math.floor(e)===e,d.joinValues=function(e,t=" | "){return e.map(e=>"string"==typeof e?`'${e}'`:e).join(t)},d.jsonStringifyReplacer=(e,t)=>"bigint"==typeof t?t.toString():t,(P||(P={})).mergeShapes=(e,t)=>({...e,...t});let rk=j.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),rT=e=>{switch(typeof e){case"undefined":return rk.undefined;case"string":return rk.string;case"number":return Number.isNaN(e)?rk.nan:rk.number;case"boolean":return rk.boolean;case"function":return rk.function;case"bigint":return rk.bigint;case"symbol":return rk.symbol;case"object":if(Array.isArray(e))return rk.array;if(null===e)return rk.null;if(e.then&&"function"==typeof e.then&&e.catch&&"function"==typeof e.catch)return rk.promise;if("undefined"!=typeof Map&&e instanceof Map)return rk.map;if("undefined"!=typeof Set&&e instanceof Set)return rk.set;if("undefined"!=typeof Date&&e instanceof Date)return rk.date;return rk.object;default:return rk.unknown}};e.s(["ZodParsedType",0,rk,"getParsedType",0,rT,"objectUtil",()=>P,"util",()=>j],742944);let rE=j.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]),rA=e=>JSON.stringify(e,null,2).replace(/"([^"]+)":/g,"$1:");class rO extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=e=>{this.issues=[...this.issues,e]},this.addIssues=(e=[])=>{this.issues=[...this.issues,...e]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}format(e){let t=e||function(e){return e.message},r={_errors:[]},a=e=>{for(let s of e.issues)if("invalid_union"===s.code)s.unionErrors.map(a);else if("invalid_return_type"===s.code)a(s.returnTypeError);else if("invalid_arguments"===s.code)a(s.argumentsError);else if(0===s.path.length)r._errors.push(t(s));else{let e=r,a=0;for(;a<s.path.length;){let r=s.path[a];a===s.path.length-1?(e[r]=e[r]||{_errors:[]},e[r]._errors.push(t(s))):e[r]=e[r]||{_errors:[]},e=e[r],a++}}};return a(this),r}static assert(e){if(!(e instanceof rO))throw Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,j.jsonStringifyReplacer,2)}get isEmpty(){return 0===this.issues.length}flatten(e=e=>e.message){let t=Object.create(null),r=[];for(let a of this.issues)if(a.path.length>0){let r=a.path[0];t[r]=t[r]||[],t[r].push(e(a))}else r.push(e(a));return{formErrors:r,fieldErrors:t}}get formErrors(){return this.flatten()}}rO.create=e=>new rO(e),e.s(["ZodError",()=>rO,"ZodIssueCode",0,rE,"quotelessJson",0,rA],115235);let rC=(e,t)=>{let r;switch(e.code){case rE.invalid_type:r=e.received===rk.undefined?"Required":`Expected ${e.expected}, received ${e.received}`;break;case rE.invalid_literal:r=`Invalid literal value, expected ${JSON.stringify(e.expected,j.jsonStringifyReplacer)}`;break;case rE.unrecognized_keys:r=`Unrecognized key(s) in object: ${j.joinValues(e.keys,", ")}`;break;case rE.invalid_union:r="Invalid input";break;case rE.invalid_union_discriminator:r=`Invalid discriminator value. Expected ${j.joinValues(e.options)}`;break;case rE.invalid_enum_value:r=`Invalid enum value. Expected ${j.joinValues(e.options)}, received '${e.received}'`;break;case rE.invalid_arguments:r="Invalid function arguments";break;case rE.invalid_return_type:r="Invalid function return type";break;case rE.invalid_date:r="Invalid date";break;case rE.invalid_string:"object"==typeof e.validation?"includes"in e.validation?(r=`Invalid input: must include "${e.validation.includes}"`,"number"==typeof e.validation.position&&(r=`${r} at one or more positions greater than or equal to ${e.validation.position}`)):"startsWith"in e.validation?r=`Invalid input: must start with "${e.validation.startsWith}"`:"endsWith"in e.validation?r=`Invalid input: must end with "${e.validation.endsWith}"`:j.assertNever(e.validation):r="regex"!==e.validation?`Invalid ${e.validation}`:"Invalid";break;case rE.too_small:r="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at least":"more than"} ${e.minimum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at least":"over"} ${e.minimum} character(s)`:"number"===e.type||"bigint"===e.type?`Number must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${e.minimum}`:"date"===e.type?`Date must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(e.minimum))}`:"Invalid input";break;case rE.too_big:r="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at most":"less than"} ${e.maximum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at most":"under"} ${e.maximum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"bigint"===e.type?`BigInt must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"date"===e.type?`Date must be ${e.exact?"exactly":e.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(e.maximum))}`:"Invalid input";break;case rE.custom:r="Invalid input";break;case rE.invalid_intersection_types:r="Intersection results could not be merged";break;case rE.not_multiple_of:r=`Number must be a multiple of ${e.multipleOf}`;break;case rE.not_finite:r="Number must be finite";break;default:r=t.defaultError,j.assertNever(e)}return{message:r}},rR=rC;function rM(e){rR=e}function rN(){return rR}e.s(["getErrorMap",()=>rN,"setErrorMap",()=>rM],585676);let rj=e=>{let{data:t,path:r,errorMaps:a,issueData:s}=e,n=[...r,...s.path||[]],i={...s,path:n};if(void 0!==s.message)return{...s,path:n,message:s.message};let o="";for(let e of a.filter(e=>!!e).slice().reverse())o=e(i,{data:t,defaultError:o}).message;return{...s,path:n,message:o}},rP=[];function r$(e,t){let r=rR,a=rj({issueData:t,data:e.data,path:e.path,errorMaps:[e.common.contextualErrorMap,e.schemaErrorMap,r,r===rC?void 0:rC].filter(e=>!!e)});e.common.issues.push(a)}class rD{constructor(){this.value="valid"}dirty(){"valid"===this.value&&(this.value="dirty")}abort(){"aborted"!==this.value&&(this.value="aborted")}static mergeArray(e,t){let r=[];for(let a of t){if("aborted"===a.status)return rL;"dirty"===a.status&&e.dirty(),r.push(a.value)}return{status:e.value,value:r}}static async mergeObjectAsync(e,t){let r=[];for(let e of t){let t=await e.key,a=await e.value;r.push({key:t,value:a})}return rD.mergeObjectSync(e,r)}static mergeObjectSync(e,t){let r={};for(let a of t){let{key:t,value:s}=a;if("aborted"===t.status||"aborted"===s.status)return rL;"dirty"===t.status&&e.dirty(),"dirty"===s.status&&e.dirty(),"__proto__"!==t.value&&(void 0!==s.value||a.alwaysSet)&&(r[t.value]=s.value)}return{status:e.value,value:r}}}let rL=Object.freeze({status:"aborted"}),rU=e=>({status:"dirty",value:e}),rz=e=>({status:"valid",value:e}),rq=e=>"aborted"===e.status,rV=e=>"dirty"===e.status,rF=e=>"valid"===e.status,rZ=e=>"undefined"!=typeof Promise&&e instanceof Promise;e.s(["DIRTY",0,rU,"EMPTY_PATH",0,rP,"INVALID",0,rL,"OK",0,rz,"ParseStatus",()=>rD,"addIssueToContext",()=>r$,"isAborted",0,rq,"isAsync",0,rZ,"isDirty",0,rV,"isValid",0,rF,"makeIssue",0,rj],984488),e.s([],91316),(p=$||($={})).errToObj=e=>"string"==typeof e?{message:e}:e||{},p.toString=e=>"string"==typeof e?e:e?.message;class rW{constructor(e,t,r,a){this._cachedPath=[],this.parent=e,this.data=t,this._path=r,this._key=a}get path(){return this._cachedPath.length||(Array.isArray(this._key)?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}let rG=(e,t)=>{if(rF(t))return{success:!0,data:t.value};if(!e.common.issues.length)throw Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;let t=new rO(e.common.issues);return this._error=t,this._error}}};function rB(e){if(!e)return{};let{errorMap:t,invalid_type_error:r,required_error:a,description:s}=e;if(t&&(r||a))throw Error('Can\'t use "invalid_type_error" or "required_error" in conjunction with custom error map.');return t?{errorMap:t,description:s}:{errorMap:(t,s)=>{let{message:n}=e;return"invalid_enum_value"===t.code?{message:n??s.defaultError}:void 0===s.data?{message:n??a??s.defaultError}:"invalid_type"!==t.code?{message:s.defaultError}:{message:n??r??s.defaultError}},description:s}}class rK{get description(){return this._def.description}_getType(e){return rT(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:rT(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new rD,ctx:{common:e.parent.common,data:e.data,parsedType:rT(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){let t=this._parse(e);if(rZ(t))throw Error("Synchronous parse encountered promise.");return t}_parseAsync(e){return Promise.resolve(this._parse(e))}parse(e,t){let r=this.safeParse(e,t);if(r.success)return r.data;throw r.error}safeParse(e,t){let r={common:{issues:[],async:t?.async??!1,contextualErrorMap:t?.errorMap},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:rT(e)},a=this._parseSync({data:e,path:r.path,parent:r});return rG(r,a)}"~validate"(e){let t={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:rT(e)};if(!this["~standard"].async)try{let r=this._parseSync({data:e,path:[],parent:t});return rF(r)?{value:r.value}:{issues:t.common.issues}}catch(e){e?.message?.toLowerCase()?.includes("encountered")&&(this["~standard"].async=!0),t.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:t}).then(e=>rF(e)?{value:e.value}:{issues:t.common.issues})}async parseAsync(e,t){let r=await this.safeParseAsync(e,t);if(r.success)return r.data;throw r.error}async safeParseAsync(e,t){let r={common:{issues:[],contextualErrorMap:t?.errorMap,async:!0},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:rT(e)},a=this._parse({data:e,path:r.path,parent:r});return rG(r,await (rZ(a)?a:Promise.resolve(a)))}refine(e,t){return this._refinement((r,a)=>{let s=e(r),n=()=>a.addIssue({code:rE.custom,..."string"==typeof t||void 0===t?{message:t}:"function"==typeof t?t(r):t});return"undefined"!=typeof Promise&&s instanceof Promise?s.then(e=>!!e||(n(),!1)):!!s||(n(),!1)})}refinement(e,t){return this._refinement((r,a)=>!!e(r)||(a.addIssue("function"==typeof t?t(r,a):t),!1))}_refinement(e){return new aM({schema:this,typeName:D.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:e=>this["~validate"](e)}}optional(){return aN.create(this,this._def)}nullable(){return aj.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return ag.create(this)}promise(){return aR.create(this,this._def)}or(e){return ay.create([this,e],this._def)}and(e){return aw.create(this,e,this._def)}transform(e){return new aM({...rB(this._def),schema:this,typeName:D.ZodEffects,effect:{type:"transform",transform:e}})}default(e){return new aP({...rB(this._def),innerType:this,defaultValue:"function"==typeof e?e:()=>e,typeName:D.ZodDefault})}brand(){return new aU({typeName:D.ZodBranded,type:this,...rB(this._def)})}catch(e){return new a$({...rB(this._def),innerType:this,catchValue:"function"==typeof e?e:()=>e,typeName:D.ZodCatch})}describe(e){return new this.constructor({...this._def,description:e})}pipe(e){return az.create(this,e)}readonly(){return aq.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}let rJ=/^c[^\s-]{8,}$/i,rH=/^[0-9a-z]+$/,rY=/^[0-9A-HJKMNP-TV-Z]{26}$/i,rQ=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,rX=/^[a-z0-9_-]{21}$/i,r0=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,r1=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,r2=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,r4=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,r5=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,r3=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,r9=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,r6=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,r8=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,r7="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",ae=RegExp(`^${r7}$`);function at(e){let t="[0-5]\\d";e.precision?t=`${t}\\.\\d{${e.precision}}`:null==e.precision&&(t=`${t}(\\.\\d+)?`);let r=e.precision?"+":"?";return`([01]\\d|2[0-3]):[0-5]\\d(:${t})${r}`}function ar(e){let t=`${r7}T${at(e)}`,r=[];return r.push(e.local?"Z?":"Z"),e.offset&&r.push("([+-]\\d{2}:?\\d{2})"),t=`${t}(${r.join("|")})`,RegExp(`^${t}$`)}class aa extends rK{_parse(e){var r,a,s,n;let i;if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==rk.string){let t=this._getOrReturnCtx(e);return r$(t,{code:rE.invalid_type,expected:rk.string,received:t.parsedType}),rL}let o=new rD;for(let l of this._def.checks)if("min"===l.kind)e.data.length<l.value&&(r$(i=this._getOrReturnCtx(e,i),{code:rE.too_small,minimum:l.value,type:"string",inclusive:!0,exact:!1,message:l.message}),o.dirty());else if("max"===l.kind)e.data.length>l.value&&(r$(i=this._getOrReturnCtx(e,i),{code:rE.too_big,maximum:l.value,type:"string",inclusive:!0,exact:!1,message:l.message}),o.dirty());else if("length"===l.kind){let t=e.data.length>l.value,r=e.data.length<l.value;(t||r)&&(i=this._getOrReturnCtx(e,i),t?r$(i,{code:rE.too_big,maximum:l.value,type:"string",inclusive:!0,exact:!0,message:l.message}):r&&r$(i,{code:rE.too_small,minimum:l.value,type:"string",inclusive:!0,exact:!0,message:l.message}),o.dirty())}else if("email"===l.kind)r2.test(e.data)||(r$(i=this._getOrReturnCtx(e,i),{validation:"email",code:rE.invalid_string,message:l.message}),o.dirty());else if("emoji"===l.kind)t||(t=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),t.test(e.data)||(r$(i=this._getOrReturnCtx(e,i),{validation:"emoji",code:rE.invalid_string,message:l.message}),o.dirty());else if("uuid"===l.kind)rQ.test(e.data)||(r$(i=this._getOrReturnCtx(e,i),{validation:"uuid",code:rE.invalid_string,message:l.message}),o.dirty());else if("nanoid"===l.kind)rX.test(e.data)||(r$(i=this._getOrReturnCtx(e,i),{validation:"nanoid",code:rE.invalid_string,message:l.message}),o.dirty());else if("cuid"===l.kind)rJ.test(e.data)||(r$(i=this._getOrReturnCtx(e,i),{validation:"cuid",code:rE.invalid_string,message:l.message}),o.dirty());else if("cuid2"===l.kind)rH.test(e.data)||(r$(i=this._getOrReturnCtx(e,i),{validation:"cuid2",code:rE.invalid_string,message:l.message}),o.dirty());else if("ulid"===l.kind)rY.test(e.data)||(r$(i=this._getOrReturnCtx(e,i),{validation:"ulid",code:rE.invalid_string,message:l.message}),o.dirty());else if("url"===l.kind)try{new URL(e.data)}catch{r$(i=this._getOrReturnCtx(e,i),{validation:"url",code:rE.invalid_string,message:l.message}),o.dirty()}else"regex"===l.kind?(l.regex.lastIndex=0,l.regex.test(e.data)||(r$(i=this._getOrReturnCtx(e,i),{validation:"regex",code:rE.invalid_string,message:l.message}),o.dirty())):"trim"===l.kind?e.data=e.data.trim():"includes"===l.kind?e.data.includes(l.value,l.position)||(r$(i=this._getOrReturnCtx(e,i),{code:rE.invalid_string,validation:{includes:l.value,position:l.position},message:l.message}),o.dirty()):"toLowerCase"===l.kind?e.data=e.data.toLowerCase():"toUpperCase"===l.kind?e.data=e.data.toUpperCase():"startsWith"===l.kind?e.data.startsWith(l.value)||(r$(i=this._getOrReturnCtx(e,i),{code:rE.invalid_string,validation:{startsWith:l.value},message:l.message}),o.dirty()):"endsWith"===l.kind?e.data.endsWith(l.value)||(r$(i=this._getOrReturnCtx(e,i),{code:rE.invalid_string,validation:{endsWith:l.value},message:l.message}),o.dirty()):"datetime"===l.kind?ar(l).test(e.data)||(r$(i=this._getOrReturnCtx(e,i),{code:rE.invalid_string,validation:"datetime",message:l.message}),o.dirty()):"date"===l.kind?ae.test(e.data)||(r$(i=this._getOrReturnCtx(e,i),{code:rE.invalid_string,validation:"date",message:l.message}),o.dirty()):"time"===l.kind?RegExp(`^${at(l)}$`).test(e.data)||(r$(i=this._getOrReturnCtx(e,i),{code:rE.invalid_string,validation:"time",message:l.message}),o.dirty()):"duration"===l.kind?r1.test(e.data)||(r$(i=this._getOrReturnCtx(e,i),{validation:"duration",code:rE.invalid_string,message:l.message}),o.dirty()):"ip"===l.kind?(r=e.data,!(("v4"===(a=l.version)||!a)&&r4.test(r)||("v6"===a||!a)&&r3.test(r))&&1&&(r$(i=this._getOrReturnCtx(e,i),{validation:"ip",code:rE.invalid_string,message:l.message}),o.dirty())):"jwt"===l.kind?!function(e,t){if(!r0.test(e))return!1;try{let[r]=e.split(".");if(!r)return!1;let a=r.replace(/-/g,"+").replace(/_/g,"/").padEnd(r.length+(4-r.length%4)%4,"="),s=JSON.parse(atob(a));if("object"!=typeof s||null===s||"typ"in s&&s?.typ!=="JWT"||!s.alg||t&&s.alg!==t)return!1;return!0}catch{return!1}}(e.data,l.alg)&&(r$(i=this._getOrReturnCtx(e,i),{validation:"jwt",code:rE.invalid_string,message:l.message}),o.dirty()):"cidr"===l.kind?(s=e.data,!(("v4"===(n=l.version)||!n)&&r5.test(s)||("v6"===n||!n)&&r9.test(s))&&1&&(r$(i=this._getOrReturnCtx(e,i),{validation:"cidr",code:rE.invalid_string,message:l.message}),o.dirty())):"base64"===l.kind?r6.test(e.data)||(r$(i=this._getOrReturnCtx(e,i),{validation:"base64",code:rE.invalid_string,message:l.message}),o.dirty()):"base64url"===l.kind?r8.test(e.data)||(r$(i=this._getOrReturnCtx(e,i),{validation:"base64url",code:rE.invalid_string,message:l.message}),o.dirty()):j.assertNever(l);return{status:o.value,value:e.data}}_regex(e,t,r){return this.refinement(t=>e.test(t),{validation:t,code:rE.invalid_string,...$.errToObj(r)})}_addCheck(e){return new aa({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...$.errToObj(e)})}url(e){return this._addCheck({kind:"url",...$.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...$.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...$.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...$.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...$.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...$.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...$.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...$.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...$.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...$.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...$.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...$.errToObj(e)})}datetime(e){return"string"==typeof e?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:void 0===e?.precision?null:e?.precision,offset:e?.offset??!1,local:e?.local??!1,...$.errToObj(e?.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return"string"==typeof e?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:void 0===e?.precision?null:e?.precision,...$.errToObj(e?.message)})}duration(e){return this._addCheck({kind:"duration",...$.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...$.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t?.position,...$.errToObj(t?.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...$.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...$.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...$.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...$.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...$.errToObj(t)})}nonempty(e){return this.min(1,$.errToObj(e))}trim(){return new aa({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new aa({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new aa({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>"datetime"===e.kind)}get isDate(){return!!this._def.checks.find(e=>"date"===e.kind)}get isTime(){return!!this._def.checks.find(e=>"time"===e.kind)}get isDuration(){return!!this._def.checks.find(e=>"duration"===e.kind)}get isEmail(){return!!this._def.checks.find(e=>"email"===e.kind)}get isURL(){return!!this._def.checks.find(e=>"url"===e.kind)}get isEmoji(){return!!this._def.checks.find(e=>"emoji"===e.kind)}get isUUID(){return!!this._def.checks.find(e=>"uuid"===e.kind)}get isNANOID(){return!!this._def.checks.find(e=>"nanoid"===e.kind)}get isCUID(){return!!this._def.checks.find(e=>"cuid"===e.kind)}get isCUID2(){return!!this._def.checks.find(e=>"cuid2"===e.kind)}get isULID(){return!!this._def.checks.find(e=>"ulid"===e.kind)}get isIP(){return!!this._def.checks.find(e=>"ip"===e.kind)}get isCIDR(){return!!this._def.checks.find(e=>"cidr"===e.kind)}get isBase64(){return!!this._def.checks.find(e=>"base64"===e.kind)}get isBase64url(){return!!this._def.checks.find(e=>"base64url"===e.kind)}get minLength(){let e=null;for(let t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(let t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}aa.create=e=>new aa({checks:[],typeName:D.ZodString,coerce:e?.coerce??!1,...rB(e)});class as extends rK{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){let t;if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==rk.number){let t=this._getOrReturnCtx(e);return r$(t,{code:rE.invalid_type,expected:rk.number,received:t.parsedType}),rL}let r=new rD;for(let a of this._def.checks)"int"===a.kind?j.isInteger(e.data)||(r$(t=this._getOrReturnCtx(e,t),{code:rE.invalid_type,expected:"integer",received:"float",message:a.message}),r.dirty()):"min"===a.kind?(a.inclusive?e.data<a.value:e.data<=a.value)&&(r$(t=this._getOrReturnCtx(e,t),{code:rE.too_small,minimum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),r.dirty()):"max"===a.kind?(a.inclusive?e.data>a.value:e.data>=a.value)&&(r$(t=this._getOrReturnCtx(e,t),{code:rE.too_big,maximum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),r.dirty()):"multipleOf"===a.kind?0!==function(e,t){let r=(e.toString().split(".")[1]||"").length,a=(t.toString().split(".")[1]||"").length,s=r>a?r:a;return Number.parseInt(e.toFixed(s).replace(".",""))%Number.parseInt(t.toFixed(s).replace(".",""))/10**s}(e.data,a.value)&&(r$(t=this._getOrReturnCtx(e,t),{code:rE.not_multiple_of,multipleOf:a.value,message:a.message}),r.dirty()):"finite"===a.kind?Number.isFinite(e.data)||(r$(t=this._getOrReturnCtx(e,t),{code:rE.not_finite,message:a.message}),r.dirty()):j.assertNever(a);return{status:r.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,$.toString(t))}gt(e,t){return this.setLimit("min",e,!1,$.toString(t))}lte(e,t){return this.setLimit("max",e,!0,$.toString(t))}lt(e,t){return this.setLimit("max",e,!1,$.toString(t))}setLimit(e,t,r,a){return new as({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:$.toString(a)}]})}_addCheck(e){return new as({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:$.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:$.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:$.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:$.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:$.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:$.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:$.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:$.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:$.toString(e)})}get minValue(){let e=null;for(let t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(let t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>"int"===e.kind||"multipleOf"===e.kind&&j.isInteger(e.value))}get isFinite(){let e=null,t=null;for(let r of this._def.checks)if("finite"===r.kind||"int"===r.kind||"multipleOf"===r.kind)return!0;else"min"===r.kind?(null===t||r.value>t)&&(t=r.value):"max"===r.kind&&(null===e||r.value<e)&&(e=r.value);return Number.isFinite(t)&&Number.isFinite(e)}}as.create=e=>new as({checks:[],typeName:D.ZodNumber,coerce:e?.coerce||!1,...rB(e)});class an extends rK{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){let t;if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==rk.bigint)return this._getInvalidInput(e);let r=new rD;for(let a of this._def.checks)"min"===a.kind?(a.inclusive?e.data<a.value:e.data<=a.value)&&(r$(t=this._getOrReturnCtx(e,t),{code:rE.too_small,type:"bigint",minimum:a.value,inclusive:a.inclusive,message:a.message}),r.dirty()):"max"===a.kind?(a.inclusive?e.data>a.value:e.data>=a.value)&&(r$(t=this._getOrReturnCtx(e,t),{code:rE.too_big,type:"bigint",maximum:a.value,inclusive:a.inclusive,message:a.message}),r.dirty()):"multipleOf"===a.kind?e.data%a.value!==BigInt(0)&&(r$(t=this._getOrReturnCtx(e,t),{code:rE.not_multiple_of,multipleOf:a.value,message:a.message}),r.dirty()):j.assertNever(a);return{status:r.value,value:e.data}}_getInvalidInput(e){let t=this._getOrReturnCtx(e);return r$(t,{code:rE.invalid_type,expected:rk.bigint,received:t.parsedType}),rL}gte(e,t){return this.setLimit("min",e,!0,$.toString(t))}gt(e,t){return this.setLimit("min",e,!1,$.toString(t))}lte(e,t){return this.setLimit("max",e,!0,$.toString(t))}lt(e,t){return this.setLimit("max",e,!1,$.toString(t))}setLimit(e,t,r,a){return new an({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:$.toString(a)}]})}_addCheck(e){return new an({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:$.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:$.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:$.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:$.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:$.toString(t)})}get minValue(){let e=null;for(let t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(let t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}an.create=e=>new an({checks:[],typeName:D.ZodBigInt,coerce:e?.coerce??!1,...rB(e)});class ai extends rK{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==rk.boolean){let t=this._getOrReturnCtx(e);return r$(t,{code:rE.invalid_type,expected:rk.boolean,received:t.parsedType}),rL}return rz(e.data)}}ai.create=e=>new ai({typeName:D.ZodBoolean,coerce:e?.coerce||!1,...rB(e)});class ao extends rK{_parse(e){let t;if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==rk.date){let t=this._getOrReturnCtx(e);return r$(t,{code:rE.invalid_type,expected:rk.date,received:t.parsedType}),rL}if(Number.isNaN(e.data.getTime()))return r$(this._getOrReturnCtx(e),{code:rE.invalid_date}),rL;let r=new rD;for(let a of this._def.checks)"min"===a.kind?e.data.getTime()<a.value&&(r$(t=this._getOrReturnCtx(e,t),{code:rE.too_small,message:a.message,inclusive:!0,exact:!1,minimum:a.value,type:"date"}),r.dirty()):"max"===a.kind?e.data.getTime()>a.value&&(r$(t=this._getOrReturnCtx(e,t),{code:rE.too_big,message:a.message,inclusive:!0,exact:!1,maximum:a.value,type:"date"}),r.dirty()):j.assertNever(a);return{status:r.value,value:new Date(e.data.getTime())}}_addCheck(e){return new ao({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:$.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:$.toString(t)})}get minDate(){let e=null;for(let t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return null!=e?new Date(e):null}get maxDate(){let e=null;for(let t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return null!=e?new Date(e):null}}ao.create=e=>new ao({checks:[],coerce:e?.coerce||!1,typeName:D.ZodDate,...rB(e)});class al extends rK{_parse(e){if(this._getType(e)!==rk.symbol){let t=this._getOrReturnCtx(e);return r$(t,{code:rE.invalid_type,expected:rk.symbol,received:t.parsedType}),rL}return rz(e.data)}}al.create=e=>new al({typeName:D.ZodSymbol,...rB(e)});class au extends rK{_parse(e){if(this._getType(e)!==rk.undefined){let t=this._getOrReturnCtx(e);return r$(t,{code:rE.invalid_type,expected:rk.undefined,received:t.parsedType}),rL}return rz(e.data)}}au.create=e=>new au({typeName:D.ZodUndefined,...rB(e)});class ad extends rK{_parse(e){if(this._getType(e)!==rk.null){let t=this._getOrReturnCtx(e);return r$(t,{code:rE.invalid_type,expected:rk.null,received:t.parsedType}),rL}return rz(e.data)}}ad.create=e=>new ad({typeName:D.ZodNull,...rB(e)});class ap extends rK{constructor(){super(...arguments),this._any=!0}_parse(e){return rz(e.data)}}ap.create=e=>new ap({typeName:D.ZodAny,...rB(e)});class ac extends rK{constructor(){super(...arguments),this._unknown=!0}_parse(e){return rz(e.data)}}ac.create=e=>new ac({typeName:D.ZodUnknown,...rB(e)});class ah extends rK{_parse(e){let t=this._getOrReturnCtx(e);return r$(t,{code:rE.invalid_type,expected:rk.never,received:t.parsedType}),rL}}ah.create=e=>new ah({typeName:D.ZodNever,...rB(e)});class am extends rK{_parse(e){if(this._getType(e)!==rk.undefined){let t=this._getOrReturnCtx(e);return r$(t,{code:rE.invalid_type,expected:rk.void,received:t.parsedType}),rL}return rz(e.data)}}am.create=e=>new am({typeName:D.ZodVoid,...rB(e)});class ag extends rK{_parse(e){let{ctx:t,status:r}=this._processInputParams(e),a=this._def;if(t.parsedType!==rk.array)return r$(t,{code:rE.invalid_type,expected:rk.array,received:t.parsedType}),rL;if(null!==a.exactLength){let e=t.data.length>a.exactLength.value,s=t.data.length<a.exactLength.value;(e||s)&&(r$(t,{code:e?rE.too_big:rE.too_small,minimum:s?a.exactLength.value:void 0,maximum:e?a.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:a.exactLength.message}),r.dirty())}if(null!==a.minLength&&t.data.length<a.minLength.value&&(r$(t,{code:rE.too_small,minimum:a.minLength.value,type:"array",inclusive:!0,exact:!1,message:a.minLength.message}),r.dirty()),null!==a.maxLength&&t.data.length>a.maxLength.value&&(r$(t,{code:rE.too_big,maximum:a.maxLength.value,type:"array",inclusive:!0,exact:!1,message:a.maxLength.message}),r.dirty()),t.common.async)return Promise.all([...t.data].map((e,r)=>a.type._parseAsync(new rW(t,e,t.path,r)))).then(e=>rD.mergeArray(r,e));let s=[...t.data].map((e,r)=>a.type._parseSync(new rW(t,e,t.path,r)));return rD.mergeArray(r,s)}get element(){return this._def.type}min(e,t){return new ag({...this._def,minLength:{value:e,message:$.toString(t)}})}max(e,t){return new ag({...this._def,maxLength:{value:e,message:$.toString(t)}})}length(e,t){return new ag({...this._def,exactLength:{value:e,message:$.toString(t)}})}nonempty(e){return this.min(1,e)}}ag.create=(e,t)=>new ag({type:e,minLength:null,maxLength:null,exactLength:null,typeName:D.ZodArray,...rB(t)});class af extends rK{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(null!==this._cached)return this._cached;let e=this._def.shape(),t=j.objectKeys(e);return this._cached={shape:e,keys:t},this._cached}_parse(e){if(this._getType(e)!==rk.object){let t=this._getOrReturnCtx(e);return r$(t,{code:rE.invalid_type,expected:rk.object,received:t.parsedType}),rL}let{status:t,ctx:r}=this._processInputParams(e),{shape:a,keys:s}=this._getCached(),n=[];if(!(this._def.catchall instanceof ah&&"strip"===this._def.unknownKeys))for(let e in r.data)s.includes(e)||n.push(e);let i=[];for(let e of s){let t=a[e],s=r.data[e];i.push({key:{status:"valid",value:e},value:t._parse(new rW(r,s,r.path,e)),alwaysSet:e in r.data})}if(this._def.catchall instanceof ah){let e=this._def.unknownKeys;if("passthrough"===e)for(let e of n)i.push({key:{status:"valid",value:e},value:{status:"valid",value:r.data[e]}});else if("strict"===e)n.length>0&&(r$(r,{code:rE.unrecognized_keys,keys:n}),t.dirty());else if("strip"===e);else throw Error("Internal ZodObject error: invalid unknownKeys value.")}else{let e=this._def.catchall;for(let t of n){let a=r.data[t];i.push({key:{status:"valid",value:t},value:e._parse(new rW(r,a,r.path,t)),alwaysSet:t in r.data})}}return r.common.async?Promise.resolve().then(async()=>{let e=[];for(let t of i){let r=await t.key,a=await t.value;e.push({key:r,value:a,alwaysSet:t.alwaysSet})}return e}).then(e=>rD.mergeObjectSync(t,e)):rD.mergeObjectSync(t,i)}get shape(){return this._def.shape()}strict(e){return $.errToObj,new af({...this._def,unknownKeys:"strict",...void 0!==e?{errorMap:(t,r)=>{let a=this._def.errorMap?.(t,r).message??r.defaultError;return"unrecognized_keys"===t.code?{message:$.errToObj(e).message??a}:{message:a}}}:{}})}strip(){return new af({...this._def,unknownKeys:"strip"})}passthrough(){return new af({...this._def,unknownKeys:"passthrough"})}extend(e){return new af({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new af({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:D.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new af({...this._def,catchall:e})}pick(e){let t={};for(let r of j.objectKeys(e))e[r]&&this.shape[r]&&(t[r]=this.shape[r]);return new af({...this._def,shape:()=>t})}omit(e){let t={};for(let r of j.objectKeys(this.shape))e[r]||(t[r]=this.shape[r]);return new af({...this._def,shape:()=>t})}deepPartial(){return function e(t){if(t instanceof af){let r={};for(let a in t.shape){let s=t.shape[a];r[a]=aN.create(e(s))}return new af({...t._def,shape:()=>r})}if(t instanceof ag)return new ag({...t._def,type:e(t.element)});if(t instanceof aN)return aN.create(e(t.unwrap()));if(t instanceof aj)return aj.create(e(t.unwrap()));if(t instanceof a_)return a_.create(t.items.map(t=>e(t)));else return t}(this)}partial(e){let t={};for(let r of j.objectKeys(this.shape)){let a=this.shape[r];e&&!e[r]?t[r]=a:t[r]=a.optional()}return new af({...this._def,shape:()=>t})}required(e){let t={};for(let r of j.objectKeys(this.shape))if(e&&!e[r])t[r]=this.shape[r];else{let e=this.shape[r];for(;e instanceof aN;)e=e._def.innerType;t[r]=e}return new af({...this._def,shape:()=>t})}keyof(){return aA(j.objectKeys(this.shape))}}af.create=(e,t)=>new af({shape:()=>e,unknownKeys:"strip",catchall:ah.create(),typeName:D.ZodObject,...rB(t)}),af.strictCreate=(e,t)=>new af({shape:()=>e,unknownKeys:"strict",catchall:ah.create(),typeName:D.ZodObject,...rB(t)}),af.lazycreate=(e,t)=>new af({shape:e,unknownKeys:"strip",catchall:ah.create(),typeName:D.ZodObject,...rB(t)});class ay extends rK{_parse(e){let{ctx:t}=this._processInputParams(e),r=this._def.options;if(t.common.async)return Promise.all(r.map(async e=>{let r={...t,common:{...t.common,issues:[]},parent:null};return{result:await e._parseAsync({data:t.data,path:t.path,parent:r}),ctx:r}})).then(function(e){for(let t of e)if("valid"===t.result.status)return t.result;for(let r of e)if("dirty"===r.result.status)return t.common.issues.push(...r.ctx.common.issues),r.result;let r=e.map(e=>new rO(e.ctx.common.issues));return r$(t,{code:rE.invalid_union,unionErrors:r}),rL});{let e,a=[];for(let s of r){let r={...t,common:{...t.common,issues:[]},parent:null},n=s._parseSync({data:t.data,path:t.path,parent:r});if("valid"===n.status)return n;"dirty"!==n.status||e||(e={result:n,ctx:r}),r.common.issues.length&&a.push(r.common.issues)}if(e)return t.common.issues.push(...e.ctx.common.issues),e.result;let s=a.map(e=>new rO(e));return r$(t,{code:rE.invalid_union,unionErrors:s}),rL}}get options(){return this._def.options}}ay.create=(e,t)=>new ay({options:e,typeName:D.ZodUnion,...rB(t)});let av=e=>{if(e instanceof aT)return av(e.schema);if(e instanceof aM)return av(e.innerType());if(e instanceof aE)return[e.value];if(e instanceof aO)return e.options;if(e instanceof aC)return j.objectValues(e.enum);else if(e instanceof aP)return av(e._def.innerType);else if(e instanceof au)return[void 0];else if(e instanceof ad)return[null];else if(e instanceof aN)return[void 0,...av(e.unwrap())];else if(e instanceof aj)return[null,...av(e.unwrap())];else if(e instanceof aU)return av(e.unwrap());else if(e instanceof aq)return av(e.unwrap());else if(e instanceof a$)return av(e._def.innerType);else return[]};class ab extends rK{_parse(e){let{ctx:t}=this._processInputParams(e);if(t.parsedType!==rk.object)return r$(t,{code:rE.invalid_type,expected:rk.object,received:t.parsedType}),rL;let r=this.discriminator,a=t.data[r],s=this.optionsMap.get(a);return s?t.common.async?s._parseAsync({data:t.data,path:t.path,parent:t}):s._parseSync({data:t.data,path:t.path,parent:t}):(r$(t,{code:rE.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[r]}),rL)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,r){let a=new Map;for(let r of t){let t=av(r.shape[e]);if(!t.length)throw Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(let s of t){if(a.has(s))throw Error(`Discriminator property ${String(e)} has duplicate value ${String(s)}`);a.set(s,r)}}return new ab({typeName:D.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:a,...rB(r)})}}class aw extends rK{_parse(e){let{status:t,ctx:r}=this._processInputParams(e),a=(e,a)=>{if(rq(e)||rq(a))return rL;let s=function e(t,r){let a=rT(t),s=rT(r);if(t===r)return{valid:!0,data:t};if(a===rk.object&&s===rk.object){let a=j.objectKeys(r),s=j.objectKeys(t).filter(e=>-1!==a.indexOf(e)),n={...t,...r};for(let a of s){let s=e(t[a],r[a]);if(!s.valid)return{valid:!1};n[a]=s.data}return{valid:!0,data:n}}if(a===rk.array&&s===rk.array){if(t.length!==r.length)return{valid:!1};let a=[];for(let s=0;s<t.length;s++){let n=e(t[s],r[s]);if(!n.valid)return{valid:!1};a.push(n.data)}return{valid:!0,data:a}}if(a===rk.date&&s===rk.date&&+t==+r)return{valid:!0,data:t};return{valid:!1}}(e.value,a.value);return s.valid?((rV(e)||rV(a))&&t.dirty(),{status:t.value,value:s.data}):(r$(r,{code:rE.invalid_intersection_types}),rL)};return r.common.async?Promise.all([this._def.left._parseAsync({data:r.data,path:r.path,parent:r}),this._def.right._parseAsync({data:r.data,path:r.path,parent:r})]).then(([e,t])=>a(e,t)):a(this._def.left._parseSync({data:r.data,path:r.path,parent:r}),this._def.right._parseSync({data:r.data,path:r.path,parent:r}))}}aw.create=(e,t,r)=>new aw({left:e,right:t,typeName:D.ZodIntersection,...rB(r)});class a_ extends rK{_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==rk.array)return r$(r,{code:rE.invalid_type,expected:rk.array,received:r.parsedType}),rL;if(r.data.length<this._def.items.length)return r$(r,{code:rE.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),rL;!this._def.rest&&r.data.length>this._def.items.length&&(r$(r,{code:rE.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());let a=[...r.data].map((e,t)=>{let a=this._def.items[t]||this._def.rest;return a?a._parse(new rW(r,e,r.path,t)):null}).filter(e=>!!e);return r.common.async?Promise.all(a).then(e=>rD.mergeArray(t,e)):rD.mergeArray(t,a)}get items(){return this._def.items}rest(e){return new a_({...this._def,rest:e})}}a_.create=(e,t)=>{if(!Array.isArray(e))throw Error("You must pass an array of schemas to z.tuple([ ... ])");return new a_({items:e,typeName:D.ZodTuple,rest:null,...rB(t)})};class aS extends rK{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==rk.object)return r$(r,{code:rE.invalid_type,expected:rk.object,received:r.parsedType}),rL;let a=[],s=this._def.keyType,n=this._def.valueType;for(let e in r.data)a.push({key:s._parse(new rW(r,e,r.path,e)),value:n._parse(new rW(r,r.data[e],r.path,e)),alwaysSet:e in r.data});return r.common.async?rD.mergeObjectAsync(t,a):rD.mergeObjectSync(t,a)}get element(){return this._def.valueType}static create(e,t,r){return new aS(t instanceof rK?{keyType:e,valueType:t,typeName:D.ZodRecord,...rB(r)}:{keyType:aa.create(),valueType:e,typeName:D.ZodRecord,...rB(t)})}}class ax extends rK{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==rk.map)return r$(r,{code:rE.invalid_type,expected:rk.map,received:r.parsedType}),rL;let a=this._def.keyType,s=this._def.valueType,n=[...r.data.entries()].map(([e,t],n)=>({key:a._parse(new rW(r,e,r.path,[n,"key"])),value:s._parse(new rW(r,t,r.path,[n,"value"]))}));if(r.common.async){let e=new Map;return Promise.resolve().then(async()=>{for(let r of n){let a=await r.key,s=await r.value;if("aborted"===a.status||"aborted"===s.status)return rL;("dirty"===a.status||"dirty"===s.status)&&t.dirty(),e.set(a.value,s.value)}return{status:t.value,value:e}})}{let e=new Map;for(let r of n){let a=r.key,s=r.value;if("aborted"===a.status||"aborted"===s.status)return rL;("dirty"===a.status||"dirty"===s.status)&&t.dirty(),e.set(a.value,s.value)}return{status:t.value,value:e}}}}ax.create=(e,t,r)=>new ax({valueType:t,keyType:e,typeName:D.ZodMap,...rB(r)});class aI extends rK{_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==rk.set)return r$(r,{code:rE.invalid_type,expected:rk.set,received:r.parsedType}),rL;let a=this._def;null!==a.minSize&&r.data.size<a.minSize.value&&(r$(r,{code:rE.too_small,minimum:a.minSize.value,type:"set",inclusive:!0,exact:!1,message:a.minSize.message}),t.dirty()),null!==a.maxSize&&r.data.size>a.maxSize.value&&(r$(r,{code:rE.too_big,maximum:a.maxSize.value,type:"set",inclusive:!0,exact:!1,message:a.maxSize.message}),t.dirty());let s=this._def.valueType;function n(e){let r=new Set;for(let a of e){if("aborted"===a.status)return rL;"dirty"===a.status&&t.dirty(),r.add(a.value)}return{status:t.value,value:r}}let i=[...r.data.values()].map((e,t)=>s._parse(new rW(r,e,r.path,t)));return r.common.async?Promise.all(i).then(e=>n(e)):n(i)}min(e,t){return new aI({...this._def,minSize:{value:e,message:$.toString(t)}})}max(e,t){return new aI({...this._def,maxSize:{value:e,message:$.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}aI.create=(e,t)=>new aI({valueType:e,minSize:null,maxSize:null,typeName:D.ZodSet,...rB(t)});class ak extends rK{constructor(){super(...arguments),this.validate=this.implement}_parse(e){let{ctx:t}=this._processInputParams(e);if(t.parsedType!==rk.function)return r$(t,{code:rE.invalid_type,expected:rk.function,received:t.parsedType}),rL;function r(e,r){return rj({data:e,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,rR,rC].filter(e=>!!e),issueData:{code:rE.invalid_arguments,argumentsError:r}})}function a(e,r){return rj({data:e,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,rR,rC].filter(e=>!!e),issueData:{code:rE.invalid_return_type,returnTypeError:r}})}let s={errorMap:t.common.contextualErrorMap},n=t.data;if(this._def.returns instanceof aR){let e=this;return rz(async function(...t){let i=new rO([]),o=await e._def.args.parseAsync(t,s).catch(e=>{throw i.addIssue(r(t,e)),i}),l=await Reflect.apply(n,this,o);return await e._def.returns._def.type.parseAsync(l,s).catch(e=>{throw i.addIssue(a(l,e)),i})})}{let e=this;return rz(function(...t){let i=e._def.args.safeParse(t,s);if(!i.success)throw new rO([r(t,i.error)]);let o=Reflect.apply(n,this,i.data),l=e._def.returns.safeParse(o,s);if(!l.success)throw new rO([a(o,l.error)]);return l.data})}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new ak({...this._def,args:a_.create(e).rest(ac.create())})}returns(e){return new ak({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,t,r){return new ak({args:e||a_.create([]).rest(ac.create()),returns:t||ac.create(),typeName:D.ZodFunction,...rB(r)})}}class aT extends rK{get schema(){return this._def.getter()}_parse(e){let{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}aT.create=(e,t)=>new aT({getter:e,typeName:D.ZodLazy,...rB(t)});class aE extends rK{_parse(e){if(e.data!==this._def.value){let t=this._getOrReturnCtx(e);return r$(t,{received:t.data,code:rE.invalid_literal,expected:this._def.value}),rL}return{status:"valid",value:e.data}}get value(){return this._def.value}}function aA(e,t){return new aO({values:e,typeName:D.ZodEnum,...rB(t)})}aE.create=(e,t)=>new aE({value:e,typeName:D.ZodLiteral,...rB(t)});class aO extends rK{_parse(e){if("string"!=typeof e.data){let t=this._getOrReturnCtx(e),r=this._def.values;return r$(t,{expected:j.joinValues(r),received:t.parsedType,code:rE.invalid_type}),rL}if(this._cache||(this._cache=new Set(this._def.values)),!this._cache.has(e.data)){let t=this._getOrReturnCtx(e),r=this._def.values;return r$(t,{received:t.data,code:rE.invalid_enum_value,options:r}),rL}return rz(e.data)}get options(){return this._def.values}get enum(){let e={};for(let t of this._def.values)e[t]=t;return e}get Values(){let e={};for(let t of this._def.values)e[t]=t;return e}get Enum(){let e={};for(let t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return aO.create(e,{...this._def,...t})}exclude(e,t=this._def){return aO.create(this.options.filter(t=>!e.includes(t)),{...this._def,...t})}}aO.create=aA;class aC extends rK{_parse(e){let t=j.getValidEnumValues(this._def.values),r=this._getOrReturnCtx(e);if(r.parsedType!==rk.string&&r.parsedType!==rk.number){let e=j.objectValues(t);return r$(r,{expected:j.joinValues(e),received:r.parsedType,code:rE.invalid_type}),rL}if(this._cache||(this._cache=new Set(j.getValidEnumValues(this._def.values))),!this._cache.has(e.data)){let e=j.objectValues(t);return r$(r,{received:r.data,code:rE.invalid_enum_value,options:e}),rL}return rz(e.data)}get enum(){return this._def.values}}aC.create=(e,t)=>new aC({values:e,typeName:D.ZodNativeEnum,...rB(t)});class aR extends rK{unwrap(){return this._def.type}_parse(e){let{ctx:t}=this._processInputParams(e);return t.parsedType!==rk.promise&&!1===t.common.async?(r$(t,{code:rE.invalid_type,expected:rk.promise,received:t.parsedType}),rL):rz((t.parsedType===rk.promise?t.data:Promise.resolve(t.data)).then(e=>this._def.type.parseAsync(e,{path:t.path,errorMap:t.common.contextualErrorMap})))}}aR.create=(e,t)=>new aR({type:e,typeName:D.ZodPromise,...rB(t)});class aM extends rK{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===D.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){let{status:t,ctx:r}=this._processInputParams(e),a=this._def.effect||null,s={addIssue:e=>{r$(r,e),e.fatal?t.abort():t.dirty()},get path(){return r.path}};if(s.addIssue=s.addIssue.bind(s),"preprocess"===a.type){let e=a.transform(r.data,s);if(r.common.async)return Promise.resolve(e).then(async e=>{if("aborted"===t.value)return rL;let a=await this._def.schema._parseAsync({data:e,path:r.path,parent:r});return"aborted"===a.status?rL:"dirty"===a.status||"dirty"===t.value?rU(a.value):a});{if("aborted"===t.value)return rL;let a=this._def.schema._parseSync({data:e,path:r.path,parent:r});return"aborted"===a.status?rL:"dirty"===a.status||"dirty"===t.value?rU(a.value):a}}if("refinement"===a.type){let e=e=>{let t=a.refinement(e,s);if(r.common.async)return Promise.resolve(t);if(t instanceof Promise)throw Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return e};if(!1!==r.common.async)return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(r=>"aborted"===r.status?rL:("dirty"===r.status&&t.dirty(),e(r.value).then(()=>({status:t.value,value:r.value}))));{let a=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});return"aborted"===a.status?rL:("dirty"===a.status&&t.dirty(),e(a.value),{status:t.value,value:a.value})}}if("transform"===a.type)if(!1!==r.common.async)return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(e=>rF(e)?Promise.resolve(a.transform(e.value,s)).then(e=>({status:t.value,value:e})):rL);else{let e=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});if(!rF(e))return rL;let n=a.transform(e.value,s);if(n instanceof Promise)throw Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:n}}j.assertNever(a)}}aM.create=(e,t,r)=>new aM({schema:e,typeName:D.ZodEffects,effect:t,...rB(r)}),aM.createWithPreprocess=(e,t,r)=>new aM({schema:t,effect:{type:"preprocess",transform:e},typeName:D.ZodEffects,...rB(r)});class aN extends rK{_parse(e){return this._getType(e)===rk.undefined?rz(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}aN.create=(e,t)=>new aN({innerType:e,typeName:D.ZodOptional,...rB(t)});class aj extends rK{_parse(e){return this._getType(e)===rk.null?rz(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}aj.create=(e,t)=>new aj({innerType:e,typeName:D.ZodNullable,...rB(t)});class aP extends rK{_parse(e){let{ctx:t}=this._processInputParams(e),r=t.data;return t.parsedType===rk.undefined&&(r=this._def.defaultValue()),this._def.innerType._parse({data:r,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}aP.create=(e,t)=>new aP({innerType:e,typeName:D.ZodDefault,defaultValue:"function"==typeof t.default?t.default:()=>t.default,...rB(t)});class a$ extends rK{_parse(e){let{ctx:t}=this._processInputParams(e),r={...t,common:{...t.common,issues:[]}},a=this._def.innerType._parse({data:r.data,path:r.path,parent:{...r}});return rZ(a)?a.then(e=>({status:"valid",value:"valid"===e.status?e.value:this._def.catchValue({get error(){return new rO(r.common.issues)},input:r.data})})):{status:"valid",value:"valid"===a.status?a.value:this._def.catchValue({get error(){return new rO(r.common.issues)},input:r.data})}}removeCatch(){return this._def.innerType}}a$.create=(e,t)=>new a$({innerType:e,typeName:D.ZodCatch,catchValue:"function"==typeof t.catch?t.catch:()=>t.catch,...rB(t)});class aD extends rK{_parse(e){if(this._getType(e)!==rk.nan){let t=this._getOrReturnCtx(e);return r$(t,{code:rE.invalid_type,expected:rk.nan,received:t.parsedType}),rL}return{status:"valid",value:e.data}}}aD.create=e=>new aD({typeName:D.ZodNaN,...rB(e)});let aL=Symbol("zod_brand");class aU extends rK{_parse(e){let{ctx:t}=this._processInputParams(e),r=t.data;return this._def.type._parse({data:r,path:t.path,parent:t})}unwrap(){return this._def.type}}class az extends rK{_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.common.async)return(async()=>{let e=await this._def.in._parseAsync({data:r.data,path:r.path,parent:r});return"aborted"===e.status?rL:"dirty"===e.status?(t.dirty(),rU(e.value)):this._def.out._parseAsync({data:e.value,path:r.path,parent:r})})();{let e=this._def.in._parseSync({data:r.data,path:r.path,parent:r});return"aborted"===e.status?rL:"dirty"===e.status?(t.dirty(),{status:"dirty",value:e.value}):this._def.out._parseSync({data:e.value,path:r.path,parent:r})}}static create(e,t){return new az({in:e,out:t,typeName:D.ZodPipeline})}}class aq extends rK{_parse(e){let t=this._def.innerType._parse(e),r=e=>(rF(e)&&(e.value=Object.freeze(e.value)),e);return rZ(t)?t.then(e=>r(e)):r(t)}unwrap(){return this._def.innerType}}function aV(e,t){let r="function"==typeof e?e(t):"string"==typeof e?{message:e}:e;return"string"==typeof r?{message:r}:r}function aF(e,t={},r){return e?ap.create().superRefine((a,s)=>{let n=e(a);if(n instanceof Promise)return n.then(e=>{if(!e){let e=aV(t,a),n=e.fatal??r??!0;s.addIssue({code:"custom",...e,fatal:n})}});if(!n){let e=aV(t,a),n=e.fatal??r??!0;s.addIssue({code:"custom",...e,fatal:n})}}):ap.create()}aq.create=(e,t)=>new aq({innerType:e,typeName:D.ZodReadonly,...rB(t)});let aZ={object:af.lazycreate};(c=D||(D={})).ZodString="ZodString",c.ZodNumber="ZodNumber",c.ZodNaN="ZodNaN",c.ZodBigInt="ZodBigInt",c.ZodBoolean="ZodBoolean",c.ZodDate="ZodDate",c.ZodSymbol="ZodSymbol",c.ZodUndefined="ZodUndefined",c.ZodNull="ZodNull",c.ZodAny="ZodAny",c.ZodUnknown="ZodUnknown",c.ZodNever="ZodNever",c.ZodVoid="ZodVoid",c.ZodArray="ZodArray",c.ZodObject="ZodObject",c.ZodUnion="ZodUnion",c.ZodDiscriminatedUnion="ZodDiscriminatedUnion",c.ZodIntersection="ZodIntersection",c.ZodTuple="ZodTuple",c.ZodRecord="ZodRecord",c.ZodMap="ZodMap",c.ZodSet="ZodSet",c.ZodFunction="ZodFunction",c.ZodLazy="ZodLazy",c.ZodLiteral="ZodLiteral",c.ZodEnum="ZodEnum",c.ZodEffects="ZodEffects",c.ZodNativeEnum="ZodNativeEnum",c.ZodOptional="ZodOptional",c.ZodNullable="ZodNullable",c.ZodDefault="ZodDefault",c.ZodCatch="ZodCatch",c.ZodPromise="ZodPromise",c.ZodBranded="ZodBranded",c.ZodPipeline="ZodPipeline",c.ZodReadonly="ZodReadonly";let aW=(e,t={message:`Input not instance of ${e.name}`})=>aF(t=>t instanceof e,t),aG=aa.create,aB=as.create,aK=aD.create,aJ=an.create,aH=ai.create,aY=ao.create,aQ=al.create,aX=au.create,a0=ad.create,a1=ap.create,a2=ac.create,a4=ah.create,a5=am.create,a3=ag.create,a9=af.create,a6=af.strictCreate,a8=ay.create,a7=ab.create,se=aw.create,st=a_.create,sr=aS.create,sa=ax.create,ss=aI.create,sn=ak.create,si=aT.create,so=aE.create,sl=aO.create,su=aC.create,sd=aR.create,sp=aM.create,sc=aN.create,sh=aj.create,sm=aM.createWithPreprocess,sg=az.create,sf=()=>aG().optional(),sy=()=>aB().optional(),sv=()=>aH().optional(),sb={string:e=>aa.create({...e,coerce:!0}),number:e=>as.create({...e,coerce:!0}),boolean:e=>ai.create({...e,coerce:!0}),bigint:e=>an.create({...e,coerce:!0}),date:e=>ao.create({...e,coerce:!0})};function sw(e){if("openAi"!==e.target)return{};let t=[...e.basePath,e.definitionPath,e.openAiAnyTypeName];return e.flags.hasReferencedOpenAiAnyType=!0,{$ref:"relative"===e.$refStrategy?rI(t,e.currentPath):t.join("/")}}function s_(e,t){return sV(e.type._def,t)}e.s(["BRAND",0,aL,"NEVER",0,rL,"Schema",()=>rK,"ZodAny",()=>ap,"ZodArray",()=>ag,"ZodBigInt",()=>an,"ZodBoolean",()=>ai,"ZodBranded",()=>aU,"ZodCatch",()=>a$,"ZodDate",()=>ao,"ZodDefault",()=>aP,"ZodDiscriminatedUnion",()=>ab,"ZodEffects",()=>aM,"ZodEnum",()=>aO,"ZodFirstPartyTypeKind",()=>D,"ZodFunction",()=>ak,"ZodIntersection",()=>aw,"ZodLazy",()=>aT,"ZodLiteral",()=>aE,"ZodMap",()=>ax,"ZodNaN",()=>aD,"ZodNativeEnum",()=>aC,"ZodNever",()=>ah,"ZodNull",()=>ad,"ZodNullable",()=>aj,"ZodNumber",()=>as,"ZodObject",()=>af,"ZodOptional",()=>aN,"ZodPipeline",()=>az,"ZodPromise",()=>aR,"ZodReadonly",()=>aq,"ZodRecord",()=>aS,"ZodSchema",()=>rK,"ZodSet",()=>aI,"ZodString",()=>aa,"ZodSymbol",()=>al,"ZodTransformer",()=>aM,"ZodTuple",()=>a_,"ZodType",()=>rK,"ZodUndefined",()=>au,"ZodUnion",()=>ay,"ZodUnknown",()=>ac,"ZodVoid",()=>am,"any",()=>a1,"array",()=>a3,"bigint",()=>aJ,"boolean",()=>aH,"coerce",0,sb,"custom",()=>aF,"date",()=>aY,"datetimeRegex",()=>ar,"discriminatedUnion",()=>a7,"effect",()=>sp,"enum",()=>sl,"function",()=>sn,"instanceof",()=>aW,"intersection",()=>se,"late",0,aZ,"lazy",()=>si,"literal",()=>so,"map",()=>sa,"nan",()=>aK,"nativeEnum",()=>su,"never",()=>a4,"null",()=>a0,"nullable",()=>sh,"number",()=>aB,"object",()=>a9,"oboolean",()=>sv,"onumber",()=>sy,"optional",()=>sc,"ostring",()=>sf,"pipeline",()=>sg,"preprocess",()=>sm,"promise",()=>sd,"record",()=>sr,"set",()=>ss,"strictObject",()=>a6,"string",()=>aG,"symbol",()=>aQ,"transformer",()=>sp,"tuple",()=>st,"undefined",()=>aX,"union",()=>a8,"unknown",()=>a2,"void",()=>a5],117958),e.s([],254033),e.i(254033),e.i(585676),e.s(["defaultErrorMap",0,rC,"getErrorMap",()=>rN,"setErrorMap",()=>rM],676733),e.i(676733),e.i(984488),e.i(91316),e.i(742944),e.i(117958),e.i(115235),e.s(["BRAND",0,aL,"DIRTY",0,rU,"EMPTY_PATH",0,rP,"INVALID",0,rL,"NEVER",0,rL,"OK",0,rz,"ParseStatus",()=>rD,"Schema",()=>rK,"ZodAny",()=>ap,"ZodArray",()=>ag,"ZodBigInt",()=>an,"ZodBoolean",()=>ai,"ZodBranded",()=>aU,"ZodCatch",()=>a$,"ZodDate",()=>ao,"ZodDefault",()=>aP,"ZodDiscriminatedUnion",()=>ab,"ZodEffects",()=>aM,"ZodEnum",()=>aO,"ZodError",()=>rO,"ZodFirstPartyTypeKind",()=>D,"ZodFunction",()=>ak,"ZodIntersection",()=>aw,"ZodIssueCode",0,rE,"ZodLazy",()=>aT,"ZodLiteral",()=>aE,"ZodMap",()=>ax,"ZodNaN",()=>aD,"ZodNativeEnum",()=>aC,"ZodNever",()=>ah,"ZodNull",()=>ad,"ZodNullable",()=>aj,"ZodNumber",()=>as,"ZodObject",()=>af,"ZodOptional",()=>aN,"ZodParsedType",0,rk,"ZodPipeline",()=>az,"ZodPromise",()=>aR,"ZodReadonly",()=>aq,"ZodRecord",()=>aS,"ZodSchema",()=>rK,"ZodSet",()=>aI,"ZodString",()=>aa,"ZodSymbol",()=>al,"ZodTransformer",()=>aM,"ZodTuple",()=>a_,"ZodType",()=>rK,"ZodUndefined",()=>au,"ZodUnion",()=>ay,"ZodUnknown",()=>ac,"ZodVoid",()=>am,"addIssueToContext",()=>r$,"any",()=>a1,"array",()=>a3,"bigint",()=>aJ,"boolean",()=>aH,"coerce",0,sb,"custom",()=>aF,"date",()=>aY,"datetimeRegex",()=>ar,"defaultErrorMap",0,rC,"discriminatedUnion",()=>a7,"effect",()=>sp,"enum",()=>sl,"function",()=>sn,"getErrorMap",()=>rN,"getParsedType",0,rT,"instanceof",()=>aW,"intersection",()=>se,"isAborted",0,rq,"isAsync",0,rZ,"isDirty",0,rV,"isValid",0,rF,"late",0,aZ,"lazy",()=>si,"literal",()=>so,"makeIssue",0,rj,"map",()=>sa,"nan",()=>aK,"nativeEnum",()=>su,"never",()=>a4,"null",()=>a0,"nullable",()=>sh,"number",()=>aB,"object",()=>a9,"objectUtil",()=>P,"oboolean",()=>sv,"onumber",()=>sy,"optional",()=>sc,"ostring",()=>sf,"pipeline",()=>sg,"preprocess",()=>sm,"promise",()=>sd,"quotelessJson",0,rA,"record",()=>sr,"set",()=>ss,"setErrorMap",()=>rM,"strictObject",()=>a6,"string",()=>aG,"symbol",()=>aQ,"transformer",()=>sp,"tuple",()=>st,"undefined",()=>aX,"union",()=>a8,"unknown",()=>a2,"util",()=>j,"void",()=>a5],735907),e.i(735907);let sS=/^[cC][^\s-]{8,}$/,sx=/^[0-9a-z]+$/,sI=/^[0-9A-HJKMNP-TV-Z]{26}$/,sk=/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,sT=()=>(void 0===a&&(a=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),a),sE=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,sA=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,sO=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,sC=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,sR=/^[a-zA-Z0-9_-]{21}$/,sM=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/;function sN(e,t){let r={type:"string"};if(e.checks)for(let a of e.checks)switch(a.kind){case"min":rx(r,"minLength","number"==typeof r.minLength?Math.max(r.minLength,a.value):a.value,a.message,t);break;case"max":rx(r,"maxLength","number"==typeof r.maxLength?Math.min(r.maxLength,a.value):a.value,a.message,t);break;case"email":switch(t.emailStrategy){case"format:email":s$(r,"email",a.message,t);break;case"format:idn-email":s$(r,"idn-email",a.message,t);break;case"pattern:zod":sD(r,sk,a.message,t)}break;case"url":s$(r,"uri",a.message,t);break;case"uuid":s$(r,"uuid",a.message,t);break;case"regex":sD(r,a.regex,a.message,t);break;case"cuid":sD(r,sS,a.message,t);break;case"cuid2":sD(r,sx,a.message,t);break;case"startsWith":sD(r,RegExp(`^${sj(a.value,t)}`),a.message,t);break;case"endsWith":sD(r,RegExp(`${sj(a.value,t)}$`),a.message,t);break;case"datetime":s$(r,"date-time",a.message,t);break;case"date":s$(r,"date",a.message,t);break;case"time":s$(r,"time",a.message,t);break;case"duration":s$(r,"duration",a.message,t);break;case"length":rx(r,"minLength","number"==typeof r.minLength?Math.max(r.minLength,a.value):a.value,a.message,t),rx(r,"maxLength","number"==typeof r.maxLength?Math.min(r.maxLength,a.value):a.value,a.message,t);break;case"includes":sD(r,RegExp(sj(a.value,t)),a.message,t);break;case"ip":"v6"!==a.version&&s$(r,"ipv4",a.message,t),"v4"!==a.version&&s$(r,"ipv6",a.message,t);break;case"base64url":sD(r,sC,a.message,t);break;case"jwt":sD(r,sM,a.message,t);break;case"cidr":"v6"!==a.version&&sD(r,sE,a.message,t),"v4"!==a.version&&sD(r,sA,a.message,t);break;case"emoji":sD(r,sT(),a.message,t);break;case"ulid":sD(r,sI,a.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":s$(r,"binary",a.message,t);break;case"contentEncoding:base64":rx(r,"contentEncoding","base64",a.message,t);break;case"pattern:zod":sD(r,sO,a.message,t)}break;case"nanoid":sD(r,sR,a.message,t)}return r}function sj(e,t){return"escape"===t.patternStrategy?function(e){let t="";for(let r=0;r<e.length;r++)sP.has(e[r])||(t+="\\"),t+=e[r];return t}(e):e}let sP=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function s$(e,t,r,a){e.format||e.anyOf?.some(e=>e.format)?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&a.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.anyOf.push({format:t,...r&&a.errorMessages&&{errorMessage:{format:r}}})):rx(e,"format",t,r,a)}function sD(e,t,r,a){e.pattern||e.allOf?.some(e=>e.pattern)?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&a.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.allOf.push({pattern:sL(t,a),...r&&a.errorMessages&&{errorMessage:{pattern:r}}})):rx(e,"pattern",sL(t,a),r,a)}function sL(e,t){if(!t.applyRegexFlags||!e.flags)return e.source;let r={i:e.flags.includes("i"),m:e.flags.includes("m"),s:e.flags.includes("s")},a=r.i?e.source.toLowerCase():e.source,s="",n=!1,i=!1,o=!1;for(let e=0;e<a.length;e++){if(n){s+=a[e],n=!1;continue}if(r.i){if(i){if(a[e].match(/[a-z]/)){o?(s+=a[e],s+=`${a[e-2]}-${a[e]}`.toUpperCase(),o=!1):"-"===a[e+1]&&a[e+2]?.match(/[a-z]/)?(s+=a[e],o=!0):s+=`${a[e]}${a[e].toUpperCase()}`;continue}}else if(a[e].match(/[a-z]/)){s+=`[${a[e]}${a[e].toUpperCase()}]`;continue}}if(r.m){if("^"===a[e]){s+=`(^|(?<=[\r
]))`;continue}else if("$"===a[e]){s+=`($|(?=[\r
]))`;continue}}if(r.s&&"."===a[e]){s+=i?`${a[e]}\r
`:`[${a[e]}\r
]`;continue}s+=a[e],"\\"===a[e]?n=!0:i&&"]"===a[e]?i=!1:i||"["!==a[e]||(i=!0)}try{new RegExp(s)}catch{return console.warn(`Could not convert regex pattern at ${t.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),e.source}return s}function sU(e,t){if("openAi"===t.target&&console.warn("Warning: OpenAI may not support records in schemas! Try an array of key-value pairs instead."),"openApi3"===t.target&&e.keyType?._def.typeName===D.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce((r,a)=>({...r,[a]:sV(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",a]})??sw(t)}),{}),additionalProperties:t.rejectedAdditionalProperties};let r={type:"object",additionalProperties:sV(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??t.allowedAdditionalProperties};if("openApi3"===t.target)return r;if(e.keyType?._def.typeName===D.ZodString&&e.keyType._def.checks?.length){let{type:a,...s}=sN(e.keyType._def,t);return{...r,propertyNames:s}}if(e.keyType?._def.typeName===D.ZodEnum)return{...r,propertyNames:{enum:e.keyType._def.values}};if(e.keyType?._def.typeName===D.ZodBranded&&e.keyType._def.type._def.typeName===D.ZodString&&e.keyType._def.type._def.checks?.length){let{type:a,...s}=s_(e.keyType._def,t);return{...r,propertyNames:s}}return r}let sz={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"},sq=(e,t)=>{let r=(e.options instanceof Map?Array.from(e.options.values()):e.options).map((e,r)=>sV(e._def,{...t,currentPath:[...t.currentPath,"anyOf",`${r}`]})).filter(e=>!!e&&(!t.strictUnions||"object"==typeof e&&Object.keys(e).length>0));return r.length?{anyOf:r}:void 0};function sV(e,t,r=!1){let a=t.seen.get(e);if(t.override){let s=t.override?.(e,t,a,r);if(s!==rw)return s}if(a&&!r){let e=sF(a,t);if(void 0!==e)return e}let s={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,s);let n=((e,t,r)=>{switch(t){case D.ZodString:return sN(e,r);case D.ZodNumber:let a={type:"number"};if(!e.checks)return a;for(let t of e.checks)switch(t.kind){case"int":a.type="integer",rS(a,"type",t.message,r);break;case"min":"jsonSchema7"===r.target?t.inclusive?rx(a,"minimum",t.value,t.message,r):rx(a,"exclusiveMinimum",t.value,t.message,r):(t.inclusive||(a.exclusiveMinimum=!0),rx(a,"minimum",t.value,t.message,r));break;case"max":"jsonSchema7"===r.target?t.inclusive?rx(a,"maximum",t.value,t.message,r):rx(a,"exclusiveMaximum",t.value,t.message,r):(t.inclusive||(a.exclusiveMaximum=!0),rx(a,"maximum",t.value,t.message,r));break;case"multipleOf":rx(a,"multipleOf",t.value,t.message,r)}return a;case D.ZodObject:return function(e,t){let r="openAi"===t.target,a={type:"object",properties:{}},s=[],n=e.shape();for(let e in n){let i=n[e];if(void 0===i||void 0===i._def)continue;let o=function(e){try{return e.isOptional()}catch{return!0}}(i);o&&r&&("ZodOptional"===i._def.typeName&&(i=i._def.innerType),i.isNullable()||(i=i.nullable()),o=!1);let l=sV(i._def,{...t,currentPath:[...t.currentPath,"properties",e],propertyPath:[...t.currentPath,"properties",e]});void 0!==l&&(a.properties[e]=l,o||s.push(e))}s.length&&(a.required=s);let i=function(e,t){if("ZodNever"!==e.catchall._def.typeName)return sV(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]});switch(e.unknownKeys){case"passthrough":return t.allowedAdditionalProperties;case"strict":return t.rejectedAdditionalProperties;case"strip":return"strict"===t.removeAdditionalStrategy?t.allowedAdditionalProperties:t.rejectedAdditionalProperties}}(e,t);return void 0!==i&&(a.additionalProperties=i),a}(e,r);case D.ZodBigInt:let s={type:"integer",format:"int64"};if(!e.checks)return s;for(let t of e.checks)switch(t.kind){case"min":"jsonSchema7"===r.target?t.inclusive?rx(s,"minimum",t.value,t.message,r):rx(s,"exclusiveMinimum",t.value,t.message,r):(t.inclusive||(s.exclusiveMinimum=!0),rx(s,"minimum",t.value,t.message,r));break;case"max":"jsonSchema7"===r.target?t.inclusive?rx(s,"maximum",t.value,t.message,r):rx(s,"exclusiveMaximum",t.value,t.message,r):(t.inclusive||(s.exclusiveMaximum=!0),rx(s,"maximum",t.value,t.message,r));break;case"multipleOf":rx(s,"multipleOf",t.value,t.message,r)}return s;case D.ZodBoolean:return{type:"boolean"};case D.ZodDate:return function e(t,r,a){let s=a??r.dateStrategy;if(Array.isArray(s))return{anyOf:s.map((a,s)=>e(t,r,a))};switch(s){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":var n=t,i=r;let o={type:"integer",format:"unix-time"};if("openApi3"===i.target)return o;for(let e of n.checks)switch(e.kind){case"min":rx(o,"minimum",e.value,e.message,i);break;case"max":rx(o,"maximum",e.value,e.message,i)}return o}}(e,r);case D.ZodUndefined:return{not:sw(r)};case D.ZodNull:return"openApi3"===r.target?{enum:["null"],nullable:!0}:{type:"null"};case D.ZodArray:let n;return n={type:"array"},e.type?._def&&e.type?._def?.typeName!==D.ZodAny&&(n.items=sV(e.type._def,{...r,currentPath:[...r.currentPath,"items"]})),e.minLength&&rx(n,"minItems",e.minLength.value,e.minLength.message,r),e.maxLength&&rx(n,"maxItems",e.maxLength.value,e.maxLength.message,r),e.exactLength&&(rx(n,"minItems",e.exactLength.value,e.exactLength.message,r),rx(n,"maxItems",e.exactLength.value,e.exactLength.message,r)),n;case D.ZodUnion:case D.ZodDiscriminatedUnion:if("openApi3"===r.target)return sq(e,r);let i=e.options instanceof Map?Array.from(e.options.values()):e.options;if(i.every(e=>e._def.typeName in sz&&(!e._def.checks||!e._def.checks.length))){let e=i.reduce((e,t)=>{let r=sz[t._def.typeName];return r&&!e.includes(r)?[...e,r]:e},[]);return{type:e.length>1?e:e[0]}}if(i.every(e=>"ZodLiteral"===e._def.typeName&&!e.description)){let e=i.reduce((e,t)=>{let r=typeof t._def.value;switch(r){case"string":case"number":case"boolean":return[...e,r];case"bigint":return[...e,"integer"];case"object":if(null===t._def.value)return[...e,"null"];default:return e}},[]);if(e.length===i.length){let t=e.filter((e,t,r)=>r.indexOf(e)===t);return{type:t.length>1?t:t[0],enum:i.reduce((e,t)=>e.includes(t._def.value)?e:[...e,t._def.value],[])}}}else if(i.every(e=>"ZodEnum"===e._def.typeName))return{type:"string",enum:i.reduce((e,t)=>[...e,...t._def.values.filter(t=>!e.includes(t))],[])};return sq(e,r);case D.ZodIntersection:let o,l,u;return o=[sV(e.left._def,{...r,currentPath:[...r.currentPath,"allOf","0"]}),sV(e.right._def,{...r,currentPath:[...r.currentPath,"allOf","1"]})].filter(e=>!!e),l="jsonSchema2019-09"===r.target?{unevaluatedProperties:!1}:void 0,u=[],o.forEach(e=>{if((!("type"in e)||"string"!==e.type)&&"allOf"in e)u.push(...e.allOf),void 0===e.unevaluatedProperties&&(l=void 0);else{let t=e;if("additionalProperties"in e&&!1===e.additionalProperties){let{additionalProperties:r,...a}=e;t=a}else l=void 0;u.push(t)}}),u.length?{allOf:u,...l}:void 0;case D.ZodTuple:return e.rest?{type:"array",minItems:e.items.length,items:e.items.map((e,t)=>sV(e._def,{...r,currentPath:[...r.currentPath,"items",`${t}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[]),additionalItems:sV(e.rest._def,{...r,currentPath:[...r.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map((e,t)=>sV(e._def,{...r,currentPath:[...r.currentPath,"items",`${t}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[])};case D.ZodRecord:return sU(e,r);case D.ZodLiteral:let d;return"bigint"!=(d=typeof e.value)&&"number"!==d&&"boolean"!==d&&"string"!==d?{type:Array.isArray(e.value)?"array":"object"}:"openApi3"===r.target?{type:"bigint"===d?"integer":d,enum:[e.value]}:{type:"bigint"===d?"integer":d,const:e.value};case D.ZodEnum:return{type:"string",enum:Array.from(e.values)};case D.ZodNativeEnum:let p,c,h;return p=e.values,{type:1===(h=Array.from(new Set((c=Object.keys(e.values).filter(e=>"number"!=typeof p[p[e]]).map(e=>p[e])).map(e=>typeof e)))).length?"string"===h[0]?"string":"number":["string","number"],enum:c};case D.ZodNullable:if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return"openApi3"===r.target?{type:sz[e.innerType._def.typeName],nullable:!0}:{type:[sz[e.innerType._def.typeName],"null"]};if("openApi3"===r.target){let t=sV(e.innerType._def,{...r,currentPath:[...r.currentPath]});return t&&"$ref"in t?{allOf:[t],nullable:!0}:t&&{...t,nullable:!0}}let m=sV(e.innerType._def,{...r,currentPath:[...r.currentPath,"anyOf","0"]});return m&&{anyOf:[m,{type:"null"}]};case D.ZodOptional:if(r.currentPath.toString()===r.propertyPath?.toString())return sV(e.innerType._def,r);let g=sV(e.innerType._def,{...r,currentPath:[...r.currentPath,"anyOf","1"]});return g?{anyOf:[{not:sw(r)},g]}:sw(r);case D.ZodMap:if("record"===r.mapStrategy)return sU(e,r);return{type:"array",maxItems:125,items:{type:"array",items:[sV(e.keyType._def,{...r,currentPath:[...r.currentPath,"items","items","0"]})||sw(r),sV(e.valueType._def,{...r,currentPath:[...r.currentPath,"items","items","1"]})||sw(r)],minItems:2,maxItems:2}};case D.ZodSet:let f;return f={type:"array",uniqueItems:!0,items:sV(e.valueType._def,{...r,currentPath:[...r.currentPath,"items"]})},e.minSize&&rx(f,"minItems",e.minSize.value,e.minSize.message,r),e.maxSize&&rx(f,"maxItems",e.maxSize.value,e.maxSize.message,r),f;case D.ZodLazy:return()=>e.getter()._def;case D.ZodPromise:return sV(e.type._def,r);case D.ZodNaN:case D.ZodNever:return"openAi"===r.target?void 0:{not:sw({...r,currentPath:[...r.currentPath,"not"]})};case D.ZodEffects:return"input"===r.effectStrategy?sV(e.schema._def,r):sw(r);case D.ZodAny:case D.ZodUnknown:return sw(r);case D.ZodDefault:return{...sV(e.innerType._def,r),default:e.defaultValue()};case D.ZodBranded:return s_(e,r);case D.ZodReadonly:case D.ZodCatch:return sV(e.innerType._def,r);case D.ZodPipeline:if("input"===r.pipeStrategy)return sV(e.in._def,r);if("output"===r.pipeStrategy)return sV(e.out._def,r);let y=sV(e.in._def,{...r,currentPath:[...r.currentPath,"allOf","0"]}),v=sV(e.out._def,{...r,currentPath:[...r.currentPath,"allOf",y?"1":"0"]});return{allOf:[y,v].filter(e=>void 0!==e)};case D.ZodFunction:case D.ZodVoid:case D.ZodSymbol:default:return}})(e,e.typeName,t),i="function"==typeof n?sV(n(),t):n;if(i&&sZ(e,t,i),t.postProcess){let r=t.postProcess(i,e,t);return s.jsonSchema=i,r}return s.jsonSchema=i,i}let sF=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"relative":return{$ref:rI(t.currentPath,e.path)};case"none":case"seen":if(e.path.length<t.currentPath.length&&e.path.every((e,r)=>t.currentPath[r]===e))return console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),sw(t);return"seen"===t.$refStrategy?sw(t):void 0}},sZ=(e,t,r)=>(e.description&&(r.description=e.description,t.markdownDescription&&(r.markdownDescription=e.description)),r),sW=(e,t)=>{let r,a,s=(a=void 0!==(r="string"==typeof t?{...r_,name:t}:{...r_,...t}).name?[...r.basePath,r.definitionPath,r.name]:r.basePath,{...r,flags:{hasReferencedOpenAiAnyType:!1},currentPath:a,propertyPath:void 0,seen:new Map(Object.entries(r.definitions).map(([e,t])=>[t._def,{def:t._def,path:[...r.basePath,r.definitionPath,e],jsonSchema:void 0}]))}),n="object"==typeof t&&t.definitions?Object.entries(t.definitions).reduce((e,[t,r])=>({...e,[t]:sV(r._def,{...s,currentPath:[...s.basePath,s.definitionPath,t]},!0)??sw(s)}),{}):void 0,i="string"==typeof t?t:t?.nameStrategy==="title"?void 0:t?.name,o=sV(e._def,void 0===i?s:{...s,currentPath:[...s.basePath,s.definitionPath,i]},!1)??sw(s),l="object"==typeof t&&void 0!==t.name&&"title"===t.nameStrategy?t.name:void 0;void 0!==l&&(o.title=l),s.flags.hasReferencedOpenAiAnyType&&(n||(n={}),n[s.openAiAnyTypeName]||(n[s.openAiAnyTypeName]={type:["string","number","integer","boolean","array","null"],items:{$ref:"relative"===s.$refStrategy?"1":[...s.basePath,s.definitionPath,s.openAiAnyTypeName].join("/")}}));let u=void 0===i?n?{...o,[s.definitionPath]:n}:o:{$ref:[..."relative"===s.$refStrategy?[]:s.basePath,s.definitionPath,i].join("/"),[s.definitionPath]:{...n,[i]:o}};return"jsonSchema7"===s.target?u.$schema="http://json-schema.org/draft-07/schema#":("jsonSchema2019-09"===s.target||"openAi"===s.target)&&(u.$schema="https://json-schema.org/draft/2019-09/schema#"),"openAi"===s.target&&("anyOf"in u||"oneOf"in u||"allOf"in u||"type"in u&&Array.isArray(u.type))&&console.warn("Warning: OpenAI may not support schemas with unions as roots! Try wrapping it in an object property."),u};function sG(e,t="jsonSchema7",r="relative"){let a="toJSONSchema";return a in rb.z?rb.z[a](e,{unrepresentable:"any",override:e=>{let t=e.zodSchema?._zod?.def;t&&"date"===t.type&&(e.jsonSchema.type="string",e.jsonSchema.format="date-time")}}):sW(e,{$refStrategy:r,target:t})}var sB=e.i(907855),sK="vercel.ai.error",sJ=Symbol.for(sK),sH=class e extends Error{constructor({name:e,message:t,cause:r}){super(t),this[L]=!0,this.name=e,this.cause=r}static isInstance(t){return e.hasMarker(t,sK)}static hasMarker(e,t){let r=Symbol.for(t);return null!=e&&"object"==typeof e&&r in e&&"boolean"==typeof e[r]&&!0===e[r]}};L=sJ;var sY=sH;function sQ(e){return null==e?"unknown error":"string"==typeof e?e:e instanceof Error?e.message:JSON.stringify(e)}Symbol.for("vercel.ai.error.AI_APICallError"),Symbol.for("vercel.ai.error.AI_EmptyResponseBodyError");var sX="AI_InvalidArgumentError",s0=`vercel.ai.error.${sX}`,s1=Symbol.for(s0),s2=class extends sY{constructor({message:e,cause:t,argument:r}){super({name:sX,message:e,cause:t}),this[U]=!0,this.argument=r}static isInstance(e){return sY.hasMarker(e,s0)}};U=s1,Symbol.for("vercel.ai.error.AI_InvalidPromptError"),Symbol.for("vercel.ai.error.AI_InvalidResponseDataError");var s4="AI_JSONParseError",s5=`vercel.ai.error.${s4}`,s3=Symbol.for(s5),s9=class extends sY{constructor({text:e,cause:t}){super({name:s4,message:`JSON parsing failed: Text: ${e}.
Error message: ${sQ(t)}`,cause:t}),this[z]=!0,this.text=e}static isInstance(e){return sY.hasMarker(e,s5)}};z=s3,Symbol.for("vercel.ai.error.AI_LoadAPIKeyError"),Symbol.for("vercel.ai.error.AI_LoadSettingError"),Symbol.for("vercel.ai.error.AI_NoContentGeneratedError"),Symbol.for("vercel.ai.error.AI_NoSuchModelError"),Symbol.for("vercel.ai.error.AI_TooManyEmbeddingValuesForCallError");var s6="AI_TypeValidationError",s8=`vercel.ai.error.${s6}`,s7=Symbol.for(s8),ne=class e extends sY{constructor({value:e,cause:t}){super({name:s6,message:`Type validation failed: Value: ${JSON.stringify(e)}.
Error message: ${sQ(t)}`,cause:t}),this[q]=!0,this.value=e}static isInstance(e){return sY.hasMarker(e,s8)}static wrap({value:t,cause:r}){return e.isInstance(r)&&r.value===t?r:new e({value:t,cause:r})}};q=s7,Symbol.for("vercel.ai.error.AI_UnsupportedFunctionalityError");let nt=(e,t=21)=>(r=t)=>{let a="",s=0|r;for(;s--;)a+=e[Math.random()*e.length|0];return a};var nr=e.i(150040),na=(({prefix:e,size:t=16,alphabet:r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",separator:a="-"}={})=>{let s=nt(r,t);if(null==e)return s;if(r.includes(a))throw new s2({argument:"separator",message:`The separator "${a}" must not be part of the alphabet "${r}".`});return t=>`${e}${a}${s(t)}`})(),ns=Symbol.for("vercel.ai.validator");function nn({text:e,schema:t}){try{let r=nr.default.parse(e);if(null==t)return{success:!0,value:r,rawValue:r};let a=function({value:e,schema:t}){var r;let a="object"==typeof t&&null!==t&&ns in t&&!0===t[ns]&&"validate"in t?t:(r=t,{[ns]:!0,validate:e=>{let t=r.safeParse(e);return t.success?{success:!0,value:t.data}:{success:!1,error:t.error}}});try{if(null==a.validate)return{success:!0,value:e};let t=a.validate(e);if(t.success)return t;return{success:!1,error:ne.wrap({value:e,cause:t.error})}}catch(t){return{success:!1,error:ne.wrap({value:e,cause:t})}}}({value:r,schema:t});return a.success?{...a,rawValue:r}:a}catch(t){return{success:!1,error:s9.isInstance(t)?t:new s9({text:e,cause:t})}}}var{btoa:ni,atob:no}=globalThis,nl={code:"0",name:"text",parse:e=>{if("string"!=typeof e)throw Error('"text" parts expect a string value.');return{type:"text",value:e}}},nu={code:"3",name:"error",parse:e=>{if("string"!=typeof e)throw Error('"error" parts expect a string value.');return{type:"error",value:e}}},nd={code:"4",name:"assistant_message",parse:e=>{if(null==e||"object"!=typeof e||!("id"in e)||!("role"in e)||!("content"in e)||"string"!=typeof e.id||"string"!=typeof e.role||"assistant"!==e.role||!Array.isArray(e.content)||!e.content.every(e=>null!=e&&"object"==typeof e&&"type"in e&&"text"===e.type&&"text"in e&&null!=e.text&&"object"==typeof e.text&&"value"in e.text&&"string"==typeof e.text.value))throw Error('"assistant_message" parts expect an object with an "id", "role", and "content" property.');return{type:"assistant_message",value:e}}},np={code:"5",name:"assistant_control_data",parse:e=>{if(null==e||"object"!=typeof e||!("threadId"in e)||!("messageId"in e)||"string"!=typeof e.threadId||"string"!=typeof e.messageId)throw Error('"assistant_control_data" parts expect an object with a "threadId" and "messageId" property.');return{type:"assistant_control_data",value:{threadId:e.threadId,messageId:e.messageId}}}},nc={code:"6",name:"data_message",parse:e=>{if(null==e||"object"!=typeof e||!("role"in e)||!("data"in e)||"string"!=typeof e.role||"data"!==e.role)throw Error('"data_message" parts expect an object with a "role" and "data" property.');return{type:"data_message",value:e}}},nh=[nl,nu,nd,np,nc];function nm(e){if(void 0===e)return{value:void 0,state:"undefined-input"};let t=nn({text:e});return t.success?{value:t.value,state:"successful-parse"}:(t=nn({text:function(e){let t=["ROOT"],r=-1,a=null;function s(e,s,n){switch(e){case'"':r=s,t.pop(),t.push(n),t.push("INSIDE_STRING");break;case"f":case"t":case"n":r=s,a=s,t.pop(),t.push(n),t.push("INSIDE_LITERAL");break;case"-":t.pop(),t.push(n),t.push("INSIDE_NUMBER");break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":r=s,t.pop(),t.push(n),t.push("INSIDE_NUMBER");break;case"{":r=s,t.pop(),t.push(n),t.push("INSIDE_OBJECT_START");break;case"[":r=s,t.pop(),t.push(n),t.push("INSIDE_ARRAY_START")}}function n(e,a){switch(e){case",":t.pop(),t.push("INSIDE_OBJECT_AFTER_COMMA");break;case"}":r=a,t.pop()}}function i(e,a){switch(e){case",":t.pop(),t.push("INSIDE_ARRAY_AFTER_COMMA");break;case"]":r=a,t.pop()}}for(let o=0;o<e.length;o++){let l=e[o];switch(t[t.length-1]){case"ROOT":s(l,o,"FINISH");break;case"INSIDE_OBJECT_START":switch(l){case'"':t.pop(),t.push("INSIDE_OBJECT_KEY");break;case"}":r=o,t.pop()}break;case"INSIDE_OBJECT_AFTER_COMMA":'"'===l&&(t.pop(),t.push("INSIDE_OBJECT_KEY"));break;case"INSIDE_OBJECT_KEY":'"'===l&&(t.pop(),t.push("INSIDE_OBJECT_AFTER_KEY"));break;case"INSIDE_OBJECT_AFTER_KEY":":"===l&&(t.pop(),t.push("INSIDE_OBJECT_BEFORE_VALUE"));break;case"INSIDE_OBJECT_BEFORE_VALUE":s(l,o,"INSIDE_OBJECT_AFTER_VALUE");break;case"INSIDE_OBJECT_AFTER_VALUE":n(l,o);break;case"INSIDE_STRING":switch(l){case'"':t.pop(),r=o;break;case"\\":t.push("INSIDE_STRING_ESCAPE");break;default:r=o}break;case"INSIDE_ARRAY_START":"]"===l?(r=o,t.pop()):(r=o,s(l,o,"INSIDE_ARRAY_AFTER_VALUE"));break;case"INSIDE_ARRAY_AFTER_VALUE":switch(l){case",":t.pop(),t.push("INSIDE_ARRAY_AFTER_COMMA");break;case"]":r=o,t.pop();break;default:r=o}break;case"INSIDE_ARRAY_AFTER_COMMA":s(l,o,"INSIDE_ARRAY_AFTER_VALUE");break;case"INSIDE_STRING_ESCAPE":t.pop(),r=o;break;case"INSIDE_NUMBER":switch(l){case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":r=o;break;case"e":case"E":case"-":case".":break;case",":t.pop(),"INSIDE_ARRAY_AFTER_VALUE"===t[t.length-1]&&i(l,o),"INSIDE_OBJECT_AFTER_VALUE"===t[t.length-1]&&n(l,o);break;case"}":t.pop(),"INSIDE_OBJECT_AFTER_VALUE"===t[t.length-1]&&n(l,o);break;case"]":t.pop(),"INSIDE_ARRAY_AFTER_VALUE"===t[t.length-1]&&i(l,o);break;default:t.pop()}break;case"INSIDE_LITERAL":{let s=e.substring(a,o+1);"false".startsWith(s)||"true".startsWith(s)||"null".startsWith(s)?r=o:(t.pop(),"INSIDE_OBJECT_AFTER_VALUE"===t[t.length-1]?n(l,o):"INSIDE_ARRAY_AFTER_VALUE"===t[t.length-1]&&i(l,o))}}}let o=e.slice(0,r+1);for(let r=t.length-1;r>=0;r--)switch(t[r]){case"INSIDE_STRING":o+='"';break;case"INSIDE_OBJECT_KEY":case"INSIDE_OBJECT_AFTER_KEY":case"INSIDE_OBJECT_AFTER_COMMA":case"INSIDE_OBJECT_START":case"INSIDE_OBJECT_BEFORE_VALUE":case"INSIDE_OBJECT_AFTER_VALUE":o+="}";break;case"INSIDE_ARRAY_START":case"INSIDE_ARRAY_AFTER_COMMA":case"INSIDE_ARRAY_AFTER_VALUE":o+="]";break;case"INSIDE_LITERAL":{let t=e.substring(a,e.length);"true".startsWith(t)?o+="true".slice(t.length):"false".startsWith(t)?o+="false".slice(t.length):"null".startsWith(t)&&(o+="null".slice(t.length))}}return o}(e)})).success?{value:t.value,state:"repaired-parse"}:{value:void 0,state:"failed-parse"}}nl.code,nu.code,nd.code,np.code,nc.code,nl.name,nl.code,nu.name,nu.code,nd.name,nd.code,np.name,np.code,nc.name,nc.code,nh.map(e=>e.code);var ng=[{code:"0",name:"text",parse:e=>{if("string"!=typeof e)throw Error('"text" parts expect a string value.');return{type:"text",value:e}}},{code:"2",name:"data",parse:e=>{if(!Array.isArray(e))throw Error('"data" parts expect an array value.');return{type:"data",value:e}}},{code:"3",name:"error",parse:e=>{if("string"!=typeof e)throw Error('"error" parts expect a string value.');return{type:"error",value:e}}},{code:"8",name:"message_annotations",parse:e=>{if(!Array.isArray(e))throw Error('"message_annotations" parts expect an array value.');return{type:"message_annotations",value:e}}},{code:"9",name:"tool_call",parse:e=>{if(null==e||"object"!=typeof e||!("toolCallId"in e)||"string"!=typeof e.toolCallId||!("toolName"in e)||"string"!=typeof e.toolName||!("args"in e)||"object"!=typeof e.args)throw Error('"tool_call" parts expect an object with a "toolCallId", "toolName", and "args" property.');return{type:"tool_call",value:e}}},{code:"a",name:"tool_result",parse:e=>{if(null==e||"object"!=typeof e||!("toolCallId"in e)||"string"!=typeof e.toolCallId||!("result"in e))throw Error('"tool_result" parts expect an object with a "toolCallId" and a "result" property.');return{type:"tool_result",value:e}}},{code:"b",name:"tool_call_streaming_start",parse:e=>{if(null==e||"object"!=typeof e||!("toolCallId"in e)||"string"!=typeof e.toolCallId||!("toolName"in e)||"string"!=typeof e.toolName)throw Error('"tool_call_streaming_start" parts expect an object with a "toolCallId" and "toolName" property.');return{type:"tool_call_streaming_start",value:e}}},{code:"c",name:"tool_call_delta",parse:e=>{if(null==e||"object"!=typeof e||!("toolCallId"in e)||"string"!=typeof e.toolCallId||!("argsTextDelta"in e)||"string"!=typeof e.argsTextDelta)throw Error('"tool_call_delta" parts expect an object with a "toolCallId" and "argsTextDelta" property.');return{type:"tool_call_delta",value:e}}},{code:"d",name:"finish_message",parse:e=>{if(null==e||"object"!=typeof e||!("finishReason"in e)||"string"!=typeof e.finishReason)throw Error('"finish_message" parts expect an object with a "finishReason" property.');let t={finishReason:e.finishReason};return"usage"in e&&null!=e.usage&&"object"==typeof e.usage&&"promptTokens"in e.usage&&"completionTokens"in e.usage&&(t.usage={promptTokens:"number"==typeof e.usage.promptTokens?e.usage.promptTokens:NaN,completionTokens:"number"==typeof e.usage.completionTokens?e.usage.completionTokens:NaN}),{type:"finish_message",value:t}}},{code:"e",name:"finish_step",parse:e=>{if(null==e||"object"!=typeof e||!("finishReason"in e)||"string"!=typeof e.finishReason)throw Error('"finish_step" parts expect an object with a "finishReason" property.');let t={finishReason:e.finishReason,isContinued:!1};return"usage"in e&&null!=e.usage&&"object"==typeof e.usage&&"promptTokens"in e.usage&&"completionTokens"in e.usage&&(t.usage={promptTokens:"number"==typeof e.usage.promptTokens?e.usage.promptTokens:NaN,completionTokens:"number"==typeof e.usage.completionTokens?e.usage.completionTokens:NaN}),"isContinued"in e&&"boolean"==typeof e.isContinued&&(t.isContinued=e.isContinued),{type:"finish_step",value:t}}},{code:"f",name:"start_step",parse:e=>{if(null==e||"object"!=typeof e||!("messageId"in e)||"string"!=typeof e.messageId)throw Error('"start_step" parts expect an object with an "id" property.');return{type:"start_step",value:{messageId:e.messageId}}}},{code:"g",name:"reasoning",parse:e=>{if("string"!=typeof e)throw Error('"reasoning" parts expect a string value.');return{type:"reasoning",value:e}}},{code:"h",name:"source",parse:e=>{if(null==e||"object"!=typeof e)throw Error('"source" parts expect a Source object.');return{type:"source",value:e}}},{code:"i",name:"redacted_reasoning",parse:e=>{if(null==e||"object"!=typeof e||!("data"in e)||"string"!=typeof e.data)throw Error('"redacted_reasoning" parts expect an object with a "data" property.');return{type:"redacted_reasoning",value:{data:e.data}}}},{code:"j",name:"reasoning_signature",parse:e=>{if(null==e||"object"!=typeof e||!("signature"in e)||"string"!=typeof e.signature)throw Error('"reasoning_signature" parts expect an object with a "signature" property.');return{type:"reasoning_signature",value:{signature:e.signature}}}},{code:"k",name:"file",parse:e=>{if(null==e||"object"!=typeof e||!("data"in e)||"string"!=typeof e.data||!("mimeType"in e)||"string"!=typeof e.mimeType)throw Error('"file" parts expect an object with a "data" and "mimeType" property.');return{type:"file",value:e}}}];function nf(e,t){let r=ng.find(t=>t.name===e);if(!r)throw Error(`Invalid stream part type: ${e}`);return`${r.code}:${JSON.stringify(t)}
`}function ny(e,t){if(e===t)return!0;if(null==e||null==t)return!1;if("object"!=typeof e&&"object"!=typeof t)return e===t;if(e.constructor!==t.constructor)return!1;if(e instanceof Date&&t instanceof Date)return e.getTime()===t.getTime();if(Array.isArray(e)){if(e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(!ny(e[r],t[r]))return!1;return!0}let r=Object.keys(e),a=Object.keys(t);if(r.length!==a.length)return!1;for(let s of r)if(!a.includes(s)||!ny(e[s],t[s]))return!1;return!0}Object.fromEntries(ng.map(e=>[e.code,e])),Object.fromEntries(ng.map(e=>[e.name,e.code])),ng.map(e=>e.code);var nv=Symbol.for("vercel.ai.schema");function nb(e,{validate:t}={}){return{[nv]:!0,_type:void 0,[ns]:!0,jsonSchema:e,validate:t}}function nw(e){return"object"==typeof e&&null!==e&&nv in e&&!0===e[nv]&&"jsonSchema"in e&&"validate"in e?e:nb(sW(e,{$refStrategy:"none",target:"jsonSchema7"}),{validate:t=>{let r=e.safeParse(t);return r.success?{success:!0,value:r.data}:{success:!1,error:r.error}}})}e.i(654048);var n_=e.i(562810);e.s(["default",0,n_],580420),e.i(580420);var nS=n_,nx=class{apply(e,t){if(!t.type)return;let r=new Set(Array.isArray(t.type)?t.type:[t.type]);if(r.has("string")||(e.string=!1),r.has("number")||r.has("integer")||(e.number=!1),r.has("boolean")||(e.boolean=!1),r.has("null")||(e.null=!1),r.has("array")||(e.array=!1),r.has("object")||(e.object=!1),r.has("integer")&&!1!==e.number){let t=e.number||nS.number();t instanceof nS.ZodNumber&&(e.number=t.int())}}},nI=class{apply(e,t){if(void 0===t.const)return;let r=t.const;e.string=!1,e.number=!1,e.boolean=!1,e.null=!1,e.array=!1,e.object=!1,"string"==typeof r?e.string=nS.literal(r):"number"==typeof r?e.number=nS.literal(r):"boolean"==typeof r?e.boolean=nS.literal(r):null===r?e.null=nS.null():Array.isArray(r)?e.array=void 0:"object"==typeof r&&(e.object=void 0)}},nk=class{apply(e,t){if(!t.enum)return;if(0===t.enum.length){t.type||(e.string=!1,e.number=!1,e.boolean=!1,e.null=!1,e.array=!1,e.object=!1);return}let r={string:t.enum.filter(e=>"string"==typeof e),number:t.enum.filter(e=>"number"==typeof e),boolean:t.enum.filter(e=>"boolean"==typeof e),null:t.enum.filter(e=>null===e),array:t.enum.filter(e=>Array.isArray(e)),object:t.enum.filter(e=>"object"==typeof e&&null!==e&&!Array.isArray(e))};e.string=this.createTypeSchema(r.string,"string"),e.number=this.createTypeSchema(r.number,"number"),e.boolean=this.createTypeSchema(r.boolean,"boolean"),e.null=r.null.length>0&&nS.null(),e.array=r.array.length>0&&void 0,e.object=r.object.length>0&&void 0}createTypeSchema(e,t){if(0===e.length)return!1;if(1===e.length)return nS.literal(e[0]);if("string"===t)return nS.enum(e);if("number"===t){let[t,r,...a]=e;return nS.union([nS.literal(t),nS.literal(r),...a.map(e=>nS.literal(e))])}return"boolean"===t&&nS.union([nS.literal(!0),nS.literal(!1)])}},nT=class{apply(e,t){if("string"===t.type&&"binary"===t.format&&"binary"===t.contentEncoding){let r=nS.file();void 0!==t.minLength&&(r=r.min(t.minLength)),void 0!==t.maxLength&&(r=r.max(t.maxLength)),void 0!==t.contentMediaType&&(r=r.mime(t.contentMediaType)),e.file=r,e.string=!1}}},nE=class{apply(e,t){void 0===t.type&&(void 0!==t.minLength||void 0!==t.maxLength||void 0!==t.pattern)&&void 0===e.string&&(e.string=nS.string())}},nA=class{apply(e,t){if(void 0!==t.minLength&&!1!==e.string){let r=e.string||nS.string();r instanceof nS.ZodString&&(e.string=r.refine(e=>Array.from(e).length>=t.minLength,{message:`String must be at least ${t.minLength} characters long`}))}}},nO=class{apply(e,t){if(void 0!==t.maxLength&&!1!==e.string){let r=e.string||nS.string();r instanceof nS.ZodString&&(e.string=r.refine(e=>Array.from(e).length<=t.maxLength,{message:`String must be at most ${t.maxLength} characters long`}))}}},nC=class{apply(e,t){if(t.pattern&&!1!==e.string){let r=e.string||nS.string();if(r instanceof nS.ZodString){let a=new RegExp(t.pattern);e.string=r.regex(a)}}}},nR=class{apply(e,t){if(void 0!==t.minimum&&!1!==e.number){let r=e.number||nS.number();r instanceof nS.ZodNumber&&(e.number=r.min(t.minimum))}}},nM=class{apply(e,t){if(void 0!==t.maximum&&!1!==e.number){let r=e.number||nS.number();r instanceof nS.ZodNumber&&(e.number=r.max(t.maximum))}}},nN=class{apply(e,t){if(void 0!==t.exclusiveMinimum&&!1!==e.number){let r=e.number||nS.number();r instanceof nS.ZodNumber&&("number"==typeof t.exclusiveMinimum?e.number=r.gt(t.exclusiveMinimum):e.number=!1)}}},nj=class{apply(e,t){if(void 0!==t.exclusiveMaximum&&!1!==e.number){let r=e.number||nS.number();r instanceof nS.ZodNumber&&("number"==typeof t.exclusiveMaximum?e.number=r.lt(t.exclusiveMaximum):e.number=!1)}}},nP=class{apply(e,t){if(void 0!==t.multipleOf&&!1!==e.number){let r=e.number||nS.number();r instanceof nS.ZodNumber&&(e.number=r.refine(e=>{if(0===t.multipleOf)return!1;let r=e/t.multipleOf,a=Math.round(r);return Math.abs(r-a)<=Math.min(Math.abs(e)*Number.EPSILON*10,Math.abs(t.multipleOf)*Number.EPSILON*10)/Math.abs(t.multipleOf)},{message:`Must be a multiple of ${t.multipleOf}`}))}}},n$=class{apply(e,t){void 0===t.type&&(void 0!==t.minItems||void 0!==t.maxItems||void 0!==t.items||void 0!==t.prefixItems)&&void 0===e.array&&(e.array=nS.array(nS.any()))}},nD=class{apply(e,t){void 0!==t.minItems&&!1!==e.array&&(e.array=(e.array||nS.array(nS.any())).min(t.minItems))}},nL=class{apply(e,t){void 0!==t.maxItems&&!1!==e.array&&(e.array=(e.array||nS.array(nS.any())).max(t.maxItems))}},nU=class{apply(e,t){if(!1!==e.array)if(Array.isArray(t.items))e.array=e.array||nS.array(nS.any());else if(t.items&&"boolean"!=typeof t.items&&!t.prefixItems){let r=n8(t.items),a=nS.array(r);if(e.array&&e.array instanceof nS.ZodArray){let t=e.array._def;t.checks&&t.checks.forEach(e=>{if(e._zod&&e._zod.def){let t=e._zod.def;"min_length"===t.check&&void 0!==t.minimum?a=a.min(t.minimum):"max_length"===t.check&&void 0!==t.maximum&&(a=a.max(t.maximum))}})}e.array=a}else"boolean"==typeof t.items&&!1===t.items?t.prefixItems?e.array=e.array||nS.array(nS.any()):e.array=nS.array(nS.any()).max(0):"boolean"==typeof t.items&&!0===t.items?e.array=e.array||nS.array(nS.any()):t.prefixItems&&(e.array=e.array||nS.array(nS.any()))}},nz=class{apply(e,t){let r;if("array"!==t.type||!Array.isArray(t.items)||!1===e.array)return;let a=t.items.map(e=>n8(e));r=0===a.length?nS.tuple([]):nS.tuple(a),void 0!==t.minItems&&t.minItems>a.length&&(r=!1),void 0!==t.maxItems&&t.maxItems<a.length&&(r=!1),e.tuple=r,e.array=!1}},nq=class{apply(e,t){!1!==e.object&&(t.properties||t.required||void 0!==t.additionalProperties)&&(e.object=e.object||nS.object({}).passthrough())}},nV=class{apply(e,t){void 0===t.type&&(void 0!==t.maxProperties||void 0!==t.minProperties)&&void 0===e.object&&(e.object=nS.object({}).passthrough())}},nF=class{apply(e,t){if(void 0!==t.maxProperties&&!1!==e.object){let r=e.object||nS.object({}).passthrough();e.object=r.refine(e=>Object.keys(e).length<=t.maxProperties,{message:`Object must have at most ${t.maxProperties} properties`})}}},nZ=class{apply(e,t){if(void 0!==t.minProperties&&!1!==e.object){let r=e.object||nS.object({}).passthrough();e.object=r.refine(e=>Object.keys(e).length>=t.minProperties,{message:`Object must have at least ${t.minProperties} properties`})}}};function nW(e,t){if(e===t)return!0;if(null==e||null==t)return e===t;if(typeof e!=typeof t)return!1;if(Array.isArray(e)&&Array.isArray(t))return e.length===t.length&&e.every((e,r)=>nW(e,t[r]));if("object"==typeof e&&"object"==typeof t){let r=Object.keys(e),a=Object.keys(t);return r.length===a.length&&r.every(r=>a.includes(r)&&nW(e[r],t[r]))}return!1}function nG(e,t){return e.safeParse(t).success}var nB=class{apply(e,t){if(!t.not)return e;let r=n8(t.not);return e.refine(e=>!nG(r,e),{message:"Value must not match the 'not' schema"})}},nK=class{apply(e,t){return!0!==t.uniqueItems?e:e.refine(e=>{if(!Array.isArray(e))return!0;let t=[];return e.every(e=>!t.some(t=>nW(e,t))&&(t.push(e),!0))},{message:"Array items must be unique"})}},nJ=class{apply(e,t){return t.allOf&&0!==t.allOf.length?t.allOf.map(e=>n8(e)).reduce((e,t)=>nS.intersection(e,t),e):e}},nH=class{apply(e,t){if(!t.anyOf||0===t.anyOf.length)return e;let r=1===t.anyOf.length?n8(t.anyOf[0]):nS.union([n8(t.anyOf[0]),n8(t.anyOf[1]),...t.anyOf.slice(2).map(e=>n8(e))]);return nS.intersection(e,r)}},nY=class{apply(e,t){if(!t.oneOf||0===t.oneOf.length)return e;let r=t.oneOf.map(e=>n8(e));return e.refine(e=>{let t=0;for(let a of r)if(a.safeParse(e).success&&++t>1)return!1;return 1===t},{message:"Value must match exactly one of the oneOf schemas"})}},nQ=class{apply(e,t){if(t.prefixItems&&Array.isArray(t.prefixItems)){let r=t.prefixItems.map(e=>n8(e));return e.refine(e=>{if(!Array.isArray(e))return!0;for(let t=0;t<Math.min(e.length,r.length);t++)if(!nG(r[t],e[t]))return!1;if(e.length>r.length){if("boolean"==typeof t.items&&!1===t.items)return!1;else if(t.items&&"object"==typeof t.items&&!Array.isArray(t.items)){let a=n8(t.items);for(let t=r.length;t<e.length;t++)if(!nG(a,e[t]))return!1}}return!0},{message:"Array does not match prefixItems schema"})}return e}},nX=class{apply(e,t){if(!t.properties&&!t.required&&!1!==t.additionalProperties)return e;if(e instanceof nS.ZodObject||e instanceof nS.ZodRecord){let e={};if(t.properties)for(let[r,a]of Object.entries(t.properties))void 0!==a&&(e[r]=n8(a));if(t.required&&Array.isArray(t.required)){let r=new Set(t.required);for(let t of Object.keys(e))r.has(t)||(e[t]=e[t].optional())}else for(let t of Object.keys(e))e[t]=e[t].optional();return!1===t.additionalProperties?nS.object(e):nS.object(e).passthrough()}return e.refine(e=>{if("object"!=typeof e||null===e||Array.isArray(e))return!0;if(t.properties){for(let[r,a]of Object.entries(t.properties))if(void 0!==a&&void 0!==Object.getOwnPropertyDescriptor(e,r)&&!n8(a).safeParse(e[r]).success)return!1}if(t.required&&Array.isArray(t.required)){for(let r of t.required)if(void 0===Object.getOwnPropertyDescriptor(e,r))return!1}if(!1===t.additionalProperties&&t.properties){let r=new Set(Object.keys(t.properties));for(let t in e)if(!r.has(t))return!1}return!0},{message:"Object constraints validation failed"})}},n0=class{apply(e,t){if(!t.enum||0===t.enum.length)return e;let r=t.enum.filter(e=>Array.isArray(e)||"object"==typeof e&&null!==e);return 0===r.length?e:e.refine(e=>"object"!=typeof e||null===e||r.some(t=>nW(e,t)),{message:"Value must match one of the enum values"})}},n1=class{apply(e,t){if(void 0===t.const)return e;let r=t.const;return"object"!=typeof r||null===r?e:e.refine(e=>nW(e,r),{message:"Value must equal the const value"})}},n2=class{apply(e,t){return t.description&&(e=e.describe(t.description)),e}},n4=class{apply(e,t){var r;return(null==(r=t.required)?void 0:r.includes("__proto__"))&&void 0===t.type?nS.any().refine(e=>this.validateRequired(e,t.required),{message:"Missing required properties"}):e}validateRequired(e,t){return!!("object"!=typeof e||null===e||Array.isArray(e))||t.every(t=>Object.prototype.hasOwnProperty.call(e,t))}},n5=class{apply(e,t){var r;if(void 0===t.contains)return e;let a=n8(t.contains),s=null!=(r=t.minContains)?r:1,n=t.maxContains;return e.refine(e=>{if(!Array.isArray(e))return!0;let t=0;for(let r of e)nG(a,r)&&t++;return!(t<s)&&(void 0===n||!(t>n))},{message:"Array must contain required items matching the schema"})}},n3=class{apply(e,t){let{default:r}=t;return void 0!==r&&e.safeParse(r).success?e.default(r):e}},n9=[new nI,new nk,new nx,new nT,new nE,new n$,new nV,new nA,new nO,new nC,new nR,new nM,new nN,new nj,new nP,new nz,new nD,new nL,new nU,new nF,new nZ,new nq],n6=[new n4,new n0,new n1,new nJ,new nH,new nY,new nQ,new nX,new n5,new nB,new nK,new n3,new n2];function n8(e){let t;if("boolean"==typeof e)return e?nS.any():nS.never();let r={};for(let t of n9)t.apply(r,e);let a=[];if(!1!==r.string&&a.push(r.string||nS.string()),!1!==r.number&&a.push(r.number||nS.number()),!1!==r.boolean&&a.push(r.boolean||nS.boolean()),!1!==r.null&&a.push(r.null||nS.null()),!1!==r.array&&a.push(r.array||nS.array(nS.any())),!1!==r.tuple&&void 0!==r.tuple&&a.push(r.tuple),!1!==r.object)if(r.object)a.push(r.object);else{let e=nS.custom(e=>"object"==typeof e&&null!==e&&!Array.isArray(e),"Must be an object, not an array");a.push(e)}for(let s of(!1!==r.file&&void 0!==r.file&&a.push(r.file),t=0===a.length?nS.never():1===a.length?a[0]:Object.keys(e).some(e=>"$schema"!==e&&"title"!==e&&"description"!==e)?nS.union(a):nS.any(),n6))t=s.apply(t,e);return t}e.s([],546927),e.i(546927),(h=V||(V={})).assertEqual=e=>{},h.assertIs=function(e){},h.assertNever=function(e){throw Error()},h.arrayToEnum=e=>{let t={};for(let r of e)t[r]=r;return t},h.getValidEnumValues=e=>{let t=h.objectKeys(e).filter(t=>"number"!=typeof e[e[t]]),r={};for(let a of t)r[a]=e[a];return h.objectValues(r)},h.objectValues=e=>h.objectKeys(e).map(function(t){return e[t]}),h.objectKeys="function"==typeof Object.keys?e=>Object.keys(e):e=>{let t=[];for(let r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.push(r);return t},h.find=(e,t)=>{for(let r of e)if(t(r))return r},h.isInteger="function"==typeof Number.isInteger?e=>Number.isInteger(e):e=>"number"==typeof e&&Number.isFinite(e)&&Math.floor(e)===e,h.joinValues=function(e,t=" | "){return e.map(e=>"string"==typeof e?`'${e}'`:e).join(t)},h.jsonStringifyReplacer=(e,t)=>"bigint"==typeof t?t.toString():t,(F||(F={})).mergeShapes=(e,t)=>({...e,...t});let n7=V.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),ie=e=>{switch(typeof e){case"undefined":return n7.undefined;case"string":return n7.string;case"number":return Number.isNaN(e)?n7.nan:n7.number;case"boolean":return n7.boolean;case"function":return n7.function;case"bigint":return n7.bigint;case"symbol":return n7.symbol;case"object":if(Array.isArray(e))return n7.array;if(null===e)return n7.null;if(e.then&&"function"==typeof e.then&&e.catch&&"function"==typeof e.catch)return n7.promise;if("undefined"!=typeof Map&&e instanceof Map)return n7.map;if("undefined"!=typeof Set&&e instanceof Set)return n7.set;if("undefined"!=typeof Date&&e instanceof Date)return n7.date;return n7.object;default:return n7.unknown}};e.s(["ZodParsedType",0,n7,"getParsedType",0,ie,"objectUtil",()=>F,"util",()=>V],546382);let it=V.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]),ir=e=>JSON.stringify(e,null,2).replace(/"([^"]+)":/g,"$1:");class ia extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=e=>{this.issues=[...this.issues,e]},this.addIssues=(e=[])=>{this.issues=[...this.issues,...e]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}format(e){let t=e||function(e){return e.message},r={_errors:[]},a=e=>{for(let s of e.issues)if("invalid_union"===s.code)s.unionErrors.map(a);else if("invalid_return_type"===s.code)a(s.returnTypeError);else if("invalid_arguments"===s.code)a(s.argumentsError);else if(0===s.path.length)r._errors.push(t(s));else{let e=r,a=0;for(;a<s.path.length;){let r=s.path[a];a===s.path.length-1?(e[r]=e[r]||{_errors:[]},e[r]._errors.push(t(s))):e[r]=e[r]||{_errors:[]},e=e[r],a++}}};return a(this),r}static assert(e){if(!(e instanceof ia))throw Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,V.jsonStringifyReplacer,2)}get isEmpty(){return 0===this.issues.length}flatten(e=e=>e.message){let t={},r=[];for(let a of this.issues)if(a.path.length>0){let r=a.path[0];t[r]=t[r]||[],t[r].push(e(a))}else r.push(e(a));return{formErrors:r,fieldErrors:t}}get formErrors(){return this.flatten()}}ia.create=e=>new ia(e),e.s(["ZodError",()=>ia,"ZodIssueCode",0,it,"quotelessJson",0,ir],512329);let is=(e,t)=>{let r;switch(e.code){case it.invalid_type:r=e.received===n7.undefined?"Required":`Expected ${e.expected}, received ${e.received}`;break;case it.invalid_literal:r=`Invalid literal value, expected ${JSON.stringify(e.expected,V.jsonStringifyReplacer)}`;break;case it.unrecognized_keys:r=`Unrecognized key(s) in object: ${V.joinValues(e.keys,", ")}`;break;case it.invalid_union:r="Invalid input";break;case it.invalid_union_discriminator:r=`Invalid discriminator value. Expected ${V.joinValues(e.options)}`;break;case it.invalid_enum_value:r=`Invalid enum value. Expected ${V.joinValues(e.options)}, received '${e.received}'`;break;case it.invalid_arguments:r="Invalid function arguments";break;case it.invalid_return_type:r="Invalid function return type";break;case it.invalid_date:r="Invalid date";break;case it.invalid_string:"object"==typeof e.validation?"includes"in e.validation?(r=`Invalid input: must include "${e.validation.includes}"`,"number"==typeof e.validation.position&&(r=`${r} at one or more positions greater than or equal to ${e.validation.position}`)):"startsWith"in e.validation?r=`Invalid input: must start with "${e.validation.startsWith}"`:"endsWith"in e.validation?r=`Invalid input: must end with "${e.validation.endsWith}"`:V.assertNever(e.validation):r="regex"!==e.validation?`Invalid ${e.validation}`:"Invalid";break;case it.too_small:r="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at least":"more than"} ${e.minimum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at least":"over"} ${e.minimum} character(s)`:"number"===e.type||"bigint"===e.type?`Number must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${e.minimum}`:"date"===e.type?`Date must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(e.minimum))}`:"Invalid input";break;case it.too_big:r="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at most":"less than"} ${e.maximum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at most":"under"} ${e.maximum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"bigint"===e.type?`BigInt must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"date"===e.type?`Date must be ${e.exact?"exactly":e.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(e.maximum))}`:"Invalid input";break;case it.custom:r="Invalid input";break;case it.invalid_intersection_types:r="Intersection results could not be merged";break;case it.not_multiple_of:r=`Number must be a multiple of ${e.multipleOf}`;break;case it.not_finite:r="Number must be finite";break;default:r=t.defaultError,V.assertNever(e)}return{message:r}},ii=is;function io(e){ii=e}function il(){return ii}e.s(["getErrorMap",()=>il,"setErrorMap",()=>io],8891),e.i(8891),e.s(["defaultErrorMap",0,is,"getErrorMap",()=>il,"setErrorMap",()=>io],186165),e.i(186165);let iu=e=>{let{data:t,path:r,errorMaps:a,issueData:s}=e,n=[...r,...s.path||[]],i={...s,path:n};if(void 0!==s.message)return{...s,path:n,message:s.message};let o="";for(let e of a.filter(e=>!!e).slice().reverse())o=e(i,{data:t,defaultError:o}).message;return{...s,path:n,message:o}},id=[];function ip(e,t){let r=ii,a=iu({issueData:t,data:e.data,path:e.path,errorMaps:[e.common.contextualErrorMap,e.schemaErrorMap,r,r===is?void 0:is].filter(e=>!!e)});e.common.issues.push(a)}class ic{constructor(){this.value="valid"}dirty(){"valid"===this.value&&(this.value="dirty")}abort(){"aborted"!==this.value&&(this.value="aborted")}static mergeArray(e,t){let r=[];for(let a of t){if("aborted"===a.status)return ih;"dirty"===a.status&&e.dirty(),r.push(a.value)}return{status:e.value,value:r}}static async mergeObjectAsync(e,t){let r=[];for(let e of t){let t=await e.key,a=await e.value;r.push({key:t,value:a})}return ic.mergeObjectSync(e,r)}static mergeObjectSync(e,t){let r={};for(let a of t){let{key:t,value:s}=a;if("aborted"===t.status||"aborted"===s.status)return ih;"dirty"===t.status&&e.dirty(),"dirty"===s.status&&e.dirty(),"__proto__"!==t.value&&(void 0!==s.value||a.alwaysSet)&&(r[t.value]=s.value)}return{status:e.value,value:r}}}let ih=Object.freeze({status:"aborted"}),im=e=>({status:"dirty",value:e}),ig=e=>({status:"valid",value:e}),iy=e=>"aborted"===e.status,iv=e=>"dirty"===e.status,ib=e=>"valid"===e.status,iw=e=>"undefined"!=typeof Promise&&e instanceof Promise;e.s(["DIRTY",0,im,"EMPTY_PATH",0,id,"INVALID",0,ih,"OK",0,ig,"ParseStatus",()=>ic,"addIssueToContext",()=>ip,"isAborted",0,iy,"isAsync",0,iw,"isDirty",0,iv,"isValid",0,ib,"makeIssue",0,iu],266994),e.i(266994),e.s([],384379),e.i(384379),e.i(546382),(m=Z||(Z={})).errToObj=e=>"string"==typeof e?{message:e}:e||{},m.toString=e=>"string"==typeof e?e:e?.message;class i_{constructor(e,t,r,a){this._cachedPath=[],this.parent=e,this.data=t,this._path=r,this._key=a}get path(){return this._cachedPath.length||(Array.isArray(this._key)?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}let iS=(e,t)=>{if(ib(t))return{success:!0,data:t.value};if(!e.common.issues.length)throw Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;let t=new ia(e.common.issues);return this._error=t,this._error}}};function ix(e){if(!e)return{};let{errorMap:t,invalid_type_error:r,required_error:a,description:s}=e;if(t&&(r||a))throw Error('Can\'t use "invalid_type_error" or "required_error" in conjunction with custom error map.');return t?{errorMap:t,description:s}:{errorMap:(t,s)=>{let{message:n}=e;return"invalid_enum_value"===t.code?{message:n??s.defaultError}:void 0===s.data?{message:n??a??s.defaultError}:"invalid_type"!==t.code?{message:s.defaultError}:{message:n??r??s.defaultError}},description:s}}class iI{get description(){return this._def.description}_getType(e){return ie(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:ie(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new ic,ctx:{common:e.parent.common,data:e.data,parsedType:ie(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){let t=this._parse(e);if(iw(t))throw Error("Synchronous parse encountered promise.");return t}_parseAsync(e){return Promise.resolve(this._parse(e))}parse(e,t){let r=this.safeParse(e,t);if(r.success)return r.data;throw r.error}safeParse(e,t){let r={common:{issues:[],async:t?.async??!1,contextualErrorMap:t?.errorMap},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:ie(e)},a=this._parseSync({data:e,path:r.path,parent:r});return iS(r,a)}"~validate"(e){let t={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:ie(e)};if(!this["~standard"].async)try{let r=this._parseSync({data:e,path:[],parent:t});return ib(r)?{value:r.value}:{issues:t.common.issues}}catch(e){e?.message?.toLowerCase()?.includes("encountered")&&(this["~standard"].async=!0),t.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:t}).then(e=>ib(e)?{value:e.value}:{issues:t.common.issues})}async parseAsync(e,t){let r=await this.safeParseAsync(e,t);if(r.success)return r.data;throw r.error}async safeParseAsync(e,t){let r={common:{issues:[],contextualErrorMap:t?.errorMap,async:!0},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:ie(e)},a=this._parse({data:e,path:r.path,parent:r});return iS(r,await (iw(a)?a:Promise.resolve(a)))}refine(e,t){return this._refinement((r,a)=>{let s=e(r),n=()=>a.addIssue({code:it.custom,..."string"==typeof t||void 0===t?{message:t}:"function"==typeof t?t(r):t});return"undefined"!=typeof Promise&&s instanceof Promise?s.then(e=>!!e||(n(),!1)):!!s||(n(),!1)})}refinement(e,t){return this._refinement((r,a)=>!!e(r)||(a.addIssue("function"==typeof t?t(r,a):t),!1))}_refinement(e){return new ol({schema:this,typeName:W.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:e=>this["~validate"](e)}}optional(){return ou.create(this,this._def)}nullable(){return od.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return i1.create(this)}promise(){return oo.create(this,this._def)}or(e){return i4.create([this,e],this._def)}and(e){return i9.create(this,e,this._def)}transform(e){return new ol({...ix(this._def),schema:this,typeName:W.ZodEffects,effect:{type:"transform",transform:e}})}default(e){return new op({...ix(this._def),innerType:this,defaultValue:"function"==typeof e?e:()=>e,typeName:W.ZodDefault})}brand(){return new og({typeName:W.ZodBranded,type:this,...ix(this._def)})}catch(e){return new oc({...ix(this._def),innerType:this,catchValue:"function"==typeof e?e:()=>e,typeName:W.ZodCatch})}describe(e){return new this.constructor({...this._def,description:e})}pipe(e){return of.create(this,e)}readonly(){return oy.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}let ik=/^c[^\s-]{8,}$/i,iT=/^[0-9a-z]+$/,iE=/^[0-9A-HJKMNP-TV-Z]{26}$/i,iA=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,iO=/^[a-z0-9_-]{21}$/i,iC=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,iR=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,iM=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,iN=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ij=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,iP=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,i$=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,iD=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,iL=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,iU="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",iz=RegExp(`^${iU}$`);function iq(e){let t="[0-5]\\d";e.precision?t=`${t}\\.\\d{${e.precision}}`:null==e.precision&&(t=`${t}(\\.\\d+)?`);let r=e.precision?"+":"?";return`([01]\\d|2[0-3]):[0-5]\\d(:${t})${r}`}function iV(e){let t=`${iU}T${iq(e)}`,r=[];return r.push(e.local?"Z?":"Z"),e.offset&&r.push("([+-]\\d{2}:?\\d{2})"),t=`${t}(${r.join("|")})`,RegExp(`^${t}$`)}class iF extends iI{_parse(e){var t,a,s,n;let i;if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==n7.string){let t=this._getOrReturnCtx(e);return ip(t,{code:it.invalid_type,expected:n7.string,received:t.parsedType}),ih}let o=new ic;for(let l of this._def.checks)if("min"===l.kind)e.data.length<l.value&&(ip(i=this._getOrReturnCtx(e,i),{code:it.too_small,minimum:l.value,type:"string",inclusive:!0,exact:!1,message:l.message}),o.dirty());else if("max"===l.kind)e.data.length>l.value&&(ip(i=this._getOrReturnCtx(e,i),{code:it.too_big,maximum:l.value,type:"string",inclusive:!0,exact:!1,message:l.message}),o.dirty());else if("length"===l.kind){let t=e.data.length>l.value,r=e.data.length<l.value;(t||r)&&(i=this._getOrReturnCtx(e,i),t?ip(i,{code:it.too_big,maximum:l.value,type:"string",inclusive:!0,exact:!0,message:l.message}):r&&ip(i,{code:it.too_small,minimum:l.value,type:"string",inclusive:!0,exact:!0,message:l.message}),o.dirty())}else if("email"===l.kind)iM.test(e.data)||(ip(i=this._getOrReturnCtx(e,i),{validation:"email",code:it.invalid_string,message:l.message}),o.dirty());else if("emoji"===l.kind)r||(r=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),r.test(e.data)||(ip(i=this._getOrReturnCtx(e,i),{validation:"emoji",code:it.invalid_string,message:l.message}),o.dirty());else if("uuid"===l.kind)iA.test(e.data)||(ip(i=this._getOrReturnCtx(e,i),{validation:"uuid",code:it.invalid_string,message:l.message}),o.dirty());else if("nanoid"===l.kind)iO.test(e.data)||(ip(i=this._getOrReturnCtx(e,i),{validation:"nanoid",code:it.invalid_string,message:l.message}),o.dirty());else if("cuid"===l.kind)ik.test(e.data)||(ip(i=this._getOrReturnCtx(e,i),{validation:"cuid",code:it.invalid_string,message:l.message}),o.dirty());else if("cuid2"===l.kind)iT.test(e.data)||(ip(i=this._getOrReturnCtx(e,i),{validation:"cuid2",code:it.invalid_string,message:l.message}),o.dirty());else if("ulid"===l.kind)iE.test(e.data)||(ip(i=this._getOrReturnCtx(e,i),{validation:"ulid",code:it.invalid_string,message:l.message}),o.dirty());else if("url"===l.kind)try{new URL(e.data)}catch{ip(i=this._getOrReturnCtx(e,i),{validation:"url",code:it.invalid_string,message:l.message}),o.dirty()}else"regex"===l.kind?(l.regex.lastIndex=0,l.regex.test(e.data)||(ip(i=this._getOrReturnCtx(e,i),{validation:"regex",code:it.invalid_string,message:l.message}),o.dirty())):"trim"===l.kind?e.data=e.data.trim():"includes"===l.kind?e.data.includes(l.value,l.position)||(ip(i=this._getOrReturnCtx(e,i),{code:it.invalid_string,validation:{includes:l.value,position:l.position},message:l.message}),o.dirty()):"toLowerCase"===l.kind?e.data=e.data.toLowerCase():"toUpperCase"===l.kind?e.data=e.data.toUpperCase():"startsWith"===l.kind?e.data.startsWith(l.value)||(ip(i=this._getOrReturnCtx(e,i),{code:it.invalid_string,validation:{startsWith:l.value},message:l.message}),o.dirty()):"endsWith"===l.kind?e.data.endsWith(l.value)||(ip(i=this._getOrReturnCtx(e,i),{code:it.invalid_string,validation:{endsWith:l.value},message:l.message}),o.dirty()):"datetime"===l.kind?iV(l).test(e.data)||(ip(i=this._getOrReturnCtx(e,i),{code:it.invalid_string,validation:"datetime",message:l.message}),o.dirty()):"date"===l.kind?iz.test(e.data)||(ip(i=this._getOrReturnCtx(e,i),{code:it.invalid_string,validation:"date",message:l.message}),o.dirty()):"time"===l.kind?RegExp(`^${iq(l)}$`).test(e.data)||(ip(i=this._getOrReturnCtx(e,i),{code:it.invalid_string,validation:"time",message:l.message}),o.dirty()):"duration"===l.kind?iR.test(e.data)||(ip(i=this._getOrReturnCtx(e,i),{validation:"duration",code:it.invalid_string,message:l.message}),o.dirty()):"ip"===l.kind?(t=e.data,!(("v4"===(a=l.version)||!a)&&iN.test(t)||("v6"===a||!a)&&iP.test(t))&&1&&(ip(i=this._getOrReturnCtx(e,i),{validation:"ip",code:it.invalid_string,message:l.message}),o.dirty())):"jwt"===l.kind?!function(e,t){if(!iC.test(e))return!1;try{let[r]=e.split(".");if(!r)return!1;let a=r.replace(/-/g,"+").replace(/_/g,"/").padEnd(r.length+(4-r.length%4)%4,"="),s=JSON.parse(atob(a));if("object"!=typeof s||null===s||"typ"in s&&s?.typ!=="JWT"||!s.alg||t&&s.alg!==t)return!1;return!0}catch{return!1}}(e.data,l.alg)&&(ip(i=this._getOrReturnCtx(e,i),{validation:"jwt",code:it.invalid_string,message:l.message}),o.dirty()):"cidr"===l.kind?(s=e.data,!(("v4"===(n=l.version)||!n)&&ij.test(s)||("v6"===n||!n)&&i$.test(s))&&1&&(ip(i=this._getOrReturnCtx(e,i),{validation:"cidr",code:it.invalid_string,message:l.message}),o.dirty())):"base64"===l.kind?iD.test(e.data)||(ip(i=this._getOrReturnCtx(e,i),{validation:"base64",code:it.invalid_string,message:l.message}),o.dirty()):"base64url"===l.kind?iL.test(e.data)||(ip(i=this._getOrReturnCtx(e,i),{validation:"base64url",code:it.invalid_string,message:l.message}),o.dirty()):V.assertNever(l);return{status:o.value,value:e.data}}_regex(e,t,r){return this.refinement(t=>e.test(t),{validation:t,code:it.invalid_string,...Z.errToObj(r)})}_addCheck(e){return new iF({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...Z.errToObj(e)})}url(e){return this._addCheck({kind:"url",...Z.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...Z.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...Z.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...Z.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...Z.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...Z.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...Z.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...Z.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...Z.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...Z.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...Z.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...Z.errToObj(e)})}datetime(e){return"string"==typeof e?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:void 0===e?.precision?null:e?.precision,offset:e?.offset??!1,local:e?.local??!1,...Z.errToObj(e?.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return"string"==typeof e?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:void 0===e?.precision?null:e?.precision,...Z.errToObj(e?.message)})}duration(e){return this._addCheck({kind:"duration",...Z.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...Z.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t?.position,...Z.errToObj(t?.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...Z.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...Z.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...Z.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...Z.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...Z.errToObj(t)})}nonempty(e){return this.min(1,Z.errToObj(e))}trim(){return new iF({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new iF({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new iF({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>"datetime"===e.kind)}get isDate(){return!!this._def.checks.find(e=>"date"===e.kind)}get isTime(){return!!this._def.checks.find(e=>"time"===e.kind)}get isDuration(){return!!this._def.checks.find(e=>"duration"===e.kind)}get isEmail(){return!!this._def.checks.find(e=>"email"===e.kind)}get isURL(){return!!this._def.checks.find(e=>"url"===e.kind)}get isEmoji(){return!!this._def.checks.find(e=>"emoji"===e.kind)}get isUUID(){return!!this._def.checks.find(e=>"uuid"===e.kind)}get isNANOID(){return!!this._def.checks.find(e=>"nanoid"===e.kind)}get isCUID(){return!!this._def.checks.find(e=>"cuid"===e.kind)}get isCUID2(){return!!this._def.checks.find(e=>"cuid2"===e.kind)}get isULID(){return!!this._def.checks.find(e=>"ulid"===e.kind)}get isIP(){return!!this._def.checks.find(e=>"ip"===e.kind)}get isCIDR(){return!!this._def.checks.find(e=>"cidr"===e.kind)}get isBase64(){return!!this._def.checks.find(e=>"base64"===e.kind)}get isBase64url(){return!!this._def.checks.find(e=>"base64url"===e.kind)}get minLength(){let e=null;for(let t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(let t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}iF.create=e=>new iF({checks:[],typeName:W.ZodString,coerce:e?.coerce??!1,...ix(e)});class iZ extends iI{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){let t;if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==n7.number){let t=this._getOrReturnCtx(e);return ip(t,{code:it.invalid_type,expected:n7.number,received:t.parsedType}),ih}let r=new ic;for(let a of this._def.checks)"int"===a.kind?V.isInteger(e.data)||(ip(t=this._getOrReturnCtx(e,t),{code:it.invalid_type,expected:"integer",received:"float",message:a.message}),r.dirty()):"min"===a.kind?(a.inclusive?e.data<a.value:e.data<=a.value)&&(ip(t=this._getOrReturnCtx(e,t),{code:it.too_small,minimum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),r.dirty()):"max"===a.kind?(a.inclusive?e.data>a.value:e.data>=a.value)&&(ip(t=this._getOrReturnCtx(e,t),{code:it.too_big,maximum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),r.dirty()):"multipleOf"===a.kind?0!==function(e,t){let r=(e.toString().split(".")[1]||"").length,a=(t.toString().split(".")[1]||"").length,s=r>a?r:a;return Number.parseInt(e.toFixed(s).replace(".",""))%Number.parseInt(t.toFixed(s).replace(".",""))/10**s}(e.data,a.value)&&(ip(t=this._getOrReturnCtx(e,t),{code:it.not_multiple_of,multipleOf:a.value,message:a.message}),r.dirty()):"finite"===a.kind?Number.isFinite(e.data)||(ip(t=this._getOrReturnCtx(e,t),{code:it.not_finite,message:a.message}),r.dirty()):V.assertNever(a);return{status:r.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,Z.toString(t))}gt(e,t){return this.setLimit("min",e,!1,Z.toString(t))}lte(e,t){return this.setLimit("max",e,!0,Z.toString(t))}lt(e,t){return this.setLimit("max",e,!1,Z.toString(t))}setLimit(e,t,r,a){return new iZ({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:Z.toString(a)}]})}_addCheck(e){return new iZ({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:Z.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:Z.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:Z.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:Z.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:Z.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:Z.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:Z.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:Z.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:Z.toString(e)})}get minValue(){let e=null;for(let t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(let t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>"int"===e.kind||"multipleOf"===e.kind&&V.isInteger(e.value))}get isFinite(){let e=null,t=null;for(let r of this._def.checks)if("finite"===r.kind||"int"===r.kind||"multipleOf"===r.kind)return!0;else"min"===r.kind?(null===t||r.value>t)&&(t=r.value):"max"===r.kind&&(null===e||r.value<e)&&(e=r.value);return Number.isFinite(t)&&Number.isFinite(e)}}iZ.create=e=>new iZ({checks:[],typeName:W.ZodNumber,coerce:e?.coerce||!1,...ix(e)});class iW extends iI{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){let t;if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==n7.bigint)return this._getInvalidInput(e);let r=new ic;for(let a of this._def.checks)"min"===a.kind?(a.inclusive?e.data<a.value:e.data<=a.value)&&(ip(t=this._getOrReturnCtx(e,t),{code:it.too_small,type:"bigint",minimum:a.value,inclusive:a.inclusive,message:a.message}),r.dirty()):"max"===a.kind?(a.inclusive?e.data>a.value:e.data>=a.value)&&(ip(t=this._getOrReturnCtx(e,t),{code:it.too_big,type:"bigint",maximum:a.value,inclusive:a.inclusive,message:a.message}),r.dirty()):"multipleOf"===a.kind?e.data%a.value!==BigInt(0)&&(ip(t=this._getOrReturnCtx(e,t),{code:it.not_multiple_of,multipleOf:a.value,message:a.message}),r.dirty()):V.assertNever(a);return{status:r.value,value:e.data}}_getInvalidInput(e){let t=this._getOrReturnCtx(e);return ip(t,{code:it.invalid_type,expected:n7.bigint,received:t.parsedType}),ih}gte(e,t){return this.setLimit("min",e,!0,Z.toString(t))}gt(e,t){return this.setLimit("min",e,!1,Z.toString(t))}lte(e,t){return this.setLimit("max",e,!0,Z.toString(t))}lt(e,t){return this.setLimit("max",e,!1,Z.toString(t))}setLimit(e,t,r,a){return new iW({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:Z.toString(a)}]})}_addCheck(e){return new iW({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:Z.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:Z.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:Z.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:Z.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:Z.toString(t)})}get minValue(){let e=null;for(let t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(let t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}iW.create=e=>new iW({checks:[],typeName:W.ZodBigInt,coerce:e?.coerce??!1,...ix(e)});class iG extends iI{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==n7.boolean){let t=this._getOrReturnCtx(e);return ip(t,{code:it.invalid_type,expected:n7.boolean,received:t.parsedType}),ih}return ig(e.data)}}iG.create=e=>new iG({typeName:W.ZodBoolean,coerce:e?.coerce||!1,...ix(e)});class iB extends iI{_parse(e){let t;if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==n7.date){let t=this._getOrReturnCtx(e);return ip(t,{code:it.invalid_type,expected:n7.date,received:t.parsedType}),ih}if(Number.isNaN(e.data.getTime()))return ip(this._getOrReturnCtx(e),{code:it.invalid_date}),ih;let r=new ic;for(let a of this._def.checks)"min"===a.kind?e.data.getTime()<a.value&&(ip(t=this._getOrReturnCtx(e,t),{code:it.too_small,message:a.message,inclusive:!0,exact:!1,minimum:a.value,type:"date"}),r.dirty()):"max"===a.kind?e.data.getTime()>a.value&&(ip(t=this._getOrReturnCtx(e,t),{code:it.too_big,message:a.message,inclusive:!0,exact:!1,maximum:a.value,type:"date"}),r.dirty()):V.assertNever(a);return{status:r.value,value:new Date(e.data.getTime())}}_addCheck(e){return new iB({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:Z.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:Z.toString(t)})}get minDate(){let e=null;for(let t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return null!=e?new Date(e):null}get maxDate(){let e=null;for(let t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return null!=e?new Date(e):null}}iB.create=e=>new iB({checks:[],coerce:e?.coerce||!1,typeName:W.ZodDate,...ix(e)});class iK extends iI{_parse(e){if(this._getType(e)!==n7.symbol){let t=this._getOrReturnCtx(e);return ip(t,{code:it.invalid_type,expected:n7.symbol,received:t.parsedType}),ih}return ig(e.data)}}iK.create=e=>new iK({typeName:W.ZodSymbol,...ix(e)});class iJ extends iI{_parse(e){if(this._getType(e)!==n7.undefined){let t=this._getOrReturnCtx(e);return ip(t,{code:it.invalid_type,expected:n7.undefined,received:t.parsedType}),ih}return ig(e.data)}}iJ.create=e=>new iJ({typeName:W.ZodUndefined,...ix(e)});class iH extends iI{_parse(e){if(this._getType(e)!==n7.null){let t=this._getOrReturnCtx(e);return ip(t,{code:it.invalid_type,expected:n7.null,received:t.parsedType}),ih}return ig(e.data)}}iH.create=e=>new iH({typeName:W.ZodNull,...ix(e)});class iY extends iI{constructor(){super(...arguments),this._any=!0}_parse(e){return ig(e.data)}}iY.create=e=>new iY({typeName:W.ZodAny,...ix(e)});class iQ extends iI{constructor(){super(...arguments),this._unknown=!0}_parse(e){return ig(e.data)}}iQ.create=e=>new iQ({typeName:W.ZodUnknown,...ix(e)});class iX extends iI{_parse(e){let t=this._getOrReturnCtx(e);return ip(t,{code:it.invalid_type,expected:n7.never,received:t.parsedType}),ih}}iX.create=e=>new iX({typeName:W.ZodNever,...ix(e)});class i0 extends iI{_parse(e){if(this._getType(e)!==n7.undefined){let t=this._getOrReturnCtx(e);return ip(t,{code:it.invalid_type,expected:n7.void,received:t.parsedType}),ih}return ig(e.data)}}i0.create=e=>new i0({typeName:W.ZodVoid,...ix(e)});class i1 extends iI{_parse(e){let{ctx:t,status:r}=this._processInputParams(e),a=this._def;if(t.parsedType!==n7.array)return ip(t,{code:it.invalid_type,expected:n7.array,received:t.parsedType}),ih;if(null!==a.exactLength){let e=t.data.length>a.exactLength.value,s=t.data.length<a.exactLength.value;(e||s)&&(ip(t,{code:e?it.too_big:it.too_small,minimum:s?a.exactLength.value:void 0,maximum:e?a.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:a.exactLength.message}),r.dirty())}if(null!==a.minLength&&t.data.length<a.minLength.value&&(ip(t,{code:it.too_small,minimum:a.minLength.value,type:"array",inclusive:!0,exact:!1,message:a.minLength.message}),r.dirty()),null!==a.maxLength&&t.data.length>a.maxLength.value&&(ip(t,{code:it.too_big,maximum:a.maxLength.value,type:"array",inclusive:!0,exact:!1,message:a.maxLength.message}),r.dirty()),t.common.async)return Promise.all([...t.data].map((e,r)=>a.type._parseAsync(new i_(t,e,t.path,r)))).then(e=>ic.mergeArray(r,e));let s=[...t.data].map((e,r)=>a.type._parseSync(new i_(t,e,t.path,r)));return ic.mergeArray(r,s)}get element(){return this._def.type}min(e,t){return new i1({...this._def,minLength:{value:e,message:Z.toString(t)}})}max(e,t){return new i1({...this._def,maxLength:{value:e,message:Z.toString(t)}})}length(e,t){return new i1({...this._def,exactLength:{value:e,message:Z.toString(t)}})}nonempty(e){return this.min(1,e)}}i1.create=(e,t)=>new i1({type:e,minLength:null,maxLength:null,exactLength:null,typeName:W.ZodArray,...ix(t)});class i2 extends iI{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(null!==this._cached)return this._cached;let e=this._def.shape(),t=V.objectKeys(e);return this._cached={shape:e,keys:t},this._cached}_parse(e){if(this._getType(e)!==n7.object){let t=this._getOrReturnCtx(e);return ip(t,{code:it.invalid_type,expected:n7.object,received:t.parsedType}),ih}let{status:t,ctx:r}=this._processInputParams(e),{shape:a,keys:s}=this._getCached(),n=[];if(!(this._def.catchall instanceof iX&&"strip"===this._def.unknownKeys))for(let e in r.data)s.includes(e)||n.push(e);let i=[];for(let e of s){let t=a[e],s=r.data[e];i.push({key:{status:"valid",value:e},value:t._parse(new i_(r,s,r.path,e)),alwaysSet:e in r.data})}if(this._def.catchall instanceof iX){let e=this._def.unknownKeys;if("passthrough"===e)for(let e of n)i.push({key:{status:"valid",value:e},value:{status:"valid",value:r.data[e]}});else if("strict"===e)n.length>0&&(ip(r,{code:it.unrecognized_keys,keys:n}),t.dirty());else if("strip"===e);else throw Error("Internal ZodObject error: invalid unknownKeys value.")}else{let e=this._def.catchall;for(let t of n){let a=r.data[t];i.push({key:{status:"valid",value:t},value:e._parse(new i_(r,a,r.path,t)),alwaysSet:t in r.data})}}return r.common.async?Promise.resolve().then(async()=>{let e=[];for(let t of i){let r=await t.key,a=await t.value;e.push({key:r,value:a,alwaysSet:t.alwaysSet})}return e}).then(e=>ic.mergeObjectSync(t,e)):ic.mergeObjectSync(t,i)}get shape(){return this._def.shape()}strict(e){return Z.errToObj,new i2({...this._def,unknownKeys:"strict",...void 0!==e?{errorMap:(t,r)=>{let a=this._def.errorMap?.(t,r).message??r.defaultError;return"unrecognized_keys"===t.code?{message:Z.errToObj(e).message??a}:{message:a}}}:{}})}strip(){return new i2({...this._def,unknownKeys:"strip"})}passthrough(){return new i2({...this._def,unknownKeys:"passthrough"})}extend(e){return new i2({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new i2({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:W.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new i2({...this._def,catchall:e})}pick(e){let t={};for(let r of V.objectKeys(e))e[r]&&this.shape[r]&&(t[r]=this.shape[r]);return new i2({...this._def,shape:()=>t})}omit(e){let t={};for(let r of V.objectKeys(this.shape))e[r]||(t[r]=this.shape[r]);return new i2({...this._def,shape:()=>t})}deepPartial(){return function e(t){if(t instanceof i2){let r={};for(let a in t.shape){let s=t.shape[a];r[a]=ou.create(e(s))}return new i2({...t._def,shape:()=>r})}if(t instanceof i1)return new i1({...t._def,type:e(t.element)});if(t instanceof ou)return ou.create(e(t.unwrap()));if(t instanceof od)return od.create(e(t.unwrap()));if(t instanceof i6)return i6.create(t.items.map(t=>e(t)));else return t}(this)}partial(e){let t={};for(let r of V.objectKeys(this.shape)){let a=this.shape[r];e&&!e[r]?t[r]=a:t[r]=a.optional()}return new i2({...this._def,shape:()=>t})}required(e){let t={};for(let r of V.objectKeys(this.shape))if(e&&!e[r])t[r]=this.shape[r];else{let e=this.shape[r];for(;e instanceof ou;)e=e._def.innerType;t[r]=e}return new i2({...this._def,shape:()=>t})}keyof(){return os(V.objectKeys(this.shape))}}i2.create=(e,t)=>new i2({shape:()=>e,unknownKeys:"strip",catchall:iX.create(),typeName:W.ZodObject,...ix(t)}),i2.strictCreate=(e,t)=>new i2({shape:()=>e,unknownKeys:"strict",catchall:iX.create(),typeName:W.ZodObject,...ix(t)}),i2.lazycreate=(e,t)=>new i2({shape:e,unknownKeys:"strip",catchall:iX.create(),typeName:W.ZodObject,...ix(t)});class i4 extends iI{_parse(e){let{ctx:t}=this._processInputParams(e),r=this._def.options;if(t.common.async)return Promise.all(r.map(async e=>{let r={...t,common:{...t.common,issues:[]},parent:null};return{result:await e._parseAsync({data:t.data,path:t.path,parent:r}),ctx:r}})).then(function(e){for(let t of e)if("valid"===t.result.status)return t.result;for(let r of e)if("dirty"===r.result.status)return t.common.issues.push(...r.ctx.common.issues),r.result;let r=e.map(e=>new ia(e.ctx.common.issues));return ip(t,{code:it.invalid_union,unionErrors:r}),ih});{let e,a=[];for(let s of r){let r={...t,common:{...t.common,issues:[]},parent:null},n=s._parseSync({data:t.data,path:t.path,parent:r});if("valid"===n.status)return n;"dirty"!==n.status||e||(e={result:n,ctx:r}),r.common.issues.length&&a.push(r.common.issues)}if(e)return t.common.issues.push(...e.ctx.common.issues),e.result;let s=a.map(e=>new ia(e));return ip(t,{code:it.invalid_union,unionErrors:s}),ih}}get options(){return this._def.options}}i4.create=(e,t)=>new i4({options:e,typeName:W.ZodUnion,...ix(t)});let i5=e=>{if(e instanceof or)return i5(e.schema);if(e instanceof ol)return i5(e.innerType());if(e instanceof oa)return[e.value];if(e instanceof on)return e.options;if(e instanceof oi)return V.objectValues(e.enum);else if(e instanceof op)return i5(e._def.innerType);else if(e instanceof iJ)return[void 0];else if(e instanceof iH)return[null];else if(e instanceof ou)return[void 0,...i5(e.unwrap())];else if(e instanceof od)return[null,...i5(e.unwrap())];else if(e instanceof og)return i5(e.unwrap());else if(e instanceof oy)return i5(e.unwrap());else if(e instanceof oc)return i5(e._def.innerType);else return[]};class i3 extends iI{_parse(e){let{ctx:t}=this._processInputParams(e);if(t.parsedType!==n7.object)return ip(t,{code:it.invalid_type,expected:n7.object,received:t.parsedType}),ih;let r=this.discriminator,a=t.data[r],s=this.optionsMap.get(a);return s?t.common.async?s._parseAsync({data:t.data,path:t.path,parent:t}):s._parseSync({data:t.data,path:t.path,parent:t}):(ip(t,{code:it.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[r]}),ih)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,r){let a=new Map;for(let r of t){let t=i5(r.shape[e]);if(!t.length)throw Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(let s of t){if(a.has(s))throw Error(`Discriminator property ${String(e)} has duplicate value ${String(s)}`);a.set(s,r)}}return new i3({typeName:W.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:a,...ix(r)})}}class i9 extends iI{_parse(e){let{status:t,ctx:r}=this._processInputParams(e),a=(e,a)=>{if(iy(e)||iy(a))return ih;let s=function e(t,r){let a=ie(t),s=ie(r);if(t===r)return{valid:!0,data:t};if(a===n7.object&&s===n7.object){let a=V.objectKeys(r),s=V.objectKeys(t).filter(e=>-1!==a.indexOf(e)),n={...t,...r};for(let a of s){let s=e(t[a],r[a]);if(!s.valid)return{valid:!1};n[a]=s.data}return{valid:!0,data:n}}if(a===n7.array&&s===n7.array){if(t.length!==r.length)return{valid:!1};let a=[];for(let s=0;s<t.length;s++){let n=e(t[s],r[s]);if(!n.valid)return{valid:!1};a.push(n.data)}return{valid:!0,data:a}}if(a===n7.date&&s===n7.date&&+t==+r)return{valid:!0,data:t};return{valid:!1}}(e.value,a.value);return s.valid?((iv(e)||iv(a))&&t.dirty(),{status:t.value,value:s.data}):(ip(r,{code:it.invalid_intersection_types}),ih)};return r.common.async?Promise.all([this._def.left._parseAsync({data:r.data,path:r.path,parent:r}),this._def.right._parseAsync({data:r.data,path:r.path,parent:r})]).then(([e,t])=>a(e,t)):a(this._def.left._parseSync({data:r.data,path:r.path,parent:r}),this._def.right._parseSync({data:r.data,path:r.path,parent:r}))}}i9.create=(e,t,r)=>new i9({left:e,right:t,typeName:W.ZodIntersection,...ix(r)});class i6 extends iI{_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==n7.array)return ip(r,{code:it.invalid_type,expected:n7.array,received:r.parsedType}),ih;if(r.data.length<this._def.items.length)return ip(r,{code:it.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),ih;!this._def.rest&&r.data.length>this._def.items.length&&(ip(r,{code:it.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());let a=[...r.data].map((e,t)=>{let a=this._def.items[t]||this._def.rest;return a?a._parse(new i_(r,e,r.path,t)):null}).filter(e=>!!e);return r.common.async?Promise.all(a).then(e=>ic.mergeArray(t,e)):ic.mergeArray(t,a)}get items(){return this._def.items}rest(e){return new i6({...this._def,rest:e})}}i6.create=(e,t)=>{if(!Array.isArray(e))throw Error("You must pass an array of schemas to z.tuple([ ... ])");return new i6({items:e,typeName:W.ZodTuple,rest:null,...ix(t)})};class i8 extends iI{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==n7.object)return ip(r,{code:it.invalid_type,expected:n7.object,received:r.parsedType}),ih;let a=[],s=this._def.keyType,n=this._def.valueType;for(let e in r.data)a.push({key:s._parse(new i_(r,e,r.path,e)),value:n._parse(new i_(r,r.data[e],r.path,e)),alwaysSet:e in r.data});return r.common.async?ic.mergeObjectAsync(t,a):ic.mergeObjectSync(t,a)}get element(){return this._def.valueType}static create(e,t,r){return new i8(t instanceof iI?{keyType:e,valueType:t,typeName:W.ZodRecord,...ix(r)}:{keyType:iF.create(),valueType:e,typeName:W.ZodRecord,...ix(t)})}}class i7 extends iI{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==n7.map)return ip(r,{code:it.invalid_type,expected:n7.map,received:r.parsedType}),ih;let a=this._def.keyType,s=this._def.valueType,n=[...r.data.entries()].map(([e,t],n)=>({key:a._parse(new i_(r,e,r.path,[n,"key"])),value:s._parse(new i_(r,t,r.path,[n,"value"]))}));if(r.common.async){let e=new Map;return Promise.resolve().then(async()=>{for(let r of n){let a=await r.key,s=await r.value;if("aborted"===a.status||"aborted"===s.status)return ih;("dirty"===a.status||"dirty"===s.status)&&t.dirty(),e.set(a.value,s.value)}return{status:t.value,value:e}})}{let e=new Map;for(let r of n){let a=r.key,s=r.value;if("aborted"===a.status||"aborted"===s.status)return ih;("dirty"===a.status||"dirty"===s.status)&&t.dirty(),e.set(a.value,s.value)}return{status:t.value,value:e}}}}i7.create=(e,t,r)=>new i7({valueType:t,keyType:e,typeName:W.ZodMap,...ix(r)});class oe extends iI{_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==n7.set)return ip(r,{code:it.invalid_type,expected:n7.set,received:r.parsedType}),ih;let a=this._def;null!==a.minSize&&r.data.size<a.minSize.value&&(ip(r,{code:it.too_small,minimum:a.minSize.value,type:"set",inclusive:!0,exact:!1,message:a.minSize.message}),t.dirty()),null!==a.maxSize&&r.data.size>a.maxSize.value&&(ip(r,{code:it.too_big,maximum:a.maxSize.value,type:"set",inclusive:!0,exact:!1,message:a.maxSize.message}),t.dirty());let s=this._def.valueType;function n(e){let r=new Set;for(let a of e){if("aborted"===a.status)return ih;"dirty"===a.status&&t.dirty(),r.add(a.value)}return{status:t.value,value:r}}let i=[...r.data.values()].map((e,t)=>s._parse(new i_(r,e,r.path,t)));return r.common.async?Promise.all(i).then(e=>n(e)):n(i)}min(e,t){return new oe({...this._def,minSize:{value:e,message:Z.toString(t)}})}max(e,t){return new oe({...this._def,maxSize:{value:e,message:Z.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}oe.create=(e,t)=>new oe({valueType:e,minSize:null,maxSize:null,typeName:W.ZodSet,...ix(t)});class ot extends iI{constructor(){super(...arguments),this.validate=this.implement}_parse(e){let{ctx:t}=this._processInputParams(e);if(t.parsedType!==n7.function)return ip(t,{code:it.invalid_type,expected:n7.function,received:t.parsedType}),ih;function r(e,r){return iu({data:e,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,ii,is].filter(e=>!!e),issueData:{code:it.invalid_arguments,argumentsError:r}})}function a(e,r){return iu({data:e,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,ii,is].filter(e=>!!e),issueData:{code:it.invalid_return_type,returnTypeError:r}})}let s={errorMap:t.common.contextualErrorMap},n=t.data;if(this._def.returns instanceof oo){let e=this;return ig(async function(...t){let i=new ia([]),o=await e._def.args.parseAsync(t,s).catch(e=>{throw i.addIssue(r(t,e)),i}),l=await Reflect.apply(n,this,o);return await e._def.returns._def.type.parseAsync(l,s).catch(e=>{throw i.addIssue(a(l,e)),i})})}{let e=this;return ig(function(...t){let i=e._def.args.safeParse(t,s);if(!i.success)throw new ia([r(t,i.error)]);let o=Reflect.apply(n,this,i.data),l=e._def.returns.safeParse(o,s);if(!l.success)throw new ia([a(o,l.error)]);return l.data})}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new ot({...this._def,args:i6.create(e).rest(iQ.create())})}returns(e){return new ot({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,t,r){return new ot({args:e||i6.create([]).rest(iQ.create()),returns:t||iQ.create(),typeName:W.ZodFunction,...ix(r)})}}class or extends iI{get schema(){return this._def.getter()}_parse(e){let{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}or.create=(e,t)=>new or({getter:e,typeName:W.ZodLazy,...ix(t)});class oa extends iI{_parse(e){if(e.data!==this._def.value){let t=this._getOrReturnCtx(e);return ip(t,{received:t.data,code:it.invalid_literal,expected:this._def.value}),ih}return{status:"valid",value:e.data}}get value(){return this._def.value}}function os(e,t){return new on({values:e,typeName:W.ZodEnum,...ix(t)})}oa.create=(e,t)=>new oa({value:e,typeName:W.ZodLiteral,...ix(t)});class on extends iI{_parse(e){if("string"!=typeof e.data){let t=this._getOrReturnCtx(e),r=this._def.values;return ip(t,{expected:V.joinValues(r),received:t.parsedType,code:it.invalid_type}),ih}if(this._cache||(this._cache=new Set(this._def.values)),!this._cache.has(e.data)){let t=this._getOrReturnCtx(e),r=this._def.values;return ip(t,{received:t.data,code:it.invalid_enum_value,options:r}),ih}return ig(e.data)}get options(){return this._def.values}get enum(){let e={};for(let t of this._def.values)e[t]=t;return e}get Values(){let e={};for(let t of this._def.values)e[t]=t;return e}get Enum(){let e={};for(let t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return on.create(e,{...this._def,...t})}exclude(e,t=this._def){return on.create(this.options.filter(t=>!e.includes(t)),{...this._def,...t})}}on.create=os;class oi extends iI{_parse(e){let t=V.getValidEnumValues(this._def.values),r=this._getOrReturnCtx(e);if(r.parsedType!==n7.string&&r.parsedType!==n7.number){let e=V.objectValues(t);return ip(r,{expected:V.joinValues(e),received:r.parsedType,code:it.invalid_type}),ih}if(this._cache||(this._cache=new Set(V.getValidEnumValues(this._def.values))),!this._cache.has(e.data)){let e=V.objectValues(t);return ip(r,{received:r.data,code:it.invalid_enum_value,options:e}),ih}return ig(e.data)}get enum(){return this._def.values}}oi.create=(e,t)=>new oi({values:e,typeName:W.ZodNativeEnum,...ix(t)});class oo extends iI{unwrap(){return this._def.type}_parse(e){let{ctx:t}=this._processInputParams(e);return t.parsedType!==n7.promise&&!1===t.common.async?(ip(t,{code:it.invalid_type,expected:n7.promise,received:t.parsedType}),ih):ig((t.parsedType===n7.promise?t.data:Promise.resolve(t.data)).then(e=>this._def.type.parseAsync(e,{path:t.path,errorMap:t.common.contextualErrorMap})))}}oo.create=(e,t)=>new oo({type:e,typeName:W.ZodPromise,...ix(t)});class ol extends iI{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===W.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){let{status:t,ctx:r}=this._processInputParams(e),a=this._def.effect||null,s={addIssue:e=>{ip(r,e),e.fatal?t.abort():t.dirty()},get path(){return r.path}};if(s.addIssue=s.addIssue.bind(s),"preprocess"===a.type){let e=a.transform(r.data,s);if(r.common.async)return Promise.resolve(e).then(async e=>{if("aborted"===t.value)return ih;let a=await this._def.schema._parseAsync({data:e,path:r.path,parent:r});return"aborted"===a.status?ih:"dirty"===a.status||"dirty"===t.value?im(a.value):a});{if("aborted"===t.value)return ih;let a=this._def.schema._parseSync({data:e,path:r.path,parent:r});return"aborted"===a.status?ih:"dirty"===a.status||"dirty"===t.value?im(a.value):a}}if("refinement"===a.type){let e=e=>{let t=a.refinement(e,s);if(r.common.async)return Promise.resolve(t);if(t instanceof Promise)throw Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return e};if(!1!==r.common.async)return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(r=>"aborted"===r.status?ih:("dirty"===r.status&&t.dirty(),e(r.value).then(()=>({status:t.value,value:r.value}))));{let a=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});return"aborted"===a.status?ih:("dirty"===a.status&&t.dirty(),e(a.value),{status:t.value,value:a.value})}}if("transform"===a.type)if(!1!==r.common.async)return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(e=>ib(e)?Promise.resolve(a.transform(e.value,s)).then(e=>({status:t.value,value:e})):ih);else{let e=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});if(!ib(e))return ih;let n=a.transform(e.value,s);if(n instanceof Promise)throw Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:n}}V.assertNever(a)}}ol.create=(e,t,r)=>new ol({schema:e,typeName:W.ZodEffects,effect:t,...ix(r)}),ol.createWithPreprocess=(e,t,r)=>new ol({schema:t,effect:{type:"preprocess",transform:e},typeName:W.ZodEffects,...ix(r)});class ou extends iI{_parse(e){return this._getType(e)===n7.undefined?ig(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}ou.create=(e,t)=>new ou({innerType:e,typeName:W.ZodOptional,...ix(t)});class od extends iI{_parse(e){return this._getType(e)===n7.null?ig(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}od.create=(e,t)=>new od({innerType:e,typeName:W.ZodNullable,...ix(t)});class op extends iI{_parse(e){let{ctx:t}=this._processInputParams(e),r=t.data;return t.parsedType===n7.undefined&&(r=this._def.defaultValue()),this._def.innerType._parse({data:r,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}op.create=(e,t)=>new op({innerType:e,typeName:W.ZodDefault,defaultValue:"function"==typeof t.default?t.default:()=>t.default,...ix(t)});class oc extends iI{_parse(e){let{ctx:t}=this._processInputParams(e),r={...t,common:{...t.common,issues:[]}},a=this._def.innerType._parse({data:r.data,path:r.path,parent:{...r}});return iw(a)?a.then(e=>({status:"valid",value:"valid"===e.status?e.value:this._def.catchValue({get error(){return new ia(r.common.issues)},input:r.data})})):{status:"valid",value:"valid"===a.status?a.value:this._def.catchValue({get error(){return new ia(r.common.issues)},input:r.data})}}removeCatch(){return this._def.innerType}}oc.create=(e,t)=>new oc({innerType:e,typeName:W.ZodCatch,catchValue:"function"==typeof t.catch?t.catch:()=>t.catch,...ix(t)});class oh extends iI{_parse(e){if(this._getType(e)!==n7.nan){let t=this._getOrReturnCtx(e);return ip(t,{code:it.invalid_type,expected:n7.nan,received:t.parsedType}),ih}return{status:"valid",value:e.data}}}oh.create=e=>new oh({typeName:W.ZodNaN,...ix(e)});let om=Symbol("zod_brand");class og extends iI{_parse(e){let{ctx:t}=this._processInputParams(e),r=t.data;return this._def.type._parse({data:r,path:t.path,parent:t})}unwrap(){return this._def.type}}class of extends iI{_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.common.async)return(async()=>{let e=await this._def.in._parseAsync({data:r.data,path:r.path,parent:r});return"aborted"===e.status?ih:"dirty"===e.status?(t.dirty(),im(e.value)):this._def.out._parseAsync({data:e.value,path:r.path,parent:r})})();{let e=this._def.in._parseSync({data:r.data,path:r.path,parent:r});return"aborted"===e.status?ih:"dirty"===e.status?(t.dirty(),{status:"dirty",value:e.value}):this._def.out._parseSync({data:e.value,path:r.path,parent:r})}}static create(e,t){return new of({in:e,out:t,typeName:W.ZodPipeline})}}class oy extends iI{_parse(e){let t=this._def.innerType._parse(e),r=e=>(ib(e)&&(e.value=Object.freeze(e.value)),e);return iw(t)?t.then(e=>r(e)):r(t)}unwrap(){return this._def.innerType}}function ov(e,t){let r="function"==typeof e?e(t):"string"==typeof e?{message:e}:e;return"string"==typeof r?{message:r}:r}function ob(e,t={},r){return e?iY.create().superRefine((a,s)=>{let n=e(a);if(n instanceof Promise)return n.then(e=>{if(!e){let e=ov(t,a),n=e.fatal??r??!0;s.addIssue({code:"custom",...e,fatal:n})}});if(!n){let e=ov(t,a),n=e.fatal??r??!0;s.addIssue({code:"custom",...e,fatal:n})}}):iY.create()}oy.create=(e,t)=>new oy({innerType:e,typeName:W.ZodReadonly,...ix(t)});let ow={object:i2.lazycreate};(g=W||(W={})).ZodString="ZodString",g.ZodNumber="ZodNumber",g.ZodNaN="ZodNaN",g.ZodBigInt="ZodBigInt",g.ZodBoolean="ZodBoolean",g.ZodDate="ZodDate",g.ZodSymbol="ZodSymbol",g.ZodUndefined="ZodUndefined",g.ZodNull="ZodNull",g.ZodAny="ZodAny",g.ZodUnknown="ZodUnknown",g.ZodNever="ZodNever",g.ZodVoid="ZodVoid",g.ZodArray="ZodArray",g.ZodObject="ZodObject",g.ZodUnion="ZodUnion",g.ZodDiscriminatedUnion="ZodDiscriminatedUnion",g.ZodIntersection="ZodIntersection",g.ZodTuple="ZodTuple",g.ZodRecord="ZodRecord",g.ZodMap="ZodMap",g.ZodSet="ZodSet",g.ZodFunction="ZodFunction",g.ZodLazy="ZodLazy",g.ZodLiteral="ZodLiteral",g.ZodEnum="ZodEnum",g.ZodEffects="ZodEffects",g.ZodNativeEnum="ZodNativeEnum",g.ZodOptional="ZodOptional",g.ZodNullable="ZodNullable",g.ZodDefault="ZodDefault",g.ZodCatch="ZodCatch",g.ZodPromise="ZodPromise",g.ZodBranded="ZodBranded",g.ZodPipeline="ZodPipeline",g.ZodReadonly="ZodReadonly";let o_=(e,t={message:`Input not instance of ${e.name}`})=>ob(t=>t instanceof e,t),oS=iF.create,ox=iZ.create,oI=oh.create,ok=iW.create,oT=iG.create,oE=iB.create,oA=iK.create,oO=iJ.create,oC=iH.create,oR=iY.create,oM=iQ.create,oN=iX.create,oj=i0.create,oP=i1.create,o$=i2.create,oD=i2.strictCreate,oL=i4.create,oU=i3.create,oz=i9.create,oq=i6.create,oV=i8.create,oF=i7.create,oZ=oe.create,oW=ot.create,oG=or.create,oB=oa.create,oK=on.create,oJ=oi.create,oH=oo.create,oY=ol.create,oQ=ou.create,oX=od.create,o0=ol.createWithPreprocess,o1=of.create,o2=()=>oS().optional(),o4=()=>ox().optional(),o5=()=>oT().optional(),o3={string:e=>iF.create({...e,coerce:!0}),number:e=>iZ.create({...e,coerce:!0}),boolean:e=>iG.create({...e,coerce:!0}),bigint:e=>iW.create({...e,coerce:!0}),date:e=>iB.create({...e,coerce:!0})};e.s(["BRAND",0,om,"NEVER",0,ih,"Schema",()=>iI,"ZodAny",()=>iY,"ZodArray",()=>i1,"ZodBigInt",()=>iW,"ZodBoolean",()=>iG,"ZodBranded",()=>og,"ZodCatch",()=>oc,"ZodDate",()=>iB,"ZodDefault",()=>op,"ZodDiscriminatedUnion",()=>i3,"ZodEffects",()=>ol,"ZodEnum",()=>on,"ZodFirstPartyTypeKind",()=>W,"ZodFunction",()=>ot,"ZodIntersection",()=>i9,"ZodLazy",()=>or,"ZodLiteral",()=>oa,"ZodMap",()=>i7,"ZodNaN",()=>oh,"ZodNativeEnum",()=>oi,"ZodNever",()=>iX,"ZodNull",()=>iH,"ZodNullable",()=>od,"ZodNumber",()=>iZ,"ZodObject",()=>i2,"ZodOptional",()=>ou,"ZodPipeline",()=>of,"ZodPromise",()=>oo,"ZodReadonly",()=>oy,"ZodRecord",()=>i8,"ZodSchema",()=>iI,"ZodSet",()=>oe,"ZodString",()=>iF,"ZodSymbol",()=>iK,"ZodTransformer",()=>ol,"ZodTuple",()=>i6,"ZodType",()=>iI,"ZodUndefined",()=>iJ,"ZodUnion",()=>i4,"ZodUnknown",()=>iQ,"ZodVoid",()=>i0,"any",()=>oR,"array",()=>oP,"bigint",()=>ok,"boolean",()=>oT,"coerce",0,o3,"custom",()=>ob,"date",()=>oE,"datetimeRegex",()=>iV,"discriminatedUnion",()=>oU,"effect",()=>oY,"enum",()=>oK,"function",()=>oW,"instanceof",()=>o_,"intersection",()=>oz,"late",0,ow,"lazy",()=>oG,"literal",()=>oB,"map",()=>oF,"nan",()=>oI,"nativeEnum",()=>oJ,"never",()=>oN,"null",()=>oC,"nullable",()=>oX,"number",()=>ox,"object",()=>o$,"oboolean",()=>o5,"onumber",()=>o4,"optional",()=>oQ,"ostring",()=>o2,"pipeline",()=>o1,"preprocess",()=>o0,"promise",()=>oH,"record",()=>oV,"set",()=>oZ,"strictObject",()=>oD,"string",()=>oS,"symbol",()=>oA,"transformer",()=>oY,"tuple",()=>oq,"undefined",()=>oO,"union",()=>oL,"unknown",()=>oM,"void",()=>oj],784544),e.i(784544),e.i(512329),e.s(["BRAND",0,om,"DIRTY",0,im,"EMPTY_PATH",0,id,"INVALID",0,ih,"NEVER",0,ih,"OK",0,ig,"ParseStatus",()=>ic,"Schema",()=>iI,"ZodAny",()=>iY,"ZodArray",()=>i1,"ZodBigInt",()=>iW,"ZodBoolean",()=>iG,"ZodBranded",()=>og,"ZodCatch",()=>oc,"ZodDate",()=>iB,"ZodDefault",()=>op,"ZodDiscriminatedUnion",()=>i3,"ZodEffects",()=>ol,"ZodEnum",()=>on,"ZodError",()=>ia,"ZodFirstPartyTypeKind",()=>W,"ZodFunction",()=>ot,"ZodIntersection",()=>i9,"ZodIssueCode",0,it,"ZodLazy",()=>or,"ZodLiteral",()=>oa,"ZodMap",()=>i7,"ZodNaN",()=>oh,"ZodNativeEnum",()=>oi,"ZodNever",()=>iX,"ZodNull",()=>iH,"ZodNullable",()=>od,"ZodNumber",()=>iZ,"ZodObject",()=>i2,"ZodOptional",()=>ou,"ZodParsedType",0,n7,"ZodPipeline",()=>of,"ZodPromise",()=>oo,"ZodReadonly",()=>oy,"ZodRecord",()=>i8,"ZodSchema",()=>iI,"ZodSet",()=>oe,"ZodString",()=>iF,"ZodSymbol",()=>iK,"ZodTransformer",()=>ol,"ZodTuple",()=>i6,"ZodType",()=>iI,"ZodUndefined",()=>iJ,"ZodUnion",()=>i4,"ZodUnknown",()=>iQ,"ZodVoid",()=>i0,"addIssueToContext",()=>ip,"any",()=>oR,"array",()=>oP,"bigint",()=>ok,"boolean",()=>oT,"coerce",0,o3,"custom",()=>ob,"date",()=>oE,"datetimeRegex",()=>iV,"defaultErrorMap",0,is,"discriminatedUnion",()=>oU,"effect",()=>oY,"enum",()=>oK,"function",()=>oW,"getErrorMap",()=>il,"getParsedType",0,ie,"instanceof",()=>o_,"intersection",()=>oz,"isAborted",0,iy,"isAsync",0,iw,"isDirty",0,iv,"isValid",0,ib,"late",0,ow,"lazy",()=>oG,"literal",()=>oB,"makeIssue",0,iu,"map",()=>oF,"nan",()=>oI,"nativeEnum",()=>oJ,"never",()=>oN,"null",()=>oC,"nullable",()=>oX,"number",()=>ox,"object",()=>o$,"objectUtil",()=>F,"oboolean",()=>o5,"onumber",()=>o4,"optional",()=>oQ,"ostring",()=>o2,"pipeline",()=>o1,"preprocess",()=>o0,"promise",()=>oH,"quotelessJson",0,ir,"record",()=>oV,"set",()=>oZ,"setErrorMap",()=>io,"strictObject",()=>oD,"string",()=>oS,"symbol",()=>oA,"transformer",()=>oY,"tuple",()=>oq,"undefined",()=>oO,"union",()=>oL,"unknown",()=>oM,"util",()=>V,"void",()=>oj],967884);var o9=e.i(967884),o9=o9,nS=n_;function o6(e,t="jsonSchema7"){return nb(sG(e,t),{validate:t=>{let r=e.safeParse(t);return r.success?{success:!0,value:r.data}:{success:!1,error:r.error}}})}function o8(e){return"object"==typeof e&&null!==e&&"_def"in e&&"parse"in e&&"function"==typeof e.parse&&"safeParse"in e&&"function"==typeof e.safeParse}function o7({schema:e,compatLayers:t,mode:r}){let a;for(let s of(a=o8(e)?e:function(e){if(o8(e))return e;{let t="jsonSchema"in e?e.jsonSchema:e;try{if("toJSONSchema"in rb.z)return n8(t);return function e(t){function r(e,t){return t.description&&(e=e.describe(t.description)),e}if(void 0!==t.const){if("string"==typeof t.const);else if("number"==typeof t.const);else if("boolean"==typeof t.const);else if(null===t.const)return r(o9.null(),t);return r(o9.literal(t.const),t)}if(t.type)switch(t.type){case"string":{if(t.enum){if(0===t.enum.length)return r(o9.string(),t);return r(o9.enum(t.enum),t)}let e=o9.string();if(void 0!==t.minLength&&(e=e.min(t.minLength)),void 0!==t.maxLength&&(e=e.max(t.maxLength)),void 0!==t.pattern){let r=new RegExp(t.pattern);e=e.regex(r)}return r(e,t)}case"number":case"integer":{if(t.enum){if(0===t.enum.length)return r(o9.number(),t);let e=t.enum.map(e=>o9.literal(e));if(1===e.length)return r(e[0],t);if(e.length>=2)return r(o9.union([e[0],e[1],...e.slice(2)]),t)}let e="integer"===t.type?o9.number().int():o9.number();return void 0!==t.minimum&&(e=e.min(t.minimum)),void 0!==t.maximum&&(e=e.max(t.maximum)),void 0!==t.exclusiveMinimum&&(e=e.gt(t.exclusiveMinimum)),void 0!==t.exclusiveMaximum&&(e=e.lt(t.exclusiveMaximum)),void 0!==t.multipleOf&&(e=e.multipleOf(t.multipleOf)),r(e,t)}case"boolean":if(t.enum){if(0===t.enum.length)return r(o9.boolean(),t);let e=t.enum.map(e=>o9.literal(e));if(1===e.length)return r(e[0],t);if(e.length>=2)return r(o9.union([e[0],e[1],...e.slice(2)]),t)}return r(o9.boolean(),t);case"null":return r(o9.null(),t);case"object":if(t.properties){let a={};for(let[r,s]of Object.entries(t.properties))a[r]=e(s);if(t.required&&Array.isArray(t.required)){let e=new Set(t.required);for(let t of Object.keys(a))e.has(t)||(a[t]=a[t].optional())}else for(let e of Object.keys(a))a[e]=a[e].optional();return r(!1!==t.additionalProperties?o9.object(a).passthrough():o9.object(a),t)}return r(o9.object({}),t);case"array":{let a;return a=t.items?o9.array(e(t.items)):o9.array(o9.any()),void 0!==t.minItems&&(a=a.min(t.minItems)),void 0!==t.maxItems&&(a=a.max(t.maxItems)),!0===t.uniqueItems&&(a=a.refine(e=>{let t=new Set;return e.every(e=>{if("string"==typeof e||"number"==typeof e||"boolean"==typeof e)return!t.has(e)&&(t.add(e),!0);let r=JSON.stringify(e);return!t.has(r)&&(t.add(r),!0)})},{message:"Array items must be unique"})),r(a,t)}}if(t.enum){if(0===t.enum.length)return r(o9.never(),t);if(t.enum.every(e=>"string"==typeof e))return r(o9.enum(t.enum),t);{let e=t.enum.map(e=>o9.literal(e));if(1===e.length)return r(e[0],t);if(e.length>=2)return r(o9.union([e[0],e[1],...e.slice(2)]),t)}}if(t.anyOf&&t.anyOf.length>=2){let a=t.anyOf.map(e);return r(o9.union([a[0],a[1],...a.slice(2)]),t)}if(t.allOf)return r(t.allOf.reduce((t,r)=>o9.intersection(t,e(r)),o9.object({})),t);if(t.oneOf&&t.oneOf.length>=2){let a=t.oneOf.map(e);return r(o9.union([a[0],a[1],...a.slice(2)]),t)}return r(o9.any(),t)}(t)}catch(r){let e=`[Schema Builder] Failed to convert schema parameters to Zod. Original schema: ${JSON.stringify(t)}`;throw console.error(e,r),Error(e+(r instanceof Error?`
${r.stack}`:"\nUnknown error object"))}}}(e),t))if(s.shouldApply())return"jsonSchema"===r?s.processToJSONSchema(a):s.processToAISDKSchema(a);return"jsonSchema"===r?sG(a,"jsonSchema7"):o6(a)}var le=["regex","emoji","email","url","uuid","cuid","min","max"],lt=["min","max","multipleOf"],lr=["min","max","length"],la=["ZodIntersection","ZodNever","ZodNull","ZodTuple","ZodUndefined"],ls=["ZodObject","ZodArray","ZodUnion","ZodString","ZodNumber","ZodDate","ZodAny","ZodDefault"];[...ls,...la];var ln=class{model;parent;constructor(e,t){this.model=e,this.parent=t}getModel(){return this.model}getUnsupportedZodTypes(){return la}isOptional(e){return e instanceof sB.ZodOptional}isObj(e){return e instanceof sB.ZodObject}isNull(e){return e instanceof sB.ZodNull}isArr(e){return e instanceof sB.ZodArray}isUnion(e){return e instanceof sB.ZodUnion}isString(e){return e instanceof sB.ZodString}isNumber(e){return e instanceof sB.ZodNumber}isDate(e){return e instanceof sB.ZodDate}isDefault(e){return e instanceof sB.ZodDefault}shouldApply(){return this.parent.shouldApply()}getSchemaTarget(){return this.parent.getSchemaTarget()}processZodType(e){return this.parent.processZodType(e)}defaultZodObjectHandler(e,t={passthrough:!0}){let r=Object.entries(e.shape).reduce((e,[t,r])=>(e[t]=this.processZodType(r),e),{}),a=rb.z.object(r);return"strict"===e._def.unknownKeys&&(a=a.strict()),!e._def.catchall||e._def.catchall instanceof rb.z.ZodNever||(a=a.catchall(e._def.catchall)),e.description&&(a=a.describe(e.description)),t.passthrough&&"passthrough"===e._def.unknownKeys&&(a=a.passthrough()),a}mergeParameterDescription(e,t){return Object.keys(t).length>0?(e?e+"\n":"")+JSON.stringify(t):e}defaultUnsupportedZodTypeHandler(e,t=la){if(t.includes(e._def?.typeName))throw Error(`${this.model.modelId} does not support zod type: ${e._def?.typeName}`);return e}defaultZodArrayHandler(e,t=lr){let r=e._def,a=this.processZodType(r.type),s=rb.z.array(a),n={};r.minLength?.value!==void 0&&(t.includes("min")?n.minLength=r.minLength.value:s=s.min(r.minLength.value)),r.maxLength?.value!==void 0&&(t.includes("max")?n.maxLength=r.maxLength.value:s=s.max(r.maxLength.value)),r.exactLength?.value!==void 0&&(t.includes("length")?n.exactLength=r.exactLength.value:s=s.length(r.exactLength.value));let i=this.mergeParameterDescription(e.description,n);return i&&(s=s.describe(i)),s}defaultZodUnionHandler(e){let t=e._def.options.map(e=>this.processZodType(e));if(t.length<2)throw Error("Union must have at least 2 options");let r=rb.z.union(t);return e.description&&(r=r.describe(e.description)),r}defaultZodStringHandler(e,t=le){let r={},a=e._def.checks||[],s=[];for(let e of a)if("kind"in e)if(t.includes(e.kind))switch(e.kind){case"regex":r.regex={pattern:e.regex.source,flags:e.regex.flags};break;case"emoji":r.emoji=!0;break;case"email":r.email=!0;break;case"url":r.url=!0;break;case"uuid":r.uuid=!0;break;case"cuid":r.cuid=!0;break;case"min":r.minLength=e.value;break;case"max":r.maxLength=e.value}else s.push(e);let n=rb.z.string();for(let e of s)n=n._addCheck(e);let i=this.mergeParameterDescription(e.description,r);return i&&(n=n.describe(i)),n}defaultZodNumberHandler(e,t=lt){let r={},a=e._def.checks||[],s=[];for(let e of a)if("kind"in e)if(t.includes(e.kind))switch(e.kind){case"min":e.inclusive?r.gte=e.value:r.gt=e.value;break;case"max":e.inclusive?r.lte=e.value:r.lt=e.value;break;case"multipleOf":r.multipleOf=e.value}else s.push(e);let n=rb.z.number();for(let e of s)switch(e.kind){case"int":n=n.int();break;case"finite":n=n.finite();break;default:n=n._addCheck(e)}let i=this.mergeParameterDescription(e.description,r);return i&&(n=n.describe(i)),n}defaultZodDateHandler(e){let t={};for(let r of e._def.checks||[])if("kind"in r)switch(r.kind){case"min":let e=new Date(r.value);isNaN(e.getTime())||(t.minDate=e.toISOString());break;case"max":let a=new Date(r.value);isNaN(a.getTime())||(t.maxDate=a.toISOString())}t.dateFormat="date-time";let r=rb.z.string().describe("date-time"),a=this.mergeParameterDescription(e.description,t);return a&&(r=r.describe(a)),r}defaultZodOptionalHandler(e,t=ls){return t.includes(e._def.innerType._def.typeName)?this.processZodType(e._def.innerType).optional():e}processToAISDKSchema(e){return o6(this.processZodType(e),this.getSchemaTarget())}processToJSONSchema(e){return this.processToAISDKSchema(e).jsonSchema}},li=["regex","emoji","email","url","uuid","cuid","min_length","max_length","string_format"],lo=["greater_than","less_than","multiple_of"],ll=["min","max","length"],lu=["ZodIntersection","ZodNever","ZodNull","ZodTuple","ZodUndefined"],ld=["ZodObject","ZodArray","ZodUnion","ZodString","ZodNumber","ZodDate","ZodAny","ZodDefault"],lp=class{model;parent;constructor(e,t){this.model=e,this.parent=t}getModel(){return this.model}getUnsupportedZodTypes(){return lu}isOptional(e){return e instanceof sB.ZodOptional}isObj(e){return e instanceof sB.ZodObject}isNull(e){return e instanceof sB.ZodNull}isArr(e){return e instanceof sB.ZodArray}isUnion(e){return e instanceof sB.ZodUnion}isString(e){return e instanceof sB.ZodString}isNumber(e){return e instanceof sB.ZodNumber}isDate(e){return e instanceof sB.ZodDate}isDefault(e){return e instanceof sB.ZodDefault}shouldApply(){return this.parent.shouldApply()}getSchemaTarget(){return this.parent.getSchemaTarget()}processZodType(e){return this.parent.processZodType(e)}defaultZodObjectHandler(e,t={passthrough:!0}){let r=Object.entries(e.shape).reduce((e,[t,r])=>(e[t]=this.processZodType(r),e),{}),a=nS.object(r);return e._zod.def.catchall instanceof nS.ZodNever&&(a=nS.strictObject(r)),!e._zod.def.catchall||e._zod.def.catchall instanceof nS.ZodNever||(a=a.catchall(e._zod.def.catchall)),e.description&&(a=a.describe(e.description)),t.passthrough&&e._zod.def.catchall instanceof nS.ZodUnknown&&(a=nS.looseObject(r)),a}mergeParameterDescription(e,t){return Object.keys(t).length>0?(e?e+"\n":"")+JSON.stringify(t):e}defaultUnsupportedZodTypeHandler(e,t=lu){if(t.includes(e.constructor.name))throw Error(`${this.model.modelId} does not support zod type: ${e.constructor.name}`);return e}defaultZodArrayHandler(e,t=ll){let r=e._zod.def,a=this.processZodType(r.element),s=nS.array(a),n={};if(r.checks)for(let e of r.checks)"min_length"===e._zod.def.check&&(t.includes("min")?n.minLength=e._zod.def.minimum:s=s.min(e._zod.def.minimum)),"max_length"===e._zod.def.check&&(t.includes("max")?n.maxLength=e._zod.def.maximum:s=s.max(e._zod.def.maximum)),"length_equals"===e._zod.def.check&&(t.includes("length")?n.exactLength=e._zod.def.length:s=s.length(e._zod.def.length));let i=e.meta()?.description,o=e.description,l=this.mergeParameterDescription(i||o,n);return l&&(s=s.describe(l)),s}defaultZodUnionHandler(e){let t=e._zod.def.options.map(e=>this.processZodType(e));if(t.length<2)throw Error("Union must have at least 2 options");let r=nS.union(t);return e.description&&(r=r.describe(e.description)),r}defaultZodStringHandler(e,t=li){let r={},a=e._zod.def.checks||[],s=[];for(let e of a)if(t.includes(e._zod.def.check))switch(e._zod.def.check){case"min_length":r.minLength=e._zod.def.minimum;break;case"max_length":r.maxLength=e._zod.def.maximum;break;case"string_format":switch(e._zod.def.format){case"email":r.email=!0;break;case"url":r.url=!0;break;case"emoji":r.emoji=!0;break;case"uuid":r.uuid=!0;break;case"cuid":r.cuid=!0;break;case"regex":r.regex={pattern:e._zod.def.pattern,flags:e._zod.def.flags}}}else s.push(e);let n=nS.string();for(let e of s)n=n.check(e);let i=e.meta()?.description,o=e.description,l=this.mergeParameterDescription(i||o,r);return l&&(n=n.describe(l)),n}defaultZodNumberHandler(e,t=lo){let r={},a=e._zod.def.checks||[],s=[];for(let e of a)if(t.includes(e._zod.def.check))switch(e._zod.def.check){case"greater_than":e._zod.def.inclusive?r.gte=e._zod.def.value:r.gt=e._zod.def.value;break;case"less_than":e._zod.def.inclusive?r.lte=e._zod.def.value:r.lt=e._zod.def.value;break;case"multiple_of":r.multipleOf=e._zod.def.value}else s.push(e);let n=nS.number();for(let e of s)"number_format"===e._zod.def.check?"safeint"===e._zod.def.format&&(n=n.int()):n=n.check(e);let i=this.mergeParameterDescription(e.description,r);return i&&(n=n.describe(i)),n}defaultZodDateHandler(e){let t={};for(let r of e._zod.def.checks||[])switch(r._zod.def.check){case"less_than":let e=new Date(r._zod.def.value);isNaN(e.getTime())||(t.minDate=e.toISOString());break;case"greater_than":let a=new Date(r._zod.def.value);isNaN(a.getTime())||(t.maxDate=a.toISOString())}t.dateFormat="date-time";let r=nS.string().describe("date-time"),a=this.mergeParameterDescription(e.description,t);return a&&(r=r.describe(a)),r}defaultZodOptionalHandler(e,t=ld){return t.includes(e.constructor.name)?this.processZodType(e._zod.def.innerType).optional():e}processToAISDKSchema(e){return o6(this.processZodType(e),this.getSchemaTarget())}processToJSONSchema(e){return this.processToAISDKSchema(e).jsonSchema}},lc=class{model;v3Layer;v4Layer;constructor(e){this.model=e,this.v3Layer=new ln(e,this),this.v4Layer=new lp(e,this)}getModel(){return this.model}getUnsupportedZodTypes(e){return"_zod"in e?this.v4Layer.getUnsupportedZodTypes():this.v3Layer.getUnsupportedZodTypes()}isOptional(e){return"_zod"in e?this.v4Layer.isOptional(e):this.v3Layer.isOptional(e)}isObj(e){return"_zod"in e?this.v4Layer.isObj(e):this.v3Layer.isObj(e)}isNull(e){return"_zod"in e?this.v4Layer.isNull(e):this.v3Layer.isNull(e)}isArr(e){return"_zod"in e?this.v4Layer.isArr(e):this.v3Layer.isArr(e)}isUnion(e){return"_zod"in e?this.v4Layer.isUnion(e):this.v3Layer.isUnion(e)}isString(e){return"_zod"in e?this.v4Layer.isString(e):this.v3Layer.isString(e)}isNumber(e){return"_zod"in e?this.v4Layer.isNumber(e):this.v3Layer.isNumber(e)}isDate(e){return"_zod"in e?this.v4Layer.isDate(e):this.v3Layer.isDate(e)}isDefault(e){return"_zod"in e?this.v4Layer.isDefault(e):this.v3Layer.isDefault(e)}defaultZodObjectHandler(e,t={passthrough:!0}){return"_zod"in e?this.v4Layer.defaultZodObjectHandler(e,t):this.v3Layer.defaultZodObjectHandler(e,t)}mergeParameterDescription(e,t){return this.v3Layer.mergeParameterDescription(e,t)}defaultUnsupportedZodTypeHandler(e,t){return"_zod"in e?this.v4Layer.defaultUnsupportedZodTypeHandler(e,t??lu):this.v3Layer.defaultUnsupportedZodTypeHandler(e,t??la)}defaultZodArrayHandler(e,t=lr){return"_zod"in e?this.v4Layer.defaultZodArrayHandler(e,t):this.v3Layer.defaultZodArrayHandler(e,t)}defaultZodUnionHandler(e){return"_zod"in e?this.v4Layer.defaultZodUnionHandler(e):this.v3Layer.defaultZodUnionHandler(e)}defaultZodStringHandler(e,t=le){return"_zod"in e?this.v4Layer.defaultZodStringHandler(e):this.v3Layer.defaultZodStringHandler(e,t)}defaultZodNumberHandler(e,t=lt){return"_zod"in e?this.v4Layer.defaultZodNumberHandler(e):this.v3Layer.defaultZodNumberHandler(e,t)}defaultZodDateHandler(e){return"_zod"in e?this.v4Layer.defaultZodDateHandler(e):this.v3Layer.defaultZodDateHandler(e)}defaultZodOptionalHandler(e,t){return"_zod"in e?this.v4Layer.defaultZodOptionalHandler(e,t??ld):this.v3Layer.defaultZodOptionalHandler(e,t??ls)}processToAISDKSchema(e){return o6(this.processZodType(e),this.getSchemaTarget())}processToJSONSchema(e){return this.processToAISDKSchema(e).jsonSchema}};function lh(e){return t=>t instanceof e.ZodOptional}function lm(e){return t=>t instanceof e.ZodObject}function lg(e){return t=>t instanceof e.ZodArray}function lf(e){return t=>t instanceof e.ZodUnion}function ly(e){return t=>t instanceof e.ZodString}function lv(e){return t=>t instanceof e.ZodNumber}var lb=class extends lc{constructor(e){super(e)}getSchemaTarget(){return"jsonSchema7"}shouldApply(){return this.getModel().modelId.includes("claude")}processZodType(e){if(lh(rb.z)(e)){let t=["ZodObject","ZodArray","ZodUnion","ZodNever","ZodUndefined","ZodTuple"];return this.getModel().modelId.includes("claude-3.5-haiku")&&t.push("ZodString"),this.defaultZodOptionalHandler(e,t)}if(lm(rb.z)(e))return this.defaultZodObjectHandler(e);if(lg(rb.z)(e))return this.defaultZodArrayHandler(e,[]);if(lf(rb.z)(e))return this.defaultZodUnionHandler(e);if(ly(rb.z)(e))if(this.getModel().modelId.includes("claude-3.5-haiku"))return this.defaultZodStringHandler(e,["max","min"]);else return e;return this.defaultUnsupportedZodTypeHandler(e,["ZodNever","ZodTuple","ZodUndefined"])}},lw=class extends lc{constructor(e){super(e)}getSchemaTarget(){return"jsonSchema7"}shouldApply(){return this.getModel().modelId.includes("deepseek")&&!this.getModel().modelId.includes("r1")}processZodType(e){if(lh(rb.z)(e))return this.defaultZodOptionalHandler(e,["ZodObject","ZodArray","ZodUnion","ZodString","ZodNumber"]);if(lm(rb.z)(e))return this.defaultZodObjectHandler(e);if(lg(rb.z)(e))return this.defaultZodArrayHandler(e,["min","max"]);if(lf(rb.z)(e))return this.defaultZodUnionHandler(e);if(ly(rb.z)(e))return this.defaultZodStringHandler(e);return e}},l_=class extends lc{constructor(e){super(e)}getSchemaTarget(){return"jsonSchema7"}shouldApply(){return this.getModel().provider.includes("google")||this.getModel().modelId.includes("google")}processZodType(e){var t;if(lh(rb.z)(e))return this.defaultZodOptionalHandler(e,["ZodObject","ZodArray","ZodUnion","ZodString","ZodNumber"]);if((t=rb.z,e=>e instanceof t.ZodNull)(e))return rb.z.any().refine(e=>null===e,{message:"must be null"}).describe(e.description||"must be null");if(lm(rb.z)(e))return this.defaultZodObjectHandler(e);if(lg(rb.z)(e))return this.defaultZodArrayHandler(e,[]);else if(lf(rb.z)(e))return this.defaultZodUnionHandler(e);else if(ly(rb.z)(e))return this.defaultZodStringHandler(e);else if(lv(rb.z)(e))return this.defaultZodNumberHandler(e);return this.defaultUnsupportedZodTypeHandler(e)}},lS=class extends lc{constructor(e){super(e)}getSchemaTarget(){return"jsonSchema7"}shouldApply(){return this.getModel().modelId.includes("meta")}processZodType(e){if(lh(rb.z)(e))return this.defaultZodOptionalHandler(e,["ZodObject","ZodArray","ZodUnion","ZodString","ZodNumber"]);if(lm(rb.z)(e))return this.defaultZodObjectHandler(e);if(lg(rb.z)(e))return this.defaultZodArrayHandler(e,["min","max"]);if(lf(rb.z)(e))return this.defaultZodUnionHandler(e);if(lv(rb.z)(e))return this.defaultZodNumberHandler(e);else if(ly(rb.z)(e))return this.defaultZodStringHandler(e);return e}},lx=class extends lc{constructor(e){super(e)}getSchemaTarget(){return"jsonSchema7"}shouldApply(){return!!(!this.getModel().supportsStructuredOutputs&&(this.getModel().provider.includes("openai")||this.getModel().modelId.includes("openai")))}processZodType(e){if(lh(rb.z)(e))return this.defaultZodOptionalHandler(e,["ZodObject","ZodArray","ZodUnion","ZodString","ZodNever","ZodUndefined","ZodTuple"]);if(lm(rb.z)(e))return this.defaultZodObjectHandler(e);if(lf(rb.z)(e))return this.defaultZodUnionHandler(e);if(lg(rb.z)(e))return this.defaultZodArrayHandler(e);if(ly(rb.z)(e))return this.getModel().modelId.includes("gpt-4o-mini")?this.defaultZodStringHandler(e,["emoji","regex"]):this.defaultZodStringHandler(e,["emoji"]);return this.defaultUnsupportedZodTypeHandler(e,["ZodNever","ZodUndefined","ZodTuple"])}},lI=class extends lc{constructor(e){super(e)}getSchemaTarget(){return"openApi3"}isReasoningModel(){return this.getModel().modelId.includes("o3")||this.getModel().modelId.includes("o4")||this.getModel().modelId.includes("o1")}shouldApply(){return!!((this.getModel().supportsStructuredOutputs||this.isReasoningModel())&&(this.getModel().provider.includes("openai")||this.getModel().modelId.includes("openai")))}processZodType(e){var t,r;if(lh(rb.z)(e))return this.processZodType(e._def.innerType).nullable();if(lm(rb.z)(e))return this.defaultZodObjectHandler(e,{passthrough:!1});if(lg(rb.z)(e))return this.defaultZodArrayHandler(e);if(lf(rb.z)(e))return this.defaultZodUnionHandler(e);if((t=rb.z,e=>e instanceof t.ZodDefault)(e)){let t=e._def,r=t.innerType,a="function"==typeof t.defaultValue?t.defaultValue():t.defaultValue,s={};void 0!==a&&(s.defaultValue=a);let n=this.mergeParameterDescription(e.description,s),i=this.processZodType(r);return n&&(i=i.describe(n)),i}if(lv(rb.z)(e))return this.defaultZodNumberHandler(e);if(ly(rb.z)(e))return this.defaultZodStringHandler(e);if((r=rb.z,e=>e instanceof r.ZodDate)(e))return this.defaultZodDateHandler(e);if("ZodAny"===e.constructor.name)return rb.z.string().describe((e.description??"")+`
Argument was an "any" type, but you (the LLM) do not support "any", so it was cast to a "string" type`);return this.defaultUnsupportedZodTypeHandler(e)}},lk=((f=lk||{}).AGENT_RUN="agent_run",f.GENERIC="generic",f.LLM_GENERATION="llm_generation",f.LLM_CHUNK="llm_chunk",f.MCP_TOOL_CALL="mcp_tool_call",f.TOOL_CALL="tool_call",f.WORKFLOW_RUN="workflow_run",f.WORKFLOW_STEP="workflow_step",f.WORKFLOW_CONDITIONAL="workflow_conditional",f.WORKFLOW_CONDITIONAL_EVAL="workflow_conditional_eval",f.WORKFLOW_PARALLEL="workflow_parallel",f.WORKFLOW_LOOP="workflow_loop",f.WORKFLOW_SLEEP="workflow_sleep",f.WORKFLOW_WAIT_EVENT="workflow_wait_event",f),lT=((y=lT||{})[y.NONE=0]="NONE",y[y.WORKFLOW=1]="WORKFLOW",y[y.AGENT=2]="AGENT",y[y.TOOL=4]="TOOL",y[y.LLM=8]="LLM",y[y.ALL=15]="ALL",y),lE=((v=lE||{}).ALWAYS="always",v.NEVER="never",v.RATIO="ratio",v.CUSTOM="custom",v),lA=((b=lA||{}).SPAN_STARTED="span_started",b.SPAN_UPDATED="span_updated",b.SPAN_ENDED="span_ended",b),lO=class{name;type;attributes;parent;startTime;endTime;isEvent;isInternal;aiTracing;input;output;errorInfo;metadata;constructor(e,t){this.name=e.name,this.type=e.type,this.attributes=lR(e.attributes)||{},this.metadata=lR(e.metadata),this.parent=e.parent,this.startTime=new Date,this.aiTracing=t,this.isEvent=e.isEvent??!1,this.isInternal=function(e,t){if(void 0===t||0===t)return!1;switch(e){case"workflow_run":case"workflow_step":case"workflow_conditional":case"workflow_conditional_eval":case"workflow_parallel":case"workflow_loop":case"workflow_sleep":case"workflow_wait_event":return(1&t)!=0;case"agent_run":return(2&t)!=0;case"tool_call":case"mcp_tool_call":return(4&t)!=0;case"llm_generation":case"llm_chunk":return(8&t)!=0;default:return!1}}(this.type,e.tracingPolicy?.internal),this.isEvent?this.output=lR(e.output):this.input=lR(e.input)}createChildSpan(e){return this.aiTracing.startSpan({...e,parent:this,isEvent:!1})}createEventSpan(e){return this.aiTracing.startSpan({...e,parent:this,isEvent:!0})}get isRootSpan(){return!this.parent}getParentSpanId(e){if(this.parent)return e?this.parent.id:this.parent.isInternal?this.parent.getParentSpanId(e):this.parent.id}exportSpan(e){return{id:this.id,traceId:this.traceId,name:this.name,type:this.type,attributes:this.attributes,metadata:this.metadata,startTime:this.startTime,endTime:this.endTime,input:this.input,output:this.output,errorInfo:this.errorInfo,isEvent:this.isEvent,isRootSpan:this.isRootSpan,parentSpanId:this.getParentSpanId(e)}}},lC=new Set(["logger","experimental_providerMetadata","providerMetadata","steps","tracingContext"]);function lR(e,t={},r=new WeakSet,a=0){let{keysToStrip:s=lC,maxDepth:n=10}=t;if(a>n)return"[MaxDepth]";if(null===e||"object"!=typeof e)try{return JSON.stringify(e),e}catch(e){return`[${e instanceof Error?e.message:String(e)}]`}if(r.has(e))return"[Circular]";if(r.add(e),Array.isArray(e))return e.map(e=>lR(e,t,r,a+1));let i={};for(let[n,o]of Object.entries(e))if(!s.has(n))try{i[n]=lR(o,t,r,a+1)}catch(e){i[n]=`[${e instanceof Error?e.message:String(e)}]`}return i}var lM=class extends lO{id;traceId;constructor(e,t){super(e,t),this.id=function(){let e=new Uint8Array(8);if("undefined"!=typeof crypto&&crypto.getRandomValues)crypto.getRandomValues(e);else for(let t=0;t<8;t++)e[t]=Math.floor(256*Math.random());return Array.from(e,e=>e.toString(16).padStart(2,"0")).join("")}(),e.parent?this.traceId=e.parent.traceId:this.traceId=function(){let e=new Uint8Array(16);if("undefined"!=typeof crypto&&crypto.getRandomValues)crypto.getRandomValues(e);else for(let t=0;t<16;t++)e[t]=Math.floor(256*Math.random());return Array.from(e,e=>e.toString(16).padStart(2,"0")).join("")}()}end(e){!this.isEvent&&(this.endTime=new Date,e?.output!==void 0&&(this.output=lR(e.output)),e?.attributes&&(this.attributes={...this.attributes,...lR(e.attributes)}),e?.metadata&&(this.metadata={...this.metadata,...lR(e.metadata)}))}error(e){if(this.isEvent)return;let{error:t,endSpan:r=!0,attributes:a,metadata:s}=e;this.errorInfo=t instanceof tv?{id:t.id,details:t.details,category:t.category,domain:t.domain,message:t.message}:{message:t.message},a&&(this.attributes={...this.attributes,...lR(a)}),s&&(this.metadata={...this.metadata,...lR(s)}),r?this.end():this.update({})}update(e){!this.isEvent&&(void 0!==e.input&&(this.input=lR(e.input)),void 0!==e.output&&(this.output=lR(e.output)),e.attributes&&(this.attributes={...this.attributes,...lR(e.attributes)}),e.metadata&&(this.metadata={...this.metadata,...lR(e.metadata)}))}get isValid(){return!0}async export(){return JSON.stringify({spanId:this.id,traceId:this.traceId,startTime:this.startTime,endTime:this.endTime,attributes:this.attributes,metadata:this.metadata})}},lN=class extends lO{id;traceId;constructor(e,t){super(e,t),this.id="no-op",this.traceId="no-op-trace"}end(e){}error(e){}update(e){}get isValid(){return!1}},lj=class extends tD{config;constructor(e){super({component:"AI_TRACING",name:e.serviceName}),this.config={serviceName:e.serviceName,name:e.name,sampling:e.sampling??{type:"always"},exporters:e.exporters??[],processors:e.processors??[],includeInternalSpans:e.includeInternalSpans??!1}}__setLogger(e){super.__setLogger(e),this.logger.debug(`[AI Tracing] Initialized [service=${this.config.serviceName}] [instance=${this.config.name}] [sampling=${this.config.sampling.type}]`)}get exporters(){return this.config.exporters||[]}get processors(){return this.config.processors||[]}startSpan(e){let{customSamplerOptions:t,...r}=e;if(!this.shouldSample(t))return new lN(r,this);let a=this.createSpan(r);return a.isEvent?this.emitSpanEnded(a):(this.wireSpanLifecycle(a),this.emitSpanStarted(a)),a}getConfig(){return{...this.config}}getExporters(){return[...this.exporters]}getProcessors(){return[...this.processors]}getLogger(){return this.logger}wireSpanLifecycle(e){if(!this.config.includeInternalSpans&&e.isInternal)return;let t=e.end.bind(e),r=e.update.bind(e);e.end=r=>{e.isEvent?this.logger.warn("End event is not available on event spans"):(t(r),this.emitSpanEnded(e))},e.update=t=>{e.isEvent?this.logger.warn("Update() is not available on event spans"):(r(t),this.emitSpanUpdated(e))}}shouldSample(e){let{sampling:t}=this.config;switch(t.type){case"always":return!0;case"never":return!1;case"ratio":if(void 0===t.probability||t.probability<0||t.probability>1)return this.logger.warn(`Invalid sampling probability: ${t.probability}. Expected value between 0 and 1. Defaulting to no sampling.`),!1;return Math.random()<t.probability;case"custom":return t.sampler(e);default:throw Error(`Sampling strategy type not implemented: ${t.type}`)}}processSpan(e){for(let t of this.processors){if(!e)break;try{e=t.process(e)}catch(e){this.logger.error(`[AI Tracing] Processor error [name=${t.name}]`,e)}}return e}getSpanForExport(e){if(!e.isValid||e.isInternal&&!this.config.includeInternalSpans)return;let t=this.processSpan(e);return t?.exportSpan(this.config.includeInternalSpans)}emitSpanStarted(e){let t=this.getSpanForExport(e);t&&this.exportEvent({type:"span_started",exportedSpan:t}).catch(e=>{this.logger.error("[AI Tracing] Failed to export span_started event",e)})}emitSpanEnded(e){let t=this.getSpanForExport(e);t&&this.exportEvent({type:"span_ended",exportedSpan:t}).catch(e=>{this.logger.error("[AI Tracing] Failed to export span_ended event",e)})}emitSpanUpdated(e){let t=this.getSpanForExport(e);t&&this.exportEvent({type:"span_updated",exportedSpan:t}).catch(e=>{this.logger.error("[AI Tracing] Failed to export span_updated event",e)})}async exportEvent(e){let t=this.exporters.map(async t=>{try{t.exportEvent&&(await t.exportEvent(e),this.logger.debug(`[AI Tracing] Event exported [exporter=${t.name}] [type=${e.type}]`))}catch(e){this.logger.error(`[AI Tracing] Export error [exporter=${t.name}]`,e)}});await Promise.allSettled(t)}init(){this.logger.debug(`[AI Tracing] Initialization started [name=${this.name}]`),this.logger.info(`[AI Tracing] Initialized successfully [name=${this.name}]`)}async shutdown(){this.logger.debug(`[AI Tracing] Shutdown started [name=${this.name}]`);let e=[...this.exporters.map(e=>e.shutdown()),...this.processors.map(e=>e.shutdown())];await Promise.allSettled(e),this.logger.info(`[AI Tracing] Shutdown completed [name=${this.name}]`)}},lP=class extends lj{constructor(e){super(e)}createSpan(e){return new lM(e,this)}},l$=class extends tD{originalTool;options;logType;constructor(e){super({name:"CoreToolBuilder"}),this.originalTool=e.originalTool,this.options=e.options,this.logType=e.logType}getParameters=()=>rn(this.originalTool)?this.originalTool.parameters??rb.z.object({}):this.originalTool.inputSchema??rb.z.object({});getOutputSchema=()=>"outputSchema"in this.originalTool?this.originalTool.outputSchema:null;buildProviderTool(e){if("type"in e&&"provider-defined"===e.type&&"id"in e&&"string"==typeof e.id&&e.id.includes(".")){let t=this.getParameters(),r=this.getOutputSchema();return{type:"provider-defined",id:e.id,args:"args"in this.originalTool?this.originalTool.args:{},description:e.description,parameters:o6(t),...r?{outputSchema:o6(r)}:{},execute:this.originalTool.execute?this.createExecute(this.originalTool,{...this.options,description:this.originalTool.description},this.logType):void 0}}}createLogMessageOptions({agentName:e,toolName:t,type:r}){if(!e)return{start:`Executing tool ${t}`,error:"Failed tool execution"};let a=`[Agent:${e}]`,s="toolset"===r?"toolset":"tool";return{start:`${a} - Executing ${s} ${t}`,error:`${a} - Failed ${s} execution`}}createExecute(e,t,r){let{logger:a,mastra:s,memory:n,runtimeContext:i,...o}=t,{start:l,error:u}=this.createLogMessageOptions({agentName:t.agentName,toolName:t.name,type:r}),d=async(a,s)=>{let n=t.tracingContext?.currentSpan?.createChildSpan({type:"tool_call",name:`tool: '${t.name}'`,input:a,attributes:{toolId:t.name,toolDescription:t.description,toolType:r||"tool"},tracingPolicy:t.tracingPolicy});try{let r;if(rn(e))r=await e?.execute?.(a,s);else{let i=t.mastra?l4(t.mastra,{currentSpan:n}):t.mastra;r=await e?.execute?.({context:a,threadId:t.threadId,resourceId:t.resourceId,mastra:i,memory:t.memory,runId:t.runId,runtimeContext:t.runtimeContext??new t7,writer:new rt({prefix:"tool",callId:s.toolCallId,name:t.name,runId:t.runId},t.writableStream||s.writableStream),tracingContext:{currentSpan:n}},s)}return n?.end({output:r}),r??void 0}catch(e){throw n?.error({error:e}),e}};return async(e,r)=>{let a=t.logger||this.logger;try{a.debug(l,{...o,args:e});let s=this.getParameters(),{data:n,error:i}=rr(s,e,t.name);if(i)return a.warn(`Tool input validation failed for '${t.name}'`,{toolName:t.name,errors:i.validationErrors,args:e}),i;return e=n,await new Promise((t,a)=>{setImmediate(async()=>{try{let a=await d(e,r);t(a)}catch(e){a(e)}})})}catch(r){let t=new tv({id:"TOOL_EXECUTION_FAILED",domain:"TOOL",category:"USER",details:{errorMessage:String(u),argsJson:JSON.stringify(e),model:o.model?.modelId??""}},r);return a.trackException(t),a.error(u,{...o,error:t,args:e}),t}}}buildV5(){let e=this.build();if(!e.parameters)throw Error("Tool parameters are required");return{...e,inputSchema:e.parameters,onInputStart:"onInputStart"in this.originalTool?this.originalTool.onInputStart:void 0,onInputDelta:"onInputDelta"in this.originalTool?this.originalTool.onInputDelta:void 0,onInputAvailable:"onInputAvailable"in this.originalTool?this.originalTool.onInputAvailable:void 0}}build(){let e,t=this.buildProviderTool(this.originalTool);if(t)return t;let r={type:"function",description:this.originalTool.description,parameters:this.getParameters(),outputSchema:this.getOutputSchema(),requireApproval:this.options.requireApproval,execute:this.originalTool.execute?this.createExecute(this.originalTool,{...this.options,description:this.originalTool.description},this.logType):void 0},a=this.options.model,s=[];if(a){let e="v2"!==a.specificationVersion&&(a.supportsStructuredOutputs??!1),t={modelId:a.modelId,supportsStructuredOutputs:e,provider:a.provider};s.push(new lI(t),new lx(t),new l_(t),new lb(t),new lw(t),new lS(t))}let n=o7({schema:this.getParameters(),compatLayers:s,mode:"aiSdkSchema"});return this.getOutputSchema()&&(e=o7({schema:this.getOutputSchema(),compatLayers:s,mode:"aiSdkSchema"})),{...r,id:"id"in this.originalTool?this.originalTool.id:void 0,parameters:n,outputSchema:e}}},lD=e=>new Promise(t=>setTimeout(t,e));function lL(e){return"object"==typeof e&&null!==e&&"_def"in e&&"parse"in e&&"function"==typeof e.parse&&"safeParse"in e&&"function"==typeof e.safeParse}function lU(e){return Object.keys(e).reduce((t,r)=>{let a=e?.[r];if(a)if(rn(a)){var s,n;let e,i,o;t[r]=(e=lL(o=a.parameters??rb.z.object({}))?o:(n=((e,{module:t,name:r,type:a,noImport:s,...n}={})=>{if(a&&(!r||"esm"!==t))throw Error("Option `type` requires `name` to be set and `module` to be `esm`");let i=rh(e,{module:t,name:r,path:[],seen:new Map,...n}),o=n.withJsdocs&&"boolean"!=typeof e&&e.description?rc(e.description):"";if("cjs"===t?(i=`${o}module.exports = ${r?`{ ${JSON.stringify(r)}: ${i} }`:i}
`,s||(i=`${o}const { z } = require("zod")

${i}`)):"esm"===t?(i=`${o}export ${r?`const ${r} =`:"default"} ${i}
`,s||(i=`import { z } from "zod"

${i}`)):r&&(i=`${o}const ${r} = ${i}`),a&&r){let e="string"==typeof a?a:`${r[0].toUpperCase()}${r.substring(1)}`;i+=`export type ${e} = z.infer<typeof ${r}>
`}return i})(o),Function("z",`"use strict";return (${n});`)(rb.z)),i="id"in a?a.id:a.description?`tool-${s=a.description,(0,ri.createHash)("sha256").update(s).digest("hex").slice(0,8)}`:`tool-${Math.random().toString(36).substring(2,9)}`,{...a,id:i,inputSchema:e})}else t[r]=a;return t},{})}function lz(e,t,r){return new l$({originalTool:e,options:t,logType:r}).build()}function lq({mastra:e,logger:t}){return new Proxy(e,{get(e,r){if(Reflect.has(e,r)){let t=Reflect.get(e,r);return"function"==typeof t?t.bind(e):t}return"logger"===r?(t.warn("Please use 'getLogger' instead, logger is deprecated"),Reflect.apply(e.getLogger,e,[])):"telemetry"===r?(t.warn("Please use 'getTelemetry' instead, telemetry is deprecated"),Reflect.apply(e.getTelemetry,e,[])):"storage"===r?(t.warn("Please use 'getStorage' instead, storage is deprecated"),Reflect.get(e,"storage")):"agents"===r?(t.warn("Please use 'getAgents' instead, agents is deprecated"),Reflect.apply(e.getAgents,e,[])):"tts"===r?(t.warn("Please use 'getTTS' instead, tts is deprecated"),Reflect.apply(e.getTTS,e,[])):"vectors"===r?(t.warn("Please use 'getVectors' instead, vectors is deprecated"),Reflect.apply(e.getVectors,e,[])):"memory"===r?(t.warn("Please use 'getMemory' instead, memory is deprecated"),Reflect.get(e,"memory")):Reflect.get(e,r)}})}async function lV(e,t={},r=3){let a=0,s=null;for(;a<r;)try{let r=await fetch(e,t);if(!r.ok)throw Error(`Request failed with status: ${r.status} ${r.statusText}`);return r}catch(t){if(s=t instanceof Error?t:Error(String(t)),++a>=r)break;let e=Math.min(1e3*Math.pow(2,a)*1e3,1e4);await new Promise(t=>setTimeout(t,e))}throw s||Error("Request failed after multiple retry attempts")}var lF=class{name="mastra-cloud-ai-tracing-exporter";config;buffer;flushTimer=null;logger;isDisabled=!1;constructor(e={}){this.logger=e.logger??new t$({level:tM});const t=e.accessToken??process.env.MASTRA_CLOUD_ACCESS_TOKEN;t||(this.logger.debug("CloudExporter disabled: MASTRA_CLOUD_ACCESS_TOKEN environment variable not set.  Sign up for Mastra Cloud at https://cloud.mastra.ai to see your AI traces online and obtain your access token."),this.isDisabled=!0);const r=e.endpoint??process.env.MASTRA_CLOUD_AI_TRACES_ENDPOINT??"https://api.mastra.ai/ai/spans/publish";this.config={maxBatchSize:e.maxBatchSize??1e3,maxBatchWaitMs:e.maxBatchWaitMs??5e3,maxRetries:e.maxRetries??3,accessToken:t||"",endpoint:r,logger:this.logger},this.buffer={spans:[],totalSize:0}}async exportEvent(e){this.isDisabled||"span_ended"===e.type&&(this.addToBuffer(e),this.shouldFlush()?this.flush().catch(e=>{this.logger.error("Batch flush failed",{error:e instanceof Error?e.message:String(e)})}):1===this.buffer.totalSize&&this.scheduleFlush())}addToBuffer(e){0===this.buffer.totalSize&&(this.buffer.firstEventTime=new Date);let t=this.formatSpan(e.exportedSpan);this.buffer.spans.push(t),this.buffer.totalSize++}formatSpan(e){return{traceId:e.traceId,spanId:e.id,parentSpanId:e.parentSpanId??null,name:e.name,spanType:e.type,attributes:e.attributes??null,metadata:e.metadata??null,startedAt:e.startTime,endedAt:e.endTime??null,input:e.input??null,output:e.output??null,error:e.errorInfo,isEvent:e.isEvent,createdAt:new Date,updatedAt:null}}shouldFlush(){return!!(this.buffer.totalSize>=this.config.maxBatchSize||this.buffer.firstEventTime&&this.buffer.totalSize>0&&Date.now()-this.buffer.firstEventTime.getTime()>=this.config.maxBatchWaitMs)||!1}scheduleFlush(){this.flushTimer&&clearTimeout(this.flushTimer),this.flushTimer=setTimeout(()=>{this.flush().catch(e=>{let t=new tv({id:"CLOUD_AI_TRACING_FAILED_TO_SCHEDULE_FLUSH",domain:"MASTRA_OBSERVABILITY",category:"USER"},e);this.logger.trackException(t),this.logger.error("Scheduled flush failed",t)})},this.config.maxBatchWaitMs)}async flush(){if(this.flushTimer&&(clearTimeout(this.flushTimer),this.flushTimer=null),0===this.buffer.totalSize)return;let e=Date.now(),t=[...this.buffer.spans],r=this.buffer.totalSize>=this.config.maxBatchSize?"size":"time";this.resetBuffer();try{await this.batchUpload(t);let a=Date.now()-e;this.logger.debug("Batch flushed successfully",{batchSize:t.length,flushReason:r,durationMs:a})}catch(r){let e=new tv({id:"CLOUD_AI_TRACING_FAILED_TO_BATCH_UPLOAD",domain:"MASTRA_OBSERVABILITY",category:"USER",details:{droppedBatchSize:t.length}},r);this.logger.trackException(e),this.logger.error("Batch upload failed after all retries, dropping batch",e)}}async batchUpload(e){let t=`${this.config.endpoint}`,r={method:"POST",headers:{Authorization:`Bearer ${this.config.accessToken}`,"Content-Type":"application/json"},body:JSON.stringify({spans:e})};await lV(t,r,this.config.maxRetries)}resetBuffer(){this.buffer.spans=[],this.buffer.firstEventTime=void 0,this.buffer.totalSize=0}async shutdown(){if(!this.isDisabled){if(this.flushTimer&&(clearTimeout(this.flushTimer),this.flushTimer=null),this.buffer.totalSize>0){this.logger.info("Flushing remaining events on shutdown",{remainingEvents:this.buffer.totalSize});try{await this.flush()}catch(t){let e=new tv({id:"CLOUD_AI_TRACING_FAILED_TO_FLUSH_REMAINING_EVENTS_DURING_SHUTDOWN",domain:"MASTRA_OBSERVABILITY",category:"USER",details:{remainingEvents:this.buffer.totalSize}},t);this.logger.trackException(e),this.logger.error("Failed to flush remaining events during shutdown",e)}}this.logger.info("CloudExporter shutdown complete")}}},lZ=class{name="tracing-default-exporter";logger;mastra=null;config;resolvedStrategy;buffer;flushTimer=null;allCreatedSpans=new Set;constructor(e={},t){t?this.logger=t:this.logger=new t$({level:tM}),this.config={maxBatchSize:e.maxBatchSize??1e3,maxBufferSize:e.maxBufferSize??1e4,maxBatchWaitMs:e.maxBatchWaitMs??5e3,maxRetries:e.maxRetries??4,retryDelayMs:e.retryDelayMs??500,strategy:e.strategy??"auto"},this.buffer={creates:[],updates:[],insertOnly:[],seenSpans:new Set,spanSequences:new Map,completedSpans:new Set,outOfOrderCount:0,totalSize:0},this.resolvedStrategy="batch-with-updates"}strategyInitialized=!1;__registerMastra(e){this.mastra=e}init(e){if(!this.mastra)throw Error("DefaultExporter: init() called before __registerMastra()");let t=this.mastra.getStorage();t?this.initializeStrategy(t):this.logger.warn("DefaultExporter disabled: Storage not available. Traces will not be persisted.")}initializeStrategy(e){this.strategyInitialized||(this.resolvedStrategy=function(e,t,r){if(e.strategy&&"auto"!==e.strategy){let a=t.aiTracingStrategy;if(a.supported.includes(e.strategy))return e.strategy;r.warn("User-specified AI tracing strategy not supported by storage adapter, falling back to auto-selection",{userStrategy:e.strategy,storageAdapter:t.constructor.name,supportedStrategies:a.supported,fallbackStrategy:a.preferred})}return t.aiTracingStrategy.preferred}(this.config,e,this.logger),this.strategyInitialized=!0,this.logger.debug("AI tracing exporter initialized",{strategy:this.resolvedStrategy,source:"auto"!==this.config.strategy?"user":"auto",storageAdapter:e.constructor.name,maxBatchSize:this.config.maxBatchSize,maxBatchWaitMs:this.config.maxBatchWaitMs}))}buildSpanKey(e,t){return`${e}:${t}`}getNextSequence(e){let t=(this.buffer.spanSequences.get(e)||0)+1;return this.buffer.spanSequences.set(e,t),t}handleOutOfOrderUpdate(e){this.logger.warn("Out-of-order span update detected - skipping event",{spanId:e.exportedSpan.id,traceId:e.exportedSpan.traceId,spanName:e.exportedSpan.name,eventType:e.type})}addToBuffer(e){let t=this.buildSpanKey(e.exportedSpan.traceId,e.exportedSpan.id);switch(0===this.buffer.totalSize&&(this.buffer.firstEventTime=new Date),e.type){case"span_started":if("batch-with-updates"===this.resolvedStrategy){let r=this.buildCreateRecord(e.exportedSpan);this.buffer.creates.push(r),this.buffer.seenSpans.add(t),this.allCreatedSpans.add(t)}break;case"span_updated":"batch-with-updates"===this.resolvedStrategy&&(this.allCreatedSpans.has(t)?this.buffer.updates.push({traceId:e.exportedSpan.traceId,spanId:e.exportedSpan.id,updates:this.buildUpdateRecord(e.exportedSpan),sequenceNumber:this.getNextSequence(t)}):(this.handleOutOfOrderUpdate(e),this.buffer.outOfOrderCount++));break;case"span_ended":if("batch-with-updates"===this.resolvedStrategy)if(this.allCreatedSpans.has(t))this.buffer.updates.push({traceId:e.exportedSpan.traceId,spanId:e.exportedSpan.id,updates:this.buildUpdateRecord(e.exportedSpan),sequenceNumber:this.getNextSequence(t)}),this.buffer.completedSpans.add(t);else if(e.exportedSpan.isEvent){let r=this.buildCreateRecord(e.exportedSpan);this.buffer.creates.push(r),this.buffer.seenSpans.add(t),this.allCreatedSpans.add(t),this.buffer.completedSpans.add(t)}else this.handleOutOfOrderUpdate(e),this.buffer.outOfOrderCount++;else if("insert-only"===this.resolvedStrategy){let r=this.buildCreateRecord(e.exportedSpan);this.buffer.insertOnly.push(r),this.buffer.completedSpans.add(t),this.allCreatedSpans.add(t)}}this.buffer.totalSize=this.buffer.creates.length+this.buffer.updates.length+this.buffer.insertOnly.length}shouldFlush(){return!!(this.buffer.totalSize>=this.config.maxBufferSize||this.buffer.totalSize>=this.config.maxBatchSize||this.buffer.firstEventTime&&this.buffer.totalSize>0&&Date.now()-this.buffer.firstEventTime.getTime()>=this.config.maxBatchWaitMs)||!1}resetBuffer(e=new Set){for(let t of(this.buffer.creates=[],this.buffer.updates=[],this.buffer.insertOnly=[],this.buffer.seenSpans.clear(),this.buffer.spanSequences.clear(),this.buffer.completedSpans.clear(),this.buffer.outOfOrderCount=0,this.buffer.firstEventTime=void 0,this.buffer.totalSize=0,e))this.allCreatedSpans.delete(t)}scheduleFlush(){this.flushTimer&&clearTimeout(this.flushTimer),this.flushTimer=setTimeout(()=>{this.flush().catch(e=>{this.logger.error("Scheduled flush failed",{error:e instanceof Error?e.message:String(e)})})},this.config.maxBatchWaitMs)}serializeAttributes(e){if(!e.attributes)return null;try{return JSON.parse(JSON.stringify(e.attributes,(e,t)=>t instanceof Date?t.toISOString():t))}catch(t){return this.logger.warn("Failed to serialize span attributes, storing as null",{spanId:e.id,spanType:e.type,error:t instanceof Error?t.message:String(t)}),null}}buildCreateRecord(e){return{traceId:e.traceId,spanId:e.id,parentSpanId:e.parentSpanId??null,name:e.name,scope:null,spanType:e.type,attributes:this.serializeAttributes(e),metadata:e.metadata??null,links:null,startedAt:e.startTime,endedAt:e.endTime??null,input:e.input,output:e.output,error:e.errorInfo,isEvent:e.isEvent}}buildUpdateRecord(e){return{name:e.name,scope:null,attributes:this.serializeAttributes(e),metadata:e.metadata??null,links:null,endedAt:e.endTime??null,input:e.input,output:e.output,error:e.errorInfo}}async handleRealtimeEvent(e,t){let r=e.exportedSpan,a=this.buildSpanKey(r.traceId,r.id);if(r.isEvent)"span_ended"===e.type?await t.createAISpan(this.buildCreateRecord(e.exportedSpan)):this.logger.warn(`Tracing event type not implemented for event spans: ${e.type}`);else switch(e.type){case"span_started":await t.createAISpan(this.buildCreateRecord(e.exportedSpan)),this.allCreatedSpans.add(a);break;case"span_updated":await t.updateAISpan({traceId:r.traceId,spanId:r.id,updates:this.buildUpdateRecord(r)});break;case"span_ended":await t.updateAISpan({traceId:r.traceId,spanId:r.id,updates:this.buildUpdateRecord(r)}),this.allCreatedSpans.delete(a);break;default:this.logger.warn(`Tracing event type not implemented for span spans: ${e.type}`)}}handleBatchWithUpdatesEvent(e){this.addToBuffer(e),this.shouldFlush()?this.flush().catch(e=>{this.logger.error("Batch flush failed",{error:e instanceof Error?e.message:String(e)})}):1===this.buffer.totalSize&&this.scheduleFlush()}handleInsertOnlyEvent(e){"span_ended"===e.type&&(this.addToBuffer(e),this.shouldFlush()?this.flush().catch(e=>{this.logger.error("Batch flush failed",{error:e instanceof Error?e.message:String(e)})}):1===this.buffer.totalSize&&this.scheduleFlush())}calculateRetryDelay(e){return this.config.retryDelayMs*Math.pow(2,e)}async flush(){if(!this.mastra)return void this.logger.debug("Cannot flush traces. Mastra instance not registered yet.");let e=this.mastra.getStorage();if(!e)return void this.logger.debug("Cannot flush traces. Mastra storage is not initialized");if(this.flushTimer&&(clearTimeout(this.flushTimer),this.flushTimer=null),0===this.buffer.totalSize)return;let t=Date.now(),r=this.buffer.totalSize>=this.config.maxBufferSize?"overflow":this.buffer.totalSize>=this.config.maxBatchSize?"size":"time",a={creates:[...this.buffer.creates],updates:[...this.buffer.updates],insertOnly:[...this.buffer.insertOnly],seenSpans:new Set(this.buffer.seenSpans),spanSequences:new Map(this.buffer.spanSequences),completedSpans:new Set(this.buffer.completedSpans),outOfOrderCount:this.buffer.outOfOrderCount,firstEventTime:this.buffer.firstEventTime,totalSize:this.buffer.totalSize};this.resetBuffer(),await this.flushWithRetries(e,a,0);let s=Date.now()-t;this.logger.debug("Batch flushed",{strategy:this.resolvedStrategy,batchSize:a.totalSize,flushReason:r,durationMs:s,outOfOrderCount:a.outOfOrderCount>0?a.outOfOrderCount:void 0})}async flushWithRetries(e,t,r){try{if("batch-with-updates"===this.resolvedStrategy){if(t.creates.length>0&&await e.batchCreateAISpans({records:t.creates}),t.updates.length>0){let r=t.updates.sort((e,t)=>{let r=this.buildSpanKey(e.traceId,e.spanId).localeCompare(this.buildSpanKey(t.traceId,t.spanId));return 0!==r?r:e.sequenceNumber-t.sequenceNumber});await e.batchUpdateAISpans({records:r})}}else"insert-only"===this.resolvedStrategy&&t.insertOnly.length>0&&await e.batchCreateAISpans({records:t.insertOnly});for(let e of t.completedSpans)this.allCreatedSpans.delete(e)}catch(a){if(r<this.config.maxRetries){let s=this.calculateRetryDelay(r);return this.logger.warn("Batch flush failed, retrying",{attempt:r+1,maxRetries:this.config.maxRetries,nextRetryInMs:s,error:a instanceof Error?a.message:String(a)}),await new Promise(e=>setTimeout(e,s)),this.flushWithRetries(e,t,r+1)}for(let e of(this.logger.error("Batch flush failed after all retries, dropping batch",{finalAttempt:r+1,maxRetries:this.config.maxRetries,droppedBatchSize:t.totalSize,error:a instanceof Error?a.message:String(a)}),t.completedSpans))this.allCreatedSpans.delete(e)}}async exportEvent(e){if(!this.mastra)return void this.logger.debug("Cannot export AI tracing event. Mastra instance not registered yet.");let t=this.mastra.getStorage();if(!t)return void this.logger.debug("Cannot store traces. Mastra storage is not initialized");switch(!this.strategyInitialized&&this.initializeStrategy(t),this.resolvedStrategy){case"realtime":await this.handleRealtimeEvent(e,t);break;case"batch-with-updates":this.handleBatchWithUpdatesEvent(e);break;case"insert-only":this.handleInsertOnlyEvent(e)}}async shutdown(){if(this.flushTimer&&(clearTimeout(this.flushTimer),this.flushTimer=null),this.buffer.totalSize>0){this.logger.info("Flushing remaining events on shutdown",{remainingEvents:this.buffer.totalSize});try{await this.flush()}catch(e){this.logger.error("Failed to flush remaining events during shutdown",{error:e instanceof Error?e.message:String(e)})}}this.logger.info("DefaultExporter shutdown complete")}},lW=class{name="sensitive-data-filter";sensitiveFields;redactionToken;redactionStyle;constructor(e={}){this.sensitiveFields=(e.sensitiveFields||["password","token","secret","key","apikey","auth","authorization","bearer","bearertoken","jwt","credential","clientsecret","privatekey","refresh","ssn"]).map(e=>this.normalizeKey(e)),this.redactionToken=e.redactionToken??"[REDACTED]",this.redactionStyle=e.redactionStyle??"full"}process(e){return e.attributes=this.tryFilter(e.attributes),e.metadata=this.tryFilter(e.metadata),e.input=this.tryFilter(e.input),e.output=this.tryFilter(e.output),e.errorInfo=this.tryFilter(e.errorInfo),e}deepFilter(e,t=new WeakSet){if(null===e||"object"!=typeof e)return e;if(t.has(e))return"[Circular Reference]";if(t.add(e),Array.isArray(e))return e.map(e=>this.deepFilter(e,t));let r={};for(let a of Object.keys(e)){let s=this.normalizeKey(a);this.isSensitive(s)?e[a]&&"object"==typeof e[a]?r[a]=this.deepFilter(e[a],t):r[a]=this.redactValue(e[a]):r[a]=this.deepFilter(e[a],t)}return r}tryFilter(e){try{return this.deepFilter(e)}catch{return{error:{processor:this.name}}}}normalizeKey(e){return e.toLowerCase().replace(/[^a-z0-9]/g,"")}isSensitive(e){return this.sensitiveFields.some(t=>e===t)}redactValue(e){if("full"===this.redactionStyle)return this.redactionToken;let t=String(e),r=t.length;return r<=6?this.redactionToken:t.slice(0,3)+""+t.slice(r-3)}async shutdown(){}},lG=new class{instances=new Map;defaultInstance;configSelector;register(e,t,r=!1){if(this.instances.has(e))throw Error(`AI Tracing instance '${e}' already registered`);this.instances.set(e,t),(r||!this.defaultInstance)&&(this.defaultInstance=t)}get(e){return this.instances.get(e)}getDefault(){return this.defaultInstance}setSelector(e){this.configSelector=e}getSelected(e){if(this.configSelector){let t=this.configSelector(e,this.instances);if(t&&this.instances.has(t))return this.instances.get(t)}return this.defaultInstance}unregister(e){return this.instances.delete(e)}async shutdown(){let e=Array.from(this.instances.values()).map(e=>e.shutdown());await Promise.allSettled(e),this.instances.clear()}clear(){this.instances.clear(),this.defaultInstance=void 0,this.configSelector=void 0}getAll(){return new Map(this.instances)}};function lB(e,t,r=!1){lG.register(e,t,r)}async function lK(){await lG.shutdown()}function lJ(){return lG.getAll()}function lH(e){return e?.isValid?e.traceId:void 0}function lY(e){var t;let{type:r,attributes:a,tracingContext:s,runtimeContext:n,...i}=e,o={...i.metadata??{},...i.tracingOptions?.metadata??{}};if(s?.currentSpan)return s.currentSpan.createChildSpan({type:r,attributes:a,...i,metadata:o});let l=(t={runtimeContext:n},lG.getSelected(t));return l?.startSpan({type:r,attributes:a,...i,metadata:o,customSamplerOptions:{runtimeContext:n,metadata:o}})}var lQ=["getAgent","getAgentById"],lX=["generate","stream","generateLegacy","streamLegacy"],l0=["getWorkflow","getWorkflowById"],l1=["execute","createRun","createRunAsync"];function l2(e){return"NoOpAISpan"===e.constructor.name||!0===e.__isNoOp}function l4(e,t){let r,a;if(!t.currentSpan||l2(t.currentSpan)||(r=lQ.every(t=>"function"==typeof e?.[t]),a=l0.every(t=>"function"==typeof e?.[t]),!r||!a))return e;try{return new Proxy(e,{get(e,r){try{if(lQ.includes(r))return(...a)=>{var s=e[r](...a),n=t;if(!n.currentSpan||l2(n.currentSpan))return s;try{return new Proxy(s,{get(e,t){try{if(lX.includes(t))return(r,a={})=>e[t](r,{...a,tracingContext:n});let r=e[t];return"function"==typeof r?r.bind(e):r}catch(a){console.warn("AI Tracing: Failed to wrap agent method, falling back to original",a);let r=e[t];return"function"==typeof r?r.bind(e):r}}})}catch(e){return console.warn("AI Tracing: Failed to create agent proxy, using original instance",e),s}};if(l0.includes(r))return(...a)=>{var s=e[r](...a),n=t;if(!n.currentSpan||l2(n.currentSpan))return s;try{return new Proxy(s,{get(e,t){try{if(l1.includes(t)){if("createRun"===t||"createRunAsync"===t)return async(r={})=>{let a=await e[t](r);return a?function(e,t){if(!t.currentSpan||l2(t.currentSpan))return e;try{return new Proxy(e,{get(e,r){try{if("start"===r)return (r={})=>e.start({...r,tracingContext:r.tracingContext??t});let a=e[r];return"function"==typeof a?a.bind(e):a}catch(a){console.warn("AI Tracing: Failed to wrap run method, falling back to original",a);let t=e[r];return"function"==typeof t?t.bind(e):t}}})}catch(t){return console.warn("AI Tracing: Failed to create run proxy, using original instance",t),e}}(a,n):a};return(r,a={})=>e[t](r,{...a,tracingContext:n})}let r=e[t];return"function"==typeof r?r.bind(e):r}catch(a){console.warn("AI Tracing: Failed to wrap workflow method, falling back to original",a);let r=e[t];return"function"==typeof r?r.bind(e):r}}})}catch(e){return console.warn("AI Tracing: Failed to create workflow proxy, using original instance",e),s}};let a=e[r];return"function"==typeof a?a.bind(e):a}catch(a){console.warn("AI Tracing: Failed to wrap method, falling back to original",a);let t=e[r];return"function"==typeof t?t.bind(e):t}}})}catch(t){return console.warn("AI Tracing: Failed to create proxy, using original Mastra instance",t),e}}var l5="vercel.ai.error",l3=Symbol.for(l5),l9=class e extends Error{constructor({name:e,message:t,cause:r}){super(t),this[G]=!0,this.name=e,this.cause=r}static isInstance(t){return e.hasMarker(t,l5)}static hasMarker(e,t){let r=Symbol.for(t);return null!=e&&"object"==typeof e&&r in e&&"boolean"==typeof e[r]&&!0===e[r]}};G=l3;var l6=l9,l8="AI_APICallError",l7=`vercel.ai.error.${l8}`,ue=Symbol.for(l7),ut=class extends l6{constructor({message:e,url:t,requestBodyValues:r,statusCode:a,responseHeaders:s,responseBody:n,cause:i,isRetryable:o=null!=a&&(408===a||409===a||429===a||a>=500),data:l}){super({name:l8,message:e,cause:i}),this[B]=!0,this.url=t,this.requestBodyValues=r,this.statusCode=a,this.responseHeaders=s,this.responseBody=n,this.isRetryable=o,this.data=l}static isInstance(e){return l6.hasMarker(e,l7)}};function ur(e){return null==e?"unknown error":"string"==typeof e?e:e instanceof Error?e.message:JSON.stringify(e)}B=ue,Symbol.for("vercel.ai.error.AI_EmptyResponseBodyError");var ua="AI_InvalidArgumentError",us=`vercel.ai.error.${ua}`,un=Symbol.for(us),ui=class extends l6{constructor({message:e,cause:t,argument:r}){super({name:ua,message:e,cause:t}),this[K]=!0,this.argument=r}static isInstance(e){return l6.hasMarker(e,us)}};K=un;var uo="AI_InvalidPromptError",ul=`vercel.ai.error.${uo}`,uu=Symbol.for(ul),ud=class extends l6{constructor({prompt:e,message:t,cause:r}){super({name:uo,message:`Invalid prompt: ${t}`,cause:r}),this[J]=!0,this.prompt=e}static isInstance(e){return l6.hasMarker(e,ul)}};J=uu,Symbol.for("vercel.ai.error.AI_InvalidResponseDataError");var up="AI_JSONParseError",uc=`vercel.ai.error.${up}`,uh=Symbol.for(uc),um=class extends l6{constructor({text:e,cause:t}){super({name:up,message:`JSON parsing failed: Text: ${e}.
Error message: ${ur(t)}`,cause:t}),this[H]=!0,this.text=e}static isInstance(e){return l6.hasMarker(e,uc)}};H=uh,Symbol.for("vercel.ai.error.AI_LoadAPIKeyError"),Symbol.for("vercel.ai.error.AI_LoadSettingError"),Symbol.for("vercel.ai.error.AI_NoContentGeneratedError"),Symbol.for("vercel.ai.error.AI_NoSuchModelError"),Symbol.for("vercel.ai.error.AI_TooManyEmbeddingValuesForCallError");var ug="AI_TypeValidationError",uf=`vercel.ai.error.${ug}`,uy=Symbol.for(uf),uv=class e extends l6{constructor({value:e,cause:t}){super({name:ug,message:`Type validation failed: Value: ${JSON.stringify(e)}.
Error message: ${ur(t)}`,cause:t}),this[Y]=!0,this.value=e}static isInstance(e){return l6.hasMarker(e,uf)}static wrap({value:t,cause:r}){return e.isInstance(r)&&r.value===t?r:new e({value:t,cause:r})}};Y=uy;var ub="AI_UnsupportedFunctionalityError",uw=`vercel.ai.error.${ub}`,u_=Symbol.for(uw),uS=class extends l6{constructor({functionality:e,message:t=`'${e}' functionality not supported.`}){super({name:ub,message:t}),this[Q]=!0,this.functionality=e}static isInstance(e){return l6.hasMarker(e,uw)}};function ux(e){return null===e||"string"==typeof e||"number"==typeof e||"boolean"==typeof e||(Array.isArray(e)?e.every(ux):"object"==typeof e&&Object.entries(e).every(([e,t])=>"string"==typeof e&&ux(t)))}function uI(e){return Array.isArray(e)&&e.every(ux)}function uk(e){return null!=e&&"object"==typeof e&&Object.entries(e).every(([e,t])=>"string"==typeof e&&ux(t))}async function uT(e){return null==e?Promise.resolve():new Promise(t=>setTimeout(t,e))}Q=u_;var uE=({prefix:e,size:t=16,alphabet:r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",separator:a="-"}={})=>{let s=nt(r,t);if(null==e)return s;if(r.includes(a))throw new ui({argument:"separator",message:`The separator "${a}" must not be part of the alphabet "${r}".`});return t=>`${e}${a}${s(t)}`};uE();var uA=Symbol.for("vercel.ai.validator");function uO({value:e,schema:t}){var r;let a="object"==typeof t&&null!==t&&uA in t&&!0===t[uA]&&"validate"in t?t:(r=t,{[uA]:!0,validate:e=>{let t=r.safeParse(e);return t.success?{success:!0,value:t.data}:{success:!1,error:t.error}}});try{if(null==a.validate)return{success:!0,value:e};let t=a.validate(e);if(t.success)return t;return{success:!1,error:uv.wrap({value:e,cause:t.error})}}catch(t){return{success:!1,error:uv.wrap({value:e,cause:t})}}}function uC({text:e,schema:t}){try{let r=nr.default.parse(e);if(null==t)return{success:!0,value:r,rawValue:r};let a=uO({value:r,schema:t});return a.success?{...a,rawValue:r}:a}catch(t){return{success:!1,error:um.isInstance(t)?t:new um({text:e,cause:t})}}}var{btoa:uR,atob:uM}=globalThis;function uN(e){let t=uM(e.replace(/-/g,"+").replace(/_/g,"/"));return Uint8Array.from(t,e=>e.codePointAt(0))}function uj(e){let t="";for(let r=0;r<e.length;r++)t+=String.fromCodePoint(e[r]);return uR(t)}var uP=Object.defineProperty,u$=(e,t)=>{for(var r in t)uP(e,r,{get:t[r],enumerable:!0})};function uD(e,{contentType:t,dataStreamVersion:r}){let a=new Headers(null!=e?e:{});return a.has("Content-Type")||a.set("Content-Type",t),void 0!==r&&a.set("X-Vercel-AI-Data-Stream",r),a}function uL(e,{contentType:t,dataStreamVersion:r}){let a={};if(null!=e)for(let[t,r]of Object.entries(e))a[t]=r;return null==a["Content-Type"]&&(a["Content-Type"]=t),void 0!==r&&(a["X-Vercel-AI-Data-Stream"]=r),a}function uU({response:e,status:t,statusText:r,headers:a,stream:s}){e.writeHead(null!=t?t:200,r,a);let n=s.getReader();(async()=>{try{for(;;){let{done:t,value:r}=await n.read();if(t)break;e.write(r)}}catch(e){throw e}finally{e.end()}})()}var uz=class extends l6{constructor(){super({name:"AI_UnsupportedModelVersionError",message:'Unsupported model version. AI SDK 4 only supports models that implement specification version "v1". Please upgrade to AI SDK 5 to use this model.'})}},uq="AI_InvalidArgumentError",uV=`vercel.ai.error.${uq}`,uF=Symbol.for(uV),uZ=class extends l6{constructor({parameter:e,value:t,message:r}){super({name:uq,message:`Invalid argument for parameter ${e}: ${r}`}),this[X]=!0,this.parameter=e,this.value=t}static isInstance(e){return l6.hasMarker(e,uV)}};X=uF;var uW="AI_RetryError",uG=`vercel.ai.error.${uW}`,uB=Symbol.for(uG),uK=class extends l6{constructor({message:e,reason:t,errors:r}){super({name:uW,message:e}),this[ee]=!0,this.reason=t,this.errors=r,this.lastError=r[r.length-1]}static isInstance(e){return l6.hasMarker(e,uG)}};async function uJ(e,{maxRetries:t,delayInMs:r,backoffFactor:a},s=[]){try{return await e()}catch(l){if(l instanceof Error&&("AbortError"===l.name||"TimeoutError"===l.name)||0===t)throw l;let n=null==l?"unknown error":"string"==typeof l?l:l instanceof Error?l.message:JSON.stringify(l),i=[...s,l],o=i.length;if(o>t)throw new uK({message:`Failed after ${o} attempts. Last error: ${n}`,reason:"maxRetriesExceeded",errors:i});if(l instanceof Error&&ut.isInstance(l)&&!0===l.isRetryable&&o<=t)return await uT(r),uJ(e,{maxRetries:t,delayInMs:a*r,backoffFactor:a},i);if(1===o)throw l;throw new uK({message:`Failed after ${o} attempts with non-retryable error: '${n}'`,reason:"errorNotRetryable",errors:i})}}function uH({maxRetries:e}){if(null!=e){if(!Number.isInteger(e))throw new uZ({parameter:"maxRetries",value:e,message:"maxRetries must be an integer"});if(e<0)throw new uZ({parameter:"maxRetries",value:e,message:"maxRetries must be >= 0"})}let t=null!=e?e:2;return{maxRetries:t,retry:(({maxRetries:e=2,initialDelayInMs:t=2e3,backoffFactor:r=2}={})=>async a=>uJ(a,{maxRetries:e,delayInMs:t,backoffFactor:r}))({maxRetries:t})}}function uY({operationId:e,telemetry:t}){return{"operation.name":`${e}${(null==t?void 0:t.functionId)!=null?` ${t.functionId}`:""}`,"resource.name":null==t?void 0:t.functionId,"ai.operationId":e,"ai.telemetry.functionId":null==t?void 0:t.functionId}}function uQ({model:e,settings:t,telemetry:r,headers:a}){var s;return{"ai.model.provider":e.provider,"ai.model.id":e.modelId,...Object.entries(t).reduce((e,[t,r])=>(e[`ai.settings.${t}`]=r,e),{}),...Object.entries(null!=(s=null==r?void 0:r.metadata)?s:{}).reduce((e,[t,r])=>(e[`ai.telemetry.metadata.${t}`]=r,e),{}),...Object.entries(null!=a?a:{}).reduce((e,[t,r])=>(void 0!==r&&(e[`ai.request.headers.${t}`]=r),e),{})}}ee=uB;var uX={startSpan:()=>u0,startActiveSpan:(e,t,r,a)=>"function"==typeof t?t(u0):"function"==typeof r?r(u0):"function"==typeof a?a(u0):void 0},u0={spanContext:()=>u1,setAttribute(){return this},setAttributes(){return this},addEvent(){return this},addLink(){return this},addLinks(){return this},setStatus(){return this},updateName(){return this},end(){return this},isRecording:()=>!1,recordException(){return this}},u1={traceId:"",spanId:"",traceFlags:0};function u2({isEnabled:e=!1,tracer:t}={}){return e?t||tb.trace.getTracer("ai"):uX}function u4({name:e,tracer:t,attributes:r,fn:a,endWhenDone:s=!0}){return t.startActiveSpan(e,{attributes:r},async e=>{try{let t=await a(e);return s&&e.end(),t}catch(t){try{u5(e,t)}finally{e.end()}throw t}})}function u5(e,t){t instanceof Error?(e.recordException({name:t.name,message:t.message,stack:t.stack}),e.setStatus({code:tS.SpanStatusCode.ERROR,message:t.message})):e.setStatus({code:tS.SpanStatusCode.ERROR})}function u3({telemetry:e,attributes:t}){return(null==e?void 0:e.isEnabled)!==!0?{}:Object.entries(t).reduce((t,[r,a])=>{if(void 0===a)return t;if("object"==typeof a&&"input"in a&&"function"==typeof a.input){if((null==e?void 0:e.recordInputs)===!1)return t;let s=a.input();return void 0===s?t:{...t,[r]:s}}if("object"==typeof a&&"output"in a&&"function"==typeof a.output){if((null==e?void 0:e.recordOutputs)===!1)return t;let s=a.output();return void 0===s?t:{...t,[r]:s}}return{...t,[r]:a}},{})}Symbol.for("vercel.ai.error.AI_NoImageGeneratedError");var u9=class{constructor({data:e,mimeType:t}){const r=e instanceof Uint8Array;this.base64Data=r?void 0:e,this.uint8ArrayData=r?e:void 0,this.mimeType=t}get base64(){return null==this.base64Data&&(this.base64Data=uj(this.uint8ArrayData)),this.base64Data}get uint8Array(){return null==this.uint8ArrayData&&(this.uint8ArrayData=uN(this.base64Data)),this.uint8ArrayData}},u6=class extends u9{constructor(e){super(e),this.type="file"}},u8=[{mimeType:"image/gif",bytesPrefix:[71,73,70],base64Prefix:"R0lG"},{mimeType:"image/png",bytesPrefix:[137,80,78,71],base64Prefix:"iVBORw"},{mimeType:"image/jpeg",bytesPrefix:[255,216],base64Prefix:"/9j/"},{mimeType:"image/webp",bytesPrefix:[82,73,70,70],base64Prefix:"UklGRg"},{mimeType:"image/bmp",bytesPrefix:[66,77],base64Prefix:"Qk"},{mimeType:"image/tiff",bytesPrefix:[73,73,42,0],base64Prefix:"SUkqAA"},{mimeType:"image/tiff",bytesPrefix:[77,77,0,42],base64Prefix:"TU0AKg"},{mimeType:"image/avif",bytesPrefix:[0,0,0,32,102,116,121,112,97,118,105,102],base64Prefix:"AAAAIGZ0eXBhdmlm"},{mimeType:"image/heic",bytesPrefix:[0,0,0,32,102,116,121,112,104,101,105,99],base64Prefix:"AAAAIGZ0eXBoZWlj"}],u7="AI_NoObjectGeneratedError",de=`vercel.ai.error.${u7}`,dt=Symbol.for(de),dr=class extends l6{constructor({message:e="No object generated.",cause:t,text:r,response:a,usage:s,finishReason:n}){super({name:u7,message:e,cause:t}),this[et]=!0,this.text=r,this.response=a,this.usage=s,this.finishReason=n}static isInstance(e){return l6.hasMarker(e,de)}};et=dt;var da="AI_DownloadError",ds=`vercel.ai.error.${da}`,dn=Symbol.for(ds),di=class extends l6{constructor({url:e,statusCode:t,statusText:r,cause:a,message:s=null==a?`Failed to download ${e}: ${t} ${r}`:`Failed to download ${e}: ${a}`}){super({name:da,message:s,cause:a}),this[er]=!0,this.url=e,this.statusCode=t,this.statusText=r}static isInstance(e){return l6.hasMarker(e,ds)}};async function dl({url:e}){var t;let r=e.toString();try{let e=await fetch(r);if(!e.ok)throw new di({url:r,statusCode:e.status,statusText:e.statusText});return{data:new Uint8Array(await e.arrayBuffer()),mimeType:null!=(t=e.headers.get("content-type"))?t:void 0}}catch(e){if(di.isInstance(e))throw e;throw new di({url:r,cause:e})}}er=dn;var du="AI_InvalidDataContentError",dd=`vercel.ai.error.${du}`,dp=Symbol.for(dd),dc=class extends l6{constructor({content:e,cause:t,message:r=`Invalid data content. Expected a base64 string, Uint8Array, ArrayBuffer, or Buffer, but got ${typeof e}.`}){super({name:du,message:r,cause:t}),this[ea]=!0,this.content=e}static isInstance(e){return l6.hasMarker(e,dd)}};ea=dp;var dh=rb.z.union([rb.z.string(),rb.z.instanceof(Uint8Array),rb.z.instanceof(ArrayBuffer),rb.z.custom(e=>{var t,r;return null!=(r=null==(t=globalThis.Buffer)?void 0:t.isBuffer(e))&&r},{message:"Must be a Buffer"})]);function dm(e){return"string"==typeof e?e:e instanceof ArrayBuffer?uj(new Uint8Array(e)):uj(e)}function dg(e){if(e instanceof Uint8Array)return e;if("string"==typeof e)try{return uN(e)}catch(t){throw new dc({message:"Invalid data content. Content string is not a base64-encoded media.",content:e,cause:t})}if(e instanceof ArrayBuffer)return new Uint8Array(e);throw new dc({content:e})}var df="AI_InvalidMessageRoleError",dy=`vercel.ai.error.${df}`,dv=Symbol.for(dy),db=class extends l6{constructor({role:e,message:t=`Invalid message role: '${e}'. Must be one of: "system", "user", "assistant", "tool".`}){super({name:df,message:t}),this[es]=!0,this.role=e}static isInstance(e){return l6.hasMarker(e,dy)}};async function dw({prompt:e,modelSupportsImageUrls:t=!0,modelSupportsUrl:r=()=>!1,downloadImplementation:a=dl}){let s=await d_(e.messages,a,t,r);return[...null!=e.system?[{role:"system",content:e.system}]:[],...e.messages.map(e=>(function(e,t){var r,a,s,n,i,o;let l=e.role;switch(l){case"system":return{role:"system",content:e.content,providerMetadata:null!=(r=e.providerOptions)?r:e.experimental_providerMetadata};case"user":if("string"==typeof e.content)return{role:"user",content:[{type:"text",text:e.content}],providerMetadata:null!=(a=e.providerOptions)?a:e.experimental_providerMetadata};return{role:"user",content:e.content.map(e=>(function(e,t){var r,a,s,n;let i,o,l;if("text"===e.type)return{type:"text",text:e.text,providerMetadata:null!=(r=e.providerOptions)?r:e.experimental_providerMetadata};let u=e.mimeType,d=e.type;switch(d){case"image":i=e.image;break;case"file":i=e.data;break;default:throw Error(`Unsupported part type: ${d}`)}try{o="string"==typeof i?new URL(i):i}catch(e){o=i}if(o instanceof URL)if("data:"===o.protocol){let{mimeType:e,base64Content:t}=function(e){try{let[t,r]=e.split(",");return{mimeType:t.split(";")[0].split(":")[1],base64Content:r}}catch(e){return{mimeType:void 0,base64Content:void 0}}}(o.toString());if(null==e||null==t)throw Error(`Invalid data URL format in part ${d}`);u=e,l=dg(t)}else{let e=t[o.toString()];e?(l=e.data,null!=u||(u=e.mimeType)):l=o}else l=dg(o);switch(d){case"image":return l instanceof Uint8Array&&(u=null!=(a=function({data:e,signatures:t}){let r,a,s="string"==typeof e&&e.startsWith("SUQz")||"string"!=typeof e&&e.length>10&&73===e[0]&&68===e[1]&&51===e[2]?(a=(127&(r="string"==typeof e?uN(e):e)[6])<<21|(127&r[7])<<14|(127&r[8])<<7|127&r[9],r.slice(a+10)):e;for(let e of t)if("string"==typeof s?s.startsWith(e.base64Prefix):s.length>=e.bytesPrefix.length&&e.bytesPrefix.every((e,t)=>s[t]===e))return e.mimeType}({data:l,signatures:u8}))?a:u),{type:"image",image:l,mimeType:u,providerMetadata:null!=(s=e.providerOptions)?s:e.experimental_providerMetadata};case"file":if(null==u)throw Error("Mime type is missing for file part");return{type:"file",data:l instanceof Uint8Array?dm(l):l,filename:e.filename,mimeType:u,providerMetadata:null!=(n=e.providerOptions)?n:e.experimental_providerMetadata}}})(e,t)).filter(e=>"text"!==e.type||""!==e.text),providerMetadata:null!=(s=e.providerOptions)?s:e.experimental_providerMetadata};case"assistant":if("string"==typeof e.content)return{role:"assistant",content:[{type:"text",text:e.content}],providerMetadata:null!=(n=e.providerOptions)?n:e.experimental_providerMetadata};return{role:"assistant",content:e.content.filter(e=>"text"!==e.type||""!==e.text).map(e=>{var t;let r=null!=(t=e.providerOptions)?t:e.experimental_providerMetadata;switch(e.type){case"file":return{type:"file",data:e.data instanceof URL?e.data:dm(e.data),filename:e.filename,mimeType:e.mimeType,providerMetadata:r};case"reasoning":return{type:"reasoning",text:e.text,signature:e.signature,providerMetadata:r};case"redacted-reasoning":return{type:"redacted-reasoning",data:e.data,providerMetadata:r};case"text":return{type:"text",text:e.text,providerMetadata:r};case"tool-call":return{type:"tool-call",toolCallId:e.toolCallId,toolName:e.toolName,args:e.args,providerMetadata:r}}}),providerMetadata:null!=(i=e.providerOptions)?i:e.experimental_providerMetadata};case"tool":return{role:"tool",content:e.content.map(e=>{var t;return{type:"tool-result",toolCallId:e.toolCallId,toolName:e.toolName,result:e.result,content:e.experimental_content,isError:e.isError,providerMetadata:null!=(t=e.providerOptions)?t:e.experimental_providerMetadata}}),providerMetadata:null!=(o=e.providerOptions)?o:e.experimental_providerMetadata};default:throw new db({role:l})}})(e,s))]}async function d_(e,t,r,a){let s=e.filter(e=>"user"===e.role).map(e=>e.content).filter(e=>Array.isArray(e)).flat().filter(e=>"image"===e.type||"file"===e.type).filter(e=>"image"!==e.type||!0!==r).map(e=>"image"===e.type?e.image:e.data).map(e=>"string"==typeof e&&(e.startsWith("http:")||e.startsWith("https:"))?new URL(e):e).filter(e=>e instanceof URL).filter(e=>!a(e));return Object.fromEntries((await Promise.all(s.map(async e=>({url:e,data:await t({url:e})})))).map(({url:e,data:t})=>[e.toString(),t]))}function dS({maxTokens:e,temperature:t,topP:r,topK:a,presencePenalty:s,frequencyPenalty:n,stopSequences:i,seed:o}){if(null!=e){if(!Number.isInteger(e))throw new uZ({parameter:"maxTokens",value:e,message:"maxTokens must be an integer"});if(e<1)throw new uZ({parameter:"maxTokens",value:e,message:"maxTokens must be >= 1"})}if(null!=t&&"number"!=typeof t)throw new uZ({parameter:"temperature",value:t,message:"temperature must be a number"});if(null!=r&&"number"!=typeof r)throw new uZ({parameter:"topP",value:r,message:"topP must be a number"});if(null!=a&&"number"!=typeof a)throw new uZ({parameter:"topK",value:a,message:"topK must be a number"});if(null!=s&&"number"!=typeof s)throw new uZ({parameter:"presencePenalty",value:s,message:"presencePenalty must be a number"});if(null!=n&&"number"!=typeof n)throw new uZ({parameter:"frequencyPenalty",value:n,message:"frequencyPenalty must be a number"});if(null!=o&&!Number.isInteger(o))throw new uZ({parameter:"seed",value:o,message:"seed must be an integer"});return{maxTokens:e,temperature:null!=t?t:0,topP:r,topK:a,presencePenalty:s,frequencyPenalty:n,stopSequences:null!=i&&i.length>0?i:void 0,seed:o}}function dx(e){var t,r,a;let s=[];for(let n of e){let e;try{e=new URL(n.url)}catch(e){throw Error(`Invalid URL: ${n.url}`)}switch(e.protocol){case"http:":case"https:":if(null==(t=n.contentType)?void 0:t.startsWith("image/"))s.push({type:"image",image:e});else{if(!n.contentType)throw Error("If the attachment is not an image, it must specify a content type");s.push({type:"file",data:e,mimeType:n.contentType})}break;case"data:":{let e,t,i;try{[e,t]=n.url.split(","),i=e.split(";")[0].split(":")[1]}catch(e){throw Error(`Error processing data URL: ${n.url}`)}if(null==i||null==t)throw Error(`Invalid data URL format: ${n.url}`);if(null==(r=n.contentType)?void 0:r.startsWith("image/"))s.push({type:"image",image:dg(t)});else if(null==(a=n.contentType)?void 0:a.startsWith("text/"))s.push({type:"text",text:function(e){try{return new TextDecoder().decode(e)}catch(e){throw Error("Error decoding Uint8Array to text")}}(dg(t))});else{if(!n.contentType)throw Error("If the attachment is not an image or text, it must specify a content type");s.push({type:"file",data:t,mimeType:n.contentType})}break}default:throw Error(`Unsupported URL protocol: ${e.protocol}`)}}return s}es=dv;var dI="AI_MessageConversionError",dk=`vercel.ai.error.${dI}`,dT=Symbol.for(dk),dE=class extends l6{constructor({originalMessage:e,message:t}){super({name:dI,message:t}),this[en]=!0,this.originalMessage=e}static isInstance(e){return l6.hasMarker(e,dk)}};function dA(e,t){var r,a;let s=null!=(r=null==t?void 0:t.tools)?r:{},n=[];for(let t=0;t<e.length;t++){let r=e[t],i=t===e.length-1,{role:o,content:l,experimental_attachments:u}=r;switch(o){case"system":n.push({role:"system",content:l});break;case"user":if(null==r.parts)n.push({role:"user",content:u?[{type:"text",text:l},...dx(u)]:l});else{let e=r.parts.filter(e=>"text"===e.type).map(e=>({type:"text",text:e.text}));n.push({role:"user",content:u?[...e,...dx(u)]:e})}break;case"assistant":{if(null!=r.parts){let e=function(){let e=[];for(let t of o)switch(t.type){case"file":case"text":e.push(t);break;case"reasoning":for(let r of t.details)switch(r.type){case"text":e.push({type:"reasoning",text:r.text,signature:r.signature});break;case"redacted":e.push({type:"redacted-reasoning",data:r.data})}break;case"tool-invocation":e.push({type:"tool-call",toolCallId:t.toolInvocation.toolCallId,toolName:t.toolInvocation.toolName,args:t.toolInvocation.args});break;default:throw Error(`Unsupported part: ${t}`)}n.push({role:"assistant",content:e});let a=o.filter(e=>"tool-invocation"===e.type).map(e=>e.toolInvocation);a.length>0&&n.push({role:"tool",content:a.map(e=>{if(!("result"in e))throw new dE({originalMessage:r,message:"ToolInvocation must have a result: "+JSON.stringify(e)});let{toolCallId:t,toolName:a,result:n}=e,i=s[a];return(null==i?void 0:i.experimental_toToolResultContent)!=null?{type:"tool-result",toolCallId:t,toolName:a,result:i.experimental_toToolResultContent(n),experimental_content:i.experimental_toToolResultContent(n)}:{type:"tool-result",toolCallId:t,toolName:a,result:n}})}),o=[],i=!1,t++},t=0,i=!1,o=[];for(let s of r.parts)switch(s.type){case"text":i&&e(),o.push(s);break;case"file":case"reasoning":o.push(s);break;case"tool-invocation":(null!=(a=s.toolInvocation.step)?a:0)!==t&&e(),o.push(s),i=!0}e();break}let e=r.toolInvocations;if(null==e||0===e.length){n.push({role:"assistant",content:l});break}let t=e.reduce((e,t)=>{var r;return Math.max(e,null!=(r=t.step)?r:0)},0);for(let a=0;a<=t;a++){let t=e.filter(e=>{var t;return(null!=(t=e.step)?t:0)===a});0!==t.length&&(n.push({role:"assistant",content:[...i&&l&&0===a?[{type:"text",text:l}]:[],...t.map(({toolCallId:e,toolName:t,args:r})=>({type:"tool-call",toolCallId:e,toolName:t,args:r}))]}),n.push({role:"tool",content:t.map(e=>{if(!("result"in e))throw new dE({originalMessage:r,message:"ToolInvocation must have a result: "+JSON.stringify(e)});let{toolCallId:t,toolName:a,result:n}=e,i=s[a];return(null==i?void 0:i.experimental_toToolResultContent)!=null?{type:"tool-result",toolCallId:t,toolName:a,result:i.experimental_toToolResultContent(n),experimental_content:i.experimental_toToolResultContent(n)}:{type:"tool-result",toolCallId:t,toolName:a,result:n}})}))}l&&!i&&n.push({role:"assistant",content:l});break}case"data":break;default:throw new dE({originalMessage:r,message:`Unsupported role: ${o}`})}}return n}en=dT;var dO=rb.z.lazy(()=>rb.z.union([rb.z.null(),rb.z.string(),rb.z.number(),rb.z.boolean(),rb.z.record(rb.z.string(),dO),rb.z.array(dO)])),dC=rb.z.record(rb.z.string(),rb.z.record(rb.z.string(),dO)),dR=rb.z.array(rb.z.union([rb.z.object({type:rb.z.literal("text"),text:rb.z.string()}),rb.z.object({type:rb.z.literal("image"),data:rb.z.string(),mimeType:rb.z.string().optional()})])),dM=rb.z.object({type:rb.z.literal("text"),text:rb.z.string(),providerOptions:dC.optional(),experimental_providerMetadata:dC.optional()}),dN=rb.z.object({type:rb.z.literal("image"),image:rb.z.union([dh,rb.z.instanceof(URL)]),mimeType:rb.z.string().optional(),providerOptions:dC.optional(),experimental_providerMetadata:dC.optional()}),dj=rb.z.object({type:rb.z.literal("file"),data:rb.z.union([dh,rb.z.instanceof(URL)]),filename:rb.z.string().optional(),mimeType:rb.z.string(),providerOptions:dC.optional(),experimental_providerMetadata:dC.optional()}),dP=rb.z.object({type:rb.z.literal("reasoning"),text:rb.z.string(),providerOptions:dC.optional(),experimental_providerMetadata:dC.optional()}),d$=rb.z.object({type:rb.z.literal("redacted-reasoning"),data:rb.z.string(),providerOptions:dC.optional(),experimental_providerMetadata:dC.optional()}),dD=rb.z.object({type:rb.z.literal("tool-call"),toolCallId:rb.z.string(),toolName:rb.z.string(),args:rb.z.unknown(),providerOptions:dC.optional(),experimental_providerMetadata:dC.optional()}),dL=rb.z.object({type:rb.z.literal("tool-result"),toolCallId:rb.z.string(),toolName:rb.z.string(),result:rb.z.unknown(),content:dR.optional(),isError:rb.z.boolean().optional(),providerOptions:dC.optional(),experimental_providerMetadata:dC.optional()}),dU=rb.z.object({role:rb.z.literal("system"),content:rb.z.string(),providerOptions:dC.optional(),experimental_providerMetadata:dC.optional()}),dz=rb.z.object({role:rb.z.literal("user"),content:rb.z.union([rb.z.string(),rb.z.array(rb.z.union([dM,dN,dj]))]),providerOptions:dC.optional(),experimental_providerMetadata:dC.optional()}),dq=rb.z.object({role:rb.z.literal("assistant"),content:rb.z.union([rb.z.string(),rb.z.array(rb.z.union([dM,dj,dP,d$,dD]))]),providerOptions:dC.optional(),experimental_providerMetadata:dC.optional()}),dV=rb.z.object({role:rb.z.literal("tool"),content:rb.z.array(dL),providerOptions:dC.optional(),experimental_providerMetadata:dC.optional()}),dF=rb.z.union([dU,dz,dq,dV]);function dZ({prompt:e,tools:t}){if(null==e.prompt&&null==e.messages)throw new ud({prompt:e,message:"prompt or messages must be defined"});if(null!=e.prompt&&null!=e.messages)throw new ud({prompt:e,message:"prompt and messages cannot be defined at the same time"});if(null!=e.system&&"string"!=typeof e.system)throw new ud({prompt:e,message:"system must be a string"});if(null!=e.prompt){if("string"!=typeof e.prompt)throw new ud({prompt:e,message:"prompt must be a string"});return{type:"prompt",system:e.system,messages:[{role:"user",content:e.prompt}]}}if(null!=e.messages){let r="ui-messages"===function(e){if(!Array.isArray(e))throw new ud({prompt:e,message:`messages must be an array of CoreMessage or UIMessage
Received non-array value: ${JSON.stringify(e)}`,cause:e});if(0===e.length)return"messages";let t=e.map(dW);if(t.some(e=>"has-ui-specific-parts"===e))return"ui-messages";let r=t.findIndex(e=>"has-core-specific-parts"!==e&&"message"!==e);if(-1===r)return"messages";throw new ud({prompt:e,message:`messages must be an array of CoreMessage or UIMessage
Received message of type: "${t[r]}" at index ${r}
messages[${r}]: ${JSON.stringify(e[r])}`,cause:e})}(e.messages)?dA(e.messages,{tools:t}):e.messages;if(0===r.length)throw new ud({prompt:e,message:"messages must not be empty"});let a=uO({value:r,schema:rb.z.array(dF)});if(!a.success)throw new ud({prompt:e,message:`message must be a CoreMessage or a UI message
Validation error: ${a.error.message}`,cause:a.error});return{type:"messages",messages:r,system:e.system}}throw Error("unreachable")}function dW(e){return"object"==typeof e&&null!==e&&("function"===e.role||"data"===e.role||"toolInvocations"in e||"parts"in e||"experimental_attachments"in e)?"has-ui-specific-parts":"object"==typeof e&&null!==e&&"content"in e&&(Array.isArray(e.content)||"experimental_providerMetadata"in e||"providerOptions"in e)?"has-core-specific-parts":"object"==typeof e&&null!==e&&"role"in e&&"content"in e&&"string"==typeof e.content&&["system","user","assistant","tool"].includes(e.role)?"message":"other"}function dG({promptTokens:e,completionTokens:t}){return{promptTokens:e,completionTokens:t,totalTokens:e+t}}function dB(e,t){return{promptTokens:e.promptTokens+t.promptTokens,completionTokens:e.completionTokens+t.completionTokens,totalTokens:e.totalTokens+t.totalTokens}}function dK({prompt:e,schema:t,schemaPrefix:r=null!=t?"JSON schema:":void 0,schemaSuffix:a=null!=t?"You MUST answer with a JSON object that matches the JSON schema above.":"You MUST answer with JSON."}){return[null!=e&&e.length>0?e:void 0,null!=e&&e.length>0?"":void 0,r,null!=t?JSON.stringify(t):void 0,a].filter(e=>null!=e).join("\n")}function dJ(e){let t=e.pipeThrough(new TransformStream);return t[Symbol.asyncIterator]=()=>{let e=t.getReader();return{async next(){let{done:t,value:r}=await e.read();return t?{done:!0,value:void 0}:{done:!1,value:r}}}},t}var dH={type:"no-schema",jsonSchema:void 0,validatePartialResult:({value:e,textDelta:t})=>({success:!0,value:{partial:e,textDelta:t}}),validateFinalResult:(e,t)=>void 0===e?{success:!1,error:new dr({message:"No object generated: response did not match schema.",text:t.text,response:t.response,usage:t.usage,finishReason:t.finishReason})}:{success:!0,value:e},createElementStream(){throw new uS({functionality:"element streams in no-schema mode"})}};function dY({output:e,schema:t,enumValues:r}){switch(e){case"object":let a;return{type:"object",jsonSchema:(a=nw(t)).jsonSchema,validatePartialResult:({value:e,textDelta:t})=>({success:!0,value:{partial:e,textDelta:t}}),validateFinalResult:e=>uO({value:e,schema:a}),createElementStream(){throw new uS({functionality:"element streams in object mode"})}};case"array":return(e=>{let{$schema:t,...r}=e.jsonSchema;return{type:"enum",jsonSchema:{$schema:"http://json-schema.org/draft-07/schema#",type:"object",properties:{elements:{type:"array",items:r}},required:["elements"],additionalProperties:!1},validatePartialResult({value:t,latestObject:r,isFirstDelta:a,isFinalDelta:s}){var n;if(!uk(t)||!uI(t.elements))return{success:!1,error:new uv({value:t,cause:"value must be an object that contains an array of elements"})};let i=t.elements,o=[];for(let t=0;t<i.length;t++){let r=uO({value:i[t],schema:e});if(t!==i.length-1||s){if(!r.success)return r;o.push(r.value)}}let l=null!=(n=null==r?void 0:r.length)?n:0,u="";return a&&(u+="["),l>0&&(u+=","),u+=o.slice(l).map(e=>JSON.stringify(e)).join(","),s&&(u+="]"),{success:!0,value:{partial:o,textDelta:u}}},validateFinalResult(t){if(!uk(t)||!uI(t.elements))return{success:!1,error:new uv({value:t,cause:"value must be an object that contains an array of elements"})};let r=t.elements;for(let t of r){let r=uO({value:t,schema:e});if(!r.success)return r}return{success:!0,value:r}},createElementStream(e){let t=0;return dJ(e.pipeThrough(new TransformStream({transform(e,r){switch(e.type){case"object":{let a=e.object;for(;t<a.length;t++)r.enqueue(a[t]);break}case"text-delta":case"finish":case"error":break;default:throw Error(`Unsupported chunk type: ${e}`)}}})))}}})(nw(t));case"enum":return{type:"enum",jsonSchema:{$schema:"http://json-schema.org/draft-07/schema#",type:"object",properties:{result:{type:"string",enum:r}},required:["result"],additionalProperties:!1},validateFinalResult(e){if(!uk(e)||"string"!=typeof e.result)return{success:!1,error:new uv({value:e,cause:'value must be an object that contains a string in the "result" property.'})};let t=e.result;return r.includes(t)?{success:!0,value:t}:{success:!1,error:new uv({value:e,cause:"value must be a string in the enum"})}},validatePartialResult(){throw new uS({functionality:"partial results in enum mode"})},createElementStream(){throw new uS({functionality:"element streams in enum mode"})}};case"no-schema":return dH;default:throw Error(`Unsupported output: ${e}`)}}function dQ({output:e,mode:t,schema:r,schemaName:a,schemaDescription:s,enumValues:n}){if(null!=e&&"object"!==e&&"array"!==e&&"enum"!==e&&"no-schema"!==e)throw new uZ({parameter:"output",value:e,message:"Invalid output type."});if("no-schema"===e){if("auto"===t||"tool"===t)throw new uZ({parameter:"mode",value:t,message:'Mode must be "json" for no-schema output.'});if(null!=r)throw new uZ({parameter:"schema",value:r,message:"Schema is not supported for no-schema output."});if(null!=s)throw new uZ({parameter:"schemaDescription",value:s,message:"Schema description is not supported for no-schema output."});if(null!=a)throw new uZ({parameter:"schemaName",value:a,message:"Schema name is not supported for no-schema output."});if(null!=n)throw new uZ({parameter:"enumValues",value:n,message:"Enum values are not supported for no-schema output."})}if("object"===e){if(null==r)throw new uZ({parameter:"schema",value:r,message:"Schema is required for object output."});if(null!=n)throw new uZ({parameter:"enumValues",value:n,message:"Enum values are not supported for object output."})}if("array"===e){if(null==r)throw new uZ({parameter:"schema",value:r,message:"Element schema is required for array output."});if(null!=n)throw new uZ({parameter:"enumValues",value:n,message:"Enum values are not supported for array output."})}if("enum"===e){if(null!=r)throw new uZ({parameter:"schema",value:r,message:"Schema is not supported for enum output."});if(null!=s)throw new uZ({parameter:"schemaDescription",value:s,message:"Schema description is not supported for enum output."});if(null!=a)throw new uZ({parameter:"schemaName",value:a,message:"Schema name is not supported for enum output."});if(null==n)throw new uZ({parameter:"enumValues",value:n,message:"Enum values are required for enum output."});for(let e of n)if("string"!=typeof e)throw new uZ({parameter:"enumValues",value:e,message:"Enum values must be strings."})}}function dX(e){return JSON.stringify(e.map(e=>({...e,content:"string"==typeof e.content?e.content:e.content.map(d0)})))}function d0(e){return"image"===e.type?{...e,image:e.image instanceof Uint8Array?dm(e.image):e.image}:e}var d1=uE({prefix:"aiobj",size:24});async function d2({model:e,enum:t,schema:r,schemaName:a,schemaDescription:s,mode:n,output:i="object",system:o,prompt:l,messages:u,maxRetries:d,abortSignal:p,headers:c,experimental_repairText:h,experimental_telemetry:m,experimental_providerMetadata:g,providerOptions:f=g,_internal:{generateId:y=d1,currentDate:v=()=>new Date}={},...b}){if("string"==typeof e||"v1"!==e.specificationVersion)throw new uz;dQ({output:i,mode:n,schema:r,schemaName:a,schemaDescription:s,enumValues:t});let{maxRetries:w,retry:_}=uH({maxRetries:d}),S=dY({output:i,schema:r,enumValues:t});"no-schema"===S.type&&void 0===n&&(n="json");let I=uQ({model:e,telemetry:m,headers:c,settings:{...b,maxRetries:w}}),k=u2(m);return u4({name:"ai.generateObject",attributes:u3({telemetry:m,attributes:{...uY({operationId:"ai.generateObject",telemetry:m}),...I,"ai.prompt":{input:()=>JSON.stringify({system:o,prompt:l,messages:u})},"ai.schema":null!=S.jsonSchema?{input:()=>JSON.stringify(S.jsonSchema)}:void 0,"ai.schema.name":a,"ai.schema.description":s,"ai.settings.output":S.type,"ai.settings.mode":n}}),tracer:k,fn:async t=>{var r,i,d,g;let w,T,E,A,O,C,R,M,N,j;switch(("auto"===n||null==n)&&(n=e.defaultObjectGenerationMode),n){case"json":{let t=dZ({prompt:{system:null==S.jsonSchema?dK({prompt:o}):e.supportsStructuredOutputs?o:dK({prompt:o,schema:S.jsonSchema}),prompt:l,messages:u},tools:void 0}),d=await dw({prompt:t,modelSupportsImageUrls:e.supportsImageUrls,modelSupportsUrl:null==(r=e.supportsUrl)?void 0:r.bind(e)}),h=await _(()=>u4({name:"ai.generateObject.doGenerate",attributes:u3({telemetry:m,attributes:{...uY({operationId:"ai.generateObject.doGenerate",telemetry:m}),...I,"ai.prompt.format":{input:()=>t.type},"ai.prompt.messages":{input:()=>JSON.stringify(d)},"ai.settings.mode":n,"gen_ai.system":e.provider,"gen_ai.request.model":e.modelId,"gen_ai.request.frequency_penalty":b.frequencyPenalty,"gen_ai.request.max_tokens":b.maxTokens,"gen_ai.request.presence_penalty":b.presencePenalty,"gen_ai.request.temperature":b.temperature,"gen_ai.request.top_k":b.topK,"gen_ai.request.top_p":b.topP}}),tracer:k,fn:async r=>{var n,i,o,l,u,h;let g=await e.doGenerate({mode:{type:"object-json",schema:S.jsonSchema,name:a,description:s},...dS(b),inputFormat:t.type,prompt:d,providerMetadata:f,abortSignal:p,headers:c}),w={id:null!=(i=null==(n=g.response)?void 0:n.id)?i:y(),timestamp:null!=(l=null==(o=g.response)?void 0:o.timestamp)?l:v(),modelId:null!=(h=null==(u=g.response)?void 0:u.modelId)?h:e.modelId};if(void 0===g.text)throw new dr({message:"No object generated: the model did not return a response.",response:w,usage:dG(g.usage),finishReason:g.finishReason});return r.setAttributes(u3({telemetry:m,attributes:{"ai.response.finishReason":g.finishReason,"ai.response.object":{output:()=>g.text},"ai.response.id":w.id,"ai.response.model":w.modelId,"ai.response.timestamp":w.timestamp.toISOString(),"ai.response.providerMetadata":JSON.stringify(g.providerMetadata),"ai.usage.promptTokens":g.usage.promptTokens,"ai.usage.completionTokens":g.usage.completionTokens,"gen_ai.response.finish_reasons":[g.finishReason],"gen_ai.response.id":w.id,"gen_ai.response.model":w.modelId,"gen_ai.usage.prompt_tokens":g.usage.promptTokens,"gen_ai.usage.completion_tokens":g.usage.completionTokens}})),{...g,objectText:g.text,responseData:w}}}));w=h.objectText,T=h.finishReason,E=h.usage,A=h.warnings,O=h.rawResponse,M=h.logprobs,N=h.providerMetadata,R=null!=(i=h.request)?i:{},C=h.responseData;break}case"tool":{let t=dZ({prompt:{system:o,prompt:l,messages:u},tools:void 0}),r=await dw({prompt:t,modelSupportsImageUrls:e.supportsImageUrls,modelSupportsUrl:null==(d=e.supportsUrl)?void 0:d.bind(e)}),i=t.type,h=await _(()=>u4({name:"ai.generateObject.doGenerate",attributes:u3({telemetry:m,attributes:{...uY({operationId:"ai.generateObject.doGenerate",telemetry:m}),...I,"ai.prompt.format":{input:()=>i},"ai.prompt.messages":{input:()=>dX(r)},"ai.settings.mode":n,"gen_ai.system":e.provider,"gen_ai.request.model":e.modelId,"gen_ai.request.frequency_penalty":b.frequencyPenalty,"gen_ai.request.max_tokens":b.maxTokens,"gen_ai.request.presence_penalty":b.presencePenalty,"gen_ai.request.temperature":b.temperature,"gen_ai.request.top_k":b.topK,"gen_ai.request.top_p":b.topP}}),tracer:k,fn:async t=>{var n,o,l,u,d,h,g,w;let _=await e.doGenerate({mode:{type:"object-tool",tool:{type:"function",name:null!=a?a:"json",description:null!=s?s:"Respond with a JSON object.",parameters:S.jsonSchema}},...dS(b),inputFormat:i,prompt:r,providerMetadata:f,abortSignal:p,headers:c}),I=null==(o=null==(n=_.toolCalls)?void 0:n[0])?void 0:o.args,k={id:null!=(u=null==(l=_.response)?void 0:l.id)?u:y(),timestamp:null!=(h=null==(d=_.response)?void 0:d.timestamp)?h:v(),modelId:null!=(w=null==(g=_.response)?void 0:g.modelId)?w:e.modelId};if(void 0===I)throw new dr({message:"No object generated: the tool was not called.",response:k,usage:dG(_.usage),finishReason:_.finishReason});return t.setAttributes(u3({telemetry:m,attributes:{"ai.response.finishReason":_.finishReason,"ai.response.object":{output:()=>I},"ai.response.id":k.id,"ai.response.model":k.modelId,"ai.response.timestamp":k.timestamp.toISOString(),"ai.response.providerMetadata":JSON.stringify(_.providerMetadata),"ai.usage.promptTokens":_.usage.promptTokens,"ai.usage.completionTokens":_.usage.completionTokens,"gen_ai.response.finish_reasons":[_.finishReason],"gen_ai.response.id":k.id,"gen_ai.response.model":k.modelId,"gen_ai.usage.input_tokens":_.usage.promptTokens,"gen_ai.usage.output_tokens":_.usage.completionTokens}})),{..._,objectText:I,responseData:k}}}));w=h.objectText,T=h.finishReason,E=h.usage,A=h.warnings,O=h.rawResponse,M=h.logprobs,N=h.providerMetadata,R=null!=(g=h.request)?g:{},C=h.responseData;break}case void 0:throw Error("Model does not have a default object generation mode.");default:{let e=n;throw Error(`Unsupported mode: ${e}`)}}function P(e){let t=uC({text:e});if(!t.success)throw new dr({message:"No object generated: could not parse the response.",cause:t.error,text:e,response:C,usage:dG(E),finishReason:T});let r=S.validateFinalResult(t.value,{text:e,response:C,usage:dG(E)});if(!r.success)throw new dr({message:"No object generated: response did not match schema.",cause:r.error,text:e,response:C,usage:dG(E),finishReason:T});return r.value}try{j=P(w)}catch(e){if(null!=h&&dr.isInstance(e)&&(um.isInstance(e.cause)||uv.isInstance(e.cause))){let t=await h({text:w,error:e.cause});if(null===t)throw e;j=P(t)}else throw e}return t.setAttributes(u3({telemetry:m,attributes:{"ai.response.finishReason":T,"ai.response.object":{output:()=>JSON.stringify(j)},"ai.usage.promptTokens":E.promptTokens,"ai.usage.completionTokens":E.completionTokens}})),new d4({object:j,finishReason:T,usage:dG(E),warnings:A,request:R,response:{...C,headers:null==O?void 0:O.headers,body:null==O?void 0:O.body},logprobs:M,providerMetadata:N})}})}var d4=class{constructor(e){this.object=e.object,this.finishReason=e.finishReason,this.usage=e.usage,this.warnings=e.warnings,this.providerMetadata=e.providerMetadata,this.experimental_providerMetadata=e.providerMetadata,this.response=e.response,this.request=e.request,this.logprobs=e.logprobs}toJsonResponse(e){var t;return new Response(JSON.stringify(this.object),{status:null!=(t=null==e?void 0:e.status)?t:200,headers:uD(null==e?void 0:e.headers,{contentType:"application/json; charset=utf-8"})})}},d5=class{constructor(){this.status={type:"pending"},this._resolve=void 0,this._reject=void 0}get value(){return this.promise||(this.promise=new Promise((e,t)=>{"resolved"===this.status.type?e(this.status.value):"rejected"===this.status.type&&t(this.status.error),this._resolve=e,this._reject=t})),this.promise}resolve(e){var t;this.status={type:"resolved",value:e},this.promise&&(null==(t=this._resolve)||t.call(this,e))}reject(e){var t;this.status={type:"rejected",error:e},this.promise&&(null==(t=this._reject)||t.call(this,e))}};function d3(){let e,t;return{promise:new Promise((r,a)=>{e=r,t=a}),resolve:e,reject:t}}function d9(){let e=[],t=null,r=!1,a=d3(),s=async()=>{if(r&&0===e.length){null==t||t.close();return}if(0===e.length)return a=d3(),await a.promise,s();try{let{value:a,done:n}=await e[0].read();n?(e.shift(),e.length>0?await s():r&&(null==t||t.close())):null==t||t.enqueue(a)}catch(a){null==t||t.error(a),e.shift(),r&&0===e.length&&(null==t||t.close())}};return{stream:new ReadableStream({start(e){t=e},pull:s,async cancel(){for(let t of e)await t.cancel();e=[],r=!0}}),addStream:t=>{if(r)throw Error("Cannot add inner stream: outer stream is closed");e.push(t.getReader()),a.resolve()},close:()=>{r=!0,a.resolve(),0===e.length&&(null==t||t.close())},terminate:()=>{r=!0,a.resolve(),e.forEach(e=>e.cancel()),e=[],null==t||t.close()}}}function d6(){var e,t;return null!=(t=null==(e=null==globalThis?void 0:globalThis.performance)?void 0:e.now())?t:Date.now()}var d8=uE({prefix:"aiobj",size:24}),d7=class{constructor({model:e,headers:t,telemetry:r,settings:a,maxRetries:s,abortSignal:n,outputStrategy:i,system:o,prompt:l,messages:u,schemaName:d,schemaDescription:p,providerOptions:c,mode:h,onError:m,onFinish:g,generateId:f,currentDate:y,now:v}){this.objectPromise=new d5,this.usagePromise=new d5,this.providerMetadataPromise=new d5,this.warningsPromise=new d5,this.requestPromise=new d5,this.responsePromise=new d5;const{maxRetries:b,retry:w}=uH({maxRetries:s}),_=uQ({model:e,telemetry:r,headers:t,settings:{...a,maxRetries:b}}),S=u2(r),I=this,k=d9(),T=new TransformStream({transform(e,t){t.enqueue(e),"error"===e.type&&(null==m||m({error:e.error}))}});this.baseStream=k.stream.pipeThrough(T),u4({name:"ai.streamObject",attributes:u3({telemetry:r,attributes:{...uY({operationId:"ai.streamObject",telemetry:r}),..._,"ai.prompt":{input:()=>JSON.stringify({system:o,prompt:l,messages:u})},"ai.schema":null!=i.jsonSchema?{input:()=>JSON.stringify(i.jsonSchema)}:void 0,"ai.schema.name":d,"ai.schema.description":p,"ai.settings.output":i.type,"ai.settings.mode":h}}),tracer:S,endWhenDone:!1,fn:async s=>{var m,b;let T,E,A,O,C,R,M,N,j;switch(("auto"===h||null==h)&&(h=e.defaultObjectGenerationMode),h){case"json":{let r=dZ({prompt:{system:null==i.jsonSchema?dK({prompt:o}):e.supportsStructuredOutputs?o:dK({prompt:o,schema:i.jsonSchema}),prompt:l,messages:u},tools:void 0});T={mode:{type:"object-json",schema:i.jsonSchema,name:d,description:p},...dS(a),inputFormat:r.type,prompt:await dw({prompt:r,modelSupportsImageUrls:e.supportsImageUrls,modelSupportsUrl:null==(m=e.supportsUrl)?void 0:m.bind(e)}),providerMetadata:c,abortSignal:n,headers:t},E={transform:(e,t)=>{switch(e.type){case"text-delta":t.enqueue(e.textDelta);break;case"response-metadata":case"finish":case"error":t.enqueue(e)}}};break}case"tool":{let r=dZ({prompt:{system:o,prompt:l,messages:u},tools:void 0});T={mode:{type:"object-tool",tool:{type:"function",name:null!=d?d:"json",description:null!=p?p:"Respond with a JSON object.",parameters:i.jsonSchema}},...dS(a),inputFormat:r.type,prompt:await dw({prompt:r,modelSupportsImageUrls:e.supportsImageUrls,modelSupportsUrl:null==(b=e.supportsUrl)?void 0:b.bind(e)}),providerMetadata:c,abortSignal:n,headers:t},E={transform(e,t){switch(e.type){case"tool-call-delta":t.enqueue(e.argsTextDelta);break;case"response-metadata":case"finish":case"error":t.enqueue(e)}}};break}case void 0:throw Error("Model does not have a default object generation mode.");default:{let e=h;throw Error(`Unsupported mode: ${e}`)}}let{result:{stream:P,warnings:$,rawResponse:D,request:L},doStreamSpan:U,startTimestampMs:z}=await w(()=>u4({name:"ai.streamObject.doStream",attributes:u3({telemetry:r,attributes:{...uY({operationId:"ai.streamObject.doStream",telemetry:r}),..._,"ai.prompt.format":{input:()=>T.inputFormat},"ai.prompt.messages":{input:()=>dX(T.prompt)},"ai.settings.mode":h,"gen_ai.system":e.provider,"gen_ai.request.model":e.modelId,"gen_ai.request.frequency_penalty":a.frequencyPenalty,"gen_ai.request.max_tokens":a.maxTokens,"gen_ai.request.presence_penalty":a.presencePenalty,"gen_ai.request.temperature":a.temperature,"gen_ai.request.top_k":a.topK,"gen_ai.request.top_p":a.topP}}),tracer:S,endWhenDone:!1,fn:async t=>({startTimestampMs:v(),doStreamSpan:t,result:await e.doStream(T)})}));I.requestPromise.resolve(null!=L?L:{});let q="",V="",F={id:f(),timestamp:y(),modelId:e.modelId},Z=!0,W=!0,G=P.pipeThrough(new TransformStream(E)).pipeThrough(new TransformStream({async transform(e,t){var r,a,s;if(Z){let e=v()-z;Z=!1,U.addEvent("ai.stream.firstChunk",{"ai.stream.msToFirstChunk":e}),U.setAttributes({"ai.stream.msToFirstChunk":e})}if("string"==typeof e){q+=e,V+=e;let{value:r,state:a}=nm(q);if(void 0!==r&&!ny(N,r)){let e=i.validatePartialResult({value:r,textDelta:V,latestObject:j,isFirstDelta:W,isFinalDelta:"successful-parse"===a});e.success&&!ny(j,e.value.partial)&&(N=r,j=e.value.partial,t.enqueue({type:"object",object:j}),t.enqueue({type:"text-delta",textDelta:e.value.textDelta}),V="",W=!1)}return}switch(e.type){case"response-metadata":F={id:null!=(r=e.id)?r:F.id,timestamp:null!=(a=e.timestamp)?a:F.timestamp,modelId:null!=(s=e.modelId)?s:F.modelId};break;case"finish":{""!==V&&t.enqueue({type:"text-delta",textDelta:V}),O=e.finishReason,A=dG(e.usage),C=e.providerMetadata,t.enqueue({...e,usage:A,response:F}),I.usagePromise.resolve(A),I.providerMetadataPromise.resolve(C),I.responsePromise.resolve({...F,headers:null==D?void 0:D.headers});let r=i.validateFinalResult(N,{text:q,response:F,usage:A});r.success?(R=r.value,I.objectPromise.resolve(R)):(M=new dr({message:"No object generated: response did not match schema.",cause:r.error,text:q,response:F,usage:A,finishReason:O}),I.objectPromise.reject(M));break}default:t.enqueue(e)}},async flush(e){try{let e=null!=A?A:{promptTokens:NaN,completionTokens:NaN,totalTokens:NaN};U.setAttributes(u3({telemetry:r,attributes:{"ai.response.finishReason":O,"ai.response.object":{output:()=>JSON.stringify(R)},"ai.response.id":F.id,"ai.response.model":F.modelId,"ai.response.timestamp":F.timestamp.toISOString(),"ai.response.providerMetadata":JSON.stringify(C),"ai.usage.promptTokens":e.promptTokens,"ai.usage.completionTokens":e.completionTokens,"gen_ai.response.finish_reasons":[O],"gen_ai.response.id":F.id,"gen_ai.response.model":F.modelId,"gen_ai.usage.input_tokens":e.promptTokens,"gen_ai.usage.output_tokens":e.completionTokens}})),U.end(),s.setAttributes(u3({telemetry:r,attributes:{"ai.usage.promptTokens":e.promptTokens,"ai.usage.completionTokens":e.completionTokens,"ai.response.object":{output:()=>JSON.stringify(R)},"ai.response.providerMetadata":JSON.stringify(C)}})),await (null==g?void 0:g({usage:e,object:R,error:M,response:{...F,headers:null==D?void 0:D.headers},warnings:$,providerMetadata:C,experimental_providerMetadata:C}))}catch(t){e.enqueue({type:"error",error:t})}finally{s.end()}}}));k.addStream(G)}}).catch(e=>{k.addStream(new ReadableStream({start(t){t.enqueue({type:"error",error:e}),t.close()}}))}).finally(()=>{k.close()}),this.outputStrategy=i}get object(){return this.objectPromise.value}get usage(){return this.usagePromise.value}get experimental_providerMetadata(){return this.providerMetadataPromise.value}get providerMetadata(){return this.providerMetadataPromise.value}get warnings(){return this.warningsPromise.value}get request(){return this.requestPromise.value}get response(){return this.responsePromise.value}get partialObjectStream(){return dJ(this.baseStream.pipeThrough(new TransformStream({transform(e,t){switch(e.type){case"object":t.enqueue(e.object);break;case"text-delta":case"finish":case"error":break;default:throw Error(`Unsupported chunk type: ${e}`)}}})))}get elementStream(){return this.outputStrategy.createElementStream(this.baseStream)}get textStream(){return dJ(this.baseStream.pipeThrough(new TransformStream({transform(e,t){switch(e.type){case"text-delta":t.enqueue(e.textDelta);break;case"object":case"finish":case"error":break;default:throw Error(`Unsupported chunk type: ${e}`)}}})))}get fullStream(){return dJ(this.baseStream)}pipeTextStreamToResponse(e,t){uU({response:e,status:null==t?void 0:t.status,statusText:null==t?void 0:t.statusText,headers:uL(null==t?void 0:t.headers,{contentType:"text/plain; charset=utf-8"}),stream:this.textStream.pipeThrough(new TextEncoderStream)})}toTextStreamResponse(e){var t;return new Response(this.textStream.pipeThrough(new TextEncoderStream),{status:null!=(t=null==e?void 0:e.status)?t:200,headers:uD(null==e?void 0:e.headers,{contentType:"text/plain; charset=utf-8"})})}},pe="AI_NoOutputSpecifiedError",pt=`vercel.ai.error.${pe}`,pr=Symbol.for(pt),pa=class extends l6{constructor({message:e="No output specified."}={}){super({name:pe,message:e}),this[ei]=!0}static isInstance(e){return l6.hasMarker(e,pt)}};ei=pr;var ps="AI_ToolExecutionError",pn=`vercel.ai.error.${ps}`,pi=Symbol.for(pn),po=class extends l6{constructor({toolArgs:e,toolName:t,toolCallId:r,cause:a,message:s=`Error executing tool ${t}: ${ur(a)}`}){super({name:ps,message:s,cause:a}),this[eo]=!0,this.toolArgs=e,this.toolName=t,this.toolCallId=r}static isInstance(e){return l6.hasMarker(e,pn)}};function pl({tools:e,toolChoice:t,activeTools:r}){return null!=e&&Object.keys(e).length>0?{tools:(null!=r?Object.entries(e).filter(([e])=>r.includes(e)):Object.entries(e)).map(([e,t])=>{let r=t.type;switch(r){case void 0:case"function":return{type:"function",name:e,description:t.description,parameters:nw(t.parameters).jsonSchema};case"provider-defined":return{type:"provider-defined",name:e,id:t.id,args:t.args};default:throw Error(`Unsupported tool type: ${r}`)}}),toolChoice:null==t?{type:"auto"}:"string"==typeof t?{type:t}:{type:"tool",toolName:t.toolName}}:{tools:void 0,toolChoice:void 0}}eo=pi;var pu=/^([\s\S]*?)(\s+)(\S*)$/;function pd(e){let t=e.match(pu);return t?{prefix:t[1],whitespace:t[2],suffix:t[3]}:void 0}var pp="AI_InvalidToolArgumentsError",pc=`vercel.ai.error.${pp}`,ph=Symbol.for(pc),pm=class extends l6{constructor({toolArgs:e,toolName:t,cause:r,message:a=`Invalid arguments for tool ${t}: ${ur(r)}`}){super({name:pp,message:a,cause:r}),this[el]=!0,this.toolArgs=e,this.toolName=t}static isInstance(e){return l6.hasMarker(e,pc)}};el=ph;var pg="AI_NoSuchToolError",pf=`vercel.ai.error.${pg}`,py=Symbol.for(pf),pv=class extends l6{constructor({toolName:e,availableTools:t,message:r=`Model tried to call unavailable tool '${e}'. ${void 0===t?"No tools are available.":`Available tools: ${t.join(", ")}.`}`}){super({name:pg,message:r}),this[eu]=!0,this.toolName=e,this.availableTools=t}static isInstance(e){return l6.hasMarker(e,pf)}};eu=py;var pb="AI_ToolCallRepairError",pw=`vercel.ai.error.${pb}`,p_=Symbol.for(pw),pS=class extends l6{constructor({cause:e,originalError:t,message:r=`Error repairing tool call: ${ur(e)}`}){super({name:pb,message:r,cause:e}),this[ed]=!0,this.originalError=t}static isInstance(e){return l6.hasMarker(e,pw)}};async function px({toolCall:e,tools:t,repairToolCall:r,system:a,messages:s}){if(null==t)throw new pv({toolName:e.toolName});try{return await pI({toolCall:e,tools:t})}catch(i){if(null==r||!(pv.isInstance(i)||pm.isInstance(i)))throw i;let n=null;try{n=await r({toolCall:e,tools:t,parameterSchema:({toolName:e})=>nw(t[e].parameters).jsonSchema,system:a,messages:s,error:i})}catch(e){throw new pS({cause:e,originalError:i})}if(null==n)throw i;return await pI({toolCall:n,tools:t})}}async function pI({toolCall:e,tools:t}){let r=e.toolName,a=t[r];if(null==a)throw new pv({toolName:e.toolName,availableTools:Object.keys(t)});let s=nw(a.parameters),n=""===e.args.trim()?uO({value:{},schema:s}):uC({text:e.args,schema:s});if(!1===n.success)throw new pm({toolName:r,toolArgs:e.args,cause:n.error});return{type:"tool-call",toolCallId:e.toolCallId,toolName:r,args:n.value}}function pk(e){let t=e.filter(e=>"text"===e.type).map(e=>e.text).join("");return t.length>0?t:void 0}function pT({text:e="",files:t,reasoning:r,tools:a,toolCalls:s,toolResults:n,messageId:i,generateMessageId:o}){let l=[],u=[];return r.length>0&&u.push(...r.map(e=>"text"===e.type?{...e,type:"reasoning"}:{...e,type:"redacted-reasoning"})),t.length>0&&u.push(...t.map(e=>({type:"file",data:e.base64,mimeType:e.mimeType}))),e.length>0&&u.push({type:"text",text:e}),s.length>0&&u.push(...s),u.length>0&&l.push({role:"assistant",content:u,id:i}),n.length>0&&l.push({role:"tool",id:o(),content:n.map(e=>{let t=a[e.toolName];return(null==t?void 0:t.experimental_toToolResultContent)!=null?{type:"tool-result",toolCallId:e.toolCallId,toolName:e.toolName,result:t.experimental_toToolResultContent(e.result),experimental_content:t.experimental_toToolResultContent(e.result)}:{type:"tool-result",toolCallId:e.toolCallId,toolName:e.toolName,result:e.result}})}),l}ed=p_;var pE=uE({prefix:"aitxt",size:24}),pA=uE({prefix:"msg",size:24});async function pO({model:e,tools:t,toolChoice:r,system:a,prompt:s,messages:n,maxRetries:i,abortSignal:o,headers:l,maxSteps:u=1,experimental_generateMessageId:d=pA,experimental_output:p,experimental_continueSteps:c=!1,experimental_telemetry:h,experimental_providerMetadata:m,providerOptions:g=m,experimental_activeTools:f,experimental_prepareStep:y,experimental_repairToolCall:v,_internal:{generateId:b=pE,currentDate:w=()=>new Date}={},onStepFinish:_,...S}){var I;if("string"==typeof e||"v1"!==e.specificationVersion)throw new uz;if(u<1)throw new uZ({parameter:"maxSteps",value:u,message:"maxSteps must be at least 1"});let{maxRetries:k,retry:T}=uH({maxRetries:i}),E=uQ({model:e,telemetry:h,headers:l,settings:{...S,maxRetries:k}}),A=dZ({prompt:{system:null!=(I=null==p?void 0:p.injectIntoSystemPrompt({system:a,model:e}))?I:a,prompt:s,messages:n},tools:t}),O=u2(h);return u4({name:"ai.generateText",attributes:u3({telemetry:h,attributes:{...uY({operationId:"ai.generateText",telemetry:h}),...E,"ai.model.provider":e.provider,"ai.model.id":e.modelId,"ai.prompt":{input:()=>JSON.stringify({system:a,prompt:s,messages:n})},"ai.settings.maxSteps":u}}),tracer:O,fn:async s=>{var n,i,m,I,k,C,R,M,N,j,P,$,D,L;let U,z=dS(S),q=[],V=[],F=[],Z=0,W=[],G="",B=[],K=[],J={completionTokens:0,promptTokens:0,totalTokens:0},H="initial";do{let s=0===Z?A.type:"messages",$=[...A.messages,...W],D=await (null==y?void 0:y({model:e,steps:K,maxSteps:u,stepNumber:Z})),L=null!=(n=null==D?void 0:D.toolChoice)?n:r,Y=null!=(i=null==D?void 0:D.experimental_activeTools)?i:f,Q=null!=(m=null==D?void 0:D.model)?m:e,X=await dw({prompt:{type:s,system:A.system,messages:$},modelSupportsImageUrls:Q.supportsImageUrls,modelSupportsUrl:null==(I=Q.supportsUrl)?void 0:I.bind(Q)}),ee={type:"regular",...pl({tools:t,toolChoice:L,activeTools:Y})};U=await T(()=>u4({name:"ai.generateText.doGenerate",attributes:u3({telemetry:h,attributes:{...uY({operationId:"ai.generateText.doGenerate",telemetry:h}),...E,"ai.model.provider":Q.provider,"ai.model.id":Q.modelId,"ai.prompt.format":{input:()=>s},"ai.prompt.messages":{input:()=>dX(X)},"ai.prompt.tools":{input:()=>{var e;return null==(e=ee.tools)?void 0:e.map(e=>JSON.stringify(e))}},"ai.prompt.toolChoice":{input:()=>null!=ee.toolChoice?JSON.stringify(ee.toolChoice):void 0},"gen_ai.system":Q.provider,"gen_ai.request.model":Q.modelId,"gen_ai.request.frequency_penalty":S.frequencyPenalty,"gen_ai.request.max_tokens":S.maxTokens,"gen_ai.request.presence_penalty":S.presencePenalty,"gen_ai.request.stop_sequences":S.stopSequences,"gen_ai.request.temperature":S.temperature,"gen_ai.request.top_k":S.topK,"gen_ai.request.top_p":S.topP}}),tracer:O,fn:async t=>{var r,a,n,i,u,d;let c=await Q.doGenerate({mode:ee,...z,inputFormat:s,responseFormat:null==p?void 0:p.responseFormat({model:e}),prompt:X,providerMetadata:g,abortSignal:o,headers:l}),m={id:null!=(a=null==(r=c.response)?void 0:r.id)?a:b(),timestamp:null!=(i=null==(n=c.response)?void 0:n.timestamp)?i:w(),modelId:null!=(d=null==(u=c.response)?void 0:u.modelId)?d:Q.modelId};return t.setAttributes(u3({telemetry:h,attributes:{"ai.response.finishReason":c.finishReason,"ai.response.text":{output:()=>c.text},"ai.response.toolCalls":{output:()=>JSON.stringify(c.toolCalls)},"ai.response.id":m.id,"ai.response.model":m.modelId,"ai.response.timestamp":m.timestamp.toISOString(),"ai.response.providerMetadata":JSON.stringify(c.providerMetadata),"ai.usage.promptTokens":c.usage.promptTokens,"ai.usage.completionTokens":c.usage.completionTokens,"gen_ai.response.finish_reasons":[c.finishReason],"gen_ai.response.id":m.id,"gen_ai.response.model":m.modelId,"gen_ai.usage.input_tokens":c.usage.promptTokens,"gen_ai.usage.output_tokens":c.usage.completionTokens}})),{...c,response:m}}})),q=await Promise.all((null!=(k=U.toolCalls)?k:[]).map(e=>px({toolCall:e,tools:t,repairToolCall:v,system:a,messages:$}))),V=null==t?[]:await pC({toolCalls:q,tools:t,tracer:O,telemetry:h,messages:$,abortSignal:o});let et=dG(U.usage);J=dB(J,et);let er="done";++Z<u&&(c&&"length"===U.finishReason&&0===q.length?er="continue":q.length>0&&V.length===q.length&&(er="tool-result"));let ea=null!=(C=U.text)?C:"",es="continue"===H&&G.trimEnd()!==G?ea.trimStart():ea,en="continue"===er?function(e){let t=pd(e);return t?t.prefix+t.whitespace:e}(es):es;if(G="continue"===er||"continue"===H?G+en:en,F=pM(U.reasoning),B.push(...null!=(R=U.sources)?R:[]),"continue"===H){let e=W[W.length-1];"string"==typeof e.content?e.content+=en:e.content.push({text:en,type:"text"})}else W.push(...pT({text:G,files:pN(U.files),reasoning:pM(U.reasoning),tools:null!=t?t:{},toolCalls:q,toolResults:V,messageId:d(),generateMessageId:d}));let ei={stepType:H,text:en,reasoning:pk(F),reasoningDetails:F,files:pN(U.files),sources:null!=(M=U.sources)?M:[],toolCalls:q,toolResults:V,finishReason:U.finishReason,usage:et,warnings:U.warnings,logprobs:U.logprobs,request:null!=(N=U.request)?N:{},response:{...U.response,headers:null==(j=U.rawResponse)?void 0:j.headers,body:null==(P=U.rawResponse)?void 0:P.body,messages:structuredClone(W)},providerMetadata:U.providerMetadata,experimental_providerMetadata:U.providerMetadata,isContinued:"continue"===er};K.push(ei),await (null==_?void 0:_(ei)),H=er}while("done"!==H)return s.setAttributes(u3({telemetry:h,attributes:{"ai.response.finishReason":U.finishReason,"ai.response.text":{output:()=>U.text},"ai.response.toolCalls":{output:()=>JSON.stringify(U.toolCalls)},"ai.usage.promptTokens":U.usage.promptTokens,"ai.usage.completionTokens":U.usage.completionTokens,"ai.response.providerMetadata":JSON.stringify(U.providerMetadata)}})),new pR({text:G,files:pN(U.files),reasoning:pk(F),reasoningDetails:F,sources:B,outputResolver:()=>{if(null==p)throw new pa;return p.parseOutput({text:G},{response:U.response,usage:J,finishReason:U.finishReason})},toolCalls:q,toolResults:V,finishReason:U.finishReason,usage:J,warnings:U.warnings,request:null!=($=U.request)?$:{},response:{...U.response,headers:null==(D=U.rawResponse)?void 0:D.headers,body:null==(L=U.rawResponse)?void 0:L.body,messages:W},logprobs:U.logprobs,steps:K,providerMetadata:U.providerMetadata})}})}async function pC({toolCalls:e,tools:t,tracer:r,telemetry:a,messages:s,abortSignal:n}){return(await Promise.all(e.map(async({toolCallId:e,toolName:i,args:o})=>{let l=t[i];if((null==l?void 0:l.execute)==null)return;let u=await u4({name:"ai.toolCall",attributes:u3({telemetry:a,attributes:{...uY({operationId:"ai.toolCall",telemetry:a}),"ai.toolCall.name":i,"ai.toolCall.id":e,"ai.toolCall.args":{output:()=>JSON.stringify(o)}}}),tracer:r,fn:async t=>{try{let r=await l.execute(o,{toolCallId:e,messages:s,abortSignal:n});try{t.setAttributes(u3({telemetry:a,attributes:{"ai.toolCall.result":{output:()=>JSON.stringify(r)}}}))}catch(e){}return r}catch(r){throw u5(t,r),new po({toolCallId:e,toolName:i,toolArgs:o,cause:r})}}});return{type:"tool-result",toolCallId:e,toolName:i,args:o,result:u}}))).filter(e=>null!=e)}var pR=class{constructor(e){this.text=e.text,this.files=e.files,this.reasoning=e.reasoning,this.reasoningDetails=e.reasoningDetails,this.toolCalls=e.toolCalls,this.toolResults=e.toolResults,this.finishReason=e.finishReason,this.usage=e.usage,this.warnings=e.warnings,this.request=e.request,this.response=e.response,this.steps=e.steps,this.experimental_providerMetadata=e.providerMetadata,this.providerMetadata=e.providerMetadata,this.logprobs=e.logprobs,this.outputResolver=e.outputResolver,this.sources=e.sources}get experimental_output(){return this.outputResolver()}};function pM(e){return null==e?[]:"string"==typeof e?[{type:"text",text:e}]:e}function pN(e){var t;return null!=(t=null==e?void 0:e.map(e=>new u9(e)))?t:[]}var pj={};u$(pj,{object:()=>pz,text:()=>pU});var pP="AI_InvalidStreamPartError",p$=`vercel.ai.error.${pP}`,pD=Symbol.for(p$),pL=class extends l6{constructor({chunk:e,message:t}){super({name:pP,message:t}),this[ep]=!0,this.chunk=e}static isInstance(e){return l6.hasMarker(e,p$)}};ep=pD,Symbol.for("vercel.ai.error.AI_MCPClientError");var pU=()=>({type:"text",responseFormat:()=>({type:"text"}),injectIntoSystemPrompt:({system:e})=>e,parsePartial:({text:e})=>({partial:e}),parseOutput:({text:e})=>e}),pz=({schema:e})=>{let t=nw(e);return{type:"object",responseFormat:({model:e})=>({type:"json",schema:e.supportsStructuredOutputs?t.jsonSchema:void 0}),injectIntoSystemPrompt:({system:e,model:r})=>r.supportsStructuredOutputs?e:dK({prompt:e,schema:t.jsonSchema}),parsePartial({text:e}){let t=nm(e);switch(t.state){case"failed-parse":case"undefined-input":return;case"repaired-parse":case"successful-parse":return{partial:t.value};default:{let e=t.state;throw Error(`Unsupported parse state: ${e}`)}}},parseOutput({text:e},r){let a=uC({text:e});if(!a.success)throw new dr({message:"No object generated: could not parse the response.",cause:a.error,text:e,response:r.response,usage:r.usage,finishReason:r.finishReason});let s=uO({value:a.value,schema:t});if(!s.success)throw new dr({message:"No object generated: response did not match schema.",cause:s.error,text:e,response:r.response,usage:r.usage,finishReason:r.finishReason});return s.value}}};async function pq({stream:e,onError:t}){let r=e.getReader();try{for(;;){let{done:e}=await r.read();if(e)break}}catch(e){null==t||t(e)}finally{r.releaseLock()}}function pV(e,t){let r,a,s=e.getReader(),n=t.getReader(),i=!1,o=!1;async function l(e){try{null==r&&(r=s.read());let t=await r;r=void 0,t.done?e.close():e.enqueue(t.value)}catch(t){e.error(t)}}async function u(e){try{null==a&&(a=n.read());let t=await a;a=void 0,t.done?e.close():e.enqueue(t.value)}catch(t){e.error(t)}}return new ReadableStream({async pull(e){try{if(i)return void await u(e);if(o)return void await l(e);null==r&&(r=s.read()),null==a&&(a=n.read());let{result:t,reader:d}=await Promise.race([r.then(e=>({result:e,reader:s})),a.then(e=>({result:e,reader:n}))]);t.done||e.enqueue(t.value),d===s?(r=void 0,t.done&&(await u(e),i=!0)):(a=void 0,t.done&&(o=!0,await l(e)))}catch(t){e.error(t)}},cancel(){s.cancel(),n.cancel()}})}var pF=uE({prefix:"aitxt",size:24}),pZ=uE({prefix:"msg",size:24}),pW=class{constructor({model:e,telemetry:t,headers:r,settings:a,maxRetries:s,abortSignal:n,system:i,prompt:o,messages:l,tools:u,toolChoice:d,toolCallStreaming:p,transforms:c,activeTools:h,repairToolCall:m,maxSteps:g,output:f,continueSteps:y,providerOptions:v,now:b,currentDate:w,generateId:_,generateMessageId:S,onChunk:I,onError:k,onFinish:T,onStepFinish:E}){var A;let O,C,R,M;if(this.warningsPromise=new d5,this.usagePromise=new d5,this.finishReasonPromise=new d5,this.providerMetadataPromise=new d5,this.textPromise=new d5,this.reasoningPromise=new d5,this.reasoningDetailsPromise=new d5,this.sourcesPromise=new d5,this.filesPromise=new d5,this.toolCallsPromise=new d5,this.toolResultsPromise=new d5,this.requestPromise=new d5,this.responsePromise=new d5,this.stepsPromise=new d5,g<1)throw new uZ({parameter:"maxSteps",value:g,message:"maxSteps must be at least 1"});this.output=f;let N="",j="",P="",$=[],D=[],L=[];const U=[],z={id:_(),timestamp:w(),modelId:e.modelId,messages:[]};let q=[],V=[],F="initial";const Z=[],W=new TransformStream({async transform(e,t){t.enqueue(e);let{part:r}=e;if(("text-delta"===r.type||"reasoning"===r.type||"source"===r.type||"tool-call"===r.type||"tool-result"===r.type||"tool-call-streaming-start"===r.type||"tool-call-delta"===r.type)&&await (null==I?void 0:I({chunk:r})),"error"===r.type&&await (null==k?void 0:k({error:r.error})),"text-delta"===r.type&&(N+=r.textDelta,j+=r.textDelta,P+=r.textDelta),"reasoning"===r.type&&(null==C?(C={type:"text",text:r.textDelta},$.push(C)):C.text+=r.textDelta),"reasoning-signature"===r.type){if(null==C)throw new l6({name:"InvalidStreamPart",message:"reasoning-signature without reasoning"});C.signature=r.signature,C=void 0}if("redacted-reasoning"===r.type&&$.push({type:"redacted",data:r.data}),"file"===r.type&&D.push(r),"source"===r.type&&(U.push(r.source),L.push(r.source)),"tool-call"===r.type&&q.push(r),"tool-result"===r.type&&V.push(r),"step-finish"===r.type){let e=pT({text:j,files:D,reasoning:$,tools:null!=u?u:{},toolCalls:q,toolResults:V,messageId:r.messageId,generateMessageId:S}),t=Z.length,a="done";t+1<g&&(y&&"length"===r.finishReason&&0===q.length?a="continue":q.length>0&&V.length===q.length&&(a="tool-result"));let s={stepType:F,text:N,reasoning:pk($),reasoningDetails:$,files:D,sources:L,toolCalls:q,toolResults:V,finishReason:r.finishReason,usage:r.usage,warnings:r.warnings,logprobs:r.logprobs,request:r.request,response:{...r.response,messages:[...z.messages,...e]},providerMetadata:r.experimental_providerMetadata,experimental_providerMetadata:r.experimental_providerMetadata,isContinued:r.isContinued};await (null==E?void 0:E(s)),Z.push(s),q=[],V=[],N="",L=[],$=[],D=[],C=void 0,"done"!==a&&(F=a),"continue"!==a&&(z.messages.push(...e),j="")}"finish"===r.type&&(z.id=r.response.id,z.timestamp=r.response.timestamp,z.modelId=r.response.modelId,z.headers=r.response.headers,M=r.usage,R=r.finishReason)},async flush(e){var r;try{if(0===Z.length)return;let e=Z[Z.length-1];X.warningsPromise.resolve(e.warnings),X.requestPromise.resolve(e.request),X.responsePromise.resolve(e.response),X.toolCallsPromise.resolve(e.toolCalls),X.toolResultsPromise.resolve(e.toolResults),X.providerMetadataPromise.resolve(e.experimental_providerMetadata),X.reasoningPromise.resolve(e.reasoning),X.reasoningDetailsPromise.resolve(e.reasoningDetails);let a=null!=R?R:"unknown",s=null!=M?M:{completionTokens:NaN,promptTokens:NaN,totalTokens:NaN};X.finishReasonPromise.resolve(a),X.usagePromise.resolve(s),X.textPromise.resolve(P),X.sourcesPromise.resolve(U),X.filesPromise.resolve(e.files),X.stepsPromise.resolve(Z),await (null==T?void 0:T({finishReason:a,logprobs:void 0,usage:s,text:P,reasoning:e.reasoning,reasoningDetails:e.reasoningDetails,files:e.files,sources:e.sources,toolCalls:e.toolCalls,toolResults:e.toolResults,request:null!=(r=e.request)?r:{},response:e.response,warnings:e.warnings,providerMetadata:e.providerMetadata,experimental_providerMetadata:e.experimental_providerMetadata,steps:Z})),O.setAttributes(u3({telemetry:t,attributes:{"ai.response.finishReason":a,"ai.response.text":{output:()=>P},"ai.response.toolCalls":{output:()=>{var t;return(null==(t=e.toolCalls)?void 0:t.length)?JSON.stringify(e.toolCalls):void 0}},"ai.usage.promptTokens":s.promptTokens,"ai.usage.completionTokens":s.completionTokens,"ai.response.providerMetadata":JSON.stringify(e.providerMetadata)}}))}catch(t){e.error(t)}finally{O.end()}}}),G=d9();this.addStream=G.addStream,this.closeStream=G.close;let B=G.stream;for(const e of c)B=B.pipeThrough(e({tools:u,stopStream(){G.terminate()}}));this.baseStream=B.pipeThrough(function(e){if(!e)return new TransformStream({transform(e,t){t.enqueue({part:e,partialOutput:void 0})}});let t="",r="",a="";function s({controller:e,partialOutput:t}){e.enqueue({part:{type:"text-delta",textDelta:r},partialOutput:t}),r=""}return new TransformStream({transform(n,i){if("step-finish"===n.type&&s({controller:i}),"text-delta"!==n.type)return void i.enqueue({part:n,partialOutput:void 0});t+=n.textDelta,r+=n.textDelta;let o=e.parsePartial({text:t});if(null!=o){let e=JSON.stringify(o.partial);e!==a&&(s({controller:i,partialOutput:o.partial}),a=e)}},flush(e){r.length>0&&s({controller:e})}})}(f)).pipeThrough(W);const{maxRetries:K,retry:J}=uH({maxRetries:s}),H=u2(t),Y=uQ({model:e,telemetry:t,headers:r,settings:{...a,maxRetries:K}}),Q=dZ({prompt:{system:null!=(A=null==f?void 0:f.injectIntoSystemPrompt({system:i,model:e}))?A:i,prompt:o,messages:l},tools:u}),X=this;u4({name:"ai.streamText",attributes:u3({telemetry:t,attributes:{...uY({operationId:"ai.streamText",telemetry:t}),...Y,"ai.prompt":{input:()=>JSON.stringify({system:i,prompt:o,messages:l})},"ai.settings.maxSteps":g}}),tracer:H,endWhenDone:!1,fn:async s=>{async function o({currentStep:s,responseMessages:l,usage:c,stepType:I,previousStepText:k,hasLeadingWhitespace:T,messageId:E}){var A;let O,C,R,M=0===l.length?Q.type:"messages",N=[...Q.messages,...l],j=await dw({prompt:{type:M,system:Q.system,messages:N},modelSupportsImageUrls:e.supportsImageUrls,modelSupportsUrl:null==(A=e.supportsUrl)?void 0:A.bind(e)}),P={type:"regular",...pl({tools:u,toolChoice:d,activeTools:h})},{result:{stream:$,warnings:D,rawResponse:L,request:U},doStreamSpan:z,startTimestampMs:q}=await J(()=>u4({name:"ai.streamText.doStream",attributes:u3({telemetry:t,attributes:{...uY({operationId:"ai.streamText.doStream",telemetry:t}),...Y,"ai.prompt.format":{input:()=>M},"ai.prompt.messages":{input:()=>dX(j)},"ai.prompt.tools":{input:()=>{var e;return null==(e=P.tools)?void 0:e.map(e=>JSON.stringify(e))}},"ai.prompt.toolChoice":{input:()=>null!=P.toolChoice?JSON.stringify(P.toolChoice):void 0},"gen_ai.system":e.provider,"gen_ai.request.model":e.modelId,"gen_ai.request.frequency_penalty":a.frequencyPenalty,"gen_ai.request.max_tokens":a.maxTokens,"gen_ai.request.presence_penalty":a.presencePenalty,"gen_ai.request.stop_sequences":a.stopSequences,"gen_ai.request.temperature":a.temperature,"gen_ai.request.top_k":a.topK,"gen_ai.request.top_p":a.topP}}),tracer:H,endWhenDone:!1,fn:async t=>({startTimestampMs:b(),doStreamSpan:t,result:await e.doStream({mode:P,...dS(a),inputFormat:M,responseFormat:null==f?void 0:f.responseFormat({model:e}),prompt:j,providerMetadata:v,abortSignal:n,headers:r})})})),V=function({tools:e,generatorStream:t,toolCallStreaming:r,tracer:a,telemetry:s,system:n,messages:i,abortSignal:o,repairToolCall:l}){let u,d=null,p=new ReadableStream({start(e){d=e}}),c={},h=new Set,m=!1;function g(){m&&0===h.size&&(null!=u&&d.enqueue(u),d.close())}let f=new TransformStream({async transform(t,p){let m=t.type;switch(m){case"text-delta":case"reasoning":case"reasoning-signature":case"redacted-reasoning":case"source":case"response-metadata":case"error":p.enqueue(t);break;case"file":p.enqueue(new u6({data:t.data,mimeType:t.mimeType}));break;case"tool-call-delta":r&&(c[t.toolCallId]||(p.enqueue({type:"tool-call-streaming-start",toolCallId:t.toolCallId,toolName:t.toolName}),c[t.toolCallId]=!0),p.enqueue({type:"tool-call-delta",toolCallId:t.toolCallId,toolName:t.toolName,argsTextDelta:t.argsTextDelta}));break;case"tool-call":try{let r=await px({toolCall:t,tools:e,repairToolCall:l,system:n,messages:i});p.enqueue(r);let u=e[r.toolName];if(null!=u.execute){let e=na();h.add(e),u4({name:"ai.toolCall",attributes:u3({telemetry:s,attributes:{...uY({operationId:"ai.toolCall",telemetry:s}),"ai.toolCall.name":r.toolName,"ai.toolCall.id":r.toolCallId,"ai.toolCall.args":{output:()=>JSON.stringify(r.args)}}}),tracer:a,fn:async t=>u.execute(r.args,{toolCallId:r.toolCallId,messages:i,abortSignal:o}).then(a=>{d.enqueue({...r,type:"tool-result",result:a}),h.delete(e),g();try{t.setAttributes(u3({telemetry:s,attributes:{"ai.toolCall.result":{output:()=>JSON.stringify(a)}}}))}catch(e){}},a=>{u5(t,a),d.enqueue({type:"error",error:new po({toolCallId:r.toolCallId,toolName:r.toolName,toolArgs:r.args,cause:a})}),h.delete(e),g()})})}}catch(e){d.enqueue({type:"error",error:e})}break;case"finish":u={type:"finish",finishReason:t.finishReason,logprobs:t.logprobs,usage:dG(t.usage),experimental_providerMetadata:t.providerMetadata};break;default:throw Error(`Unhandled chunk type: ${m}`)}},flush(){m=!0,g()}});return new ReadableStream({start:async e=>Promise.all([t.pipeThrough(f).pipeTo(new WritableStream({write(t){e.enqueue(t)},close(){}})),p.pipeTo(new WritableStream({write(t){e.enqueue(t)},close(){e.close()}}))])})}({tools:u,generatorStream:$,toolCallStreaming:p,tracer:H,telemetry:t,system:i,messages:N,repairToolCall:m,abortSignal:n}),F=null!=U?U:{},Z=[],W=[],G=[],B=[],K="unknown",ee={promptTokens:0,completionTokens:0,totalTokens:0},et=!0,er="",ea="continue"===I?k:"",es={id:_(),timestamp:w(),modelId:e.modelId},en="",ei=!1,eo=!0,el=!1;async function eu({controller:e,chunk:t}){e.enqueue(t),er+=t.textDelta,ea+=t.textDelta,ei=!0,el=t.textDelta.trimEnd()!==t.textDelta}X.addStream(V.pipeThrough(new TransformStream({async transform(e,t){var r,a,s;if(et){let e=b()-q;et=!1,z.addEvent("ai.stream.firstChunk",{"ai.response.msToFirstChunk":e}),z.setAttributes({"ai.response.msToFirstChunk":e}),t.enqueue({type:"step-start",messageId:E,request:F,warnings:null!=D?D:[]})}if("text-delta"===e.type&&0===e.textDelta.length)return;let n=e.type;switch(n){case"text-delta":if(y){let r=eo&&T?e.textDelta.trimStart():e.textDelta;if(0===r.length)break;eo=!1;let a=pd(en+=r);null!=a&&(en=a.suffix,await eu({controller:t,chunk:{type:"text-delta",textDelta:a.prefix+a.whitespace}}))}else await eu({controller:t,chunk:e});break;case"reasoning":t.enqueue(e),null==R?(R={type:"text",text:e.textDelta},G.push(R)):R.text+=e.textDelta;break;case"reasoning-signature":if(t.enqueue(e),null==R)throw new pL({chunk:e,message:"reasoning-signature without reasoning"});R.signature=e.signature,R=void 0;break;case"redacted-reasoning":t.enqueue(e),G.push({type:"redacted",data:e.data});break;case"tool-call":t.enqueue(e),Z.push(e);break;case"tool-result":t.enqueue(e),W.push(e);break;case"response-metadata":es={id:null!=(r=e.id)?r:es.id,timestamp:null!=(a=e.timestamp)?a:es.timestamp,modelId:null!=(s=e.modelId)?s:es.modelId};break;case"finish":{ee=e.usage,K=e.finishReason,O=e.experimental_providerMetadata,C=e.logprobs;let t=b()-q;z.addEvent("ai.stream.finish"),z.setAttributes({"ai.response.msToFinish":t,"ai.response.avgCompletionTokensPerSecond":1e3*ee.completionTokens/t});break}case"file":B.push(e),t.enqueue(e);break;case"source":case"tool-call-streaming-start":case"tool-call-delta":t.enqueue(e);break;case"error":t.enqueue(e),K="error";break;default:throw Error(`Unknown chunk type: ${n}`)}},async flush(e){let r=Z.length>0?JSON.stringify(Z):void 0,a="done";s+1<g&&(y&&"length"===K&&0===Z.length?a="continue":Z.length>0&&W.length===Z.length&&(a="tool-result")),y&&en.length>0&&("continue"!==a||"continue"===I&&!ei)&&(await eu({controller:e,chunk:{type:"text-delta",textDelta:en}}),en="");try{z.setAttributes(u3({telemetry:t,attributes:{"ai.response.finishReason":K,"ai.response.text":{output:()=>er},"ai.response.toolCalls":{output:()=>r},"ai.response.id":es.id,"ai.response.model":es.modelId,"ai.response.timestamp":es.timestamp.toISOString(),"ai.response.providerMetadata":JSON.stringify(O),"ai.usage.promptTokens":ee.promptTokens,"ai.usage.completionTokens":ee.completionTokens,"gen_ai.response.finish_reasons":[K],"gen_ai.response.id":es.id,"gen_ai.response.model":es.modelId,"gen_ai.usage.input_tokens":ee.promptTokens,"gen_ai.usage.output_tokens":ee.completionTokens}}))}catch(e){}finally{z.end()}e.enqueue({type:"step-finish",finishReason:K,usage:ee,providerMetadata:O,experimental_providerMetadata:O,logprobs:C,request:F,response:{...es,headers:null==L?void 0:L.headers},warnings:D,isContinued:"continue"===a,messageId:E});let n=dB(c,ee);if("done"===a)e.enqueue({type:"finish",finishReason:K,usage:n,providerMetadata:O,experimental_providerMetadata:O,logprobs:C,response:{...es,headers:null==L?void 0:L.headers}}),X.closeStream();else{if("continue"===I){let e=l[l.length-1];"string"==typeof e.content?e.content+=er:e.content.push({text:er,type:"text"})}else l.push(...pT({text:er,files:B,reasoning:G,tools:null!=u?u:{},toolCalls:Z,toolResults:W,messageId:E,generateMessageId:S}));await o({currentStep:s+1,responseMessages:l,usage:n,stepType:a,previousStepText:ea,hasLeadingWhitespace:el,messageId:"continue"===a?E:S()})}}})))}O=s,await o({currentStep:0,responseMessages:[],usage:{promptTokens:0,completionTokens:0,totalTokens:0},previousStepText:"",stepType:"initial",hasLeadingWhitespace:!1,messageId:S()})}}).catch(e=>{X.addStream(new ReadableStream({start(t){t.enqueue({type:"error",error:e}),t.close()}})),X.closeStream()})}get warnings(){return this.warningsPromise.value}get usage(){return this.usagePromise.value}get finishReason(){return this.finishReasonPromise.value}get experimental_providerMetadata(){return this.providerMetadataPromise.value}get providerMetadata(){return this.providerMetadataPromise.value}get text(){return this.textPromise.value}get reasoning(){return this.reasoningPromise.value}get reasoningDetails(){return this.reasoningDetailsPromise.value}get sources(){return this.sourcesPromise.value}get files(){return this.filesPromise.value}get toolCalls(){return this.toolCallsPromise.value}get toolResults(){return this.toolResultsPromise.value}get request(){return this.requestPromise.value}get response(){return this.responsePromise.value}get steps(){return this.stepsPromise.value}teeStream(){let[e,t]=this.baseStream.tee();return this.baseStream=t,e}get textStream(){return dJ(this.teeStream().pipeThrough(new TransformStream({transform({part:e},t){"text-delta"===e.type&&t.enqueue(e.textDelta)}})))}get fullStream(){return dJ(this.teeStream().pipeThrough(new TransformStream({transform({part:e},t){t.enqueue(e)}})))}async consumeStream(e){var t;try{await pq({stream:this.fullStream,onError:null==e?void 0:e.onError})}catch(r){null==(t=null==e?void 0:e.onError)||t.call(e,r)}}get experimental_partialOutputStream(){if(null==this.output)throw new pa;return dJ(this.teeStream().pipeThrough(new TransformStream({transform({partialOutput:e},t){null!=e&&t.enqueue(e)}})))}toDataStreamInternal({getErrorMessage:e=()=>"An error occurred.",sendUsage:t=!0,sendReasoning:r=!1,sendSources:a=!1,experimental_sendFinish:s=!0}){return this.fullStream.pipeThrough(new TransformStream({transform:async(n,i)=>{let o=n.type;switch(o){case"text-delta":i.enqueue(nf("text",n.textDelta));break;case"reasoning":r&&i.enqueue(nf("reasoning",n.textDelta));break;case"redacted-reasoning":r&&i.enqueue(nf("redacted_reasoning",{data:n.data}));break;case"reasoning-signature":r&&i.enqueue(nf("reasoning_signature",{signature:n.signature}));break;case"file":i.enqueue(nf("file",{mimeType:n.mimeType,data:n.base64}));break;case"source":a&&i.enqueue(nf("source",n.source));break;case"tool-call-streaming-start":i.enqueue(nf("tool_call_streaming_start",{toolCallId:n.toolCallId,toolName:n.toolName}));break;case"tool-call-delta":i.enqueue(nf("tool_call_delta",{toolCallId:n.toolCallId,argsTextDelta:n.argsTextDelta}));break;case"tool-call":i.enqueue(nf("tool_call",{toolCallId:n.toolCallId,toolName:n.toolName,args:n.args}));break;case"tool-result":i.enqueue(nf("tool_result",{toolCallId:n.toolCallId,result:n.result}));break;case"error":i.enqueue(nf("error",e(n.error)));break;case"step-start":i.enqueue(nf("start_step",{messageId:n.messageId}));break;case"step-finish":i.enqueue(nf("finish_step",{finishReason:n.finishReason,usage:t?{promptTokens:n.usage.promptTokens,completionTokens:n.usage.completionTokens}:void 0,isContinued:n.isContinued}));break;case"finish":s&&i.enqueue(nf("finish_message",{finishReason:n.finishReason,usage:t?{promptTokens:n.usage.promptTokens,completionTokens:n.usage.completionTokens}:void 0}));break;default:throw Error(`Unknown chunk type: ${o}`)}}}))}pipeDataStreamToResponse(e,{status:t,statusText:r,headers:a,data:s,getErrorMessage:n,sendUsage:i,sendReasoning:o,sendSources:l,experimental_sendFinish:u}={}){uU({response:e,status:t,statusText:r,headers:uL(a,{contentType:"text/plain; charset=utf-8",dataStreamVersion:"v1"}),stream:this.toDataStream({data:s,getErrorMessage:n,sendUsage:i,sendReasoning:o,sendSources:l,experimental_sendFinish:u})})}pipeTextStreamToResponse(e,t){uU({response:e,status:null==t?void 0:t.status,statusText:null==t?void 0:t.statusText,headers:uL(null==t?void 0:t.headers,{contentType:"text/plain; charset=utf-8"}),stream:this.textStream.pipeThrough(new TextEncoderStream)})}toDataStream(e){let t=this.toDataStreamInternal({getErrorMessage:null==e?void 0:e.getErrorMessage,sendUsage:null==e?void 0:e.sendUsage,sendReasoning:null==e?void 0:e.sendReasoning,sendSources:null==e?void 0:e.sendSources,experimental_sendFinish:null==e?void 0:e.experimental_sendFinish}).pipeThrough(new TextEncoderStream);return(null==e?void 0:e.data)?pV(null==e?void 0:e.data.stream,t):t}mergeIntoDataStream(e,t){e.merge(this.toDataStreamInternal({getErrorMessage:e.onError,sendUsage:null==t?void 0:t.sendUsage,sendReasoning:null==t?void 0:t.sendReasoning,sendSources:null==t?void 0:t.sendSources,experimental_sendFinish:null==t?void 0:t.experimental_sendFinish}))}toDataStreamResponse({headers:e,status:t,statusText:r,data:a,getErrorMessage:s,sendUsage:n,sendReasoning:i,sendSources:o,experimental_sendFinish:l}={}){return new Response(this.toDataStream({data:a,getErrorMessage:s,sendUsage:n,sendReasoning:i,sendSources:o,experimental_sendFinish:l}),{status:t,statusText:r,headers:uD(e,{contentType:"text/plain; charset=utf-8",dataStreamVersion:"v1"})})}toTextStreamResponse(e){var t;return new Response(this.textStream.pipeThrough(new TextEncoderStream),{status:null!=(t=null==e?void 0:e.status)?t:200,headers:uD(null==e?void 0:e.headers,{contentType:"text/plain; charset=utf-8"})})}},pG=(Symbol.for("vercel.ai.error.AI_NoSuchProviderError"),rb.z.object({name:rb.z.string(),version:rb.z.string()}).passthrough()),pB=rb.z.object({_meta:rb.z.optional(rb.z.object({}).passthrough())}).passthrough(),pK=rb.z.object({method:rb.z.string(),params:rb.z.optional(pB)}),pJ=rb.z.object({experimental:rb.z.optional(rb.z.object({}).passthrough()),logging:rb.z.optional(rb.z.object({}).passthrough()),prompts:rb.z.optional(rb.z.object({listChanged:rb.z.optional(rb.z.boolean())}).passthrough()),resources:rb.z.optional(rb.z.object({subscribe:rb.z.optional(rb.z.boolean()),listChanged:rb.z.optional(rb.z.boolean())}).passthrough()),tools:rb.z.optional(rb.z.object({listChanged:rb.z.optional(rb.z.boolean())}).passthrough())}).passthrough();pB.extend({protocolVersion:rb.z.string(),capabilities:pJ,serverInfo:pG,instructions:rb.z.optional(rb.z.string())});var pH=pB.extend({nextCursor:rb.z.optional(rb.z.string())}),pY=rb.z.object({name:rb.z.string(),description:rb.z.optional(rb.z.string()),inputSchema:rb.z.object({type:rb.z.literal("object"),properties:rb.z.optional(rb.z.object({}).passthrough())}).passthrough()}).passthrough();pH.extend({tools:rb.z.array(pY)});var pQ=rb.z.object({type:rb.z.literal("text"),text:rb.z.string()}).passthrough(),pX=rb.z.object({type:rb.z.literal("image"),data:rb.z.string().base64(),mimeType:rb.z.string()}).passthrough(),p0=rb.z.object({uri:rb.z.string(),mimeType:rb.z.optional(rb.z.string())}).passthrough(),p1=p0.extend({text:rb.z.string()}),p2=p0.extend({blob:rb.z.string().base64()}),p4=rb.z.object({type:rb.z.literal("resource"),resource:rb.z.union([p1,p2])}).passthrough();pB.extend({content:rb.z.array(rb.z.union([pQ,pX,p4])),isError:rb.z.boolean().default(!1).optional()}).or(pB.extend({toolResult:rb.z.unknown()}));var p5=rb.z.object({jsonrpc:rb.z.literal("2.0"),id:rb.z.union([rb.z.string(),rb.z.number().int()])}).merge(pK).strict(),p3=rb.z.object({jsonrpc:rb.z.literal("2.0"),id:rb.z.union([rb.z.string(),rb.z.number().int()]),result:pB}).strict(),p9=rb.z.object({jsonrpc:rb.z.literal("2.0"),id:rb.z.union([rb.z.string(),rb.z.number().int()]),error:rb.z.object({code:rb.z.number().int(),message:rb.z.string(),data:rb.z.optional(rb.z.unknown())})}).strict(),p6=rb.z.object({jsonrpc:rb.z.literal("2.0")}).merge(rb.z.object({method:rb.z.string(),params:rb.z.optional(pB)})).strict();function p8(e={}){let t=new TextEncoder,r="";return new TransformStream({async start(){e.onStart&&await e.onStart()},async transform(a,s){s.enqueue(t.encode(a)),r+=a,e.onToken&&await e.onToken(a),e.onText&&"string"==typeof a&&await e.onText(a)},async flush(){e.onCompletion&&await e.onCompletion(r),e.onFinal&&await e.onFinal(r)}})}function p7(e,t){return e.pipeThrough(new TransformStream({transform:async(e,t)=>{var r;if("string"==typeof e)return void t.enqueue(e);if("event"in e){"on_chat_model_stream"===e.event&&ca(null==(r=e.data)?void 0:r.chunk,t);return}ca(e,t)}})).pipeThrough(p8(t)).pipeThrough(new TextDecoderStream).pipeThrough(new TransformStream({transform:async(e,t)=>{t.enqueue(nf("text",e))}}))}function ce(e,t){return p7(e,t).pipeThrough(new TextEncoderStream)}function ct(e,t){var r;let a=p7(e,null==t?void 0:t.callbacks).pipeThrough(new TextEncoderStream),s=null==t?void 0:t.data,n=null==t?void 0:t.init;return new Response(s?pV(s.stream,a):a,{status:null!=(r=null==n?void 0:n.status)?r:200,statusText:null==n?void 0:n.statusText,headers:uD(null==n?void 0:n.headers,{contentType:"text/plain; charset=utf-8",dataStreamVersion:"v1"})})}function cr(e,t){t.dataStream.merge(p7(e,t.callbacks))}function ca(e,t){if("string"==typeof e.content)t.enqueue(e.content);else for(let r of e.content)"text"===r.type&&t.enqueue(r.text)}function cs(e,t){var r;let a,s=(a=!0,e=>(a&&(e=e.trimStart())&&(a=!1),e));return(r=e[Symbol.asyncIterator](),new ReadableStream({async pull(e){try{let{value:t,done:a}=await r.next();a?e.close():e.enqueue(t)}catch(t){e.error(t)}},cancel(){}})).pipeThrough(new TransformStream({async transform(e,t){t.enqueue(s(e.delta))}})).pipeThrough(p8(t)).pipeThrough(new TextDecoderStream).pipeThrough(new TransformStream({transform:async(e,t)=>{t.enqueue(nf("text",e))}}))}function cn(e,t){return cs(e,t).pipeThrough(new TextEncoderStream)}function ci(e,t={}){var r;let{init:a,data:s,callbacks:n}=t,i=cs(e,n).pipeThrough(new TextEncoderStream);return new Response(s?pV(s.stream,i):i,{status:null!=(r=null==a?void 0:a.status)?r:200,statusText:null==a?void 0:a.statusText,headers:uD(null==a?void 0:a.headers,{contentType:"text/plain; charset=utf-8",dataStreamVersion:"v1"})})}function co(e,t){t.dataStream.merge(cs(e,t.callbacks))}rb.z.union([p5,p6,p3,p9]),u$({},{mergeIntoDataStream:()=>cr,toDataStream:()=>ce,toDataStreamResponse:()=>ct}),u$({},{mergeIntoDataStream:()=>co,toDataStream:()=>cn,toDataStreamResponse:()=>ci});var cl=class extends tD{#e;#t;#r;constructor({model:e,mastra:t,options:r}){super({name:"aisdk"}),this.#e=e,this.#r=r,t&&(this.#t=t,t.getLogger()&&this.__setLogger(this.#t.getLogger()))}__registerPrimitives(e){e.telemetry&&this.__setTelemetry(e.telemetry),e.logger&&this.__setLogger(e.logger)}__registerMastra(e){this.#t=e}getProvider(){return this.#e.provider}getModelId(){return this.#e.modelId}getModel(){return this.#e}_applySchemaCompat(e){let t=this.#e,r=[];if(t){let e={modelId:t.modelId,supportsStructuredOutputs:t.supportsStructuredOutputs??!1,provider:t.provider};r.push(new lI(e),new lx(e),new l_(e),new lb(e),new lw(e),new lS(e))}return o7({schema:e,compatLayers:r,mode:"aiSdkSchema"})}async __text({runId:e,messages:t,maxSteps:r=5,tools:a={},temperature:s,toolChoice:n="auto",onStepFinish:i,experimental_output:o,telemetry:l,threadId:u,resourceId:d,runtimeContext:p,tracingContext:c,...h}){let m,g=this.#e;this.logger.debug("[LLM] - Generating text",{runId:e,messages:t,maxSteps:r,threadId:u,resourceId:d,tools:Object.keys(a)}),o&&((this.logger.debug("[LLM] - Using experimental output",{runId:e}),lL(o))?((m=o)instanceof rb.z.ZodArray&&(m=m._def.type),m=nb(sG(m,"jsonSchema7"))):m=nb(o));let f=c.currentSpan?.createChildSpan({name:`llm: '${g.modelId}'`,type:"llm_generation",input:{messages:t,schema:m},attributes:{model:g.modelId,provider:g.provider,parameters:{temperature:s,maxOutputTokens:h.maxTokens,topP:h.topP,frequencyPenalty:h.frequencyPenalty,presencePenalty:h.presencePenalty},streaming:!1},metadata:{runId:e,threadId:u,resourceId:d},tracingPolicy:this.#r?.tracingPolicy}),y={...h,messages:t,model:g,temperature:s,tools:{...a},toolChoice:n,maxSteps:r,onStepFinish:async t=>{try{await i?.({...t,runId:e})}catch(r){throw new tv({id:"LLM_TEXT_ON_STEP_FINISH_CALLBACK_EXECUTION_FAILED",domain:"LLM",category:"USER",details:{modelId:g.modelId,modelProvider:g.provider,runId:e??"unknown",threadId:u??"unknown",resourceId:d??"unknown",finishReason:t?.finishReason,toolCalls:t?.toolCalls?JSON.stringify(t.toolCalls):"",toolResults:t?.toolResults?JSON.stringify(t.toolResults):"",usage:t?.usage?JSON.stringify(t.usage):""}},r)}this.logger.debug("[LLM] - Text Step Change:",{text:t?.text,toolCalls:t?.toolCalls,toolResults:t?.toolResults,finishReason:t?.finishReason,usage:t?.usage,runId:e}),t?.response?.headers?.["x-ratelimit-remaining-tokens"]&&2e3>parseInt(t?.response?.headers?.["x-ratelimit-remaining-tokens"],10)&&(this.logger.warn("Rate limit approaching, waiting 10 seconds",{runId:e}),await lD(1e4))},experimental_telemetry:{...this.experimental_telemetry,...l},experimental_output:m?pj.object({schema:m}):void 0};try{let e=await pO(y);return m&&"stop"===e.finishReason&&(e.object=e.experimental_output),f?.end({output:{text:e.text,object:e.object,reasoning:e.reasoningDetails,reasoningText:e.reasoning,files:e.files,sources:e.sources,warnings:e.warnings},attributes:{finishReason:e.finishReason,usage:e.usage}}),e}catch(r){let t=new tv({id:"LLM_GENERATE_TEXT_AI_SDK_EXECUTION_FAILED",domain:"LLM",category:"THIRD_PARTY",details:{modelId:g.modelId,modelProvider:g.provider,runId:e??"unknown",threadId:u??"unknown",resourceId:d??"unknown"}},r);throw f?.error({error:t}),t}}async __textObject({messages:e,structuredOutput:t,runId:r,telemetry:a,threadId:s,resourceId:n,runtimeContext:i,tracingContext:o,...l}){let u=this.#e;this.logger.debug("[LLM] - Generating a text object",{runId:r});let d=o.currentSpan?.createChildSpan({name:`llm: '${u.modelId}'`,type:"llm_generation",input:{messages:e},attributes:{model:u.modelId,provider:u.provider,parameters:{temperature:l.temperature,maxOutputTokens:l.maxTokens,topP:l.topP,frequencyPenalty:l.frequencyPenalty,presencePenalty:l.presencePenalty},streaming:!1},metadata:{runId:r,threadId:s,resourceId:n},tracingPolicy:this.#r?.tracingPolicy});try{let i="object";t instanceof rb.z.ZodArray&&(i="array",t=t._def.type);let o=this._applySchemaCompat(t);d?.update({input:{messages:e,schema:o}});let p={...l,messages:e,model:u,output:i,schema:o,experimental_telemetry:{...this.experimental_telemetry,...a}};try{let e=await d2(p);return d?.end({output:{object:e.object,warnings:e.warnings},attributes:{finishReason:e.finishReason,usage:e.usage}}),e}catch(t){let e=new tv({id:"LLM_GENERATE_OBJECT_AI_SDK_EXECUTION_FAILED",domain:"LLM",category:"THIRD_PARTY",details:{modelId:u.modelId,modelProvider:u.provider,runId:r??"unknown",threadId:s??"unknown",resourceId:n??"unknown"}},t);throw d?.error({error:e}),e}}catch(t){if(t instanceof tv)throw t;let e=new tv({id:"LLM_GENERATE_OBJECT_AI_SDK_SCHEMA_CONVERSION_FAILED",domain:"LLM",category:"USER",details:{modelId:u.modelId,modelProvider:u.provider,runId:r??"unknown",threadId:s??"unknown",resourceId:n??"unknown"}},t);throw d?.error({error:e}),e}}__stream({messages:e,onStepFinish:t,onFinish:r,maxSteps:a=5,tools:s={},runId:n,temperature:i,toolChoice:o="auto",experimental_output:l,telemetry:u,threadId:d,resourceId:p,runtimeContext:c,tracingContext:h,...m}){let g,f=this.#e;this.logger.debug("[LLM] - Streaming text",{runId:n,threadId:d,resourceId:p,messages:e,maxSteps:a,tools:Object.keys(s||{})}),l&&(this.logger.debug("[LLM] - Using experimental output",{runId:n}),"function"==typeof l.parse?(g=l)instanceof rb.z.ZodArray&&(g=g._def.type):g=nb(l));let y=h.currentSpan?.createChildSpan({name:`llm: '${f.modelId}'`,type:"llm_generation",input:{messages:e},attributes:{model:f.modelId,provider:f.provider,parameters:{temperature:i,maxOutputTokens:m.maxTokens,topP:m.topP,frequencyPenalty:m.frequencyPenalty,presencePenalty:m.presencePenalty},streaming:!0},metadata:{runId:n,threadId:d,resourceId:p},tracingPolicy:this.#r?.tracingPolicy}),v={model:f,temperature:i,tools:{...s},maxSteps:a,toolChoice:o,onStepFinish:async e=>{try{await t?.({...e,runId:n})}catch(r){let t=new tv({id:"LLM_STREAM_ON_STEP_FINISH_CALLBACK_EXECUTION_FAILED",domain:"LLM",category:"USER",details:{modelId:f.modelId,modelProvider:f.provider,runId:n??"unknown",threadId:d??"unknown",resourceId:p??"unknown",finishReason:e?.finishReason,toolCalls:e?.toolCalls?JSON.stringify(e.toolCalls):"",toolResults:e?.toolResults?JSON.stringify(e.toolResults):"",usage:e?.usage?JSON.stringify(e.usage):""}},r);throw this.logger.trackException(t),y?.error({error:t}),t}this.logger.debug("[LLM] - Stream Step Change:",{text:e?.text,toolCalls:e?.toolCalls,toolResults:e?.toolResults,finishReason:e?.finishReason,usage:e?.usage,runId:n}),e?.response?.headers?.["x-ratelimit-remaining-tokens"]&&2e3>parseInt(e?.response?.headers?.["x-ratelimit-remaining-tokens"],10)&&(this.logger.warn("Rate limit approaching, waiting 10 seconds",{runId:n}),await lD(1e4))},onFinish:async e=>{try{await r?.({...e,runId:n}),y?.end({output:{text:e?.text,reasoning:e?.reasoningDetails,reasoningText:e?.reasoning,files:e?.files,sources:e?.sources,warnings:e?.warnings},attributes:{finishReason:e?.finishReason,usage:e?.usage}})}catch(r){let t=new tv({id:"LLM_STREAM_ON_FINISH_CALLBACK_EXECUTION_FAILED",domain:"LLM",category:"USER",details:{modelId:f.modelId,modelProvider:f.provider,runId:n??"unknown",threadId:d??"unknown",resourceId:p??"unknown",finishReason:e?.finishReason,toolCalls:e?.toolCalls?JSON.stringify(e.toolCalls):"",toolResults:e?.toolResults?JSON.stringify(e.toolResults):"",usage:e?.usage?JSON.stringify(e.usage):""}},r);throw y?.error({error:t}),this.logger.trackException(t),t}this.logger.debug("[LLM] - Stream Finished:",{text:e?.text,toolCalls:e?.toolCalls,toolResults:e?.toolResults,finishReason:e?.finishReason,usage:e?.usage,runId:n,threadId:d,resourceId:p})},...m,messages:e,experimental_telemetry:{...this.experimental_telemetry,...u},experimental_output:g?pj.object({schema:g}):void 0};try{return function({model:e,tools:t,toolChoice:r,system:a,prompt:s,messages:n,maxRetries:i,abortSignal:o,headers:l,maxSteps:u=1,experimental_generateMessageId:d=pZ,experimental_output:p,experimental_continueSteps:c=!1,experimental_telemetry:h,experimental_providerMetadata:m,providerOptions:g=m,experimental_toolCallStreaming:f=!1,toolCallStreaming:y=f,experimental_activeTools:v,experimental_repairToolCall:b,experimental_transform:w,onChunk:_,onError:S,onFinish:I,onStepFinish:k,_internal:{now:T=d6,generateId:E=pF,currentDate:A=()=>new Date}={},...O}){if("string"==typeof e||"v1"!==e.specificationVersion)throw new uz;return new pW({model:e,telemetry:h,headers:l,settings:O,maxRetries:i,abortSignal:o,system:a,prompt:s,messages:n,tools:t,toolChoice:r,toolCallStreaming:y,transforms:void 0===w?[]:Array.isArray(w)?w:[w],activeTools:v,repairToolCall:b,maxSteps:u,output:p,continueSteps:c,providerOptions:g,onChunk:_,onError:S,onFinish:I,onStepFinish:k,now:T,currentDate:A,generateId:E,generateMessageId:d})}(v)}catch(t){let e=new tv({id:"LLM_STREAM_TEXT_AI_SDK_EXECUTION_FAILED",domain:"LLM",category:"THIRD_PARTY",details:{modelId:f.modelId,modelProvider:f.provider,runId:n??"unknown",threadId:d??"unknown",resourceId:p??"unknown"}},t);throw y?.error({error:e}),e}}__streamObject({messages:e,runId:t,runtimeContext:r,threadId:a,resourceId:s,onFinish:n,structuredOutput:i,telemetry:o,tracingContext:l,...u}){let d=this.#e;this.logger.debug("[LLM] - Streaming structured output",{runId:t,messages:e});let p=l.currentSpan?.createChildSpan({name:`llm: '${d.modelId}'`,type:"llm_generation",input:{messages:e},attributes:{model:d.modelId,provider:d.provider,parameters:{temperature:u.temperature,maxOutputTokens:u.maxTokens,topP:u.topP,frequencyPenalty:u.frequencyPenalty,presencePenalty:u.presencePenalty},streaming:!0},metadata:{runId:t,threadId:a,resourceId:s},tracingPolicy:this.#r?.tracingPolicy});try{let r="object";i instanceof rb.z.ZodArray&&(r="array",i=i._def.type);let l=this._applySchemaCompat(i);p?.update({input:{messages:e,schema:l}});let c={...u,model:d,onFinish:async e=>{try{await n?.({...e,runId:t}),p?.end({output:{text:e?.text,object:e?.object,reasoning:e?.reasoningDetails,reasoningText:e?.reasoning,files:e?.files,sources:e?.sources,warnings:e?.warnings},attributes:{finishReason:e?.finishReason,usage:e?.usage}})}catch(n){let r=new tv({id:"LLM_STREAM_OBJECT_ON_FINISH_CALLBACK_EXECUTION_FAILED",domain:"LLM",category:"USER",details:{modelId:d.modelId,modelProvider:d.provider,runId:t??"unknown",threadId:a??"unknown",resourceId:s??"unknown",toolCalls:"",toolResults:"",finishReason:"",usage:e?.usage?JSON.stringify(e.usage):""}},n);throw this.logger.trackException(r),p?.error({error:r}),r}this.logger.debug("[LLM] - Object Stream Finished:",{usage:e?.usage,runId:t,threadId:a,resourceId:s})},messages:e,output:r,experimental_telemetry:{...this.experimental_telemetry,...o},schema:l};try{return function({model:e,schema:t,schemaName:r,schemaDescription:a,mode:s,output:n="object",system:i,prompt:o,messages:l,maxRetries:u,abortSignal:d,headers:p,experimental_telemetry:c,experimental_providerMetadata:h,providerOptions:m=h,onError:g,onFinish:f,_internal:{generateId:y=d8,currentDate:v=()=>new Date,now:b=d6}={},...w}){if("string"==typeof e||"v1"!==e.specificationVersion)throw new uz;dQ({output:n,mode:s,schema:t,schemaName:r,schemaDescription:a});let _=dY({output:n,schema:t});return"no-schema"===_.type&&void 0===s&&(s="json"),new d7({model:e,telemetry:c,headers:p,settings:w,maxRetries:u,abortSignal:d,outputStrategy:_,system:i,prompt:o,messages:l,schemaName:r,schemaDescription:a,providerOptions:m,mode:s,onError:g,onFinish:f,generateId:y,currentDate:v,now:b})}(c)}catch(r){let e=new tv({id:"LLM_STREAM_OBJECT_AI_SDK_EXECUTION_FAILED",domain:"LLM",category:"THIRD_PARTY",details:{modelId:d.modelId,modelProvider:d.provider,runId:t??"unknown",threadId:a??"unknown",resourceId:s??"unknown"}},r);throw p?.error({error:e}),e}}catch(r){if(r instanceof tv)throw p?.error({error:r}),r;let e=new tv({id:"LLM_STREAM_OBJECT_AI_SDK_SCHEMA_CONVERSION_FAILED",domain:"LLM",category:"USER",details:{modelId:d.modelId,modelProvider:d.provider,runId:t??"unknown",threadId:a??"unknown",resourceId:s??"unknown"}},r);throw p?.error({error:e}),e}}convertToMessages(e){return Array.isArray(e)?e.map(e=>"string"==typeof e?{role:"user",content:e}:e):[{role:"user",content:e}]}async generate(e,{output:t,...r}){let a=this.convertToMessages(e);if(!t){let{maxSteps:e,onStepFinish:t,...s}=r;return await this.__text({messages:a,maxSteps:e,onStepFinish:t,...s})}return await this.__textObject({messages:a,structuredOutput:t,...r})}stream(e,{maxSteps:t=5,output:r,onFinish:a,...s}){let n=this.convertToMessages(e);return r?this.__streamObject({messages:n,structuredOutput:r,onFinish:a,...s}):this.__stream({messages:n,maxSteps:t,onFinish:a,...s})}},cu=e.i(493661),cd=class extends tD{constructor({name:e}){super({component:"SERVER_CACHE",name:e})}},cp=class extends cd{cache=new cu.default({max:1e3,ttl:3e5});constructor(){super({name:"InMemoryServerCache"})}async get(e){return this.cache.get(e)}async set(e,t){this.cache.set(e,t)}async listLength(e){let t=this.cache.get(e);if(!Array.isArray(t))throw Error(`${e} is not an array`);return t.length}async listPush(e,t){let r=this.cache.get(e);Array.isArray(r)?r.push(t):this.cache.set(e,[t])}async listFromTo(e,t,r=-1){let a=this.cache.get(e);return Array.isArray(a)?a.slice(t,-1===r?void 0:r+1):[]}async delete(e){this.cache.delete(e)}async clear(){this.cache.clear()}},cc="vercel.ai.error",ch=Symbol.for(cc),cm=class e extends Error{constructor({name:e,message:t,cause:r}){super(t),this[ec]=!0,this.name=e,this.cause=r}static isInstance(t){return e.hasMarker(t,cc)}static hasMarker(e,t){let r=Symbol.for(t);return null!=e&&"object"==typeof e&&r in e&&"boolean"==typeof e[r]&&!0===e[r]}};ec=ch;var cg=cm,cf="AI_APICallError",cy=`vercel.ai.error.${cf}`,cv=Symbol.for(cy),cb=class extends cg{constructor({message:e,url:t,requestBodyValues:r,statusCode:a,responseHeaders:s,responseBody:n,cause:i,isRetryable:o=null!=a&&(408===a||409===a||429===a||a>=500),data:l}){super({name:cf,message:e,cause:i}),this[eh]=!0,this.url=t,this.requestBodyValues=r,this.statusCode=a,this.responseHeaders=s,this.responseBody=n,this.isRetryable=o,this.data=l}static isInstance(e){return cg.hasMarker(e,cy)}};eh=cv;var cw="AI_EmptyResponseBodyError",c_=`vercel.ai.error.${cw}`,cS=Symbol.for(c_),cx=class extends cg{constructor({message:e="Empty response body"}={}){super({name:cw,message:e}),this[em]=!0}static isInstance(e){return cg.hasMarker(e,c_)}};function cI(e){return null==e?"unknown error":"string"==typeof e?e:e instanceof Error?e.message:JSON.stringify(e)}em=cS;var ck="AI_InvalidArgumentError",cT=`vercel.ai.error.${ck}`,cE=Symbol.for(cT),cA=class extends cg{constructor({message:e,cause:t,argument:r}){super({name:ck,message:e,cause:t}),this[eg]=!0,this.argument=r}static isInstance(e){return cg.hasMarker(e,cT)}};eg=cE;var cO="AI_InvalidPromptError",cC=`vercel.ai.error.${cO}`,cR=Symbol.for(cC),cM=class extends cg{constructor({prompt:e,message:t,cause:r}){super({name:cO,message:`Invalid prompt: ${t}`,cause:r}),this[ef]=!0,this.prompt=e}static isInstance(e){return cg.hasMarker(e,cC)}};ef=cR;var cN="AI_InvalidResponseDataError",cj=`vercel.ai.error.${cN}`,cP=Symbol.for(cj),c$=class extends cg{constructor({data:e,message:t=`Invalid response data: ${JSON.stringify(e)}.`}){super({name:cN,message:t}),this[ey]=!0,this.data=e}static isInstance(e){return cg.hasMarker(e,cj)}};ey=cP;var cD="AI_JSONParseError",cL=`vercel.ai.error.${cD}`,cU=Symbol.for(cL),cz=class extends cg{constructor({text:e,cause:t}){super({name:cD,message:`JSON parsing failed: Text: ${e}.
Error message: ${cI(t)}`,cause:t}),this[ev]=!0,this.text=e}static isInstance(e){return cg.hasMarker(e,cL)}};ev=cU;var cq="AI_LoadAPIKeyError",cV=`vercel.ai.error.${cq}`,cF=Symbol.for(cV),cZ=class extends cg{constructor({message:e}){super({name:cq,message:e}),this[eb]=!0}static isInstance(e){return cg.hasMarker(e,cV)}};eb=cF,Symbol.for("vercel.ai.error.AI_LoadSettingError"),Symbol.for("vercel.ai.error.AI_NoContentGeneratedError");var cW="AI_NoSuchModelError",cG=`vercel.ai.error.${cW}`,cB=Symbol.for(cG),cK=class extends cg{constructor({errorName:e=cW,modelId:t,modelType:r,message:a=`No such ${r}: ${t}`}){super({name:e,message:a}),this[ew]=!0,this.modelId=t,this.modelType=r}static isInstance(e){return cg.hasMarker(e,cG)}};ew=cB;var cJ="AI_TooManyEmbeddingValuesForCallError",cH=`vercel.ai.error.${cJ}`,cY=Symbol.for(cH),cQ=class extends cg{constructor(e){super({name:cJ,message:`Too many values for a single embedding call. The ${e.provider} model "${e.modelId}" can only embed up to ${e.maxEmbeddingsPerCall} values per call, but ${e.values.length} values were provided.`}),this[e_]=!0,this.provider=e.provider,this.modelId=e.modelId,this.maxEmbeddingsPerCall=e.maxEmbeddingsPerCall,this.values=e.values}static isInstance(e){return cg.hasMarker(e,cH)}};e_=cY;var cX="AI_TypeValidationError",c0=`vercel.ai.error.${cX}`,c1=Symbol.for(c0),c2=class e extends cg{constructor({value:e,cause:t}){super({name:cX,message:`Type validation failed: Value: ${JSON.stringify(e)}.
Error message: ${cI(t)}`,cause:t}),this[eS]=!0,this.value=e}static isInstance(e){return cg.hasMarker(e,c0)}static wrap({value:t,cause:r}){return e.isInstance(r)&&r.value===t?r:new e({value:t,cause:r})}};eS=c1;var c4="AI_UnsupportedFunctionalityError",c5=`vercel.ai.error.${c4}`,c3=Symbol.for(c5),c9=class extends cg{constructor({functionality:e,message:t=`'${e}' functionality not supported.`}){super({name:c4,message:t}),this[ex]=!0,this.functionality=e}static isInstance(e){return cg.hasMarker(e,c5)}};ex=c3;class c6 extends Error{constructor(e,t){super(e),this.name="ParseError",this.type=t.type,this.field=t.field,this.value=t.value,this.line=t.line}}function c8(e){}class c7 extends TransformStream{constructor({onError:e,onRetry:t,onComment:r}={}){let a;super({start(s){a=function(e){if("function"==typeof e)throw TypeError("`callbacks` must be an object, got a function instead. Did you mean `{onEvent: fn}`?");let{onEvent:t=c8,onError:r=c8,onRetry:a=c8,onComment:s}=e,n="",i=!0,o,l="",u="";function d(e){if(""===e)return void(l.length>0&&t({id:o,event:u||void 0,data:l.endsWith(`
`)?l.slice(0,-1):l}),o=void 0,l="",u="");if(e.startsWith(":")){s&&s(e.slice(e.startsWith(": ")?2:1));return}let r=e.indexOf(":");if(-1!==r){let t=e.slice(0,r),a=" "===e[r+1]?2:1;p(t,e.slice(r+a),e);return}p(e,"",e)}function p(e,t,s){switch(e){case"event":u=t;break;case"data":l=`${l}${t}
`;break;case"id":o=t.includes("\0")?void 0:t;break;case"retry":/^\d+$/.test(t)?a(parseInt(t,10)):r(new c6(`Invalid \`retry\` value: "${t}"`,{type:"invalid-retry",value:t,line:s}));break;default:r(new c6(`Unknown field "${e.length>20?`${e.slice(0,20)}\u2026`:e}"`,{type:"unknown-field",field:e,value:t,line:s}))}}return{feed:function(e){let t=i?e.replace(/^\xEF\xBB\xBF/,""):e,[r,a]=function(e){let t=[],r="",a=0;for(;a<e.length;){let s=e.indexOf("\r",a),n=e.indexOf(`
`,a),i=-1;if(-1!==s&&-1!==n?i=Math.min(s,n):-1!==s?i=s===e.length-1?-1:s:-1!==n&&(i=n),-1===i){r=e.slice(a);break}{let r=e.slice(a,i);t.push(r),"\r"===e[(a=i+1)-1]&&e[a]===`
`&&a++}}return[t,r]}(`${n}${t}`);for(let e of r)d(e);n=a,i=!1},reset:function(e={}){n&&e.consume&&d(n),i=!0,o=void 0,l="",u="",n=""}}}({onEvent:e=>{s.enqueue(e)},onError(t){"terminate"===e?s.error(t):"function"==typeof e&&e(t)},onRetry:t,onComment:r})},transform(e){a.feed(e)}})}}var he=e.i(248804);function ht(...e){return e.reduce((e,t)=>({...e,...null!=t?t:{}}),{})}function hr(e){return Object.fromEntries([...e.headers])}function ha(e=globalThis){var t,r,a;return e.window?"runtime/browser":(null==(t=e.navigator)?void 0:t.userAgent)?`runtime/${e.navigator.userAgent.toLowerCase()}`:(null==(a=null==(r=e.process)?void 0:r.versions)?void 0:a.node)?`runtime/node.js/${e.process.version.substring(0)}`:e.EdgeRuntime?"runtime/vercel-edge":"runtime/unknown"}function hs(e,...t){let r=new Headers(Object.fromEntries(Object.entries(null!=e?e:{}).filter(([e,t])=>null!=t))),a=r.get("user-agent")||"";return r.set("user-agent",[a,...t].filter(Boolean).join(" ")),Object.fromEntries(r)}var hn=({prefix:e,size:t=16,alphabet:r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",separator:a="-"}={})=>{let s=()=>{let e=r.length,a=Array(t);for(let s=0;s<t;s++)a[s]=r[Math.random()*e|0];return a.join("")};if(null==e)return s;if(r.includes(a))throw new cA({argument:"separator",message:`The separator "${a}" must not be part of the alphabet "${r}".`});return()=>`${e}${a}${s()}`},hi=hn();function ho(e){return(e instanceof Error||e instanceof DOMException)&&("AbortError"===e.name||"ResponseAborted"===e.name||"TimeoutError"===e.name)}var hl=["fetch failed","failed to fetch"];function hu({error:e,url:t,requestBodyValues:r}){if(ho(e))return e;if(e instanceof TypeError&&hl.includes(e.message.toLowerCase())){let a=e.cause;if(null!=a)return new cb({message:`Cannot connect to API: ${a.message}`,cause:a,url:t,requestBodyValues:r,isRetryable:!0})}return e}var hd="3.0.10",hp=()=>globalThis.fetch,hc=async({url:e,headers:t={},successfulResponseHandler:r,failedResponseHandler:a,abortSignal:s,fetch:n=hp()})=>{try{let i=await n(e,{method:"GET",headers:hs(t,`ai-sdk/provider-utils/${hd}`,ha()),signal:s}),o=hr(i);if(!i.ok){let t;try{t=await a({response:i,url:e,requestBodyValues:{}})}catch(t){if(ho(t)||cb.isInstance(t))throw t;throw new cb({message:"Failed to process error response",cause:t,statusCode:i.status,url:e,responseHeaders:o,requestBodyValues:{}})}throw t.value}try{return await r({response:i,url:e,requestBodyValues:{}})}catch(t){if(t instanceof Error&&(ho(t)||cb.isInstance(t)))throw t;throw new cb({message:"Failed to process successful response",cause:t,statusCode:i.status,url:e,responseHeaders:o,requestBodyValues:{}})}}catch(t){throw hu({error:t,url:e,requestBodyValues:{}})}};function hh({apiKey:e,environmentVariableName:t,apiKeyParameterName:r="apiKey",description:a}){if("string"==typeof e)return e;if(null!=e)throw new cZ({message:`${a} API key must be a string.`});if("undefined"==typeof process)throw new cZ({message:`${a} API key is missing. Pass it using the '${r}' parameter. Environment variables is not supported in this environment.`});if(null==(e=process.env[t]))throw new cZ({message:`${a} API key is missing. Pass it using the '${r}' parameter or the ${t} environment variable.`});if("string"!=typeof e)throw new cZ({message:`${a} API key must be a string. The value of the ${t} environment variable is not a string.`});return e}function hm({settingValue:e,environmentVariableName:t}){return"string"==typeof e?e:null!=e||"undefined"==typeof process?void 0:null!=(e=process.env[t])&&"string"==typeof e?e:void 0}var hg=/"__proto__"\s*:/,hf=/"constructor"\s*:/;function hy(e){let{stackTraceLimit:t}=Error;Error.stackTraceLimit=0;try{let t;return t=JSON.parse(e),null===t||"object"!=typeof t||!1===hg.test(e)&&!1===hf.test(e)?t:function(e){let t=[e];for(;t.length;){let e=t;for(let r of(t=[],e)){if(Object.prototype.hasOwnProperty.call(r,"__proto__")||Object.prototype.hasOwnProperty.call(r,"constructor")&&Object.prototype.hasOwnProperty.call(r.constructor,"prototype"))throw SyntaxError("Object contains forbidden prototype property");for(let e in r){let a=r[e];a&&"object"==typeof a&&t.push(a)}}}return e}(t)}finally{Error.stackTraceLimit=t}}var hv=Symbol.for("vercel.ai.validator");async function hb({value:e,schema:t}){let r=await hw({value:e,schema:t});if(!r.success)throw c2.wrap({value:e,cause:r.error});return r.value}async function hw({value:e,schema:t}){var r;let a="object"==typeof t&&null!==t&&hv in t&&!0===t[hv]&&"validate"in t?t:(r=t,{[hv]:!0,validate:async e=>{let t=await r["~standard"].validate(e);return null==t.issues?{success:!0,value:t.value}:{success:!1,error:new c2({value:e,cause:t.issues})}}});try{if(null==a.validate)return{success:!0,value:e,rawValue:e};let t=await a.validate(e);if(t.success)return{success:!0,value:t.value,rawValue:e};return{success:!1,error:c2.wrap({value:e,cause:t.error}),rawValue:e}}catch(t){return{success:!1,error:c2.wrap({value:e,cause:t}),rawValue:e}}}async function h_({text:e,schema:t}){try{let r=hy(e);if(null==t)return r;return hb({value:r,schema:t})}catch(t){if(cz.isInstance(t)||c2.isInstance(t))throw t;throw new cz({text:e,cause:t})}}async function hS({text:e,schema:t}){try{let r=hy(e);if(null==t)return{success:!0,value:r,rawValue:r};return await hw({value:r,schema:t})}catch(t){return{success:!1,error:cz.isInstance(t)?t:new cz({text:e,cause:t}),rawValue:void 0}}}function hx(e){try{return hy(e),!0}catch(e){return!1}}async function hI({provider:e,providerOptions:t,schema:r}){if((null==t?void 0:t[e])==null)return;let a=await hw({value:t[e],schema:r});if(!a.success)throw new cA({argument:"providerOptions",message:`invalid ${e} provider options`,cause:a.error});return a.value}var hk=()=>globalThis.fetch,hT=async({url:e,headers:t,body:r,failedResponseHandler:a,successfulResponseHandler:s,abortSignal:n,fetch:i})=>hA({url:e,headers:{"Content-Type":"application/json",...t},body:{content:JSON.stringify(r),values:r},failedResponseHandler:a,successfulResponseHandler:s,abortSignal:n,fetch:i}),hE=async({url:e,headers:t,formData:r,failedResponseHandler:a,successfulResponseHandler:s,abortSignal:n,fetch:i})=>hA({url:e,headers:t,body:{content:r,values:Object.fromEntries(r.entries())},failedResponseHandler:a,successfulResponseHandler:s,abortSignal:n,fetch:i}),hA=async({url:e,headers:t={},body:r,successfulResponseHandler:a,failedResponseHandler:s,abortSignal:n,fetch:i=hk()})=>{try{let o=await i(e,{method:"POST",headers:hs(t,`ai-sdk/provider-utils/${hd}`,ha()),body:r.content,signal:n}),l=hr(o);if(!o.ok){let t;try{t=await s({response:o,url:e,requestBodyValues:r.values})}catch(t){if(ho(t)||cb.isInstance(t))throw t;throw new cb({message:"Failed to process error response",cause:t,statusCode:o.status,url:e,responseHeaders:l,requestBodyValues:r.values})}throw t.value}try{return await a({response:o,url:e,requestBodyValues:r.values})}catch(t){if(t instanceof Error&&(ho(t)||cb.isInstance(t)))throw t;throw new cb({message:"Failed to process successful response",cause:t,statusCode:o.status,url:e,responseHeaders:l,requestBodyValues:r.values})}}catch(t){throw hu({error:t,url:e,requestBodyValues:r.values})}};function hO({id:e,name:t,inputSchema:r}){return({execute:a,outputSchema:s,toModelOutput:n,onInputStart:i,onInputDelta:o,onInputAvailable:l,...u})=>({type:"provider-defined",id:e,name:t,args:u,inputSchema:r,outputSchema:s,execute:a,toModelOutput:n,onInputStart:i,onInputDelta:o,onInputAvailable:l})}function hC({id:e,name:t,inputSchema:r,outputSchema:a}){return({execute:s,toModelOutput:n,onInputStart:i,onInputDelta:o,onInputAvailable:l,...u})=>({type:"provider-defined",id:e,name:t,args:u,inputSchema:r,outputSchema:a,execute:s,toModelOutput:n,onInputStart:i,onInputDelta:o,onInputAvailable:l})}async function hR(e){return"function"==typeof e&&(e=e()),Promise.resolve(e)}var hM=({errorSchema:e,errorToMessage:t,isRetryable:r})=>async({response:a,url:s,requestBodyValues:n})=>{let i=await a.text(),o=hr(a);if(""===i.trim())return{responseHeaders:o,value:new cb({message:a.statusText,url:s,requestBodyValues:n,statusCode:a.status,responseHeaders:o,responseBody:i,isRetryable:null==r?void 0:r(a)})};try{let l=await h_({text:i,schema:e});return{responseHeaders:o,value:new cb({message:t(l),url:s,requestBodyValues:n,statusCode:a.status,responseHeaders:o,responseBody:i,data:l,isRetryable:null==r?void 0:r(a,l)})}}catch(e){return{responseHeaders:o,value:new cb({message:a.statusText,url:s,requestBodyValues:n,statusCode:a.status,responseHeaders:o,responseBody:i,isRetryable:null==r?void 0:r(a)})}}},hN=e=>async({response:t})=>{let r=hr(t);if(null==t.body)throw new cx({});return{responseHeaders:r,value:function({stream:e,schema:t}){return e.pipeThrough(new TextDecoderStream).pipeThrough(new c7).pipeThrough(new TransformStream({async transform({data:e},r){"[DONE]"!==e&&r.enqueue(await hS({text:e,schema:t}))}}))}({stream:t.body,schema:e})}},hj=e=>async({response:t,url:r,requestBodyValues:a})=>{let s=await t.text(),n=await hS({text:s,schema:e}),i=hr(t);if(!n.success)throw new cb({message:"Invalid JSON response",cause:n.error,statusCode:t.status,responseHeaders:i,responseBody:s,url:r,requestBodyValues:a});return{responseHeaders:i,value:n.value,rawValue:n.rawValue}},hP=Symbol("Let zodToJsonSchema decide on which parser to use"),h$={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",allowedAdditionalProperties:!0,rejectedAdditionalProperties:!1,definitionPath:"definitions",strictUnions:!1,definitions:{},errorMessages:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"};function hD(e,t){return h5(e.type._def,t)}var hL=void 0,hU=/^[cC][^\s-]{8,}$/,hz=/^[0-9a-z]+$/,hq=/^[0-9A-HJKMNP-TV-Z]{26}$/,hV=/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,hF=()=>(void 0===hL&&(hL=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),hL),hZ=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,hW=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,hG=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,hB=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,hK=/^[a-zA-Z0-9_-]{21}$/,hJ=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/;function hH(e,t){let r={type:"string"};if(e.checks)for(let a of e.checks)switch(a.kind){case"min":r.minLength="number"==typeof r.minLength?Math.max(r.minLength,a.value):a.value;break;case"max":r.maxLength="number"==typeof r.maxLength?Math.min(r.maxLength,a.value):a.value;break;case"email":switch(t.emailStrategy){case"format:email":hX(r,"email",a.message,t);break;case"format:idn-email":hX(r,"idn-email",a.message,t);break;case"pattern:zod":h0(r,hV,a.message,t)}break;case"url":hX(r,"uri",a.message,t);break;case"uuid":hX(r,"uuid",a.message,t);break;case"regex":h0(r,a.regex,a.message,t);break;case"cuid":h0(r,hU,a.message,t);break;case"cuid2":h0(r,hz,a.message,t);break;case"startsWith":h0(r,RegExp(`^${hY(a.value,t)}`),a.message,t);break;case"endsWith":h0(r,RegExp(`${hY(a.value,t)}$`),a.message,t);break;case"datetime":hX(r,"date-time",a.message,t);break;case"date":hX(r,"date",a.message,t);break;case"time":hX(r,"time",a.message,t);break;case"duration":hX(r,"duration",a.message,t);break;case"length":r.minLength="number"==typeof r.minLength?Math.max(r.minLength,a.value):a.value,r.maxLength="number"==typeof r.maxLength?Math.min(r.maxLength,a.value):a.value;break;case"includes":h0(r,RegExp(hY(a.value,t)),a.message,t);break;case"ip":"v6"!==a.version&&hX(r,"ipv4",a.message,t),"v4"!==a.version&&hX(r,"ipv6",a.message,t);break;case"base64url":h0(r,hB,a.message,t);break;case"jwt":h0(r,hJ,a.message,t);break;case"cidr":"v6"!==a.version&&h0(r,hZ,a.message,t),"v4"!==a.version&&h0(r,hW,a.message,t);break;case"emoji":h0(r,hF(),a.message,t);break;case"ulid":h0(r,hq,a.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":hX(r,"binary",a.message,t);break;case"contentEncoding:base64":r.contentEncoding="base64";break;case"pattern:zod":h0(r,hG,a.message,t)}break;case"nanoid":h0(r,hK,a.message,t)}return r}function hY(e,t){return"escape"===t.patternStrategy?function(e){let t="";for(let r=0;r<e.length;r++)hQ.has(e[r])||(t+="\\"),t+=e[r];return t}(e):e}var hQ=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function hX(e,t,r,a){var s;e.format||(null==(s=e.anyOf)?void 0:s.some(e=>e.format))?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format}),delete e.format),e.anyOf.push({format:t,...r&&a.errorMessages&&{errorMessage:{format:r}}})):e.format=t}function h0(e,t,r,a){var s;e.pattern||(null==(s=e.allOf)?void 0:s.some(e=>e.pattern))?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern}),delete e.pattern),e.allOf.push({pattern:h1(t,a),...r&&a.errorMessages&&{errorMessage:{pattern:r}}})):e.pattern=h1(t,a)}function h1(e,t){var r;if(!t.applyRegexFlags||!e.flags)return e.source;let a={i:e.flags.includes("i"),m:e.flags.includes("m"),s:e.flags.includes("s")},s=a.i?e.source.toLowerCase():e.source,n="",i=!1,o=!1,l=!1;for(let e=0;e<s.length;e++){if(i){n+=s[e],i=!1;continue}if(a.i){if(o){if(s[e].match(/[a-z]/)){l?(n+=s[e],n+=`${s[e-2]}-${s[e]}`.toUpperCase(),l=!1):"-"===s[e+1]&&(null==(r=s[e+2])?void 0:r.match(/[a-z]/))?(n+=s[e],l=!0):n+=`${s[e]}${s[e].toUpperCase()}`;continue}}else if(s[e].match(/[a-z]/)){n+=`[${s[e]}${s[e].toUpperCase()}]`;continue}}if(a.m){if("^"===s[e]){n+=`(^|(?<=[\r
]))`;continue}else if("$"===s[e]){n+=`($|(?=[\r
]))`;continue}}if(a.s&&"."===s[e]){n+=o?`${s[e]}\r
`:`[${s[e]}\r
]`;continue}n+=s[e],"\\"===s[e]?i=!0:o&&"]"===s[e]?o=!1:o||"["!==s[e]||(o=!0)}try{new RegExp(n)}catch(r){return console.warn(`Could not convert regex pattern at ${t.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),e.source}return n}function h2(e,t){var r,a,s,n,i,o;let l={type:"object",additionalProperties:null!=(r=h5(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]}))?r:t.allowedAdditionalProperties};if((null==(a=e.keyType)?void 0:a._def.typeName)===D.ZodString&&(null==(s=e.keyType._def.checks)?void 0:s.length)){let{type:r,...a}=hH(e.keyType._def,t);return{...l,propertyNames:a}}if((null==(n=e.keyType)?void 0:n._def.typeName)===D.ZodEnum)return{...l,propertyNames:{enum:e.keyType._def.values}};if((null==(i=e.keyType)?void 0:i._def.typeName)===D.ZodBranded&&e.keyType._def.type._def.typeName===D.ZodString&&(null==(o=e.keyType._def.type._def.checks)?void 0:o.length)){let{type:r,...a}=hD(e.keyType._def,t);return{...l,propertyNames:a}}return l}var h4={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function h5(e,t,r=!1){var a;let s=t.seen.get(e);if(t.override){let n=null==(a=t.override)?void 0:a.call(t,e,t,s,r);if(n!==hP)return n}if(s&&!r){let e=h3(s,t);if(void 0!==e)return e}let n={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,n);let i=((e,t,r)=>{var a,s,n,i,o,l;switch(t){case D.ZodString:return hH(e,r);case D.ZodNumber:let u={type:"number"};if(!e.checks)return u;for(let t of e.checks)switch(t.kind){case"int":u.type="integer";break;case"min":t.inclusive?u.minimum=t.value:u.exclusiveMinimum=t.value;break;case"max":t.inclusive?u.maximum=t.value:u.exclusiveMaximum=t.value;break;case"multipleOf":u.multipleOf=t.value}return u;case D.ZodObject:return function(e,t){let r={type:"object",properties:{}},a=[],s=e.shape();for(let e in s){let n=s[e];if(void 0===n||void 0===n._def)continue;let i=function(e){try{return e.isOptional()}catch(e){return!0}}(n),o=h5(n._def,{...t,currentPath:[...t.currentPath,"properties",e],propertyPath:[...t.currentPath,"properties",e]});void 0!==o&&(r.properties[e]=o,i||a.push(e))}a.length&&(r.required=a);let n=function(e,t){if("ZodNever"!==e.catchall._def.typeName)return h5(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]});switch(e.unknownKeys){case"passthrough":return t.allowedAdditionalProperties;case"strict":return t.rejectedAdditionalProperties;case"strip":return"strict"===t.removeAdditionalStrategy?t.allowedAdditionalProperties:t.rejectedAdditionalProperties}}(e,t);return void 0!==n&&(r.additionalProperties=n),r}(e,r);case D.ZodBigInt:let d={type:"integer",format:"int64"};if(!e.checks)return d;for(let t of e.checks)switch(t.kind){case"min":t.inclusive?d.minimum=t.value:d.exclusiveMinimum=t.value;break;case"max":t.inclusive?d.maximum=t.value:d.exclusiveMaximum=t.value;break;case"multipleOf":d.multipleOf=t.value}return d;case D.ZodBoolean:return{type:"boolean"};case D.ZodDate:return function e(t,r,a){let s=null!=a?a:r.dateStrategy;if(Array.isArray(s))return{anyOf:s.map((a,s)=>e(t,r,a))};switch(s){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":var n=t;let i={type:"integer",format:"unix-time"};for(let e of n.checks)switch(e.kind){case"min":i.minimum=e.value;break;case"max":i.maximum=e.value}return i}}(e,r);case D.ZodUndefined:return{not:{}};case D.ZodNull:return{type:"null"};case D.ZodArray:let p;return p={type:"array"},(null==(n=e.type)?void 0:n._def)&&(null==(o=null==(i=e.type)?void 0:i._def)?void 0:o.typeName)!==D.ZodAny&&(p.items=h5(e.type._def,{...r,currentPath:[...r.currentPath,"items"]})),e.minLength&&(p.minItems=e.minLength.value),e.maxLength&&(p.maxItems=e.maxLength.value),e.exactLength&&(p.minItems=e.exactLength.value,p.maxItems=e.exactLength.value),p;case D.ZodUnion:case D.ZodDiscriminatedUnion:let c,h=e.options instanceof Map?Array.from(e.options.values()):e.options;if(h.every(e=>e._def.typeName in h4&&(!e._def.checks||!e._def.checks.length))){let e=h.reduce((e,t)=>{let r=h4[t._def.typeName];return r&&!e.includes(r)?[...e,r]:e},[]);return{type:e.length>1?e:e[0]}}if(h.every(e=>"ZodLiteral"===e._def.typeName&&!e.description)){let e=h.reduce((e,t)=>{let r=typeof t._def.value;switch(r){case"string":case"number":case"boolean":return[...e,r];case"bigint":return[...e,"integer"];case"object":if(null===t._def.value)return[...e,"null"];default:return e}},[]);if(e.length===h.length){let t=e.filter((e,t,r)=>r.indexOf(e)===t);return{type:t.length>1?t:t[0],enum:h.reduce((e,t)=>e.includes(t._def.value)?e:[...e,t._def.value],[])}}}else if(h.every(e=>"ZodEnum"===e._def.typeName))return{type:"string",enum:h.reduce((e,t)=>[...e,...t._def.values.filter(t=>!e.includes(t))],[])};return a=e,s=r,(c=(a.options instanceof Map?Array.from(a.options.values()):a.options).map((e,t)=>h5(e._def,{...s,currentPath:[...s.currentPath,"anyOf",`${t}`]})).filter(e=>!!e&&(!s.strictUnions||"object"==typeof e&&Object.keys(e).length>0))).length?{anyOf:c}:void 0;case D.ZodIntersection:let m,g;return m=[h5(e.left._def,{...r,currentPath:[...r.currentPath,"allOf","0"]}),h5(e.right._def,{...r,currentPath:[...r.currentPath,"allOf","1"]})].filter(e=>!!e),g=[],m.forEach(e=>{if((!("type"in e)||"string"!==e.type)&&"allOf"in e)g.push(...e.allOf);else{let t=e;if("additionalProperties"in e&&!1===e.additionalProperties){let{additionalProperties:r,...a}=e;t=a}g.push(t)}}),g.length?{allOf:g}:void 0;case D.ZodTuple:return e.rest?{type:"array",minItems:e.items.length,items:e.items.map((e,t)=>h5(e._def,{...r,currentPath:[...r.currentPath,"items",`${t}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[]),additionalItems:h5(e.rest._def,{...r,currentPath:[...r.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map((e,t)=>h5(e._def,{...r,currentPath:[...r.currentPath,"items",`${t}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[])};case D.ZodRecord:return h2(e,r);case D.ZodLiteral:let f;return"bigint"!=(f=typeof e.value)&&"number"!==f&&"boolean"!==f&&"string"!==f?{type:Array.isArray(e.value)?"array":"object"}:{type:"bigint"===f?"integer":f,const:e.value};case D.ZodEnum:return{type:"string",enum:Array.from(e.values)};case D.ZodNativeEnum:let y,v,b;return y=e.values,{type:1===(b=Array.from(new Set((v=Object.keys(e.values).filter(e=>"number"!=typeof y[y[e]]).map(e=>y[e])).map(e=>typeof e)))).length?"string"===b[0]?"string":"number":["string","number"],enum:v};case D.ZodNullable:if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return{type:[h4[e.innerType._def.typeName],"null"]};let w=h5(e.innerType._def,{...r,currentPath:[...r.currentPath,"anyOf","0"]});return w&&{anyOf:[w,{type:"null"}]};case D.ZodOptional:if(r.currentPath.toString()===(null==(l=r.propertyPath)?void 0:l.toString()))return h5(e.innerType._def,r);let _=h5(e.innerType._def,{...r,currentPath:[...r.currentPath,"anyOf","1"]});return _?{anyOf:[{not:{}},_]}:{};case D.ZodMap:if("record"===r.mapStrategy)return h2(e,r);return{type:"array",maxItems:125,items:{type:"array",items:[h5(e.keyType._def,{...r,currentPath:[...r.currentPath,"items","items","0"]})||{},h5(e.valueType._def,{...r,currentPath:[...r.currentPath,"items","items","1"]})||{}],minItems:2,maxItems:2}};case D.ZodSet:let S;return S={type:"array",uniqueItems:!0,items:h5(e.valueType._def,{...r,currentPath:[...r.currentPath,"items"]})},e.minSize&&(S.minItems=e.minSize.value),e.maxSize&&(S.maxItems=e.maxSize.value),S;case D.ZodLazy:return()=>e.getter()._def;case D.ZodPromise:return h5(e.type._def,r);case D.ZodNaN:case D.ZodNever:return{not:{}};case D.ZodEffects:return"input"===r.effectStrategy?h5(e.schema._def,r):{};case D.ZodAny:case D.ZodUnknown:return{};case D.ZodDefault:return{...h5(e.innerType._def,r),default:e.defaultValue()};case D.ZodBranded:return hD(e,r);case D.ZodReadonly:case D.ZodCatch:return h5(e.innerType._def,r);case D.ZodPipeline:if("input"===r.pipeStrategy)return h5(e.in._def,r);if("output"===r.pipeStrategy)return h5(e.out._def,r);let I=h5(e.in._def,{...r,currentPath:[...r.currentPath,"allOf","0"]}),k=h5(e.out._def,{...r,currentPath:[...r.currentPath,"allOf",I?"1":"0"]});return{allOf:[I,k].filter(e=>void 0!==e)};case D.ZodFunction:case D.ZodVoid:case D.ZodSymbol:default:return}})(e,e.typeName,t),o="function"==typeof i?h5(i(),t):i;if(o&&h9(e,t,o),t.postProcess){let r=t.postProcess(o,e,t);return n.jsonSchema=o,r}return n.jsonSchema=o,o}var h3=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"relative":return{$ref:((e,t)=>{let r=0;for(;r<e.length&&r<t.length&&e[r]===t[r];r++);return[(e.length-r).toString(),...t.slice(r)].join("/")})(t.currentPath,e.path)};case"none":case"seen":if(e.path.length<t.currentPath.length&&e.path.every((e,r)=>t.currentPath[r]===e))return console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),{};return"seen"===t.$refStrategy?{}:void 0}},h9=(e,t,r)=>(e.description&&(r.description=e.description),r),h6=Symbol.for("vercel.ai.schema");function h8(e,{validate:t}={}){return{[h6]:!0,_type:void 0,[hv]:!0,jsonSchema:e,validate:t}}function h7(e){return null==e?h8({properties:{},additionalProperties:!1}):"object"==typeof e&&null!==e&&h6 in e&&!0===e[h6]&&"jsonSchema"in e&&"validate"in e?e:function(e,t){if("_zod"in e){let t;return t=!1,h8(n_.toJSONSchema(e,{target:"draft-7",io:"output",reused:t?"ref":"inline"}),{validate:async t=>{let r=await he.safeParseAsync(e,t);return r.success?{success:!0,value:r.data}:{success:!1,error:r.error}}})}return h8(((e,t)=>{var r;let a,s,n=(s=void 0!==(a="string"==typeof t?{...h$,name:t}:{...h$,...t}).name?[...a.basePath,a.definitionPath,a.name]:a.basePath,{...a,currentPath:s,propertyPath:void 0,seen:new Map(Object.entries(a.definitions).map(([e,t])=>[t._def,{def:t._def,path:[...a.basePath,a.definitionPath,e],jsonSchema:void 0}]))}),i="object"==typeof t&&t.definitions?Object.entries(t.definitions).reduce((e,[t,r])=>{var a;return{...e,[t]:null!=(a=h5(r._def,{...n,currentPath:[...n.basePath,n.definitionPath,t]},!0))?a:{}}},{}):void 0,o="string"==typeof t?t:(null==t?void 0:t.nameStrategy)==="title"||null==t?void 0:t.name,l=null!=(r=h5(e._def,void 0===o?n:{...n,currentPath:[...n.basePath,n.definitionPath,o]},!1))?r:{},u="object"==typeof t&&void 0!==t.name&&"title"===t.nameStrategy?t.name:void 0;void 0!==u&&(l.title=u);let d=void 0===o?i?{...l,[n.definitionPath]:i}:l:{$ref:[..."relative"===n.$refStrategy?[]:n.basePath,n.definitionPath,o].join("/"),[n.definitionPath]:{...i,[o]:l}};return d.$schema="http://json-schema.org/draft-07/schema#",d})(e,{$refStrategy:"none"}),{validate:async t=>{let r=await e.safeParseAsync(t);return r.success?{success:!0,value:r.data}:{success:!1,error:r.error}}})}(e)}var{btoa:me,atob:mt}=globalThis;function mr(e){return e instanceof Uint8Array?function(e){let t="";for(let r=0;r<e.length;r++)t+=String.fromCodePoint(e[r]);return me(t)}(e):e}function ma(e){return null==e?void 0:e.replace(/\/$/,"")}var nS=n_,ms=hM({errorSchema:nS.object({type:nS.literal("error"),error:nS.object({type:nS.string(),message:nS.string()})}),errorToMessage:e=>e.error.message}),mn=nS.object({citations:nS.object({enabled:nS.boolean()}).optional(),title:nS.string().optional(),context:nS.string().optional()}),mi=nS.object({sendReasoning:nS.boolean().optional(),thinking:nS.object({type:nS.union([nS.literal("enabled"),nS.literal("disabled")]),budgetTokens:nS.number().optional()}).optional(),disableParallelToolUse:nS.boolean().optional(),cacheControl:nS.object({type:nS.literal("ephemeral"),ttl:nS.union([nS.literal("5m"),nS.literal("1h")]).optional()}).optional()});function mo(e){var t;let r=null==e?void 0:e.anthropic;return null!=(t=null==r?void 0:r.cacheControl)?t:null==r?void 0:r.cache_control}var ml=nS.object({maxCharacters:nS.number().optional()}),mu=hO({id:"anthropic.text_editor_20250728",name:"str_replace_based_edit_tool",inputSchema:nS.object({command:nS.enum(["view","create","str_replace","insert"]),path:nS.string(),file_text:nS.string().optional(),insert_line:nS.number().int().optional(),new_str:nS.string().optional(),old_str:nS.string().optional(),view_range:nS.array(nS.number().int()).optional()})}),md=nS.object({maxUses:nS.number().optional(),allowedDomains:nS.array(nS.string()).optional(),blockedDomains:nS.array(nS.string()).optional(),userLocation:nS.object({type:nS.literal("approximate"),city:nS.string().optional(),region:nS.string().optional(),country:nS.string().optional(),timezone:nS.string().optional()}).optional()}),mp=nS.array(nS.object({url:nS.string(),title:nS.string(),pageAge:nS.string().nullable(),encryptedContent:nS.string(),type:nS.literal("web_search_result")})),mc=hC({id:"anthropic.web_search_20250305",name:"web_search",inputSchema:nS.object({query:nS.string()}),outputSchema:mp}),mh=nS.object({maxUses:nS.number().optional(),allowedDomains:nS.array(nS.string()).optional(),blockedDomains:nS.array(nS.string()).optional(),citations:nS.object({enabled:nS.boolean()}).optional(),maxContentTokens:nS.number().optional()}),mm=nS.object({type:nS.literal("web_fetch_result"),url:nS.string(),content:nS.object({type:nS.literal("document"),title:nS.string(),citations:nS.object({enabled:nS.boolean()}).optional(),source:nS.union([nS.object({type:nS.literal("base64"),mediaType:nS.literal("application/pdf"),data:nS.string()}),nS.object({type:nS.literal("text"),mediaType:nS.literal("text/plain"),data:nS.string()})])}),retrievedAt:nS.string().nullable()}),mg=hC({id:"anthropic.web_fetch_20250910",name:"web_fetch",inputSchema:nS.object({url:nS.string()}),outputSchema:mm}),mf=nS.object({type:nS.literal("code_execution_result"),stdout:nS.string(),stderr:nS.string(),return_code:nS.number()}),my=hC({id:"anthropic.code_execution_20250522",name:"code_execution",inputSchema:nS.object({code:nS.string()}),outputSchema:mf});async function mv({prompt:e,sendReasoning:t,warnings:r}){var a,s,n,i,o;let l,u=new Set,d=function(e){let t,r=[];for(let a of e){let{role:e}=a;switch(e){case"system":(null==t?void 0:t.type)!=="system"&&(t={type:"system",messages:[]},r.push(t)),t.messages.push(a);break;case"assistant":(null==t?void 0:t.type)!=="assistant"&&(t={type:"assistant",messages:[]},r.push(t)),t.messages.push(a);break;case"user":case"tool":(null==t?void 0:t.type)!=="user"&&(t={type:"user",messages:[]},r.push(t)),t.messages.push(a);break;default:throw Error(`Unsupported role: ${e}`)}}return r}(e),p=[];async function c(e){var t,r;let a=await hI({provider:"anthropic",providerOptions:e,schema:mn});return null!=(r=null==(t=null==a?void 0:a.citations)?void 0:t.enabled)&&r}async function h(e){let t=await hI({provider:"anthropic",providerOptions:e,schema:mn});return{title:null==t?void 0:t.title,context:null==t?void 0:t.context}}for(let e=0;e<d.length;e++){let m=d[e],g=e===d.length-1,f=m.type;switch(f){case"system":if(null!=l)throw new c9({functionality:"Multiple system messages that are separated by user/assistant messages"});l=m.messages.map(({content:e,providerOptions:t})=>({type:"text",text:e,cache_control:mo(t)}));break;case"user":{let e=[];for(let t of m.messages){let{role:r,content:o}=t;switch(r){case"user":for(let r=0;r<o.length;r++){let i=o[r],l=r===o.length-1,d=null!=(a=mo(i.providerOptions))?a:l?mo(t.providerOptions):void 0;switch(i.type){case"text":e.push({type:"text",text:i.text,cache_control:d});break;case"file":if(i.mediaType.startsWith("image/"))e.push({type:"image",source:i.data instanceof URL?{type:"url",url:i.data.toString()}:{type:"base64",media_type:"image/*"===i.mediaType?"image/jpeg":i.mediaType,data:mr(i.data)},cache_control:d});else if("application/pdf"===i.mediaType){u.add("pdfs-2024-09-25");let t=await c(i.providerOptions),r=await h(i.providerOptions);e.push({type:"document",source:i.data instanceof URL?{type:"url",url:i.data.toString()}:{type:"base64",media_type:"application/pdf",data:mr(i.data)},title:null!=(s=r.title)?s:i.filename,...r.context&&{context:r.context},...t&&{citations:{enabled:!0}},cache_control:d})}else if("text/plain"===i.mediaType){let t=await c(i.providerOptions),r=await h(i.providerOptions);e.push({type:"document",source:i.data instanceof URL?{type:"url",url:i.data.toString()}:{type:"text",media_type:"text/plain",data:function(e){if("string"==typeof e)return Buffer.from(e,"base64").toString("utf-8");if(e instanceof Uint8Array)return new TextDecoder().decode(e);if(e instanceof URL)throw new c9({functionality:"URL-based text documents are not supported for citations"});throw new c9({functionality:`unsupported data type for text documents: ${typeof e}`})}(i.data)},title:null!=(n=r.title)?n:i.filename,...r.context&&{context:r.context},...t&&{citations:{enabled:!0}},cache_control:d})}else throw new c9({functionality:`media type: ${i.mediaType}`})}}break;case"tool":for(let r=0;r<o.length;r++){let a,s=o[r],n=r===o.length-1,l=null!=(i=mo(s.providerOptions))?i:n?mo(t.providerOptions):void 0,u=s.output;switch(u.type){case"content":a=u.value.map(e=>{switch(e.type){case"text":return{type:"text",text:e.text,cache_control:void 0};case"media":if(e.mediaType.startsWith("image/"))return{type:"image",source:{type:"base64",media_type:e.mediaType,data:e.data},cache_control:void 0};throw new c9({functionality:`media type: ${e.mediaType}`})}});break;case"text":case"error-text":a=u.value;break;default:a=JSON.stringify(u.value)}e.push({type:"tool_result",tool_use_id:s.toolCallId,content:a,is_error:"error-text"===u.type||"error-json"===u.type||void 0,cache_control:l})}break;default:throw Error(`Unsupported role: ${r}`)}}p.push({role:"user",content:e});break}case"assistant":{let e=[];for(let a=0;a<m.messages.length;a++){let s=m.messages[a],n=a===m.messages.length-1,{content:i}=s;for(let a=0;a<i.length;a++){let l=i[a],u=a===i.length-1,d=null!=(o=mo(l.providerOptions))?o:u?mo(s.providerOptions):void 0;switch(l.type){case"text":e.push({type:"text",text:g&&n&&u?l.text.trim():l.text,cache_control:d});break;case"reasoning":if(t){let t=await hI({provider:"anthropic",providerOptions:l.providerOptions,schema:mT});null!=t?null!=t.signature?e.push({type:"thinking",thinking:l.text,signature:t.signature,cache_control:d}):null!=t.redactedData?e.push({type:"redacted_thinking",data:t.redactedData,cache_control:d}):r.push({type:"other",message:"unsupported reasoning metadata"}):r.push({type:"other",message:"unsupported reasoning metadata"})}else r.push({type:"other",message:"sending reasoning content is disabled for this model"});break;case"tool-call":if(l.providerExecuted){"code_execution"===l.toolName||"web_fetch"===l.toolName||"web_search"===l.toolName?e.push({type:"server_tool_use",id:l.toolCallId,name:l.toolName,input:l.input,cache_control:d}):r.push({type:"other",message:`provider executed tool call for tool ${l.toolName} is not supported`});break}e.push({type:"tool_use",id:l.toolCallId,name:l.toolName,input:l.input,cache_control:d});break;case"tool-result":if("code_execution"===l.toolName){let t=l.output;if("json"!==t.type){r.push({type:"other",message:`provider executed tool result output type ${t.type} for tool ${l.toolName} is not supported`});break}let a=mf.parse(t.value);e.push({type:"code_execution_tool_result",tool_use_id:l.toolCallId,content:{type:a.type,stdout:a.stdout,stderr:a.stderr,return_code:a.return_code},cache_control:d});break}if("web_fetch"===l.toolName){let t=l.output;if("json"!==t.type){r.push({type:"other",message:`provider executed tool result output type ${t.type} for tool ${l.toolName} is not supported`});break}let a=mm.parse(t.value);e.push({type:"web_fetch_tool_result",tool_use_id:l.toolCallId,content:{type:"web_fetch_result",url:a.url,retrieved_at:a.retrievedAt,content:{type:"document",title:a.content.title,citations:a.content.citations,source:{type:a.content.source.type,media_type:a.content.source.mediaType,data:a.content.source.data}}},cache_control:d});break}if("web_search"===l.toolName){let t=l.output;if("json"!==t.type){r.push({type:"other",message:`provider executed tool result output type ${t.type} for tool ${l.toolName} is not supported`});break}let a=mp.parse(t.value);e.push({type:"web_search_tool_result",tool_use_id:l.toolCallId,content:a.map(e=>({url:e.url,title:e.title,page_age:e.pageAge,encrypted_content:e.encryptedContent,type:e.type})),cache_control:d});break}r.push({type:"other",message:`provider executed tool result for tool ${l.toolName} is not supported`})}}}p.push({role:"assistant",content:e});break}default:throw Error(`content type: ${f}`)}}return{prompt:{system:l,messages:p},betas:u}}function mb({finishReason:e,isJsonResponseFromTool:t}){switch(e){case"pause_turn":case"end_turn":case"stop_sequence":return"stop";case"refusal":return"content-filter";case"tool_use":return t?"stop":"tool-calls";case"max_tokens":return"length";default:return"unknown"}}var mw={webSearchResult:nS.object({type:nS.literal("web_search_result_location"),cited_text:nS.string(),url:nS.string(),title:nS.string(),encrypted_index:nS.string()}),pageLocation:nS.object({type:nS.literal("page_location"),cited_text:nS.string(),document_index:nS.number(),document_title:nS.string().nullable(),start_page_number:nS.number(),end_page_number:nS.number()}),charLocation:nS.object({type:nS.literal("char_location"),cited_text:nS.string(),document_index:nS.number(),document_title:nS.string().nullable(),start_char_index:nS.number(),end_char_index:nS.number()})},m_=nS.discriminatedUnion("type",[mw.webSearchResult,mw.pageLocation,mw.charLocation]);function mS(e,t,r,a){if("page_location"===e.type||"char_location"===e.type){let s=function(e,t,r){var a;let s=t[e.document_index];if(!s)return null;let n="page_location"===e.type?{citedText:e.cited_text,startPageNumber:e.start_page_number,endPageNumber:e.end_page_number}:{citedText:e.cited_text,startCharIndex:e.start_char_index,endCharIndex:e.end_char_index};return{type:"source",sourceType:"document",id:r(),mediaType:s.mediaType,title:null!=(a=e.document_title)?a:s.title,filename:s.filename,providerMetadata:{anthropic:n}}}(e,t,r);s&&a(s)}}nS.discriminatedUnion("type",[mw.pageLocation,mw.charLocation]);var mx=class{constructor(e,t){var r;this.specificationVersion="v2",this.modelId=e,this.config=t,this.generateId=null!=(r=t.generateId)?r:hi}supportsUrl(e){return"https:"===e.protocol}get provider(){return this.config.provider}get supportedUrls(){var e,t,r;return null!=(r=null==(t=(e=this.config).supportedUrls)?void 0:t.call(e))?r:{}}async getArgs({prompt:e,maxOutputTokens:t=4096,temperature:r,topP:a,topK:s,frequencyPenalty:n,presencePenalty:i,stopSequences:o,responseFormat:l,seed:u,tools:d,toolChoice:p,providerOptions:c}){var h,m,g;let f=[];null!=n&&f.push({type:"unsupported-setting",setting:"frequencyPenalty"}),null!=i&&f.push({type:"unsupported-setting",setting:"presencePenalty"}),null!=u&&f.push({type:"unsupported-setting",setting:"seed"}),(null==l?void 0:l.type)==="json"&&(null==l.schema?f.push({type:"unsupported-setting",setting:"responseFormat",details:"JSON response format requires a schema. The response format is ignored."}):null!=d&&f.push({type:"unsupported-setting",setting:"tools",details:"JSON response format does not support tools. The provided tools are ignored."}));let y=(null==l?void 0:l.type)==="json"&&null!=l.schema?{type:"function",name:"json",description:"Respond with a JSON object.",inputSchema:l.schema}:void 0,v=await hI({provider:"anthropic",providerOptions:c,schema:mi}),{prompt:b,betas:w}=await mv({prompt:e,sendReasoning:null==(h=null==v?void 0:v.sendReasoning)||h,warnings:f}),_=(null==(m=null==v?void 0:v.thinking)?void 0:m.type)==="enabled",S=null==(g=null==v?void 0:v.thinking)?void 0:g.budgetTokens,I={model:this.modelId,max_tokens:t,temperature:r,top_k:s,top_p:a,stop_sequences:o,..._&&{thinking:{type:"enabled",budget_tokens:S}},system:b.system,messages:b.messages};if(_){if(null==S)throw new c9({functionality:"thinking requires a budget"});null!=I.temperature&&(I.temperature=void 0,f.push({type:"unsupported-setting",setting:"temperature",details:"temperature is not supported when thinking is enabled"})),null!=s&&(I.top_k=void 0,f.push({type:"unsupported-setting",setting:"topK",details:"topK is not supported when thinking is enabled"})),null!=a&&(I.top_p=void 0,f.push({type:"unsupported-setting",setting:"topP",details:"topP is not supported when thinking is enabled"})),I.max_tokens=t+S}let{tools:k,toolChoice:T,toolWarnings:E,betas:A}=function({tools:e,toolChoice:t,disableParallelToolUse:r}){e=(null==e?void 0:e.length)?e:void 0;let a=[],s=new Set;if(null==e)return{tools:void 0,toolChoice:void 0,toolWarnings:a,betas:s};let n=[];for(let t of e)switch(t.type){case"function":{let e=mo(t.providerOptions);n.push({name:t.name,description:t.description,input_schema:t.inputSchema,cache_control:e});break}case"provider-defined":switch(t.id){case"anthropic.code_execution_20250522":s.add("code-execution-2025-05-22"),n.push({type:"code_execution_20250522",name:"code_execution"});break;case"anthropic.computer_20250124":s.add("computer-use-2025-01-24"),n.push({name:"computer",type:"computer_20250124",display_width_px:t.args.displayWidthPx,display_height_px:t.args.displayHeightPx,display_number:t.args.displayNumber});break;case"anthropic.computer_20241022":s.add("computer-use-2024-10-22"),n.push({name:"computer",type:"computer_20241022",display_width_px:t.args.displayWidthPx,display_height_px:t.args.displayHeightPx,display_number:t.args.displayNumber});break;case"anthropic.text_editor_20250124":s.add("computer-use-2025-01-24"),n.push({name:"str_replace_editor",type:"text_editor_20250124"});break;case"anthropic.text_editor_20241022":s.add("computer-use-2024-10-22"),n.push({name:"str_replace_editor",type:"text_editor_20241022"});break;case"anthropic.text_editor_20250429":s.add("computer-use-2025-01-24"),n.push({name:"str_replace_based_edit_tool",type:"text_editor_20250429"});break;case"anthropic.text_editor_20250728":{let e=ml.parse(t.args);n.push({name:"str_replace_based_edit_tool",type:"text_editor_20250728",max_characters:e.maxCharacters});break}case"anthropic.bash_20250124":s.add("computer-use-2025-01-24"),n.push({name:"bash",type:"bash_20250124"});break;case"anthropic.bash_20241022":s.add("computer-use-2024-10-22"),n.push({name:"bash",type:"bash_20241022"});break;case"anthropic.web_fetch_20250910":{s.add("web-fetch-2025-09-10");let e=mh.parse(t.args);n.push({type:"web_fetch_20250910",name:"web_fetch",max_uses:e.maxUses,allowed_domains:e.allowedDomains,blocked_domains:e.blockedDomains,citations:e.citations,max_content_tokens:e.maxContentTokens});break}case"anthropic.web_search_20250305":{let e=md.parse(t.args);n.push({type:"web_search_20250305",name:"web_search",max_uses:e.maxUses,allowed_domains:e.allowedDomains,blocked_domains:e.blockedDomains,user_location:e.userLocation});break}default:a.push({type:"unsupported-tool",tool:t})}break;default:a.push({type:"unsupported-tool",tool:t})}if(null==t)return{tools:n,toolChoice:r?{type:"auto",disable_parallel_tool_use:r}:void 0,toolWarnings:a,betas:s};let i=t.type;switch(i){case"auto":return{tools:n,toolChoice:{type:"auto",disable_parallel_tool_use:r},toolWarnings:a,betas:s};case"required":return{tools:n,toolChoice:{type:"any",disable_parallel_tool_use:r},toolWarnings:a,betas:s};case"none":return{tools:void 0,toolChoice:void 0,toolWarnings:a,betas:s};case"tool":return{tools:n,toolChoice:{type:"tool",name:t.toolName,disable_parallel_tool_use:r},toolWarnings:a,betas:s};default:throw new c9({functionality:`tool choice type: ${i}`})}}(null!=y?{tools:[y],toolChoice:{type:"tool",toolName:y.name},disableParallelToolUse:!0}:{tools:null!=d?d:[],toolChoice:p,disableParallelToolUse:null==v?void 0:v.disableParallelToolUse});return{args:{...I,tools:k,tool_choice:T},warnings:[...f,...E],betas:new Set([...w,...A]),usesJsonResponseTool:null!=y}}async getHeaders({betas:e,headers:t}){return ht(await hR(this.config.headers),e.size>0?{"anthropic-beta":Array.from(e).join(",")}:{},t)}buildRequestUrl(e){var t,r,a;return null!=(a=null==(r=(t=this.config).buildRequestUrl)?void 0:r.call(t,this.config.baseURL,e))?a:`${this.config.baseURL}/messages`}transformRequestBody(e){var t,r,a;return null!=(a=null==(r=(t=this.config).transformRequestBody)?void 0:r.call(t,e))?a:e}extractCitationDocuments(e){return e.filter(e=>"user"===e.role).flatMap(e=>e.content).filter(e=>{var t,r;if("file"!==e.type||"application/pdf"!==e.mediaType&&"text/plain"!==e.mediaType)return!1;let a=null==(t=e.providerOptions)?void 0:t.anthropic,s=null==a?void 0:a.citations;return null!=(r=null==s?void 0:s.enabled)&&r}).map(e=>{var t;return{title:null!=(t=e.filename)?t:"Untitled Document",filename:e.filename,mediaType:e.mediaType}})}async doGenerate(e){var t,r,a,s,n,i;let{args:o,warnings:l,betas:u,usesJsonResponseTool:d}=await this.getArgs(e),p=this.extractCitationDocuments(e.prompt),{responseHeaders:c,value:h,rawValue:m}=await hT({url:this.buildRequestUrl(!1),headers:await this.getHeaders({betas:u,headers:e.headers}),body:this.transformRequestBody(o),failedResponseHandler:ms,successfulResponseHandler:hj(mI),abortSignal:e.abortSignal,fetch:this.config.fetch}),g=[];for(let e of h.content)switch(e.type){case"text":if(!d&&(g.push({type:"text",text:e.text}),e.citations))for(let t of e.citations)mS(t,p,this.generateId,e=>g.push(e));break;case"thinking":g.push({type:"reasoning",text:e.thinking,providerMetadata:{anthropic:{signature:e.signature}}});break;case"redacted_thinking":g.push({type:"reasoning",text:"",providerMetadata:{anthropic:{redactedData:e.data}}});break;case"tool_use":g.push(d?{type:"text",text:JSON.stringify(e.input)}:{type:"tool-call",toolCallId:e.id,toolName:e.name,input:JSON.stringify(e.input)});break;case"server_tool_use":("web_search"===e.name||"code_execution"===e.name||"web_fetch"===e.name)&&g.push({type:"tool-call",toolCallId:e.id,toolName:e.name,input:JSON.stringify(e.input),providerExecuted:!0});break;case"web_fetch_tool_result":"web_fetch_result"===e.content.type?g.push({type:"tool-result",toolCallId:e.tool_use_id,toolName:"web_fetch",result:{type:"web_fetch_result",url:e.content.url,retrievedAt:e.content.retrieved_at,content:{type:e.content.content.type,title:e.content.content.title,citations:e.content.content.citations,source:{type:e.content.content.source.type,mediaType:e.content.content.source.media_type,data:e.content.content.source.data}}},providerExecuted:!0}):"web_fetch_tool_result_error"===e.content.type&&g.push({type:"tool-result",toolCallId:e.tool_use_id,toolName:"web_fetch",isError:!0,result:{type:"web_fetch_tool_result_error",errorCode:e.content.error_code},providerExecuted:!0});break;case"web_search_tool_result":if(Array.isArray(e.content))for(let r of(g.push({type:"tool-result",toolCallId:e.tool_use_id,toolName:"web_search",result:e.content.map(e=>{var t;return{url:e.url,title:e.title,pageAge:null!=(t=e.page_age)?t:null,encryptedContent:e.encrypted_content,type:e.type}}),providerExecuted:!0}),e.content))g.push({type:"source",sourceType:"url",id:this.generateId(),url:r.url,title:r.title,providerMetadata:{anthropic:{pageAge:null!=(t=r.page_age)?t:null}}});else g.push({type:"tool-result",toolCallId:e.tool_use_id,toolName:"web_search",isError:!0,result:{type:"web_search_tool_result_error",errorCode:e.content.error_code},providerExecuted:!0});break;case"code_execution_tool_result":"code_execution_result"===e.content.type?g.push({type:"tool-result",toolCallId:e.tool_use_id,toolName:"code_execution",result:{type:e.content.type,stdout:e.content.stdout,stderr:e.content.stderr,return_code:e.content.return_code},providerExecuted:!0}):"code_execution_tool_result_error"===e.content.type&&g.push({type:"tool-result",toolCallId:e.tool_use_id,toolName:"code_execution",isError:!0,result:{type:"code_execution_tool_result_error",errorCode:e.content.error_code},providerExecuted:!0})}return{content:g,finishReason:mb({finishReason:h.stop_reason,isJsonResponseFromTool:d}),usage:{inputTokens:h.usage.input_tokens,outputTokens:h.usage.output_tokens,totalTokens:h.usage.input_tokens+h.usage.output_tokens,cachedInputTokens:null!=(r=h.usage.cache_read_input_tokens)?r:void 0},request:{body:o},response:{id:null!=(a=h.id)?a:void 0,modelId:null!=(s=h.model)?s:void 0,headers:c,body:m},warnings:l,providerMetadata:{anthropic:{usage:h.usage,cacheCreationInputTokens:null!=(n=h.usage.cache_creation_input_tokens)?n:null,stopSequence:null!=(i=h.stop_sequence)?i:null}}}}async doStream(e){let t,r,{args:a,warnings:s,betas:n,usesJsonResponseTool:i}=await this.getArgs(e),o=this.extractCitationDocuments(e.prompt),l={...a,stream:!0},{responseHeaders:u,value:d}=await hT({url:this.buildRequestUrl(!0),headers:await this.getHeaders({betas:n,headers:e.headers}),body:this.transformRequestBody(l),failedResponseHandler:ms,successfulResponseHandler:hN(mk),abortSignal:e.abortSignal,fetch:this.config.fetch}),p="unknown",c={inputTokens:void 0,outputTokens:void 0,totalTokens:void 0},h={},m=null,g=null,f=this.generateId;return{stream:d.pipeThrough(new TransformStream({start(e){e.enqueue({type:"stream-start",warnings:s})},transform(a,s){var n,l,u,d,y,v,b,w;if(e.includeRawChunks&&s.enqueue({type:"raw",rawValue:a.rawValue}),!a.success)return void s.enqueue({type:"error",error:a.error});let _=a.value;switch(_.type){case"ping":return;case"content_block_start":{let e=_.content_block.type;switch(r=e,e){case"text":h[_.index]={type:"text"},s.enqueue({type:"text-start",id:String(_.index)});return;case"thinking":h[_.index]={type:"reasoning"},s.enqueue({type:"reasoning-start",id:String(_.index)});return;case"redacted_thinking":h[_.index]={type:"reasoning"},s.enqueue({type:"reasoning-start",id:String(_.index),providerMetadata:{anthropic:{redactedData:_.content_block.data}}});return;case"tool_use":h[_.index]=i?{type:"text"}:{type:"tool-call",toolCallId:_.content_block.id,toolName:_.content_block.name,input:""},s.enqueue(i?{type:"text-start",id:String(_.index)}:{type:"tool-input-start",id:_.content_block.id,toolName:_.content_block.name});return;case"server_tool_use":("web_fetch"===_.content_block.name||"web_search"===_.content_block.name||"code_execution"===_.content_block.name)&&(h[_.index]={type:"tool-call",toolCallId:_.content_block.id,toolName:_.content_block.name,input:"",providerExecuted:!0},s.enqueue({type:"tool-input-start",id:_.content_block.id,toolName:_.content_block.name,providerExecuted:!0}));return;case"web_fetch_tool_result":{let e=_.content_block;"web_fetch_result"===e.content.type?s.enqueue({type:"tool-result",toolCallId:e.tool_use_id,toolName:"web_fetch",result:{type:"web_fetch_result",url:e.content.url,retrievedAt:e.content.retrieved_at,content:{type:e.content.content.type,title:e.content.content.title,citations:e.content.content.citations,source:{type:e.content.content.source.type,mediaType:e.content.content.source.media_type,data:e.content.content.source.data}}}}):"web_fetch_tool_result_error"===e.content.type&&s.enqueue({type:"tool-result",toolCallId:e.tool_use_id,toolName:"web_fetch",isError:!0,result:{type:"web_fetch_tool_result_error",errorCode:e.content.error_code},providerExecuted:!0});return}case"web_search_tool_result":{let e=_.content_block;if(Array.isArray(e.content))for(let t of(s.enqueue({type:"tool-result",toolCallId:e.tool_use_id,toolName:"web_search",result:e.content.map(e=>{var t;return{url:e.url,title:e.title,pageAge:null!=(t=e.page_age)?t:null,encryptedContent:e.encrypted_content,type:e.type}}),providerExecuted:!0}),e.content))s.enqueue({type:"source",sourceType:"url",id:f(),url:t.url,title:t.title,providerMetadata:{anthropic:{pageAge:null!=(n=t.page_age)?n:null}}});else s.enqueue({type:"tool-result",toolCallId:e.tool_use_id,toolName:"web_search",isError:!0,result:{type:"web_search_tool_result_error",errorCode:e.content.error_code},providerExecuted:!0});return}case"code_execution_tool_result":{let e=_.content_block;"code_execution_result"===e.content.type?s.enqueue({type:"tool-result",toolCallId:e.tool_use_id,toolName:"code_execution",result:{type:e.content.type,stdout:e.content.stdout,stderr:e.content.stderr,return_code:e.content.return_code},providerExecuted:!0}):"code_execution_tool_result_error"===e.content.type&&s.enqueue({type:"tool-result",toolCallId:e.tool_use_id,toolName:"code_execution",isError:!0,result:{type:"code_execution_tool_result_error",errorCode:e.content.error_code},providerExecuted:!0});return}default:throw Error(`Unsupported content block type: ${e}`)}}case"content_block_stop":if(null!=h[_.index]){let e=h[_.index];switch(e.type){case"text":s.enqueue({type:"text-end",id:String(_.index)});break;case"reasoning":s.enqueue({type:"reasoning-end",id:String(_.index)});break;case"tool-call":i||(s.enqueue({type:"tool-input-end",id:e.toolCallId}),s.enqueue(e))}delete h[_.index]}r=void 0;return;case"content_block_delta":{let e=_.delta.type;switch(e){case"text_delta":if(i)return;s.enqueue({type:"text-delta",id:String(_.index),delta:_.delta.text});return;case"thinking_delta":return void s.enqueue({type:"reasoning-delta",id:String(_.index),delta:_.delta.thinking});case"signature_delta":"thinking"===r&&s.enqueue({type:"reasoning-delta",id:String(_.index),delta:"",providerMetadata:{anthropic:{signature:_.delta.signature}}});return;case"input_json_delta":{let e=h[_.index],t=_.delta.partial_json;if(i){if((null==e?void 0:e.type)!=="text")return;s.enqueue({type:"text-delta",id:String(_.index),delta:t})}else{if((null==e?void 0:e.type)!=="tool-call")return;s.enqueue({type:"tool-input-delta",id:e.toolCallId,delta:t}),e.input+=t}return}case"citations_delta":return void mS(_.delta.citation,o,f,e=>s.enqueue(e));default:throw Error(`Unsupported delta type: ${e}`)}}case"message_start":c.inputTokens=_.message.usage.input_tokens,c.cachedInputTokens=null!=(l=_.message.usage.cache_read_input_tokens)?l:void 0,t={..._.message.usage},m=null!=(u=_.message.usage.cache_creation_input_tokens)?u:null,s.enqueue({type:"response-metadata",id:null!=(d=_.message.id)?d:void 0,modelId:null!=(y=_.message.model)?y:void 0});return;case"message_delta":c.outputTokens=_.usage.output_tokens,c.totalTokens=(null!=(v=c.inputTokens)?v:0)+(null!=(b=_.usage.output_tokens)?b:0),p=mb({finishReason:_.delta.stop_reason,isJsonResponseFromTool:i}),g=null!=(w=_.delta.stop_sequence)?w:null,t={...t,..._.usage};return;case"message_stop":return void s.enqueue({type:"finish",finishReason:p,usage:c,providerMetadata:{anthropic:{usage:null!=t?t:null,cacheCreationInputTokens:m,stopSequence:g}}});case"error":return void s.enqueue({type:"error",error:_.error});default:throw Error(`Unsupported chunk type: ${_}`)}}})),request:{body:l},response:{headers:u}}}},mI=nS.object({type:nS.literal("message"),id:nS.string().nullish(),model:nS.string().nullish(),content:nS.array(nS.discriminatedUnion("type",[nS.object({type:nS.literal("text"),text:nS.string(),citations:nS.array(m_).optional()}),nS.object({type:nS.literal("thinking"),thinking:nS.string(),signature:nS.string()}),nS.object({type:nS.literal("redacted_thinking"),data:nS.string()}),nS.object({type:nS.literal("tool_use"),id:nS.string(),name:nS.string(),input:nS.unknown()}),nS.object({type:nS.literal("server_tool_use"),id:nS.string(),name:nS.string(),input:nS.record(nS.string(),nS.unknown()).nullish()}),nS.object({type:nS.literal("web_fetch_tool_result"),tool_use_id:nS.string(),content:nS.union([nS.object({type:nS.literal("web_fetch_result"),url:nS.string(),retrieved_at:nS.string(),content:nS.object({type:nS.literal("document"),title:nS.string().nullable(),citations:nS.object({enabled:nS.boolean()}).optional(),source:nS.object({type:nS.literal("text"),media_type:nS.string(),data:nS.string()})})}),nS.object({type:nS.literal("web_fetch_tool_result_error"),error_code:nS.string()})])}),nS.object({type:nS.literal("web_search_tool_result"),tool_use_id:nS.string(),content:nS.union([nS.array(nS.object({type:nS.literal("web_search_result"),url:nS.string(),title:nS.string(),encrypted_content:nS.string(),page_age:nS.string().nullish()})),nS.object({type:nS.literal("web_search_tool_result_error"),error_code:nS.string()})])}),nS.object({type:nS.literal("code_execution_tool_result"),tool_use_id:nS.string(),content:nS.union([nS.object({type:nS.literal("code_execution_result"),stdout:nS.string(),stderr:nS.string(),return_code:nS.number()}),nS.object({type:nS.literal("code_execution_tool_result_error"),error_code:nS.string()})])})])),stop_reason:nS.string().nullish(),stop_sequence:nS.string().nullish(),usage:nS.looseObject({input_tokens:nS.number(),output_tokens:nS.number(),cache_creation_input_tokens:nS.number().nullish(),cache_read_input_tokens:nS.number().nullish()})}),mk=nS.discriminatedUnion("type",[nS.object({type:nS.literal("message_start"),message:nS.object({id:nS.string().nullish(),model:nS.string().nullish(),usage:nS.looseObject({input_tokens:nS.number(),cache_creation_input_tokens:nS.number().nullish(),cache_read_input_tokens:nS.number().nullish()})})}),nS.object({type:nS.literal("content_block_start"),index:nS.number(),content_block:nS.discriminatedUnion("type",[nS.object({type:nS.literal("text"),text:nS.string()}),nS.object({type:nS.literal("thinking"),thinking:nS.string()}),nS.object({type:nS.literal("tool_use"),id:nS.string(),name:nS.string()}),nS.object({type:nS.literal("redacted_thinking"),data:nS.string()}),nS.object({type:nS.literal("server_tool_use"),id:nS.string(),name:nS.string(),input:nS.record(nS.string(),nS.unknown()).nullish()}),nS.object({type:nS.literal("web_fetch_tool_result"),tool_use_id:nS.string(),content:nS.union([nS.object({type:nS.literal("web_fetch_result"),url:nS.string(),retrieved_at:nS.string(),content:nS.object({type:nS.literal("document"),title:nS.string().nullable(),citations:nS.object({enabled:nS.boolean()}).optional(),source:nS.object({type:nS.literal("text"),media_type:nS.string(),data:nS.string()})})}),nS.object({type:nS.literal("web_fetch_tool_result_error"),error_code:nS.string()})])}),nS.object({type:nS.literal("web_search_tool_result"),tool_use_id:nS.string(),content:nS.union([nS.array(nS.object({type:nS.literal("web_search_result"),url:nS.string(),title:nS.string(),encrypted_content:nS.string(),page_age:nS.string().nullish()})),nS.object({type:nS.literal("web_search_tool_result_error"),error_code:nS.string()})])}),nS.object({type:nS.literal("code_execution_tool_result"),tool_use_id:nS.string(),content:nS.union([nS.object({type:nS.literal("code_execution_result"),stdout:nS.string(),stderr:nS.string(),return_code:nS.number()}),nS.object({type:nS.literal("code_execution_tool_result_error"),error_code:nS.string()})])})])}),nS.object({type:nS.literal("content_block_delta"),index:nS.number(),delta:nS.discriminatedUnion("type",[nS.object({type:nS.literal("input_json_delta"),partial_json:nS.string()}),nS.object({type:nS.literal("text_delta"),text:nS.string()}),nS.object({type:nS.literal("thinking_delta"),thinking:nS.string()}),nS.object({type:nS.literal("signature_delta"),signature:nS.string()}),nS.object({type:nS.literal("citations_delta"),citation:m_})])}),nS.object({type:nS.literal("content_block_stop"),index:nS.number()}),nS.object({type:nS.literal("error"),error:nS.object({type:nS.string(),message:nS.string()})}),nS.object({type:nS.literal("message_delta"),delta:nS.object({stop_reason:nS.string().nullish(),stop_sequence:nS.string().nullish()}),usage:nS.looseObject({output_tokens:nS.number(),cache_creation_input_tokens:nS.number().nullish()})}),nS.object({type:nS.literal("message_stop")}),nS.object({type:nS.literal("ping")})]),mT=nS.object({signature:nS.string().optional(),redactedData:nS.string().optional()}),mE=hO({id:"anthropic.bash_20241022",name:"bash",inputSchema:n_.object({command:n_.string(),restart:n_.boolean().optional()})}),mA=hO({id:"anthropic.bash_20250124",name:"bash",inputSchema:n_.object({command:n_.string(),restart:n_.boolean().optional()})}),mO=hO({id:"anthropic.computer_20241022",name:"computer",inputSchema:nS.object({action:nS.enum(["key","type","mouse_move","left_click","left_click_drag","right_click","middle_click","double_click","screenshot","cursor_position"]),coordinate:nS.array(nS.number().int()).optional(),text:nS.string().optional()})}),mC=hO({id:"anthropic.computer_20250124",name:"computer",inputSchema:nS.object({action:nS.enum(["key","hold_key","type","cursor_position","mouse_move","left_mouse_down","left_mouse_up","left_click","left_click_drag","right_click","middle_click","double_click","triple_click","scroll","wait","screenshot"]),coordinate:nS.tuple([nS.number().int(),nS.number().int()]).optional(),duration:nS.number().optional(),scroll_amount:nS.number().optional(),scroll_direction:nS.enum(["up","down","left","right"]).optional(),start_coordinate:nS.tuple([nS.number().int(),nS.number().int()]).optional(),text:nS.string().optional()})}),mR={bash_20241022:mE,bash_20250124:mA,codeExecution_20250522:(e={})=>my(e),computer_20241022:mO,computer_20250124:mC,textEditor_20241022:hO({id:"anthropic.text_editor_20241022",name:"str_replace_editor",inputSchema:nS.object({command:nS.enum(["view","create","str_replace","insert","undo_edit"]),path:nS.string(),file_text:nS.string().optional(),insert_line:nS.number().int().optional(),new_str:nS.string().optional(),old_str:nS.string().optional(),view_range:nS.array(nS.number().int()).optional()})}),textEditor_20250124:hO({id:"anthropic.text_editor_20250124",name:"str_replace_editor",inputSchema:nS.object({command:nS.enum(["view","create","str_replace","insert","undo_edit"]),path:nS.string(),file_text:nS.string().optional(),insert_line:nS.number().int().optional(),new_str:nS.string().optional(),old_str:nS.string().optional(),view_range:nS.array(nS.number().int()).optional()})}),textEditor_20250429:hO({id:"anthropic.text_editor_20250429",name:"str_replace_based_edit_tool",inputSchema:nS.object({command:nS.enum(["view","create","str_replace","insert"]),path:nS.string(),file_text:nS.string().optional(),insert_line:nS.number().int().optional(),new_str:nS.string().optional(),old_str:nS.string().optional(),view_range:nS.array(nS.number().int()).optional()})}),textEditor_20250728:(e={})=>mu(e),webFetch_20250910:(e={})=>mg(e),webSearch_20250305:(e={})=>mc(e)};function mM(e={}){var t;let r=null!=(t=ma(e.baseURL))?t:"https://api.anthropic.com/v1",a=()=>hs({"anthropic-version":"2023-06-01","x-api-key":hh({apiKey:e.apiKey,environmentVariableName:"ANTHROPIC_API_KEY",description:"Anthropic"}),...e.headers},"ai-sdk/anthropic/2.0.23"),s=t=>{var s;return new mx(t,{provider:"anthropic.messages",baseURL:r,headers:a,fetch:e.fetch,generateId:null!=(s=e.generateId)?s:hi,supportedUrls:()=>({"image/*":[/^https?:\/\/.*$/]})})},n=function(e){if(new.target)throw Error("The Anthropic model function cannot be called with the new keyword.");return s(e)};return n.languageModel=s,n.chat=s,n.messages=s,n.textEmbeddingModel=e=>{throw new cK({modelId:e,modelType:"textEmbeddingModel"})},n.imageModel=e=>{throw new cK({modelId:e,modelType:"imageModel"})},n.tools=mR,n}mM();var nS=n_,mN=hM({errorSchema:nS.object({error:nS.object({code:nS.number().nullable(),message:nS.string(),status:nS.string()})}),errorToMessage:e=>e.error.message}),mj=nS.object({outputDimensionality:nS.number().optional(),taskType:nS.enum(["SEMANTIC_SIMILARITY","CLASSIFICATION","CLUSTERING","RETRIEVAL_DOCUMENT","RETRIEVAL_QUERY","QUESTION_ANSWERING","FACT_VERIFICATION","CODE_RETRIEVAL_QUERY"]).optional()}),mP=class{constructor(e,t){this.specificationVersion="v2",this.maxEmbeddingsPerCall=2048,this.supportsParallelCalls=!0,this.modelId=e,this.config=t}get provider(){return this.config.provider}async doEmbed({values:e,headers:t,abortSignal:r,providerOptions:a}){let s=await hI({provider:"google",providerOptions:a,schema:mj});if(e.length>this.maxEmbeddingsPerCall)throw new cQ({provider:this.provider,modelId:this.modelId,maxEmbeddingsPerCall:this.maxEmbeddingsPerCall,values:e});let n=ht(await hR(this.config.headers),t);if(1===e.length){let{responseHeaders:t,value:a,rawValue:i}=await hT({url:`${this.config.baseURL}/models/${this.modelId}:embedContent`,headers:n,body:{model:`models/${this.modelId}`,content:{parts:[{text:e[0]}]},outputDimensionality:null==s?void 0:s.outputDimensionality,taskType:null==s?void 0:s.taskType},failedResponseHandler:mN,successfulResponseHandler:hj(mD),abortSignal:r,fetch:this.config.fetch});return{embeddings:[a.embedding.values],usage:void 0,response:{headers:t,body:i}}}let{responseHeaders:i,value:o,rawValue:l}=await hT({url:`${this.config.baseURL}/models/${this.modelId}:batchEmbedContents`,headers:n,body:{requests:e.map(e=>({model:`models/${this.modelId}`,content:{role:"user",parts:[{text:e}]},outputDimensionality:null==s?void 0:s.outputDimensionality,taskType:null==s?void 0:s.taskType}))},failedResponseHandler:mN,successfulResponseHandler:hj(m$),abortSignal:r,fetch:this.config.fetch});return{embeddings:o.embeddings.map(e=>e.values),usage:void 0,response:{headers:i,body:l}}}},m$=nS.object({embeddings:nS.array(nS.object({values:nS.array(nS.number())}))}),mD=nS.object({embedding:nS.object({values:nS.array(nS.number())})});function mL(e){var t;if(null==e||null!=(t=e)&&"object"==typeof t&&"object"===t.type&&(null==t.properties||0===Object.keys(t.properties).length)&&!t.additionalProperties)return;if("boolean"==typeof e)return{type:"boolean",properties:{}};let{type:r,description:a,required:s,properties:n,items:i,allOf:o,anyOf:l,oneOf:u,format:d,const:p,minLength:c,enum:h}=e,m={};if(a&&(m.description=a),s&&(m.required=s),d&&(m.format=d),void 0!==p&&(m.enum=[p]),r&&(Array.isArray(r)?r.includes("null")?(m.type=r.filter(e=>"null"!==e)[0],m.nullable=!0):m.type=r:"null"===r?m.type="null":m.type=r),void 0!==h&&(m.enum=h),null!=n&&(m.properties=Object.entries(n).reduce((e,[t,r])=>(e[t]=mL(r),e),{})),i&&(m.items=Array.isArray(i)?i.map(mL):mL(i)),o&&(m.allOf=o.map(mL)),l)if(l.some(e=>"object"==typeof e&&(null==e?void 0:e.type)==="null")){let e=l.filter(e=>"object"!=typeof e||(null==e?void 0:e.type)!=="null");if(1===e.length){let t=mL(e[0]);"object"==typeof t&&(m.nullable=!0,Object.assign(m,t))}else m.anyOf=e.map(mL),m.nullable=!0}else m.anyOf=l.map(mL);return u&&(m.oneOf=u.map(mL)),void 0!==c&&(m.minLength=c),m}function mU(e){return e.includes("/")?e:`models/${e}`}var mz=nS.object({responseModalities:nS.array(nS.enum(["TEXT","IMAGE"])).optional(),thinkingConfig:nS.object({thinkingBudget:nS.number().optional(),includeThoughts:nS.boolean().optional()}).optional(),cachedContent:nS.string().optional(),structuredOutputs:nS.boolean().optional(),safetySettings:nS.array(nS.object({category:nS.enum(["HARM_CATEGORY_UNSPECIFIED","HARM_CATEGORY_HATE_SPEECH","HARM_CATEGORY_DANGEROUS_CONTENT","HARM_CATEGORY_HARASSMENT","HARM_CATEGORY_SEXUALLY_EXPLICIT","HARM_CATEGORY_CIVIC_INTEGRITY"]),threshold:nS.enum(["HARM_BLOCK_THRESHOLD_UNSPECIFIED","BLOCK_LOW_AND_ABOVE","BLOCK_MEDIUM_AND_ABOVE","BLOCK_ONLY_HIGH","BLOCK_NONE","OFF"])})).optional(),threshold:nS.enum(["HARM_BLOCK_THRESHOLD_UNSPECIFIED","BLOCK_LOW_AND_ABOVE","BLOCK_MEDIUM_AND_ABOVE","BLOCK_ONLY_HIGH","BLOCK_NONE","OFF"]).optional(),audioTimestamp:nS.boolean().optional(),labels:nS.record(nS.string(),nS.string()).optional()});function mq({finishReason:e,hasToolCalls:t}){switch(e){case"STOP":return t?"tool-calls":"stop";case"MAX_TOKENS":return"length";case"IMAGE_SAFETY":case"RECITATION":case"SAFETY":case"BLOCKLIST":case"PROHIBITED_CONTENT":case"SPII":return"content-filter";case"FINISH_REASON_UNSPECIFIED":case"OTHER":return"other";case"MALFORMED_FUNCTION_CALL":return"error";default:return"unknown"}}var mV=nS.object({web:nS.object({uri:nS.string(),title:nS.string()}).nullish(),retrievedContext:nS.object({uri:nS.string(),title:nS.string()}).nullish()}),mF=nS.object({webSearchQueries:nS.array(nS.string()).nullish(),retrievalQueries:nS.array(nS.string()).nullish(),searchEntryPoint:nS.object({renderedContent:nS.string()}).nullish(),groundingChunks:nS.array(mV).nullish(),groundingSupports:nS.array(nS.object({segment:nS.object({startIndex:nS.number().nullish(),endIndex:nS.number().nullish(),text:nS.string().nullish()}),segment_text:nS.string().nullish(),groundingChunkIndices:nS.array(nS.number()).nullish(),supportChunkIndices:nS.array(nS.number()).nullish(),confidenceScores:nS.array(nS.number()).nullish(),confidenceScore:nS.array(nS.number()).nullish()})).nullish(),retrievalMetadata:nS.union([nS.object({webDynamicRetrievalScore:nS.number()}),nS.object({})]).nullish()}),mZ=hO({id:"google.google_search",name:"google_search",inputSchema:nS.object({mode:nS.enum(["MODE_DYNAMIC","MODE_UNSPECIFIED"]).default("MODE_UNSPECIFIED"),dynamicThreshold:nS.number().default(1)})}),mW=nS.object({retrievedUrl:nS.string(),urlRetrievalStatus:nS.string()}),mG=nS.object({urlMetadata:nS.array(mW)}),mB=hO({id:"google.url_context",name:"url_context",inputSchema:nS.object({})}),mK=class{constructor(e,t){var r;this.specificationVersion="v2",this.modelId=e,this.config=t,this.generateId=null!=(r=t.generateId)?r:hi}get provider(){return this.config.provider}get supportedUrls(){var e,t,r;return null!=(r=null==(t=(e=this.config).supportedUrls)?void 0:t.call(e))?r:{}}async getArgs({prompt:e,maxOutputTokens:t,temperature:r,topP:a,topK:s,frequencyPenalty:n,presencePenalty:i,stopSequences:o,responseFormat:l,seed:u,tools:d,toolChoice:p,providerOptions:c}){var h,m;let g=[],f=await hI({provider:"google",providerOptions:c,schema:mz});(null==(h=null==f?void 0:f.thinkingConfig)?void 0:h.includeThoughts)!==!0||this.config.provider.startsWith("google.vertex.")||g.push({type:"other",message:`The 'includeThoughts' option is only supported with the Google Vertex provider and might not be supported or could behave unexpectedly with the current Google provider (${this.config.provider}).`});let y=this.modelId.toLowerCase().startsWith("gemma-"),{contents:v,systemInstruction:b}=function(e,t){var r;let a=[],s=[],n=!0,i=null!=(r=null==t?void 0:t.isGemmaModel)&&r;for(let{role:t,content:r}of e)switch(t){case"system":if(!n)throw new c9({functionality:"system messages are only supported at the beginning of the conversation"});a.push({text:r});break;case"user":{n=!1;let e=[];for(let t of r)switch(t.type){case"text":e.push({text:t.text});break;case"file":{let r="image/*"===t.mediaType?"image/jpeg":t.mediaType;e.push(t.data instanceof URL?{fileData:{mimeType:r,fileUri:t.data.toString()}}:{inlineData:{mimeType:r,data:mr(t.data)}})}}s.push({role:"user",parts:e});break}case"assistant":n=!1,s.push({role:"model",parts:r.map(e=>{var t,r,a,s,n,i;switch(e.type){case"text":return 0===e.text.length?void 0:{text:e.text,thoughtSignature:null==(r=null==(t=e.providerOptions)?void 0:t.google)?void 0:r.thoughtSignature};case"reasoning":return 0===e.text.length?void 0:{text:e.text,thought:!0,thoughtSignature:null==(s=null==(a=e.providerOptions)?void 0:a.google)?void 0:s.thoughtSignature};case"file":if("image/png"!==e.mediaType)throw new c9({functionality:"Only PNG images are supported in assistant messages"});if(e.data instanceof URL)throw new c9({functionality:"File data URLs in assistant messages are not supported"});return{inlineData:{mimeType:e.mediaType,data:mr(e.data)}};case"tool-call":return{functionCall:{name:e.toolName,args:e.input},thoughtSignature:null==(i=null==(n=e.providerOptions)?void 0:n.google)?void 0:i.thoughtSignature}}}).filter(e=>void 0!==e)});break;case"tool":{n=!1;let e=[];for(let t of r){let r=t.output;if("content"===r.type)for(let a of r.value)switch(a.type){case"text":e.push({functionResponse:{name:t.toolName,response:{name:t.toolName,content:a.text}}});break;case"media":e.push({inlineData:{mimeType:a.mediaType,data:a.data}},{text:"Tool executed successfully and returned this image as a response"});break;default:e.push({text:JSON.stringify(a)})}else e.push({functionResponse:{name:t.toolName,response:{name:t.toolName,content:r.value}}})}s.push({role:"user",parts:e})}}if(i&&a.length>0&&s.length>0&&"user"===s[0].role){let e=a.map(e=>e.text).join("\n\n");s[0].parts.unshift({text:e+"\n\n"})}return{systemInstruction:a.length>0&&!i?{parts:a}:void 0,contents:s}}(e,{isGemmaModel:y}),{tools:w,toolConfig:_,toolWarnings:S}=function({tools:e,toolChoice:t,modelId:r}){var a;e=(null==e?void 0:e.length)?e:void 0;let s=[],n=r.includes("gemini-2"),i=r.includes("gemini-1.5-flash")&&!r.includes("-8b");if(null==e)return{tools:void 0,toolConfig:void 0,toolWarnings:s};let o=e.some(e=>"function"===e.type),l=e.some(e=>"provider-defined"===e.type);if(o&&l&&s.push({type:"unsupported-tool",tool:e.find(e=>"function"===e.type),details:"Cannot mix function tools with provider-defined tools in the same request. Please use either function tools or provider-defined tools, but not both."}),l){let t={};return e.filter(e=>"provider-defined"===e.type).forEach(e=>{switch(e.id){case"google.google_search":n?t.googleSearch={}:i?t.googleSearchRetrieval={dynamicRetrievalConfig:{mode:e.args.mode,dynamicThreshold:e.args.dynamicThreshold}}:t.googleSearchRetrieval={};break;case"google.url_context":n?t.urlContext={}:s.push({type:"unsupported-tool",tool:e,details:"The URL context tool is not supported with other Gemini models than Gemini 2."});break;case"google.code_execution":n?t.codeExecution={}:s.push({type:"unsupported-tool",tool:e,details:"The code execution tools is not supported with other Gemini models than Gemini 2."});break;default:s.push({type:"unsupported-tool",tool:e})}}),{tools:Object.keys(t).length>0?t:void 0,toolConfig:void 0,toolWarnings:s}}let u=[];for(let t of e)"function"===t.type?u.push({name:t.name,description:null!=(a=t.description)?a:"",parameters:mL(t.inputSchema)}):s.push({type:"unsupported-tool",tool:t});if(null==t)return{tools:{functionDeclarations:u},toolConfig:void 0,toolWarnings:s};let d=t.type;switch(d){case"auto":return{tools:{functionDeclarations:u},toolConfig:{functionCallingConfig:{mode:"AUTO"}},toolWarnings:s};case"none":return{tools:{functionDeclarations:u},toolConfig:{functionCallingConfig:{mode:"NONE"}},toolWarnings:s};case"required":return{tools:{functionDeclarations:u},toolConfig:{functionCallingConfig:{mode:"ANY"}},toolWarnings:s};case"tool":return{tools:{functionDeclarations:u},toolConfig:{functionCallingConfig:{mode:"ANY",allowedFunctionNames:[t.toolName]}},toolWarnings:s};default:throw new c9({functionality:`tool choice type: ${d}`})}}({tools:d,toolChoice:p,modelId:this.modelId});return{args:{generationConfig:{maxOutputTokens:t,temperature:r,topK:s,topP:a,frequencyPenalty:n,presencePenalty:i,stopSequences:o,seed:u,responseMimeType:(null==l?void 0:l.type)==="json"?"application/json":void 0,responseSchema:(null==l?void 0:l.type)==="json"&&null!=l.schema&&(null==(m=null==f?void 0:f.structuredOutputs)||m)?mL(l.schema):void 0,...(null==f?void 0:f.audioTimestamp)&&{audioTimestamp:f.audioTimestamp},responseModalities:null==f?void 0:f.responseModalities,thinkingConfig:null==f?void 0:f.thinkingConfig},contents:v,systemInstruction:y?void 0:b,safetySettings:null==f?void 0:f.safetySettings,tools:w,toolConfig:_,cachedContent:null==f?void 0:f.cachedContent,labels:null==f?void 0:f.labels},warnings:[...g,...S]}}async doGenerate(e){var t,r,a,s,n,i,o,l,u,d,p,c,h;let m,{args:g,warnings:f}=await this.getArgs(e),y=JSON.stringify(g),v=ht(await hR(this.config.headers),e.headers),{responseHeaders:b,value:w,rawValue:_}=await hT({url:`${this.config.baseURL}/${mU(this.modelId)}:generateContent`,headers:v,body:g,failedResponseHandler:mN,successfulResponseHandler:hj(mX),abortSignal:e.abortSignal,fetch:this.config.fetch}),S=w.candidates[0],I=[],k=null!=(r=null==(t=S.content)?void 0:t.parts)?r:[],T=w.usageMetadata;for(let e of k)if("executableCode"in e&&(null==(a=e.executableCode)?void 0:a.code)){let t=this.config.generateId();m=t,I.push({type:"tool-call",toolCallId:t,toolName:"code_execution",input:JSON.stringify(e.executableCode),providerExecuted:!0})}else"codeExecutionResult"in e&&e.codeExecutionResult?(I.push({type:"tool-result",toolCallId:m,toolName:"code_execution",result:{outcome:e.codeExecutionResult.outcome,output:e.codeExecutionResult.output},providerExecuted:!0}),m=void 0):"text"in e&&null!=e.text&&e.text.length>0?I.push({type:!0===e.thought?"reasoning":"text",text:e.text,providerMetadata:e.thoughtSignature?{google:{thoughtSignature:e.thoughtSignature}}:void 0}):"functionCall"in e?I.push({type:"tool-call",toolCallId:this.config.generateId(),toolName:e.functionCall.name,input:JSON.stringify(e.functionCall.args),providerMetadata:e.thoughtSignature?{google:{thoughtSignature:e.thoughtSignature}}:void 0}):"inlineData"in e&&I.push({type:"file",data:e.inlineData.data,mediaType:e.inlineData.mimeType});for(let e of null!=(s=mJ({groundingMetadata:S.groundingMetadata,generateId:this.config.generateId}))?s:[])I.push(e);return{content:I,finishReason:mq({finishReason:S.finishReason,hasToolCalls:I.some(e=>"tool-call"===e.type)}),usage:{inputTokens:null!=(n=null==T?void 0:T.promptTokenCount)?n:void 0,outputTokens:null!=(i=null==T?void 0:T.candidatesTokenCount)?i:void 0,totalTokens:null!=(o=null==T?void 0:T.totalTokenCount)?o:void 0,reasoningTokens:null!=(l=null==T?void 0:T.thoughtsTokenCount)?l:void 0,cachedInputTokens:null!=(u=null==T?void 0:T.cachedContentTokenCount)?u:void 0},warnings:f,providerMetadata:{google:{promptFeedback:null!=(d=w.promptFeedback)?d:null,groundingMetadata:null!=(p=S.groundingMetadata)?p:null,urlContextMetadata:null!=(c=S.urlContextMetadata)?c:null,safetyRatings:null!=(h=S.safetyRatings)?h:null,usageMetadata:null!=T?T:null}},request:{body:y},response:{headers:b,body:_}}}async doStream(e){let t,r,{args:a,warnings:s}=await this.getArgs(e),n=JSON.stringify(a),i=ht(await hR(this.config.headers),e.headers),{responseHeaders:o,value:l}=await hT({url:`${this.config.baseURL}/${mU(this.modelId)}:streamGenerateContent?alt=sse`,headers:i,body:a,failedResponseHandler:mN,successfulResponseHandler:hN(m0),abortSignal:e.abortSignal,fetch:this.config.fetch}),u="unknown",d={inputTokens:void 0,outputTokens:void 0,totalTokens:void 0},p=this.config.generateId,c=!1,h=null,m=null,g=0,f=new Set;return{stream:l.pipeThrough(new TransformStream({start(e){e.enqueue({type:"stream-start",warnings:s})},transform(a,s){var n,i,o,l,y,v,b,w,_,S,I,k,T;if(e.includeRawChunks&&s.enqueue({type:"raw",rawValue:a.rawValue}),!a.success)return void s.enqueue({type:"error",error:a.error});let E=a.value,A=E.usageMetadata;null!=A&&(d.inputTokens=null!=(n=A.promptTokenCount)?n:void 0,d.outputTokens=null!=(i=A.candidatesTokenCount)?i:void 0,d.totalTokens=null!=(o=A.totalTokenCount)?o:void 0,d.reasoningTokens=null!=(l=A.thoughtsTokenCount)?l:void 0,d.cachedInputTokens=null!=(y=A.cachedContentTokenCount)?y:void 0);let O=null==(v=E.candidates)?void 0:v[0];if(null==O)return;let C=O.content,R=mJ({groundingMetadata:O.groundingMetadata,generateId:p});if(null!=R)for(let e of R)"url"!==e.sourceType||f.has(e.url)||(f.add(e.url),s.enqueue(e));if(null!=C){for(let e of null!=(b=C.parts)?b:[])if("executableCode"in e&&(null==(w=e.executableCode)?void 0:w.code)){let r=p();t=r,s.enqueue({type:"tool-call",toolCallId:r,toolName:"code_execution",input:JSON.stringify(e.executableCode),providerExecuted:!0}),c=!0}else if("codeExecutionResult"in e&&e.codeExecutionResult){let r=t;r&&(s.enqueue({type:"tool-result",toolCallId:r,toolName:"code_execution",result:{outcome:e.codeExecutionResult.outcome,output:e.codeExecutionResult.output},providerExecuted:!0}),t=void 0)}else"text"in e&&null!=e.text&&e.text.length>0&&(!0===e.thought?(null!==h&&(s.enqueue({type:"text-end",id:h}),h=null),null===m&&(m=String(g++),s.enqueue({type:"reasoning-start",id:m,providerMetadata:e.thoughtSignature?{google:{thoughtSignature:e.thoughtSignature}}:void 0})),s.enqueue({type:"reasoning-delta",id:m,delta:e.text,providerMetadata:e.thoughtSignature?{google:{thoughtSignature:e.thoughtSignature}}:void 0})):(null!==m&&(s.enqueue({type:"reasoning-end",id:m}),m=null),null===h&&(h=String(g++),s.enqueue({type:"text-start",id:h,providerMetadata:e.thoughtSignature?{google:{thoughtSignature:e.thoughtSignature}}:void 0})),s.enqueue({type:"text-delta",id:h,delta:e.text,providerMetadata:e.thoughtSignature?{google:{thoughtSignature:e.thoughtSignature}}:void 0})));let e=null==(T=C.parts)?void 0:T.filter(e=>"inlineData"in e);if(null!=e)for(let t of e)s.enqueue({type:"file",mediaType:t.inlineData.mimeType,data:t.inlineData.data});let r=function({parts:e,generateId:t}){let r=null==e?void 0:e.filter(e=>"functionCall"in e);return null==r||0===r.length?void 0:r.map(e=>({type:"tool-call",toolCallId:t(),toolName:e.functionCall.name,args:JSON.stringify(e.functionCall.args),providerMetadata:e.thoughtSignature?{google:{thoughtSignature:e.thoughtSignature}}:void 0}))}({parts:C.parts,generateId:p});if(null!=r)for(let e of r)s.enqueue({type:"tool-input-start",id:e.toolCallId,toolName:e.toolName,providerMetadata:e.providerMetadata}),s.enqueue({type:"tool-input-delta",id:e.toolCallId,delta:e.args,providerMetadata:e.providerMetadata}),s.enqueue({type:"tool-input-end",id:e.toolCallId,providerMetadata:e.providerMetadata}),s.enqueue({type:"tool-call",toolCallId:e.toolCallId,toolName:e.toolName,input:e.args,providerMetadata:e.providerMetadata}),c=!0}null!=O.finishReason&&(u=mq({finishReason:O.finishReason,hasToolCalls:c}),r={google:{promptFeedback:null!=(_=E.promptFeedback)?_:null,groundingMetadata:null!=(S=O.groundingMetadata)?S:null,urlContextMetadata:null!=(I=O.urlContextMetadata)?I:null,safetyRatings:null!=(k=O.safetyRatings)?k:null}},null!=A&&(r.google.usageMetadata=A))},flush(e){null!==h&&e.enqueue({type:"text-end",id:h}),null!==m&&e.enqueue({type:"reasoning-end",id:m}),e.enqueue({type:"finish",finishReason:u,usage:d,providerMetadata:r})}})),response:{headers:o},request:{body:n}}}};function mJ({groundingMetadata:e,generateId:t}){var r;return null==(r=null==e?void 0:e.groundingChunks)?void 0:r.filter(e=>null!=e.web).map(e=>({type:"source",sourceType:"url",id:t(),url:e.web.uri,title:e.web.title}))}var mH=nS.object({parts:nS.array(nS.union([nS.object({functionCall:nS.object({name:nS.string(),args:nS.unknown()}),thoughtSignature:nS.string().nullish()}),nS.object({inlineData:nS.object({mimeType:nS.string(),data:nS.string()})}),nS.object({executableCode:nS.object({language:nS.string(),code:nS.string()}).nullish(),codeExecutionResult:nS.object({outcome:nS.string(),output:nS.string()}).nullish(),text:nS.string().nullish(),thought:nS.boolean().nullish(),thoughtSignature:nS.string().nullish()})])).nullish()}),mY=nS.object({category:nS.string().nullish(),probability:nS.string().nullish(),probabilityScore:nS.number().nullish(),severity:nS.string().nullish(),severityScore:nS.number().nullish(),blocked:nS.boolean().nullish()}),mQ=nS.object({cachedContentTokenCount:nS.number().nullish(),thoughtsTokenCount:nS.number().nullish(),promptTokenCount:nS.number().nullish(),candidatesTokenCount:nS.number().nullish(),totalTokenCount:nS.number().nullish()}),mX=nS.object({candidates:nS.array(nS.object({content:mH.nullish().or(nS.object({}).strict()),finishReason:nS.string().nullish(),safetyRatings:nS.array(mY).nullish(),groundingMetadata:mF.nullish(),urlContextMetadata:mG.nullish()})),usageMetadata:mQ.nullish(),promptFeedback:nS.object({blockReason:nS.string().nullish(),safetyRatings:nS.array(mY).nullish()}).nullish()}),m0=nS.object({candidates:nS.array(nS.object({content:mH.nullish(),finishReason:nS.string().nullish(),safetyRatings:nS.array(mY).nullish(),groundingMetadata:mF.nullish(),urlContextMetadata:mG.nullish()})).nullish(),usageMetadata:mQ.nullish(),promptFeedback:nS.object({blockReason:nS.string().nullish(),safetyRatings:nS.array(mY).nullish()}).nullish()}),m1={googleSearch:mZ,urlContext:mB,codeExecution:hC({id:"google.code_execution",name:"code_execution",inputSchema:nS.object({language:nS.string().describe("The programming language of the code."),code:nS.string().describe("The code to be executed.")}),outputSchema:nS.object({outcome:nS.string().describe('The outcome of the execution (e.g., "OUTCOME_OK").'),output:nS.string().describe("The output from the code execution.")})})},m2=class{constructor(e,t,r){this.modelId=e,this.settings=t,this.config=r,this.specificationVersion="v2"}get maxImagesPerCall(){var e;return null!=(e=this.settings.maxImagesPerCall)?e:4}get provider(){return this.config.provider}async doGenerate(e){var t,r,a;let{prompt:s,n=1,size:i="1024x1024",aspectRatio:o="1:1",seed:l,providerOptions:u,headers:d,abortSignal:p}=e,c=[];null!=i&&c.push({type:"unsupported-setting",setting:"size",details:"This model does not support the `size` option. Use `aspectRatio` instead."}),null!=l&&c.push({type:"unsupported-setting",setting:"seed",details:"This model does not support the `seed` option through this provider."});let h=await hI({provider:"google",providerOptions:u,schema:m5}),m=null!=(a=null==(r=null==(t=this.config._internal)?void 0:t.currentDate)?void 0:r.call(t))?a:new Date,g={sampleCount:n};null!=o&&(g.aspectRatio=o),h&&Object.assign(g,h);let{responseHeaders:f,value:y}=await hT({url:`${this.config.baseURL}/models/${this.modelId}:predict`,headers:ht(await hR(this.config.headers),d),body:{instances:[{prompt:s}],parameters:g},failedResponseHandler:mN,successfulResponseHandler:hj(m4),abortSignal:p,fetch:this.config.fetch});return{images:y.predictions.map(e=>e.bytesBase64Encoded),warnings:null!=c?c:[],providerMetadata:{google:{images:y.predictions.map(e=>({}))}},response:{timestamp:m,modelId:this.modelId,headers:f}}}},m4=nS.object({predictions:nS.array(nS.object({bytesBase64Encoded:nS.string()})).default([])}),m5=nS.object({personGeneration:nS.enum(["dont_allow","allow_adult","allow_all"]).nullish(),aspectRatio:nS.enum(["1:1","3:4","4:3","9:16","16:9"]).nullish()});function m3(e={}){var t;let r=null!=(t=ma(e.baseURL))?t:"https://generativelanguage.googleapis.com/v1beta",a=()=>hs({"x-goog-api-key":hh({apiKey:e.apiKey,environmentVariableName:"GOOGLE_GENERATIVE_AI_API_KEY",description:"Google Generative AI"}),...e.headers},"ai-sdk/google/2.0.17"),s=t=>{var s;return new mK(t,{provider:"google.generative-ai",baseURL:r,headers:a,generateId:null!=(s=e.generateId)?s:hi,supportedUrls:()=>({"*":[RegExp(`^${r}/files/.*$`),RegExp("^https://(?:www\\.)?youtube\\.com/watch\\?v=[\\w-]+(?:&[\\w=&.-]*)?$"),RegExp("^https://youtu\\.be/[\\w-]+(?:\\?[\\w=&.-]*)?$")]}),fetch:e.fetch})},n=t=>new mP(t,{provider:"google.generative-ai",baseURL:r,headers:a,fetch:e.fetch}),i=(t,s={})=>new m2(t,s,{provider:"google.generative-ai",baseURL:r,headers:a,fetch:e.fetch}),o=function(e){if(new.target)throw Error("The Google Generative AI model function cannot be called with the new keyword.");return s(e)};return o.languageModel=s,o.chat=s,o.generativeAI=s,o.embedding=n,o.textEmbedding=n,o.textEmbeddingModel=n,o.image=i,o.imageModel=i,o.tools=m1,o}m3();var nS=n_;function m9(e){var t,r;return null!=(r=null==(t=null==e?void 0:e.providerOptions)?void 0:t.openaiCompatible)?r:{}}function m6({id:e,model:t,created:r}){return{id:null!=e?e:void 0,modelId:null!=t?t:void 0,timestamp:null!=r?new Date(1e3*r):void 0}}function m8(e){switch(e){case"stop":return"stop";case"length":return"length";case"content_filter":return"content-filter";case"function_call":case"tool_calls":return"tool-calls";default:return"unknown"}}var m7=nS.object({user:nS.string().optional(),reasoningEffort:nS.string().optional()}),ge={errorSchema:nS.object({error:nS.object({message:nS.string(),type:nS.string().nullish(),param:nS.any().nullish(),code:nS.union([nS.string(),nS.number()]).nullish()})}),errorToMessage:e=>e.error.message},gt=class{constructor(e,t){var r,a;this.specificationVersion="v2",this.modelId=e,this.config=t;const s=null!=(r=t.errorStructure)?r:ge;this.chunkSchema=gs(s.errorSchema),this.failedResponseHandler=hM(s),this.supportsStructuredOutputs=null!=(a=t.supportsStructuredOutputs)&&a}get provider(){return this.config.provider}get providerOptionsName(){return this.config.provider.split(".")[0].trim()}get supportedUrls(){var e,t,r;return null!=(r=null==(t=(e=this.config).supportedUrls)?void 0:t.call(e))?r:{}}async getArgs({prompt:e,maxOutputTokens:t,temperature:r,topP:a,topK:s,frequencyPenalty:n,presencePenalty:i,providerOptions:o,stopSequences:l,responseFormat:u,seed:d,toolChoice:p,tools:c}){var h,m,g,f;let y=[],v=Object.assign(null!=(h=await hI({provider:"openai-compatible",providerOptions:o,schema:m7}))?h:{},null!=(m=await hI({provider:this.providerOptionsName,providerOptions:o,schema:m7}))?m:{});null!=s&&y.push({type:"unsupported-setting",setting:"topK"}),(null==u?void 0:u.type)!=="json"||null==u.schema||this.supportsStructuredOutputs||y.push({type:"unsupported-setting",setting:"responseFormat",details:"JSON response format schema is only supported with structuredOutputs"});let{tools:b,toolChoice:w,toolWarnings:_}=function({tools:e,toolChoice:t}){e=(null==e?void 0:e.length)?e:void 0;let r=[];if(null==e)return{tools:void 0,toolChoice:void 0,toolWarnings:r};let a=[];for(let t of e)"provider-defined"===t.type?r.push({type:"unsupported-tool",tool:t}):a.push({type:"function",function:{name:t.name,description:t.description,parameters:t.inputSchema}});if(null==t)return{tools:a,toolChoice:void 0,toolWarnings:r};let s=t.type;switch(s){case"auto":case"none":case"required":return{tools:a,toolChoice:s,toolWarnings:r};case"tool":return{tools:a,toolChoice:{type:"function",function:{name:t.toolName}},toolWarnings:r};default:throw new c9({functionality:`tool choice type: ${s}`})}}({tools:c,toolChoice:p});return{args:{model:this.modelId,user:v.user,max_tokens:t,temperature:r,top_p:a,frequency_penalty:n,presence_penalty:i,response_format:(null==u?void 0:u.type)==="json"?!0===this.supportsStructuredOutputs&&null!=u.schema?{type:"json_schema",json_schema:{schema:u.schema,name:null!=(g=u.name)?g:"response",description:u.description}}:{type:"json_object"}:void 0,stop:l,seed:d,...Object.fromEntries(Object.entries(null!=(f=null==o?void 0:o[this.providerOptionsName])?f:{}).filter(([e])=>!Object.keys(m7.shape).includes(e))),reasoning_effort:v.reasoningEffort,messages:function(e){let t=[];for(let{role:r,content:a,...s}of e){let e=m9({...s});switch(r){case"system":t.push({role:"system",content:a,...e});break;case"user":if(1===a.length&&"text"===a[0].type){t.push({role:"user",content:a[0].text,...m9(a[0])});break}t.push({role:"user",content:a.map(e=>{let t=m9(e);switch(e.type){case"text":return{type:"text",text:e.text,...t};case"file":if(e.mediaType.startsWith("image/")){let r="image/*"===e.mediaType?"image/jpeg":e.mediaType;return{type:"image_url",image_url:{url:e.data instanceof URL?e.data.toString():`data:${r};base64,${mr(e.data)}`},...t}}throw new c9({functionality:`file part media type ${e.mediaType}`})}}),...e});break;case"assistant":{let r="",s=[];for(let e of a){let t=m9(e);switch(e.type){case"text":r+=e.text;break;case"tool-call":s.push({id:e.toolCallId,type:"function",function:{name:e.toolName,arguments:JSON.stringify(e.input)},...t})}}t.push({role:"assistant",content:r,tool_calls:s.length>0?s:void 0,...e});break}case"tool":for(let e of a){let r,a=e.output;switch(a.type){case"text":case"error-text":r=a.value;break;case"content":case"json":case"error-json":r=JSON.stringify(a.value)}let s=m9(e);t.push({role:"tool",tool_call_id:e.toolCallId,content:r,...s})}break;default:throw Error(`Unsupported role: ${r}`)}}return t}(e),tools:b,tool_choice:w},warnings:[...y,..._]}}async doGenerate(e){var t,r,a,s,n,i,o,l,u,d,p,c,h,m,g,f,y;let{args:v,warnings:b}=await this.getArgs({...e}),w=JSON.stringify(v),{responseHeaders:_,value:S,rawValue:I}=await hT({url:this.config.url({path:"/chat/completions",modelId:this.modelId}),headers:ht(this.config.headers(),e.headers),body:v,failedResponseHandler:this.failedResponseHandler,successfulResponseHandler:hj(ga),abortSignal:e.abortSignal,fetch:this.config.fetch}),k=S.choices[0],T=[],E=k.message.content;null!=E&&E.length>0&&T.push({type:"text",text:E});let A=null!=(t=k.message.reasoning_content)?t:k.message.reasoning;if(null!=A&&A.length>0&&T.push({type:"reasoning",text:A}),null!=k.message.tool_calls)for(let e of k.message.tool_calls)T.push({type:"tool-call",toolCallId:null!=(r=e.id)?r:hi(),toolName:e.function.name,input:e.function.arguments});let O={[this.providerOptionsName]:{},...await (null==(s=null==(a=this.config.metadataExtractor)?void 0:a.extractMetadata)?void 0:s.call(a,{parsedBody:I}))},C=null==(n=S.usage)?void 0:n.completion_tokens_details;return(null==C?void 0:C.accepted_prediction_tokens)!=null&&(O[this.providerOptionsName].acceptedPredictionTokens=null==C?void 0:C.accepted_prediction_tokens),(null==C?void 0:C.rejected_prediction_tokens)!=null&&(O[this.providerOptionsName].rejectedPredictionTokens=null==C?void 0:C.rejected_prediction_tokens),{content:T,finishReason:m8(k.finish_reason),usage:{inputTokens:null!=(o=null==(i=S.usage)?void 0:i.prompt_tokens)?o:void 0,outputTokens:null!=(u=null==(l=S.usage)?void 0:l.completion_tokens)?u:void 0,totalTokens:null!=(p=null==(d=S.usage)?void 0:d.total_tokens)?p:void 0,reasoningTokens:null!=(m=null==(h=null==(c=S.usage)?void 0:c.completion_tokens_details)?void 0:h.reasoning_tokens)?m:void 0,cachedInputTokens:null!=(y=null==(f=null==(g=S.usage)?void 0:g.prompt_tokens_details)?void 0:f.cached_tokens)?y:void 0},providerMetadata:O,request:{body:w},response:{...m6(S),headers:_,body:I},warnings:b}}async doStream(e){var t;let{args:r,warnings:a}=await this.getArgs({...e}),s={...r,stream:!0,stream_options:this.config.includeUsage?{include_usage:!0}:void 0},n=null==(t=this.config.metadataExtractor)?void 0:t.createStreamExtractor(),{responseHeaders:i,value:o}=await hT({url:this.config.url({path:"/chat/completions",modelId:this.modelId}),headers:ht(this.config.headers(),e.headers),body:s,failedResponseHandler:this.failedResponseHandler,successfulResponseHandler:hN(this.chunkSchema),abortSignal:e.abortSignal,fetch:this.config.fetch}),l=[],u="unknown",d={completionTokens:void 0,completionTokensDetails:{reasoningTokens:void 0,acceptedPredictionTokens:void 0,rejectedPredictionTokens:void 0},promptTokens:void 0,promptTokensDetails:{cachedTokens:void 0},totalTokens:void 0},p=!0,c=this.providerOptionsName,h=!1,m=!1;return{stream:o.pipeThrough(new TransformStream({start(e){e.enqueue({type:"stream-start",warnings:a})},transform(t,r){var a,s,i,o,c,g,f,y,v,b,w,_,S;if(e.includeRawChunks&&r.enqueue({type:"raw",rawValue:t.rawValue}),!t.success){u="error",r.enqueue({type:"error",error:t.error});return}let I=t.value;if(null==n||n.processChunk(t.rawValue),"error"in I){u="error",r.enqueue({type:"error",error:I.error.message});return}if(p&&(p=!1,r.enqueue({type:"response-metadata",...m6(I)})),null!=I.usage){let{prompt_tokens:e,completion_tokens:t,total_tokens:r,prompt_tokens_details:a,completion_tokens_details:s}=I.usage;d.promptTokens=null!=e?e:void 0,d.completionTokens=null!=t?t:void 0,d.totalTokens=null!=r?r:void 0,(null==s?void 0:s.reasoning_tokens)!=null&&(d.completionTokensDetails.reasoningTokens=null==s?void 0:s.reasoning_tokens),(null==s?void 0:s.accepted_prediction_tokens)!=null&&(d.completionTokensDetails.acceptedPredictionTokens=null==s?void 0:s.accepted_prediction_tokens),(null==s?void 0:s.rejected_prediction_tokens)!=null&&(d.completionTokensDetails.rejectedPredictionTokens=null==s?void 0:s.rejected_prediction_tokens),(null==a?void 0:a.cached_tokens)!=null&&(d.promptTokensDetails.cachedTokens=null==a?void 0:a.cached_tokens)}let k=I.choices[0];if((null==k?void 0:k.finish_reason)!=null&&(u=m8(k.finish_reason)),(null==k?void 0:k.delta)==null)return;let T=k.delta,E=null!=(a=T.reasoning_content)?a:T.reasoning;if(E&&(h||(r.enqueue({type:"reasoning-start",id:"reasoning-0"}),h=!0),r.enqueue({type:"reasoning-delta",id:"reasoning-0",delta:E})),T.content&&(m||(r.enqueue({type:"text-start",id:"txt-0"}),m=!0),r.enqueue({type:"text-delta",id:"txt-0",delta:T.content})),null!=T.tool_calls)for(let e of T.tool_calls){let t=e.index;if(null==l[t]){if(null==e.id)throw new c$({data:e,message:"Expected 'id' to be a string."});if((null==(s=e.function)?void 0:s.name)==null)throw new c$({data:e,message:"Expected 'function.name' to be a string."});r.enqueue({type:"tool-input-start",id:e.id,toolName:e.function.name}),l[t]={id:e.id,type:"function",function:{name:e.function.name,arguments:null!=(i=e.function.arguments)?i:""},hasFinished:!1};let a=l[t];(null==(o=a.function)?void 0:o.name)!=null&&(null==(c=a.function)?void 0:c.arguments)!=null&&(a.function.arguments.length>0&&r.enqueue({type:"tool-input-delta",id:a.id,delta:a.function.arguments}),hx(a.function.arguments)&&(r.enqueue({type:"tool-input-end",id:a.id}),r.enqueue({type:"tool-call",toolCallId:null!=(g=a.id)?g:hi(),toolName:a.function.name,input:a.function.arguments}),a.hasFinished=!0));continue}let a=l[t];!a.hasFinished&&((null==(f=e.function)?void 0:f.arguments)!=null&&(a.function.arguments+=null!=(v=null==(y=e.function)?void 0:y.arguments)?v:""),r.enqueue({type:"tool-input-delta",id:a.id,delta:null!=(b=e.function.arguments)?b:""}),(null==(w=a.function)?void 0:w.name)!=null&&(null==(_=a.function)?void 0:_.arguments)!=null&&hx(a.function.arguments)&&(r.enqueue({type:"tool-input-end",id:a.id}),r.enqueue({type:"tool-call",toolCallId:null!=(S=a.id)?S:hi(),toolName:a.function.name,input:a.function.arguments}),a.hasFinished=!0))}},flush(e){var t,r,a,s,i,o;for(let r of(h&&e.enqueue({type:"reasoning-end",id:"reasoning-0"}),m&&e.enqueue({type:"text-end",id:"txt-0"}),l.filter(e=>!e.hasFinished)))e.enqueue({type:"tool-input-end",id:r.id}),e.enqueue({type:"tool-call",toolCallId:null!=(t=r.id)?t:hi(),toolName:r.function.name,input:r.function.arguments});let p={[c]:{},...null==n?void 0:n.buildMetadata()};null!=d.completionTokensDetails.acceptedPredictionTokens&&(p[c].acceptedPredictionTokens=d.completionTokensDetails.acceptedPredictionTokens),null!=d.completionTokensDetails.rejectedPredictionTokens&&(p[c].rejectedPredictionTokens=d.completionTokensDetails.rejectedPredictionTokens),e.enqueue({type:"finish",finishReason:u,usage:{inputTokens:null!=(r=d.promptTokens)?r:void 0,outputTokens:null!=(a=d.completionTokens)?a:void 0,totalTokens:null!=(s=d.totalTokens)?s:void 0,reasoningTokens:null!=(i=d.completionTokensDetails.reasoningTokens)?i:void 0,cachedInputTokens:null!=(o=d.promptTokensDetails.cachedTokens)?o:void 0},providerMetadata:p})}})),request:{body:s},response:{headers:i}}}},gr=nS.object({prompt_tokens:nS.number().nullish(),completion_tokens:nS.number().nullish(),total_tokens:nS.number().nullish(),prompt_tokens_details:nS.object({cached_tokens:nS.number().nullish()}).nullish(),completion_tokens_details:nS.object({reasoning_tokens:nS.number().nullish(),accepted_prediction_tokens:nS.number().nullish(),rejected_prediction_tokens:nS.number().nullish()}).nullish()}).nullish(),ga=nS.object({id:nS.string().nullish(),created:nS.number().nullish(),model:nS.string().nullish(),choices:nS.array(nS.object({message:nS.object({role:nS.literal("assistant").nullish(),content:nS.string().nullish(),reasoning_content:nS.string().nullish(),reasoning:nS.string().nullish(),tool_calls:nS.array(nS.object({id:nS.string().nullish(),function:nS.object({name:nS.string(),arguments:nS.string()})})).nullish()}),finish_reason:nS.string().nullish()})),usage:gr}),gs=e=>nS.union([nS.object({id:nS.string().nullish(),created:nS.number().nullish(),model:nS.string().nullish(),choices:nS.array(nS.object({delta:nS.object({role:nS.enum(["assistant"]).nullish(),content:nS.string().nullish(),reasoning_content:nS.string().nullish(),reasoning:nS.string().nullish(),tool_calls:nS.array(nS.object({index:nS.number(),id:nS.string().nullish(),function:nS.object({name:nS.string().nullish(),arguments:nS.string().nullish()})})).nullish()}).nullish(),finish_reason:nS.string().nullish()})),usage:gr}),e]);function gn({id:e,model:t,created:r}){return{id:null!=e?e:void 0,modelId:null!=t?t:void 0,timestamp:null!=r?new Date(1e3*r):void 0}}function gi(e){switch(e){case"stop":return"stop";case"length":return"length";case"content_filter":return"content-filter";case"function_call":case"tool_calls":return"tool-calls";default:return"unknown"}}var go=nS.object({echo:nS.boolean().optional(),logitBias:nS.record(nS.string(),nS.number()).optional(),suffix:nS.string().optional(),user:nS.string().optional()}),gl=class{constructor(e,t){var r;this.specificationVersion="v2",this.modelId=e,this.config=t;const a=null!=(r=t.errorStructure)?r:ge;this.chunkSchema=gp(a.errorSchema),this.failedResponseHandler=hM(a)}get provider(){return this.config.provider}get providerOptionsName(){return this.config.provider.split(".")[0].trim()}get supportedUrls(){var e,t,r;return null!=(r=null==(t=(e=this.config).supportedUrls)?void 0:t.call(e))?r:{}}async getArgs({prompt:e,maxOutputTokens:t,temperature:r,topP:a,topK:s,frequencyPenalty:n,presencePenalty:i,stopSequences:o,responseFormat:l,seed:u,providerOptions:d,tools:p,toolChoice:c}){var h;let m=[],g=null!=(h=await hI({provider:this.providerOptionsName,providerOptions:d,schema:go}))?h:{};null!=s&&m.push({type:"unsupported-setting",setting:"topK"}),(null==p?void 0:p.length)&&m.push({type:"unsupported-setting",setting:"tools"}),null!=c&&m.push({type:"unsupported-setting",setting:"toolChoice"}),null!=l&&"text"!==l.type&&m.push({type:"unsupported-setting",setting:"responseFormat",details:"JSON response format is not supported."});let{prompt:f,stopSequences:y}=function({prompt:e,user:t="user",assistant:r="assistant"}){let a="";for(let{role:s,content:n}of("system"===e[0].role&&(a+=`${e[0].content}

`,e=e.slice(1)),e))switch(s){case"system":throw new cM({message:"Unexpected system message in prompt: ${content}",prompt:e});case"user":{let e=n.map(e=>{if("text"===e.type)return e.text}).filter(Boolean).join("");a+=`${t}:
${e}

`;break}case"assistant":{let e=n.map(e=>{switch(e.type){case"text":return e.text;case"tool-call":throw new c9({functionality:"tool-call messages"})}}).join("");a+=`${r}:
${e}

`;break}case"tool":throw new c9({functionality:"tool messages"});default:throw Error(`Unsupported role: ${s}`)}return{prompt:a+=`${r}:
`,stopSequences:[`
${t}:`]}}({prompt:e}),v=[...null!=y?y:[],...null!=o?o:[]];return{args:{model:this.modelId,echo:g.echo,logit_bias:g.logitBias,suffix:g.suffix,user:g.user,max_tokens:t,temperature:r,top_p:a,frequency_penalty:n,presence_penalty:i,seed:u,...null==d?void 0:d[this.providerOptionsName],prompt:f,stop:v.length>0?v:void 0},warnings:m}}async doGenerate(e){var t,r,a,s,n,i;let{args:o,warnings:l}=await this.getArgs(e),{responseHeaders:u,value:d,rawValue:p}=await hT({url:this.config.url({path:"/completions",modelId:this.modelId}),headers:ht(this.config.headers(),e.headers),body:o,failedResponseHandler:this.failedResponseHandler,successfulResponseHandler:hj(gd),abortSignal:e.abortSignal,fetch:this.config.fetch}),c=d.choices[0],h=[];return null!=c.text&&c.text.length>0&&h.push({type:"text",text:c.text}),{content:h,usage:{inputTokens:null!=(r=null==(t=d.usage)?void 0:t.prompt_tokens)?r:void 0,outputTokens:null!=(s=null==(a=d.usage)?void 0:a.completion_tokens)?s:void 0,totalTokens:null!=(i=null==(n=d.usage)?void 0:n.total_tokens)?i:void 0},finishReason:gi(c.finish_reason),request:{body:o},response:{...gn(d),headers:u,body:p},warnings:l}}async doStream(e){let{args:t,warnings:r}=await this.getArgs(e),a={...t,stream:!0,stream_options:this.config.includeUsage?{include_usage:!0}:void 0},{responseHeaders:s,value:n}=await hT({url:this.config.url({path:"/completions",modelId:this.modelId}),headers:ht(this.config.headers(),e.headers),body:a,failedResponseHandler:this.failedResponseHandler,successfulResponseHandler:hN(this.chunkSchema),abortSignal:e.abortSignal,fetch:this.config.fetch}),i="unknown",o={inputTokens:void 0,outputTokens:void 0,totalTokens:void 0},l=!0;return{stream:n.pipeThrough(new TransformStream({start(e){e.enqueue({type:"stream-start",warnings:r})},transform(t,r){var a,s,n;if(e.includeRawChunks&&r.enqueue({type:"raw",rawValue:t.rawValue}),!t.success){i="error",r.enqueue({type:"error",error:t.error});return}let u=t.value;if("error"in u){i="error",r.enqueue({type:"error",error:u.error});return}l&&(l=!1,r.enqueue({type:"response-metadata",...gn(u)}),r.enqueue({type:"text-start",id:"0"})),null!=u.usage&&(o.inputTokens=null!=(a=u.usage.prompt_tokens)?a:void 0,o.outputTokens=null!=(s=u.usage.completion_tokens)?s:void 0,o.totalTokens=null!=(n=u.usage.total_tokens)?n:void 0);let d=u.choices[0];(null==d?void 0:d.finish_reason)!=null&&(i=gi(d.finish_reason)),(null==d?void 0:d.text)!=null&&r.enqueue({type:"text-delta",id:"0",delta:d.text})},flush(e){l||e.enqueue({type:"text-end",id:"0"}),e.enqueue({type:"finish",finishReason:i,usage:o})}})),request:{body:a},response:{headers:s}}}},gu=nS.object({prompt_tokens:nS.number(),completion_tokens:nS.number(),total_tokens:nS.number()}),gd=nS.object({id:nS.string().nullish(),created:nS.number().nullish(),model:nS.string().nullish(),choices:nS.array(nS.object({text:nS.string(),finish_reason:nS.string()})),usage:gu.nullish()}),gp=e=>nS.union([nS.object({id:nS.string().nullish(),created:nS.number().nullish(),model:nS.string().nullish(),choices:nS.array(nS.object({text:nS.string(),finish_reason:nS.string().nullish(),index:nS.number()})),usage:gu.nullish()}),e]),gc=nS.object({dimensions:nS.number().optional(),user:nS.string().optional()}),gh=class{constructor(e,t){this.specificationVersion="v2",this.modelId=e,this.config=t}get provider(){return this.config.provider}get maxEmbeddingsPerCall(){var e;return null!=(e=this.config.maxEmbeddingsPerCall)?e:2048}get supportsParallelCalls(){var e;return null==(e=this.config.supportsParallelCalls)||e}get providerOptionsName(){return this.config.provider.split(".")[0].trim()}async doEmbed({values:e,headers:t,abortSignal:r,providerOptions:a}){var s,n,i;let o=Object.assign(null!=(s=await hI({provider:"openai-compatible",providerOptions:a,schema:gc}))?s:{},null!=(n=await hI({provider:this.providerOptionsName,providerOptions:a,schema:gc}))?n:{});if(e.length>this.maxEmbeddingsPerCall)throw new cQ({provider:this.provider,modelId:this.modelId,maxEmbeddingsPerCall:this.maxEmbeddingsPerCall,values:e});let{responseHeaders:l,value:u,rawValue:d}=await hT({url:this.config.url({path:"/embeddings",modelId:this.modelId}),headers:ht(this.config.headers(),t),body:{model:this.modelId,input:e,encoding_format:"float",dimensions:o.dimensions,user:o.user},failedResponseHandler:hM(null!=(i=this.config.errorStructure)?i:ge),successfulResponseHandler:hj(gm),abortSignal:r,fetch:this.config.fetch});return{embeddings:u.data.map(e=>e.embedding),usage:u.usage?{tokens:u.usage.prompt_tokens}:void 0,providerMetadata:u.providerMetadata,response:{headers:l,body:d}}}},gm=nS.object({data:nS.array(nS.object({embedding:nS.array(nS.number())})),usage:nS.object({prompt_tokens:nS.number()}).nullish(),providerMetadata:nS.record(nS.string(),nS.record(nS.string(),nS.any())).optional()}),gg=class{constructor(e,t){this.modelId=e,this.config=t,this.specificationVersion="v2",this.maxImagesPerCall=10}get provider(){return this.config.provider}async doGenerate({prompt:e,n:t,size:r,aspectRatio:a,seed:s,providerOptions:n,headers:i,abortSignal:o}){var l,u,d,p,c;let h=[];null!=a&&h.push({type:"unsupported-setting",setting:"aspectRatio",details:"This model does not support aspect ratio. Use `size` instead."}),null!=s&&h.push({type:"unsupported-setting",setting:"seed"});let m=null!=(d=null==(u=null==(l=this.config._internal)?void 0:l.currentDate)?void 0:u.call(l))?d:new Date,{value:g,responseHeaders:f}=await hT({url:this.config.url({path:"/images/generations",modelId:this.modelId}),headers:ht(this.config.headers(),i),body:{model:this.modelId,prompt:e,n:t,size:r,...null!=(p=n.openai)?p:{},response_format:"b64_json"},failedResponseHandler:hM(null!=(c=this.config.errorStructure)?c:ge),successfulResponseHandler:hj(gf),abortSignal:o,fetch:this.config.fetch});return{images:g.data.map(e=>e.b64_json),warnings:h,response:{timestamp:m,modelId:this.modelId,headers:f}}}},gf=nS.object({data:nS.array(nS.object({b64_json:nS.string()}))});function gy(e){let t=ma(e.baseURL),r=e.name,a={...e.apiKey&&{Authorization:`Bearer ${e.apiKey}`},...e.headers},s=()=>hs(a,"ai-sdk/openai-compatible/1.0.19"),n=a=>({provider:`${r}.${a}`,url:({path:r})=>{let a=new URL(`${t}${r}`);return e.queryParams&&(a.search=new URLSearchParams(e.queryParams).toString()),a.toString()},headers:s,fetch:e.fetch}),i=e=>o(e),o=t=>new gt(t,{...n("chat"),includeUsage:e.includeUsage,supportsStructuredOutputs:e.supportsStructuredOutputs}),l=e=>i(e);return l.languageModel=i,l.chatModel=o,l.completionModel=t=>new gl(t,{...n("completion"),includeUsage:e.includeUsage}),l.textEmbeddingModel=e=>new gh(e,{...n("embedding")}),l.imageModel=e=>new gg(e,n("image")),l}var nS=n_,gv=nS.object({error:nS.object({message:nS.string(),type:nS.string().nullish(),param:nS.any().nullish(),code:nS.union([nS.string(),nS.number()]).nullish()})}),gb=hM({errorSchema:gv,errorToMessage:e=>e.error.message});function gw({id:e,model:t,created:r}){return{id:null!=e?e:void 0,modelId:null!=t?t:void 0,timestamp:null!=r?new Date(1e3*r):void 0}}function g_(e){switch(e){case"stop":return"stop";case"length":return"length";case"content_filter":return"content-filter";case"function_call":case"tool_calls":return"tool-calls";default:return"unknown"}}var gS=nS.object({logitBias:nS.record(nS.coerce.number(),nS.number()).optional(),logprobs:nS.union([nS.boolean(),nS.number()]).optional(),parallelToolCalls:nS.boolean().optional(),user:nS.string().optional(),reasoningEffort:nS.enum(["minimal","low","medium","high"]).optional(),maxCompletionTokens:nS.number().optional(),store:nS.boolean().optional(),metadata:nS.record(nS.string().max(64),nS.string().max(512)).optional(),prediction:nS.record(nS.string(),nS.any()).optional(),structuredOutputs:nS.boolean().optional(),serviceTier:nS.enum(["auto","flex","priority"]).optional(),strictJsonSchema:nS.boolean().optional(),textVerbosity:nS.enum(["low","medium","high"]).optional(),promptCacheKey:nS.string().optional(),safetyIdentifier:nS.string().optional()}),gx=class{constructor(e,t){this.specificationVersion="v2",this.supportedUrls={"image/*":[/^https?:\/\/.*$/]},this.modelId=e,this.config=t}get provider(){return this.config.provider}async getArgs({prompt:e,maxOutputTokens:t,temperature:r,topP:a,topK:s,frequencyPenalty:n,presencePenalty:i,stopSequences:o,responseFormat:l,seed:u,tools:d,toolChoice:p,providerOptions:c}){var h,m,g,f,y,v,b,w,_;let S=[],I=null!=(h=await hI({provider:"openai",providerOptions:c,schema:gS}))?h:{},k=null==(m=I.structuredOutputs)||m;null!=s&&S.push({type:"unsupported-setting",setting:"topK"}),(null==l?void 0:l.type)!=="json"||null==l.schema||k||S.push({type:"unsupported-setting",setting:"responseFormat",details:"JSON response format schema is only supported with structuredOutputs"});let{messages:T,warnings:E}=function({prompt:e,systemMessageMode:t="system"}){let r=[],a=[];for(let{role:s,content:n}of e)switch(s){case"system":switch(t){case"system":r.push({role:"system",content:n});break;case"developer":r.push({role:"developer",content:n});break;case"remove":a.push({type:"other",message:"system messages are removed for this model"});break;default:throw Error(`Unsupported system message mode: ${t}`)}break;case"user":if(1===n.length&&"text"===n[0].type){r.push({role:"user",content:n[0].text});break}r.push({role:"user",content:n.map((e,t)=>{var r,a,s;switch(e.type){case"text":return{type:"text",text:e.text};case"file":if(e.mediaType.startsWith("image/")){let t="image/*"===e.mediaType?"image/jpeg":e.mediaType;return{type:"image_url",image_url:{url:e.data instanceof URL?e.data.toString():`data:${t};base64,${mr(e.data)}`,detail:null==(a=null==(r=e.providerOptions)?void 0:r.openai)?void 0:a.imageDetail}}}if(e.mediaType.startsWith("audio/")){if(e.data instanceof URL)throw new c9({functionality:"audio file parts with URLs"});switch(e.mediaType){case"audio/wav":return{type:"input_audio",input_audio:{data:mr(e.data),format:"wav"}};case"audio/mp3":case"audio/mpeg":return{type:"input_audio",input_audio:{data:mr(e.data),format:"mp3"}};default:throw new c9({functionality:`audio content parts with media type ${e.mediaType}`})}}if("application/pdf"===e.mediaType){if(e.data instanceof URL)throw new c9({functionality:"PDF file parts with URLs"});return{type:"file",file:"string"==typeof e.data&&e.data.startsWith("file-")?{file_id:e.data}:{filename:null!=(s=e.filename)?s:`part-${t}.pdf`,file_data:`data:application/pdf;base64,${mr(e.data)}`}}}else throw new c9({functionality:`file part media type ${e.mediaType}`})}})});break;case"assistant":{let e="",t=[];for(let r of n)switch(r.type){case"text":e+=r.text;break;case"tool-call":t.push({id:r.toolCallId,type:"function",function:{name:r.toolName,arguments:JSON.stringify(r.input)}})}r.push({role:"assistant",content:e,tool_calls:t.length>0?t:void 0});break}case"tool":for(let e of n){let t,a=e.output;switch(a.type){case"text":case"error-text":t=a.value;break;case"content":case"json":case"error-json":t=JSON.stringify(a.value)}r.push({role:"tool",tool_call_id:e.toolCallId,content:t})}break;default:throw Error(`Unsupported role: ${s}`)}return{messages:r,warnings:a}}({prompt:e,systemMessageMode:gE(y=this.modelId)?null!=(b=null==(v=gA[y])?void 0:v.systemMessageMode)?b:"developer":"system"});S.push(...E);let A=null!=(g=I.strictJsonSchema)&&g,O={model:this.modelId,logit_bias:I.logitBias,logprobs:!0===I.logprobs||"number"==typeof I.logprobs||void 0,top_logprobs:"number"==typeof I.logprobs?I.logprobs:"boolean"==typeof I.logprobs&&I.logprobs?0:void 0,user:I.user,parallel_tool_calls:I.parallelToolCalls,max_tokens:t,temperature:r,top_p:a,frequency_penalty:n,presence_penalty:i,response_format:(null==l?void 0:l.type)==="json"?k&&null!=l.schema?{type:"json_schema",json_schema:{schema:l.schema,strict:A,name:null!=(f=l.name)?f:"response",description:l.description}}:{type:"json_object"}:void 0,stop:o,seed:u,verbosity:I.textVerbosity,max_completion_tokens:I.maxCompletionTokens,store:I.store,metadata:I.metadata,prediction:I.prediction,reasoning_effort:I.reasoningEffort,service_tier:I.serviceTier,prompt_cache_key:I.promptCacheKey,safety_identifier:I.safetyIdentifier,messages:T};gE(this.modelId)?(null!=O.temperature&&(O.temperature=void 0,S.push({type:"unsupported-setting",setting:"temperature",details:"temperature is not supported for reasoning models"})),null!=O.top_p&&(O.top_p=void 0,S.push({type:"unsupported-setting",setting:"topP",details:"topP is not supported for reasoning models"})),null!=O.frequency_penalty&&(O.frequency_penalty=void 0,S.push({type:"unsupported-setting",setting:"frequencyPenalty",details:"frequencyPenalty is not supported for reasoning models"})),null!=O.presence_penalty&&(O.presence_penalty=void 0,S.push({type:"unsupported-setting",setting:"presencePenalty",details:"presencePenalty is not supported for reasoning models"})),null!=O.logit_bias&&(O.logit_bias=void 0,S.push({type:"other",message:"logitBias is not supported for reasoning models"})),null!=O.logprobs&&(O.logprobs=void 0,S.push({type:"other",message:"logprobs is not supported for reasoning models"})),null!=O.top_logprobs&&(O.top_logprobs=void 0,S.push({type:"other",message:"topLogprobs is not supported for reasoning models"})),null!=O.max_tokens&&(null==O.max_completion_tokens&&(O.max_completion_tokens=O.max_tokens),O.max_tokens=void 0)):(this.modelId.startsWith("gpt-4o-search-preview")||this.modelId.startsWith("gpt-4o-mini-search-preview"))&&null!=O.temperature&&(O.temperature=void 0,S.push({type:"unsupported-setting",setting:"temperature",details:"temperature is not supported for the search preview models and has been removed."})),"flex"!==I.serviceTier||(w=this.modelId).startsWith("o3")||w.startsWith("o4-mini")||w.startsWith("gpt-5")&&!w.startsWith("gpt-5-chat")||(S.push({type:"unsupported-setting",setting:"serviceTier",details:"flex processing is only available for o3, o4-mini, and gpt-5 models"}),O.service_tier=void 0),"priority"!==I.serviceTier||(_=this.modelId).startsWith("gpt-4")||_.startsWith("gpt-5-mini")||_.startsWith("gpt-5")&&!_.startsWith("gpt-5-nano")&&!_.startsWith("gpt-5-chat")||_.startsWith("o3")||_.startsWith("o4-mini")||(S.push({type:"unsupported-setting",setting:"serviceTier",details:"priority processing is only available for supported models (gpt-4, gpt-5, gpt-5-mini, o3, o4-mini) and requires Enterprise access. gpt-5-nano is not supported"}),O.service_tier=void 0);let{tools:C,toolChoice:R,toolWarnings:M}=function({tools:e,toolChoice:t,structuredOutputs:r,strictJsonSchema:a}){e=(null==e?void 0:e.length)?e:void 0;let s=[];if(null==e)return{tools:void 0,toolChoice:void 0,toolWarnings:s};let n=[];for(let t of e)"function"===t.type?n.push({type:"function",function:{name:t.name,description:t.description,parameters:t.inputSchema,strict:r?a:void 0}}):s.push({type:"unsupported-tool",tool:t});if(null==t)return{tools:n,toolChoice:void 0,toolWarnings:s};let i=t.type;switch(i){case"auto":case"none":case"required":return{tools:n,toolChoice:i,toolWarnings:s};case"tool":return{tools:n,toolChoice:{type:"function",function:{name:t.toolName}},toolWarnings:s};default:throw new c9({functionality:`tool choice type: ${i}`})}}({tools:d,toolChoice:p,structuredOutputs:k,strictJsonSchema:A});return{args:{...O,tools:C,tool_choice:R},warnings:[...S,...M]}}async doGenerate(e){var t,r,a,s,n,i,o,l,u,d,p,c,h,m;let{args:g,warnings:f}=await this.getArgs(e),{responseHeaders:y,value:v,rawValue:b}=await hT({url:this.config.url({path:"/chat/completions",modelId:this.modelId}),headers:ht(this.config.headers(),e.headers),body:g,failedResponseHandler:gb,successfulResponseHandler:hj(gk),abortSignal:e.abortSignal,fetch:this.config.fetch}),w=v.choices[0],_=[],S=w.message.content;for(let e of(null!=S&&S.length>0&&_.push({type:"text",text:S}),null!=(t=w.message.tool_calls)?t:[]))_.push({type:"tool-call",toolCallId:null!=(r=e.id)?r:hi(),toolName:e.function.name,input:e.function.arguments});for(let e of null!=(a=w.message.annotations)?a:[])_.push({type:"source",sourceType:"url",id:hi(),url:e.url,title:e.title});let I=null==(s=v.usage)?void 0:s.completion_tokens_details,k=null==(n=v.usage)?void 0:n.prompt_tokens_details,T={openai:{}};return(null==I?void 0:I.accepted_prediction_tokens)!=null&&(T.openai.acceptedPredictionTokens=null==I?void 0:I.accepted_prediction_tokens),(null==I?void 0:I.rejected_prediction_tokens)!=null&&(T.openai.rejectedPredictionTokens=null==I?void 0:I.rejected_prediction_tokens),(null==(i=w.logprobs)?void 0:i.content)!=null&&(T.openai.logprobs=w.logprobs.content),{content:_,finishReason:g_(w.finish_reason),usage:{inputTokens:null!=(l=null==(o=v.usage)?void 0:o.prompt_tokens)?l:void 0,outputTokens:null!=(d=null==(u=v.usage)?void 0:u.completion_tokens)?d:void 0,totalTokens:null!=(c=null==(p=v.usage)?void 0:p.total_tokens)?c:void 0,reasoningTokens:null!=(h=null==I?void 0:I.reasoning_tokens)?h:void 0,cachedInputTokens:null!=(m=null==k?void 0:k.cached_tokens)?m:void 0},request:{body:g},response:{...gw(v),headers:y,body:b},warnings:f,providerMetadata:T}}async doStream(e){let{args:t,warnings:r}=await this.getArgs(e),a={...t,stream:!0,stream_options:{include_usage:!0}},{responseHeaders:s,value:n}=await hT({url:this.config.url({path:"/chat/completions",modelId:this.modelId}),headers:ht(this.config.headers(),e.headers),body:a,failedResponseHandler:gb,successfulResponseHandler:hN(gT),abortSignal:e.abortSignal,fetch:this.config.fetch}),i=[],o="unknown",l={inputTokens:void 0,outputTokens:void 0,totalTokens:void 0},u=!0,d=!1,p={openai:{}};return{stream:n.pipeThrough(new TransformStream({start(e){e.enqueue({type:"stream-start",warnings:r})},transform(t,r){var a,s,n,c,h,m,g,f,y,v,b,w,_,S,I,k,T,E,A,O,C,R,M,N;if(e.includeRawChunks&&r.enqueue({type:"raw",rawValue:t.rawValue}),!t.success){o="error",r.enqueue({type:"error",error:t.error});return}let j=t.value;if("error"in j){o="error",r.enqueue({type:"error",error:j.error});return}u&&(u=!1,r.enqueue({type:"response-metadata",...gw(j)})),null!=j.usage&&(l.inputTokens=null!=(a=j.usage.prompt_tokens)?a:void 0,l.outputTokens=null!=(s=j.usage.completion_tokens)?s:void 0,l.totalTokens=null!=(n=j.usage.total_tokens)?n:void 0,l.reasoningTokens=null!=(h=null==(c=j.usage.completion_tokens_details)?void 0:c.reasoning_tokens)?h:void 0,l.cachedInputTokens=null!=(g=null==(m=j.usage.prompt_tokens_details)?void 0:m.cached_tokens)?g:void 0,(null==(f=j.usage.completion_tokens_details)?void 0:f.accepted_prediction_tokens)!=null&&(p.openai.acceptedPredictionTokens=null==(y=j.usage.completion_tokens_details)?void 0:y.accepted_prediction_tokens),(null==(v=j.usage.completion_tokens_details)?void 0:v.rejected_prediction_tokens)!=null&&(p.openai.rejectedPredictionTokens=null==(b=j.usage.completion_tokens_details)?void 0:b.rejected_prediction_tokens));let P=j.choices[0];if((null==P?void 0:P.finish_reason)!=null&&(o=g_(P.finish_reason)),(null==(w=null==P?void 0:P.logprobs)?void 0:w.content)!=null&&(p.openai.logprobs=P.logprobs.content),(null==P?void 0:P.delta)==null)return;let $=P.delta;if(null!=$.content&&(d||(r.enqueue({type:"text-start",id:"0"}),d=!0),r.enqueue({type:"text-delta",id:"0",delta:$.content})),null!=$.tool_calls)for(let e of $.tool_calls){let t=e.index;if(null==i[t]){if("function"!==e.type)throw new c$({data:e,message:"Expected 'function' type."});if(null==e.id)throw new c$({data:e,message:"Expected 'id' to be a string."});if((null==(_=e.function)?void 0:_.name)==null)throw new c$({data:e,message:"Expected 'function.name' to be a string."});r.enqueue({type:"tool-input-start",id:e.id,toolName:e.function.name}),i[t]={id:e.id,type:"function",function:{name:e.function.name,arguments:null!=(S=e.function.arguments)?S:""},hasFinished:!1};let a=i[t];(null==(I=a.function)?void 0:I.name)!=null&&(null==(k=a.function)?void 0:k.arguments)!=null&&(a.function.arguments.length>0&&r.enqueue({type:"tool-input-delta",id:a.id,delta:a.function.arguments}),hx(a.function.arguments)&&(r.enqueue({type:"tool-input-end",id:a.id}),r.enqueue({type:"tool-call",toolCallId:null!=(T=a.id)?T:hi(),toolName:a.function.name,input:a.function.arguments}),a.hasFinished=!0));continue}let a=i[t];!a.hasFinished&&((null==(E=e.function)?void 0:E.arguments)!=null&&(a.function.arguments+=null!=(O=null==(A=e.function)?void 0:A.arguments)?O:""),r.enqueue({type:"tool-input-delta",id:a.id,delta:null!=(C=e.function.arguments)?C:""}),(null==(R=a.function)?void 0:R.name)!=null&&(null==(M=a.function)?void 0:M.arguments)!=null&&hx(a.function.arguments)&&(r.enqueue({type:"tool-input-end",id:a.id}),r.enqueue({type:"tool-call",toolCallId:null!=(N=a.id)?N:hi(),toolName:a.function.name,input:a.function.arguments}),a.hasFinished=!0))}if(null!=$.annotations)for(let e of $.annotations)r.enqueue({type:"source",sourceType:"url",id:hi(),url:e.url,title:e.title})},flush(e){d&&e.enqueue({type:"text-end",id:"0"}),e.enqueue({type:"finish",finishReason:o,usage:l,...null!=p?{providerMetadata:p}:{}})}})),request:{body:a},response:{headers:s}}}},gI=nS.object({prompt_tokens:nS.number().nullish(),completion_tokens:nS.number().nullish(),total_tokens:nS.number().nullish(),prompt_tokens_details:nS.object({cached_tokens:nS.number().nullish()}).nullish(),completion_tokens_details:nS.object({reasoning_tokens:nS.number().nullish(),accepted_prediction_tokens:nS.number().nullish(),rejected_prediction_tokens:nS.number().nullish()}).nullish()}).nullish(),gk=nS.object({id:nS.string().nullish(),created:nS.number().nullish(),model:nS.string().nullish(),choices:nS.array(nS.object({message:nS.object({role:nS.literal("assistant").nullish(),content:nS.string().nullish(),tool_calls:nS.array(nS.object({id:nS.string().nullish(),type:nS.literal("function"),function:nS.object({name:nS.string(),arguments:nS.string()})})).nullish(),annotations:nS.array(nS.object({type:nS.literal("url_citation"),start_index:nS.number(),end_index:nS.number(),url:nS.string(),title:nS.string()})).nullish()}),index:nS.number(),logprobs:nS.object({content:nS.array(nS.object({token:nS.string(),logprob:nS.number(),top_logprobs:nS.array(nS.object({token:nS.string(),logprob:nS.number()}))})).nullish()}).nullish(),finish_reason:nS.string().nullish()})),usage:gI}),gT=nS.union([nS.object({id:nS.string().nullish(),created:nS.number().nullish(),model:nS.string().nullish(),choices:nS.array(nS.object({delta:nS.object({role:nS.enum(["assistant"]).nullish(),content:nS.string().nullish(),tool_calls:nS.array(nS.object({index:nS.number(),id:nS.string().nullish(),type:nS.literal("function").nullish(),function:nS.object({name:nS.string().nullish(),arguments:nS.string().nullish()})})).nullish(),annotations:nS.array(nS.object({type:nS.literal("url_citation"),start_index:nS.number(),end_index:nS.number(),url:nS.string(),title:nS.string()})).nullish()}).nullish(),logprobs:nS.object({content:nS.array(nS.object({token:nS.string(),logprob:nS.number(),top_logprobs:nS.array(nS.object({token:nS.string(),logprob:nS.number()}))})).nullish()}).nullish(),finish_reason:nS.string().nullish(),index:nS.number()})),usage:gI}),gv]);function gE(e){return(e.startsWith("o")||e.startsWith("gpt-5"))&&!e.startsWith("gpt-5-chat")}var gA={"o1-mini":{systemMessageMode:"remove"},"o1-mini-2024-09-12":{systemMessageMode:"remove"},"o1-preview":{systemMessageMode:"remove"},"o1-preview-2024-09-12":{systemMessageMode:"remove"},o3:{systemMessageMode:"developer"},"o3-2025-04-16":{systemMessageMode:"developer"},"o3-mini":{systemMessageMode:"developer"},"o3-mini-2025-01-31":{systemMessageMode:"developer"},"o4-mini":{systemMessageMode:"developer"},"o4-mini-2025-04-16":{systemMessageMode:"developer"}};function gO({id:e,model:t,created:r}){return{id:null!=e?e:void 0,modelId:null!=t?t:void 0,timestamp:null!=r?new Date(1e3*r):void 0}}function gC(e){switch(e){case"stop":return"stop";case"length":return"length";case"content_filter":return"content-filter";case"function_call":case"tool_calls":return"tool-calls";default:return"unknown"}}var gR=nS.object({echo:nS.boolean().optional(),logitBias:nS.record(nS.string(),nS.number()).optional(),suffix:nS.string().optional(),user:nS.string().optional(),logprobs:nS.union([nS.boolean(),nS.number()]).optional()}),gM=class{constructor(e,t){this.specificationVersion="v2",this.supportedUrls={},this.modelId=e,this.config=t}get providerOptionsName(){return this.config.provider.split(".")[0].trim()}get provider(){return this.config.provider}async getArgs({prompt:e,maxOutputTokens:t,temperature:r,topP:a,topK:s,frequencyPenalty:n,presencePenalty:i,stopSequences:o,responseFormat:l,tools:u,toolChoice:d,seed:p,providerOptions:c}){let h=[],m={...await hI({provider:"openai",providerOptions:c,schema:gR}),...await hI({provider:this.providerOptionsName,providerOptions:c,schema:gR})};null!=s&&h.push({type:"unsupported-setting",setting:"topK"}),(null==u?void 0:u.length)&&h.push({type:"unsupported-setting",setting:"tools"}),null!=d&&h.push({type:"unsupported-setting",setting:"toolChoice"}),null!=l&&"text"!==l.type&&h.push({type:"unsupported-setting",setting:"responseFormat",details:"JSON response format is not supported."});let{prompt:g,stopSequences:f}=function({prompt:e,user:t="user",assistant:r="assistant"}){let a="";for(let{role:s,content:n}of("system"===e[0].role&&(a+=`${e[0].content}

`,e=e.slice(1)),e))switch(s){case"system":throw new cM({message:"Unexpected system message in prompt: ${content}",prompt:e});case"user":{let e=n.map(e=>{if("text"===e.type)return e.text}).filter(Boolean).join("");a+=`${t}:
${e}

`;break}case"assistant":{let e=n.map(e=>{switch(e.type){case"text":return e.text;case"tool-call":throw new c9({functionality:"tool-call messages"})}}).join("");a+=`${r}:
${e}

`;break}case"tool":throw new c9({functionality:"tool messages"});default:throw Error(`Unsupported role: ${s}`)}return{prompt:a+=`${r}:
`,stopSequences:[`
${t}:`]}}({prompt:e}),y=[...null!=f?f:[],...null!=o?o:[]];return{args:{model:this.modelId,echo:m.echo,logit_bias:m.logitBias,logprobs:(null==m?void 0:m.logprobs)===!0?0:(null==m?void 0:m.logprobs)===!1||null==m?void 0:m.logprobs,suffix:m.suffix,user:m.user,max_tokens:t,temperature:r,top_p:a,frequency_penalty:n,presence_penalty:i,seed:p,prompt:g,stop:y.length>0?y:void 0},warnings:h}}async doGenerate(e){var t,r,a;let{args:s,warnings:n}=await this.getArgs(e),{responseHeaders:i,value:o,rawValue:l}=await hT({url:this.config.url({path:"/completions",modelId:this.modelId}),headers:ht(this.config.headers(),e.headers),body:s,failedResponseHandler:gb,successfulResponseHandler:hj(gj),abortSignal:e.abortSignal,fetch:this.config.fetch}),u=o.choices[0],d={openai:{}};return null!=u.logprobs&&(d.openai.logprobs=u.logprobs),{content:[{type:"text",text:u.text}],usage:{inputTokens:null==(t=o.usage)?void 0:t.prompt_tokens,outputTokens:null==(r=o.usage)?void 0:r.completion_tokens,totalTokens:null==(a=o.usage)?void 0:a.total_tokens},finishReason:gC(u.finish_reason),request:{body:s},response:{...gO(o),headers:i,body:l},providerMetadata:d,warnings:n}}async doStream(e){let{args:t,warnings:r}=await this.getArgs(e),a={...t,stream:!0,stream_options:{include_usage:!0}},{responseHeaders:s,value:n}=await hT({url:this.config.url({path:"/completions",modelId:this.modelId}),headers:ht(this.config.headers(),e.headers),body:a,failedResponseHandler:gb,successfulResponseHandler:hN(gP),abortSignal:e.abortSignal,fetch:this.config.fetch}),i="unknown",o={openai:{}},l={inputTokens:void 0,outputTokens:void 0,totalTokens:void 0},u=!0;return{stream:n.pipeThrough(new TransformStream({start(e){e.enqueue({type:"stream-start",warnings:r})},transform(t,r){if(e.includeRawChunks&&r.enqueue({type:"raw",rawValue:t.rawValue}),!t.success){i="error",r.enqueue({type:"error",error:t.error});return}let a=t.value;if("error"in a){i="error",r.enqueue({type:"error",error:a.error});return}u&&(u=!1,r.enqueue({type:"response-metadata",...gO(a)}),r.enqueue({type:"text-start",id:"0"})),null!=a.usage&&(l.inputTokens=a.usage.prompt_tokens,l.outputTokens=a.usage.completion_tokens,l.totalTokens=a.usage.total_tokens);let s=a.choices[0];(null==s?void 0:s.finish_reason)!=null&&(i=gC(s.finish_reason)),(null==s?void 0:s.logprobs)!=null&&(o.openai.logprobs=s.logprobs),(null==s?void 0:s.text)!=null&&s.text.length>0&&r.enqueue({type:"text-delta",id:"0",delta:s.text})},flush(e){u||e.enqueue({type:"text-end",id:"0"}),e.enqueue({type:"finish",finishReason:i,providerMetadata:o,usage:l})}})),request:{body:a},response:{headers:s}}}},gN=nS.object({prompt_tokens:nS.number(),completion_tokens:nS.number(),total_tokens:nS.number()}),gj=nS.object({id:nS.string().nullish(),created:nS.number().nullish(),model:nS.string().nullish(),choices:nS.array(nS.object({text:nS.string(),finish_reason:nS.string(),logprobs:nS.object({tokens:nS.array(nS.string()),token_logprobs:nS.array(nS.number()),top_logprobs:nS.array(nS.record(nS.string(),nS.number())).nullish()}).nullish()})),usage:gN.nullish()}),gP=nS.union([nS.object({id:nS.string().nullish(),created:nS.number().nullish(),model:nS.string().nullish(),choices:nS.array(nS.object({text:nS.string(),finish_reason:nS.string().nullish(),index:nS.number(),logprobs:nS.object({tokens:nS.array(nS.string()),token_logprobs:nS.array(nS.number()),top_logprobs:nS.array(nS.record(nS.string(),nS.number())).nullish()}).nullish()})),usage:gN.nullish()}),gv]),g$=nS.object({dimensions:nS.number().optional(),user:nS.string().optional()}),gD=class{constructor(e,t){this.specificationVersion="v2",this.maxEmbeddingsPerCall=2048,this.supportsParallelCalls=!0,this.modelId=e,this.config=t}get provider(){return this.config.provider}async doEmbed({values:e,headers:t,abortSignal:r,providerOptions:a}){var s;if(e.length>this.maxEmbeddingsPerCall)throw new cQ({provider:this.provider,modelId:this.modelId,maxEmbeddingsPerCall:this.maxEmbeddingsPerCall,values:e});let n=null!=(s=await hI({provider:"openai",providerOptions:a,schema:g$}))?s:{},{responseHeaders:i,value:o,rawValue:l}=await hT({url:this.config.url({path:"/embeddings",modelId:this.modelId}),headers:ht(this.config.headers(),t),body:{model:this.modelId,input:e,encoding_format:"float",dimensions:n.dimensions,user:n.user},failedResponseHandler:gb,successfulResponseHandler:hj(gL),abortSignal:r,fetch:this.config.fetch});return{embeddings:o.data.map(e=>e.embedding),usage:o.usage?{tokens:o.usage.prompt_tokens}:void 0,response:{headers:i,body:l}}}},gL=nS.object({data:nS.array(nS.object({embedding:nS.array(nS.number())})),usage:nS.object({prompt_tokens:nS.number()}).nullish()}),gU={"dall-e-3":1,"dall-e-2":10,"gpt-image-1":10},gz=new Set(["gpt-image-1"]),gq=class{constructor(e,t){this.modelId=e,this.config=t,this.specificationVersion="v2"}get maxImagesPerCall(){var e;return null!=(e=gU[this.modelId])?e:1}get provider(){return this.config.provider}async doGenerate({prompt:e,n:t,size:r,aspectRatio:a,seed:s,providerOptions:n,headers:i,abortSignal:o}){var l,u,d,p;let c=[];null!=a&&c.push({type:"unsupported-setting",setting:"aspectRatio",details:"This model does not support aspect ratio. Use `size` instead."}),null!=s&&c.push({type:"unsupported-setting",setting:"seed"});let h=null!=(d=null==(u=null==(l=this.config._internal)?void 0:l.currentDate)?void 0:u.call(l))?d:new Date,{value:m,responseHeaders:g}=await hT({url:this.config.url({path:"/images/generations",modelId:this.modelId}),headers:ht(this.config.headers(),i),body:{model:this.modelId,prompt:e,n:t,size:r,...null!=(p=n.openai)?p:{},...!gz.has(this.modelId)?{response_format:"b64_json"}:{}},failedResponseHandler:gb,successfulResponseHandler:hj(gV),abortSignal:o,fetch:this.config.fetch});return{images:m.data.map(e=>e.b64_json),warnings:c,response:{timestamp:h,modelId:this.modelId,headers:g},providerMetadata:{openai:{images:m.data.map(e=>e.revised_prompt?{revisedPrompt:e.revised_prompt}:null)}}}}},gV=nS.object({data:nS.array(nS.object({b64_json:nS.string(),revised_prompt:nS.string().optional()}))}),gF=nS.object({code:nS.string().nullish(),containerId:nS.string()}),gZ=nS.object({outputs:nS.array(nS.discriminatedUnion("type",[nS.object({type:nS.literal("logs"),logs:nS.string()}),nS.object({type:nS.literal("image"),url:nS.string()})])).nullish()}),gW=nS.object({container:nS.union([nS.string(),nS.object({fileIds:nS.array(nS.string()).optional()})]).optional()}),gG=hC({id:"openai.code_interpreter",name:"code_interpreter",inputSchema:gF,outputSchema:gZ}),gB=nS.object({key:nS.string(),type:nS.enum(["eq","ne","gt","gte","lt","lte"]),value:nS.union([nS.string(),nS.number(),nS.boolean()])}),gK=nS.object({type:nS.enum(["and","or"]),filters:nS.array(nS.union([gB,nS.lazy(()=>gK)]))}),gJ=nS.object({vectorStoreIds:nS.array(nS.string()),maxNumResults:nS.number().optional(),ranking:nS.object({ranker:nS.string().optional(),scoreThreshold:nS.number().optional()}).optional(),filters:nS.union([gB,gK]).optional()}),gH=nS.object({queries:nS.array(nS.string()),results:nS.array(nS.object({attributes:nS.record(nS.string(),nS.unknown()),fileId:nS.string(),filename:nS.string(),score:nS.number(),text:nS.string()})).nullable()}),gY=hC({id:"openai.file_search",name:"file_search",inputSchema:nS.object({}),outputSchema:gH}),gQ=nS.object({background:nS.enum(["auto","opaque","transparent"]).optional(),inputFidelity:nS.enum(["low","high"]).optional(),inputImageMask:nS.object({fileId:nS.string().optional(),imageUrl:nS.string().optional()}).optional(),model:nS.string().optional(),moderation:nS.enum(["auto"]).optional(),outputCompression:nS.number().int().min(0).max(100).optional(),outputFormat:nS.enum(["png","jpeg","webp"]).optional(),quality:nS.enum(["auto","low","medium","high"]).optional(),size:nS.enum(["1024x1024","1024x1536","1536x1024","auto"]).optional()}).strict(),gX=nS.object({result:nS.string()}),g0=hC({id:"openai.image_generation",name:"image_generation",inputSchema:nS.object({}),outputSchema:gX}),g1=nS.object({action:nS.object({type:nS.literal("exec"),command:nS.array(nS.string()),timeoutMs:nS.number().optional(),user:nS.string().optional(),workingDirectory:nS.string().optional(),env:nS.record(nS.string(),nS.string()).optional()})}),g2=nS.object({output:nS.string()}),g4=hC({id:"openai.local_shell",name:"local_shell",inputSchema:g1,outputSchema:g2}),g5=nS.object({filters:nS.object({allowedDomains:nS.array(nS.string()).optional()}).optional(),searchContextSize:nS.enum(["low","medium","high"]).optional(),userLocation:nS.object({type:nS.literal("approximate"),country:nS.string().optional(),city:nS.string().optional(),region:nS.string().optional(),timezone:nS.string().optional()}).optional()}),g3=hO({id:"openai.web_search",name:"web_search",inputSchema:nS.object({action:nS.discriminatedUnion("type",[nS.object({type:nS.literal("search"),query:nS.string().nullish()}),nS.object({type:nS.literal("open_page"),url:nS.string()}),nS.object({type:nS.literal("find"),url:nS.string(),pattern:nS.string()})]).nullish()})}),g9=nS.object({searchContextSize:nS.enum(["low","medium","high"]).optional(),userLocation:nS.object({type:nS.literal("approximate"),country:nS.string().optional(),city:nS.string().optional(),region:nS.string().optional(),timezone:nS.string().optional()}).optional()}),g6={codeInterpreter:(e={})=>gG(e),fileSearch:gY,imageGeneration:(e={})=>g0(e),localShell:g4,webSearchPreview:hO({id:"openai.web_search_preview",name:"web_search_preview",inputSchema:nS.object({action:nS.discriminatedUnion("type",[nS.object({type:nS.literal("search"),query:nS.string().nullish()}),nS.object({type:nS.literal("open_page"),url:nS.string()}),nS.object({type:nS.literal("find"),url:nS.string(),pattern:nS.string()})]).nullish()})}),webSearch:(e={})=>g3(e)};function g8(e,t){return!!t&&t.some(t=>e.startsWith(t))}async function g7({prompt:e,systemMessageMode:t,fileIdPrefixes:r,store:a,hasLocalShellTool:s=!1}){var n,i,o,l,u,d,p,c,h;let m=[],g=[];for(let{role:f,content:y}of e)switch(f){case"system":switch(t){case"system":m.push({role:"system",content:y});break;case"developer":m.push({role:"developer",content:y});break;case"remove":g.push({type:"other",message:"system messages are removed for this model"});break;default:throw Error(`Unsupported system message mode: ${t}`)}break;case"user":m.push({role:"user",content:y.map((e,t)=>{var a,s,n;switch(e.type){case"text":return{type:"input_text",text:e.text};case"file":if(e.mediaType.startsWith("image/")){let t="image/*"===e.mediaType?"image/jpeg":e.mediaType;return{type:"input_image",...e.data instanceof URL?{image_url:e.data.toString()}:"string"==typeof e.data&&g8(e.data,r)?{file_id:e.data}:{image_url:`data:${t};base64,${mr(e.data)}`},detail:null==(s=null==(a=e.providerOptions)?void 0:a.openai)?void 0:s.imageDetail}}if("application/pdf"===e.mediaType){if(e.data instanceof URL)return{type:"input_file",file_url:e.data.toString()};return{type:"input_file",..."string"==typeof e.data&&g8(e.data,r)?{file_id:e.data}:{filename:null!=(n=e.filename)?n:`part-${t}.pdf`,file_data:`data:application/pdf;base64,${mr(e.data)}`}}}throw new c9({functionality:`file part media type ${e.mediaType}`})}})});break;case"assistant":{let e={},t={};for(let r of y)switch(r.type){case"text":m.push({role:"assistant",content:[{type:"output_text",text:r.text}],id:null!=(o=null==(i=null==(n=r.providerOptions)?void 0:n.openai)?void 0:i.itemId)?o:void 0});break;case"tool-call":if(t[r.toolCallId]=r,r.providerExecuted)break;if(s&&"local_shell"===r.toolName){let e=g1.parse(r.input);m.push({type:"local_shell_call",call_id:r.toolCallId,id:null!=(d=null==(u=null==(l=r.providerOptions)?void 0:l.openai)?void 0:u.itemId)?d:void 0,action:{type:"exec",command:e.action.command,timeout_ms:e.action.timeoutMs,user:e.action.user,working_directory:e.action.workingDirectory,env:e.action.env}});break}m.push({type:"function_call",call_id:r.toolCallId,name:r.toolName,arguments:JSON.stringify(r.input),id:null!=(h=null==(c=null==(p=r.providerOptions)?void 0:p.openai)?void 0:c.itemId)?h:void 0});break;case"tool-result":a?m.push({type:"item_reference",id:r.toolCallId}):g.push({type:"other",message:`Results for OpenAI tool ${r.toolName} are not sent to the API when store is false`});break;case"reasoning":{let t=await hI({provider:"openai",providerOptions:r.providerOptions,schema:fe}),s=null==t?void 0:t.itemId;if(null!=s){let n=e[s];if(a)void 0===n&&(m.push({type:"item_reference",id:s}),e[s]={type:"reasoning",id:s,summary:[]});else{let a=[];r.text.length>0?a.push({type:"summary_text",text:r.text}):void 0!==n&&g.push({type:"other",message:`Cannot append empty reasoning part to existing reasoning sequence. Skipping reasoning part: ${JSON.stringify(r)}.`}),void 0===n?(e[s]={type:"reasoning",id:s,encrypted_content:null==t?void 0:t.reasoningEncryptedContent,summary:a},m.push(e[s])):n.summary.push(...a)}}else g.push({type:"other",message:`Non-OpenAI reasoning parts are not supported. Skipping reasoning part: ${JSON.stringify(r)}.`})}}break}case"tool":for(let e of y){let t,r=e.output;if(s&&"local_shell"===e.toolName&&"json"===r.type){m.push({type:"local_shell_call_output",call_id:e.toolCallId,output:g2.parse(r.value).output});break}switch(r.type){case"text":case"error-text":t=r.value;break;case"content":case"json":case"error-json":t=JSON.stringify(r.value)}m.push({type:"function_call_output",call_id:e.toolCallId,output:t})}break;default:throw Error(`Unsupported role: ${f}`)}return{input:m,warnings:g}}var fe=nS.object({itemId:nS.string().nullish(),reasoningEncryptedContent:nS.string().nullish()});function ft({finishReason:e,hasFunctionCall:t}){switch(e){case void 0:case null:return t?"tool-calls":"stop";case"max_output_tokens":return"length";case"content_filter":return"content-filter";default:return t?"tool-calls":"unknown"}}var fr=nS.object({type:nS.literal("web_search_call"),id:nS.string(),status:nS.string(),action:nS.discriminatedUnion("type",[nS.object({type:nS.literal("search"),query:nS.string().nullish()}),nS.object({type:nS.literal("open_page"),url:nS.string()}),nS.object({type:nS.literal("find"),url:nS.string(),pattern:nS.string()})]).nullish()}),fa=nS.object({type:nS.literal("file_search_call"),id:nS.string(),queries:nS.array(nS.string()),results:nS.array(nS.object({attributes:nS.record(nS.string(),nS.unknown()),file_id:nS.string(),filename:nS.string(),score:nS.number(),text:nS.string()})).nullish()}),fs=nS.object({type:nS.literal("code_interpreter_call"),id:nS.string(),code:nS.string().nullable(),container_id:nS.string(),outputs:nS.array(nS.discriminatedUnion("type",[nS.object({type:nS.literal("logs"),logs:nS.string()}),nS.object({type:nS.literal("image"),url:nS.string()})])).nullable()}),fn=nS.object({type:nS.literal("local_shell_call"),id:nS.string(),call_id:nS.string(),action:nS.object({type:nS.literal("exec"),command:nS.array(nS.string()),timeout_ms:nS.number().optional(),user:nS.string().optional(),working_directory:nS.string().optional(),env:nS.record(nS.string(),nS.string()).optional()})}),fi=nS.object({type:nS.literal("image_generation_call"),id:nS.string(),result:nS.string()}),fo=nS.array(nS.object({token:nS.string(),logprob:nS.number(),top_logprobs:nS.array(nS.object({token:nS.string(),logprob:nS.number()}))})),fl=class{constructor(e,t){this.specificationVersion="v2",this.supportedUrls={"image/*":[/^https?:\/\/.*$/],"application/pdf":[/^https?:\/\/.*$/]},this.modelId=e,this.config=t}get provider(){return this.config.provider}async getArgs({maxOutputTokens:e,temperature:t,stopSequences:r,topP:a,topK:s,presencePenalty:n,frequencyPenalty:i,seed:o,prompt:l,providerOptions:u,tools:d,toolChoice:p,responseFormat:c}){var h,m,g,f,y;let v,b=[],w=(v={requiredAutoTruncation:!1,systemMessageMode:"system",supportsFlexProcessing:(y=this.modelId).startsWith("o3")||y.startsWith("o4-mini")||y.startsWith("gpt-5")&&!y.startsWith("gpt-5-chat"),supportsPriorityProcessing:y.startsWith("gpt-4")||y.startsWith("gpt-5-mini")||y.startsWith("gpt-5")&&!y.startsWith("gpt-5-nano")&&!y.startsWith("gpt-5-chat")||y.startsWith("o3")||y.startsWith("o4-mini")},y.startsWith("gpt-5-chat")?{...v,isReasoningModel:!1}:y.startsWith("o")||y.startsWith("gpt-5")||y.startsWith("codex-")||y.startsWith("computer-use")?y.startsWith("o1-mini")||y.startsWith("o1-preview")?{...v,isReasoningModel:!0,systemMessageMode:"remove"}:{...v,isReasoningModel:!0,systemMessageMode:"developer"}:{...v,isReasoningModel:!1});null!=s&&b.push({type:"unsupported-setting",setting:"topK"}),null!=o&&b.push({type:"unsupported-setting",setting:"seed"}),null!=n&&b.push({type:"unsupported-setting",setting:"presencePenalty"}),null!=i&&b.push({type:"unsupported-setting",setting:"frequencyPenalty"}),null!=r&&b.push({type:"unsupported-setting",setting:"stopSequences"});let _=await hI({provider:"openai",providerOptions:u,schema:fk}),{input:S,warnings:I}=await g7({prompt:l,systemMessageMode:w.systemMessageMode,fileIdPrefixes:this.config.fileIdPrefixes,store:null==(h=null==_?void 0:_.store)||h,hasLocalShellTool:A("openai.local_shell")});b.push(...I);let k=null!=(m=null==_?void 0:_.strictJsonSchema)&&m,T=null==_?void 0:_.include;function E(e){T=null!=T?[...T,e]:[e]}function A(e){return(null==d?void 0:d.find(t=>"provider-defined"===t.type&&t.id===e))!=null}let O="number"==typeof(null==_?void 0:_.logprobs)?null==_?void 0:_.logprobs:(null==_?void 0:_.logprobs)===!0?20:void 0;O&&E("message.output_text.logprobs");let C=null==(g=null==d?void 0:d.find(e=>"provider-defined"===e.type&&("openai.web_search"===e.id||"openai.web_search_preview"===e.id)))?void 0:g.name;C&&E("web_search_call.action.sources"),A("openai.code_interpreter")&&E("code_interpreter_call.outputs");let R={model:this.modelId,input:S,temperature:t,top_p:a,max_output_tokens:e,...((null==c?void 0:c.type)==="json"||(null==_?void 0:_.textVerbosity))&&{text:{...(null==c?void 0:c.type)==="json"&&{format:null!=c.schema?{type:"json_schema",strict:k,name:null!=(f=c.name)?f:"response",description:c.description,schema:c.schema}:{type:"json_object"}},...(null==_?void 0:_.textVerbosity)&&{verbosity:_.textVerbosity}}},max_tool_calls:null==_?void 0:_.maxToolCalls,metadata:null==_?void 0:_.metadata,parallel_tool_calls:null==_?void 0:_.parallelToolCalls,previous_response_id:null==_?void 0:_.previousResponseId,store:null==_?void 0:_.store,user:null==_?void 0:_.user,instructions:null==_?void 0:_.instructions,service_tier:null==_?void 0:_.serviceTier,include:T,prompt_cache_key:null==_?void 0:_.promptCacheKey,safety_identifier:null==_?void 0:_.safetyIdentifier,top_logprobs:O,...w.isReasoningModel&&((null==_?void 0:_.reasoningEffort)!=null||(null==_?void 0:_.reasoningSummary)!=null)&&{reasoning:{...(null==_?void 0:_.reasoningEffort)!=null&&{effort:_.reasoningEffort},...(null==_?void 0:_.reasoningSummary)!=null&&{summary:_.reasoningSummary}}},...w.requiredAutoTruncation&&{truncation:"auto"}};w.isReasoningModel?(null!=R.temperature&&(R.temperature=void 0,b.push({type:"unsupported-setting",setting:"temperature",details:"temperature is not supported for reasoning models"})),null!=R.top_p&&(R.top_p=void 0,b.push({type:"unsupported-setting",setting:"topP",details:"topP is not supported for reasoning models"}))):((null==_?void 0:_.reasoningEffort)!=null&&b.push({type:"unsupported-setting",setting:"reasoningEffort",details:"reasoningEffort is not supported for non-reasoning models"}),(null==_?void 0:_.reasoningSummary)!=null&&b.push({type:"unsupported-setting",setting:"reasoningSummary",details:"reasoningSummary is not supported for non-reasoning models"})),(null==_?void 0:_.serviceTier)!=="flex"||w.supportsFlexProcessing||(b.push({type:"unsupported-setting",setting:"serviceTier",details:"flex processing is only available for o3, o4-mini, and gpt-5 models"}),delete R.service_tier),(null==_?void 0:_.serviceTier)!=="priority"||w.supportsPriorityProcessing||(b.push({type:"unsupported-setting",setting:"serviceTier",details:"priority processing is only available for supported models (gpt-4, gpt-5, gpt-5-mini, o3, o4-mini) and requires Enterprise access. gpt-5-nano is not supported"}),delete R.service_tier);let{tools:M,toolChoice:N,toolWarnings:j}=function({tools:e,toolChoice:t,strictJsonSchema:r}){e=(null==e?void 0:e.length)?e:void 0;let a=[];if(null==e)return{tools:void 0,toolChoice:void 0,toolWarnings:a};let s=[];for(let t of e)switch(t.type){case"function":s.push({type:"function",name:t.name,description:t.description,parameters:t.inputSchema,strict:r});break;case"provider-defined":switch(t.id){case"openai.file_search":{let e=gJ.parse(t.args);s.push({type:"file_search",vector_store_ids:e.vectorStoreIds,max_num_results:e.maxNumResults,ranking_options:e.ranking?{ranker:e.ranking.ranker,score_threshold:e.ranking.scoreThreshold}:void 0,filters:e.filters});break}case"openai.local_shell":s.push({type:"local_shell"});break;case"openai.web_search_preview":{let e=g9.parse(t.args);s.push({type:"web_search_preview",search_context_size:e.searchContextSize,user_location:e.userLocation});break}case"openai.web_search":{let e=g5.parse(t.args);s.push({type:"web_search",filters:null!=e.filters?{allowed_domains:e.filters.allowedDomains}:void 0,search_context_size:e.searchContextSize,user_location:e.userLocation});break}case"openai.code_interpreter":{let e=gW.parse(t.args);s.push({type:"code_interpreter",container:null==e.container?{type:"auto",file_ids:void 0}:"string"==typeof e.container?e.container:{type:"auto",file_ids:e.container.fileIds}});break}case"openai.image_generation":{let e=gQ.parse(t.args);s.push({type:"image_generation",background:e.background,input_fidelity:e.inputFidelity,input_image_mask:e.inputImageMask?{file_id:e.inputImageMask.fileId,image_url:e.inputImageMask.imageUrl}:void 0,model:e.model,size:e.size,quality:e.quality,moderation:e.moderation,output_format:e.outputFormat,output_compression:e.outputCompression})}}break;default:a.push({type:"unsupported-tool",tool:t})}if(null==t)return{tools:s,toolChoice:void 0,toolWarnings:a};let n=t.type;switch(n){case"auto":case"none":case"required":return{tools:s,toolChoice:n,toolWarnings:a};case"tool":return{tools:s,toolChoice:"code_interpreter"===t.toolName||"file_search"===t.toolName||"image_generation"===t.toolName||"web_search_preview"===t.toolName||"web_search"===t.toolName?{type:t.toolName}:{type:"function",name:t.toolName},toolWarnings:a};default:throw new c9({functionality:`tool choice type: ${n}`})}}({tools:d,toolChoice:p,strictJsonSchema:k});return{webSearchToolName:C,args:{...R,tools:M,tool_choice:N},warnings:[...b,...j]}}async doGenerate(e){var t,r,a,s,n,i,o,l,u,d,p,c,h,m,g,f,y,v,b;let{args:w,warnings:_,webSearchToolName:S}=await this.getArgs(e),I=this.config.url({path:"/responses",modelId:this.modelId}),{responseHeaders:k,value:T,rawValue:E}=await hT({url:I,headers:ht(this.config.headers(),e.headers),body:w,failedResponseHandler:gb,successfulResponseHandler:hj(nS.object({id:nS.string(),created_at:nS.number(),error:nS.object({code:nS.string(),message:nS.string()}).nullish(),model:nS.string(),output:nS.array(nS.discriminatedUnion("type",[nS.object({type:nS.literal("message"),role:nS.literal("assistant"),id:nS.string(),content:nS.array(nS.object({type:nS.literal("output_text"),text:nS.string(),logprobs:fo.nullish(),annotations:nS.array(nS.discriminatedUnion("type",[nS.object({type:nS.literal("url_citation"),start_index:nS.number(),end_index:nS.number(),url:nS.string(),title:nS.string()}),nS.object({type:nS.literal("file_citation"),file_id:nS.string(),filename:nS.string().nullish(),index:nS.number().nullish(),start_index:nS.number().nullish(),end_index:nS.number().nullish(),quote:nS.string().nullish()}),nS.object({type:nS.literal("container_file_citation")})]))}))}),fr,fa,fs,fi,fn,nS.object({type:nS.literal("function_call"),call_id:nS.string(),name:nS.string(),arguments:nS.string(),id:nS.string()}),nS.object({type:nS.literal("computer_call"),id:nS.string(),status:nS.string().optional()}),nS.object({type:nS.literal("reasoning"),id:nS.string(),encrypted_content:nS.string().nullish(),summary:nS.array(nS.object({type:nS.literal("summary_text"),text:nS.string()}))})])),service_tier:nS.string().nullish(),incomplete_details:nS.object({reason:nS.string()}).nullish(),usage:fu})),abortSignal:e.abortSignal,fetch:this.config.fetch});if(T.error)throw new cb({message:T.error.message,url:I,requestBodyValues:w,statusCode:400,responseHeaders:k,responseBody:E,isRetryable:!1});let A=[],O=[],C=!1;for(let g of T.output)switch(g.type){case"reasoning":for(let e of(0===g.summary.length&&g.summary.push({type:"summary_text",text:""}),g.summary))A.push({type:"reasoning",text:e.text,providerMetadata:{openai:{itemId:g.id,reasoningEncryptedContent:null!=(t=g.encrypted_content)?t:null}}});break;case"image_generation_call":A.push({type:"tool-call",toolCallId:g.id,toolName:"image_generation",input:"{}",providerExecuted:!0}),A.push({type:"tool-result",toolCallId:g.id,toolName:"image_generation",result:{result:g.result},providerExecuted:!0});break;case"local_shell_call":A.push({type:"tool-call",toolCallId:g.call_id,toolName:"local_shell",input:JSON.stringify({action:g.action}),providerMetadata:{openai:{itemId:g.id}}});break;case"message":for(let t of g.content)for(let h of((null==(a=null==(r=e.providerOptions)?void 0:r.openai)?void 0:a.logprobs)&&t.logprobs&&O.push(t.logprobs),A.push({type:"text",text:t.text,providerMetadata:{openai:{itemId:g.id}}}),t.annotations))"url_citation"===h.type?A.push({type:"source",sourceType:"url",id:null!=(i=null==(n=(s=this.config).generateId)?void 0:n.call(s))?i:hi(),url:h.url,title:h.title}):"file_citation"===h.type&&A.push({type:"source",sourceType:"document",id:null!=(u=null==(l=(o=this.config).generateId)?void 0:l.call(o))?u:hi(),mediaType:"text/plain",title:null!=(p=null!=(d=h.quote)?d:h.filename)?p:"Document",filename:null!=(c=h.filename)?c:h.file_id});break;case"function_call":C=!0,A.push({type:"tool-call",toolCallId:g.call_id,toolName:g.name,input:g.arguments,providerMetadata:{openai:{itemId:g.id}}});break;case"web_search_call":A.push({type:"tool-call",toolCallId:g.id,toolName:null!=S?S:"web_search",input:JSON.stringify({action:g.action}),providerExecuted:!0}),A.push({type:"tool-result",toolCallId:g.id,toolName:null!=S?S:"web_search",result:{status:g.status},providerExecuted:!0});break;case"computer_call":A.push({type:"tool-call",toolCallId:g.id,toolName:"computer_use",input:"",providerExecuted:!0}),A.push({type:"tool-result",toolCallId:g.id,toolName:"computer_use",result:{type:"computer_use_tool_result",status:g.status||"completed"},providerExecuted:!0});break;case"file_search_call":A.push({type:"tool-call",toolCallId:g.id,toolName:"file_search",input:"{}",providerExecuted:!0}),A.push({type:"tool-result",toolCallId:g.id,toolName:"file_search",result:{queries:g.queries,results:null!=(m=null==(h=g.results)?void 0:h.map(e=>({attributes:e.attributes,fileId:e.file_id,filename:e.filename,score:e.score,text:e.text})))?m:null},providerExecuted:!0});break;case"code_interpreter_call":A.push({type:"tool-call",toolCallId:g.id,toolName:"code_interpreter",input:JSON.stringify({code:g.code,containerId:g.container_id}),providerExecuted:!0}),A.push({type:"tool-result",toolCallId:g.id,toolName:"code_interpreter",result:{outputs:g.outputs},providerExecuted:!0})}let R={openai:{responseId:T.id}};return O.length>0&&(R.openai.logprobs=O),"string"==typeof T.service_tier&&(R.openai.serviceTier=T.service_tier),{content:A,finishReason:ft({finishReason:null==(g=T.incomplete_details)?void 0:g.reason,hasFunctionCall:C}),usage:{inputTokens:T.usage.input_tokens,outputTokens:T.usage.output_tokens,totalTokens:T.usage.input_tokens+T.usage.output_tokens,reasoningTokens:null!=(y=null==(f=T.usage.output_tokens_details)?void 0:f.reasoning_tokens)?y:void 0,cachedInputTokens:null!=(b=null==(v=T.usage.input_tokens_details)?void 0:v.cached_tokens)?b:void 0},request:{body:w},response:{id:T.id,timestamp:new Date(1e3*T.created_at),modelId:T.model,headers:k,body:E},providerMetadata:R,warnings:_}}async doStream(e){let t,{args:r,warnings:a,webSearchToolName:s}=await this.getArgs(e),{responseHeaders:n,value:i}=await hT({url:this.config.url({path:"/responses",modelId:this.modelId}),headers:ht(this.config.headers(),e.headers),body:{...r,stream:!0},failedResponseHandler:gb,successfulResponseHandler:hN(fS),abortSignal:e.abortSignal,fetch:this.config.fetch}),o=this,l="unknown",u={inputTokens:void 0,outputTokens:void 0,totalTokens:void 0},d=[],p=null,c={},h=!1,m={};return{stream:i.pipeThrough(new TransformStream({start(e){e.enqueue({type:"stream-start",warnings:a})},transform(r,a){var n,i,g,f,y,v,b,w,_,S,I,k,T,E,A,O,C,R,M,N,j,P,$,D,L,U;if(e.includeRawChunks&&a.enqueue({type:"raw",rawValue:r.rawValue}),!r.success){l="error",a.enqueue({type:"error",error:r.error});return}let z=r.value;if(fI(z)){"function_call"===z.item.type?(c[z.output_index]={toolName:z.item.name,toolCallId:z.item.call_id},a.enqueue({type:"tool-input-start",id:z.item.call_id,toolName:z.item.name})):"web_search_call"===z.item.type?(c[z.output_index]={toolName:null!=s?s:"web_search",toolCallId:z.item.id},a.enqueue({type:"tool-input-start",id:z.item.id,toolName:null!=s?s:"web_search"})):"computer_call"===z.item.type?(c[z.output_index]={toolName:"computer_use",toolCallId:z.item.id},a.enqueue({type:"tool-input-start",id:z.item.id,toolName:"computer_use"})):"code_interpreter_call"===z.item.type?(c[z.output_index]={toolName:"code_interpreter",toolCallId:z.item.id,codeInterpreter:{containerId:z.item.container_id}},a.enqueue({type:"tool-input-start",id:z.item.id,toolName:"code_interpreter"}),a.enqueue({type:"tool-input-delta",id:z.item.id,delta:`{"containerId":"${z.item.container_id}","code":"`})):"file_search_call"===z.item.type?a.enqueue({type:"tool-call",toolCallId:z.item.id,toolName:"file_search",input:"{}",providerExecuted:!0}):"image_generation_call"===z.item.type?a.enqueue({type:"tool-call",toolCallId:z.item.id,toolName:"image_generation",input:"{}",providerExecuted:!0}):"message"===z.item.type?a.enqueue({type:"text-start",id:z.item.id,providerMetadata:{openai:{itemId:z.item.id}}}):fI(D=z)&&"reasoning"===D.item.type&&(m[z.item.id]={encryptedContent:z.item.encrypted_content,summaryParts:[0]},a.enqueue({type:"reasoning-start",id:`${z.item.id}:0`,providerMetadata:{openai:{itemId:z.item.id,reasoningEncryptedContent:null!=(n=z.item.encrypted_content)?n:null}}}))}else if(fx(z))if("function_call"===z.item.type)c[z.output_index]=void 0,h=!0,a.enqueue({type:"tool-input-end",id:z.item.call_id}),a.enqueue({type:"tool-call",toolCallId:z.item.call_id,toolName:z.item.name,input:z.item.arguments,providerMetadata:{openai:{itemId:z.item.id}}});else if("web_search_call"===z.item.type)c[z.output_index]=void 0,a.enqueue({type:"tool-input-end",id:z.item.id}),a.enqueue({type:"tool-call",toolCallId:z.item.id,toolName:"web_search",input:JSON.stringify({action:z.item.action}),providerExecuted:!0}),a.enqueue({type:"tool-result",toolCallId:z.item.id,toolName:"web_search",result:{status:z.item.status},providerExecuted:!0});else if("computer_call"===z.item.type)c[z.output_index]=void 0,a.enqueue({type:"tool-input-end",id:z.item.id}),a.enqueue({type:"tool-call",toolCallId:z.item.id,toolName:"computer_use",input:"",providerExecuted:!0}),a.enqueue({type:"tool-result",toolCallId:z.item.id,toolName:"computer_use",result:{type:"computer_use_tool_result",status:z.item.status||"completed"},providerExecuted:!0});else if("file_search_call"===z.item.type)c[z.output_index]=void 0,a.enqueue({type:"tool-result",toolCallId:z.item.id,toolName:"file_search",result:{queries:z.item.queries,results:null!=(g=null==(i=z.item.results)?void 0:i.map(e=>({attributes:e.attributes,fileId:e.file_id,filename:e.filename,score:e.score,text:e.text})))?g:null},providerExecuted:!0});else if("code_interpreter_call"===z.item.type)c[z.output_index]=void 0,a.enqueue({type:"tool-result",toolCallId:z.item.id,toolName:"code_interpreter",result:{outputs:z.item.outputs},providerExecuted:!0});else if("image_generation_call"===z.item.type)a.enqueue({type:"tool-result",toolCallId:z.item.id,toolName:"image_generation",result:{result:z.item.result},providerExecuted:!0});else if("local_shell_call"===z.item.type)c[z.output_index]=void 0,a.enqueue({type:"tool-call",toolCallId:z.item.call_id,toolName:"local_shell",input:JSON.stringify({action:{type:"exec",command:z.item.action.command,timeoutMs:z.item.action.timeout_ms,user:z.item.action.user,workingDirectory:z.item.action.working_directory,env:z.item.action.env}}),providerMetadata:{openai:{itemId:z.item.id}}});else if("message"===z.item.type)a.enqueue({type:"text-end",id:z.item.id});else{if(fx(L=z)&&"reasoning"===L.item.type){for(let e of m[z.item.id].summaryParts)a.enqueue({type:"reasoning-end",id:`${z.item.id}:${e}`,providerMetadata:{openai:{itemId:z.item.id,reasoningEncryptedContent:null!=(f=z.item.encrypted_content)?f:null}}});delete m[z.item.id]}}else if("response.function_call_arguments.delta"===z.type){let e=c[z.output_index];null!=e&&a.enqueue({type:"tool-input-delta",id:e.toolCallId,delta:z.delta})}else if("response.code_interpreter_call_code.delta"===z.type){let e=c[z.output_index];null!=e&&a.enqueue({type:"tool-input-delta",id:e.toolCallId,delta:JSON.stringify(z.delta).slice(1,-1)})}else if("response.code_interpreter_call_code.done"===z.type){let e=c[z.output_index];null!=e&&(a.enqueue({type:"tool-input-delta",id:e.toolCallId,delta:'"}'}),a.enqueue({type:"tool-input-end",id:e.toolCallId}),a.enqueue({type:"tool-call",toolCallId:e.toolCallId,toolName:"code_interpreter",input:JSON.stringify({code:z.code,containerId:e.codeInterpreter.containerId}),providerExecuted:!0}))}else{"response.created"===z.type?(p=z.response.id,a.enqueue({type:"response-metadata",id:z.response.id,timestamp:new Date(1e3*z.response.created_at),modelId:z.response.model})):"response.output_text.delta"===z.type?(a.enqueue({type:"text-delta",id:z.item_id,delta:z.delta}),(null==(v=null==(y=e.providerOptions)?void 0:y.openai)?void 0:v.logprobs)&&z.logprobs&&d.push(z.logprobs)):"response.reasoning_summary_part.added"===z.type?z.summary_index>0&&(null==(b=m[z.item_id])||b.summaryParts.push(z.summary_index),a.enqueue({type:"reasoning-start",id:`${z.item_id}:${z.summary_index}`,providerMetadata:{openai:{itemId:z.item_id,reasoningEncryptedContent:null!=(_=null==(w=m[z.item_id])?void 0:w.encryptedContent)?_:null}}})):"response.reasoning_summary_text.delta"===z.type?a.enqueue({type:"reasoning-delta",id:`${z.item_id}:${z.summary_index}`,delta:z.delta,providerMetadata:{openai:{itemId:z.item_id}}}):"response.completed"===(U=z).type||"response.incomplete"===U.type?(l=ft({finishReason:null==(S=z.response.incomplete_details)?void 0:S.reason,hasFunctionCall:h}),u.inputTokens=z.response.usage.input_tokens,u.outputTokens=z.response.usage.output_tokens,u.totalTokens=z.response.usage.input_tokens+z.response.usage.output_tokens,u.reasoningTokens=null!=(k=null==(I=z.response.usage.output_tokens_details)?void 0:I.reasoning_tokens)?k:void 0,u.cachedInputTokens=null!=(E=null==(T=z.response.usage.input_tokens_details)?void 0:T.cached_tokens)?E:void 0,"string"==typeof z.response.service_tier&&(t=z.response.service_tier)):"response.output_text.annotation.added"===z.type?"url_citation"===z.annotation.type?a.enqueue({type:"source",sourceType:"url",id:null!=(C=null==(O=(A=o.config).generateId)?void 0:O.call(A))?C:hi(),url:z.annotation.url,title:z.annotation.title}):"file_citation"===z.annotation.type&&a.enqueue({type:"source",sourceType:"document",id:null!=(N=null==(M=(R=o.config).generateId)?void 0:M.call(R))?N:hi(),mediaType:"text/plain",title:null!=(P=null!=(j=z.annotation.quote)?j:z.annotation.filename)?P:"Document",filename:null!=($=z.annotation.filename)?$:z.annotation.file_id}):"error"===z.type&&a.enqueue({type:"error",error:z})}},flush(e){let r={openai:{responseId:p}};d.length>0&&(r.openai.logprobs=d),void 0!==t&&(r.openai.serviceTier=t),e.enqueue({type:"finish",finishReason:l,usage:u,providerMetadata:r})}})),request:{body:r},response:{headers:n}}}},fu=nS.object({input_tokens:nS.number(),input_tokens_details:nS.object({cached_tokens:nS.number().nullish()}).nullish(),output_tokens:nS.number(),output_tokens_details:nS.object({reasoning_tokens:nS.number().nullish()}).nullish()}),fd=nS.object({type:nS.literal("response.output_text.delta"),item_id:nS.string(),delta:nS.string(),logprobs:fo.nullish()}),fp=nS.object({type:nS.literal("error"),code:nS.string(),message:nS.string(),param:nS.string().nullish(),sequence_number:nS.number()}),fc=nS.object({type:nS.enum(["response.completed","response.incomplete"]),response:nS.object({incomplete_details:nS.object({reason:nS.string()}).nullish(),usage:fu,service_tier:nS.string().nullish()})}),fh=nS.object({type:nS.literal("response.created"),response:nS.object({id:nS.string(),created_at:nS.number(),model:nS.string(),service_tier:nS.string().nullish()})}),fm=nS.object({type:nS.literal("response.output_item.added"),output_index:nS.number(),item:nS.discriminatedUnion("type",[nS.object({type:nS.literal("message"),id:nS.string()}),nS.object({type:nS.literal("reasoning"),id:nS.string(),encrypted_content:nS.string().nullish()}),nS.object({type:nS.literal("function_call"),id:nS.string(),call_id:nS.string(),name:nS.string(),arguments:nS.string()}),nS.object({type:nS.literal("web_search_call"),id:nS.string(),status:nS.string(),action:nS.object({type:nS.literal("search"),query:nS.string().optional()}).nullish()}),nS.object({type:nS.literal("computer_call"),id:nS.string(),status:nS.string()}),nS.object({type:nS.literal("file_search_call"),id:nS.string()}),nS.object({type:nS.literal("image_generation_call"),id:nS.string()}),nS.object({type:nS.literal("code_interpreter_call"),id:nS.string(),container_id:nS.string(),code:nS.string().nullable(),outputs:nS.array(nS.discriminatedUnion("type",[nS.object({type:nS.literal("logs"),logs:nS.string()}),nS.object({type:nS.literal("image"),url:nS.string()})])).nullable(),status:nS.string()})])}),fg=nS.object({type:nS.literal("response.output_item.done"),output_index:nS.number(),item:nS.discriminatedUnion("type",[nS.object({type:nS.literal("message"),id:nS.string()}),nS.object({type:nS.literal("reasoning"),id:nS.string(),encrypted_content:nS.string().nullish()}),nS.object({type:nS.literal("function_call"),id:nS.string(),call_id:nS.string(),name:nS.string(),arguments:nS.string(),status:nS.literal("completed")}),fs,fi,fr,fa,fn,nS.object({type:nS.literal("computer_call"),id:nS.string(),status:nS.literal("completed")})])}),ff=nS.object({type:nS.literal("response.function_call_arguments.delta"),item_id:nS.string(),output_index:nS.number(),delta:nS.string()}),fy=nS.object({type:nS.literal("response.code_interpreter_call_code.delta"),item_id:nS.string(),output_index:nS.number(),delta:nS.string()}),fv=nS.object({type:nS.literal("response.code_interpreter_call_code.done"),item_id:nS.string(),output_index:nS.number(),code:nS.string()}),fb=nS.object({type:nS.literal("response.output_text.annotation.added"),annotation:nS.discriminatedUnion("type",[nS.object({type:nS.literal("url_citation"),url:nS.string(),title:nS.string()}),nS.object({type:nS.literal("file_citation"),file_id:nS.string(),filename:nS.string().nullish(),index:nS.number().nullish(),start_index:nS.number().nullish(),end_index:nS.number().nullish(),quote:nS.string().nullish()})])}),fw=nS.object({type:nS.literal("response.reasoning_summary_part.added"),item_id:nS.string(),summary_index:nS.number()}),f_=nS.object({type:nS.literal("response.reasoning_summary_text.delta"),item_id:nS.string(),summary_index:nS.number(),delta:nS.string()}),fS=nS.union([fd,fc,fh,fm,fg,ff,fy,fv,fb,fw,f_,fp,nS.object({type:nS.string()}).loose()]);function fx(e){return"response.output_item.done"===e.type}function fI(e){return"response.output_item.added"===e.type}var fk=nS.object({include:nS.array(nS.enum(["reasoning.encrypted_content","file_search_call.results","message.output_text.logprobs"])).nullish(),instructions:nS.string().nullish(),logprobs:nS.union([nS.boolean(),nS.number().min(1).max(20)]).optional(),maxToolCalls:nS.number().nullish(),metadata:nS.any().nullish(),parallelToolCalls:nS.boolean().nullish(),previousResponseId:nS.string().nullish(),promptCacheKey:nS.string().nullish(),reasoningEffort:nS.string().nullish(),reasoningSummary:nS.string().nullish(),safetyIdentifier:nS.string().nullish(),serviceTier:nS.enum(["auto","flex","priority"]).nullish(),store:nS.boolean().nullish(),strictJsonSchema:nS.boolean().nullish(),textVerbosity:nS.enum(["low","medium","high"]).nullish(),user:nS.string().nullish()}),fT=nS.object({instructions:nS.string().nullish(),speed:nS.number().min(.25).max(4).default(1).nullish()}),fE=class{constructor(e,t){this.modelId=e,this.config=t,this.specificationVersion="v2"}get provider(){return this.config.provider}async getArgs({text:e,voice:t="alloy",outputFormat:r="mp3",speed:a,instructions:s,language:n,providerOptions:i}){let o=[],l=await hI({provider:"openai",providerOptions:i,schema:fT}),u={model:this.modelId,input:e,voice:t,response_format:"mp3",speed:a,instructions:s};if(r&&(["mp3","opus","aac","flac","wav","pcm"].includes(r)?u.response_format=r:o.push({type:"unsupported-setting",setting:"outputFormat",details:`Unsupported output format: ${r}. Using mp3 instead.`})),l){let e={};for(let t in e){let r=e[t];void 0!==r&&(u[t]=r)}}return n&&o.push({type:"unsupported-setting",setting:"language",details:`OpenAI speech models do not support language selection. Language parameter "${n}" was ignored.`}),{requestBody:u,warnings:o}}async doGenerate(e){var t,r,a;let s=null!=(a=null==(r=null==(t=this.config._internal)?void 0:t.currentDate)?void 0:r.call(t))?a:new Date,{requestBody:n,warnings:i}=await this.getArgs(e),{value:o,responseHeaders:l,rawValue:u}=await hT({url:this.config.url({path:"/audio/speech",modelId:this.modelId}),headers:ht(this.config.headers(),e.headers),body:n,failedResponseHandler:gb,successfulResponseHandler:async({response:e,url:t,requestBodyValues:r})=>{let a=hr(e);if(!e.body)throw new cb({message:"Response body is empty",url:t,requestBodyValues:r,statusCode:e.status,responseHeaders:a,responseBody:void 0});try{let t=await e.arrayBuffer();return{responseHeaders:a,value:new Uint8Array(t)}}catch(s){throw new cb({message:"Failed to read response as array buffer",url:t,requestBodyValues:r,statusCode:e.status,responseHeaders:a,responseBody:void 0,cause:s})}},abortSignal:e.abortSignal,fetch:this.config.fetch});return{audio:o,warnings:i,request:{body:JSON.stringify(n)},response:{timestamp:s,modelId:this.modelId,headers:l,body:u}}}},fA=nS.object({include:nS.array(nS.string()).optional(),language:nS.string().optional(),prompt:nS.string().optional(),temperature:nS.number().min(0).max(1).default(0).optional(),timestampGranularities:nS.array(nS.enum(["word","segment"])).default(["segment"]).optional()}),fO={afrikaans:"af",arabic:"ar",armenian:"hy",azerbaijani:"az",belarusian:"be",bosnian:"bs",bulgarian:"bg",catalan:"ca",chinese:"zh",croatian:"hr",czech:"cs",danish:"da",dutch:"nl",english:"en",estonian:"et",finnish:"fi",french:"fr",galician:"gl",german:"de",greek:"el",hebrew:"he",hindi:"hi",hungarian:"hu",icelandic:"is",indonesian:"id",italian:"it",japanese:"ja",kannada:"kn",kazakh:"kk",korean:"ko",latvian:"lv",lithuanian:"lt",macedonian:"mk",malay:"ms",marathi:"mr",maori:"mi",nepali:"ne",norwegian:"no",persian:"fa",polish:"pl",portuguese:"pt",romanian:"ro",russian:"ru",serbian:"sr",slovak:"sk",slovenian:"sl",spanish:"es",swahili:"sw",swedish:"sv",tagalog:"tl",tamil:"ta",thai:"th",turkish:"tr",ukrainian:"uk",urdu:"ur",vietnamese:"vi",welsh:"cy"},fC=class{constructor(e,t){this.modelId=e,this.config=t,this.specificationVersion="v2"}get provider(){return this.config.provider}async getArgs({audio:e,mediaType:t,providerOptions:r}){let a,s=await hI({provider:"openai",providerOptions:r,schema:fA}),n=new FormData,i=e instanceof Uint8Array?new Blob([e]):new Blob([(a=mt(e.replace(/-/g,"+").replace(/_/g,"/")),Uint8Array.from(a,e=>e.codePointAt(0)))]);n.append("model",this.modelId);let o=function(e){var t;let[r,a=""]=e.toLowerCase().split("/");return null!=(t=({mpeg:"mp3","x-wav":"wav",opus:"ogg",mp4:"m4a","x-m4a":"m4a"})[a])?t:a}(t);if(n.append("file",new File([i],"audio",{type:t}),`audio.${o}`),s){for(let[e,t]of Object.entries({include:s.include,language:s.language,prompt:s.prompt,response_format:["gpt-4o-transcribe","gpt-4o-mini-transcribe"].includes(this.modelId)?"json":"verbose_json",temperature:s.temperature,timestamp_granularities:s.timestampGranularities}))if(null!=t)if(Array.isArray(t))for(let r of t)n.append(`${e}[]`,String(r));else n.append(e,String(t))}return{formData:n,warnings:[]}}async doGenerate(e){var t,r,a,s,n,i,o,l;let u=null!=(a=null==(r=null==(t=this.config._internal)?void 0:t.currentDate)?void 0:r.call(t))?a:new Date,{formData:d,warnings:p}=await this.getArgs(e),{value:c,responseHeaders:h,rawValue:m}=await hE({url:this.config.url({path:"/audio/transcriptions",modelId:this.modelId}),headers:ht(this.config.headers(),e.headers),formData:d,failedResponseHandler:gb,successfulResponseHandler:hj(fR),abortSignal:e.abortSignal,fetch:this.config.fetch}),g=null!=c.language&&c.language in fO?fO[c.language]:void 0;return{text:c.text,segments:null!=(o=null!=(i=null==(s=c.segments)?void 0:s.map(e=>({text:e.text,startSecond:e.start,endSecond:e.end})))?i:null==(n=c.words)?void 0:n.map(e=>({text:e.word,startSecond:e.start,endSecond:e.end})))?o:[],language:g,durationInSeconds:null!=(l=c.duration)?l:void 0,warnings:p,response:{timestamp:u,modelId:this.modelId,headers:h,body:m}}}},fR=nS.object({text:nS.string(),language:nS.string().nullish(),duration:nS.number().nullish(),words:nS.array(nS.object({word:nS.string(),start:nS.number(),end:nS.number()})).nullish(),segments:nS.array(nS.object({id:nS.number(),seek:nS.number(),start:nS.number(),end:nS.number(),text:nS.string(),tokens:nS.array(nS.number()),temperature:nS.number(),avg_logprob:nS.number(),compression_ratio:nS.number(),no_speech_prob:nS.number()})).nullish()});function fM(e={}){var t,r;let a=null!=(t=ma(hm({settingValue:e.baseURL,environmentVariableName:"OPENAI_BASE_URL"})))?t:"https://api.openai.com/v1",s=null!=(r=e.name)?r:"openai",n=()=>hs({Authorization:`Bearer ${hh({apiKey:e.apiKey,environmentVariableName:"OPENAI_API_KEY",description:"OpenAI"})}`,"OpenAI-Organization":e.organization,"OpenAI-Project":e.project,...e.headers},"ai-sdk/openai/2.0.42"),i=t=>new gD(t,{provider:`${s}.embedding`,url:({path:e})=>`${a}${e}`,headers:n,fetch:e.fetch}),o=t=>new gq(t,{provider:`${s}.image`,url:({path:e})=>`${a}${e}`,headers:n,fetch:e.fetch}),l=t=>new fC(t,{provider:`${s}.transcription`,url:({path:e})=>`${a}${e}`,headers:n,fetch:e.fetch}),u=t=>new fE(t,{provider:`${s}.speech`,url:({path:e})=>`${a}${e}`,headers:n,fetch:e.fetch}),d=e=>{if(new.target)throw Error("The OpenAI model function cannot be called with the new keyword.");return p(e)},p=t=>new fl(t,{provider:`${s}.responses`,url:({path:e})=>`${a}${e}`,headers:n,fetch:e.fetch,fileIdPrefixes:["file-"]}),c=function(e){return d(e)};return c.languageModel=d,c.chat=t=>new gx(t,{provider:`${s}.chat`,url:({path:e})=>`${a}${e}`,headers:n,fetch:e.fetch}),c.completion=t=>new gM(t,{provider:`${s}.completion`,url:({path:e})=>`${a}${e}`,headers:n,fetch:e.fetch}),c.responses=p,c.embedding=i,c.textEmbedding=i,c.textEmbeddingModel=i,c.image=o,c.imageModel=o,c.transcription=l,c.transcriptionModel=l,c.speech=u,c.speechModel=u,c.tools=g6,c}fM();var nS=n_;nS.object({user:nS.string().optional(),reasoningEffort:nS.string().optional()});var fN={errorSchema:nS.object({error:nS.object({message:nS.string(),type:nS.string().nullish(),param:nS.any().nullish(),code:nS.union([nS.string(),nS.number()]).nullish()})}),errorToMessage:e=>e.error.message},fj=nS.object({prompt_tokens:nS.number().nullish(),completion_tokens:nS.number().nullish(),total_tokens:nS.number().nullish(),prompt_tokens_details:nS.object({cached_tokens:nS.number().nullish()}).nullish(),completion_tokens_details:nS.object({reasoning_tokens:nS.number().nullish(),accepted_prediction_tokens:nS.number().nullish(),rejected_prediction_tokens:nS.number().nullish()}).nullish()}).nullish();nS.object({id:nS.string().nullish(),created:nS.number().nullish(),model:nS.string().nullish(),choices:nS.array(nS.object({message:nS.object({role:nS.literal("assistant").nullish(),content:nS.string().nullish(),reasoning_content:nS.string().nullish(),reasoning:nS.string().nullish(),tool_calls:nS.array(nS.object({id:nS.string().nullish(),function:nS.object({name:nS.string(),arguments:nS.string()})})).nullish()}),finish_reason:nS.string().nullish()})),usage:fj}),nS.object({echo:nS.boolean().optional(),logitBias:nS.record(nS.string(),nS.number()).optional(),suffix:nS.string().optional(),user:nS.string().optional()});var fP=nS.object({prompt_tokens:nS.number(),completion_tokens:nS.number(),total_tokens:nS.number()});nS.object({id:nS.string().nullish(),created:nS.number().nullish(),model:nS.string().nullish(),choices:nS.array(nS.object({text:nS.string(),finish_reason:nS.string()})),usage:fP.nullish()}),nS.object({dimensions:nS.number().optional(),user:nS.string().optional()}),nS.object({data:nS.array(nS.object({embedding:nS.array(nS.number())})),usage:nS.object({prompt_tokens:nS.number()}).nullish(),providerMetadata:nS.record(nS.string(),nS.record(nS.string(),nS.any())).optional()});var f$=class{constructor(e,t){this.modelId=e,this.config=t,this.specificationVersion="v2",this.maxImagesPerCall=10}get provider(){return this.config.provider}async doGenerate({prompt:e,n:t,size:r,aspectRatio:a,seed:s,providerOptions:n,headers:i,abortSignal:o}){var l,u,d,p,c;let h=[];null!=a&&h.push({type:"unsupported-setting",setting:"aspectRatio",details:"This model does not support aspect ratio. Use `size` instead."}),null!=s&&h.push({type:"unsupported-setting",setting:"seed"});let m=null!=(d=null==(u=null==(l=this.config._internal)?void 0:l.currentDate)?void 0:u.call(l))?d:new Date,{value:g,responseHeaders:f}=await hT({url:this.config.url({path:"/images/generations",modelId:this.modelId}),headers:ht(this.config.headers(),i),body:{model:this.modelId,prompt:e,n:t,size:r,...null!=(p=n.openai)?p:{},response_format:"b64_json"},failedResponseHandler:hM(null!=(c=this.config.errorStructure)?c:fN),successfulResponseHandler:hj(fD),abortSignal:o,fetch:this.config.fetch});return{images:g.data.map(e=>e.b64_json),warnings:h,response:{timestamp:m,modelId:this.modelId,headers:f}}}},fD=nS.object({data:nS.array(nS.object({b64_json:nS.string()}))}),nS=n_;function fL({id:e,model:t,created:r}){return{id:null!=e?e:void 0,modelId:null!=t?t:void 0,timestamp:null!=r?new Date(1e3*r):void 0}}function fU(e){switch(e){case"stop":return"stop";case"length":return"length";case"tool_calls":case"function_call":return"tool-calls";case"content_filter":return"content-filter";default:return"unknown"}}var fz=nS.object({type:nS.literal("web"),country:nS.string().length(2).optional(),excludedWebsites:nS.array(nS.string()).max(5).optional(),allowedWebsites:nS.array(nS.string()).max(5).optional(),safeSearch:nS.boolean().optional()}),fq=nS.object({type:nS.literal("x"),excludedXHandles:nS.array(nS.string()).optional(),includedXHandles:nS.array(nS.string()).optional(),postFavoriteCount:nS.number().int().optional(),postViewCount:nS.number().int().optional(),xHandles:nS.array(nS.string()).optional()}),fV=nS.object({type:nS.literal("news"),country:nS.string().length(2).optional(),excludedWebsites:nS.array(nS.string()).max(5).optional(),safeSearch:nS.boolean().optional()}),fF=nS.object({type:nS.literal("rss"),links:nS.array(nS.string().url()).max(1)}),fZ=nS.discriminatedUnion("type",[fz,fq,fV,fF]),fW=nS.object({reasoningEffort:nS.enum(["low","high"]).optional(),searchParameters:nS.object({mode:nS.enum(["off","auto","on"]),returnCitations:nS.boolean().optional(),fromDate:nS.string().optional(),toDate:nS.string().optional(),maxSearchResults:nS.number().min(1).max(50).optional(),sources:nS.array(fZ).optional()}).optional()}),fG=nS.object({error:nS.object({message:nS.string(),type:nS.string().nullish(),param:nS.any().nullish(),code:nS.union([nS.string(),nS.number()]).nullish()})}),fB=hM({errorSchema:fG,errorToMessage:e=>e.error.message}),fK=class{constructor(e,t){this.specificationVersion="v2",this.supportedUrls={"image/*":[/^https?:\/\/.*$/]},this.modelId=e,this.config=t}get provider(){return this.config.provider}async getArgs({prompt:e,maxOutputTokens:t,temperature:r,topP:a,topK:s,frequencyPenalty:n,presencePenalty:i,stopSequences:o,seed:l,responseFormat:u,providerOptions:d,tools:p,toolChoice:c}){var h,m,g;let f=[],y=null!=(h=await hI({provider:"xai",providerOptions:d,schema:fW}))?h:{};null!=s&&f.push({type:"unsupported-setting",setting:"topK"}),null!=n&&f.push({type:"unsupported-setting",setting:"frequencyPenalty"}),null!=i&&f.push({type:"unsupported-setting",setting:"presencePenalty"}),null!=o&&f.push({type:"unsupported-setting",setting:"stopSequences"}),null!=u&&"json"===u.type&&null!=u.schema&&f.push({type:"unsupported-setting",setting:"responseFormat",details:"JSON response format schema is not supported"});let{messages:v,warnings:b}=function(e){let t=[];for(let{role:r,content:a}of e)switch(r){case"system":t.push({role:"system",content:a});break;case"user":if(1===a.length&&"text"===a[0].type){t.push({role:"user",content:a[0].text});break}t.push({role:"user",content:a.map(e=>{switch(e.type){case"text":return{type:"text",text:e.text};case"file":if(e.mediaType.startsWith("image/")){let t="image/*"===e.mediaType?"image/jpeg":e.mediaType;return{type:"image_url",image_url:{url:e.data instanceof URL?e.data.toString():`data:${t};base64,${mr(e.data)}`}}}throw new c9({functionality:`file part media type ${e.mediaType}`})}})});break;case"assistant":{let e="",r=[];for(let t of a)switch(t.type){case"text":e+=t.text;break;case"tool-call":r.push({id:t.toolCallId,type:"function",function:{name:t.toolName,arguments:JSON.stringify(t.input)}})}t.push({role:"assistant",content:e,tool_calls:r.length>0?r:void 0});break}case"tool":for(let e of a){let r,a=e.output;switch(a.type){case"text":case"error-text":r=a.value;break;case"content":case"json":case"error-json":r=JSON.stringify(a.value)}t.push({role:"tool",tool_call_id:e.toolCallId,content:r})}break;default:throw Error(`Unsupported role: ${r}`)}return{messages:t,warnings:[]}}(e);f.push(...b);let{tools:w,toolChoice:_,toolWarnings:S}=function({tools:e,toolChoice:t}){e=(null==e?void 0:e.length)?e:void 0;let r=[];if(null==e)return{tools:void 0,toolChoice:void 0,toolWarnings:r};let a=[];for(let t of e)"provider-defined"===t.type?r.push({type:"unsupported-tool",tool:t}):a.push({type:"function",function:{name:t.name,description:t.description,parameters:t.inputSchema}});if(null==t)return{tools:a,toolChoice:void 0,toolWarnings:r};let s=t.type;switch(s){case"auto":case"none":return{tools:a,toolChoice:s,toolWarnings:r};case"required":return{tools:a,toolChoice:"required",toolWarnings:r};case"tool":return{tools:a,toolChoice:{type:"function",function:{name:t.toolName}},toolWarnings:r};default:throw new c9({functionality:`tool choice type: ${s}`})}}({tools:p,toolChoice:c});return f.push(...S),{args:{model:this.modelId,max_tokens:t,temperature:r,top_p:a,seed:l,reasoning_effort:y.reasoningEffort,response_format:(null==u?void 0:u.type)==="json"?null!=u.schema?{type:"json_schema",json_schema:{name:null!=(m=u.name)?m:"response",schema:u.schema,strict:!0}}:{type:"json_object"}:void 0,search_parameters:y.searchParameters?{mode:y.searchParameters.mode,return_citations:y.searchParameters.returnCitations,from_date:y.searchParameters.fromDate,to_date:y.searchParameters.toDate,max_search_results:y.searchParameters.maxSearchResults,sources:null==(g=y.searchParameters.sources)?void 0:g.map(e=>{var t;return{type:e.type,..."web"===e.type&&{country:e.country,excluded_websites:e.excludedWebsites,allowed_websites:e.allowedWebsites,safe_search:e.safeSearch},..."x"===e.type&&{excluded_x_handles:e.excludedXHandles,included_x_handles:null!=(t=e.includedXHandles)?t:e.xHandles,post_favorite_count:e.postFavoriteCount,post_view_count:e.postViewCount},..."news"===e.type&&{country:e.country,excluded_websites:e.excludedWebsites,safe_search:e.safeSearch},..."rss"===e.type&&{links:e.links}}})}:void 0,messages:v,tools:w,tool_choice:_},warnings:f}}async doGenerate(e){var t,r,a;let{args:s,warnings:n}=await this.getArgs(e),{responseHeaders:i,value:o,rawValue:l}=await hT({url:`${null!=(t=this.config.baseURL)?t:"https://api.x.ai/v1"}/chat/completions`,headers:ht(this.config.headers(),e.headers),body:s,failedResponseHandler:fB,successfulResponseHandler:hj(fH),abortSignal:e.abortSignal,fetch:this.config.fetch}),u=o.choices[0],d=[];if(null!=u.message.content&&u.message.content.length>0){let e=u.message.content,t=s.messages[s.messages.length-1];(null==t?void 0:t.role)==="assistant"&&e===t.content&&(e=""),e.length>0&&d.push({type:"text",text:e})}if(null!=u.message.reasoning_content&&u.message.reasoning_content.length>0&&d.push({type:"reasoning",text:u.message.reasoning_content}),null!=u.message.tool_calls)for(let e of u.message.tool_calls)d.push({type:"tool-call",toolCallId:e.id,toolName:e.function.name,input:e.function.arguments});if(null!=o.citations)for(let e of o.citations)d.push({type:"source",sourceType:"url",id:this.config.generateId(),url:e});return{content:d,finishReason:fU(u.finish_reason),usage:{inputTokens:o.usage.prompt_tokens,outputTokens:o.usage.completion_tokens,totalTokens:o.usage.total_tokens,reasoningTokens:null!=(a=null==(r=o.usage.completion_tokens_details)?void 0:r.reasoning_tokens)?a:void 0},request:{body:s},response:{...fL(o),headers:i,body:l},warnings:n}}async doStream(e){var t;let{args:r,warnings:a}=await this.getArgs(e),s={...r,stream:!0,stream_options:{include_usage:!0}},{responseHeaders:n,value:i}=await hT({url:`${null!=(t=this.config.baseURL)?t:"https://api.x.ai/v1"}/chat/completions`,headers:ht(this.config.headers(),e.headers),body:s,failedResponseHandler:fB,successfulResponseHandler:hN(fY),abortSignal:e.abortSignal,fetch:this.config.fetch}),o="unknown",l={inputTokens:void 0,outputTokens:void 0,totalTokens:void 0},u=!0,d={},p={},c=this;return{stream:i.pipeThrough(new TransformStream({start(e){e.enqueue({type:"stream-start",warnings:a})},transform(t,r){var a,n;if(e.includeRawChunks&&r.enqueue({type:"raw",rawValue:t.rawValue}),!t.success)return void r.enqueue({type:"error",error:t.error});let i=t.value;if(u&&(r.enqueue({type:"response-metadata",...fL(i)}),u=!1),null!=i.citations)for(let e of i.citations)r.enqueue({type:"source",sourceType:"url",id:c.config.generateId(),url:e});null!=i.usage&&(l.inputTokens=i.usage.prompt_tokens,l.outputTokens=i.usage.completion_tokens,l.totalTokens=i.usage.total_tokens,l.reasoningTokens=null!=(n=null==(a=i.usage.completion_tokens_details)?void 0:a.reasoning_tokens)?n:void 0);let h=i.choices[0];if((null==h?void 0:h.finish_reason)!=null&&(o=fU(h.finish_reason)),(null==h?void 0:h.delta)==null)return;let m=h.delta,g=h.index;if(null!=m.content&&m.content.length>0){let e=m.content,t=s.messages[s.messages.length-1];if((null==t?void 0:t.role)==="assistant"&&e===t.content)return;let a=`text-${i.id||g}`;null==d[a]&&(d[a]={type:"text"},r.enqueue({type:"text-start",id:a})),r.enqueue({type:"text-delta",id:a,delta:e})}if(null!=m.reasoning_content&&m.reasoning_content.length>0){let e=`reasoning-${i.id||g}`;if(p[e]===m.reasoning_content)return;p[e]=m.reasoning_content,null==d[e]&&(d[e]={type:"reasoning"},r.enqueue({type:"reasoning-start",id:e})),r.enqueue({type:"reasoning-delta",id:e,delta:m.reasoning_content})}if(null!=m.tool_calls)for(let e of m.tool_calls){let t=e.id;r.enqueue({type:"tool-input-start",id:t,toolName:e.function.name}),r.enqueue({type:"tool-input-delta",id:t,delta:e.function.arguments}),r.enqueue({type:"tool-input-end",id:t}),r.enqueue({type:"tool-call",toolCallId:t,toolName:e.function.name,input:e.function.arguments})}},flush(e){for(let[t,r]of Object.entries(d))e.enqueue({type:"text"===r.type?"text-end":"reasoning-end",id:t});e.enqueue({type:"finish",finishReason:o,usage:l})}})),request:{body:s},response:{headers:n}}}},fJ=nS.object({prompt_tokens:nS.number(),completion_tokens:nS.number(),total_tokens:nS.number(),completion_tokens_details:nS.object({reasoning_tokens:nS.number().nullish()}).nullish()}),fH=nS.object({id:nS.string().nullish(),created:nS.number().nullish(),model:nS.string().nullish(),choices:nS.array(nS.object({message:nS.object({role:nS.literal("assistant"),content:nS.string().nullish(),reasoning_content:nS.string().nullish(),tool_calls:nS.array(nS.object({id:nS.string(),type:nS.literal("function"),function:nS.object({name:nS.string(),arguments:nS.string()})})).nullish()}),index:nS.number(),finish_reason:nS.string().nullish()})),object:nS.literal("chat.completion"),usage:fJ,citations:nS.array(nS.string().url()).nullish()}),fY=nS.object({id:nS.string().nullish(),created:nS.number().nullish(),model:nS.string().nullish(),choices:nS.array(nS.object({delta:nS.object({role:nS.enum(["assistant"]).optional(),content:nS.string().nullish(),reasoning_content:nS.string().nullish(),tool_calls:nS.array(nS.object({id:nS.string(),type:nS.literal("function"),function:nS.object({name:nS.string(),arguments:nS.string()})})).nullish()}),finish_reason:nS.string().nullish(),index:nS.number()})),usage:fJ.nullish(),citations:nS.array(nS.string().url()).nullish()}),fQ={errorSchema:fG,errorToMessage:e=>e.error.message};function fX(e={}){var t;let r=ma(null!=(t=e.baseURL)?t:"https://api.x.ai/v1"),a=()=>hs({Authorization:`Bearer ${hh({apiKey:e.apiKey,environmentVariableName:"XAI_API_KEY",description:"xAI API key"})}`,...e.headers},"ai-sdk/xai/2.0.23"),s=t=>new fK(t,{provider:"xai.chat",baseURL:r,headers:a,generateId:hi,fetch:e.fetch}),n=t=>new f$(t,{provider:"xai.image",url:({path:e})=>`${r}${e}`,headers:a,fetch:e.fetch,errorStructure:fQ}),i=e=>s(e);return i.languageModel=s,i.chat=s,i.textEmbeddingModel=e=>{throw new cK({modelId:e,modelType:"textEmbeddingModel"})},i.imageModel=n,i.image=n,i}fX();var nS=n_,f0=Object.defineProperty,f1=Object.defineProperties,f2=Object.getOwnPropertyDescriptors,f4=Object.getOwnPropertySymbols,f5=Object.prototype.hasOwnProperty,f3=Object.prototype.propertyIsEnumerable,f9=(e,t,r)=>t in e?f0(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,f6=(e,t)=>{for(var r in t||(t={}))f5.call(t,r)&&f9(e,r,t[r]);if(f4)for(var r of f4(t))f3.call(t,r)&&f9(e,r,t[r]);return e},f8="vercel.ai.error",f7=Symbol.for(f8),ye=class e extends Error{constructor({name:e,message:t,cause:r}){super(t),this[eI]=!0,this.name=e,this.cause=r}static isInstance(t){return e.hasMarker(t,f8)}static hasMarker(e,t){let r=Symbol.for(t);return null!=e&&"object"==typeof e&&r in e&&"boolean"==typeof e[r]&&!0===e[r]}};eI=f7;var yt=ye,yr="AI_APICallError",ya=`vercel.ai.error.${yr}`,ys=Symbol.for(ya),yn=class extends yt{constructor({message:e,url:t,requestBodyValues:r,statusCode:a,responseHeaders:s,responseBody:n,cause:i,isRetryable:o=null!=a&&(408===a||409===a||429===a||a>=500),data:l}){super({name:yr,message:e,cause:i}),this[ek]=!0,this.url=t,this.requestBodyValues=r,this.statusCode=a,this.responseHeaders=s,this.responseBody=n,this.isRetryable=o,this.data=l}static isInstance(e){return yt.hasMarker(e,ya)}};ek=ys;var yi="AI_EmptyResponseBodyError",yo=`vercel.ai.error.${yi}`,yl=Symbol.for(yo),yu=class extends yt{constructor({message:e="Empty response body"}={}){super({name:yi,message:e}),this[eT]=!0}static isInstance(e){return yt.hasMarker(e,yo)}};function yd(e){return null==e?"unknown error":"string"==typeof e?e:e instanceof Error?e.message:JSON.stringify(e)}eT=yl;var yp="AI_InvalidArgumentError",yc=`vercel.ai.error.${yp}`,yh=Symbol.for(yc),ym=class extends yt{constructor({message:e,cause:t,argument:r}){super({name:yp,message:e,cause:t}),this[eE]=!0,this.argument=r}static isInstance(e){return yt.hasMarker(e,yc)}};eE=yh;var yg="AI_InvalidPromptError",yf=`vercel.ai.error.${yg}`,yy=Symbol.for(yf),yv=class extends yt{constructor({prompt:e,message:t,cause:r}){super({name:yg,message:`Invalid prompt: ${t}`,cause:r}),this[eA]=!0,this.prompt=e}static isInstance(e){return yt.hasMarker(e,yf)}};eA=yy;var yb="AI_InvalidResponseDataError",yw=`vercel.ai.error.${yb}`,y_=Symbol.for(yw),yS=class extends yt{constructor({data:e,message:t=`Invalid response data: ${JSON.stringify(e)}.`}){super({name:yb,message:t}),this[eO]=!0,this.data=e}static isInstance(e){return yt.hasMarker(e,yw)}};eO=y_;var yx="AI_JSONParseError",yI=`vercel.ai.error.${yx}`,yk=Symbol.for(yI),yT=class extends yt{constructor({text:e,cause:t}){super({name:yx,message:`JSON parsing failed: Text: ${e}.
Error message: ${yd(t)}`,cause:t}),this[eC]=!0,this.text=e}static isInstance(e){return yt.hasMarker(e,yI)}};eC=yk;var yE="AI_LoadAPIKeyError",yA=`vercel.ai.error.${yE}`,yO=Symbol.for(yA),yC=class extends yt{constructor({message:e}){super({name:yE,message:e}),this[eR]=!0}static isInstance(e){return yt.hasMarker(e,yA)}};eR=yO,Symbol.for("vercel.ai.error.AI_LoadSettingError"),Symbol.for("vercel.ai.error.AI_NoContentGeneratedError"),Symbol.for("vercel.ai.error.AI_NoSuchModelError"),Symbol.for("vercel.ai.error.AI_TooManyEmbeddingValuesForCallError");var yR="AI_TypeValidationError",yM=`vercel.ai.error.${yR}`,yN=Symbol.for(yM),yj=class e extends yt{constructor({value:e,cause:t}){super({name:yR,message:`Type validation failed: Value: ${JSON.stringify(e)}.
Error message: ${yd(t)}`,cause:t}),this[eM]=!0,this.value=e}static isInstance(e){return yt.hasMarker(e,yM)}static wrap({value:t,cause:r}){return e.isInstance(r)&&r.value===t?r:new e({value:t,cause:r})}};eM=yN;var yP="AI_UnsupportedFunctionalityError",y$=`vercel.ai.error.${yP}`,yD=Symbol.for(y$),yL=class extends yt{constructor({functionality:e,message:t=`'${e}' functionality not supported.`}){super({name:yP,message:t}),this[eN]=!0,this.functionality=e}static isInstance(e){return yt.hasMarker(e,y$)}};eN=yD;var yU=class extends Error{constructor(e,t){super(e),this.name="ParseError",this.type=t.type,this.field=t.field,this.value=t.value,this.line=t.line}};function yz(e){}var yq=class extends TransformStream{constructor({onError:e,onRetry:t,onComment:r}={}){let a;super({start(s){a=function(e){if("function"==typeof e)throw TypeError("`callbacks` must be an object, got a function instead. Did you mean `{onEvent: fn}`?");let{onEvent:t=yz,onError:r=yz,onRetry:a=yz,onComment:s}=e,n="",i=!0,o,l="",u="";function d(e){if(""===e)return void(l.length>0&&t({id:o,event:u||void 0,data:l.endsWith(`
`)?l.slice(0,-1):l}),o=void 0,l="",u="");if(e.startsWith(":")){s&&s(e.slice(e.startsWith(": ")?2:1));return}let r=e.indexOf(":");if(-1!==r){let t=e.slice(0,r),a=" "===e[r+1]?2:1;p(t,e.slice(r+a),e);return}p(e,"",e)}function p(e,t,s){switch(e){case"event":u=t;break;case"data":l=`${l}${t}
`;break;case"id":o=t.includes("\0")?void 0:t;break;case"retry":/^\d+$/.test(t)?a(parseInt(t,10)):r(new yU(`Invalid \`retry\` value: "${t}"`,{type:"invalid-retry",value:t,line:s}));break;default:r(new yU(`Unknown field "${e.length>20?`${e.slice(0,20)}\u2026`:e}"`,{type:"unknown-field",field:e,value:t,line:s}))}}return{feed:function(e){let t=i?e.replace(/^\xEF\xBB\xBF/,""):e,[r,a]=function(e){let t=[],r="",a=0;for(;a<e.length;){let s=e.indexOf("\r",a),n=e.indexOf(`
`,a),i=-1;if(-1!==s&&-1!==n?i=Math.min(s,n):-1!==s?i=s:-1!==n&&(i=n),-1===i){r=e.slice(a);break}{let r=e.slice(a,i);t.push(r),"\r"===e[(a=i+1)-1]&&e[a]===`
`&&a++}}return[t,r]}(`${n}${t}`);for(let e of r)d(e);n=a,i=!1},reset:function(e={}){n&&e.consume&&d(n),i=!0,o=void 0,l="",u="",n=""}}}({onEvent:e=>{s.enqueue(e)},onError(t){"terminate"===e?s.error(t):"function"==typeof e&&e(t)},onRetry:t,onComment:r})},transform(e){a.feed(e)}})}};function yV(...e){return e.reduce((e,t)=>f6(f6({},e),null!=t?t:{}),{})}function yF(e){return Object.fromEntries([...e.headers])}Symbol("Let zodToJsonSchema decide on which parser to use");var yZ=(({prefix:e,size:t=16,alphabet:r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",separator:a="-"}={})=>{let s=()=>{let e=r.length,a=Array(t);for(let s=0;s<t;s++)a[s]=r[Math.random()*e|0];return a.join("")};if(null==e)return s;if(r.includes(a))throw new ym({argument:"separator",message:`The separator "${a}" must not be part of the alphabet "${r}".`});return()=>`${e}${a}${s()}`})();function yW(e){return(e instanceof Error||e instanceof DOMException)&&("AbortError"===e.name||"ResponseAborted"===e.name||"TimeoutError"===e.name)}var yG=["fetch failed","failed to fetch"],yB=/"__proto__"\s*:/,yK=/"constructor"\s*:/;function yJ(e){let{stackTraceLimit:t}=Error;Error.stackTraceLimit=0;try{let t;return t=JSON.parse(e),null===t||"object"!=typeof t||!1===yB.test(e)&&!1===yK.test(e)?t:function(e){let t=[e];for(;t.length;){let e=t;for(let r of(t=[],e)){if(Object.prototype.hasOwnProperty.call(r,"__proto__")||Object.prototype.hasOwnProperty.call(r,"constructor")&&Object.prototype.hasOwnProperty.call(r.constructor,"prototype"))throw SyntaxError("Object contains forbidden prototype property");for(let e in r){let a=r[e];a&&"object"==typeof a&&t.push(a)}}}return e}(t)}finally{Error.stackTraceLimit=t}}var yH=Symbol.for("vercel.ai.validator");async function yY({value:e,schema:t}){let r=await yQ({value:e,schema:t});if(!r.success)throw yj.wrap({value:e,cause:r.error});return r.value}async function yQ({value:e,schema:t}){var r;let a="object"==typeof t&&null!==t&&yH in t&&!0===t[yH]&&"validate"in t?t:(r=t,{[yH]:!0,validate:async e=>{let t=await r["~standard"].validate(e);return null==t.issues?{success:!0,value:t.value}:{success:!1,error:new yj({value:e,cause:t.issues})}}});try{if(null==a.validate)return{success:!0,value:e,rawValue:e};let t=await a.validate(e);if(t.success)return{success:!0,value:t.value,rawValue:e};return{success:!1,error:yj.wrap({value:e,cause:t.error}),rawValue:e}}catch(t){return{success:!1,error:yj.wrap({value:e,cause:t}),rawValue:e}}}async function yX({text:e,schema:t}){try{let r=yJ(e);if(null==t)return r;return yY({value:r,schema:t})}catch(t){if(yT.isInstance(t)||yj.isInstance(t))throw t;throw new yT({text:e,cause:t})}}async function y0({text:e,schema:t}){try{let r=yJ(e);if(null==t)return{success:!0,value:r,rawValue:r};return await yQ({value:r,schema:t})}catch(t){return{success:!1,error:yT.isInstance(t)?t:new yT({text:e,cause:t}),rawValue:void 0}}}function y1(e){try{return yJ(e),!0}catch(e){return!1}}var y2=()=>globalThis.fetch,y4=async({url:e,headers:t,body:r,failedResponseHandler:a,successfulResponseHandler:s,abortSignal:n,fetch:i})=>y5({url:e,headers:f6({"Content-Type":"application/json"},t),body:{content:JSON.stringify(r),values:r},failedResponseHandler:a,successfulResponseHandler:s,abortSignal:n,fetch:i}),y5=async({url:e,headers:t={},body:r,successfulResponseHandler:a,failedResponseHandler:s,abortSignal:n,fetch:i=y2()})=>{try{let o=await i(e,{method:"POST",headers:Object.fromEntries(Object.entries(t).filter(([e,t])=>null!=t)),body:r.content,signal:n}),l=yF(o);if(!o.ok){let t;try{t=await s({response:o,url:e,requestBodyValues:r.values})}catch(t){if(yW(t)||yn.isInstance(t))throw t;throw new yn({message:"Failed to process error response",cause:t,statusCode:o.status,url:e,responseHeaders:l,requestBodyValues:r.values})}throw t.value}try{return await a({response:o,url:e,requestBodyValues:r.values})}catch(t){if(t instanceof Error&&(yW(t)||yn.isInstance(t)))throw t;throw new yn({message:"Failed to process successful response",cause:t,statusCode:o.status,url:e,responseHeaders:l,requestBodyValues:r.values})}}catch(t){throw function({error:e,url:t,requestBodyValues:r}){if(yW(e))return e;if(e instanceof TypeError&&yG.includes(e.message.toLowerCase())){let a=e.cause;if(null!=a)return new yn({message:`Cannot connect to API: ${a.message}`,cause:a,url:t,requestBodyValues:r,isRetryable:!0})}return e}({error:t,url:e,requestBodyValues:r.values})}},y3=e=>async({response:t})=>{let r=yF(t);if(null==t.body)throw new yu({});return{responseHeaders:r,value:function({stream:e,schema:t}){return e.pipeThrough(new TextDecoderStream).pipeThrough(new yq).pipeThrough(new TransformStream({async transform({data:e},r){"[DONE]"!==e&&r.enqueue(await y0({text:e,schema:t}))}}))}({stream:t.body,schema:e})}},y9=e=>async({response:t,url:r,requestBodyValues:a})=>{let s=await t.text(),n=await y0({text:s,schema:e}),i=yF(t);if(!n.success)throw new yn({message:"Invalid JSON response",cause:n.error,statusCode:t.status,responseHeaders:i,responseBody:s,url:r,requestBodyValues:a});return{responseHeaders:i,value:n.value,rawValue:n.rawValue}};Symbol.for("vercel.ai.schema");var{btoa:y6,atob:y8}=globalThis,y7=nS.object({type:nS.literal("reasoning.summary"),summary:nS.string()}),ve=nS.object({type:nS.literal("reasoning.encrypted"),data:nS.string()}),vt=nS.object({type:nS.literal("reasoning.text"),text:nS.string().nullish(),signature:nS.string().nullish()}),vr=nS.union([y7,ve,vt]),va=nS.union([vr,nS.unknown().transform(()=>null)]),vs=nS.array(va).transform(e=>e.filter(e=>!!e)),vn=nS.object({error:nS.object({code:nS.union([nS.string(),nS.number()]).nullable().optional().default(null),message:nS.string(),type:nS.string().nullable().optional().default(null),param:nS.any().nullable().optional().default(null)})}),vi=(({errorSchema:e,errorToMessage:t,isRetryable:r})=>async({response:a,url:s,requestBodyValues:n})=>{let i=await a.text(),o=yF(a);if(""===i.trim())return{responseHeaders:o,value:new yn({message:a.statusText,url:s,requestBodyValues:n,statusCode:a.status,responseHeaders:o,responseBody:i,isRetryable:null==r?void 0:r(a)})};try{let l=await yX({text:i,schema:e});return{responseHeaders:o,value:new yn({message:t(l),url:s,requestBodyValues:n,statusCode:a.status,responseHeaders:o,responseBody:i,data:l,isRetryable:null==r?void 0:r(a,l)})}}catch(e){return{responseHeaders:o,value:new yn({message:a.statusText,url:s,requestBodyValues:n,statusCode:a.status,responseHeaders:o,responseBody:i,isRetryable:null==r?void 0:r(a)})}}})({errorSchema:vn,errorToMessage:e=>e.error.message});function vo(e){switch(e){case"stop":return"stop";case"length":return"length";case"content_filter":return"content-filter";case"function_call":case"tool_calls":return"tool-calls";default:return"unknown"}}function vl({url:e,protocols:t}){try{let r=new URL(e);return t.has(r.protocol)}catch(e){return!1}}function vu({part:e,defaultMediaType:t}){var r,a;if(e.data instanceof Uint8Array){let a=function(e){let t="";for(let r=0;r<e.length;r++)t+=String.fromCodePoint(e[r]);return y6(t)}(e.data);return`data:${null!=(r=e.mediaType)?r:t};base64,${a}`}let s=e.data.toString();return vl({url:s,protocols:new Set(["http:","https:"])})||s.startsWith("data:")?s:`data:${null!=(a=e.mediaType)?a:t};base64,${s}`}function vd(e,t){var r;let a=e.match(/^data:([^;]+)/);return a&&null!=(r=a[1])?r:t}function vp(e){let t=e.match(/^data:[^;]*;base64,(.+)$/);return t?t[1]:e}function vc(e){var t,r,a;let s=null==e?void 0:e.anthropic,n=null==e?void 0:e.openrouter;return null!=(a=null!=(r=null!=(t=null==n?void 0:n.cacheControl)?t:null==n?void 0:n.cache_control)?r:null==s?void 0:s.cacheControl)?a:null==s?void 0:s.cache_control}nS.union([nS.literal("auto"),nS.literal("none"),nS.literal("required"),nS.object({type:nS.literal("function"),function:nS.object({name:nS.string()})})]);var vh=nS.object({type:nS.literal("image_url"),image_url:nS.object({url:nS.string()})}),vm=nS.union([vh,nS.unknown().transform(()=>null)]),vg=nS.array(vm).transform(e=>e.filter(e=>!!e)),vf=nS.object({id:nS.string().optional(),model:nS.string().optional(),provider:nS.string().optional(),usage:nS.object({prompt_tokens:nS.number(),prompt_tokens_details:nS.object({cached_tokens:nS.number()}).nullish(),completion_tokens:nS.number(),completion_tokens_details:nS.object({reasoning_tokens:nS.number()}).nullish(),total_tokens:nS.number(),cost:nS.number().optional(),cost_details:nS.object({upstream_inference_cost:nS.number().nullish()}).nullish()}).nullish()}),vy=vf.extend({choices:nS.array(nS.object({message:nS.object({role:nS.literal("assistant"),content:nS.string().nullable().optional(),reasoning:nS.string().nullable().optional(),reasoning_details:vs.nullish(),images:vg.nullish(),tool_calls:nS.array(nS.object({id:nS.string().optional().nullable(),type:nS.literal("function"),function:nS.object({name:nS.string(),arguments:nS.string()})})).optional(),annotations:nS.array(nS.object({type:nS.enum(["url_citation"]),url_citation:nS.object({end_index:nS.number(),start_index:nS.number(),title:nS.string(),url:nS.string(),content:nS.string().optional()})})).nullish()}),index:nS.number().nullish(),logprobs:nS.object({content:nS.array(nS.object({token:nS.string(),logprob:nS.number(),top_logprobs:nS.array(nS.object({token:nS.string(),logprob:nS.number()}))})).nullable()}).nullable().optional(),finish_reason:nS.string().optional().nullable()}))}),vv=nS.union([vf.extend({choices:nS.array(nS.object({delta:nS.object({role:nS.enum(["assistant"]).optional(),content:nS.string().nullish(),reasoning:nS.string().nullish().optional(),reasoning_details:vs.nullish(),images:vg.nullish(),tool_calls:nS.array(nS.object({index:nS.number().nullish(),id:nS.string().nullish(),type:nS.literal("function").optional(),function:nS.object({name:nS.string().nullish(),arguments:nS.string().nullish()})})).nullish(),annotations:nS.array(nS.object({type:nS.enum(["url_citation"]),url_citation:nS.object({end_index:nS.number(),start_index:nS.number(),title:nS.string(),url:nS.string(),content:nS.string().optional()})})).nullish()}).nullish(),logprobs:nS.object({content:nS.array(nS.object({token:nS.string(),logprob:nS.number(),top_logprobs:nS.array(nS.object({token:nS.string(),logprob:nS.number()}))})).nullable()}).nullish(),finish_reason:nS.string().nullable().optional(),index:nS.number().nullish()}))}),vn]),vb=class{constructor(e,t,r){this.specificationVersion="v2",this.provider="openrouter",this.defaultObjectGenerationMode="tool",this.supportedUrls={"image/*":[/^data:image\/[a-zA-Z]+;base64,/,/^https?:\/\/.+\.(jpg|jpeg|png|gif|webp)$/i],"application/*":[/^data:application\//,/^https?:\/\/.+$/]},this.modelId=e,this.settings=t,this.config=r}getArgs({prompt:e,maxOutputTokens:t,temperature:r,topP:a,frequencyPenalty:s,presencePenalty:n,seed:i,stopSequences:o,responseFormat:l,topK:u,tools:d,toolChoice:p}){var c;let h=f6(f6({model:this.modelId,models:this.settings.models,logit_bias:this.settings.logitBias,logprobs:!0===this.settings.logprobs||"number"==typeof this.settings.logprobs||void 0,top_logprobs:"number"==typeof this.settings.logprobs?this.settings.logprobs:"boolean"==typeof this.settings.logprobs&&this.settings.logprobs?0:void 0,user:this.settings.user,parallel_tool_calls:this.settings.parallelToolCalls,max_tokens:t,temperature:r,top_p:a,frequency_penalty:s,presence_penalty:n,seed:i,stop:o,response_format:l,top_k:u,messages:function(e){var t,r,a,s;let n=[];for(let{role:i,content:o,providerOptions:l}of e)switch(i){case"system":n.push({role:"system",content:o,cache_control:vc(l)});break;case"user":{if(1===o.length&&(null==(t=o[0])?void 0:t.type)==="text"){let e=null!=(r=vc(l))?r:vc(o[0].providerOptions),t=e?[{type:"text",text:o[0].text,cache_control:e}]:o[0].text;n.push({role:"user",content:t});break}let e=vc(l),a=o.map(t=>{var r,a,s,n,i,o;let l=null!=(r=vc(t.providerOptions))?r:e;switch(t.type){case"text":return{type:"text",text:t.text,cache_control:l};case"file":{if(null==(a=t.mediaType)?void 0:a.startsWith("image/"))return{type:"image_url",image_url:{url:vu({part:t,defaultMediaType:"image/jpeg"})},cache_control:l};let e=String(null!=(o=null!=(i=null==(n=null==(s=t.providerOptions)?void 0:s.openrouter)?void 0:n.filename)?i:t.filename)?o:""),r=vu({part:t,defaultMediaType:"application/pdf"});if(vl({url:r,protocols:new Set(["http:","https:"])}))return{type:"file",file:{filename:e,file_data:r}};return{type:"file",file:{filename:e,file_data:r},cache_control:l}}default:return{type:"text",text:"",cache_control:l}}});n.push({role:"user",content:a});break}case"assistant":{let e="",t="",r=[],a=[];for(let s of o)switch(s.type){case"text":e+=s.text;break;case"tool-call":a.push({id:s.toolCallId,type:"function",function:{name:s.toolName,arguments:JSON.stringify(s.input)}});break;case"reasoning":t+=s.text,r.push({type:"reasoning.text",text:s.text})}n.push({role:"assistant",content:e,tool_calls:a.length>0?a:void 0,reasoning:t||void 0,reasoning_details:r.length>0?r:void 0,cache_control:vc(l)});break}case"tool":for(let e of o){let t="text"===(s=e).output.type?s.output.value:JSON.stringify(s.output.value);n.push({role:"tool",tool_call_id:e.toolCallId,content:t,cache_control:null!=(a=vc(l))?a:vc(e.providerOptions)})}}return n}(e),include_reasoning:this.settings.includeReasoning,reasoning:this.settings.reasoning,usage:this.settings.usage,plugins:this.settings.plugins,web_search_options:this.settings.web_search_options,provider:this.settings.provider},this.config.extraBody),this.settings.extraBody);if((null==l?void 0:l.type)==="json"&&null!=l.schema)return f1(f6({},h),f2({response_format:{type:"json_schema",json_schema:f6({schema:l.schema,strict:!0,name:null!=(c=l.name)?c:"response"},l.description&&{description:l.description})}}));if(d&&d.length>0){let e=d.filter(e=>"function"===e.type).map(e=>({type:"function",function:{name:e.name,description:e.description,parameters:e.inputSchema}}));return f1(f6({},h),f2({tools:e,tool_choice:p?function(e){switch(e.type){case"auto":case"none":case"required":return e.type;case"tool":return{type:"function",function:{name:e.toolName}};default:throw Error(`Invalid tool choice type: ${e}`)}}(p):void 0}))}return h}async doGenerate(e){var t,r,a,s,n,i,o,l,u,d,p,c,h,m,g,f,y,v,b,w,_,S,I,k;let T=(e.providerOptions||{}).openrouter||{},E=f6(f6({},this.getArgs(e)),T),{value:A,responseHeaders:O}=await y4({url:this.config.url({path:"/chat/completions",modelId:this.modelId}),headers:yV(this.config.headers(),e.headers),body:E,failedResponseHandler:vi,successfulResponseHandler:y9(vy),abortSignal:e.abortSignal,fetch:this.config.fetch}),C=A.choices[0];if(!C)throw Error("No choice in response");let R=A.usage?{inputTokens:null!=(t=A.usage.prompt_tokens)?t:0,outputTokens:null!=(r=A.usage.completion_tokens)?r:0,totalTokens:(null!=(a=A.usage.prompt_tokens)?a:0)+(null!=(s=A.usage.completion_tokens)?s:0),reasoningTokens:null!=(i=null==(n=A.usage.completion_tokens_details)?void 0:n.reasoning_tokens)?i:0,cachedInputTokens:null!=(l=null==(o=A.usage.prompt_tokens_details)?void 0:o.cached_tokens)?l:0}:{inputTokens:0,outputTokens:0,totalTokens:0,reasoningTokens:0,cachedInputTokens:0},M=null!=(u=C.message.reasoning_details)?u:[],N=M.length>0?M.map(e=>{switch(e.type){case"reasoning.text":if(e.text)return{type:"reasoning",text:e.text};break;case"reasoning.summary":if(e.summary)return{type:"reasoning",text:e.summary};break;case"reasoning.encrypted":if(e.data)return{type:"reasoning",text:"[REDACTED]"}}return null}).filter(e=>null!==e):C.message.reasoning?[{type:"reasoning",text:C.message.reasoning}]:[],j=[];if(j.push(...N),C.message.content&&j.push({type:"text",text:C.message.content}),C.message.tool_calls)for(let e of C.message.tool_calls)j.push({type:"tool-call",toolCallId:null!=(d=e.id)?d:yZ(),toolName:e.function.name,input:e.function.arguments});if(C.message.images)for(let e of C.message.images)j.push({type:"file",mediaType:vd(e.image_url.url,"image/jpeg"),data:vp(e.image_url.url)});if(C.message.annotations)for(let e of C.message.annotations)"url_citation"===e.type&&j.push({type:"source",sourceType:"url",id:e.url_citation.url,url:e.url_citation.url,title:e.url_citation.title,providerMetadata:{openrouter:{content:e.url_citation.content||""}}});return{content:j,finishReason:vo(C.finish_reason),usage:R,warnings:[],providerMetadata:{openrouter:{provider:null!=(p=A.provider)?p:"",usage:{promptTokens:null!=(c=R.inputTokens)?c:0,completionTokens:null!=(h=R.outputTokens)?h:0,totalTokens:null!=(m=R.totalTokens)?m:0,cost:null==(g=A.usage)?void 0:g.cost,promptTokensDetails:{cachedTokens:null!=(v=null==(y=null==(f=A.usage)?void 0:f.prompt_tokens_details)?void 0:y.cached_tokens)?v:0},completionTokensDetails:{reasoningTokens:null!=(_=null==(w=null==(b=A.usage)?void 0:b.completion_tokens_details)?void 0:w.reasoning_tokens)?_:0},costDetails:{upstreamInferenceCost:null!=(k=null==(I=null==(S=A.usage)?void 0:S.cost_details)?void 0:I.upstream_inference_cost)?k:0}}}},request:{body:E},response:{id:A.id,modelId:A.model,headers:O}}}async doStream(e){var t;let r,a,s,n,i=(e.providerOptions||{}).openrouter||{},o=f6(f6({},this.getArgs(e)),i),{value:l,responseHeaders:u}=await y4({url:this.config.url({path:"/chat/completions",modelId:this.modelId}),headers:yV(this.config.headers(),e.headers),body:f1(f6({},o),f2({stream:!0,stream_options:"strict"===this.config.compatibility?f6({include_usage:!0},(null==(t=this.settings.usage)?void 0:t.include)?{include_usage:!0}:{}):void 0})),failedResponseHandler:vi,successfulResponseHandler:y3(vv),abortSignal:e.abortSignal,fetch:this.config.fetch}),d=[],p="other",c={inputTokens:NaN,outputTokens:NaN,totalTokens:NaN,reasoningTokens:NaN,cachedInputTokens:NaN},h={},m=!1,g=!1;return{stream:l.pipeThrough(new TransformStream({transform(e,t){var i,o,l,u,f,y,v,b,w,_,S,I,k,T;if(!e.success){p="error",t.enqueue({type:"error",error:e.error});return}let E=e.value;if("error"in E){p="error",t.enqueue({type:"error",error:E.error});return}if(E.provider&&(n=E.provider),E.id&&(s=E.id,t.enqueue({type:"response-metadata",id:E.id})),E.model&&t.enqueue({type:"response-metadata",modelId:E.model}),null!=E.usage){if(c.inputTokens=E.usage.prompt_tokens,c.outputTokens=E.usage.completion_tokens,c.totalTokens=E.usage.prompt_tokens+E.usage.completion_tokens,h.promptTokens=E.usage.prompt_tokens,E.usage.prompt_tokens_details){let e=null!=(i=E.usage.prompt_tokens_details.cached_tokens)?i:0;c.cachedInputTokens=e,h.promptTokensDetails={cachedTokens:e}}if(h.completionTokens=E.usage.completion_tokens,E.usage.completion_tokens_details){let e=null!=(o=E.usage.completion_tokens_details.reasoning_tokens)?o:0;c.reasoningTokens=e,h.completionTokensDetails={reasoningTokens:e}}h.cost=E.usage.cost,h.totalTokens=E.usage.total_tokens}let A=E.choices[0];if((null==A?void 0:A.finish_reason)!=null&&(p=vo(A.finish_reason)),(null==A?void 0:A.delta)==null)return;let O=A.delta,C=e=>{g||(a=s||yZ(),t.enqueue({type:"reasoning-start",id:a}),g=!0),t.enqueue({type:"reasoning-delta",delta:e,id:a||yZ()})};if(O.reasoning_details&&O.reasoning_details.length>0)for(let e of O.reasoning_details)switch(e.type){case"reasoning.text":e.text&&C(e.text);break;case"reasoning.encrypted":e.data&&C("[REDACTED]");break;case"reasoning.summary":e.summary&&C(e.summary)}else O.reasoning&&C(O.reasoning);if(O.content&&(g&&!m&&(t.enqueue({type:"reasoning-end",id:a||yZ()}),g=!1),m||(r=s||yZ(),t.enqueue({type:"text-start",id:r}),m=!0),t.enqueue({type:"text-delta",delta:O.content,id:r||yZ()})),O.annotations)for(let e of O.annotations)"url_citation"===e.type&&t.enqueue({type:"source",sourceType:"url",id:e.url_citation.url,url:e.url_citation.url,title:e.url_citation.title,providerMetadata:{openrouter:{content:e.url_citation.content||""}}});if(null!=O.tool_calls)for(let e of O.tool_calls){let r=null!=(l=e.index)?l:d.length-1;if(null==d[r]){if("function"!==e.type)throw new yS({data:e,message:"Expected 'function' type."});if(null==e.id)throw new yS({data:e,message:"Expected 'id' to be a string."});if((null==(u=e.function)?void 0:u.name)==null)throw new yS({data:e,message:"Expected 'function.name' to be a string."});d[r]={id:e.id,type:"function",function:{name:e.function.name,arguments:null!=(f=e.function.arguments)?f:""},inputStarted:!1,sent:!1};let a=d[r];if(null==a)throw Error("Tool call is missing");(null==(y=a.function)?void 0:y.name)!=null&&(null==(v=a.function)?void 0:v.arguments)!=null&&y1(a.function.arguments)&&(a.inputStarted=!0,t.enqueue({type:"tool-input-start",id:a.id,toolName:a.function.name}),t.enqueue({type:"tool-input-delta",id:a.id,delta:a.function.arguments}),t.enqueue({type:"tool-input-end",id:a.id}),t.enqueue({type:"tool-call",toolCallId:a.id,toolName:a.function.name,input:a.function.arguments}),a.sent=!0);continue}let a=d[r];if(null==a)throw Error("Tool call is missing");a.inputStarted||(a.inputStarted=!0,t.enqueue({type:"tool-input-start",id:a.id,toolName:a.function.name})),(null==(b=e.function)?void 0:b.arguments)!=null&&(a.function.arguments+=null!=(_=null==(w=e.function)?void 0:w.arguments)?_:""),t.enqueue({type:"tool-input-delta",id:a.id,delta:null!=(S=e.function.arguments)?S:""}),(null==(I=a.function)?void 0:I.name)!=null&&(null==(k=a.function)?void 0:k.arguments)!=null&&y1(a.function.arguments)&&(t.enqueue({type:"tool-call",toolCallId:null!=(T=a.id)?T:yZ(),toolName:a.function.name,input:a.function.arguments}),a.sent=!0)}if(null!=O.images)for(let e of O.images)t.enqueue({type:"file",mediaType:vd(e.image_url.url,"image/jpeg"),data:vp(e.image_url.url)})},flush(e){var t;if("tool-calls"===p)for(let r of d)r&&!r.sent&&(e.enqueue({type:"tool-call",toolCallId:null!=(t=r.id)?t:yZ(),toolName:r.function.name,input:y1(r.function.arguments)?r.function.arguments:"{}"}),r.sent=!0);g&&e.enqueue({type:"reasoning-end",id:a||yZ()}),m&&e.enqueue({type:"text-end",id:r||yZ()});let s={usage:h};void 0!==n&&(s.provider=n),e.enqueue({type:"finish",finishReason:p,usage:c,providerMetadata:{openrouter:s}})}})),warnings:[],request:{body:o},response:{headers:u}}}},vw=nS.union([nS.object({id:nS.string().optional(),model:nS.string().optional(),choices:nS.array(nS.object({text:nS.string(),reasoning:nS.string().nullish().optional(),reasoning_details:vs.nullish(),finish_reason:nS.string().nullish(),index:nS.number().nullish(),logprobs:nS.object({tokens:nS.array(nS.string()),token_logprobs:nS.array(nS.number()),top_logprobs:nS.array(nS.record(nS.string(),nS.number())).nullable()}).nullable().optional()})),usage:nS.object({prompt_tokens:nS.number(),prompt_tokens_details:nS.object({cached_tokens:nS.number()}).nullish(),completion_tokens:nS.number(),completion_tokens_details:nS.object({reasoning_tokens:nS.number()}).nullish(),total_tokens:nS.number(),cost:nS.number().optional()}).nullish()}),vn]),v_=class{constructor(e,t,r){this.specificationVersion="v2",this.provider="openrouter",this.supportedUrls={"image/*":[/^data:image\/[a-zA-Z]+;base64,/,/^https?:\/\/.+\.(jpg|jpeg|png|gif|webp)$/i],"text/*":[/^data:text\//,/^https?:\/\/.+$/],"application/*":[/^data:application\//,/^https?:\/\/.+$/]},this.defaultObjectGenerationMode=void 0,this.modelId=e,this.settings=t,this.config=r}getArgs({prompt:e,maxOutputTokens:t,temperature:r,topP:a,frequencyPenalty:s,presencePenalty:n,seed:i,responseFormat:o,topK:l,stopSequences:u,tools:d,toolChoice:p}){let{prompt:c}=function({prompt:e,inputFormat:t,user:r="user",assistant:a="assistant"}){if("prompt"===t&&1===e.length&&e[0]&&"user"===e[0].role&&1===e[0].content.length&&e[0].content[0]&&"text"===e[0].content[0].type)return{prompt:e[0].content[0].text};let s="";for(let{role:t,content:n}of(e[0]&&"system"===e[0].role&&(s+=`${e[0].content}

`,e=e.slice(1)),e))switch(t){case"system":throw new yv({message:`Unexpected system message in prompt: ${n}`,prompt:e});case"user":{let e=n.map(e=>{switch(e.type){case"text":return e.text;case"file":throw new yL({functionality:"file attachments"});default:return""}}).join("");s+=`${r}:
${e}

`;break}case"assistant":{let e=n.map(e=>{switch(e.type){case"text":return e.text;case"tool-call":throw new yL({functionality:"tool-call messages"});case"tool-result":throw new yL({functionality:"tool-result messages"});case"reasoning":throw new yL({functionality:"reasoning messages"});case"file":throw new yL({functionality:"file attachments"});default:return""}}).join("");s+=`${a}:
${e}

`;break}case"tool":throw new yL({functionality:"tool messages"})}return{prompt:s+=`${a}:
`}}({prompt:e,inputFormat:"prompt"});if(null==d?void 0:d.length)throw new yL({functionality:"tools"});if(p)throw new yL({functionality:"toolChoice"});return f6(f6({model:this.modelId,models:this.settings.models,logit_bias:this.settings.logitBias,logprobs:"number"==typeof this.settings.logprobs?this.settings.logprobs:"boolean"==typeof this.settings.logprobs&&this.settings.logprobs?0:void 0,suffix:this.settings.suffix,user:this.settings.user,max_tokens:t,temperature:r,top_p:a,frequency_penalty:s,presence_penalty:n,seed:i,stop:u,response_format:o,top_k:l,prompt:c,include_reasoning:this.settings.includeReasoning,reasoning:this.settings.reasoning},this.config.extraBody),this.settings.extraBody)}async doGenerate(e){var t,r,a,s,n,i,o,l,u,d,p,c,h,m,g;let f=(e.providerOptions||{}).openrouter||{},y=f6(f6({},this.getArgs(e)),f),{value:v,responseHeaders:b}=await y4({url:this.config.url({path:"/completions",modelId:this.modelId}),headers:yV(this.config.headers(),e.headers),body:y,failedResponseHandler:vi,successfulResponseHandler:y9(vw),abortSignal:e.abortSignal,fetch:this.config.fetch});if("error"in v)throw Error(`${v.error.message}`);let w=v.choices[0];if(!w)throw Error("No choice in OpenRouter completion response");return{content:[{type:"text",text:null!=(t=w.text)?t:""}],finishReason:vo(w.finish_reason),usage:{inputTokens:null!=(a=null==(r=v.usage)?void 0:r.prompt_tokens)?a:0,outputTokens:null!=(n=null==(s=v.usage)?void 0:s.completion_tokens)?n:0,totalTokens:(null!=(o=null==(i=v.usage)?void 0:i.prompt_tokens)?o:0)+(null!=(u=null==(l=v.usage)?void 0:l.completion_tokens)?u:0),reasoningTokens:null!=(c=null==(p=null==(d=v.usage)?void 0:d.completion_tokens_details)?void 0:p.reasoning_tokens)?c:0,cachedInputTokens:null!=(g=null==(m=null==(h=v.usage)?void 0:h.prompt_tokens_details)?void 0:m.cached_tokens)?g:0},warnings:[],response:{headers:b}}}async doStream(e){let t=(e.providerOptions||{}).openrouter||{},r=f6(f6({},this.getArgs(e)),t),{value:a,responseHeaders:s}=await y4({url:this.config.url({path:"/completions",modelId:this.modelId}),headers:yV(this.config.headers(),e.headers),body:f1(f6({},r),f2({stream:!0,stream_options:"strict"===this.config.compatibility?{include_usage:!0}:void 0})),failedResponseHandler:vi,successfulResponseHandler:y3(vw),abortSignal:e.abortSignal,fetch:this.config.fetch}),n="other",i={inputTokens:NaN,outputTokens:NaN,totalTokens:NaN,reasoningTokens:NaN,cachedInputTokens:NaN},o={};return{stream:a.pipeThrough(new TransformStream({transform(e,t){var r,a;if(!e.success){n="error",t.enqueue({type:"error",error:e.error});return}let s=e.value;if("error"in s){n="error",t.enqueue({type:"error",error:s.error});return}if(null!=s.usage){if(i.inputTokens=s.usage.prompt_tokens,i.outputTokens=s.usage.completion_tokens,i.totalTokens=s.usage.prompt_tokens+s.usage.completion_tokens,o.promptTokens=s.usage.prompt_tokens,s.usage.prompt_tokens_details){let e=null!=(r=s.usage.prompt_tokens_details.cached_tokens)?r:0;i.cachedInputTokens=e,o.promptTokensDetails={cachedTokens:e}}if(o.completionTokens=s.usage.completion_tokens,s.usage.completion_tokens_details){let e=null!=(a=s.usage.completion_tokens_details.reasoning_tokens)?a:0;i.reasoningTokens=e,o.completionTokensDetails={reasoningTokens:e}}o.cost=s.usage.cost,o.totalTokens=s.usage.total_tokens}let l=s.choices[0];(null==l?void 0:l.finish_reason)!=null&&(n=vo(l.finish_reason)),(null==l?void 0:l.text)!=null&&t.enqueue({type:"text-delta",delta:l.text,id:yZ()})},flush(e){e.enqueue({type:"finish",finishReason:n,usage:i,providerMetadata:{openrouter:{usage:o}}})}})),response:{headers:s}}}};function vS(e={}){var t,r,a,s;let n=null!=(r=null==(s=null!=(t=e.baseURL)?t:e.baseUrl)?void 0:s.replace(/\/$/,""))?r:"https://openrouter.ai/api/v1",i=null!=(a=e.compatibility)?a:"compatible",o=()=>f6({Authorization:`Bearer ${function({apiKey:e,environmentVariableName:t,apiKeyParameterName:r="apiKey",description:a}){if("string"==typeof e)return e;if(null!=e)throw new yC({message:`${a} API key must be a string.`});if("undefined"==typeof process)throw new yC({message:`${a} API key is missing. Pass it using the '${r}' parameter. Environment variables is not supported in this environment.`});if(null==(e=process.env[t]))throw new yC({message:`${a} API key is missing. Pass it using the '${r}' parameter or the ${t} environment variable.`});if("string"!=typeof e)throw new yC({message:`${a} API key must be a string. The value of the ${t} environment variable is not a string.`});return e}({apiKey:e.apiKey,environmentVariableName:"OPENROUTER_API_KEY",description:"OpenRouter"})}`},e.headers),l=(t,r={})=>new vb(t,r,{provider:"openrouter.chat",url:({path:e})=>`${n}${e}`,headers:o,compatibility:i,fetch:e.fetch,extraBody:e.extraBody}),u=(t,r={})=>new v_(t,r,{provider:"openrouter.completion",url:({path:e})=>`${n}${e}`,headers:o,compatibility:i,fetch:e.fetch,extraBody:e.extraBody}),d=(e,t)=>{if(new.target)throw Error("The OpenRouter model function cannot be called with the new keyword.");return"openai/gpt-3.5-turbo-instruct"===e?u(e,t):l(e,t)},p=(e,t)=>d(e,t);return p.languageModel=d,p.chat=l,p.completion=u,p}function vx(e,t){if(t&&!e.startsWith(`${t}/`))throw Error(`Expected ${t}/ in model router ID ${e}`);let r=e.split("/");if(t&&r.length<3)throw Error(`Expected atleast 3 id parts ${t}/provider/model, but only saw ${r.length} in ${e}`);let a=r.at(+!!t),s=r.slice(t?2:1).join("/");if(!e.includes("/")||!a||!s)throw Error(`Attempted to parse provider/model from ${e} but this ID doesn't appear to contain a provider`);return{providerId:a,modelId:s}}vS({compatibility:"strict"});var vI=class{},vk=["anthropic","google","openai","openrouter","xai"],vT=["github-copilot"],vE={cerebras:{url:"https://api.cerebras.ai/v1"},mistral:{url:"https://api.mistral.ai/v1"},groq:{url:"https://api.groq.com/openai/v1"},togetherai:{url:"https://api.together.xyz/v1"},deepinfra:{url:"https://api.deepinfra.com/v1/openai"},perplexity:{url:"https://api.perplexity.ai"},vercel:{url:"https://ai-gateway.vercel.sh/v1",apiKeyEnvVar:"AI_GATEWAY_API_KEY"}},vA=class extends vI{name="models.dev";prefix=void 0;providerConfigs={};constructor(e){super(),e&&(this.providerConfigs=e)}async fetchProviders(){console.info("Fetching providers from models.dev API...");let e=await fetch("https://models.dev/api.json");if(!e.ok)throw Error(`Failed to fetch from models.dev: ${e.statusText}`);let t=await e.json(),r={};for(let[e,a]of Object.entries(t)){if(vT.includes(e)||!a||"object"!=typeof a||!a.models)continue;let t="@ai-sdk/openai-compatible"===a.npm||"@ai-sdk/gateway"===a.npm||e in vE,s=vk.includes(e),n=a.api&&a.env&&a.env.length>0;if(t||s||n){let t=Object.keys(a.models).sort(),n=a.api||vE[e]?.url;if(!s&&!n){console.info(`Skipping ${e}: No API URL available`);continue}let i=a.env?.[0]||`${e.toUpperCase().replace(/-/g,"_")}_API_KEY`,o=s?void 0:vE[e]?.apiKeyHeader||"Authorization";r[e]={url:n,apiKeyEnvVar:i,apiKeyHeader:o,name:a.name||e.charAt(0).toUpperCase()+e.slice(1),models:t,docUrl:a.doc,gateway:"models.dev"}}else console.info(`Skipped provider ${a.name}`)}return this.providerConfigs=r,console.info(`Found ${Object.keys(r).length} OpenAI-compatible providers`),console.info("Providers:",Object.keys(r).sort()),r}buildUrl(e,t){let{providerId:r}=vx(e),a=this.providerConfigs[r];if(!a?.url)return;let s=`${r.toUpperCase().replace(/-/g,"_")}_BASE_URL`;return t?.[s]||process.env[s]||a.url}getApiKey(e){let[t,r]=e.split("/");if(!t||!r)throw Error(`Could not identify provider from model id ${e}`);let a=this.providerConfigs[t];if(!a)throw Error(`Could not find config for provider ${t} with model id ${e}`);let s="string"==typeof a.apiKeyEnvVar?process.env[a.apiKeyEnvVar]:void 0;if(!s)throw Error(`Could not find API key process.env.${a.apiKeyEnvVar} for model id ${e}`);return Promise.resolve(s)}async resolveLanguageModel({modelId:e,providerId:t,apiKey:r}){let a=this.buildUrl(`${t}/${e}`);switch(t){case"openai":return fM({apiKey:r}).responses(e);case"gemini":case"google":return m3({apiKey:r}).chat(e);case"anthropic":return mM({apiKey:r})(e);case"openrouter":return vS({apiKey:r})(e);case"xai":return fX({apiKey:r})(e);default:if(!a)throw Error(`No API URL found for ${t}/${e}`);return gy({name:t,apiKey:r,baseURL:a}).chatModel(e)}}};function vO(e,t){let r=t.find(t=>t.prefix&&e.startsWith(`${t.prefix}/`));if(r)return r;for(let e of t.filter(e=>!e.prefix))return e;throw new tv({id:"MODEL_ROUTER_NO_GATEWAY_FOUND",category:"USER",domain:"MODEL_ROUTER",text:`No Mastra model router gateway found for model id ${e}`})}var vC=[new class extends vI{name="netlify";prefix="netlify";tokenCache=new cp;async fetchProviders(){console.info("Fetching providers from Netlify AI Gateway...");let e=await fetch("https://api.netlify.com/api/v1/ai-gateway/providers");if(!e.ok)throw Error(`Failed to fetch from Netlify: ${e.statusText}`);let t=await e.json(),r={apiKeyEnvVar:["NETLIFY_TOKEN","NETLIFY_SITE_ID"],apiKeyHeader:"Authorization",name:"Netlify",gateway:"netlify",models:[],docUrl:"https://docs.netlify.com/build/ai-gateway/overview/"};for(let[e,a]of Object.entries(t.providers))for(let t of a.models)r.models.push(`${e}/${t}`);return console.info(`Found ${Object.keys(t.providers).length} models via Netlify Gateway`),{netlify:r}}async buildUrl(e,t){let r=t?.NETLIFY_SITE_ID||process.env.NETLIFY_SITE_ID,a=t?.NETLIFY_TOKEN||process.env.NETLIFY_TOKEN;if(!a)throw new tv({id:"NETLIFY_GATEWAY_NO_TOKEN",domain:"LLM",category:"UNKNOWN",text:`Missing NETLIFY_TOKEN environment variable required for model: ${e}`});if(!r)throw new tv({id:"NETLIFY_GATEWAY_NO_SITE_ID",domain:"LLM",category:"UNKNOWN",text:`Missing NETLIFY_SITE_ID environment variable required for model: ${e}`});try{let e=await this.getOrFetchToken(r,a);return e.url.endsWith("/")?e.url.substring(0,e.url.length-1):e.url}catch(t){throw new tv({id:"NETLIFY_GATEWAY_TOKEN_ERROR",domain:"LLM",category:"UNKNOWN",text:`Failed to get Netlify AI Gateway token for model ${e}: ${t instanceof Error?t.message:String(t)}`})}}async getOrFetchToken(e,t){let r=`netlify-token:${e}:${t}`,a=await this.tokenCache.get(r);if(a&&a.expiresAt>Date.now()/1e3+60)return{token:a.token,url:a.url};let s=await fetch(`https://api.netlify.com/api/v1/sites/${e}/ai-gateway/token`,{method:"GET",headers:{Authorization:`Bearer ${t}`}});if(!s.ok){let e=await s.text();throw Error(`Failed to get Netlify AI Gateway token: ${s.status} ${e}`)}let n=await s.json();return await this.tokenCache.set(r,{token:n.token,url:n.url,expiresAt:n.expires_at}),{token:n.token,url:n.url}}async getApiKey(e){let t=process.env.NETLIFY_SITE_ID,r=process.env.NETLIFY_TOKEN;if(!r)throw new tv({id:"NETLIFY_GATEWAY_NO_TOKEN",domain:"LLM",category:"UNKNOWN",text:`Missing NETLIFY_TOKEN environment variable required for model: ${e}`});if(!t)throw new tv({id:"NETLIFY_GATEWAY_NO_SITE_ID",domain:"LLM",category:"UNKNOWN",text:`Missing NETLIFY_SITE_ID environment variable required for model: ${e}`});try{return(await this.getOrFetchToken(t,r)).token}catch(t){throw new tv({id:"NETLIFY_GATEWAY_TOKEN_ERROR",domain:"LLM",category:"UNKNOWN",text:`Failed to get Netlify AI Gateway token for model ${e}: ${t instanceof Error?t.message:String(t)}`})}}async resolveLanguageModel({modelId:e,providerId:t,apiKey:r}){let a=await this.buildUrl(`${t}/${e}`);switch(t){case"openai":return fM({apiKey:r,baseURL:a}).responses(e);case"gemini":return m3({baseURL:`${a}/v1beta/`,apiKey:r,headers:{"user-agent":"google-genai-sdk/"}}).chat(e);case"anthropic":return mM({apiKey:r,baseURL:`${a}/v1/`,headers:{"anthropic-version":"2023-06-01","user-agent":"anthropic/"}})(e);default:return gy({name:t,apiKey:r,baseURL:a}).chatModel(e)}}},new vA(Object.fromEntries(Object.entries({"moonshotai-cn":{url:"https://api.moonshot.cn/v1",apiKeyEnvVar:"MOONSHOT_API_KEY",apiKeyHeader:"Authorization",name:"Moonshot AI (China)",models:["kimi-k2-0711-preview","kimi-k2-0905-preview","kimi-k2-turbo-preview"],docUrl:"https://platform.moonshot.cn/docs/api/chat",gateway:"models.dev"},lucidquery:{url:"https://lucidquery.com/api/v1",apiKeyEnvVar:"LUCIDQUERY_API_KEY",apiKeyHeader:"Authorization",name:"LucidQuery AI",models:["lucidnova-rf1-100b","lucidquery-nexus-coder"],docUrl:"https://lucidquery.com/api/docs",gateway:"models.dev"},moonshotai:{url:"https://api.moonshot.ai/v1",apiKeyEnvVar:"MOONSHOT_API_KEY",apiKeyHeader:"Authorization",name:"Moonshot AI",models:["kimi-k2-0711-preview","kimi-k2-0905-preview","kimi-k2-turbo-preview"],docUrl:"https://platform.moonshot.ai/docs/api/chat",gateway:"models.dev"},"zai-coding-plan":{url:"https://api.z.ai/api/coding/paas/v4",apiKeyEnvVar:"ZHIPU_API_KEY",apiKeyHeader:"Authorization",name:"Z.AI Coding Plan",models:["glm-4.5","glm-4.5-air","glm-4.5-flash","glm-4.5v","glm-4.6"],docUrl:"https://docs.z.ai/devpack/overview",gateway:"models.dev"},alibaba:{url:"https://dashscope-intl.aliyuncs.com/compatible-mode/v1",apiKeyEnvVar:"DASHSCOPE_API_KEY",apiKeyHeader:"Authorization",name:"Alibaba",models:["qwen3-coder-plus"],docUrl:"https://www.alibabacloud.com/help/en/model-studio/models",gateway:"models.dev"},xai:{apiKeyEnvVar:"XAI_API_KEY",name:"xAI",models:["grok-2","grok-2-1212","grok-2-latest","grok-2-vision","grok-2-vision-1212","grok-2-vision-latest","grok-3","grok-3-fast","grok-3-fast-latest","grok-3-latest","grok-3-mini","grok-3-mini-fast","grok-3-mini-fast-latest","grok-3-mini-latest","grok-4","grok-4-fast","grok-4-fast-non-reasoning","grok-beta","grok-code-fast-1","grok-vision-beta"],docUrl:"https://docs.x.ai/docs/models",gateway:"models.dev"},nvidia:{url:"https://integrate.api.nvidia.com/v1",apiKeyEnvVar:"NVIDIA_API_KEY",apiKeyHeader:"Authorization",name:"Nvidia",models:["black-forest-labs/flux.1-dev","deepseek-ai/deepseek-v3.1","google/gemma-3-27b-it","microsoft/phi-4-mini-instruct","moonshotai/kimi-k2-instruct","nvidia/cosmos-nemotron-34b","nvidia/llama-3.1-nemotron-ultra-253b-v1","nvidia/nemoretriever-ocr-v1","nvidia/parakeet-tdt-0.6b-v2","openai/gpt-oss-120b","openai/whisper-large-v3","qwen/qwen3-235b-a22b","qwen/qwen3-coder-480b-a35b-instruct"],docUrl:"https://docs.api.nvidia.com/nim/",gateway:"models.dev"},upstage:{url:"https://api.upstage.ai",apiKeyEnvVar:"UPSTAGE_API_KEY",apiKeyHeader:"Authorization",name:"Upstage",models:["solar-mini","solar-pro2"],docUrl:"https://developers.upstage.ai/docs/apis/chat",gateway:"models.dev"},groq:{url:"https://api.groq.com/openai/v1",apiKeyEnvVar:"GROQ_API_KEY",apiKeyHeader:"Authorization",name:"Groq",models:["deepseek-r1-distill-llama-70b","gemma2-9b-it","llama-3.1-8b-instant","llama-3.3-70b-versatile","llama-guard-3-8b","llama3-70b-8192","llama3-8b-8192","meta-llama/llama-4-maverick-17b-128e-instruct","meta-llama/llama-4-scout-17b-16e-instruct","meta-llama/llama-guard-4-12b","mistral-saba-24b","moonshotai/kimi-k2-instruct","moonshotai/kimi-k2-instruct-0905","openai/gpt-oss-120b","openai/gpt-oss-20b","qwen-qwq-32b","qwen/qwen3-32b"],docUrl:"https://console.groq.com/docs/models",gateway:"models.dev"},mistral:{url:"https://api.mistral.ai/v1",apiKeyEnvVar:"MISTRAL_API_KEY",apiKeyHeader:"Authorization",name:"Mistral",models:["codestral-latest","devstral-medium-2507","devstral-small-2505","devstral-small-2507","magistral-medium-latest","magistral-small","ministral-3b-latest","ministral-8b-latest","mistral-large-latest","mistral-medium-2505","mistral-medium-2508","mistral-medium-latest","mistral-nemo","mistral-small-latest","open-mistral-7b","open-mixtral-8x22b","open-mixtral-8x7b","pixtral-12b","pixtral-large-latest"],docUrl:"https://docs.mistral.ai/getting-started/models/",gateway:"models.dev"},vercel:{url:"https://ai-gateway.vercel.sh/v1",apiKeyEnvVar:"AI_GATEWAY_API_KEY",apiKeyHeader:"Authorization",name:"Vercel AI Gateway",models:["amazon/nova-lite","amazon/nova-micro","amazon/nova-pro","anthropic/claude-3-5-haiku","anthropic/claude-3-haiku","anthropic/claude-3-opus","anthropic/claude-3.5-sonnet","anthropic/claude-3.7-sonnet","anthropic/claude-4-1-opus","anthropic/claude-4-opus","anthropic/claude-4-sonnet","anthropic/claude-4.5-sonnet","cerebras/qwen3-coder","deepseek/deepseek-r1","deepseek/deepseek-r1-distill-llama-70b","google/gemini-2.0-flash","google/gemini-2.0-flash-lite","google/gemini-2.5-flash","google/gemini-2.5-pro","meta/llama-3.3-70b","meta/llama-4-maverick","meta/llama-4-scout","mistral/codestral","mistral/magistral-medium","mistral/magistral-small","mistral/ministral-3b","mistral/ministral-8b","mistral/mistral-large","mistral/mistral-small","mistral/mixtral-8x22b-instruct","mistral/pixtral-12b","mistral/pixtral-large","moonshotai/kimi-k2","morph/morph-v3-fast","morph/morph-v3-large","openai/gpt-4-turbo","openai/gpt-4.1","openai/gpt-4.1-mini","openai/gpt-4.1-nano","openai/gpt-4o","openai/gpt-4o-mini","openai/gpt-5","openai/gpt-5-codex","openai/gpt-5-mini","openai/gpt-5-nano","openai/gpt-oss-120b","openai/gpt-oss-20b","openai/o1","openai/o3","openai/o3-mini","openai/o4-mini","vercel/v0-1.0-md","vercel/v0-1.5-md","xai/grok-2","xai/grok-2-vision","xai/grok-3","xai/grok-3-fast","xai/grok-3-mini","xai/grok-3-mini-fast","xai/grok-4","xai/grok-4-fast","xai/grok-4-fast-non-reasoning","xai/grok-code-fast-1"],docUrl:"https://github.com/vercel/ai/tree/5eb85cc45a259553501f535b8ac79a77d0e79223/packages/gateway",gateway:"models.dev"},deepseek:{url:"https://api.deepseek.com",apiKeyEnvVar:"DEEPSEEK_API_KEY",apiKeyHeader:"Authorization",name:"DeepSeek",models:["deepseek-chat","deepseek-reasoner"],docUrl:"https://platform.deepseek.com/api-docs/pricing",gateway:"models.dev"},"alibaba-cn":{url:"https://dashscope.aliyuncs.com/compatible-mode/v1",apiKeyEnvVar:"DASHSCOPE_API_KEY",apiKeyHeader:"Authorization",name:"Alibaba (China)",models:["qwen3-coder-plus"],docUrl:"https://www.alibabacloud.com/help/en/model-studio/models",gateway:"models.dev"},venice:{url:"https://api.venice.ai/api/v1",apiKeyEnvVar:"VENICE_API_KEY",apiKeyHeader:"Authorization",name:"Venice AI",models:["deepseek-coder-v2-lite","deepseek-r1-671b","dolphin-2.9.2-qwen2-72b","llama-3.1-405b","llama-3.2-3b","llama-3.3-70b","mistral-31-24b","qwen-2.5-coder-32b","qwen-2.5-qwq-32b","qwen-2.5-vl","qwen3-235b","qwen3-4b","venice-uncensored"],docUrl:"https://docs.venice.ai",gateway:"models.dev"},chutes:{url:"https://llm.chutes.ai/v1",apiKeyEnvVar:"CHUTES_API_KEY",apiKeyHeader:"Authorization",name:"Chutes",models:["Qwen/Qwen3-235B-A22B-Instruct-2507","Qwen/Qwen3-235B-A22B-Thinking-2507","Qwen/Qwen3-30B-A3B","Qwen/Qwen3-30B-A3B-Instruct-2507","Qwen/Qwen3-30B-A3B-Thinking-2507","Qwen/Qwen3-Coder-30B-A3B-Instruct","Qwen/Qwen3-Coder-480B-A35B-Instruct-FP8","Qwen/Qwen3-Next-80B-A3B-Instruct","Qwen/Qwen3-Next-80B-A3B-Thinking","chutesai/Devstral-Small-2505","chutesai/Mistral-Small-3.2-24B-Instruct-2506","deepseek-ai/DeepSeek-R1-0528","deepseek-ai/DeepSeek-R1-0528-Qwen3-8B","deepseek-ai/DeepSeek-R1-Distill-Llama-70B","deepseek-ai/DeepSeek-V3-0324","deepseek-ai/DeepSeek-V3.1","deepseek-ai/DeepSeek-V3.1-Terminus","deepseek-ai/DeepSeek-V3.1-turbo","deepseek-ai/DeepSeek-V3.1:THINKING","meituan-longcat/LongCat-Flash-Chat-FP8","moonshotai/Kimi-Dev-72B","moonshotai/Kimi-K2-Instruct-0905","moonshotai/Kimi-K2-Instruct-75k","moonshotai/Kimi-VL-A3B-Thinking","openai/gpt-oss-120b","tngtech/DeepSeek-R1T-Chimera","tngtech/DeepSeek-TNG-R1T2-Chimera","zai-org/GLM-4.5-Air","zai-org/GLM-4.5-FP8","zai-org/GLM-4.5-turbo","zai-org/GLM-4.6-FP8"],docUrl:"https://llm.chutes.ai/v1/models",gateway:"models.dev"},cortecs:{url:"https://api.cortecs.ai/v1",apiKeyEnvVar:"CORTECS_API_KEY",apiKeyHeader:"Authorization",name:"Cortecs",models:["claude-sonnet-4","deepseek-v3-0324","gemini-2.5-pro","gpt-4.1","gpt-oss-120b","kimi-k2-instruct","llama-3.1-405b-instruct","nova-pro-v1","qwen3-32b","qwen3-coder-480b-a35b-instruct"],docUrl:"https://api.cortecs.ai/v1/models",gateway:"models.dev"},"github-models":{url:"https://models.github.ai/inference",apiKeyEnvVar:"GITHUB_TOKEN",apiKeyHeader:"Authorization",name:"GitHub Models",models:["ai21-labs/ai21-jamba-1.5-large","ai21-labs/ai21-jamba-1.5-mini","cohere/cohere-command-a","cohere/cohere-command-r","cohere/cohere-command-r-08-2024","cohere/cohere-command-r-plus","cohere/cohere-command-r-plus-08-2024","core42/jais-30b-chat","deepseek/deepseek-r1","deepseek/deepseek-r1-0528","deepseek/deepseek-v3-0324","meta/llama-3.2-11b-vision-instruct","meta/llama-3.2-90b-vision-instruct","meta/llama-3.3-70b-instruct","meta/llama-4-maverick-17b-128e-instruct-fp8","meta/llama-4-scout-17b-16e-instruct","meta/meta-llama-3-70b-instruct","meta/meta-llama-3-8b-instruct","meta/meta-llama-3.1-405b-instruct","meta/meta-llama-3.1-70b-instruct","meta/meta-llama-3.1-8b-instruct","microsoft/mai-ds-r1","microsoft/phi-3-medium-128k-instruct","microsoft/phi-3-medium-4k-instruct","microsoft/phi-3-mini-128k-instruct","microsoft/phi-3-mini-4k-instruct","microsoft/phi-3-small-128k-instruct","microsoft/phi-3-small-8k-instruct","microsoft/phi-3.5-mini-instruct","microsoft/phi-3.5-moe-instruct","microsoft/phi-3.5-vision-instruct","microsoft/phi-4","microsoft/phi-4-mini-instruct","microsoft/phi-4-mini-reasoning","microsoft/phi-4-multimodal-instruct","microsoft/phi-4-reasoning","mistral-ai/codestral-2501","mistral-ai/ministral-3b","mistral-ai/mistral-large-2411","mistral-ai/mistral-medium-2505","mistral-ai/mistral-nemo","mistral-ai/mistral-small-2503","openai/gpt-4.1","openai/gpt-4.1-mini","openai/gpt-4.1-nano","openai/gpt-4o","openai/gpt-4o-mini","openai/o1","openai/o1-mini","openai/o1-preview","openai/o3","openai/o3-mini","openai/o4-mini","xai/grok-3","xai/grok-3-mini"],docUrl:"https://docs.github.com/en/github-models",gateway:"models.dev"},togetherai:{url:"https://api.together.xyz/v1",apiKeyEnvVar:"TOGETHER_API_KEY",apiKeyHeader:"Authorization",name:"Together AI",models:["Qwen/Qwen3-Coder-480B-A35B-Instruct-FP8","deepseek-ai/DeepSeek-R1","deepseek-ai/DeepSeek-V3","meta-llama/Llama-3.3-70B-Instruct-Turbo","moonshotai/Kimi-K2-Instruct","openai/gpt-oss-120b"],docUrl:"https://docs.together.ai/docs/serverless-models",gateway:"models.dev"},baseten:{url:"https://inference.baseten.co/v1",apiKeyEnvVar:"BASETEN_API_KEY",apiKeyHeader:"Authorization",name:"Baseten",models:["Qwen3/Qwen3-Coder-480B-A35B-Instruct","moonshotai/Kimi-K2-Instruct-0905"],docUrl:"https://docs.baseten.co/development/model-apis/overview",gateway:"models.dev"},huggingface:{url:"https://router.huggingface.co/v1",apiKeyEnvVar:"HF_TOKEN",apiKeyHeader:"Authorization",name:"Hugging Face",models:["Qwen/Qwen3-235B-A22B-Thinking-2507","Qwen/Qwen3-Coder-480B-A35B-Instruct","Qwen/Qwen3-Next-80B-A3B-Instruct","Qwen/Qwen3-Next-80B-A3B-Thinking","deepseek-ai/DeepSeek-R1-0528","deepseek-ai/Deepseek-V3-0324","moonshotai/Kimi-K2-Instruct","moonshotai/Kimi-K2-Instruct-0905","zai-org/GLM-4.5","zai-org/GLM-4.5-Air","zai-org/GLM-4.6"],docUrl:"https://huggingface.co/docs/inference-providers",gateway:"models.dev"},opencode:{url:"https://opencode.ai/zen/v1",apiKeyEnvVar:"OPENCODE_API_KEY",apiKeyHeader:"Authorization",name:"OpenCode Zen",models:["claude-3-5-haiku","claude-opus-4-1","claude-sonnet-4","claude-sonnet-4-5","code-supernova","glm-4.6","gpt-5","gpt-5-codex","grok-code","kimi-k2","qwen3-coder","qwen3-max"],docUrl:"https://opencode.ai/docs/zen",gateway:"models.dev"},fastrouter:{url:"https://go.fastrouter.ai/api/v1",apiKeyEnvVar:"FASTROUTER_API_KEY",apiKeyHeader:"Authorization",name:"FastRouter",models:["anthropic/claude-opus-4.1","anthropic/claude-sonnet-4","deepseek-ai/deepseek-r1-distill-llama-70b","google/gemini-2.5-flash","google/gemini-2.5-pro","moonshotai/kimi-k2","openai/gpt-4.1","openai/gpt-5","openai/gpt-5-mini","openai/gpt-5-nano","openai/gpt-oss-120b","openai/gpt-oss-20b","qwen/qwen3-coder","x-ai/grok-4"],docUrl:"https://fastrouter.ai/models",gateway:"models.dev"},google:{apiKeyEnvVar:"GOOGLE_GENERATIVE_AI_API_KEY",name:"Google",models:["gemini-1.5-flash","gemini-1.5-flash-8b","gemini-1.5-pro","gemini-2.0-flash","gemini-2.0-flash-lite","gemini-2.5-flash","gemini-2.5-flash-lite","gemini-2.5-flash-lite-preview-06-17","gemini-2.5-flash-lite-preview-09-2025","gemini-2.5-flash-preview-04-17","gemini-2.5-flash-preview-05-20","gemini-2.5-flash-preview-09-2025","gemini-2.5-pro","gemini-2.5-pro-preview-05-06","gemini-2.5-pro-preview-06-05","gemini-flash-latest","gemini-flash-lite-latest","gemini-live-2.5-flash-preview-native-audio"],docUrl:"https://ai.google.dev/gemini-api/docs/pricing",gateway:"models.dev"},inception:{url:"https://api.inceptionlabs.ai/v1/",apiKeyEnvVar:"INCEPTION_API_KEY",apiKeyHeader:"Authorization",name:"Inception",models:["mercury","mercury-coder"],docUrl:"https://platform.inceptionlabs.ai/docs",gateway:"models.dev"},wandb:{url:"https://api.inference.wandb.ai/v1",apiKeyEnvVar:"WANDB_API_KEY",apiKeyHeader:"Authorization",name:"Weights & Biases",models:["Qwen/Qwen3-235B-A22B-Instruct-2507","Qwen/Qwen3-235B-A22B-Thinking-2507","Qwen/Qwen3-Coder-480B-A35B-Instruct","deepseek-ai/DeepSeek-R1-0528","deepseek-ai/DeepSeek-V3-0324","meta-llama/Llama-3.1-8B-Instruct","meta-llama/Llama-3.3-70B-Instruct","meta-llama/Llama-4-Scout-17B-16E-Instruct","microsoft/Phi-4-mini-instruct","moonshotai/Kimi-K2-Instruct"],docUrl:"https://weave-docs.wandb.ai/guides/integrations/inference/",gateway:"models.dev"},openai:{apiKeyEnvVar:"OPENAI_API_KEY",name:"OpenAI",models:["codex-mini-latest","gpt-3.5-turbo","gpt-4","gpt-4-turbo","gpt-4.1","gpt-4.1-mini","gpt-4.1-nano","gpt-4o","gpt-4o-2024-05-13","gpt-4o-2024-08-06","gpt-4o-2024-11-20","gpt-4o-mini","gpt-5","gpt-5-chat-latest","gpt-5-codex","gpt-5-mini","gpt-5-nano","o1","o1-mini","o1-preview","o1-pro","o3","o3-deep-research","o3-mini","o3-pro","o4-mini","o4-mini-deep-research"],docUrl:"https://platform.openai.com/docs/models",gateway:"models.dev"},"zhipuai-coding-plan":{url:"https://open.bigmodel.cn/api/coding/paas/v4",apiKeyEnvVar:"ZHIPU_API_KEY",apiKeyHeader:"Authorization",name:"Zhipu AI Coding Plan",models:["glm-4.5","glm-4.5-air","glm-4.5-flash","glm-4.5v","glm-4.6"],docUrl:"https://docs.bigmodel.cn/cn/coding-plan/overview",gateway:"models.dev"},perplexity:{url:"https://api.perplexity.ai",apiKeyEnvVar:"PERPLEXITY_API_KEY",apiKeyHeader:"Authorization",name:"Perplexity",models:["sonar","sonar-pro","sonar-reasoning","sonar-reasoning-pro"],docUrl:"https://docs.perplexity.ai",gateway:"models.dev"},openrouter:{url:"https://openrouter.ai/api/v1",apiKeyEnvVar:"OPENROUTER_API_KEY",name:"OpenRouter",models:["anthropic/claude-3.5-haiku","anthropic/claude-3.7-sonnet","anthropic/claude-opus-4","anthropic/claude-opus-4.1","anthropic/claude-sonnet-4","anthropic/claude-sonnet-4.5","cognitivecomputations/dolphin3.0-mistral-24b","cognitivecomputations/dolphin3.0-r1-mistral-24b","deepseek/deepseek-chat-v3-0324","deepseek/deepseek-chat-v3.1","deepseek/deepseek-r1-0528-qwen3-8b:free","deepseek/deepseek-r1-0528:free","deepseek/deepseek-r1-distill-llama-70b","deepseek/deepseek-r1-distill-qwen-14b","deepseek/deepseek-r1:free","deepseek/deepseek-v3-base:free","deepseek/deepseek-v3.1-terminus","featherless/qwerky-72b","google/gemini-2.0-flash-001","google/gemini-2.0-flash-exp:free","google/gemini-2.5-flash","google/gemini-2.5-pro","google/gemini-2.5-pro-preview-05-06","google/gemini-2.5-pro-preview-06-05","google/gemma-2-9b-it:free","google/gemma-3-12b-it","google/gemma-3-27b-it","google/gemma-3n-e4b-it","google/gemma-3n-e4b-it:free","meta-llama/llama-3.2-11b-vision-instruct","meta-llama/llama-3.3-70b-instruct:free","meta-llama/llama-4-scout:free","microsoft/mai-ds-r1:free","mistralai/codestral-2508","mistralai/devstral-medium-2507","mistralai/devstral-small-2505","mistralai/devstral-small-2505:free","mistralai/devstral-small-2507","mistralai/mistral-7b-instruct:free","mistralai/mistral-medium-3","mistralai/mistral-medium-3.1","mistralai/mistral-nemo:free","mistralai/mistral-small-3.1-24b-instruct","mistralai/mistral-small-3.2-24b-instruct","mistralai/mistral-small-3.2-24b-instruct:free","moonshotai/kimi-dev-72b:free","moonshotai/kimi-k2","moonshotai/kimi-k2-0905","moonshotai/kimi-k2:free","nousresearch/deephermes-3-llama-3-8b-preview","nousresearch/hermes-4-405b","nousresearch/hermes-4-70b","openai/gpt-4.1","openai/gpt-4.1-mini","openai/gpt-4o-mini","openai/gpt-5","openai/gpt-5-chat","openai/gpt-5-codex","openai/gpt-5-mini","openai/gpt-5-nano","openai/gpt-oss-120b","openai/gpt-oss-20b","openai/o4-mini","openrouter/cypher-alpha:free","openrouter/horizon-alpha","openrouter/horizon-beta","openrouter/sonoma-dusk-alpha","openrouter/sonoma-sky-alpha","qwen/qwen-2.5-coder-32b-instruct","qwen/qwen2.5-vl-32b-instruct:free","qwen/qwen2.5-vl-72b-instruct","qwen/qwen2.5-vl-72b-instruct:free","qwen/qwen3-14b:free","qwen/qwen3-235b-a22b-07-25","qwen/qwen3-235b-a22b-07-25:free","qwen/qwen3-235b-a22b-thinking-2507","qwen/qwen3-235b-a22b:free","qwen/qwen3-30b-a3b-instruct-2507","qwen/qwen3-30b-a3b:free","qwen/qwen3-32b:free","qwen/qwen3-8b:free","qwen/qwen3-coder","qwen/qwen3-coder:free","qwen/qwen3-max","qwen/qwen3-next-80b-a3b-instruct","qwen/qwq-32b:free","rekaai/reka-flash-3","sarvamai/sarvam-m:free","thudm/glm-z1-32b:free","tngtech/deepseek-r1t2-chimera:free","x-ai/grok-3","x-ai/grok-3-beta","x-ai/grok-3-mini","x-ai/grok-3-mini-beta","x-ai/grok-4","x-ai/grok-4-fast","x-ai/grok-4-fast:free","x-ai/grok-code-fast-1","z-ai/glm-4.5","z-ai/glm-4.5-air","z-ai/glm-4.5-air:free","z-ai/glm-4.5v","z-ai/glm-4.6"],docUrl:"https://openrouter.ai/models",gateway:"models.dev"},synthetic:{url:"https://api.synthetic.new/v1",apiKeyEnvVar:"SYNTHETIC_API_KEY",apiKeyHeader:"Authorization",name:"Synthetic",models:["hf:Qwen/Qwen2.5-Coder-32B-Instruct","hf:Qwen/Qwen3-235B-A22B-Instruct-2507","hf:Qwen/Qwen3-235B-A22B-Thinking-2507","hf:Qwen/Qwen3-Coder-480B-A35B-Instruct","hf:deepseek-ai/DeepSeek-R1","hf:deepseek-ai/DeepSeek-R1-0528","hf:deepseek-ai/DeepSeek-V3","hf:deepseek-ai/DeepSeek-V3-0324","hf:deepseek-ai/DeepSeek-V3.1","hf:deepseek-ai/DeepSeek-V3.1-Terminus","hf:meta-llama/Llama-3.1-405B-Instruct","hf:meta-llama/Llama-3.1-70B-Instruct","hf:meta-llama/Llama-3.1-8B-Instruct","hf:meta-llama/Llama-3.3-70B-Instruct","hf:meta-llama/Llama-4-Maverick-17B-128E-Instruct-FP8","hf:meta-llama/Llama-4-Scout-17B-16E-Instruct","hf:moonshotai/Kimi-K2-Instruct","hf:moonshotai/Kimi-K2-Instruct-0905","hf:openai/gpt-oss-120b","hf:zai-org/GLM-4.5","hf:zai-org/GLM-4.6"],docUrl:"https://synthetic.new/pricing",gateway:"models.dev"},deepinfra:{url:"https://api.deepinfra.com/v1/openai",apiKeyEnvVar:"DEEPINFRA_API_KEY",apiKeyHeader:"Authorization",name:"Deep Infra",models:["Qwen/Qwen3-Coder-480B-A35B-Instruct","Qwen/Qwen3-Coder-480B-A35B-Instruct-Turbo","moonshotai/Kimi-K2-Instruct","zai-org/GLM-4.5"],docUrl:"https://deepinfra.com/models",gateway:"models.dev"},zhipuai:{url:"https://open.bigmodel.cn/api/paas/v4",apiKeyEnvVar:"ZHIPU_API_KEY",apiKeyHeader:"Authorization",name:"Zhipu AI",models:["glm-4.5","glm-4.5-air","glm-4.5-flash","glm-4.5v","glm-4.6"],docUrl:"https://docs.z.ai/guides/overview/pricing",gateway:"models.dev"},submodel:{url:"https://llm.submodel.ai/v1",apiKeyEnvVar:"SUBMODEL_INSTAGEN_ACCESS_KEY",apiKeyHeader:"Authorization",name:"submodel",models:["Qwen/Qwen3-235B-A22B-Instruct-2507","Qwen/Qwen3-235B-A22B-Thinking-2507","Qwen/Qwen3-Coder-480B-A35B-Instruct-FP8","deepseek-ai/DeepSeek-R1-0528","deepseek-ai/DeepSeek-V3-0324","deepseek-ai/DeepSeek-V3.1","openai/gpt-oss-120b","zai-org/GLM-4.5-Air","zai-org/GLM-4.5-FP8"],docUrl:"https://submodel.gitbook.io",gateway:"models.dev"},zai:{url:"https://api.z.ai/api/paas/v4",apiKeyEnvVar:"ZHIPU_API_KEY",apiKeyHeader:"Authorization",name:"Z.AI",models:["glm-4.5","glm-4.5-air","glm-4.5-flash","glm-4.5v","glm-4.6"],docUrl:"https://docs.z.ai/guides/overview/pricing",gateway:"models.dev"},inference:{url:"https://inference.net/v1",apiKeyEnvVar:"INFERENCE_API_KEY",apiKeyHeader:"Authorization",name:"Inference",models:["google/gemma-3","meta/llama-3.1-8b-instruct","meta/llama-3.2-11b-vision-instruct","meta/llama-3.2-1b-instruct","meta/llama-3.2-3b-instruct","mistral/mistral-nemo-12b-instruct","osmosis/osmosis-structure-0.6b","qwen/qwen-2.5-7b-vision-instruct","qwen/qwen3-embedding-4b"],docUrl:"https://inference.net/models",gateway:"models.dev"},requesty:{url:"https://router.requesty.ai/v1",apiKeyEnvVar:"REQUESTY_API_KEY",apiKeyHeader:"Authorization",name:"Requesty",models:["anthropic/claude-3-7-sonnet","anthropic/claude-4-sonnet-20250522","anthropic/claude-opus-4","anthropic/claude-opus-4-1-20250805","google/gemini-2.5-flash","google/gemini-2.5-pro","openai/gpt-4.1","openai/gpt-4.1-mini","openai/gpt-4o-mini","openai/gpt-5","openai/gpt-5-mini","openai/gpt-5-nano","openai/o4-mini"],docUrl:"https://requesty.ai/solution/llm-routing/models",gateway:"models.dev"},morph:{url:"https://api.morphllm.com/v1",apiKeyEnvVar:"MORPH_API_KEY",apiKeyHeader:"Authorization",name:"Morph",models:["auto","morph-v3-fast","morph-v3-large"],docUrl:"https://docs.morphllm.com/api-reference/introduction",gateway:"models.dev"},lmstudio:{url:"http://127.0.0.1:1234/v1",apiKeyEnvVar:"LMSTUDIO_API_KEY",apiKeyHeader:"Authorization",name:"LMStudio",models:["openai/gpt-oss-20b","qwen/qwen3-30b-a3b-2507","qwen/qwen3-coder-30b"],docUrl:"https://lmstudio.ai/models",gateway:"models.dev"},anthropic:{apiKeyEnvVar:"ANTHROPIC_API_KEY",name:"Anthropic",models:["claude-3-5-haiku-20241022","claude-3-5-sonnet-20240620","claude-3-5-sonnet-20241022","claude-3-7-sonnet-20250219","claude-3-haiku-20240307","claude-3-opus-20240229","claude-3-sonnet-20240229","claude-opus-4-1-20250805","claude-opus-4-20250514","claude-sonnet-4-20250514","claude-sonnet-4-5-20250929"],docUrl:"https://docs.anthropic.com/en/docs/about-claude/models",gateway:"models.dev"},"fireworks-ai":{url:"https://api.fireworks.ai/inference/v1/",apiKeyEnvVar:"FIREWORKS_API_KEY",apiKeyHeader:"Authorization",name:"Fireworks AI",models:["accounts/fireworks/models/deepseek-r1-0528","accounts/fireworks/models/deepseek-v3-0324","accounts/fireworks/models/deepseek-v3p1","accounts/fireworks/models/glm-4p5","accounts/fireworks/models/glm-4p5-air","accounts/fireworks/models/gpt-oss-120b","accounts/fireworks/models/gpt-oss-20b","accounts/fireworks/models/kimi-k2-instruct","accounts/fireworks/models/qwen3-235b-a22b","accounts/fireworks/models/qwen3-coder-480b-a35b-instruct"],docUrl:"https://fireworks.ai/docs/",gateway:"models.dev"},modelscope:{url:"https://api-inference.modelscope.cn/v1",apiKeyEnvVar:"MODELSCOPE_API_KEY",apiKeyHeader:"Authorization",name:"ModelScope",models:["Qwen/Qwen3-235B-A22B-Instruct-2507","Qwen/Qwen3-235B-A22B-Thinking-2507","Qwen/Qwen3-30B-A3B-Instruct-2507","Qwen/Qwen3-30B-A3B-Thinking-2507","Qwen/Qwen3-Coder-30B-A3B-Instruct","Qwen/Qwen3-Coder-480B-A35B-Instruct","ZhipuAI/GLM-4.5"],docUrl:"https://modelscope.cn/docs/model-service/API-Inference/intro",gateway:"models.dev"},llama:{url:"https://api.llama.com/compat/v1/",apiKeyEnvVar:"LLAMA_API_KEY",apiKeyHeader:"Authorization",name:"Llama",models:["cerebras-llama-4-maverick-17b-128e-instruct","cerebras-llama-4-scout-17b-16e-instruct","groq-llama-4-maverick-17b-128e-instruct","llama-3.3-70b-instruct","llama-3.3-8b-instruct","llama-4-maverick-17b-128e-instruct-fp8","llama-4-scout-17b-16e-instruct-fp8"],docUrl:"https://llama.developer.meta.com/docs/models",gateway:"models.dev"},cerebras:{url:"https://api.cerebras.ai/v1",apiKeyEnvVar:"CEREBRAS_API_KEY",apiKeyHeader:"Authorization",name:"Cerebras",models:["gpt-oss-120b","qwen-3-235b-a22b-instruct-2507","qwen-3-coder-480b"],docUrl:"https://inference-docs.cerebras.ai/models/overview",gateway:"models.dev"},netlify:{apiKeyEnvVar:["NETLIFY_TOKEN","NETLIFY_SITE_ID"],apiKeyHeader:"Authorization",name:"Netlify",gateway:"netlify",models:["anthropic/claude-opus-4-20250514","anthropic/claude-3-7-sonnet-20250219","anthropic/claude-3-7-sonnet-latest","anthropic/claude-3-haiku-20240307","anthropic/claude-opus-4-1-20250805","anthropic/claude-sonnet-4-5-20250929","anthropic/claude-sonnet-4-20250514","anthropic/claude-3-5-haiku-20241022","anthropic/claude-3-5-haiku-latest","gemini/gemini-2.0-flash-lite","gemini/gemini-2.5-flash-image-preview","gemini/gemini-2.5-pro","gemini/gemini-flash-latest","gemini/gemini-2.5-flash-preview-09-2025","gemini/gemini-flash-lite-latest","gemini/gemini-2.5-flash","gemini/gemini-2.5-flash-lite-preview-09-2025","gemini/gemini-2.5-flash-lite","gemini/gemini-2.0-flash","openai/gpt-4o","openai/gpt-4o-mini","openai/o4-mini","openai/o3","openai/gpt-5-pro","openai/gpt-5","openai/gpt-5-codex","openai/gpt-5-mini","openai/gpt-5-nano","openai/gpt-4.1","openai/o3-mini","openai/codex-mini-latest","openai/gpt-4.1-mini","openai/gpt-4.1-nano"],docUrl:"https://docs.netlify.com/build/ai-gateway/overview/"}}).filter(([e,t])=>"models.dev"===t.gateway)))],vR=class e{specificationVersion="v2";defaultObjectGenerationMode="json";supportsStructuredOutputs=!0;supportsImageUrls=!0;supportedUrls={};modelId;provider;config;gateway;constructor(e){"string"==typeof e&&(e={id:e});const t={...e,routerId:e.id};this.gateway=vO(e.id,vC);const r=vx(e.id,this.gateway.prefix);this.provider=r.providerId||"openai-compatible",r.providerId&&r.modelId!==e.id&&(t.id=r.modelId),this.modelId=t.id,this.config=t,this.gateway=vO(t.routerId,vC)}async doGenerate(){throw Error("doGenerate is not supported by Mastra model router. Mastra only uses streaming (doStream) for all LLM calls.")}async doStream(e){let t;try{t=await this.gateway.getApiKey(this.config.routerId)}catch(e){return{stream:new ReadableStream({start(t){t.enqueue({type:"error",error:e instanceof Error?e.message:String(e)})}})}}return(await this.resolveLanguageModel({apiKey:t,...vx(this.config.routerId,this.gateway.prefix)})).doStream(e)}async resolveLanguageModel({modelId:t,providerId:r,apiKey:a}){let s=(0,ri.createHash)("sha256").update(this.gateway.name+t+r+a).digest("hex");if(e.modelInstances.has(s))return e.modelInstances.get(s);let n=await this.gateway.resolveLanguageModel({modelId:t,providerId:r,apiKey:a});return e.modelInstances.set(s,n),n}static modelInstances=new Map},vM="vercel.ai.error",vN=Symbol.for(vM),vj=class e extends Error{constructor({name:e,message:t,cause:r}){super(t),this[ej]=!0,this.name=e,this.cause=r}static isInstance(t){return e.hasMarker(t,vM)}static hasMarker(e,t){let r=Symbol.for(t);return null!=e&&"object"==typeof e&&r in e&&"boolean"==typeof e[r]&&!0===e[r]}};ej=vN;var vP=vj,v$=(Symbol.for("vercel.ai.error.AI_APICallError"),Symbol.for("vercel.ai.error.AI_EmptyResponseBodyError"),"AI_InvalidArgumentError"),vD=`vercel.ai.error.${v$}`,vL=Symbol.for(vD),vU=class extends vP{constructor({message:e,cause:t,argument:r}){super({name:v$,message:e,cause:t}),this[eP]=!0,this.argument=r}static isInstance(e){return vP.hasMarker(e,vD)}};eP=vL,Symbol.for("vercel.ai.error.AI_InvalidPromptError"),Symbol.for("vercel.ai.error.AI_InvalidResponseDataError"),Symbol.for("vercel.ai.error.AI_JSONParseError"),Symbol.for("vercel.ai.error.AI_LoadAPIKeyError"),Symbol.for("vercel.ai.error.AI_LoadSettingError"),Symbol.for("vercel.ai.error.AI_NoContentGeneratedError"),Symbol.for("vercel.ai.error.AI_NoSuchModelError"),Symbol.for("vercel.ai.error.AI_TooManyEmbeddingValuesForCallError"),Symbol.for("vercel.ai.error.AI_TypeValidationError"),Symbol.for("vercel.ai.error.AI_UnsupportedFunctionalityError"),(({prefix:e,size:t=16,alphabet:r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",separator:a="-"}={})=>{let s=nt(r,t);if(null!=e){if(r.includes(a))throw new vU({argument:"separator",message:`The separator "${a}" must not be part of the alphabet "${r}".`});return t=>`${e}${a}${s(t)}`}})(),Symbol.for("vercel.ai.validator");var{btoa:vz,atob:vq}=globalThis;function vV(e){let t="";for(let r=0;r<e.length;r++)t+=String.fromCodePoint(e[r]);return vz(t)}var nS=n_,vF=e.i(190536),vZ=Symbol.for("vercel.ai.gateway.error"),vW=class e extends(eD=Error,e$=vZ,eD){constructor({message:e,statusCode:t=500,cause:r}){super(e),this[e$]=!0,this.statusCode=t,this.cause=r}static isInstance(t){return e.hasMarker(t)}static hasMarker(e){return"object"==typeof e&&null!==e&&vZ in e&&!0===e[vZ]}},vG="GatewayAuthenticationError",vB=Symbol.for(`vercel.ai.gateway.error.${vG}`),vK=class e extends(eU=vW,eL=vB,eU){constructor({message:e="Authentication failed",statusCode:t=401,cause:r}={}){super({message:e,statusCode:t,cause:r}),this[eL]=!0,this.name=vG,this.type="authentication_error"}static isInstance(e){return vW.hasMarker(e)&&vB in e}static createContextualError({apiKeyProvided:t,oidcTokenProvided:r,message:a="Authentication failed",statusCode:s=401,cause:n}){return new e({message:t?`AI Gateway authentication failed: Invalid API key provided.

The token is expected to be provided via the 'apiKey' option or 'AI_GATEWAY_API_KEY' environment variable.`:r?`AI Gateway authentication failed: Invalid OIDC token provided.

The token is expected to be provided via the 'VERCEL_OIDC_TOKEN' environment variable. It expires every 12 hours.
- make sure your Vercel project settings have OIDC enabled
- if running locally with 'vercel dev', the token is automatically obtained and refreshed
- if running locally with your own dev server, run 'vercel env pull' to fetch the token
- in production/preview, the token is automatically obtained and refreshed

Alternative: Provide an API key via 'apiKey' option or 'AI_GATEWAY_API_KEY' environment variable.`:`AI Gateway authentication failed: No authentication provided.

Provide either an API key or OIDC token.

API key instructions:

The token is expected to be provided via the 'apiKey' option or 'AI_GATEWAY_API_KEY' environment variable.

OIDC token instructions:

The token is expected to be provided via the 'VERCEL_OIDC_TOKEN' environment variable. It expires every 12 hours.
- make sure your Vercel project settings have OIDC enabled
- if running locally with 'vercel dev', the token is automatically obtained and refreshed
- if running locally with your own dev server, run 'vercel env pull' to fetch the token
- in production/preview, the token is automatically obtained and refreshed`,statusCode:s,cause:n})}},vJ="GatewayInvalidRequestError",vH=Symbol.for(`vercel.ai.gateway.error.${vJ}`),vY=class extends(eq=vW,ez=vH,eq){constructor({message:e="Invalid request",statusCode:t=400,cause:r}={}){super({message:e,statusCode:t,cause:r}),this[ez]=!0,this.name=vJ,this.type="invalid_request_error"}static isInstance(e){return vW.hasMarker(e)&&vH in e}},vQ="GatewayRateLimitError",vX=Symbol.for(`vercel.ai.gateway.error.${vQ}`),v0=class extends(eF=vW,eV=vX,eF){constructor({message:e="Rate limit exceeded",statusCode:t=429,cause:r}={}){super({message:e,statusCode:t,cause:r}),this[eV]=!0,this.name=vQ,this.type="rate_limit_exceeded"}static isInstance(e){return vW.hasMarker(e)&&vX in e}},v1="GatewayModelNotFoundError",v2=Symbol.for(`vercel.ai.gateway.error.${v1}`),v4=nS.object({modelId:nS.string()}),v5=class extends(eW=vW,eZ=v2,eW){constructor({message:e="Model not found",statusCode:t=404,modelId:r,cause:a}={}){super({message:e,statusCode:t,cause:a}),this[eZ]=!0,this.name=v1,this.type="model_not_found",this.modelId=r}static isInstance(e){return vW.hasMarker(e)&&v2 in e}},v3="GatewayInternalServerError",v9=Symbol.for(`vercel.ai.gateway.error.${v3}`),v6=class extends(eB=vW,eG=v9,eB){constructor({message:e="Internal server error",statusCode:t=500,cause:r}={}){super({message:e,statusCode:t,cause:r}),this[eG]=!0,this.name=v3,this.type="internal_server_error"}static isInstance(e){return vW.hasMarker(e)&&v9 in e}},v8="GatewayResponseError",v7=Symbol.for(`vercel.ai.gateway.error.${v8}`),be=class extends(eJ=vW,eK=v7,eJ){constructor({message:e="Invalid response from Gateway",statusCode:t=502,response:r,validationError:a,cause:s}={}){super({message:e,statusCode:t,cause:s}),this[eK]=!0,this.name=v8,this.type="response_error",this.response=r,this.validationError=a}static isInstance(e){return vW.hasMarker(e)&&v7 in e}};function bt({response:e,statusCode:t,defaultMessage:r="Gateway request failed",cause:a,authMethod:s}){let n=br.safeParse(e);if(!n.success)return new be({message:`Invalid error response format: ${r}`,statusCode:t,response:e,validationError:n.error,cause:a});let i=n.data,o=i.error.type,l=i.error.message;switch(o){case"authentication_error":return vK.createContextualError({apiKeyProvided:"api-key"===s,oidcTokenProvided:"oidc"===s,statusCode:t,cause:a});case"invalid_request_error":return new vY({message:l,statusCode:t,cause:a});case"rate_limit_exceeded":return new v0({message:l,statusCode:t,cause:a});case"model_not_found":{let e=v4.safeParse(i.error.param);return new v5({message:l,statusCode:t,modelId:e.success?e.data.modelId:void 0,cause:a})}default:return new v6({message:l,statusCode:t,cause:a})}}var br=nS.object({error:nS.object({message:nS.string(),type:nS.string().nullish(),param:nS.unknown().nullish(),code:nS.union([nS.string(),nS.number()]).nullish()})});function ba(e,t){var r;return vW.isInstance(e)?e:cb.isInstance(e)?bt({response:function(e){if(void 0!==e.data)return e.data;if(null!=e.responseBody)try{return JSON.parse(e.responseBody)}catch(t){return e.responseBody}return{}}(e),statusCode:null!=(r=e.statusCode)?r:500,defaultMessage:"Gateway request failed",cause:e,authMethod:t}):bt({response:{},statusCode:500,defaultMessage:e instanceof Error?`Gateway request failed: ${e.message}`:"Unknown Gateway error",cause:e,authMethod:t})}var bs="ai-gateway-auth-method";function bn(e){let t=bi.safeParse(e[bs]);return t.success?t.data:void 0}var bi=nS.union([nS.literal("api-key"),nS.literal("oidc")]),bo=class{constructor(e){this.config=e}async getAvailableModels(){try{let{value:e}=await hc({url:`${this.config.baseURL}/config`,headers:await hR(this.config.headers()),successfulResponseHandler:hj(bp),failedResponseHandler:hM({errorSchema:nS.any(),errorToMessage:e=>e}),fetch:this.config.fetch});return e}catch(e){throw ba(e)}}async getCredits(){try{let e=new URL(this.config.baseURL),{value:t}=await hc({url:`${e.origin}/v1/credits`,headers:await hR(this.config.headers()),successfulResponseHandler:hj(bc),failedResponseHandler:hM({errorSchema:nS.any(),errorToMessage:e=>e}),fetch:this.config.fetch});return t}catch(e){throw ba(e)}}},bl=nS.object({specificationVersion:nS.literal("v2"),provider:nS.string(),modelId:nS.string()}),bu=nS.object({input:nS.string(),output:nS.string(),input_cache_read:nS.string().nullish(),input_cache_write:nS.string().nullish()}).transform(({input:e,output:t,input_cache_read:r,input_cache_write:a})=>({input:e,output:t,...r?{cachedInputTokens:r}:{},...a?{cacheCreationInputTokens:a}:{}})),bd=nS.object({id:nS.string(),name:nS.string(),description:nS.string().nullish(),pricing:bu.nullish(),specification:bl,modelType:nS.enum(["language","embedding","image"]).nullish()}),bp=nS.object({models:nS.array(bd)}),bc=nS.object({balance:nS.string(),total_used:nS.string()}).transform(({balance:e,total_used:t})=>({balance:e,totalUsed:t})),bh=class{constructor(e,t){this.modelId=e,this.config=t,this.specificationVersion="v2",this.supportedUrls={"*/*":[/.*/]}}get provider(){return this.config.provider}async getArgs(e){let{abortSignal:t,...r}=e;return{args:this.maybeEncodeFileParts(r),warnings:[]}}async doGenerate(e){let{args:t,warnings:r}=await this.getArgs(e),{abortSignal:a}=e,s=await hR(this.config.headers());try{let{responseHeaders:n,value:i,rawValue:o}=await hT({url:this.getUrl(),headers:ht(s,e.headers,this.getModelConfigHeaders(this.modelId,!1),await hR(this.config.o11yHeaders)),body:t,successfulResponseHandler:hj(nS.any()),failedResponseHandler:hM({errorSchema:nS.any(),errorToMessage:e=>e}),...a&&{abortSignal:a},fetch:this.config.fetch});return{...i,request:{body:t},response:{headers:n,body:o},warnings:r}}catch(e){throw ba(e,bn(s))}}async doStream(e){let{args:t,warnings:r}=await this.getArgs(e),{abortSignal:a}=e,s=await hR(this.config.headers());try{let{value:n,responseHeaders:i}=await hT({url:this.getUrl(),headers:ht(s,e.headers,this.getModelConfigHeaders(this.modelId,!0),await hR(this.config.o11yHeaders)),body:t,successfulResponseHandler:hN(nS.any()),failedResponseHandler:hM({errorSchema:nS.any(),errorToMessage:e=>e}),...a&&{abortSignal:a},fetch:this.config.fetch});return{stream:n.pipeThrough(new TransformStream({start(e){r.length>0&&e.enqueue({type:"stream-start",warnings:r})},transform(t,r){if(t.success){let a=t.value;("raw"!==a.type||e.includeRawChunks)&&("response-metadata"===a.type&&a.timestamp&&"string"==typeof a.timestamp&&(a.timestamp=new Date(a.timestamp)),r.enqueue(a))}else r.error(t.error)}})),request:{body:t},response:{headers:i}}}catch(e){throw ba(e,bn(s))}}isFilePart(e){return e&&"object"==typeof e&&"type"in e&&"file"===e.type}maybeEncodeFileParts(e){for(let t of e.prompt)for(let e of t.content)if(this.isFilePart(e)&&e.data instanceof Uint8Array){let t=Uint8Array.from(e.data),r=Buffer.from(t).toString("base64");e.data=new URL(`data:${e.mediaType||"application/octet-stream"};base64,${r}`)}return e}getUrl(){return`${this.config.baseURL}/language-model`}getModelConfigHeaders(e,t){return{"ai-language-model-specification-version":"2","ai-language-model-id":e,"ai-language-model-streaming":String(t)}}},bm=class{constructor(e,t){this.modelId=e,this.config=t,this.specificationVersion="v2",this.maxEmbeddingsPerCall=2048,this.supportsParallelCalls=!0}get provider(){return this.config.provider}async doEmbed({values:e,headers:t,abortSignal:r,providerOptions:a}){var s;let n=await hR(this.config.headers());try{let{responseHeaders:i,value:o,rawValue:l}=await hT({url:this.getUrl(),headers:ht(n,null!=t?t:{},this.getModelConfigHeaders(),await hR(this.config.o11yHeaders)),body:{input:1===e.length?e[0]:e,...a?{providerOptions:a}:{}},successfulResponseHandler:hj(bg),failedResponseHandler:hM({errorSchema:nS.any(),errorToMessage:e=>e}),...r&&{abortSignal:r},fetch:this.config.fetch});return{embeddings:o.embeddings,usage:null!=(s=o.usage)?s:void 0,providerMetadata:o.providerMetadata,response:{headers:i,body:l}}}catch(e){throw ba(e,bn(n))}}getUrl(){return`${this.config.baseURL}/embedding-model`}getModelConfigHeaders(){return{"ai-embedding-model-specification-version":"2","ai-model-id":this.modelId}}},bg=nS.object({embeddings:nS.array(nS.array(nS.number())),usage:nS.object({tokens:nS.number()}).nullish(),providerMetadata:nS.record(nS.string(),nS.record(nS.string(),nS.unknown())).optional()});async function bf(){var e;return null==(e=(0,vF.getContext)().headers)?void 0:e["x-vercel-id"]}async function by(e){let t=hm({settingValue:e.apiKey,environmentVariableName:"AI_GATEWAY_API_KEY"});if(t)return{token:t,authMethod:"api-key"};try{return{token:await (0,vF.getVercelOidcToken)(),authMethod:"oidc"}}catch(e){return null}}!function(e={}){var t,r;let a=null,s=null,n=null!=(t=e.metadataCacheRefreshMillis)?t:3e5,i=0,o=null!=(r=ma(e.baseURL))?r:"https://ai-gateway.vercel.sh/v1/ai",l=async()=>{let t=await by(e);if(t)return hs({Authorization:`Bearer ${t.token}`,"ai-gateway-protocol-version":"0.0.1",[bs]:t.authMethod,...e.headers},"ai-sdk/gateway/1.0.33");throw vK.createContextualError({apiKeyProvided:!1,oidcTokenProvided:!1,statusCode:401})},u=()=>{let e=hm({settingValue:void 0,environmentVariableName:"VERCEL_DEPLOYMENT_ID"}),t=hm({settingValue:void 0,environmentVariableName:"VERCEL_ENV"}),r=hm({settingValue:void 0,environmentVariableName:"VERCEL_REGION"});return async()=>{let a=await bf();return{...e&&{"ai-o11y-deployment-id":e},...t&&{"ai-o11y-environment":t},...r&&{"ai-o11y-region":r},...a&&{"ai-o11y-request-id":a}}}},d=t=>new bh(t,{provider:"gateway",baseURL:o,headers:l,fetch:e.fetch,o11yHeaders:u()}),p=async()=>new bo({baseURL:o,headers:l,fetch:e.fetch}).getCredits().catch(async e=>{throw ba(e,bn(await l()))}),c=function(e){if(new.target)throw Error("The Gateway Provider model function cannot be called with the new keyword.");return d(e)};c.getAvailableModels=async()=>{var t,r,u;let d=null!=(u=null==(r=null==(t=e._internal)?void 0:t.currentDate)?void 0:r.call(t).getTime())?u:Date.now();return(!a||d-i>n)&&(i=d,a=new bo({baseURL:o,headers:l,fetch:e.fetch}).getAvailableModels().then(e=>(s=e,e)).catch(async e=>{throw ba(e,bn(await l()))})),s?Promise.resolve(s):a},c.getCredits=p,c.imageModel=e=>{throw new cK({modelId:e,modelType:"imageModel"})},c.languageModel=d,c.textEmbeddingModel=t=>new bm(t,{provider:"gateway",baseURL:o,headers:l,fetch:e.fetch,o11yHeaders:u()})}();var nS=n_,bv=Object.defineProperty,bb=(Symbol.for("vercel.ai.error.AI_NoOutputSpecifiedError"),Symbol.for("vercel.ai.error.AI_InvalidArgumentError"),Symbol.for("vercel.ai.error.AI_InvalidStreamPartError"),Symbol.for("vercel.ai.error.AI_InvalidToolInputError"),Symbol.for("vercel.ai.error.AI_MCPClientError"),Symbol.for("vercel.ai.error.AI_NoImageGeneratedError"),"AI_NoObjectGeneratedError"),bw=`vercel.ai.error.${bb}`,b_=Symbol.for(bw),bS=class extends cg{constructor({message:e="No object generated.",cause:t,text:r,response:a,usage:s,finishReason:n}){super({name:bb,message:e,cause:t}),this[eH]=!0,this.text=r,this.response=a,this.usage=s,this.finishReason=n}static isInstance(e){return cg.hasMarker(e,bw)}};eH=b_,Symbol.for("vercel.ai.error.AI_NoOutputGeneratedError"),Symbol.for("vercel.ai.error.AI_NoSuchToolError"),Symbol.for("vercel.ai.error.AI_ToolCallRepairError"),Symbol.for("vercel.ai.error.AI_InvalidDataContentError"),Symbol.for("vercel.ai.error.AI_InvalidMessageRoleError");var bx="AI_MessageConversionError",bI=`vercel.ai.error.${bx}`,bk=Symbol.for(bI),bT=class extends cg{constructor({originalMessage:e,message:t}){super({name:bx,message:t}),this[eY]=!0,this.originalMessage=e}static isInstance(e){return cg.hasMarker(e,bI)}};eY=bk,Symbol.for("vercel.ai.error.AI_DownloadError"),Symbol.for("vercel.ai.error.AI_RetryError");var bE=nS.union([nS.string(),nS.instanceof(Uint8Array),nS.instanceof(ArrayBuffer),nS.custom(e=>{var t,r;return null!=(r=null==(t=globalThis.Buffer)?void 0:t.isBuffer(e))&&r},{message:"Must be a Buffer"})]),bA=nS.lazy(()=>nS.union([nS.null(),nS.string(),nS.number(),nS.boolean(),nS.record(nS.string(),bA),nS.array(bA)])),bO=nS.record(nS.string(),nS.record(nS.string(),bA)),bC=nS.object({type:nS.literal("text"),text:nS.string(),providerOptions:bO.optional()}),bR=nS.object({type:nS.literal("image"),image:nS.union([bE,nS.instanceof(URL)]),mediaType:nS.string().optional(),providerOptions:bO.optional()}),bM=nS.object({type:nS.literal("file"),data:nS.union([bE,nS.instanceof(URL)]),filename:nS.string().optional(),mediaType:nS.string(),providerOptions:bO.optional()}),bN=nS.object({type:nS.literal("reasoning"),text:nS.string(),providerOptions:bO.optional()}),bj=nS.object({type:nS.literal("tool-call"),toolCallId:nS.string(),toolName:nS.string(),input:nS.unknown(),providerOptions:bO.optional(),providerExecuted:nS.boolean().optional()}),bP=nS.discriminatedUnion("type",[nS.object({type:nS.literal("text"),value:nS.string()}),nS.object({type:nS.literal("json"),value:bA}),nS.object({type:nS.literal("error-text"),value:nS.string()}),nS.object({type:nS.literal("error-json"),value:bA}),nS.object({type:nS.literal("content"),value:nS.array(nS.union([nS.object({type:nS.literal("text"),text:nS.string()}),nS.object({type:nS.literal("media"),data:nS.string(),mediaType:nS.string()})]))})]),b$=nS.object({type:nS.literal("tool-result"),toolCallId:nS.string(),toolName:nS.string(),output:bP,providerOptions:bO.optional()}),bD=nS.object({role:nS.literal("system"),content:nS.string(),providerOptions:bO.optional()}),bL=nS.object({role:nS.literal("user"),content:nS.union([nS.string(),nS.array(nS.union([bC,bR,bM]))]),providerOptions:bO.optional()}),bU=nS.object({role:nS.literal("assistant"),content:nS.union([nS.string(),nS.array(nS.union([bC,bM,bN,bj,b$]))]),providerOptions:bO.optional()}),bz=nS.object({role:nS.literal("tool"),content:nS.array(b$),providerOptions:bO.optional()});function bq(e){return({steps:t})=>t.length===e}function bV({output:e,tool:t,errorMode:r}){return"text"===r?{type:"error-text",value:cI(e)}:"json"===r?{type:"error-json",value:bF(e)}:(null==t?void 0:t.toModelOutput)?t.toModelOutput(e):"string"==typeof e?{type:"text",value:e}:{type:"json",value:bF(e)}}function bF(e){return void 0===e?null:e}function bZ(e,t){let r=new Headers(null!=e?e:{});for(let[e,a]of Object.entries(t))r.has(e)||r.set(e,a);return r}nS.union([bD,bL,bU,bz]),hn({prefix:"aitxt",size:24});var bW=class extends TransformStream{constructor(){super({transform(e,t){t.enqueue(`data: ${JSON.stringify(e)}

`)},flush(e){e.enqueue("data: [DONE]\n\n")}})}},bG={"content-type":"text/event-stream","cache-control":"no-cache",connection:"keep-alive","x-vercel-ai-ui-message-stream":"v1","x-accel-buffering":"no"};async function bB(e){if(void 0===e)return{value:void 0,state:"undefined-input"};let t=await hS({text:e});return t.success?{value:t.value,state:"successful-parse"}:(t=await hS({text:function(e){let t=["ROOT"],r=-1,a=null;function s(e,s,n){switch(e){case'"':r=s,t.pop(),t.push(n),t.push("INSIDE_STRING");break;case"f":case"t":case"n":r=s,a=s,t.pop(),t.push(n),t.push("INSIDE_LITERAL");break;case"-":t.pop(),t.push(n),t.push("INSIDE_NUMBER");break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":r=s,t.pop(),t.push(n),t.push("INSIDE_NUMBER");break;case"{":r=s,t.pop(),t.push(n),t.push("INSIDE_OBJECT_START");break;case"[":r=s,t.pop(),t.push(n),t.push("INSIDE_ARRAY_START")}}function n(e,a){switch(e){case",":t.pop(),t.push("INSIDE_OBJECT_AFTER_COMMA");break;case"}":r=a,t.pop()}}function i(e,a){switch(e){case",":t.pop(),t.push("INSIDE_ARRAY_AFTER_COMMA");break;case"]":r=a,t.pop()}}for(let o=0;o<e.length;o++){let l=e[o];switch(t[t.length-1]){case"ROOT":s(l,o,"FINISH");break;case"INSIDE_OBJECT_START":switch(l){case'"':t.pop(),t.push("INSIDE_OBJECT_KEY");break;case"}":r=o,t.pop()}break;case"INSIDE_OBJECT_AFTER_COMMA":'"'===l&&(t.pop(),t.push("INSIDE_OBJECT_KEY"));break;case"INSIDE_OBJECT_KEY":'"'===l&&(t.pop(),t.push("INSIDE_OBJECT_AFTER_KEY"));break;case"INSIDE_OBJECT_AFTER_KEY":":"===l&&(t.pop(),t.push("INSIDE_OBJECT_BEFORE_VALUE"));break;case"INSIDE_OBJECT_BEFORE_VALUE":s(l,o,"INSIDE_OBJECT_AFTER_VALUE");break;case"INSIDE_OBJECT_AFTER_VALUE":n(l,o);break;case"INSIDE_STRING":switch(l){case'"':t.pop(),r=o;break;case"\\":t.push("INSIDE_STRING_ESCAPE");break;default:r=o}break;case"INSIDE_ARRAY_START":"]"===l?(r=o,t.pop()):(r=o,s(l,o,"INSIDE_ARRAY_AFTER_VALUE"));break;case"INSIDE_ARRAY_AFTER_VALUE":switch(l){case",":t.pop(),t.push("INSIDE_ARRAY_AFTER_COMMA");break;case"]":r=o,t.pop();break;default:r=o}break;case"INSIDE_ARRAY_AFTER_COMMA":s(l,o,"INSIDE_ARRAY_AFTER_VALUE");break;case"INSIDE_STRING_ESCAPE":t.pop(),r=o;break;case"INSIDE_NUMBER":switch(l){case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":r=o;break;case"e":case"E":case"-":case".":break;case",":t.pop(),"INSIDE_ARRAY_AFTER_VALUE"===t[t.length-1]&&i(l,o),"INSIDE_OBJECT_AFTER_VALUE"===t[t.length-1]&&n(l,o);break;case"}":t.pop(),"INSIDE_OBJECT_AFTER_VALUE"===t[t.length-1]&&n(l,o);break;case"]":t.pop(),"INSIDE_ARRAY_AFTER_VALUE"===t[t.length-1]&&i(l,o);break;default:t.pop()}break;case"INSIDE_LITERAL":{let s=e.substring(a,o+1);"false".startsWith(s)||"true".startsWith(s)||"null".startsWith(s)?r=o:(t.pop(),"INSIDE_OBJECT_AFTER_VALUE"===t[t.length-1]?n(l,o):"INSIDE_ARRAY_AFTER_VALUE"===t[t.length-1]&&i(l,o))}}}let o=e.slice(0,r+1);for(let r=t.length-1;r>=0;r--)switch(t[r]){case"INSIDE_STRING":o+='"';break;case"INSIDE_OBJECT_KEY":case"INSIDE_OBJECT_AFTER_KEY":case"INSIDE_OBJECT_AFTER_COMMA":case"INSIDE_OBJECT_START":case"INSIDE_OBJECT_BEFORE_VALUE":case"INSIDE_OBJECT_AFTER_VALUE":o+="}";break;case"INSIDE_ARRAY_START":case"INSIDE_ARRAY_AFTER_COMMA":case"INSIDE_ARRAY_AFTER_VALUE":o+="]";break;case"INSIDE_LITERAL":{let t=e.substring(a,e.length);"true".startsWith(t)?o+="true".slice(t.length):"false".startsWith(t)?o+="false".slice(t.length):"null".startsWith(t)&&(o+="null".slice(t.length))}}return o}(e)})).success?{value:t.value,state:"repaired-parse"}:{value:void 0,state:"failed-parse"}}function bK(e){return e.type.startsWith("tool-")}function bJ(e){return e.type.split("-").slice(1).join("-")}function bH(e,t){let r=[];for(let a of((null==t?void 0:t.ignoreIncompleteToolCalls)&&(e=e.map(e=>({...e,parts:e.parts.filter(e=>{var t;return!(bK(t=e)||"dynamic-tool"===t.type)||"input-streaming"!==e.state&&"input-available"!==e.state})}))),e))switch(a.role){case"system":{let e=a.parts.filter(e=>"text"===e.type),t=e.reduce((e,t)=>null!=t.providerMetadata?{...e,...t.providerMetadata}:e,{});r.push({role:"system",content:e.map(e=>e.text).join(""),...Object.keys(t).length>0?{providerOptions:t}:{}});break}case"user":r.push({role:"user",content:a.parts.filter(e=>"text"===e.type||"file"===e.type).map(e=>{switch(e.type){case"text":return{type:"text",text:e.text,...null!=e.providerMetadata?{providerOptions:e.providerMetadata}:{}};case"file":return{type:"file",mediaType:e.mediaType,filename:e.filename,data:e.url,...null!=e.providerMetadata?{providerOptions:e.providerMetadata}:{}};default:return e}})});break;case"assistant":if(null!=a.parts){let e=function(){var e,a;if(0===s.length)return;let n=[];for(let r of s)if("text"===r.type)n.push({type:"text",text:r.text,...null!=r.providerMetadata?{providerOptions:r.providerMetadata}:{}});else if("file"===r.type)n.push({type:"file",mediaType:r.mediaType,filename:r.filename,data:r.url});else if("reasoning"===r.type)n.push({type:"reasoning",text:r.text,providerOptions:r.providerMetadata});else if("dynamic-tool"===r.type){let e=r.toolName;"input-streaming"!==r.state&&n.push({type:"tool-call",toolCallId:r.toolCallId,toolName:e,input:r.input,...null!=r.callProviderMetadata?{providerOptions:r.callProviderMetadata}:{}})}else if(bK(r)){let s=bJ(r);"input-streaming"!==r.state&&(n.push({type:"tool-call",toolCallId:r.toolCallId,toolName:s,input:"output-error"===r.state?null!=(e=r.input)?e:r.rawInput:r.input,providerExecuted:r.providerExecuted,...null!=r.callProviderMetadata?{providerOptions:r.callProviderMetadata}:{}}),!0===r.providerExecuted&&("output-available"===r.state||"output-error"===r.state)&&n.push({type:"tool-result",toolCallId:r.toolCallId,toolName:s,output:bV({output:"output-error"===r.state?r.errorText:r.output,tool:null==(a=null==t?void 0:t.tools)?void 0:a[s],errorMode:"output-error"===r.state?"json":"none"})}))}else throw Error(`Unsupported part: ${r}`);r.push({role:"assistant",content:n});let i=s.filter(e=>bK(e)&&!0!==e.providerExecuted||"dynamic-tool"===e.type);i.length>0&&r.push({role:"tool",content:i.map(e=>{var r;switch(e.state){case"output-error":case"output-available":{let a="dynamic-tool"===e.type?e.toolName:bJ(e);return{type:"tool-result",toolCallId:e.toolCallId,toolName:a,output:bV({output:"output-error"===e.state?e.errorText:e.output,tool:null==(r=null==t?void 0:t.tools)?void 0:r[a],errorMode:"output-error"===e.state?"text":"none"})}}default:return null}}).filter(e=>null!=e)}),s=[]},s=[];for(let t of a.parts)"text"===t.type||"reasoning"===t.type||"file"===t.type||"dynamic-tool"===t.type||bK(t)?s.push(t):"step-start"===t.type&&e();e()}break;default:{let e=a.role;throw new bT({originalMessage:a,message:`Unsupported role: ${e}`})}}return r}function bY(e,t){if(e===t)return!0;if(null==e||null==t)return!1;if("object"!=typeof e&&"object"!=typeof t)return e===t;if(e.constructor!==t.constructor)return!1;if(e instanceof Date&&t instanceof Date)return e.getTime()===t.getTime();if(Array.isArray(e)){if(e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(!bY(e[r],t[r]))return!1;return!0}let r=Object.keys(e),a=Object.keys(t);if(r.length!==a.length)return!1;for(let s of r)if(!a.includes(s)||!bY(e[s],t[s]))return!1;return!0}nS.union([nS.strictObject({type:nS.literal("text-start"),id:nS.string(),providerMetadata:bO.optional()}),nS.strictObject({type:nS.literal("text-delta"),id:nS.string(),delta:nS.string(),providerMetadata:bO.optional()}),nS.strictObject({type:nS.literal("text-end"),id:nS.string(),providerMetadata:bO.optional()}),nS.strictObject({type:nS.literal("error"),errorText:nS.string()}),nS.strictObject({type:nS.literal("tool-input-start"),toolCallId:nS.string(),toolName:nS.string(),providerExecuted:nS.boolean().optional(),dynamic:nS.boolean().optional()}),nS.strictObject({type:nS.literal("tool-input-delta"),toolCallId:nS.string(),inputTextDelta:nS.string()}),nS.strictObject({type:nS.literal("tool-input-available"),toolCallId:nS.string(),toolName:nS.string(),input:nS.unknown(),providerExecuted:nS.boolean().optional(),providerMetadata:bO.optional(),dynamic:nS.boolean().optional()}),nS.strictObject({type:nS.literal("tool-input-error"),toolCallId:nS.string(),toolName:nS.string(),input:nS.unknown(),providerExecuted:nS.boolean().optional(),providerMetadata:bO.optional(),dynamic:nS.boolean().optional(),errorText:nS.string()}),nS.strictObject({type:nS.literal("tool-output-available"),toolCallId:nS.string(),output:nS.unknown(),providerExecuted:nS.boolean().optional(),dynamic:nS.boolean().optional(),preliminary:nS.boolean().optional()}),nS.strictObject({type:nS.literal("tool-output-error"),toolCallId:nS.string(),errorText:nS.string(),providerExecuted:nS.boolean().optional(),dynamic:nS.boolean().optional()}),nS.strictObject({type:nS.literal("reasoning-start"),id:nS.string(),providerMetadata:bO.optional()}),nS.strictObject({type:nS.literal("reasoning-delta"),id:nS.string(),delta:nS.string(),providerMetadata:bO.optional()}),nS.strictObject({type:nS.literal("reasoning-end"),id:nS.string(),providerMetadata:bO.optional()}),nS.strictObject({type:nS.literal("source-url"),sourceId:nS.string(),url:nS.string(),title:nS.string().optional(),providerMetadata:bO.optional()}),nS.strictObject({type:nS.literal("source-document"),sourceId:nS.string(),mediaType:nS.string(),title:nS.string(),filename:nS.string().optional(),providerMetadata:bO.optional()}),nS.strictObject({type:nS.literal("file"),url:nS.string(),mediaType:nS.string(),providerMetadata:bO.optional()}),nS.strictObject({type:nS.custom(e=>"string"==typeof e&&e.startsWith("data-"),{message:'Type must start with "data-"'}),id:nS.string().optional(),data:nS.unknown(),transient:nS.boolean().optional()}),nS.strictObject({type:nS.literal("start-step")}),nS.strictObject({type:nS.literal("finish-step")}),nS.strictObject({type:nS.literal("start"),messageId:nS.string().optional(),messageMetadata:nS.unknown().optional()}),nS.strictObject({type:nS.literal("finish"),messageMetadata:nS.unknown().optional()}),nS.strictObject({type:nS.literal("abort")}),nS.strictObject({type:nS.literal("message-metadata"),messageMetadata:nS.unknown()})]),hn({prefix:"aitxt",size:24}),hn({prefix:"aiobj",size:24}),hn({prefix:"aiobj",size:24});var bQ={},bX={object:()=>b2,text:()=>b1};for(var b0 in bX)bv(bQ,b0,{get:bX[b0],enumerable:!0});var b1=()=>({type:"text",responseFormat:{type:"text"},parsePartial:async({text:e})=>({partial:e}),parseOutput:async({text:e})=>e}),b2=({schema:e})=>{let t=h7(e);return{type:"object",responseFormat:{type:"json",schema:t.jsonSchema},async parsePartial({text:e}){let t=await bB(e);switch(t.state){case"failed-parse":case"undefined-input":return;case"repaired-parse":case"successful-parse":return{partial:t.value};default:{let e=t.state;throw Error(`Unsupported parse state: ${e}`)}}},async parseOutput({text:e},r){let a=await hS({text:e});if(!a.success)throw new bS({message:"No object generated: could not parse the response.",cause:a.error,text:e,response:r.response,usage:r.usage,finishReason:r.finishReason});let s=await hw({value:a.value,schema:t});if(!s.success)throw new bS({message:"No object generated: response did not match schema.",cause:s.error,text:e,response:r.response,usage:r.usage,finishReason:r.finishReason});return s.value}}},b4=(Symbol.for("vercel.ai.error.AI_NoSuchProviderError"),nS.looseObject({name:nS.string(),version:nS.string()})),b5=nS.looseObject({_meta:nS.optional(nS.object({}).loose())}),b3=nS.object({method:nS.string(),params:nS.optional(b5)}),b9=nS.looseObject({experimental:nS.optional(nS.object({}).loose()),logging:nS.optional(nS.object({}).loose()),prompts:nS.optional(nS.looseObject({listChanged:nS.optional(nS.boolean())})),resources:nS.optional(nS.looseObject({subscribe:nS.optional(nS.boolean()),listChanged:nS.optional(nS.boolean())})),tools:nS.optional(nS.looseObject({listChanged:nS.optional(nS.boolean())}))});b5.extend({protocolVersion:nS.string(),capabilities:b9,serverInfo:b4,instructions:nS.optional(nS.string())});var b6=b5.extend({nextCursor:nS.optional(nS.string())}),b8=nS.object({name:nS.string(),description:nS.optional(nS.string()),inputSchema:nS.object({type:nS.literal("object"),properties:nS.optional(nS.object({}).loose())}).loose()}).loose();b6.extend({tools:nS.array(b8)});var b7=nS.object({type:nS.literal("text"),text:nS.string()}).loose(),we=nS.object({type:nS.literal("image"),data:nS.base64(),mimeType:nS.string()}).loose(),wt=nS.object({uri:nS.string(),mimeType:nS.optional(nS.string())}).loose(),wr=wt.extend({text:nS.string()}),wa=wt.extend({blob:nS.base64()}),ws=nS.object({type:nS.literal("resource"),resource:nS.union([wr,wa])}).loose();b5.extend({content:nS.array(nS.union([b7,we,ws])),isError:nS.boolean().default(!1).optional()}).or(b5.extend({toolResult:nS.unknown()}));var wn=nS.object({jsonrpc:nS.literal("2.0"),id:nS.union([nS.string(),nS.number().int()])}).merge(b3).strict(),wi=nS.object({jsonrpc:nS.literal("2.0"),id:nS.union([nS.string(),nS.number().int()]),result:b5}).strict(),wo=nS.object({jsonrpc:nS.literal("2.0"),id:nS.union([nS.string(),nS.number().int()]),error:nS.object({code:nS.number().int(),message:nS.string(),data:nS.optional(nS.unknown())})}).strict(),wl=nS.object({jsonrpc:nS.literal("2.0")}).merge(nS.object({method:nS.string(),params:nS.optional(b5)})).strict();nS.union([wn,wl,wi,wo]);var wu=nS.object({type:nS.literal("text"),text:nS.string(),state:nS.enum(["streaming","done"]).optional(),providerMetadata:bO.optional()}),wd=nS.object({type:nS.literal("reasoning"),text:nS.string(),state:nS.enum(["streaming","done"]).optional(),providerMetadata:bO.optional()}),wp=nS.object({type:nS.literal("source-url"),sourceId:nS.string(),url:nS.string(),title:nS.string().optional(),providerMetadata:bO.optional()}),wc=nS.object({type:nS.literal("source-document"),sourceId:nS.string(),mediaType:nS.string(),title:nS.string(),filename:nS.string().optional(),providerMetadata:bO.optional()}),wh=nS.object({type:nS.literal("file"),mediaType:nS.string(),filename:nS.string().optional(),url:nS.string(),providerMetadata:bO.optional()}),wm=nS.object({type:nS.literal("step-start")}),wg=nS.object({type:nS.string().startsWith("data-"),id:nS.string().optional(),data:nS.unknown()}),wf=[nS.object({type:nS.literal("dynamic-tool"),toolName:nS.string(),toolCallId:nS.string(),state:nS.literal("input-streaming"),input:nS.unknown().optional(),output:nS.never().optional(),errorText:nS.never().optional()}),nS.object({type:nS.literal("dynamic-tool"),toolName:nS.string(),toolCallId:nS.string(),state:nS.literal("input-available"),input:nS.unknown(),output:nS.never().optional(),errorText:nS.never().optional(),callProviderMetadata:bO.optional()}),nS.object({type:nS.literal("dynamic-tool"),toolName:nS.string(),toolCallId:nS.string(),state:nS.literal("output-available"),input:nS.unknown(),output:nS.unknown(),errorText:nS.never().optional(),callProviderMetadata:bO.optional(),preliminary:nS.boolean().optional()}),nS.object({type:nS.literal("dynamic-tool"),toolName:nS.string(),toolCallId:nS.string(),state:nS.literal("output-error"),input:nS.unknown(),output:nS.never().optional(),errorText:nS.string(),callProviderMetadata:bO.optional()})],wy=[nS.object({type:nS.string().startsWith("tool-"),toolCallId:nS.string(),state:nS.literal("input-streaming"),providerExecuted:nS.boolean().optional(),input:nS.unknown().optional(),output:nS.never().optional(),errorText:nS.never().optional()}),nS.object({type:nS.string().startsWith("tool-"),toolCallId:nS.string(),state:nS.literal("input-available"),providerExecuted:nS.boolean().optional(),input:nS.unknown(),output:nS.never().optional(),errorText:nS.never().optional(),callProviderMetadata:bO.optional()}),nS.object({type:nS.string().startsWith("tool-"),toolCallId:nS.string(),state:nS.literal("output-available"),providerExecuted:nS.boolean().optional(),input:nS.unknown(),output:nS.unknown(),errorText:nS.never().optional(),callProviderMetadata:bO.optional(),preliminary:nS.boolean().optional()}),nS.object({type:nS.string().startsWith("tool-"),toolCallId:nS.string(),state:nS.literal("output-error"),providerExecuted:nS.boolean().optional(),input:nS.unknown(),output:nS.never().optional(),errorText:nS.string(),callProviderMetadata:bO.optional()})];function wv(e){return(e instanceof Error||e instanceof DOMException)&&("AbortError"===e.name||"ResponseAborted"===e.name||"TimeoutError"===e.name)}nS.object({id:nS.string(),role:nS.enum(["system","user","assistant"]),metadata:nS.unknown().optional(),parts:nS.array(nS.union([wu,wd,wp,wc,wh,wm,wg,...wf,...wy]))}),(({prefix:e,size:t=16,alphabet:r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",separator:a="-"}={})=>{if(null!=e){if(r.includes(a))throw new cA({argument:"separator",message:`The separator "${a}" must not be part of the alphabet "${r}".`});return()=>`${e}${a}${(()=>{let e=r.length,a=Array(t);for(let s=0;s<t;s++)a[s]=r[Math.random()*e|0];return a.join("")})()}`}})(),Symbol.for("vercel.ai.validator");Symbol("Let zodToJsonSchema decide on which parser to use");Symbol.for("vercel.ai.schema");var{btoa:wb,atob:ww}=globalThis,w_=class{base64Data;uint8ArrayData;mediaType;constructor({data:e,mediaType:t}){const r=e instanceof Uint8Array;this.base64Data=r?void 0:e,this.uint8ArrayData=r?e:void 0,this.mediaType=t}get base64(){return null==this.base64Data&&(this.base64Data=vV(this.uint8ArrayData)),this.base64Data}get uint8Array(){let e;return null==this.uint8ArrayData&&(this.uint8ArrayData=(e=vq(this.base64Data.replace(/-/g,"+").replace(/_/g,"/")),Uint8Array.from(e,e=>e.codePointAt(0)))),this.uint8ArrayData}},wS=class extends w_{type="file";constructor(e){super(e)}},wx=[{mediaType:"image/gif",bytesPrefix:[71,73,70],base64Prefix:"R0lG"},{mediaType:"image/png",bytesPrefix:[137,80,78,71],base64Prefix:"iVBORw"},{mediaType:"image/jpeg",bytesPrefix:[255,216],base64Prefix:"/9j/"},{mediaType:"image/webp",bytesPrefix:[82,73,70,70],base64Prefix:"UklGRg"},{mediaType:"image/bmp",bytesPrefix:[66,77],base64Prefix:"Qk"},{mediaType:"image/tiff",bytesPrefix:[73,73,42,0],base64Prefix:"SUkqAA"},{mediaType:"image/tiff",bytesPrefix:[77,77,0,42],base64Prefix:"TU0AKg"},{mediaType:"image/avif",bytesPrefix:[0,0,0,32,102,116,121,112,97,118,105,102],base64Prefix:"AAAAIGZ0eXBhdmlm"},{mediaType:"image/heic",bytesPrefix:[0,0,0,32,102,116,121,112,104,101,105,99],base64Prefix:"AAAAIGZ0eXBoZWlj"}];function wI(e){let t=[];for(let r of e){let e;try{e=new URL(r.url)}catch{throw Error(`Invalid URL: ${r.url}`)}switch(e.protocol){case"http:":case"https:":if(r.contentType?.startsWith("image/"))t.push({type:"image",image:e.toString(),mimeType:r.contentType});else{if(!r.contentType)throw Error("If the attachment is not an image, it must specify a content type");t.push({type:"file",data:e.toString(),mimeType:r.contentType})}break;case"data:":if(r.contentType?.startsWith("image/"))t.push({type:"image",image:r.url,mimeType:r.contentType});else if(r.contentType?.startsWith("text/"))t.push({type:"file",data:r.url,mimeType:r.contentType});else{if(!r.contentType)throw Error("If the attachment is not an image or text, it must specify a content type");t.push({type:"file",data:r.url,mimeType:r.contentType})}break;default:throw Error(`Unsupported URL protocol: ${e.protocol}`)}}return t}function wk(e){let t,r,a=[],s=(t=new Map,r=/__split-\d+$/,e=>{let s=a.at(-1);if(e.role===s?.role&&Array.isArray(s.content)&&Array.isArray(e.content)&&("assistant"!==e.role||"assistant"===e.role&&e.content.at(-1)?.type!=="tool-call"))for(let t of e.content)s.content.push(t);else{let s=e.id;if(r.test(s))return void a.push(e);let n=t.get(s)||0;n>0&&(e.id=`${s}__split-${n}`),t.set(s,n+1),a.push(e)}});for(let t=0;t<e.length;t++){let r=e[t],a=t===e.length-1;if(!r?.content)continue;let{content:n,experimental_attachments:i=[],parts:o}=r.content,{role:l}=r,u={id:r.id,createdAt:r.createdAt,resourceId:r.resourceId,threadId:r.threadId},d=[...i],p=[];for(let e of o)"file"===e.type?d.push({url:e.data,contentType:e.mimeType}):p.push(e);switch(l){case"user":if(null==p){let e=d?[{type:"text",text:n||""},...wI(d)]:{type:"text",text:n||""};s({role:"user",...u,type:"text",content:e})}else{let e=r.content.parts.filter(e=>"text"===e.type).map(e=>({type:"text",text:e.text})),t=d?[...e,...wI(d)]:e;s({role:"user",...u,type:"text",content:Array.isArray(t)&&1===t.length&&t[0]?.type==="text"&&void 0!==n?n:t})}break;case"assistant":{if(null!=r.content.parts){let e=function(){let e=[];for(let t of n)switch(t.type){case"file":case"text":e.push(t);break;case"reasoning":for(let r of t.details)switch(r.type){case"text":e.push({type:"reasoning",text:r.text,signature:r.signature});break;case"redacted":e.push({type:"redacted-reasoning",data:r.data})}break;case"tool-invocation":"updateWorkingMemory"!==t.toolInvocation.toolName&&e.push({type:"tool-call",toolCallId:t.toolInvocation.toolCallId,toolName:t.toolInvocation.toolName,args:t.toolInvocation.args})}s({role:"assistant",...u,type:e.some(e=>"tool-call"===e.type)?"tool-call":"text",content:Array.isArray(e)&&1===e.length&&e[0]?.type==="text"?e[0].text:e});let r=n.filter(e=>"type"in e&&"tool-invocation"===e.type).map(e=>e.toolInvocation).filter(e=>"updateWorkingMemory"!==e.toolName).filter(e=>"result"===e.state&&"result"in e);r.length>0&&s({role:"tool",...u,type:"tool-result",content:r.map(e=>{let{toolCallId:t,toolName:r,result:a}=e;return{type:"tool-result",toolCallId:t,toolName:r,result:a}})}),n=[],a=!1,t++},t=0,a=!1,n=[];for(let s of r.content.parts)switch(s.type){case"text":a&&e(),n.push(s);break;case"file":case"reasoning":n.push(s);break;case"tool-invocation":(n.some(e=>"text"===e.type||"file"===e.type||"reasoning"===e.type)||(s.toolInvocation.step??0)!==t)&&e(),n.push(s),a=!0}e();let i=r.content.toolInvocations;if(i&&i.length>0){let e=new Set;for(let t of r.content.parts)"tool-invocation"===t.type&&t.toolInvocation.toolCallId&&e.add(t.toolInvocation.toolCallId);let t=i.filter(t=>!e.has(t.toolCallId)&&"updateWorkingMemory"!==t.toolName);if(t.length>0){let e=new Map;for(let r of t){let t=r.step??0;e.has(t)||e.set(t,[]),e.get(t).push(r)}for(let t of Array.from(e.keys()).sort((e,t)=>e-t)){let r=e.get(t);s({role:"assistant",...u,type:"tool-call",content:[...r.map(({toolCallId:e,toolName:t,args:r})=>({type:"tool-call",toolCallId:e,toolName:t,args:r}))]});let a=r.filter(e=>"result"===e.state&&"result"in e);a.length>0&&s({role:"tool",...u,type:"tool-result",content:a.map(e=>{let{toolCallId:t,toolName:r,result:a}=e;return{type:"tool-result",toolCallId:t,toolName:r,result:a}})})}}}break}let e=r.content.toolInvocations;if(null==e||0===e.length){s({role:"assistant",...u,content:n||"",type:"text"});break}let t=e.reduce((e,t)=>Math.max(e,t.step??0),0);for(let r=0;r<=t;r++){let t=e.filter(e=>(e.step??0)===r&&"updateWorkingMemory"!==e.toolName);if(0===t.length)continue;s({role:"assistant",...u,type:"tool-call",content:[...a&&n&&0===r?[{type:"text",text:n}]:[],...t.map(({toolCallId:e,toolName:t,args:r})=>({type:"tool-call",toolCallId:e,toolName:t,args:r}))]});let i=t.filter(e=>"result"===e.state&&"result"in e);i.length>0&&s({role:"tool",...u,type:"tool-result",content:i.map(e=>{let{toolCallId:t,toolName:r,result:a}=e;return{type:"tool-result",toolCallId:t,toolName:r,result:a}})})}n&&!a&&s({role:"assistant",...u,type:"text",content:n||""})}}}return a}function wT(e){return"string"==typeof e?e:e instanceof ArrayBuffer?vV(new Uint8Array(e)):vV(e)}rb.z.union([rb.z.string(),rb.z.instanceof(Uint8Array),rb.z.instanceof(ArrayBuffer),rb.z.custom(e=>globalThis.Buffer?.isBuffer(e)??!1,{message:"Must be a Buffer"})]);var wE=async({url:e,downloadRetries:t})=>{let r=e.toString();try{let e=await lV(r,{method:"GET"},t);if(!e.ok)throw new tv({id:"DOWNLOAD_ASSETS_FAILED",text:"Failed to download asset",domain:"LLM",category:"USER"});return{data:new Uint8Array(await e.arrayBuffer()),mediaType:e.headers.get("content-type")??void 0}}catch(e){throw new tv({id:"DOWNLOAD_ASSETS_FAILED",text:"Failed to download asset",domain:"LLM",category:"USER"},e)}};async function wA({messages:t,downloadConcurrency:r=10,downloadRetries:a=3,supportedUrls:s}){let n=(await e.A(71972)).default,i=t.filter(e=>"user"===e.role).map(e=>e.content).filter(e=>Array.isArray(e)).flat().filter(e=>"image"===e.type||"file"===e.type).map(e=>{let t=e.mediaType??("image"===e.type?"image/*":void 0),r="image"===e.type?e.image:e.data;if("string"==typeof r)try{r=new URL(r)}catch{}return{mediaType:t,data:r}}).filter(e=>e.data instanceof URL).map(e=>({url:e.data,isUrlSupportedByModel:null!=e.mediaType&&function({mediaType:e,url:t,supportedUrls:r}){return t=t.toLowerCase(),e=e.toLowerCase(),Object.entries(r).map(([e,t])=>{let r=e.toLowerCase();return"*"===r||"*/*"===r?{mediaTypePrefix:"",regexes:t}:{mediaTypePrefix:r.replace(/\*/,""),regexes:t}}).filter(({mediaTypePrefix:t})=>e.startsWith(t)).flatMap(({regexes:e})=>e).some(e=>e.test(t))}({url:e.data.toString(),mediaType:e.mediaType,supportedUrls:s??{}})}));return Object.fromEntries((await n(i,async e=>wE({url:e.url,downloadRetries:a}),{concurrency:r})).filter(e=>e?.data!=null).map(({data:e,mediaType:t},r)=>[i?.[r]?.url.toString(),{data:e,mediaType:t}]))}function wO(e){if(!e.startsWith("data:"))return{isDataUri:!1,base64Content:e};let t=e.indexOf(",");if(-1===t)return{isDataUri:!0,base64Content:e};let r=e.substring(5,t),a=e.substring(t+1),s=r.indexOf(";");return{isDataUri:!0,mimeType:(-1!==s?r.substring(0,s):r)||void 0,base64Content:a}}function wC(e,t="application/octet-stream"){return e.startsWith("data:")?e:`data:${t};base64,${e}`}function wR(e,t){if("string"==typeof e)return e;if(e instanceof URL)return e.toString();if(e instanceof Uint8Array||e instanceof ArrayBuffer||globalThis.Buffer&&Buffer.isBuffer(e)){let r=wT(e);return t&&!r.startsWith("data:")?`data:${t};base64,${r}`:r}return String(e)}function wM(e){return e instanceof URL?e.toString():"string"==typeof e?e.length:e instanceof Uint8Array||e instanceof ArrayBuffer?e.byteLength:e}function wN(e,t){let r=wO(e),a=r.isDataUri&&r.mimeType?r.mimeType:t;return r.isDataUri?{type:"dataUri",mimeType:a,data:e}:!function(e){try{return new URL(e),!0}catch{if(e.startsWith("//"))try{return new URL(`https:${e}`),!0}catch{}return!1}}(e)?{type:"raw",mimeType:a,data:e}:{type:"url",mimeType:a,data:e}}function wj(e){return("object"==typeof e&&e&&"type"in e&&(e=e.type),"string"!=typeof e)?"unknown":"dynamic-tool"===e?"dynamic-tool":e.startsWith("tool-")?e.slice(5):e}var wP=class e{messages=[];systemMessages=[];taggedSystemMessages={};memoryInfo=null;memoryMessages=new Set;newUserMessages=new Set;newResponseMessages=new Set;userContextMessages=new Set;memoryMessagesPersisted=new Set;newUserMessagesPersisted=new Set;newResponseMessagesPersisted=new Set;userContextMessagesPersisted=new Set;generateMessageId;_agentNetworkAppend=!1;constructor({threadId:e,resourceId:t,generateMessageId:r,_agentNetworkAppend:a}={}){e&&(this.memoryInfo={threadId:e,resourceId:t}),this.generateMessageId=r,this._agentNetworkAppend=a||!1}add(e,t){if("user"===t&&(t="input"),!e)return this;for(let r of Array.isArray(e)?e:[e])this.addOne("string"==typeof r?{role:"user",content:r}:r,t);return this}getLatestUserContent(){let t=this.all.core().filter(e=>"user"===e.role),r=t.at(-1)?.content;return r?e.coreContentToString(r):null}get get(){return{all:this.all,remembered:this.remembered,input:this.input,response:this.response}}get getPersisted(){return{remembered:this.rememberedPersisted,input:this.inputPersisted,taggedSystemMessages:this.taggedSystemMessages,response:this.responsePersisted}}get clear(){return{input:{v2:()=>{let e=Array.from(this.newUserMessages);return this.messages=this.messages.filter(e=>!this.newUserMessages.has(e)),this.newUserMessages.clear(),e}},response:{v2:()=>{let e=Array.from(this.newResponseMessages);return this.messages=this.messages.filter(e=>!this.newResponseMessages.has(e)),this.newResponseMessages.clear(),e}}}}all={v3:()=>this.cleanV3Metadata(this.messages.map(this.mastraMessageV2ToMastraMessageV3)),v2:()=>this.messages,v1:()=>wk(this.all.v2()),aiV5:{model:()=>this.aiV5UIMessagesToAIV5ModelMessages(this.all.aiV5.ui()),ui:()=>this.all.v3().map(e.mastraMessageV3ToAIV5UIMessage),prompt:()=>{let e=[...this.aiV4CoreMessagesToAIV5ModelMessages([...this.systemMessages,...Object.values(this.taggedSystemMessages).flat()],"system"),...this.all.aiV5.model()];return e.length&&e[0]?.role!=="assistant"||e.unshift({role:"user",content:"."}),e},llmPrompt:async(t={downloadConcurrency:10,downloadRetries:3})=>{let r=this.all.aiV5.model(),a=this.aiV4CoreMessagesToAIV5ModelMessages([...this.systemMessages,...Object.values(this.taggedSystemMessages).flat()],"system"),s=await wA({messages:r,downloadConcurrency:t?.downloadConcurrency,downloadRetries:t?.downloadRetries,supportedUrls:t?.supportedUrls}),n=[...a,...r];return Object.keys(s||{}).length>0&&(n=n.map(e=>"user"===e.role?"string"==typeof e.content?{role:"user",content:[{type:"text",text:e.content}],providerOptions:e.providerOptions}:{role:"user",content:e.content.map(e=>"image"===e.type||"file"===e.type?function(e,t){let r,a=e.type;switch(a){case"image":r=e.image;break;case"file":r=e.data;break;default:throw Error(`Unsupported part type: ${a}`)}let{data:s,mediaType:n}=function(e){if(e instanceof Uint8Array)return{data:e,mediaType:void 0};if(e instanceof ArrayBuffer)return{data:new Uint8Array(e),mediaType:void 0};if("string"==typeof e)try{e=new URL(e)}catch{}if(e instanceof URL&&"data:"===e.protocol){let{mediaType:t,base64Content:r}=function(e){try{let[t,r]=e.split(",");return{mediaType:t?.split(";")[0]?.split(":")[1],base64Content:r}}catch{return{mediaType:void 0,base64Content:void 0}}}(e.toString());if(null==t||null==r)throw new tv({id:"INVALID_DATA_URL_FORMAT",text:`Invalid data URL format in content ${e.toString()}`,domain:"LLM",category:"USER"});return{data:r,mediaType:t}}return{data:e,mediaType:void 0}}(r),i=n??e.mediaType,o=s;if(o instanceof URL){let e=t[o.toString()];e&&(o=e.data,i??=e.mediaType)}switch(a){case"image":return(o instanceof Uint8Array||"string"==typeof o)&&(i=function({data:e,signatures:t}){var r;let a,s,n,i="string"==typeof e&&e.startsWith("SUQz")||"string"!=typeof e&&e.length>10&&73===e[0]&&68===e[1]&&51===e[2]?(n=(127&(s="string"==typeof(r=e)?(a=ww(r.replace(/-/g,"+").replace(/_/g,"/")),Uint8Array.from(a,e=>e.codePointAt(0))):r)[6])<<21|(127&s[7])<<14|(127&s[8])<<7|127&s[9],s.slice(n+10)):e;for(let e of t)if("string"==typeof i?i.startsWith(e.base64Prefix):i.length>=e.bytesPrefix.length&&e.bytesPrefix.every((e,t)=>i[t]===e))return e.mediaType}({data:o,signatures:wx})??i),{type:"file",mediaType:i??"image/*",filename:void 0,data:o,providerOptions:e.providerOptions};case"file":if(null==i)throw Error("Media type is missing for file part");return{type:"file",mediaType:i,filename:e.filename,data:o,providerOptions:e.providerOptions}}}(e,s):e).filter(e=>"text"!==e.type||""!==e.text),providerOptions:e.providerOptions}:e)),n.length&&n[0]?.role!=="assistant"||n.unshift({role:"user",content:"."}),n.map(e.aiV5ModelMessageToV2PromptMessage)}},prompt:()=>this.all.aiV4.prompt(),ui:()=>this.all.v2().map(e.mastraMessageV2ToAIV4UIMessage),core:()=>this.aiV4UIMessagesToAIV4CoreMessages(this.all.aiV4.ui()),aiV4:{ui:()=>this.all.v2().map(e.mastraMessageV2ToAIV4UIMessage),core:()=>this.aiV4UIMessagesToAIV4CoreMessages(this.all.aiV4.ui()),prompt:()=>{let e=this.all.aiV4.core(),t=[...this.systemMessages,...Object.values(this.taggedSystemMessages).flat(),...e];return t.length&&t[0]?.role!=="assistant"||t.unshift({role:"user",content:"."}),t},llmPrompt:()=>{let t=this.all.aiV4.core(),r=[...this.systemMessages,...Object.values(this.taggedSystemMessages).flat(),...t];return r.length&&r[0]?.role!=="assistant"||r.unshift({role:"user",content:"."}),r.map(e.aiV4CoreMessageToV1PromptMessage)}}};remembered={v3:()=>this.remembered.v2().map(this.mastraMessageV2ToMastraMessageV3),v2:()=>this.messages.filter(e=>this.memoryMessages.has(e)),v1:()=>wk(this.remembered.v2()),aiV5:{model:()=>this.aiV5UIMessagesToAIV5ModelMessages(this.remembered.aiV5.ui()),ui:()=>this.remembered.v3().map(e.mastraMessageV3ToAIV5UIMessage)},ui:()=>this.remembered.v2().map(e.mastraMessageV2ToAIV4UIMessage),core:()=>this.aiV4UIMessagesToAIV4CoreMessages(this.all.aiV4.ui()),aiV4:{ui:()=>this.remembered.v2().map(e.mastraMessageV2ToAIV4UIMessage),core:()=>this.aiV4UIMessagesToAIV4CoreMessages(this.all.aiV4.ui())}};rememberedPersisted={v2:()=>this.all.v2().filter(e=>this.memoryMessagesPersisted.has(e)),v1:()=>wk(this.rememberedPersisted.v2()),ui:()=>this.rememberedPersisted.v2().map(e.mastraMessageV2ToAIV4UIMessage),core:()=>this.aiV4UIMessagesToAIV4CoreMessages(this.rememberedPersisted.ui())};input={v3:()=>this.cleanV3Metadata(this.messages.filter(e=>this.newUserMessages.has(e)).map(this.mastraMessageV2ToMastraMessageV3)),v2:()=>this.messages.filter(e=>this.newUserMessages.has(e)),v1:()=>wk(this.input.v2()),aiV5:{model:()=>this.aiV5UIMessagesToAIV5ModelMessages(this.input.aiV5.ui()),ui:()=>this.input.v3().map(e.mastraMessageV3ToAIV5UIMessage)},ui:()=>this.input.v2().map(e.mastraMessageV2ToAIV4UIMessage),core:()=>this.aiV4UIMessagesToAIV4CoreMessages(this.input.ui()),aiV4:{ui:()=>this.input.v2().map(e.mastraMessageV2ToAIV4UIMessage),core:()=>this.aiV4UIMessagesToAIV4CoreMessages(this.input.aiV4.ui())}};inputPersisted={v3:()=>this.cleanV3Metadata(this.messages.filter(e=>this.newUserMessagesPersisted.has(e)).map(this.mastraMessageV2ToMastraMessageV3)),v2:()=>this.messages.filter(e=>this.newUserMessagesPersisted.has(e)),v1:()=>wk(this.inputPersisted.v2()),ui:()=>this.inputPersisted.v2().map(e.mastraMessageV2ToAIV4UIMessage),core:()=>this.aiV4UIMessagesToAIV4CoreMessages(this.inputPersisted.ui())};response={v3:()=>this.response.v2().map(this.mastraMessageV2ToMastraMessageV3),v2:()=>this.messages.filter(e=>this.newResponseMessages.has(e)),v1:()=>wk(this.response.v3().map(e.mastraMessageV3ToV2)),aiV5:{ui:()=>this.response.v3().map(e.mastraMessageV3ToAIV5UIMessage),model:()=>this.aiV5UIMessagesToAIV5ModelMessages(this.response.aiV5.ui()).filter(e=>"tool"===e.role||"assistant"===e.role),modelContent:e=>{if("number"==typeof e){let t=this.response.aiV5.ui().flatMap(e=>e.parts),r=[];if(t.forEach((e,t)=>{"step-start"===e.type&&r.push(t)}),-1===e){let e=t.filter(e=>e.type?.startsWith("tool-")),a=r.length>0;if(!a&&e.length>0){let r=e[e.length-1];if(!r)return[];let a=t.indexOf(r),s=e[e.length-2],n=s?t.indexOf(s):-1,i=t.slice(n+1,a+1);return bH(this.sanitizeV5UIMessages([{id:"last-step",role:"assistant",parts:i}])).flatMap(this.response.aiV5.stepContent)}if(1===r.length+1&&!a){let e=[{id:"last-step",role:"assistant",parts:t}];return bH(this.sanitizeV5UIMessages(e)).flatMap(this.response.aiV5.stepContent)}let s=r[r.length-1];if(void 0===s)return[];let n=t.slice(s+1);if(0===n.length)return[];let i=[{id:"last-step",role:"assistant",parts:n}];return bH(this.sanitizeV5UIMessages(i)).flatMap(this.response.aiV5.stepContent)}if(1===e){let e=r[0]??t.length;if(0===e)return[];let a=t.slice(0,e);return bH(this.sanitizeV5UIMessages([{id:"step-1",role:"assistant",parts:a}])).flatMap(this.response.aiV5.stepContent)}let a=e-2;if(a<0||a>=r.length)return[];let s=(r[a]??0)+1,n=r[a+1]??t.length;if(s>=n)return[];let i=[{id:`step-${e}`,role:"assistant",parts:t.slice(s,n)}];return bH(this.sanitizeV5UIMessages(i)).flatMap(this.response.aiV5.stepContent)}return this.response.aiV5.model().map(this.response.aiV5.stepContent).flat()},stepContent:e=>{let t=e||this.response.aiV5.model().at(-1);return t?"string"==typeof t.content?[{type:"text",text:t.content}]:t.content.map(e=>"tool-result"===e.type?{type:"tool-result",input:{},output:e.output,toolCallId:e.toolCallId,toolName:e.toolName}:"file"===e.type?{type:"file",file:new wS({data:"string"==typeof e.data?wO(e.data).base64Content:e.data instanceof URL?e.data.toString():wT(e.data),mediaType:e.mediaType})}:"image"===e.type?{type:"file",file:new wS({data:"string"==typeof e.image?wO(e.image).base64Content:e.image instanceof URL?e.image.toString():wT(e.image),mediaType:e.mediaType||"unknown"})}:{...e}):[]}},aiV4:{ui:()=>this.response.v2().map(e.mastraMessageV2ToAIV4UIMessage),core:()=>this.aiV4UIMessagesToAIV4CoreMessages(this.response.aiV4.ui())}};responsePersisted={v3:()=>this.cleanV3Metadata(this.messages.filter(e=>this.newResponseMessagesPersisted.has(e)).map(this.mastraMessageV2ToMastraMessageV3)),v2:()=>this.messages.filter(e=>this.newResponseMessagesPersisted.has(e)),ui:()=>this.responsePersisted.v2().map(e.mastraMessageV2ToAIV4UIMessage)};drainUnsavedMessages(){let e=this.messages.filter(e=>this.newUserMessages.has(e)||this.newResponseMessages.has(e));return this.newUserMessages.clear(),this.newResponseMessages.clear(),e}getEarliestUnsavedMessageTimestamp(){let e=this.messages.filter(e=>this.newUserMessages.has(e)||this.newResponseMessages.has(e));if(0!==e.length)return Math.min(...e.map(e=>new Date(e.createdAt).getTime()))}getSystemMessages(e){return e?this.taggedSystemMessages[e]||[]:this.systemMessages}addSystem(e,t){if(!e)return this;for(let r of Array.isArray(e)?e:[e])this.addOneSystem(r,t);return this}aiV4UIMessagesToAIV4CoreMessages(e){return dA(this.sanitizeAIV4UIMessages(e))}sanitizeAIV4UIMessages(e){return e.map(e=>{if(0===e.parts.length)return!1;let t=e.parts.filter(e=>"tool-invocation"!==e.type||"call"!==e.toolInvocation.state&&"partial-call"!==e.toolInvocation.state);if(!t.length)return!1;let r={...e,parts:t};return"toolInvocations"in e&&e.toolInvocations&&(r.toolInvocations=e.toolInvocations.filter(e=>"result"===e.state)),r}).filter(e=>!!e)}addOneSystem(t,r){"string"==typeof t&&(t={role:"system",content:t});let a=e.isAIV4CoreMessage(t)?t:this.aiV5ModelMessagesToAIV4CoreMessages([t],"system")[0];if("system"!==a.role)throw Error(`Expected role "system" but saw ${a.role} for message ${JSON.stringify(a,null,2)}`);r&&!this.isDuplicateSystem(a,r)?(this.taggedSystemMessages[r]||=[],this.taggedSystemMessages[r].push(a)):r||this.isDuplicateSystem(a)||this.systemMessages.push(a)}isDuplicateSystem(t,r){return r?!!this.taggedSystemMessages[r]&&this.taggedSystemMessages[r].some(r=>e.cacheKeyFromAIV4CoreMessageContent(r.content)===e.cacheKeyFromAIV4CoreMessageContent(t.content)):this.systemMessages.some(r=>e.cacheKeyFromAIV4CoreMessageContent(r.content)===e.cacheKeyFromAIV4CoreMessageContent(t.content))}static mastraMessageV2ToAIV4UIMessage(e){let t=e.content.experimental_attachments?[...e.content.experimental_attachments]:[],r="string"==typeof e.content.content&&""!==e.content.content?e.content.content:e.content.parts.reduce((e,t)=>"text"===t.type?t.text:e,""),a=[];if(e.content.parts.length)for(let r of e.content.parts)if("file"===r.type)t.push({contentType:r.mimeType,url:r.data});else if("tool-invocation"===r.type&&("call"===r.toolInvocation.state||"partial-call"===r.toolInvocation.state))continue;else if("tool-invocation"===r.type){let t={...r.toolInvocation},s=-1,n=-1;for(let t of e.content.parts)if("step-start"===t.type&&s++,"tool-invocation"===t.type&&t.toolInvocation.toolCallId===r.toolInvocation.toolCallId){n=s;break}if(n>=0){let e={step:n,...t};a.push({type:"tool-invocation",toolInvocation:e})}else a.push({type:"tool-invocation",toolInvocation:t})}else a.push(r);if(0===a.length&&t.length>0&&a.push({type:"text",text:""}),"user"===e.role){let s={id:e.id,role:e.role,content:e.content.content||r,createdAt:e.createdAt,parts:a,experimental_attachments:t};return e.content.metadata&&(s.metadata=e.content.metadata),s}if("assistant"===e.role){let t=Array.isArray(e.content.content)&&1===e.content.content.length&&"text"===e.content.content[0].type,s={id:e.id,role:e.role,content:t?r:e.content.content||r,createdAt:e.createdAt,parts:a,reasoning:void 0,toolInvocations:"toolInvocations"in e.content?e.content.toolInvocations?.filter(e=>"result"===e.state):void 0};return e.content.metadata&&(s.metadata=e.content.metadata),s}let s={id:e.id,role:e.role,content:e.content.content||r,createdAt:e.createdAt,parts:a,experimental_attachments:t};return e.content.metadata&&(s.metadata=e.content.metadata),s}getMessageById(e){return this.messages.find(t=>t.id===e)}shouldReplaceMessage(t){if(!this.messages.length||!("id"in t)||!t?.id)return{exists:!1};let r=this.getMessageById(t.id);return r?{exists:!0,shouldReplace:!e.messagesAreEqual(r,t),id:r.id}:{exists:!1}}addOne(t,r){if((!("content"in t)||!t.content&&"string"!=typeof t.content)&&(!("parts"in t)||!t.parts))throw new tv({id:"INVALID_MESSAGE_CONTENT",domain:"AGENT",category:"USER",text:`Message with role "${t.role}" must have either a 'content' property (string or array) or a 'parts' property (array) that is not empty, null, or undefined. Received message: ${JSON.stringify(t,null,2)}`,details:{role:t.role,messageSource:r,hasContent:"content"in t,hasParts:"parts"in t}});if("system"===t.role){if("memory"===r)return null;if(e.isAIV4CoreMessage(t)||e.isAIV5CoreMessage(t))return this.addSystem(t);throw new tv({id:"INVALID_SYSTEM_MESSAGE_FORMAT",domain:"AGENT",category:"USER",text:"Invalid system message format. System messages must be CoreMessage format with 'role' and 'content' properties. The content should be a string or valid content array.",details:{messageSource:r,receivedMessage:JSON.stringify(t,null,2)}})}let a=this.inputToMastraMessageV2(t,r),{exists:s,shouldReplace:n,id:i}=this.shouldReplaceMessage(a),o=this.messages.at(-1);if("memory"===r){for(let t of this.messages)if(e.messagesAreEqual(t,a))return}let l=o?.role==="assistant"&&"assistant"===a.role&&o.threadId===a.threadId&&"memory"!==r,u=this._agentNetworkAppend&&o&&!this.memoryMessages.has(o)||!this._agentNetworkAppend;if(l&&u){o.createdAt=a.createdAt||o.createdAt;let e=new Map,t=new Map;for(let[r,s]of a.content.parts.entries())if("tool-invocation"===s.type){let a=[...o.content.parts].reverse().find(e=>"tool-invocation"===e.type&&e.toolInvocation.toolCallId===s.toolInvocation.toolCallId);if(a&&"tool-invocation"===a.type){if("result"===s.toolInvocation.state){a.toolInvocation={...a.toolInvocation,step:s.toolInvocation.step,state:"result",result:s.toolInvocation.result,args:{...a.toolInvocation.args,...s.toolInvocation.args}},o.content.toolInvocations||(o.content.toolInvocations=[]);let e=o.content.toolInvocations.findIndex(e=>e.toolCallId===a.toolInvocation.toolCallId);-1===e?o.content.toolInvocations.push(a.toolInvocation):o.content.toolInvocations[e]=a.toolInvocation}let t=o.content.parts.findIndex(e=>e===a);e.set(r,t)}else t.set(r,s)}else t.set(r,s);this.addPartsToLatestMessage({latestMessage:o,messageV2:a,anchorMap:e,partsToAdd:t}),o.createdAt.getTime()<a.createdAt.getTime()&&(o.createdAt=a.createdAt),!o.content.content&&a.content.content&&(o.content.content=a.content.content),o.content.content&&a.content.content&&o.content.content!==a.content.content&&(o.content.content=a.content.content),this.pushMessageToSource(o,r)}else{let e=-1;n&&(e=this.messages.findIndex(e=>e.id===i));let t=-1!==e&&this.messages[e];n&&t?this.messages[e]=a:s||this.messages.push(a),this.pushMessageToSource(a,r)}return this.messages.sort((e,t)=>e.createdAt.getTime()-t.createdAt.getTime()),this}pushMessageToSource(e,t){if("memory"===t)this.memoryMessages.add(e),this.memoryMessagesPersisted.add(e);else if("response"===t)this.newResponseMessages.add(e),this.newResponseMessagesPersisted.add(e);else if("input"===t)this.newUserMessages.add(e),this.newUserMessagesPersisted.add(e);else if("context"===t)this.userContextMessages.add(e),this.userContextMessagesPersisted.add(e);else throw Error(`Missing message source for message ${e}`)}pushNewMessagePart({latestMessage:t,newMessage:r,part:a,insertAt:s}){let n=e.cacheKeyFromAIV4Parts([a]);if(t.content.parts.filter(t=>e.cacheKeyFromAIV4Parts([t])===n).length<r.content.parts.filter(t=>e.cacheKeyFromAIV4Parts([t])===n).length){let e=r.content.parts.indexOf(a),n=e>0&&r.content.parts[e-1]?.type==="step-start",i="assistant"===t.role&&"text"===a.type&&!n&&t.content.parts.length>0&&t.content.parts.at(-1)?.type==="tool-invocation";"number"==typeof s?i?(t.content.parts.splice(s,0,{type:"step-start"}),t.content.parts.splice(s+1,0,a)):t.content.parts.splice(s,0,a):(i&&t.content.parts.push({type:"step-start"}),t.content.parts.push(a))}}addPartsToLatestMessage({latestMessage:t,messageV2:r,anchorMap:a,partsToAdd:s}){for(let n=0;n<r.content.parts.length;++n){let i=r.content.parts[n];if(!i)continue;let o=e.cacheKeyFromAIV4Parts([i]),l=s.get(n);if(o&&l)if(a.size>0){if(a.has(n))continue;let s=[...a.keys()].filter(e=>e<n).pop()??-1,o=[...a.keys()].find(e=>e>n)??-1,l=(-1!==s?a.get(s):0)+(-1===s?n:n-s),u=-1!==o?a.get(o):t.content.parts.length;if(l>=0&&l<=u&&!t.content.parts.slice(l,u).some(t=>e.cacheKeyFromAIV4Parts([t])===e.cacheKeyFromAIV4Parts([i])))for(let[e,s]of(this.pushNewMessagePart({latestMessage:t,newMessage:r,part:i,insertAt:l}),a.entries()))s>=l&&a.set(e,s+1)}else this.pushNewMessagePart({latestMessage:t,newMessage:r,part:i})}}inputToMastraMessageV2(t,r){if("memory"!==r&&"threadId"in t&&t.threadId&&this.memoryInfo&&t.threadId!==this.memoryInfo.threadId)throw Error(`Received input message with wrong threadId. Input ${t.threadId}, expected ${this.memoryInfo.threadId}`);if("resourceId"in t&&t.resourceId&&this.memoryInfo?.resourceId&&t.resourceId!==this.memoryInfo.resourceId)throw Error(`Received input message with wrong resourceId. Input ${t.resourceId}, expected ${this.memoryInfo.resourceId}`);if(e.isMastraMessageV1(t))return this.mastraMessageV1ToMastraMessageV2(t,r);if(e.isMastraMessageV2(t))return this.hydrateMastraMessageV2Fields(t);if(e.isAIV4CoreMessage(t))return this.aiV4CoreMessageToMastraMessageV2(t,r);if(e.isAIV4UIMessage(t))return this.aiV4UIMessageToMastraMessageV2(t,r);if(e.isAIV5CoreMessage(t))return e.mastraMessageV3ToV2(this.aiV5ModelMessageToMastraMessageV3(t,r));if(e.isAIV5UIMessage(t))return e.mastraMessageV3ToV2(this.aiV5UIMessageToMastraMessageV3(t,r));if(e.isMastraMessageV3(t))return e.mastraMessageV3ToV2(this.hydrateMastraMessageV3Fields(t));throw Error(`Found unhandled message ${JSON.stringify(t)}`)}lastCreatedAt;generateCreatedAt(e,t){if((t=t instanceof Date?t:t?new Date(t):void 0)&&!this.lastCreatedAt)return this.lastCreatedAt=t.getTime(),t;if(t&&"memory"===e)return t;let r=new Date,a=t?.getTime()||r.getTime(),s=this.messages.reduce((e,t)=>t.createdAt.getTime()>e?t.createdAt.getTime():e,this.lastCreatedAt||0);if(a<=s){let e=new Date(s+1);return this.lastCreatedAt=e.getTime(),e}return this.lastCreatedAt=a,r}newMessageId(){return this.generateMessageId?this.generateMessageId():(0,ri.randomUUID)()}mastraMessageV1ToMastraMessageV2(e,t){let r=this.aiV4CoreMessageToMastraMessageV2({content:e.content,role:e.role},t);return{id:e.id,role:r.role,createdAt:this.generateCreatedAt(t,e.createdAt),threadId:e.threadId,resourceId:e.resourceId,content:r.content}}hydrateMastraMessageV3Fields(e){return e.createdAt instanceof Date||(e.createdAt=new Date(e.createdAt)),e}hydrateMastraMessageV2Fields(e){return e.createdAt instanceof Date||(e.createdAt=new Date(e.createdAt)),e.content.toolInvocations&&e.content.parts&&(e.content.toolInvocations=e.content.toolInvocations.map(t=>{if(!t.args||0===Object.keys(t.args).length){let r=e.content.parts.find(e=>"tool-invocation"===e.type&&e.toolInvocation&&e.toolInvocation.toolCallId===t.toolCallId&&e.toolInvocation.args&&Object.keys(e.toolInvocation.args).length>0);if(r&&"tool-invocation"===r.type)return{...t,args:r.toolInvocation.args}}return t})),e}aiV4UIMessageToMastraMessageV2(t,r){let a={format:2,parts:t.parts};return t.toolInvocations&&(a.toolInvocations=t.toolInvocations),t.reasoning&&(a.reasoning=t.reasoning),t.annotations&&(a.annotations=t.annotations),t.experimental_attachments&&(a.experimental_attachments=t.experimental_attachments),"metadata"in t&&null!==t.metadata&&void 0!==t.metadata&&(a.metadata=t.metadata),{id:t.id||this.newMessageId(),role:e.getRole(t),createdAt:this.generateCreatedAt(r,t.createdAt),threadId:this.memoryInfo?.threadId,resourceId:this.memoryInfo?.resourceId,content:a}}aiV4CoreMessageToMastraMessageV2(t,r){let a="id"in t?t.id:this.newMessageId(),s=[],n=[],i=[],o="response"===r&&Array.isArray(t.content)&&1===t.content.length&&t.content[0]&&"text"===t.content[0].type&&"text"in t.content[0]&&t.content[0].text;if(o&&"response"===r&&(t.content=o),"string"==typeof t.content)s.push({type:"text",text:t.content});else if(Array.isArray(t.content))for(let e of t.content)switch(e.type){case"text":let r=s.at(-1);"assistant"===t.role&&r&&"tool-invocation"===r.type&&s.push({type:"step-start"}),s.push({type:"text",text:e.text});break;case"tool-call":s.push({type:"tool-invocation",toolInvocation:{state:"call",toolCallId:e.toolCallId,toolName:e.toolName,args:e.args}});break;case"tool-result":let a={},n=t.content.find(t=>"tool-call"===t.type&&t.toolCallId===e.toolCallId);if(n&&"tool-call"===n.type&&(a=n.args),0===Object.keys(a).length)for(let t=this.messages.length-1;t>=0;t--){let r=this.messages[t];if(r&&"assistant"===r.role&&r.content.parts){let t=r.content.parts.find(t=>"tool-invocation"===t.type&&t.toolInvocation.toolCallId===e.toolCallId&&"call"===t.toolInvocation.state);if(t&&"tool-invocation"===t.type&&t.toolInvocation.args){a=t.toolInvocation.args;break}}}let o={state:"result",toolCallId:e.toolCallId,toolName:e.toolName,result:e.result??"",args:a};s.push({type:"tool-invocation",toolInvocation:o}),i.push(o);break;case"reasoning":s.push({type:"reasoning",reasoning:"",details:[{type:"text",text:e.text,signature:e.signature}]});break;case"redacted-reasoning":s.push({type:"reasoning",reasoning:"",details:[{type:"redacted",data:e.data}]});break;case"image":s.push({type:"file",data:wR(e.image),mimeType:e.mimeType});break;case"file":if(e.data instanceof URL)s.push({type:"file",data:e.data.toString(),mimeType:e.mimeType});else if("string"==typeof e.data){let t=wN(e.data,e.mimeType);if("url"===t.type||"dataUri"===t.type)s.push({type:"file",data:e.data,mimeType:t.mimeType||"image/png"});else try{s.push({type:"file",mimeType:t.mimeType||"image/png",data:wT(e.data)})}catch(e){console.error(`Failed to convert binary data to base64 in CoreMessage file part: ${e}`,e)}}else try{s.push({type:"file",mimeType:e.mimeType,data:wT(e.data)})}catch(e){console.error(`Failed to convert binary data to base64 in CoreMessage file part: ${e}`,e)}}let l={format:2,parts:s};return i.length&&(l.toolInvocations=i),"string"==typeof t.content&&(l.content=t.content),n.length&&(l.experimental_attachments=n),{id:a,role:e.getRole(t),createdAt:this.generateCreatedAt(r),threadId:this.memoryInfo?.threadId,resourceId:this.memoryInfo?.resourceId,content:l}}static isAIV4UIMessage(t){return!e.isMastraMessage(t)&&!e.isAIV4CoreMessage(t)&&"parts"in t&&!e.hasAIV5UIMessageCharacteristics(t)}static isAIV5CoreMessage(t){return!e.isMastraMessage(t)&&!("parts"in t)&&"content"in t&&e.hasAIV5CoreMessageCharacteristics(t)}static isAIV4CoreMessage(t){return!e.isMastraMessage(t)&&!("parts"in t)&&"content"in t&&!e.hasAIV5CoreMessageCharacteristics(t)}static isMastraMessage(t){return e.isMastraMessageV3(t)||e.isMastraMessageV2(t)||e.isMastraMessageV1(t)}static isMastraMessageV1(t){return!e.isMastraMessageV2(t)&&!e.isMastraMessageV3(t)&&("threadId"in t||"resourceId"in t)}static isMastraMessageV2(e){return!!("content"in e&&e.content&&!Array.isArray(e.content)&&"string"!=typeof e.content&&"format"in e.content&&2===e.content.format)}static isMastraMessageV3(e){return!!("content"in e&&e.content&&!Array.isArray(e.content)&&"string"!=typeof e.content&&"format"in e.content&&3===e.content.format)}static getRole(e){if("assistant"===e.role||"tool"===e.role)return"assistant";if("user"===e.role)return"user";if("system"===e.role)return"system";throw Error(`BUG: add handling for message role ${e.role} in message ${JSON.stringify(e,null,2)}`)}static cacheKeyFromAIV4Parts(e){let t="";for(let r of e)t+=r.type,"text"===r.type&&(t+=r.text),"tool-invocation"===r.type&&(t+=r.toolInvocation.toolCallId,t+=r.toolInvocation.state),"reasoning"===r.type&&(t+=r.reasoning,t+=r.details.reduce((e,t)=>"text"===t.type?e+t.text.length+(t.signature?.length||0):e,0)),"file"===r.type&&(t+=r.data,t+=r.mimeType);return t}static coreContentToString(e){return"string"==typeof e?e:e.reduce((e,t)=>("text"===t.type&&(e+=t.text),e),"")}static cacheKeyFromAIV4CoreMessageContent(e){if("string"==typeof e)return e;let t="";for(let r of e)t+=r.type,"text"===r.type&&(t+=r.text.length),"reasoning"===r.type&&(t+=r.text.length),"tool-call"===r.type&&(t+=r.toolCallId,t+=r.toolName),"tool-result"===r.type&&(t+=r.toolCallId,t+=r.toolName),"file"===r.type&&(t+=r.filename,t+=r.mimeType),"image"===r.type&&(t+=wM(r.image),t+=r.mimeType),"redacted-reasoning"===r.type&&(t+=r.data.length);return t}static messagesAreEqual(t,r){let a=e.isAIV4UIMessage(t)&&t,s=e.isAIV4UIMessage(r)&&r;if(a&&!s)return!1;if(a&&s)return e.cacheKeyFromAIV4Parts(t.parts)===e.cacheKeyFromAIV4Parts(r.parts);let n=e.isAIV4CoreMessage(t)&&t,i=e.isAIV4CoreMessage(r)&&r;if(n&&!i)return!1;if(n&&i)return e.cacheKeyFromAIV4CoreMessageContent(n.content)===e.cacheKeyFromAIV4CoreMessageContent(i.content);let o=e.isMastraMessageV1(t)&&t,l=e.isMastraMessageV1(r)&&r;if(o&&!l)return!1;if(o&&l)return o.id===l.id&&e.cacheKeyFromAIV4CoreMessageContent(o.content)===e.cacheKeyFromAIV4CoreMessageContent(l.content);let u=e.isMastraMessageV2(t)&&t,d=e.isMastraMessageV2(r)&&r;if(u&&!d)return!1;if(u&&d)return u.id===d.id&&e.cacheKeyFromAIV4Parts(u.content.parts)===e.cacheKeyFromAIV4Parts(d.content.parts);let p=e.isMastraMessageV3(t)&&t,c=e.isMastraMessageV3(r)&&r;if(p&&!c)return!1;if(p&&c)return p.id===c.id&&e.cacheKeyFromAIV5Parts(p.content.parts)===e.cacheKeyFromAIV5Parts(c.content.parts);let h=e.isAIV5UIMessage(t)&&t,m=e.isAIV5UIMessage(r)&&r;if(h&&!m)return!1;if(h&&m)return e.cacheKeyFromAIV5Parts(t.parts)===e.cacheKeyFromAIV5Parts(r.parts);let g=e.isAIV5CoreMessage(t)&&t,f=e.isAIV5CoreMessage(r)&&r;return(!g||!!f)&&(!g||!f||e.cacheKeyFromAIV5ModelMessageContent(g.content)===e.cacheKeyFromAIV5ModelMessageContent(f.content))}cleanV3Metadata(e){return e.map(e=>{if(!e.content.metadata||"object"!=typeof e.content.metadata)return e;let t={...e.content.metadata};if(!("__originalContent"in t)&&!("__originalExperimentalAttachments"in t))return e;let{__originalContent:r,__originalExperimentalAttachments:a,...s}=t;if(0===Object.keys(s).length){let{metadata:t,...r}=e.content;return{...e,content:r}}return{...e,content:{...e.content,metadata:s}}})}static aiV4CoreMessageToV1PromptMessage(e){if("system"===e.role)return e;if("string"==typeof e.content&&("assistant"===e.role||"user"===e.role))return{...e,content:[{type:"text",text:e.content}]};if("string"==typeof e.content)throw Error(`Saw text content for input CoreMessage, but the role is ${e.role}. This is only allowed for "system", "assistant", and "user" roles.`);let t={user:[],assistant:[],tool:[]},r=e.role;for(let a of e.content){let e=`Saw incompatible message content part type ${a.type} for message role ${r}`;switch(a.type){case"text":if("tool"===r)throw Error(e);t[r].push(a);break;case"redacted-reasoning":case"reasoning":if("assistant"!==r)throw Error(e);t[r].push(a);break;case"tool-call":if("tool"===r||"user"===r)throw Error(e);t[r].push(a);break;case"tool-result":if("assistant"===r||"user"===r)throw Error(e);t[r].push(a);break;case"image":if("tool"===r||"assistant"===r)throw Error(e);t[r].push({...a,image:a.image instanceof URL||a.image instanceof Uint8Array?a.image:Buffer.isBuffer(a.image)||a.image instanceof ArrayBuffer?new Uint8Array(a.image):new URL(a.image)});break;case"file":if("tool"===r)throw Error(e);t[r].push({...a,data:a.data instanceof URL||"string"==typeof a.data?a.data:wT(a.data)})}}if("tool"===r||"user"===r||"assistant"===r)return{...e,content:t[r]};throw Error(`Encountered unknown role ${r} when converting V4 CoreMessage -> V4 LanguageModelV1Prompt, input message: ${JSON.stringify(e,null,2)}`)}static aiV5ModelMessageToV2PromptMessage(e){if("system"===e.role)return e;if("string"==typeof e.content&&("assistant"===e.role||"user"===e.role))return{role:e.role,content:[{type:"text",text:e.content}],providerOptions:e.providerOptions};if("string"==typeof e.content)throw Error(`Saw text content for input ModelMessage, but the role is ${e.role}. This is only allowed for "system", "assistant", and "user" roles.`);let t={user:[],assistant:[],tool:[]},r=e.role;for(let a of e.content){let e=`Saw incompatible message content part type ${a.type} for message role ${r}`;switch(a.type){case"text":if("tool"===r)throw Error(e);t[r].push(a);break;case"reasoning":if("tool"===r||"user"===r)throw Error(e);t[r].push(a);break;case"tool-call":if("assistant"!==r)throw Error(e);t[r].push(a);break;case"tool-result":if("assistant"===r||"user"===r)throw Error(e);t[r].push(a);break;case"file":if("tool"===r)throw Error(e);t[r].push({...a,data:a.data instanceof ArrayBuffer?new Uint8Array(a.data):a.data});break;case"image":if("tool"===r)throw Error(e);t[r].push({...a,mediaType:a.mediaType||"image/unknown",type:"file",data:a.image instanceof ArrayBuffer?new Uint8Array(a.image):a.image})}}if("tool"===r||"user"===r||"assistant"===r)return{...e,content:t[r]};throw Error(`Encountered unknown role ${r} when converting V5 ModelMessage -> V5 LanguageModelV2Message, input message: ${JSON.stringify(e,null,2)}`)}static mastraMessageV3ToV2(e){let t,r=e.content.parts.filter(e=>bK(e)),a=e.content.metadata?.__hadToolInvocations===!0;r.length>0?t=r.map(e=>{let t=wj(e);return"output-available"===e.state?{args:e.input,result:"object"==typeof e.output&&e.output&&"value"in e.output?e.output.value:e.output,toolCallId:e.toolCallId,toolName:t,state:"result"}:{args:e.input,state:"call",toolName:t,toolCallId:e.toolCallId}}):a&&"assistant"===e.role&&(t=[]);let s=new Set(e.content.metadata?.__attachmentUrls||[]),n={id:e.id,resourceId:e.resourceId,threadId:e.threadId,createdAt:e.createdAt,role:e.role,content:{format:2,parts:e.content.parts.map(e=>{if(bK(e)||"dynamic-tool"===e.type){let t=wj(e),r={state:e.state,args:e.input,toolCallId:e.toolCallId,toolName:t};return"output-available"===e.state?{type:"tool-invocation",toolInvocation:{...r,state:"result",result:"object"==typeof e.output&&e.output&&"value"in e.output?e.output.value:e.output},providerMetadata:e.callProviderMetadata}:{type:"tool-invocation",toolInvocation:{...r,state:"input-available"===e.state?"call":"partial-call"}}}switch(e.type){case"text":case"step-start":return e;case"file":{let t="url"in e&&"string"==typeof e.url?e.url:"data"in e&&"string"==typeof e.data?e.data:void 0;if(!t||s.has(t))return null;return{type:"file",mimeType:e.mediaType,data:t,providerMetadata:e.providerMetadata}}case"reasoning":if(""===e.text)break;return{type:"reasoning",reasoning:e.text,details:[{type:"text",text:e.text}],providerMetadata:e.providerMetadata};case"source-url":return{type:"source",source:{url:e.url,id:e.sourceId,sourceType:"url"},providerMetadata:e.providerMetadata}}return null}).filter(e=>!!e)}};if(void 0!==t&&(n.content.toolInvocations=t),e.content.metadata){let{__originalContent:t,__originalExperimentalAttachments:r,__attachmentUrls:a,...s}=e.content.metadata;n.content.metadata=s}let i=e.content.metadata?.__originalContent;if(void 0!==i){let e=n.content.parts.every(e=>"step-start"===e.type||"text"===e.type);("string"==typeof i||e)&&(n.content.content=i)}let o=e.content.metadata?.__originalExperimentalAttachments;o&&Array.isArray(o)&&(n.content.experimental_attachments=o||[]);let l=Array.isArray(e.content.metadata?.__originalContent)&&e.content.metadata?.__originalContent.some(e=>"file"===e.type)?[]:n.content.parts.filter(e=>"file"===e.type&&"string"==typeof e.data&&(e.data.startsWith("http://")||e.data.startsWith("https://"))&&!e.providerMetadata);if(l.length>0){for(let e of(n.content.experimental_attachments||(n.content.experimental_attachments=[]),l))"file"===e.type&&n.content.experimental_attachments.push({url:e.data,contentType:e.mimeType});n.content.parts=n.content.parts.filter(e=>!("file"===e.type&&"string"==typeof e.data&&(e.data.startsWith("http://")||e.data.startsWith("https://"))&&!e.providerMetadata))}if(t&&t.length>0){let e=t.filter(e=>"result"===e.state);e.length>0&&(n.content.toolInvocations=e)}return e.type&&(n.type=e.type),n}mastraMessageV2ToMastraMessageV3(e){let t=[],r={id:e.id,content:{format:3,parts:t},role:e.role,createdAt:e.createdAt instanceof Date?e.createdAt:new Date(e.createdAt),resourceId:e.resourceId,threadId:e.threadId,type:e.type};e.content.metadata&&(r.content.metadata={...e.content.metadata}),void 0!==e.content.content&&(r.content.metadata={...r.content.metadata||{},__originalContent:e.content.content}),void 0!==e.content.experimental_attachments&&(r.content.metadata={...r.content.metadata||{},__originalExperimentalAttachments:e.content.experimental_attachments});let a=new Set;for(let r of e.content.parts)switch(r.type){case"step-start":case"text":t.push(r);break;case"tool-invocation":"result"===r.toolInvocation.state?t.push({type:`tool-${r.toolInvocation.toolName}`,toolCallId:r.toolInvocation.toolCallId,state:"output-available",input:r.toolInvocation.args,output:r.toolInvocation.result,callProviderMetadata:r.providerMetadata}):t.push({type:`tool-${r.toolInvocation.toolName}`,toolCallId:r.toolInvocation.toolCallId,state:"call"===r.toolInvocation.state?"input-available":"input-streaming",input:r.toolInvocation.args});break;case"source":t.push({type:"source-url",sourceId:r.source.id,url:r.source.url,title:r.source.title,providerMetadata:r.source.providerMetadata||r.providerMetadata});break;case"reasoning":let e=r.reasoning||(r.details?.reduce((e,t)=>"text"===t.type?e+t.text:e,"")??"");(e||r.details?.length)&&t.push({type:"reasoning",text:e||"",state:"done",providerMetadata:r.providerMetadata});break;case"file":{let e="string"==typeof r.data?wN(r.data,r.mimeType):{type:"raw",mimeType:r.mimeType};if("url"===e.type&&"string"==typeof r.data)t.push({type:"file",url:r.data,mediaType:e.mimeType||"image/png",providerMetadata:r.providerMetadata}),a.add(r.data);else{let e,a,s=r.mimeType;if("string"==typeof r.data){let t=wO(r.data);t.isDataUri?(e=t.base64Content,t.mimeType&&(s=s||t.mimeType)):e=r.data}else e=r.data;let n=s||"image/png";a="string"==typeof e&&e.startsWith("data:")?e:wC(e,n),t.push({type:"file",url:a,mediaType:n,providerMetadata:r.providerMetadata})}a.add(r.data)}}e.content.content&&!r.content.parts?.some(e=>"text"===e.type)&&r.content.parts.push({type:"text",text:e.content.content});let s=[];if(e.content.experimental_attachments?.length)for(let r of e.content.experimental_attachments)a.has(r.url)||(s.push(r.url),t.push({url:r.url,mediaType:r.contentType||"unknown",type:"file"}));return s.length>0&&(r.content.metadata={...r.content.metadata||{},__attachmentUrls:s}),r}aiV5UIMessagesToAIV5ModelMessages(e){return bH(this.addStartStepPartsForAIV5(this.sanitizeV5UIMessages(e)))}addStartStepPartsForAIV5(e){for(let t of e)if("assistant"===t.role)for(let[e,r]of t.parts.entries())bK(r)&&t.parts.at(e+1)?.type!=="step-start"&&t.parts.splice(e+1,0,{type:"step-start"});return e}sanitizeV5UIMessages(e){return e.map(e=>{if(0===e.parts.length)return!1;let t=e.parts.filter(e=>!bK(e)||"output-available"===e.state||"output-error"===e.state);return!!t.length&&{...e,parts:t.map(e=>bK(e)&&"output-available"===e.state?{...e,output:"object"==typeof e.output&&e.output&&"value"in e.output?e.output.value:e.output}:e)}}).filter(e=>!!e)}static mastraMessageV3ToAIV5UIMessage(e){let t={...e.content.metadata||{}};e.createdAt&&(t.createdAt=e.createdAt),e.threadId&&(t.threadId=e.threadId),e.resourceId&&(t.resourceId=e.resourceId);let r=e.content.parts;return{id:e.id,role:e.role,metadata:t,parts:r}}aiV5ModelMessagesToAIV4CoreMessages(t,r){let a=t.map(e=>this.aiV5ModelMessageToMastraMessageV3(e,r)).map(e.mastraMessageV3ToV2).map(e.mastraMessageV2ToAIV4UIMessage);return this.aiV4UIMessagesToAIV4CoreMessages(a)}aiV4CoreMessagesToAIV5ModelMessages(t,r){return this.aiV5UIMessagesToAIV5ModelMessages(t.map(e=>this.aiV4CoreMessageToMastraMessageV2(e,r)).map(e=>this.mastraMessageV2ToMastraMessageV3(e)).map(t=>e.mastraMessageV3ToAIV5UIMessage(t)))}aiV5UIMessageToMastraMessageV3(t,r){let a={format:3,parts:t.parts,metadata:t.metadata},s=t.metadata,n="createdAt"in t&&t.createdAt instanceof Date?t.createdAt:s&&"createdAt"in s&&s.createdAt instanceof Date?s.createdAt:void 0;return"metadata"in t&&t.metadata&&(a.metadata={...t.metadata}),{id:t.id||this.newMessageId(),role:e.getRole(t),createdAt:this.generateCreatedAt(r,n),threadId:this.memoryInfo?.threadId,resourceId:this.memoryInfo?.resourceId,content:a}}aiV5ModelMessageToMastraMessageV3(t,r){let a="id"in t&&"string"==typeof t.id?t.id:this.newMessageId(),s=[];if("string"==typeof t.content)s.push({type:"text",text:t.content});else if(Array.isArray(t.content))for(let e of t.content)switch(e.type){case"text":let r=s.at(-1);"assistant"===t.role&&r&&bK(r)&&"output-available"===r.state&&s.push({type:"step-start"}),s.push({type:"text",text:e.text,providerMetadata:e.providerOptions});break;case"tool-call":s.push({type:`tool-${e.toolName}`,state:"input-available",toolCallId:e.toolCallId,input:e.input});break;case"tool-result":s.push({type:`tool-${e.toolName}`,state:"output-available",toolCallId:e.toolCallId,output:"string"==typeof e.output?{type:"text",value:e.output}:e.output??{type:"text",value:""},input:{},callProviderMetadata:e.providerOptions});break;case"reasoning":s.push({type:"reasoning",text:e.text,providerMetadata:e.providerOptions});break;case"image":{let t,r=e.mediaType,a=function(e,t="image/png"){let r=wR(e,t);return r.startsWith("data:")||r.startsWith("http://")||r.startsWith("https://")?r:`data:${t};base64,${r}`}(e.image,r||"image/png"),n=wO(a);if(n.isDataUri)t=n.base64Content,!r&&n.mimeType&&(r=n.mimeType);else if(a.startsWith("http://")||a.startsWith("https://")){s.push({type:"file",url:a,mediaType:e.mediaType||"image/jpeg",providerMetadata:e.providerOptions});break}else t=a;let i=r||"image/jpeg",o=t.startsWith("data:")?t:wC(t,i);s.push({type:"file",url:o,mediaType:i,providerMetadata:e.providerOptions});break}case"file":if(e.data instanceof URL){let t=e.data.toString(),r=e.mediaType,a=wO(t);if(a.isDataUri)if(!r&&a.mimeType&&(r=a.mimeType),a.base64Content!==t){let t=wC(a.base64Content,r||"image/png");s.push({type:"file",url:t,mediaType:r||"image/png",providerMetadata:e.providerOptions})}else s.push({type:"file",url:t,mediaType:e.mediaType||"image/png",providerMetadata:e.providerOptions});else s.push({type:"file",url:t,mediaType:e.mediaType||"application/octet-stream",providerMetadata:e.providerOptions})}else if("string"==typeof e.data){let t=wN(e.data,e.mediaType);if("url"===t.type||"dataUri"===t.type)s.push({type:"file",url:e.data,mediaType:t.mimeType||"application/octet-stream",providerMetadata:e.providerOptions});else try{let r=wT(e.data),a=wC(r,t.mimeType||"image/png");s.push({type:"file",url:a,mediaType:t.mimeType||"image/png",providerMetadata:e.providerOptions})}catch(e){console.error(`Failed to convert binary data to base64 in CoreMessage file part: ${e}`,e)}}else try{let t=wT(e.data),r=wC(t,e.mediaType||"image/png");s.push({type:"file",url:r,mediaType:e.mediaType||"image/png",providerMetadata:e.providerOptions})}catch(e){console.error(`Failed to convert binary data to base64 in CoreMessage file part: ${e}`,e)}}let n={format:3,parts:s};return t.content&&(n.metadata={...n.metadata||{},__originalContent:t.content}),{id:a,role:e.getRole(t),createdAt:this.generateCreatedAt(r),threadId:this.memoryInfo?.threadId,resourceId:this.memoryInfo?.resourceId,content:n}}static hasAIV5UIMessageCharacteristics(e){if("toolInvocations"in e||"reasoning"in e||"experimental_attachments"in e||"data"in e||"annotations"in e||!e.parts)return!1;for(let t of e.parts){if("metadata"in t)return!0;if("toolInvocation"in t)break;if("toolCallId"in t)return!0;if("source"===t.type)break;if("source-url"===t.type)return!0;if("reasoning"===t.type){if("state"in t||"text"in t)return!0;if("reasoning"in t||"details"in t)break}if("file"===t.type&&"mediaType"in t)return!0}return!1}static isAIV5UIMessage(t){return!e.isMastraMessage(t)&&!e.isAIV5CoreMessage(t)&&"parts"in t&&e.hasAIV5UIMessageCharacteristics(t)}static hasAIV5CoreMessageCharacteristics(e){if("experimental_providerMetadata"in e||"string"==typeof e.content)return!1;for(let t of e.content){if("tool-result"===t.type&&"output"in t||"tool-call"===t.type&&"input"in t)return!0;if("tool-result"===t.type&&"result"in t||"tool-call"===t.type&&"args"in t)break;if("mediaType"in t)return!0;if("mimeType"in t||"experimental_providerMetadata"in t||"reasoning"===t.type&&"signature"in t||"redacted-reasoning"===t.type)break}return!1}static cacheKeyFromAIV5Parts(e){let t="";for(let r of e)t+=r.type,"text"===r.type&&(t+=r.text),(bK(r)||"dynamic-tool"===r.type)&&(t+=r.toolCallId,t+=r.state),"reasoning"===r.type&&(t+=r.text),"file"===r.type&&(t+=r.url.length,t+=r.mediaType,t+=r.filename||"");return t}static cacheKeyFromAIV5ModelMessageContent(e){if("string"==typeof e)return e;let t="";for(let r of e)t+=r.type,"text"===r.type&&(t+=r.text.length),"reasoning"===r.type&&(t+=r.text.length),"tool-call"===r.type&&(t+=r.toolCallId,t+=r.toolName),"tool-result"===r.type&&(t+=r.toolCallId,t+=r.toolName),"file"===r.type&&(t+=r.filename,t+=r.mediaType),"image"===r.type&&(t+=wM(r.image),t+=r.mediaType);return t}},w$=((w=w$||{}).ON_EVALUATION="onEvaluation",w.ON_GENERATION="onGeneration",w.ON_SCORER_RUN="onScorerRun",w),wD={all:_=_||new Map,on(e,t){let r=_.get(e);r?r.push(t):_.set(e,[t])},off(e,t){let r=_.get(e);r&&(t?r.splice(r.indexOf(t)>>>0,1):_.set(e,[]))},emit(e,t){let r=_.get(e);r&&r.slice().map(e=>{e(t)}),(r=_.get("*"))&&r.slice().map(r=>{r(e,t)})}};function wL(e,t){setImmediate(()=>{wD.emit(e,t)})}var wU=e.i(427699),wz=re,wq="vercel.ai.error",wV=Symbol.for(wq),wF=class e extends Error{constructor({name:e,message:t,cause:r}){super(t),this[eQ]=!0,this.name=e,this.cause=r}static isInstance(t){return e.hasMarker(t,wq)}static hasMarker(e,t){let r=Symbol.for(t);return null!=e&&"object"==typeof e&&r in e&&"boolean"==typeof e[r]&&!0===e[r]}};eQ=wV;var wZ=wF;function wW(e){return null==e?"unknown error":"string"==typeof e?e:e instanceof Error?e.message:JSON.stringify(e)}Symbol.for("vercel.ai.error.AI_APICallError"),Symbol.for("vercel.ai.error.AI_EmptyResponseBodyError"),Symbol.for("vercel.ai.error.AI_InvalidArgumentError"),Symbol.for("vercel.ai.error.AI_InvalidPromptError"),Symbol.for("vercel.ai.error.AI_InvalidResponseDataError"),Symbol.for("vercel.ai.error.AI_JSONParseError"),Symbol.for("vercel.ai.error.AI_LoadAPIKeyError"),Symbol.for("vercel.ai.error.AI_LoadSettingError"),Symbol.for("vercel.ai.error.AI_NoContentGeneratedError"),Symbol.for("vercel.ai.error.AI_NoSuchModelError"),Symbol.for("vercel.ai.error.AI_TooManyEmbeddingValuesForCallError");var wG="AI_TypeValidationError",wB=`vercel.ai.error.${wG}`,wK=Symbol.for(wB),wJ=class e extends wZ{constructor({value:e,cause:t}){super({name:wG,message:`Type validation failed: Value: ${JSON.stringify(e)}.
Error message: ${wW(t)}`,cause:t}),this[eX]=!0,this.value=e}static isInstance(e){return wZ.hasMarker(e,wB)}static wrap({value:t,cause:r}){return e.isInstance(r)&&r.value===t?r:new e({value:t,cause:r})}};eX=wK,Symbol.for("vercel.ai.error.AI_UnsupportedFunctionalityError");let wH=e=>{try{return Number(e)===e}catch{return!1}},wY=(e,t,r)=>{let a=t.split(/[\.\[\]]/g),s=e;for(let e of a){if(null==s)return r;let t=e.replace(/['"]/g,"");""!==t.trim()&&(s=s[t])}return void 0===s?r:s};var wQ=function(e,t){return(wQ=Object.setPrototypeOf||({__proto__:[]})instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)};function wX(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}wQ(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}"function"==typeof SuppressedError&&SuppressedError;var w0=function(e){var t="[object "+e+"]";return function(e){return w1(e)===t}},w1=function(e){return Object.prototype.toString.call(e)},w2=function(e){return e instanceof Date?e.getTime():w4(e)?e.map(w2):e&&"function"==typeof e.toJSON?e.toJSON():e},w4=w0("Array"),w5=w0("Object"),w3=w0("Function"),w9=function(e,t){if(null==e&&e==t||e===t)return!0;if(Object.prototype.toString.call(e)!==Object.prototype.toString.call(t))return!1;if(w4(e)){if(e.length!==t.length)return!1;for(var r=0,a=e.length;r<a;r++)if(!w9(e[r],t[r]))return!1;return!0}if(w5(e)){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(var s in e)if(!w9(e[s],t[s]))return!1;return!0}return!1},w6=function(e,t,r,a,s,n){var i=t[a];if(w4(e)&&isNaN(Number(i))&&(!e.hasOwnProperty(i)||w3(e[i]))){for(var o=0,l=e.length;o<l;o++)if(!w6(e[o],t,r,a,o,e))return!1}return a===t.length||null==e?r(e,s,n,0===a,a===t.length):w6(e[i],t,r,a+1,i,e)},w8=function(){function e(e,t,r,a){this.params=e,this.owneryQuery=t,this.options=r,this.name=a,this.init()}return e.prototype.init=function(){},e.prototype.reset=function(){this.done=!1,this.keep=!1},e}(),w7=function(e){function t(t,r,a,s){var n=e.call(this,t,r,a)||this;return n.children=s,n}return wX(t,e),t.prototype.reset=function(){this.keep=!1,this.done=!1;for(var e=0,t=this.children.length;e<t;e++)this.children[e].reset()},t.prototype.childrenNext=function(e,t,r,a,s){for(var n=!0,i=!0,o=0,l=this.children.length;o<l;o++){var u=this.children[o];if(u.done||u.next(e,t,r,a,s),u.keep||(i=!1),u.done){if(!u.keep)break}else n=!1}this.done=n,this.keep=i},t}(w8),_e=function(e){function t(t,r,a,s,n){var i=e.call(this,t,r,a,s)||this;return i.name=n,i}return wX(t,e),t}(w7),_t=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.propop=!0,t}return wX(t,e),t.prototype.next=function(e,t,r,a){this.childrenNext(e,t,r,a)},t}(w7),_r=function(e){function t(t,r,a,s,n){var i=e.call(this,r,a,s,n)||this;return i.keyPath=t,i.propop=!0,i._nextNestedValue=function(e,t,r,a,s){return i.childrenNext(e,t,r,a,s),!i.done},i}return wX(t,e),t.prototype.next=function(e,t,r){w6(e,this.keyPath,this._nextNestedValue,0,t,r)},t}(w7),_a=function(e,t){if(e instanceof Function)return e;if(e instanceof RegExp)return function(t){var r="string"==typeof t&&e.test(t);return e.lastIndex=0,r};var r=w2(e);return function(e){return t(r,w2(e))}},_s=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.propop=!0,t}return wX(t,e),t.prototype.init=function(){this._test=_a(this.params,this.options.compare)},t.prototype.next=function(e,t,r){(!Array.isArray(r)||r.hasOwnProperty(t))&&this._test(e,t,r)&&(this.done=!0,this.keep=!0)},t}(w8),_n=function(e){var t;return t=function(t,r,a,s){var n=typeof w2(t),i=e(t);return new _s(function(e){var t=null==e?null:e;return typeof w2(t)===n&&i(t)},r,a,s)},function(e,r,a,s){return t(e,r,a,s)}},_i=function(e,t,r,a){var s=a.operations[e];return s||_o(e),s(t,r,a,e)},_o=function(e){throw Error("Unsupported operation: ".concat(e))},_l=function(e,t){for(var r in e)if(t.operations.hasOwnProperty(r)||"$"===r.charAt(0))return!0;return!1},_u=function(e,t,r,a,s){if(_l(t,s)){var n=_p(t,r,s),i=n[0];if(n[1].length)throw Error("Property queries must contain only operations, or exact objects.");return new _r(e,t,a,s,i)}return new _r(e,t,a,s,[new _s(t,a,s)])},_d=function(e,t,r){void 0===t&&(t=null);var a=void 0===r?{}:r,s={compare:a.compare||w9,operations:Object.assign({},a.operations||{})},n=_p(e,null,s),i=n[0],o=n[1],l=[];return(i.length&&l.push(new _r([],e,t,s,i)),l.push.apply(l,o),1===l.length)?l[0]:new _t(e,t,s,l)},_p=function(e,t,r){var a=[],s=[];if(!(e&&(e.constructor===Object||e.constructor===Array||"function Object() { [native code] }"===e.constructor.toString()||"function Array() { [native code] }"===e.constructor.toString())&&!e.toJSON))return a.push(new _s(e,e,r)),[a,s];for(var n in e)if(r.operations.hasOwnProperty(n)){var i=_i(n,e[n],e,r);if(i&&!i.propop&&t&&!r.operations[t])throw Error("Malformed query. ".concat(n," cannot be matched against property."));null!=i&&a.push(i)}else"$"===n.charAt(0)?_o(n):s.push(_u(n.split("."),e[n],n,e,r));return[a,s]},_c=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.propop=!0,t}return wX(t,e),t.prototype.init=function(){this._test=_a(this.params,this.options.compare)},t.prototype.reset=function(){e.prototype.reset.call(this),this.keep=!0},t.prototype.next=function(e){this._test(e)&&(this.done=!0,this.keep=!1)},t}(w8),_h=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.propop=!0,t}return wX(t,e),t.prototype.init=function(){if(!this.params||"object"!=typeof this.params)throw Error("Malformed query. $elemMatch must by an object.");this._queryOperation=_d(this.params,this.owneryQuery,this.options)},t.prototype.reset=function(){e.prototype.reset.call(this),this._queryOperation.reset()},t.prototype.next=function(e){if(w4(e)){for(var t=0,r=e.length;t<r;t++){this._queryOperation.reset();var a=e[t];this._queryOperation.next(a,t,e,!1),this.keep=this.keep||this._queryOperation.keep}this.done=!0}else this.done=!1,this.keep=!1},t}(w8),_m=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.propop=!0,t}return wX(t,e),t.prototype.init=function(){this._queryOperation=_d(this.params,this.owneryQuery,this.options)},t.prototype.reset=function(){e.prototype.reset.call(this),this._queryOperation.reset()},t.prototype.next=function(e,t,r,a){this._queryOperation.next(e,t,r,a),this.done=this._queryOperation.done,this.keep=!this._queryOperation.keep},t}(w8),_g=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.propop=!0,t}return wX(t,e),t.prototype.init=function(){},t.prototype.next=function(e){w4(e)&&e.length===this.params&&(this.done=!0,this.keep=!0)},t}(w8),_f=function(e){if(0===e.length)throw Error("$and/$or/$nor must be a nonempty array")},_y=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.propop=!1,t}return wX(t,e),t.prototype.init=function(){var e=this;_f(this.params),this._ops=this.params.map(function(t){return _d(t,null,e.options)})},t.prototype.reset=function(){this.done=!1,this.keep=!1;for(var e=0,t=this._ops.length;e<t;e++)this._ops[e].reset()},t.prototype.next=function(e,t,r){for(var a=!1,s=!1,n=0,i=this._ops.length;n<i;n++){var o=this._ops[n];if(o.next(e,t,r),o.keep){a=!0,s=o.keep;break}}this.keep=s,this.done=a},t}(w8),_v=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.propop=!1,t}return wX(t,e),t.prototype.next=function(t,r,a){e.prototype.next.call(this,t,r,a),this.keep=!this.keep},t}(_y),_b=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.propop=!0,t}return wX(t,e),t.prototype.init=function(){var e=this,t=Array.isArray(this.params)?this.params:[this.params];this._testers=t.map(function(t){if(_l(t,e.options))throw Error("cannot nest $ under ".concat(e.name.toLowerCase()));return _a(t,e.options.compare)})},t.prototype.next=function(e,t,r){for(var a=!1,s=!1,n=0,i=this._testers.length;n<i;n++)if((0,this._testers[n])(e)){a=!0,s=!0;break}this.keep=s,this.done=a},t}(w8),_w=function(e){function t(t,r,a,s){var n=e.call(this,t,r,a,s)||this;return n.propop=!0,n._in=new _b(t,r,a,s),n}return wX(t,e),t.prototype.next=function(e,t,r,a){this._in.next(e,t,r),w4(r)&&!a?this._in.keep?(this.keep=!1,this.done=!0):t==r.length-1&&(this.keep=!0,this.done=!0):(this.keep=!this._in.keep,this.done=!0)},t.prototype.reset=function(){e.prototype.reset.call(this),this._in.reset()},t}(w8),__=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.propop=!0,t}return wX(t,e),t.prototype.next=function(e,t,r,a,s){s?r.hasOwnProperty(t)===this.params&&(this.done=!0,this.keep=!0):(this.done=!0,this.keep=!this.params)},t}(w8),_S=function(e){function t(t,r,a,s){var n=e.call(this,t,r,a,t.map(function(e){return _d(e,r,a)}),s)||this;return n.propop=!1,_f(t),n}return wX(t,e),t.prototype.next=function(e,t,r,a){this.childrenNext(e,t,r,a)},t}(_e),_x=function(e){function t(t,r,a,s){var n=e.call(this,t,r,a,t.map(function(e){return _d(e,r,a)}),s)||this;return n.propop=!0,n}return wX(t,e),t.prototype.next=function(e,t,r,a){this.childrenNext(e,t,r,a)},t}(_e),_I=_n(function(e){return function(t){return null!=t&&t<e}}),_k=_n(function(e){return function(t){return t===e||t<=e}}),_T=_n(function(e){return function(t){return null!=t&&t>e}}),_E=_n(function(e){return function(t){return t===e||t>=e}}),_A={number:function(e){return"number"==typeof e},string:function(e){return"string"==typeof e},bool:function(e){return"boolean"==typeof e},array:function(e){return Array.isArray(e)},null:function(e){return null===e},timestamp:function(e){return e instanceof Date}},_O=Object.freeze({__proto__:null,$Size:_g,$all:function(e,t,r,a){return new _x(e,t,r,a)},$and:function(e,t,r,a){return new _S(e,t,r,a)},$elemMatch:function(e,t,r,a){return new _h(e,t,r,a)},$eq:function(e,t,r){return new _s(e,t,r)},$exists:function(e,t,r,a){return new __(e,t,r,a)},$gt:_T,$gte:_E,$in:function(e,t,r,a){return new _b(e,t,r,a)},$lt:_I,$lte:_k,$mod:function(e,t,r){var a=e[0],s=e[1];return new _s(function(e){return w2(e)%a===s},t,r)},$ne:function(e,t,r,a){return new _c(e,t,r,a)},$nin:function(e,t,r,a){return new _w(e,t,r,a)},$nor:function(e,t,r,a){return new _v(e,t,r,a)},$not:function(e,t,r,a){return new _m(e,t,r,a)},$options:function(){return null},$or:function(e,t,r,a){return new _y(e,t,r,a)},$regex:function(e,t,r){return new _s(new RegExp(e,t.$options),t,r)},$size:function(e,t,r){return new _g(e,t,r,"$size")},$type:function(e,t,r){return new _s(function(t){if("string"==typeof e){if(!_A[e])throw Error("Type alias does not exist");return _A[e](t)}return null!=t&&(t instanceof e||t.constructor===e)},t,r)},$where:function(e,t,r){var a;if(w3(e))a=e;else if(process.env.CSP_ENABLED)throw Error('In CSP mode, sift does not support strings in "$where" condition');else a=Function("obj","return "+e);return new _s(function(e){return a.bind(e)(e)},t,r)}}),_C=function(e,t,r){var a=void 0===r?{}:r;return _d(e,t,{compare:a.compare,operations:Object.assign({},_O,a.operations||{})})},_R=function(e,t){var r;return void 0===t&&(t={}),r=_C(e,null,t),function(e,t,a){return r.reset(),r.next(e,t,a),r.keep}};class _M{constructor(e){this._process=e,this._active=!1,this._current=null,this._last=null}start(){this._active=!0,this.flush()}clear(){this._current&&(this._current.next=null,this._last=this._current)}enqueue(e){let t={value:e,next:null};if(this._current){this._last.next=t,this._last=t;return}this._current=t,this._last=t,this._active&&this.flush()}flush(){for(;this._current;){let e=this._current;this._process(e.value),this._current=e.next}this._last=null}}let _N="xstate.init",_j="xstate.stop";function _P(e,t){return{type:`xstate.done.state.${e}`,output:t}}function _$(e,t){return{type:`xstate.error.actor.${e}`,error:t,actorId:e}}function _D(e){return{type:_N,input:e}}function _L(e){setTimeout(()=>{throw e})}let _U="function"==typeof Symbol&&Symbol.observable||"@@observable";function _z(e){if(_W(e))return e;let t=[],r="";for(let a=0;a<e.length;a++){switch(e.charCodeAt(a)){case 92:r+=e[a+1],a++;continue;case 46:t.push(r),r="";continue}r+=e[a]}return t.push(r),t}function _q(e){var t;return(t=e)&&"object"==typeof t&&"machine"in t&&"value"in t?e.value:"string"!=typeof e?e:function(e){if(1===e.length)return e[0];let t={},r=t;for(let t=0;t<e.length-1;t++)if(t===e.length-2)r[e[t]]=e[t+1];else{let a=r;r={},a[e[t]]=r}return t}(_z(e))}function _V(e,t){let r={},a=Object.keys(e);for(let s=0;s<a.length;s++){let n=a[s];r[n]=t(e[n],n,e,s)}return r}function _F(e){var t;return void 0===e?[]:_W(t=e)?t:[t]}function _Z(e,t,r,a){return"function"==typeof e?e({context:t,event:r,self:a}):e}function _W(e){return Array.isArray(e)}function _G(e){var t;return(_W(t=e)?t:[t]).map(e=>void 0===e||"string"==typeof e?{target:e}:e)}function _B(e){if(void 0!==e&&""!==e)return _F(e)}function _K(e,t,r){let a="object"==typeof e,s=a?e:void 0;return{next:(a?e.next:e)?.bind(s),error:(a?e.error:t)?.bind(s),complete:(a?e.complete:r)?.bind(s)}}function _J(e,t){let r=t.match(/^xstate\.invoke\.(\d+)\.(.*)/);if(!r)return e.implementations.actors[t];let[,a,s]=r,n=e.getStateNodeById(s).config.invoke;return(Array.isArray(n)?n[a]:n).src}function _H(e,t){return`${e.sessionId}.${t}`}let _Y=0,_Q=!1,_X=((S={})[S.NotStarted=0]="NotStarted",S[S.Running=1]="Running",S[S.Stopped=2]="Stopped",S),_0={clock:{setTimeout:(e,t)=>setTimeout(e,t),clearTimeout:e=>clearTimeout(e)},logger:console.log.bind(console),devTools:!1};class _1{constructor(e,t){this.logic=e,this._snapshot=void 0,this.clock=void 0,this.options=void 0,this.id=void 0,this.mailbox=new _M(this._process.bind(this)),this.observers=new Set,this.eventListeners=new Map,this.logger=void 0,this._processingStatus=_X.NotStarted,this._parent=void 0,this._syncSnapshot=void 0,this.ref=void 0,this._actorScope=void 0,this.systemId=void 0,this.sessionId=void 0,this.system=void 0,this._doneEvent=void 0,this.src=void 0,this._deferred=[];const r={..._0,...t},{clock:a,logger:s,parent:n,syncSnapshot:i,id:o,systemId:l,inspect:u}=r;this.system=n?n.system:function(e,t){let r=new Map,a=new Map,s=new WeakMap,n=new Set,i={},{clock:o,logger:l}=t,u={schedule:(e,t,r,a,s=Math.random().toString(36).slice(2))=>{let n={source:e,target:t,event:r,delay:a,id:s,startedAt:Date.now()},l=_H(e,s);d._snapshot._scheduledEvents[l]=n;let u=o.setTimeout(()=>{delete i[l],delete d._snapshot._scheduledEvents[l],d._relay(e,t,r)},a);i[l]=u},cancel:(e,t)=>{let r=_H(e,t),a=i[r];delete i[r],delete d._snapshot._scheduledEvents[r],void 0!==a&&o.clearTimeout(a)},cancelAll:e=>{for(let t in d._snapshot._scheduledEvents){let r=d._snapshot._scheduledEvents[t];r.source===e&&u.cancel(e,r.id)}}},d={_snapshot:{_scheduledEvents:(t?.snapshot&&t.snapshot.scheduler)??{}},_bookId:()=>`x:${_Y++}`,_register:(e,t)=>(r.set(e,t),e),_unregister:e=>{r.delete(e.sessionId);let t=s.get(e);void 0!==t&&(a.delete(t),s.delete(e))},get:e=>a.get(e),getAll:()=>Object.fromEntries(a.entries()),_set:(e,t)=>{let r=a.get(e);if(r&&r!==t)throw Error(`Actor with system ID '${e}' already exists.`);a.set(e,t),s.set(t,e)},inspect:e=>{let t=_K(e);return n.add(t),{unsubscribe(){n.delete(t)}}},_sendInspectionEvent:t=>{if(!n.size)return;let r={...t,rootId:e.sessionId};n.forEach(e=>e.next?.(r))},_relay:(e,t,r)=>{d._sendInspectionEvent({type:"@xstate.event",sourceRef:e,actorRef:t,event:r}),t._send(r)},scheduler:u,getSnapshot:()=>({_scheduledEvents:{...d._snapshot._scheduledEvents}}),start:()=>{let e=d._snapshot._scheduledEvents;for(let t in d._snapshot._scheduledEvents={},e){let{source:r,target:a,event:s,delay:n,id:i}=e[t];u.schedule(r,a,s,n,i)}},_clock:o,_logger:l};return d}(this,{clock:a,logger:s}),u&&!n&&this.system.inspect(_K(u)),this.sessionId=this.system._bookId(),this.id=o??this.sessionId,this.logger=t?.logger??this.system._logger,this.clock=t?.clock??this.system._clock,this._parent=n,this._syncSnapshot=i,this.options=r,this.src=r.src??e,this.ref=this,this._actorScope={self:this,id:this.id,sessionId:this.sessionId,logger:this.logger,defer:e=>{this._deferred.push(e)},system:this.system,stopChild:e=>{if(e._parent!==this)throw Error(`Cannot stop child actor ${e.id} of ${this.id} because it is not a child`);e._stop()},emit:e=>{let t=this.eventListeners.get(e.type),r=this.eventListeners.get("*");if(t||r)for(let a of[...t?t.values():[],...r?r.values():[]])try{a(e)}catch(e){_L(e)}},actionExecutor:e=>{let t=()=>{if(this._actorScope.system._sendInspectionEvent({type:"@xstate.action",actorRef:this,action:{type:e.type,params:e.params}}),!e.exec)return;let t=_Q;try{_Q=!0,e.exec(e.info,e.params)}finally{_Q=t}};this._processingStatus===_X.Running?t():this._deferred.push(t)}},this.send=this.send.bind(this),this.system._sendInspectionEvent({type:"@xstate.actor",actorRef:this}),l&&(this.systemId=l,this.system._set(l,this)),this._initState(t?.snapshot??t?.state),l&&"active"!==this._snapshot.status&&this.system._unregister(this)}_initState(e){try{this._snapshot=e?this.logic.restoreSnapshot?this.logic.restoreSnapshot(e,this._actorScope):e:this.logic.getInitialSnapshot(this._actorScope,this.options?.input)}catch(e){this._snapshot={status:"error",output:void 0,error:e}}}update(e,t){let r;for(this._snapshot=e;r=this._deferred.shift();)try{r()}catch(t){this._deferred.length=0,this._snapshot={...e,status:"error",error:t}}switch(this._snapshot.status){case"active":for(let t of this.observers)try{t.next?.(e)}catch(e){_L(e)}break;case"done":var a;for(let t of this.observers)try{t.next?.(e)}catch(e){_L(e)}this._stopProcedure(),this._complete(),this._doneEvent=(a=this.id,{type:`xstate.done.actor.${a}`,output:this._snapshot.output,actorId:a}),this._parent&&this.system._relay(this,this._parent,this._doneEvent);break;case"error":this._error(this._snapshot.error)}this.system._sendInspectionEvent({type:"@xstate.snapshot",actorRef:this,event:t,snapshot:e})}subscribe(e,t,r){let a=_K(e,t,r);if(this._processingStatus!==_X.Stopped)this.observers.add(a);else switch(this._snapshot.status){case"done":try{a.complete?.()}catch(e){_L(e)}break;case"error":{let e=this._snapshot.error;if(a.error)try{a.error(e)}catch(e){_L(e)}else _L(e)}}return{unsubscribe:()=>{this.observers.delete(a)}}}on(e,t){let r=this.eventListeners.get(e);r||(r=new Set,this.eventListeners.set(e,r));let a=t.bind(void 0);return r.add(a),{unsubscribe:()=>{r.delete(a)}}}start(){if(this._processingStatus===_X.Running)return this;this._syncSnapshot&&this.subscribe({next:e=>{"active"===e.status&&this.system._relay(this,this._parent,{type:`xstate.snapshot.${this.id}`,snapshot:e})},error:()=>{}}),this.system._register(this.sessionId,this),this.systemId&&this.system._set(this.systemId,this),this._processingStatus=_X.Running;let e=_D(this.options.input);switch(this.system._sendInspectionEvent({type:"@xstate.event",sourceRef:this._parent,actorRef:this,event:e}),this._snapshot.status){case"done":return this.update(this._snapshot,e),this;case"error":return this._error(this._snapshot.error),this}if(this._parent||this.system.start(),this.logic.start)try{this.logic.start(this._snapshot,this._actorScope)}catch(e){return this._snapshot={...this._snapshot,status:"error",error:e},this._error(e),this}return this.update(this._snapshot,e),this.options.devTools&&this.attachDevTools(),this.mailbox.start(),this}_process(e){let t,r;try{t=this.logic.transition(this._snapshot,e,this._actorScope)}catch(e){r={err:e}}if(r){let{err:e}=r;this._snapshot={...this._snapshot,status:"error",error:e},this._error(e);return}this.update(t,e),e.type===_j&&(this._stopProcedure(),this._complete())}_stop(){return this._processingStatus===_X.Stopped||((this.mailbox.clear(),this._processingStatus===_X.NotStarted)?this._processingStatus=_X.Stopped:this.mailbox.enqueue({type:_j})),this}stop(){if(this._parent)throw Error("A non-root actor cannot be stopped directly.");return this._stop()}_complete(){for(let e of this.observers)try{e.complete?.()}catch(e){_L(e)}this.observers.clear()}_reportError(e){if(!this.observers.size){this._parent||_L(e);return}let t=!1;for(let r of this.observers){let a=r.error;t||=!a;try{a?.(e)}catch(e){_L(e)}}this.observers.clear(),t&&_L(e)}_error(e){this._stopProcedure(),this._reportError(e),this._parent&&this.system._relay(this,this._parent,_$(this.id,e))}_stopProcedure(){return this._processingStatus!==_X.Running||(this.system.scheduler.cancelAll(this),this.mailbox.clear(),this.mailbox=new _M(this._process.bind(this)),this._processingStatus=_X.Stopped,this.system._unregister(this)),this}_send(e){this._processingStatus!==_X.Stopped&&this.mailbox.enqueue(e)}send(e){this.system._relay(void 0,this,e)}attachDevTools(){let{devTools:e}=this.options;e&&("function"==typeof e?e:e=>{})(this)}toJSON(){return{xstate$$type:1,id:this.id}}getPersistedSnapshot(e){return this.logic.getPersistedSnapshot(this._snapshot,e)}[_U](){return this}getSnapshot(){return this._snapshot}}function _2(e,...[t]){return new _1(e,t)}function _4(e,t,r,a,{sendId:s}){return[t,{sendId:"function"==typeof s?s(r,a):s},void 0]}function _5(e,t){e.defer(()=>{e.system.scheduler.cancel(e.self,t.sendId)})}function _3(e){function t(e,t){}return t.type="xstate.cancel",t.sendId=e,t.resolve=_4,t.execute=_5,t}function _9(e,t,r,a,{id:s,systemId:n,src:i,input:o,syncSnapshot:l}){let u,d,p="string"==typeof i?_J(t.machine,i):i,c="function"==typeof s?s(r):s;return p&&(d="function"==typeof o?o({context:t.context,event:r.event,self:e.self}):o,u=_2(p,{id:c,src:i,parent:e.self,syncSnapshot:l,systemId:n,input:d})),[SD(t,{children:{...t.children,[c]:u}}),{id:s,systemId:n,actorRef:u,src:i,input:d},void 0]}function _6(e,{actorRef:t}){t&&e.defer(()=>{t._processingStatus!==_X.Stopped&&t.start()})}function _8(...[e,{id:t,systemId:r,input:a,syncSnapshot:s=!1}={}]){function n(e,t){}return n.type="xstate.spawnChild",n.id=t,n.systemId=r,n.src=e,n.input=a,n.syncSnapshot=s,n.resolve=_9,n.execute=_6,n}function _7(e,t,r,a,{actorRef:s}){let n="function"==typeof s?s(r,a):s,i="string"==typeof n?t.children[n]:n,o=t.children;return i&&(o={...o},delete o[i.id]),[SD(t,{children:o}),i,void 0]}function Se(e,t){if(t){if(e.system._unregister(t),t._processingStatus!==_X.Running)return void e.stopChild(t);e.defer(()=>{e.stopChild(t)})}}function St(e){function t(e,t){}return t.type="xstate.stopChild",t.actorRef=e,t.resolve=_7,t.execute=Se,t}function Sr(e,t,r,a){let{machine:s}=a,n="function"==typeof e,i=n?e:s.implementations.guards["string"==typeof e?e:e.type];if(!n&&!i)throw Error(`Guard '${"string"==typeof e?e:e.type}' is not implemented.'.`);if("function"!=typeof i)return Sr(i,t,r,a);let o={context:t,event:r},l=n||"string"==typeof e?void 0:"params"in e?"function"==typeof e.params?e.params({context:t,event:r}):e.params:void 0;return"check"in i?i.check(a,o,i):i(o,l)}let Sa=e=>"atomic"===e.type||"final"===e.type;function Ss(e){return Object.values(e.states).filter(e=>"history"!==e.type)}function Sn(e,t){let r=[];if(t===e)return r;let a=e.parent;for(;a&&a!==t;)r.push(a),a=a.parent;return r}function Si(e){let t=new Set(e),r=So(t);for(let e of t)if("compound"!==e.type||r.get(e)&&r.get(e).length){if("parallel"===e.type){for(let r of Ss(e))if("history"!==r.type&&!t.has(r))for(let e of Sm(r))t.add(e)}}else Sm(e).forEach(e=>t.add(e));for(let e of t){let r=e.parent;for(;r;)t.add(r),r=r.parent}return t}function So(e){let t=new Map;for(let r of e)t.has(r)||t.set(r,[]),r.parent&&(t.has(r.parent)||t.set(r.parent,[]),t.get(r.parent).push(r));return t}function Sl(e,t){return function e(t,r){let a=r.get(t);if(!a)return{};if("compound"===t.type){let e=a[0];if(!e)return{};if(Sa(e))return e.key}let s={};for(let t of a)s[t.key]=e(t,r);return s}(e,So(Si(t)))}function Su(e,t){return"compound"===t.type?Ss(t).some(t=>"final"===t.type&&e.has(t)):"parallel"===t.type?Ss(t).every(t=>Su(e,t)):"final"===t.type}let Sd=e=>"#"===e[0];function Sp(e,t,r){let a=_B(r.target),s=r.reenter??!1,n=function(e,t){if(void 0!==t)return t.map(t=>{if("string"!=typeof t)return t;if(Sd(t))return e.machine.getStateNodeById(t);let r="."===t[0];if(r&&!e.parent)return Sy(e,t.slice(1));let a=r?e.key+t:t;if(e.parent)try{return Sy(e.parent,a)}catch(t){throw Error(`Invalid transition definition for state node '${e.id}':
${t.message}`)}throw Error(`Invalid target: "${t}" is not a valid target from the root node. Did you mean ".${t}"?`)})}(e,a),i={...r,actions:_F(r.actions),guard:r.guard,target:n,source:e,reenter:s,eventType:t,toJSON:()=>({...i,source:`#${e.id}`,target:n?n.map(e=>`#${e.id}`):void 0})};return i}function Sc(e){let t=_B(e.config.target);return t?{target:t.map(t=>"string"==typeof t?Sy(e.parent,t):t)}:e.parent.initial}function Sh(e){return"history"===e.type}function Sm(e){let t=Sg(e);for(let r of t)for(let a of Sn(r,e))t.add(a);return t}function Sg(e){let t=new Set;return!function e(r){if(!t.has(r)){if(t.add(r),"compound"===r.type)e(r.initial.target[0]);else if("parallel"===r.type)for(let t of Ss(r))e(t)}}(e),t}function Sf(e,t){if(Sd(t))return e.machine.getStateNodeById(t);if(!e.states)throw Error(`Unable to retrieve child state '${t}' from '${e.id}'; no child states exist.`);let r=e.states[t];if(!r)throw Error(`Child state '${t}' does not exist on '${e.id}'`);return r}function Sy(e,t){if("string"==typeof t&&Sd(t))try{return e.machine.getStateNodeById(t)}catch{}let r=_z(t).slice(),a=e;for(;r.length;){let e=r.shift();if(!e.length)break;a=Sf(a,e)}return a}function Sv(e,t){if("string"==typeof t){let r=e.states[t];if(!r)throw Error(`State '${t}' does not exist on '${e.id}'`);return[e,r]}let r=Object.keys(t),a=r.map(t=>Sf(e,t)).filter(Boolean);return[e.machine.root,e].concat(a,r.reduce((r,a)=>{let s=Sf(e,a);if(!s)return r;let n=Sv(s,t[a]);return r.concat(n)},[]))}function Sb(e,t){let r=e;for(;r.parent&&r.parent!==t;)r=r.parent;return r.parent===t}function Sw(e,t,r){let a=new Set;for(let s of e){let e=!1,n=new Set;for(let i of a)if(function(e,t){let r=new Set(e),a=new Set(t);for(let e of r)if(a.has(e))return!0;for(let e of a)if(r.has(e))return!0;return!1}(Sx([s],t,r),Sx([i],t,r)))if(Sb(s.source,i.source))n.add(i);else{e=!0;break}if(!e){for(let e of n)a.delete(e);a.add(s)}}return Array.from(a)}function S_(e,t){if(!e.target)return[];let r=new Set;for(let a of e.target)if(Sh(a))if(t[a.id])for(let e of t[a.id])r.add(e);else for(let e of S_(Sc(a),t))r.add(e);else r.add(a);return[...r]}function SS(e,t){let r=S_(e,t);if(!r)return;if(!e.reenter&&r.every(t=>t===e.source||Sb(t,e.source)))return e.source;let a=function(e){let[t,...r]=e;for(let e of Sn(t,void 0))if(r.every(t=>Sb(t,e)))return e}(r.concat(e.source));return a||(e.reenter?void 0:e.source.machine.root)}function Sx(e,t,r){let a=new Set;for(let s of e)if(s.target?.length){let e=SS(s,r);for(let r of(s.reenter&&s.source===e&&a.add(e),t))Sb(r,e)&&a.add(r)}return[...a]}function SI(e,t,r,a,s,n){if(!e.length)return t;let i=new Set(t._nodes),o=t.historyValue,l=Sw(e,i,o),u=t;s||([u,o]=function(e,t,r,a,s,n,i,o){let l,u=e,d=Sx(a,s,n);for(let e of(d.sort((e,t)=>t.order-e.order),d))for(let t of function(e){return Object.keys(e.states).map(t=>e.states[t]).filter(e=>"history"===e.type)}(e)){let r;r="deep"===t.history?t=>Sa(t)&&Sb(t,e):t=>t.parent===e,(l??={...n})[t.id]=Array.from(s).filter(r)}for(let e of d)u=SE(u,t,r,[...e.exit,...e.invoke.map(e=>St(e.id))],i,void 0),s.delete(e);return[u,l||n]}(u,a,r,l,i,o,n,r.actionExecutor)),u=function(e,t,r,a,s,n,i,o){let l=e,u=new Set,d=new Set;(function(e,t,r,a){for(let s of e){let e=SS(s,t);for(let n of s.target||[])!Sh(n)&&(s.source!==n||s.source!==e||s.reenter)&&(a.add(n),r.add(n)),Sk(n,t,r,a);for(let n of S_(s,t)){let i=Sn(n,e);e?.type==="parallel"&&i.push(e),ST(a,t,r,i,!s.source.parent&&s.reenter?void 0:e)}}})(a,i,d,u),o&&d.add(e.machine.root);let p=new Set;for(let e of[...u].sort((e,t)=>e.order-t.order)){s.add(e);let a=[];for(let t of(a.push(...e.entry),e.invoke))a.push(_8(t.src,{...t,syncSnapshot:!!t.onSnapshot}));if(d.has(e)){let t=e.initial.actions;a.push(...t)}if(l=SE(l,t,r,a,n,e.invoke.map(e=>e.id)),"final"===e.type){let a=e.parent,i=a?.type==="parallel"?a:a?.parent,o=i||e;for(a?.type==="compound"&&n.push(_P(a.id,void 0!==e.output?_Z(e.output,l.context,t,r.self):void 0));i?.type==="parallel"&&!p.has(i)&&Su(s,i);)p.add(i),n.push(_P(i.id)),o=i,i=i.parent;if(i)continue;l=SD(l,{status:"done",output:function(e,t,r,a,s){if(void 0===a.output)return;let n=_P(s.id,void 0!==s.output&&s.parent?_Z(s.output,e.context,t,r.self):void 0);return _Z(a.output,e.context,n,r.self)}(l,t,r,l.machine.root,o)})}}return l}(u=SE(u,a,r,l.flatMap(e=>e.actions),n,void 0),a,r,l,i,n,o,s);let d=[...i];"done"===u.status&&(u=SE(u,a,r,d.sort((e,t)=>t.order-e.order).flatMap(e=>e.exit),n,void 0));try{if(o===t.historyValue&&function(e,t){if(e.length!==t.size)return!1;for(let r of e)if(!t.has(r))return!1;return!0}(t._nodes,i))return u;return SD(u,{_nodes:d,historyValue:o})}catch(e){throw e}}function Sk(e,t,r,a){var s,n,i,o;if(Sh(e))if(t[e.id]){let i=t[e.id];for(let e of i)a.add(e),Sk(e,t,r,a);for(let o of i){s=o,n=e.parent,ST(a,t,r,Sn(s,n))}}else{let s=Sc(e);for(let n of s.target)a.add(n),s===e.parent?.initial&&r.add(e.parent),Sk(n,t,r,a);for(let n of s.target){i=n,o=e.parent,ST(a,t,r,Sn(i,o))}}else if("compound"===e.type){let[s]=e.initial.target;Sh(s)||(a.add(s),r.add(s)),Sk(s,t,r,a),ST(a,t,r,Sn(s,e))}else if("parallel"===e.type)for(let s of Ss(e).filter(e=>!Sh(e)))[...a].some(e=>Sb(e,s))||(Sh(s)||(a.add(s),r.add(s)),Sk(s,t,r,a))}function ST(e,t,r,a,s){for(let n of a)if((!s||Sb(n,s))&&e.add(n),"parallel"===n.type)for(let a of Ss(n).filter(e=>!Sh(e)))[...e].some(e=>Sb(e,a))||(e.add(a),Sk(a,t,r,e))}function SE(e,t,r,a,s,n){let i=n?[]:void 0,o=function e(t,r,a,s,n,i){let{machine:o}=t,l=t;for(let t of s){var u;let s="function"==typeof t,d=s?t:(u="string"==typeof t?t:t.type,o.implementations.actions[u]),p={context:l.context,event:r,self:a.self,system:a.system},c=s||"string"==typeof t?void 0:"params"in t?"function"==typeof t.params?t.params({context:l.context,event:r}):t.params:void 0;if(!d||!("resolve"in d)){a.actionExecutor({type:"string"==typeof t?t:"object"==typeof t?t.type:t.name||"(anonymous)",info:p,params:c,exec:d});continue}let[h,m,g]=d.resolve(a,l,p,c,d,n);l=h,"retryResolve"in d&&i?.push([d,m]),"execute"in d&&a.actionExecutor({type:d.type,info:p,params:m,exec:d.execute.bind(null,a,m)}),g&&(l=e(l,r,a,g,n,i))}return l}(e,t,r,a,{internalQueue:s,deferredActorIds:n},i);return i?.forEach(([e,t])=>{e.retryResolve(r,o,t)}),o}function SA(e,t,r,a){let s=e,n=[];function i(e,t,a){r.system._sendInspectionEvent({type:"@xstate.microstep",actorRef:r.self,event:t,snapshot:e,_transitions:a}),n.push(e)}if(t.type===_j)return i(s=SD(SO(s,t,r),{status:"stopped"}),t,[]),{snapshot:s,microstates:n};let o=t;if(o.type!==_N){let t=o,l=t.type.startsWith("xstate.error.actor"),u=SC(t,s);if(l&&!u.length)return i(s=SD(e,{status:"error",error:t.error}),t,[]),{snapshot:s,microstates:n};i(s=SI(u,e,r,o,!1,a),t,u)}let l=!0;for(;"active"===s.status;){let e=l?function(e,t){let r=new Set;for(let a of e._nodes.filter(Sa))e:for(let s of[a].concat(Sn(a,void 0)))if(s.always){for(let a of s.always)if(void 0===a.guard||Sr(a.guard,e.context,t,e)){r.add(a);break e}}return Sw(Array.from(r),new Set(e._nodes),e.historyValue)}(s,o):[],t=e.length?s:void 0;if(!e.length){if(!a.length)break;e=SC(o=a.shift(),s)}l=(s=SI(e,s,r,o,!1,a))!==t,i(s,o,e)}return"active"!==s.status&&SO(s,o,r),{snapshot:s,microstates:n}}function SO(e,t,r){return SE(e,t,r,Object.values(e.children).map(e=>St(e)),[],void 0)}function SC(e,t){return t.machine.getTransitionData(t,e)}let SR=function(e){return function e(t,r){let a=_q(t),s=_q(r);return"string"==typeof s?"string"==typeof a&&s===a:"string"==typeof a?a in s:Object.keys(a).every(t=>t in s&&e(a[t],s[t]))}(e,this.value)},SM=function(e){return this.tags.has(e)},SN=function(e){let t=this.machine.getTransitionData(this,e);return!!t?.length&&t.some(e=>void 0!==e.target||e.actions.length)},Sj=function(){let{_nodes:e,tags:t,machine:r,getMeta:a,toJSON:s,can:n,hasTag:i,matches:o,...l}=this;return{...l,tags:Array.from(t)}},SP=function(){return this._nodes.reduce((e,t)=>(void 0!==t.meta&&(e[t.id]=t.meta),e),{})};function S$(e,t){return{status:e.status,output:e.output,error:e.error,machine:t,context:e.context,_nodes:e._nodes,value:Sl(t.root,e._nodes),tags:new Set(e._nodes.flatMap(e=>e.tags)),children:e.children,historyValue:e.historyValue||{},matches:SR,hasTag:SM,can:SN,getMeta:SP,toJSON:Sj}}function SD(e,t={}){return S$({...e,...t},e.machine)}function SL(e,t,r,a,{event:s,id:n,delay:i},{internalQueue:o}){let l,u=t.machine.implementations.delays;if("string"==typeof s)throw Error(`Only event objects may be used with raise; use raise({ type: "${s}" }) instead`);let d="function"==typeof s?s(r,a):s;if("string"==typeof i){let e=u&&u[i];l="function"==typeof e?e(r,a):e}else l="function"==typeof i?i(r,a):i;return"number"!=typeof l&&o.push(d),[t,{event:d,id:n,delay:l},void 0]}function SU(e,t){let{event:r,delay:a,id:s}=t;if("number"==typeof a)return void e.defer(()=>{let t=e.self;e.system.scheduler.schedule(t,t,r,a,s)})}function Sz(e,t){function r(e,t){}return r.type="xstate.raise",r.event=e,r.id=t?.id,r.delay=t?.delay,r.resolve=SL,r.execute=SU,r}function Sq(e,t,r,a,{assignment:s}){if(!t.context)throw Error("Cannot assign to undefined `context`. Ensure that `context` is defined in the machine config.");let n={},i={context:t.context,event:r.event,spawn:function(e,{machine:t,context:r},a,s){return(n,i)=>{let o=((n,i)=>{if("string"!=typeof n)return _2(n,{id:i?.id,parent:e.self,syncSnapshot:i?.syncSnapshot,input:i?.input,src:n,systemId:i?.systemId});{let o=_J(t,n);if(!o)throw Error(`Actor logic '${n}' not implemented in machine '${t.id}'`);let l=_2(o,{id:i?.id,parent:e.self,syncSnapshot:i?.syncSnapshot,input:"function"==typeof i?.input?i.input({context:r,event:a,self:e.self}):i?.input,src:n,systemId:i?.systemId});return s[l.id]=l,l}})(n,i);return s[o.id]=o,e.defer(()=>{o._processingStatus!==_X.Stopped&&o.start()}),o}}(e,t,r.event,n),self:e.self,system:e.system},o={};if("function"==typeof s)o=s(i,a);else for(let e of Object.keys(s)){let t=s[e];o[e]="function"==typeof t?t(i,a):t}let l=Object.assign({},t.context,o);return[SD(t,{context:l,children:Object.keys(n).length?{...t.children,...n}:t.children}),void 0,void 0]}function SV(e){function t(e,t){}return t.type="xstate.assign",t.assignment=e,t.resolve=Sq,t}let SF="xstate.promise.resolve",SZ="xstate.promise.reject",SW=new WeakMap;function SG(e){return{config:e,transition:(e,t,r)=>{if("active"!==e.status)return e;switch(t.type){case SF:{let r=t.data;return{...e,status:"done",output:r,input:void 0}}case SZ:return{...e,status:"error",error:t.data,input:void 0};case _j:return SW.get(r.self)?.abort(),{...e,status:"stopped",input:void 0};default:return e}},start:(t,{self:r,system:a,emit:s})=>{if("active"!==t.status)return;let n=new AbortController;SW.set(r,n),Promise.resolve(e({input:t.input,system:a,self:r,signal:n.signal,emit:s})).then(e=>{"active"===r.getSnapshot().status&&(SW.delete(r),a._relay(r,r,{type:SF,data:e}))},e=>{"active"===r.getSnapshot().status&&(SW.delete(r),a._relay(r,r,{type:SZ,data:e}))})},getInitialSnapshot:(e,t)=>({status:"active",output:void 0,error:void 0,input:t}),getPersistedSnapshot:e=>e,restoreSnapshot:e=>e}}I=void 0,e=>e;let SB=new WeakMap;function SK(e,t,r){let a=SB.get(e);return a?t in a||(a[t]=r()):(a={[t]:r()},SB.set(e,a)),a[t]}let SJ={},SH=e=>"string"==typeof e?{type:e}:"function"==typeof e?"resolve"in e?{type:e.type}:{type:e.name}:e;class SY{constructor(e,t){if(this.config=e,this.key=void 0,this.id=void 0,this.type=void 0,this.path=void 0,this.states=void 0,this.history=void 0,this.entry=void 0,this.exit=void 0,this.parent=void 0,this.machine=void 0,this.meta=void 0,this.output=void 0,this.order=-1,this.description=void 0,this.tags=[],this.transitions=void 0,this.always=void 0,this.parent=t._parent,this.key=t._key,this.machine=t._machine,this.path=this.parent?this.parent.path.concat(this.key):[],this.id=this.config.id||[this.machine.id,...this.path].join("."),this.type=this.config.type||(this.config.states&&Object.keys(this.config.states).length?"compound":this.config.history?"history":"atomic"),this.description=this.config.description,this.order=this.machine.idMap.size,this.machine.idMap.set(this.id,this),this.states=this.config.states?_V(this.config.states,(e,t)=>new SY(e,{_parent:this,_key:t,_machine:this.machine})):SJ,"compound"===this.type&&!this.config.initial)throw Error(`No initial state specified for compound state node "#${this.id}". Try adding { initial: "${Object.keys(this.states)[0]}" } to the state config.`);this.history=!0===this.config.history?"shallow":this.config.history||!1,this.entry=_F(this.config.entry).slice(),this.exit=_F(this.config.exit).slice(),this.meta=this.config.meta,this.output="final"!==this.type&&this.parent?void 0:this.config.output,this.tags=_F(e.tags).slice()}_initialize(){this.transitions=function(e){let t=new Map;if(e.config.on)for(let r of Object.keys(e.config.on)){if(""===r)throw Error('Null events ("") cannot be specified as a transition key. Use `always: { ... }` instead.');let a=e.config.on[r];t.set(r,_G(a).map(t=>Sp(e,r,t)))}if(e.config.onDone){let r=`xstate.done.state.${e.id}`;t.set(r,_G(e.config.onDone).map(t=>Sp(e,r,t)))}for(let r of e.invoke){if(r.onDone){let a=`xstate.done.actor.${r.id}`;t.set(a,_G(r.onDone).map(t=>Sp(e,a,t)))}if(r.onError){let a=`xstate.error.actor.${r.id}`;t.set(a,_G(r.onError).map(t=>Sp(e,a,t)))}if(r.onSnapshot){let a=`xstate.snapshot.${r.id}`;t.set(a,_G(r.onSnapshot).map(t=>Sp(e,a,t)))}}for(let r of e.after){let e=t.get(r.eventType);e||(e=[],t.set(r.eventType,e)),e.push(r)}return t}(this),this.config.always&&(this.always=_G(this.config.always).map(e=>Sp(this,"",e))),Object.keys(this.states).forEach(e=>{this.states[e]._initialize()})}get definition(){return{id:this.id,key:this.key,version:this.machine.version,type:this.type,initial:this.initial?{target:this.initial.target,source:this,actions:this.initial.actions.map(SH),eventType:null,reenter:!1,toJSON:()=>({target:this.initial.target.map(e=>`#${e.id}`),source:`#${this.id}`,actions:this.initial.actions.map(SH),eventType:null})}:void 0,history:this.history,states:_V(this.states,e=>e.definition),on:this.on,transitions:[...this.transitions.values()].flat().map(e=>({...e,actions:e.actions.map(SH)})),entry:this.entry.map(SH),exit:this.exit.map(SH),meta:this.meta,order:this.order||-1,output:this.output,invoke:this.invoke,description:this.description,tags:this.tags}}toJSON(){return this.definition}get invoke(){return SK(this,"invoke",()=>_F(this.config.invoke).map((e,t)=>{var r,a;let{src:s,systemId:n}=e,i=e.id??(r=this.id,`${t}.${r}`),o="string"==typeof s?s:`xstate.invoke.${a=this.id,`${t}.${a}`}`;return{...e,src:o,id:i,systemId:n,toJSON(){let{onDone:t,onError:r,...a}=e;return{...a,type:"xstate.invoke",src:o,id:i}}}}))}get on(){return SK(this,"on",()=>[...this.transitions].flatMap(([e,t])=>t.map(t=>[e,t])).reduce((e,[t,r])=>(e[t]=e[t]||[],e[t].push(r),e),{}))}get after(){return SK(this,"delayedTransitions",()=>{var e;let t;return e=this,(t=e.config.after)?Object.keys(t).flatMap(r=>{var a;let s,n,i=t[r],o=Number.isNaN(+r)?r:+r,l=(a=e.id,n=(s={type:`xstate.after.${o}.${a}`}).type,e.entry.push(Sz(s,{id:n,delay:o})),e.exit.push(_3(n)),n);return _F("string"==typeof i?{target:i}:i).map(e=>({...e,event:l,delay:o}))}).map(t=>{let{delay:r}=t;return{...Sp(e,t.event,t),delay:r}}):[]})}get initial(){return SK(this,"initial",()=>(function(e,t){let r="string"==typeof t?e.states[t]:t?e.states[t.target]:void 0;if(!r&&t)throw Error(`Initial state node "${t}" not found on parent state node #${e.id}`);let a={source:e,actions:t&&"string"!=typeof t?_F(t.actions):[],eventType:null,reenter:!1,target:r?[r]:[],toJSON:()=>({...a,source:`#${e.id}`,target:r?[`#${r.id}`]:[]})};return a})(this,this.config.initial))}next(e,t){let r,a=t.type,s=[];for(let n of SK(this,`candidates-${a}`,()=>{var e;return e=this,e.transitions.get(a)||[...e.transitions.keys()].filter(e=>(function(e,t){if(t===e||"*"===t)return!0;if(!t.endsWith(".*"))return!1;let r=t.split("."),a=e.split(".");for(let e=0;e<r.length;e++){let t=r[e],s=a[e];if("*"===t)return e===r.length-1;if(t!==s)return!1}return!0})(a,e)).sort((e,t)=>t.length-e.length).flatMap(t=>e.transitions.get(t))})){let{guard:i}=n,o=e.context,l=!1;try{l=!i||Sr(i,o,t,e)}catch(t){let e="string"==typeof i?i:"object"==typeof i?i.type:void 0;throw Error(`Unable to evaluate guard ${e?`'${e}' `:""}in transition for event '${a}' in state node '${this.id}':
${t.message}`)}if(l){s.push(...n.actions),r=n;break}}return r?[r]:void 0}get events(){return SK(this,"events",()=>{let{states:e}=this,t=new Set(this.ownEvents);if(e)for(let r of Object.keys(e)){let a=e[r];if(a.states)for(let e of a.events)t.add(`${e}`)}return Array.from(t)})}get ownEvents(){return Array.from(new Set(Object.keys(Object.fromEntries(this.transitions)).filter(e=>this.transitions.get(e).some(e=>!(!e.target&&!e.actions.length&&!e.reenter)))))}}class SQ{constructor(e,t){this.config=e,this.version=void 0,this.schemas=void 0,this.implementations=void 0,this.__xstatenode=!0,this.idMap=new Map,this.root=void 0,this.id=void 0,this.states=void 0,this.events=void 0,this.id=e.id||"(machine)",this.implementations={actors:t?.actors??{},actions:t?.actions??{},delays:t?.delays??{},guards:t?.guards??{}},this.version=this.config.version,this.schemas=this.config.schemas,this.transition=this.transition.bind(this),this.getInitialSnapshot=this.getInitialSnapshot.bind(this),this.getPersistedSnapshot=this.getPersistedSnapshot.bind(this),this.restoreSnapshot=this.restoreSnapshot.bind(this),this.start=this.start.bind(this),this.root=new SY(e,{_key:this.id,_machine:this}),this.root._initialize(),this.states=this.root.states,this.events=this.root.events}provide(e){let{actions:t,guards:r,actors:a,delays:s}=this.implementations;return new SQ(this.config,{actions:{...t,...e.actions},guards:{...r,...e.guards},actors:{...a,...e.actors},delays:{...s,...e.delays}})}resolveState(e){var t;let r,a=(r=Si(Sv(t=this.root,e.value)),Sl(t,[...r])),s=Si(Sv(this.root,a));return S$({_nodes:[...s],context:e.context||{},children:{},status:Su(s,this.root)?"done":e.status||"active",output:e.output,error:e.error,historyValue:e.historyValue},this)}transition(e,t,r){return SA(e,t,r,[]).snapshot}microstep(e,t,r){return SA(e,t,r,[]).microstates}getTransitionData(e,t){return function e(t,r,a,s){if("string"==typeof r){let e;return(e=Sf(t,r).next(a,s))&&e.length?e:t.next(a,s)}if(1===Object.keys(r).length){let n,i;return(i=e(Sf(t,(n=Object.keys(r))[0]),r[n[0]],a,s))&&i.length?i:t.next(a,s)}let n=[];for(let i of Object.keys(r)){let o=r[i];if(!o)continue;let l=e(Sf(t,i),o,a,s);l&&n.push(...l)}return n.length?n:t.next(a,s)}(this.root,e.value,e,t)||[]}getPreInitialState(e,t,r){let{context:a}=this.config,s=S$({context:"function"!=typeof a&&a?a:{},_nodes:[this.root],children:{},status:"active"},this);return"function"==typeof a?SE(s,t,e,[SV(({spawn:e,event:t,self:r})=>a({spawn:e,input:t.input,self:r}))],r,void 0):s}getInitialSnapshot(e,t){let r=_D(t),a=[],s=this.getPreInitialState(e,r,a),{snapshot:n}=SA(SI([{target:[...Sg(this.root)],source:this.root,reenter:!0,actions:[],eventType:null,toJSON:null}],s,e,r,!0,a),r,e,a);return n}start(e){Object.values(e.children).forEach(e=>{"active"===e.getSnapshot().status&&e.start()})}getStateNodeById(e){let t=_z(e),r=t.slice(1),a=Sd(t[0])?t[0].slice(1):t[0],s=this.idMap.get(a);if(!s)throw Error(`Child state node '#${a}' does not exist on machine '${this.id}'`);return Sy(s,r)}get definition(){return this.root.definition}toJSON(){return this.definition}getPersistedSnapshot(e,t){return function(e,t){let{_nodes:r,tags:a,machine:s,children:n,context:i,can:o,hasTag:l,matches:u,getMeta:d,toJSON:p,...c}=e,h={};for(let e in n){let r=n[e];h[e]={snapshot:r.getPersistedSnapshot(t),src:r.src,systemId:r.systemId,syncSnapshot:r._syncSnapshot}}return{...c,context:function e(t){let r;for(let a in t){let s=t[a];if(s&&"object"==typeof s)if("sessionId"in s&&"send"in s&&"ref"in s)(r??=Array.isArray(t)?t.slice():{...t})[a]={xstate$$type:1,id:s.id};else{let n=e(s);n!==s&&((r??=Array.isArray(t)?t.slice():{...t})[a]=n)}}return r??t}(i),children:h,historyValue:function(e){if("object"!=typeof e||null===e)return{};let t={};for(let r in e){let a=e[r];Array.isArray(a)&&(t[r]=a.map(e=>({id:e.id})))}return t}(c.historyValue)}}(e,t)}restoreSnapshot(e,t){let r={},a=e.children;Object.keys(a).forEach(e=>{let s=a[e],n=s.snapshot,i=s.src,o="string"==typeof i?_J(this,i):i;if(!o)return;let l=_2(o,{id:e,parent:t.self,syncSnapshot:s.syncSnapshot,snapshot:n,src:i,systemId:s.systemId});r[e]=l});let s=function(e,t){if(!t||"object"!=typeof t)return{};let r={};for(let a in t)for(let s of t[a]){let t=function(e,t){if(t instanceof SY)return t;try{return e.machine.getStateNodeById(t.id)}catch{}}(e,s);t&&(r[a]??=[],r[a].push(t))}return r}(this.root,e.historyValue),n=S$({...e,children:r,_nodes:Array.from(Si(Sv(this.root,e.value))),historyValue:s},this),i=new Set;return!function e(t,r){if(!i.has(t))for(let a in i.add(t),t){let s=t[a];if(s&&"object"==typeof s){if("xstate$$type"in s&&1===s.xstate$$type){t[a]=r[s.id];continue}e(s,r)}}}(n.context,r),n}}function SX(e,t,r,a,{event:s}){return[t,{event:"function"==typeof s?s(r,a):s},void 0]}function S0(e,{event:t}){e.defer(()=>e.emit(t))}function S1(e){function t(e,t){}return t.type="xstate.emit",t.event=e,t.resolve=SX,t.execute=S0,t}let S2=((k={}).Parent="#_parent",k.Internal="#_internal",k);function S4(e,t,r,a,{to:s,event:n,id:i,delay:o},l){let u,d,p=t.machine.implementations.delays;if("string"==typeof n)throw Error(`Only event objects may be used with sendTo; use sendTo({ type: "${n}" }) instead`);let c="function"==typeof n?n(r,a):n;if("string"==typeof o){let e=p&&p[o];u="function"==typeof e?e(r,a):e}else u="function"==typeof o?o(r,a):o;let h="function"==typeof s?s(r,a):s;if("string"==typeof h){if(!(d=h===S2.Parent?e.self._parent:h===S2.Internal?e.self:h.startsWith("#_")?t.children[h.slice(2)]:l.deferredActorIds?.includes(h)?h:t.children[h]))throw Error(`Unable to send event to actor '${h}' from machine '${t.machine.id}'.`)}else d=h||e.self;return[t,{to:d,targetId:"string"==typeof h?h:void 0,event:c,id:i,delay:u},void 0]}function S5(e,t,r){"string"==typeof r.to&&(r.to=t.children[r.to])}function S3(e,t){e.defer(()=>{let{to:r,event:a,delay:s,id:n}=t;"number"==typeof s?e.system.scheduler.schedule(e.self,r,a,s,n):e.system._relay(e.self,r,"xstate.error"===a.type?_$(e.self.id,a.data):a)})}function S9(e,t,r){function a(e,t){}return a.type="xstate.sendTo",a.to=e,a.event=t,a.id=r?.id,a.delay=r?.delay,a.resolve=S4,a.retryResolve=S5,a.execute=S3,a}function S6(e,t,r,a,{collect:s}){let n=[],i=function(e){n.push(e)};return i.assign=(...e)=>{n.push(SV(...e))},i.cancel=(...e)=>{n.push(_3(...e))},i.raise=(...e)=>{n.push(Sz(...e))},i.sendTo=(...e)=>{n.push(S9(...e))},i.sendParent=(...e)=>{n.push(function(e,t){return S9(S2.Parent,e,t)}(...e))},i.spawnChild=(...e)=>{n.push(_8(...e))},i.stopChild=(...e)=>{n.push(St(...e))},i.emit=(...e)=>{n.push(S1(...e))},s({context:r.context,event:r.event,enqueue:i,check:e=>Sr(e,t.context,r.event,t),self:e.self,system:e.system},a),[t,void 0,n]}function S8(e){function t(e,t){}return t.type="xstate.enqueueActions",t.collect=e,t.resolve=S6,t}function S7(e,t,r,a,{value:s,label:n}){return[t,{value:"function"==typeof s?s(r,a):s,label:n},void 0]}function xe({logger:e},{value:t,label:r}){r?e(r,t):e(t)}function xt(e=({context:e,event:t})=>({context:e,event:t}),t){function r(e,t){}return r.type="xstate.log",r.value=e,r.label=t,r.resolve=S7,r.execute=xe,r}var xr=e.i(906920),xa=Object.defineProperty,xs=class{specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(e,t){for(const[t,r]of(this.patStr=e.pat_str,Object.entries(e.bpe_ranks.split("\n").filter(Boolean).reduce((e,t)=>{let[r,a,...s]=t.split(" "),n=Number.parseInt(a,10);return s.forEach((t,r)=>e[t]=n+r),e},{})))){const e=xr.default.toByteArray(t);this.rankMap.set(e.join(","),r),this.textMap.set(r,e)}this.specialTokens={...e.special_tokens,...t},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((e,[t,r])=>(e[r]=this.textEncoder.encode(t),e),{})}encode(e,t=[],r="all"){let a=RegExp(this.patStr,"ug"),s=xs.specialTokenRegex(Object.keys(this.specialTokens)),n=[],i=new Set("all"===t?Object.keys(this.specialTokens):t),o=new Set("all"===r?Object.keys(this.specialTokens).filter(e=>!i.has(e)):r);if(o.size>0){let t=xs.specialTokenRegex([...o]),r=e.match(t);if(null!=r)throw Error(`The text contains a special token that is not allowed: ${r[0]}`)}let l=0;for(;;){let t=null,r=l;for(;s.lastIndex=r,!(null==(t=s.exec(e))||i.has(t[0]));)r=t.index+1;let o=t?.index??e.length;for(let t of e.substring(l,o).matchAll(a)){let e=this.textEncoder.encode(t[0]),r=this.rankMap.get(e.join(","));if(null!=r){n.push(r);continue}n.push(...function(e,t){return 1===e.length?[t.get(e.join(","))]:(function(e,t){let r=Array.from({length:e.length},(e,t)=>({start:t,end:t+1}));for(;r.length>1;){let a=null;for(let s=0;s<r.length-1;s++){let n=e.slice(r[s].start,r[s+1].end),i=t.get(n.join(","));null!=i&&(null==a||i<a[0])&&(a=[i,s])}if(null!=a){let e=a[1];r[e]={start:r[e].start,end:r[e+1].end},r.splice(e+1,1)}else break}return r})(e,t).map(r=>t.get(e.slice(r.start,r.end).join(","))).filter(e=>null!=e)}(e,this.rankMap))}if(null==t)break;let u=this.specialTokens[t[0]];n.push(u),l=t.index+t[0].length}return n}decode(e){let t=[],r=0;for(let a=0;a<e.length;++a){let s=e[a],n=this.textMap.get(s)??this.inverseSpecialTokens[s];null!=n&&(t.push(n),r+=n.length)}let a=new Uint8Array(r),s=0;for(let e of t)a.set(e,s),s+=e.length;return this.textDecoder.decode(a)}};T="specialTokenRegex",E=e=>RegExp(e.map(e=>e.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")).join("|"),"g"),(s="symbol"!=typeof T?T+"":T)in xs?xa(xs,s,{enumerable:!0,configurable:!0,writable:!0,value:E}):xs[s]=E;var xn=(n={"../../node_modules/.pnpm/fast-deep-equal@3.1.3/node_modules/fast-deep-equal/index.js"(e,t){t.exports=function e(t,r){if(t===r)return!0;if(t&&r&&"object"==typeof t&&"object"==typeof r){if(t.constructor!==r.constructor)return!1;if(Array.isArray(t)){if((a=t.length)!=r.length)return!1;for(s=a;0!=s--;)if(!e(t[s],r[s]))return!1;return!0}if(t.constructor===RegExp)return t.source===r.source&&t.flags===r.flags;if(t.valueOf!==Object.prototype.valueOf)return t.valueOf()===r.valueOf();if(t.toString!==Object.prototype.toString)return t.toString()===r.toString();if((a=(n=Object.keys(t)).length)!==Object.keys(r).length)return!1;for(s=a;0!=s--;)if(!Object.prototype.hasOwnProperty.call(r,n[s]))return!1;for(s=a;0!=s--;){var a,s,n,i=n[s];if(!e(t[i],r[i]))return!1}return!0}return t!=t&&r!=r}}},function(){return i||(0,n[tq(n)[0]])((i={exports:{}}).exports,i),i.exports}),xi=((A=xi||{}).AGENT="AGENT",A.USER="USER",A.SYSTEM="SYSTEM",A.WORKFLOW="WORKFLOW",A),xo={traceId:"",spanId:"",traceFlags:0},xl={spanContext:()=>xo,setAttribute(){return this},setAttributes(){return this},addEvent(){return this},addLink(){return this},addLinks(){return this},setStatus(){return this},updateName(){return this},end(){return this},isRecording:()=>!1,recordException(){return this}},xu={startSpan:()=>xl,startActiveSpan:(e,t,r,a)=>"function"==typeof t?t(xl):"function"==typeof r?r(xl):"function"==typeof a?a(xl):void 0};function xd({isEnabled:e=!1,tracer:t}={}){return e?t||tb.trace.getTracer("mastra"):xu}function xp({operationId:e,telemetry:t}){return{"mastra.operationId":e,"operation.name":`${e}${t?.functionId!=null?` ${t.functionId}`:""}`,...t?.functionId?{"resource.name":t?.functionId}:{}}}function xc({operationId:e,model:t,modelSettings:r,telemetry_settings:a,headers:s}){let n=xd({isEnabled:a?.isEnabled,tracer:a?.tracer}),i=function({model:e,settings:t,telemetry:r,headers:a}){return{"aisdk.model.provider":e.provider,"aisdk.model.id":e.modelId,...Object.entries(t).reduce((e,[t,r])=>(e[`stream.settings.${t}`]=r,e),{}),...Object.entries(r?.metadata??{}).reduce((e,[t,r])=>(e[`stream.telemetry.metadata.${t}`]=r,e),{}),...Object.entries(a??{}).reduce((e,[t,r])=>(void 0!==r&&(e[`stream.request.headers.${t}`]=r),e),{})}}({model:{modelId:t.modelId,provider:t.provider},settings:r??{maxRetries:2},telemetry:a,headers:s});return{rootSpan:n.startSpan(e).setAttributes({...xp({operationId:e,telemetry:a}),...i})}}var xh=class extends Error{constructor(e){super(e),Object.setPrototypeOf(this,new.target.prototype)}},xm=async({tripwireReason:e,runId:t,tracingContext:r,options:a,model:s,messageList:n})=>{let i=new wz.ReadableStream({start(r){r.enqueue({type:"tripwire",runId:t,from:"AGENT",payload:{tripwireReason:e||""}}),r.close()}}),{rootSpan:o}=xc({operationId:"mastra.stream.tripwire",model:{modelId:s.modelId||"unknown",provider:s.provider||"unknown"},modelSettings:a.modelSettings,headers:a.modelSettings?.headers,telemetry_settings:a.telemetry});return new IS({model:{modelId:s.modelId,provider:s.provider,version:s.specificationVersion||"v2"},stream:i,messageList:n,options:{runId:t,rootSpan:o,telemetry_settings:a.telemetry,output:a.output,tracingContext:r,onFinish:a.onFinish,onStepFinish:a.onStepFinish,returnScorerData:a.returnScorerData},messageId:(0,ri.randomUUID)()})};async function xg({value:e,schema:t}){try{if(!t.validate)return{success:!0,value:e};let r=await t.validate(e);if(!r.success)return{success:!1,error:new wJ({value:e,cause:"Validation failed"})};return{success:!0,value:r.value}}catch(e){return{success:!1,error:e instanceof Error?e:Error(String(e))}}}var xf=class{status={type:"pending"};_promise;_resolve=void 0;_reject=void 0;get promise(){return this._promise||(this._promise=new Promise((e,t)=>{"resolved"===this.status.type?e(this.status.value):"rejected"===this.status.type&&t(this.status.error),this._resolve=e,this._reject=t})),this._promise}resolve(e){this.status={type:"resolved",value:e},this._promise&&this._resolve?.(e)}reject(e){this.status={type:"rejected",error:e},this._promise&&this._reject?.(e)}};async function xy({stream:e,onError:t}){let r=e.getReader();try{for(;;){let{done:e}=await r.read();if(e)break}}catch(e){console.error("consumeStream error",e),t?.(e)}finally{r.releaseLock()}}var xv=tB(xn(),1),xb=class extends wz.ReadableStream{#a={inputTokens:0,outputTokens:0,totalTokens:0};#s;#n;constructor({createStream:e,run:t}){const r={promise:null,resolve:null,reject:null};r.promise=new Promise((e,t)=>{r.resolve=e,r.reject=t});const a=e=>{"inputTokens"in e?(this.#a.inputTokens+=parseInt(e?.inputTokens?.toString()??"0",10),this.#a.outputTokens+=parseInt(e?.outputTokens?.toString()??"0",10)):"promptTokens"in e&&(this.#a.inputTokens+=parseInt(e?.promptTokens?.toString()??"0",10),this.#a.outputTokens+=parseInt(e?.completionTokens?.toString()??"0",10)),this.#a.totalTokens+=parseInt(e?.totalTokens?.toString()??"0",10)};super({start:async s=>{let n=new WritableStream({write:e=>{if("step-output"===e.type&&e.payload?.output?.from==="AGENT"&&e.payload?.output?.type==="finish"||"step-output"===e.type&&e.payload?.output?.from==="WORKFLOW"&&e.payload?.output?.type==="finish"){let t=e.payload?.output;if(t&&"payload"in t&&t.payload){let e=t.payload;"usage"in e&&e.usage&&a(e.usage)}}s.enqueue(e)}});s.enqueue({type:"workflow-start",runId:t.runId,from:"WORKFLOW",payload:{workflowId:t.workflowId}});let i=await e(n),o="success";for await(let e of i)"step-finish"===e.type&&e.payload.usage?a(e.payload.usage):"workflow-canceled"===e.type?o="canceled":"workflow-step-suspended"===e.type?o="suspended":"workflow-step-result"===e.type&&"failed"===e.payload.status&&(o="failed"),s.enqueue(e);s.enqueue({type:"workflow-finish",runId:t.runId,from:"WORKFLOW",payload:{workflowStatus:o,output:{usage:this.#a},metadata:{}}}),s.close(),r.resolve()}}),this.#n=t,this.#s=r}get status(){return this.#s.promise.then(()=>this.#n._getExecutionResults()).then(e=>e.status)}get result(){return this.#s.promise.then(()=>this.#n._getExecutionResults())}get usage(){return this.#s.promise.then(()=>this.#a)}};function xw({runId:e,scorerId:t,scorerObject:r,input:a,output:s,runtimeContext:n,entity:i,structuredOutput:o,source:l,entityType:u,threadId:d,resourceId:p,tracingContext:c}){let h=!1;if(r?.sampling&&r?.sampling?.type!=="none"||(h=!0),r?.sampling?.type&&(h=r?.sampling?.type!=="ratio"||Math.random()<r?.sampling?.rate),!h)return;let m={scorer:{id:t,name:r.scorer.name,description:r.scorer.description},input:a,output:s,runtimeContext:Object.fromEntries(n.entries()),runId:e,source:l,entity:i,structuredOutput:o,entityType:u,threadId:d,resourceId:p,tracingContext:c};wL("onScorerRun",m)}var x_=class extends tD{mastra;options;constructor({mastra:e,options:t}){super({name:"ExecutionEngine",component:tC}),this.mastra=e,this.options=t}__registerMastra(e){this.mastra=e}},xS=(e,t)=>{let r;if("string"==typeof t)r=e[t];else{if(!t?.id)return null;r=e[t.id]}return r?.status==="success"?r.output:null};async function xx({prevOutput:e,step:t,validateInputs:r}){let a,s=e;if(r){let r=t.inputSchema,n=await r.safeParseAsync(e);n.success?s=(e=>{if(!0===e||!1===e||null==e)return!0;if(wH(e))return 0===e;if("[object Date]"===Object.prototype.toString.call(e))return isNaN(e.getTime());if(e&&e.constructor&&e.call&&e.apply||e&&e.constructor===Symbol)return!1;let t=e.length;if(wH(t))return 0===t;let r=e.size;return wH(r)?0===r:0===Object.keys(e).length})(n.data)?e:n.data:a=Error("Step input validation failed: \n"+n.error.errors.map(e=>`- ${e.path?.join(".")}: ${e.message}`)?.join("\n"))}return{inputData:s,validationError:a}}var xI=class extends x_{preprocessExecutionError(e,t,r){let a=e instanceof tv?e:new tv(t,e);return!(e instanceof tv)&&e instanceof Error&&e.stack&&(a.stack=e.stack),this.logger?.trackException(a),this.logger?.error(r+a?.stack),a}runCounts=new Map;getOrGenerateRunCount(e){if(this.runCounts.has(e)){let t=this.runCounts.get(e)+1;return this.runCounts.set(e,t),t}return this.runCounts.set(e,0),0}async fmtReturnValue(e,t,r,a,s){let n={status:a.status,steps:r,input:r.input};if("success"===a.status)await t.emit("watch",{type:"watch",payload:{workflowState:{status:a.status,steps:r,result:a.output}},eventTimestamp:Date.now()}),n.result=a.output;else if("failed"===a.status)if(await t.emit("watch",{type:"watch",payload:{workflowState:{status:a.status,steps:r,result:null,error:a.error}},eventTimestamp:Date.now()}),s instanceof Error)n.error=s?.stack??s;else if(a.error)n.error=a.error;else if("string"==typeof s)n.error=s;else{let e=Error("Unknown error: "+tm(s));n.error=e?.stack??e}else"suspended"===a.status&&(n.suspended=Object.entries(r).flatMap(([e,t])=>{if(t?.status==="suspended"){let r=t?.suspendPayload?.__workflow_meta?.path;return r?[[e,...r]]:[[e]]}return[]}),await t.emit("watch",{type:"watch",payload:{workflowState:{status:a.status,steps:r,result:null,error:null}},eventTimestamp:Date.now()}));return e?.end(),n}async execute(e){let t,{workflowId:r,runId:a,resourceId:s,graph:n,input:i,initialState:o,resume:l,retryConfig:u,workflowAISpan:d,disableScorers:p}=e,{attempts:c=0,delay:h=0}=u??{},m=n.steps;if(this.runCounts.clear(),0===m.length){let e=new tv({id:"WORKFLOW_EXECUTE_EMPTY_GRAPH",text:"Workflow must have at least one step",domain:"MASTRA_WORKFLOW",category:"USER"});throw d?.error({error:e}),e}let g=this.mastra?.getTelemetry()?.tracer.startSpan(`workflow.${r}.execute`,{attributes:{componentName:r,runId:a,resourceId:s}}),f=0;l?.resumePath&&(f=l.resumePath[0],l.resumePath.shift());let y=l?.stepResults||{input:i},v=o??{};for(let n=f;n<m.length;n++){let i=m[n],u={workflowId:r,runId:a,executionPath:[n],suspendedPaths:{},retryConfig:{attempts:c,delay:h},executionSpan:g,format:e.format,state:v??o};try{if(t=await this.executeEntry({workflowId:r,runId:a,resourceId:s,entry:i,executionContext:u,serializedStepGraph:e.serializedStepGraph,prevStep:m[n-1],stepResults:y,resume:l,tracingContext:{currentSpan:d},abortController:e.abortController,emitter:e.emitter,runtimeContext:e.runtimeContext,writableStream:e.writableStream,disableScorers:p}),t.executionContext?.state&&(v=t.executionContext.state),"success"!==t.result.status){"bailed"===t.result.status&&(t.result.status="success");let n=await this.fmtReturnValue(g,e.emitter,y,t.result);return await this.persistStepUpdate({workflowId:r,runId:a,resourceId:s,stepResults:t.stepResults,serializedStepGraph:e.serializedStepGraph,executionContext:t.executionContext,workflowStatus:n.status,result:n.result,error:n.error,runtimeContext:e.runtimeContext}),n.error?d?.error({error:n.error,attributes:{status:n.status}}):d?.end({output:n.result,attributes:{status:n.status}}),n}}catch(o){let n=this.preprocessExecutionError(o,{id:"WORKFLOW_ENGINE_STEP_EXECUTION_FAILED",domain:"MASTRA_WORKFLOW",category:"USER",details:{workflowId:r,runId:a}},"Error executing step: "),i=await this.fmtReturnValue(g,e.emitter,y,t.result,o);return await this.persistStepUpdate({workflowId:r,runId:a,resourceId:s,stepResults:t.stepResults,serializedStepGraph:e.serializedStepGraph,executionContext:t.executionContext,workflowStatus:i.status,result:i.result,error:i.error,runtimeContext:e.runtimeContext}),d?.error({error:n,attributes:{status:i.status}}),i}}let b=await this.fmtReturnValue(g,e.emitter,y,t.result);return(await this.persistStepUpdate({workflowId:r,runId:a,resourceId:s,stepResults:t.stepResults,serializedStepGraph:e.serializedStepGraph,executionContext:t.executionContext,workflowStatus:b.status,result:b.result,error:b.error,runtimeContext:e.runtimeContext}),d?.end({output:b.result,attributes:{status:b.status}}),e.outputOptions?.includeState)?{...b,state:v}:b}getStepOutput(e,t){if(!t)return e.input;if("step"===t.type||"waitForEvent"===t.type)return e[t.step.id]?.output;if("sleep"===t.type||"sleepUntil"===t.type)return e[t.id]?.output;if("parallel"===t.type||"conditional"===t.type)return t.steps.reduce((t,r)=>{if("step"===r.type||"waitForEvent"===r.type)t[r.step.id]=e[r.step.id]?.output;else if("parallel"===r.type||"conditional"===r.type){let a=this.getStepOutput(e,r)?.output;t={...t,...a}}else"loop"===r.type||"foreach"===r.type?t[r.step.id]=e[r.step.id]?.output:("sleep"===r.type||"sleepUntil"===r.type)&&(t[r.id]=e[r.id]?.output);return t},{});if("loop"===t.type)return e[t.step.id]?.output;else if("foreach"===t.type)return e[t.step.id]?.output}async executeSleep({workflowId:e,runId:t,entry:r,prevOutput:a,stepResults:s,emitter:n,abortController:i,runtimeContext:o,executionContext:l,writableStream:u,tracingContext:d}){let{duration:p,fn:c}=r,h=d.currentSpan?.createChildSpan({type:"workflow_sleep",name:`sleep: ${p?`${p}ms`:"dynamic"}`,attributes:{durationMs:p,sleepType:c?"dynamic":"fixed"},tracingPolicy:this.options?.tracingPolicy});if(c){let r=(0,ri.randomUUID)();p=await c({runId:t,workflowId:e,mastra:this.mastra,runtimeContext:o,inputData:a,state:l.state,setState:e=>{l.state=e},runCount:-1,tracingContext:{currentSpan:h},getInitData:()=>s?.input,getStepResult:xS.bind(this,s),suspend:async e=>{},bail:()=>{},abort:()=>{i?.abort()},[t6]:n,[t8]:l.format,engine:{},abortSignal:i?.signal,writer:new rt({prefix:"workflow-step",callId:r,name:"sleep",runId:t},u)}),h?.update({attributes:{durationMs:p}})}try{await new Promise(e=>setTimeout(e,!p||p<0?0:p)),h?.end()}catch(e){h?.error({error:e})}}async executeSleepUntil({workflowId:e,runId:t,entry:r,prevOutput:a,stepResults:s,emitter:n,abortController:i,runtimeContext:o,executionContext:l,writableStream:u,tracingContext:d}){let{date:p,fn:c}=r,h=d.currentSpan?.createChildSpan({type:"workflow_sleep",name:`sleepUntil: ${p?p.toISOString():"dynamic"}`,attributes:{untilDate:p,durationMs:p?Math.max(0,p.getTime()-Date.now()):void 0,sleepType:c?"dynamic":"fixed"},tracingPolicy:this.options?.tracingPolicy});if(c){let r=(0,ri.randomUUID)(),d=(p=await c({runId:t,workflowId:e,mastra:this.mastra,runtimeContext:o,inputData:a,state:l.state,setState:e=>{l.state=e},runCount:-1,tracingContext:{currentSpan:h},getInitData:()=>s?.input,getStepResult:xS.bind(this,s),suspend:async e=>{},bail:()=>{},abort:()=>{i?.abort()},[t6]:n,[t8]:l.format,engine:{},abortSignal:i?.signal,writer:new rt({prefix:"workflow-step",callId:r,name:"sleepUntil",runId:t},u)}))?p.getTime()-Date.now():0;h?.update({attributes:{durationMs:Math.max(0,d)}})}let m=p?p?.getTime()-Date.now():0;try{await new Promise(e=>setTimeout(e,m<0?0:m)),h?.end()}catch(e){h?.error({error:e})}}async executeWaitForEvent({event:e,emitter:t,timeout:r,tracingContext:a}){let s=a?.currentSpan?.createChildSpan({type:"workflow_wait_event",name:`wait: ${e}`,attributes:{eventName:e,timeoutMs:r},tracingPolicy:this.options?.tracingPolicy}),n=Date.now();return new Promise((a,i)=>{let o=e=>{s?.end({output:e,attributes:{eventReceived:!0,waitDurationMs:Date.now()-n}}),a(e)};r&&setTimeout(()=>{t.off(`user-event-${e}`,o);let r=Error("Timeout waiting for event");s?.error({error:r,attributes:{eventReceived:!1,waitDurationMs:Date.now()-n}}),i(r)},r),t.once(`user-event-${e}`,o)})}async executeStep({workflowId:e,runId:t,resourceId:r,step:a,stepResults:s,executionContext:n,resume:i,prevOutput:o,emitter:l,abortController:u,runtimeContext:d,skipEmits:p=!1,writableStream:c,disableScorers:h,serializedStepGraph:m,tracingContext:g,iterationCount:f}){let y,v,b,w,_=i?.steps[0]===a.id?void 0:Date.now(),S=i?.steps[0]===a.id?Date.now():void 0,I=(0,ri.randomUUID)(),{inputData:k,validationError:T}=await xx({prevOutput:o,step:a,validateInputs:this.options?.validateInputs??!1}),E={...s[a.id],...i?.steps[0]===a.id?{resumePayload:i?.resumePayload}:{payload:k},..._?{startedAt:_}:{},...S?{resumedAt:S}:{},status:"running",...f?{metadata:{iterationCount:f}}:{}},A=g.currentSpan?.createChildSpan({name:`workflow step: '${a.id}'`,type:"workflow_step",input:k,attributes:{stepId:a.id},tracingPolicy:this.options?.tracingPolicy});p||(await l.emit("watch",{type:"watch",payload:{currentStep:{id:a.id,...E},workflowState:{status:"running",steps:{...s,[a.id]:{...E}},result:null,error:null}},eventTimestamp:Date.now()}),await l.emit("watch-v2",{type:"workflow-step-start",payload:{id:a.id,stepCallId:I,...E}})),await this.persistStepUpdate({workflowId:e,runId:t,resourceId:r,serializedStepGraph:m,stepResults:{...s,[a.id]:E},executionContext:n,workflowStatus:"running",runtimeContext:d});let O=(y=a,v=`workflow.${e}.step.${a.id}`,b={componentName:e,runId:t,resourceId:r??""},async e=>{let t=this.mastra?.getTelemetry(),r=n.executionSpan;return t&&r?t_.context.with(tb.trace.setSpan(t_.context.active(),r),async()=>t.traceMethod(y.execute.bind(y),{spanName:v,attributes:b})(e)):y.execute(e)}),C=a.retries??n.retryConfig.attempts??0,R=n.retryConfig.delay??0;for(let o=0;o<C+1;o++){o>0&&R&&await new Promise(e=>setTimeout(e,R));try{let o,p;if(T)throw T;let m=await O({runId:t,resourceId:r,workflowId:e,mastra:this.mastra?l4(this.mastra,{currentSpan:A}):void 0,runtimeContext:d,inputData:k,state:n.state,setState:e=>{n.state=e},runCount:this.getOrGenerateRunCount(a.id),resumeData:i?.steps[0]===a.id?i?.resumePayload:void 0,tracingContext:{currentSpan:A},getInitData:()=>s?.input,getStepResult:xS.bind(this,s),suspend:async e=>{n.suspendedPaths[a.id]=n.executionPath,o={payload:e}},bail:e=>{p={payload:e}},abort:()=>{u?.abort()},resume:s[a.id]?.status==="suspended"?{steps:i?.steps?.slice(1)||[],resumePayload:i?.resumePayload,runId:s[a.id]?.suspendPayload?.__workflow_meta?.runId}:void 0,[t6]:l,[t8]:n.format,engine:{},abortSignal:u?.signal,writer:new rt({prefix:"workflow-step",callId:I,name:a.id,runId:t},c),scorers:!1===h?void 0:a.scorers,validateInputs:this.options?.validateInputs});a.scorers&&await this.runScorers({scorers:a.scorers,runId:t,input:k,output:m,workflowId:e,stepId:a.id,runtimeContext:d,disableScorers:h,tracingContext:{currentSpan:g.currentSpan}}),w=o?{status:"suspended",suspendPayload:o.payload,suspendedAt:Date.now()}:p?{status:"bailed",output:p.payload,endedAt:Date.now()}:{status:"success",output:m,endedAt:Date.now()};break}catch(s){let r=this.preprocessExecutionError(s,{id:"WORKFLOW_STEP_INVOKE_FAILED",domain:"MASTRA_WORKFLOW",category:"USER",details:{workflowId:e,runId:t,stepId:a.id}},`Error executing step ${a.id}: `);A?.error({error:r,attributes:{status:"failed"}}),w={status:"failed",error:r?.stack,endedAt:Date.now()}}}return p||(await l.emit("watch",{type:"watch",payload:{currentStep:{id:a.id,...E,...w},workflowState:{status:"running",steps:{...s,[a.id]:{...E,...w}},result:null,error:null}},eventTimestamp:Date.now()}),"suspended"===w.status?await l.emit("watch-v2",{type:"workflow-step-suspended",payload:{id:a.id,stepCallId:I,...w}}):(await l.emit("watch-v2",{type:"workflow-step-result",payload:{id:a.id,stepCallId:I,...w}}),await l.emit("watch-v2",{type:"workflow-step-finish",payload:{id:a.id,stepCallId:I,metadata:{}}}))),"failed"!=w.status&&A?.end({output:w.output,attributes:{status:w.status}}),{...E,...w}}async runScorers({scorers:e,runId:t,input:r,output:a,workflowId:s,stepId:n,runtimeContext:i,disableScorers:o,tracingContext:l}){let u=e;if("function"==typeof u)try{u=await u({runtimeContext:i})}catch(e){this.preprocessExecutionError(e,{id:"WORKFLOW_FAILED_TO_FETCH_SCORERS",domain:"MASTRA_WORKFLOW",category:"USER",details:{runId:t,workflowId:s,stepId:n}},"Error fetching scorers: ")}if(!o&&u&&Object.keys(u||{}).length>0)for(let[e,o]of Object.entries(u||{}))xw({scorerId:o.name,scorerObject:o,runId:t,input:r,output:a,runtimeContext:i,entity:{id:s,stepId:n},structuredOutput:!0,source:"LIVE",entityType:"WORKFLOW",tracingContext:l})}async executeParallel({workflowId:e,runId:t,resourceId:r,entry:a,prevStep:s,serializedStepGraph:n,stepResults:i,resume:o,executionContext:l,tracingContext:u,emitter:d,abortController:p,runtimeContext:c,writableStream:h,disableScorers:m}){let g,f=u.currentSpan?.createChildSpan({type:"workflow_parallel",name:`parallel: '${a.steps.length} branches'`,input:this.getStepOutput(i,s),attributes:{branchCount:a.steps.length,parallelSteps:a.steps.map(e=>"step"===e.type?e.step.id:`control-${e.type}`)},tracingPolicy:this.options?.tracingPolicy}),y=await Promise.all(a.steps.map((a,u)=>this.executeEntry({workflowId:e,runId:t,resourceId:r,entry:a,prevStep:s,stepResults:i,serializedStepGraph:n,resume:o,executionContext:{workflowId:e,runId:t,executionPath:[...l.executionPath,u],suspendedPaths:l.suspendedPaths,retryConfig:l.retryConfig,executionSpan:l.executionSpan,state:l.state},tracingContext:{currentSpan:f},emitter:d,abortController:p,runtimeContext:c,writableStream:h,disableScorers:m}))),v=y.find(e=>"failed"===e.result.status),b=y.find(e=>"suspended"===e.result.status);return"failed"===(g=v?{status:"failed",error:v.result.error}:b?{status:"suspended",payload:b.result.suspendPayload}:p?.signal?.aborted?{status:"canceled"}:{status:"success",output:y.reduce((e,t,r)=>("success"===t.result.status&&(e[a.steps[r].step.id]=t.result.output),e),{})}).status?f?.error({error:Error(g.error)}):f?.end({output:g.output||g}),g}async executeConditional({workflowId:e,runId:t,resourceId:r,entry:a,prevOutput:s,prevStep:n,serializedStepGraph:i,stepResults:o,resume:l,executionContext:u,tracingContext:d,emitter:p,abortController:c,runtimeContext:h,writableStream:m,disableScorers:g}){let f,y=d.currentSpan?.createChildSpan({type:"workflow_conditional",name:`conditional: '${a.conditions.length} conditions'`,input:s,attributes:{conditionCount:a.conditions.length},tracingPolicy:this.options?.tracingPolicy}),v=(await Promise.all(a.conditions.map(async(r,a)=>{let n=y?.createChildSpan({type:"workflow_conditional_eval",name:`condition '${a}'`,input:s,attributes:{conditionIndex:a},tracingPolicy:this.options?.tracingPolicy});try{let i=await r({runId:t,workflowId:e,mastra:this.mastra,runtimeContext:h,inputData:s,state:u.state,setState:e=>{u.state=e},runCount:-1,tracingContext:{currentSpan:n},getInitData:()=>o?.input,getStepResult:xS.bind(this,o),suspend:async e=>{},bail:()=>{},abort:()=>{c?.abort()},[t6]:p,[t8]:u.format,engine:{},abortSignal:c?.signal,writer:new rt({prefix:"workflow-step",callId:(0,ri.randomUUID)(),name:"conditional",runId:t},m)});return n?.end({output:i,attributes:{result:!!i}}),i?a:null}catch(a){let r=this.preprocessExecutionError(a,{id:"WORKFLOW_CONDITION_EVALUATION_FAILED",domain:"MASTRA_WORKFLOW",category:"USER",details:{workflowId:e,runId:t}},"Error evaluating condition: ");return n?.error({error:r,attributes:{result:!1}}),null}}))).filter(e=>null!==e),b=a.steps.filter((e,t)=>v.includes(t));y?.update({attributes:{truthyIndexes:v,selectedSteps:b.map(e=>"step"===e.type?e.step.id:`control-${e.type}`)}});let w=b.filter(e=>{if(l&&"step"===e.type){let t=o[e.step.id];return!t||"suspended"===t.status||"failed"===t.status}return!0}),_=await Promise.all(w.map((a,s)=>this.executeEntry({workflowId:e,runId:t,resourceId:r,entry:a,prevStep:n,stepResults:o,serializedStepGraph:i,resume:l,executionContext:{workflowId:e,runId:t,executionPath:[...u.executionPath,b.indexOf(a)],suspendedPaths:u.suspendedPaths,retryConfig:u.retryConfig,executionSpan:u.executionSpan,state:u.state},tracingContext:{currentSpan:y},emitter:p,abortController:c,runtimeContext:h,writableStream:m,disableScorers:g}))),S={...o};_.forEach(e=>{"stepResults"in e&&e.stepResults&&Object.assign(S,e.stepResults)});let I=b.map(e=>{if("step"===e.type){let t=S[e.step.id];if(t)return{result:t}}return{result:{status:"success",output:{}}}}).filter(Boolean),k=I.find(e=>"failed"===e.result.status),T=I.find(e=>"suspended"===e.result.status);return"failed"===(f=k?{status:"failed",error:k.result.error}:T?{status:"suspended",payload:T.result.suspendPayload}:c?.signal?.aborted?{status:"canceled"}:{status:"success",output:I.reduce((e,t,r)=>("success"===t.result.status&&(e[b[r].step.id]=t.result.output),e),{})}).status?y?.error({error:Error(f.error)}):y?.end({output:f.output||f}),f}async executeLoop({workflowId:e,runId:t,resourceId:r,entry:a,prevOutput:s,stepResults:n,resume:i,executionContext:o,tracingContext:l,emitter:u,abortController:d,runtimeContext:p,writableStream:c,disableScorers:h,serializedStepGraph:m}){let{step:g,condition:f}=a,y=l.currentSpan?.createChildSpan({type:"workflow_loop",name:`loop: '${a.loopType}'`,input:s,attributes:{loopType:a.loopType},tracingPolicy:this.options?.tracingPolicy}),v=!0,b=n[g.id]?.metadata?.iterationCount,w=b?b-1:0,_={status:"success",output:n[g.id]?.payload??s},S=i;do{if(_=await this.executeStep({workflowId:e,runId:t,resourceId:r,step:g,stepResults:n,executionContext:o,resume:S,prevOutput:_.output,tracingContext:{currentSpan:y},emitter:u,abortController:d,runtimeContext:p,writableStream:c,disableScorers:h,serializedStepGraph:m,iterationCount:w+1}),S&&"suspended"!==_.status&&(S=void 0),"success"!==_.status)return y?.end({attributes:{totalIterations:w}}),_;let s=y?.createChildSpan({type:"workflow_conditional_eval",name:`condition: '${a.loopType}'`,input:function(e,t){if(!e||"object"!=typeof e)return e;let r={};for(let s of t){var a;let t=(a=e,s.split(".").reduce((e,t)=>e&&"object"==typeof e?e[t]:void 0,a));void 0!==t&&function(e,t,r){let a=t.split("."),s=a.pop();s&&(a.reduce((e,t)=>(e[t]&&"object"==typeof e[t]||(e[t]={}),e[t]),e)[s]=r)}(r,s,t)}return r}(_.output,["stepResult","output.text","output.object","messages"]),attributes:{conditionIndex:w},tracingPolicy:this.options?.tracingPolicy});v=await f({workflowId:e,runId:t,mastra:this.mastra,runtimeContext:p,inputData:_.output,state:o.state,setState:e=>{o.state=e},runCount:-1,tracingContext:{currentSpan:s},iterationCount:w+1,getInitData:()=>n?.input,getStepResult:xS.bind(this,n),suspend:async e=>{},bail:()=>{},abort:()=>{d?.abort()},[t6]:u,[t8]:o.format,engine:{},abortSignal:d?.signal,writer:new rt({prefix:"workflow-step",callId:(0,ri.randomUUID)(),name:"loop",runId:t},c)}),s?.end({output:v}),w++}while("dowhile"===a.loopType?v:!v)return y?.end({output:_.output,attributes:{totalIterations:w}}),_}async executeForeach({workflowId:e,runId:t,resourceId:r,entry:a,prevOutput:s,stepResults:n,resume:i,executionContext:o,tracingContext:l,emitter:u,abortController:d,runtimeContext:p,writableStream:c,disableScorers:h,serializedStepGraph:m}){let{step:g,opts:f}=a,y=[],v=f.concurrency,b=i?.steps[0]===g.id?void 0:Date.now(),w=i?.steps[0]===g.id?Date.now():void 0,_={...n[g.id],...i?.steps[0]===g.id?{resumePayload:i?.resumePayload}:{payload:s},...b?{startedAt:b}:{},...w?{resumedAt:w}:{}},S=l.currentSpan?.createChildSpan({type:"workflow_loop",name:"loop: 'foreach'",input:s,attributes:{loopType:"foreach",concurrency:v},tracingPolicy:this.options?.tracingPolicy});await u.emit("watch",{type:"watch",payload:{currentStep:{id:g.id,status:"running",..._},workflowState:{status:"running",steps:{...n,[g.id]:{status:"running",..._}},result:null,error:null}},eventTimestamp:Date.now()}),await u.emit("watch-v2",{type:"workflow-step-start",payload:{id:g.id,..._,status:"running"}});let I=n[g.id],k=I?.status==="suspended"&&I?.suspendPayload?.__workflow_meta?.foreachIndex||0;for(let a=k;a<s.length;a+=v){let l=s.slice(a,a+v);for(let s of(await Promise.all(l.map((s,l)=>this.executeStep({workflowId:e,runId:t,resourceId:r,step:g,stepResults:n,executionContext:o,resume:k===a+l?i:void 0,prevOutput:s,tracingContext:{currentSpan:S},emitter:u,abortController:d,runtimeContext:p,skipEmits:!0,writableStream:c,disableScorers:h,serializedStepGraph:m}))))){if("success"!==s.status){let{status:e,error:t,suspendPayload:r,suspendedAt:i,endedAt:o,output:l}=s,d={status:e,error:t,suspendPayload:r,suspendedAt:i,endedAt:o,output:l};if(await u.emit("watch",{type:"watch",payload:{currentStep:{id:g.id,..._,...d},workflowState:{status:"running",steps:{...n,[g.id]:{..._,...d}},result:null,error:null}},eventTimestamp:Date.now()}),"suspended"===d.status)return await u.emit("watch-v2",{type:"workflow-step-suspended",payload:{id:g.id,...d}}),{..._,status:"suspended",suspendPayload:{...d.suspendPayload,__workflow_meta:{...d.suspendPayload?.__workflow_meta,foreachIndex:a}},endedAt:Date.now()};return await u.emit("watch-v2",{type:"workflow-step-result",payload:{id:g.id,...d}}),await u.emit("watch-v2",{type:"workflow-step-finish",payload:{id:g.id,metadata:{}}}),s}y.push(s?.output)}}return await u.emit("watch",{type:"watch",payload:{currentStep:{id:g.id,..._,status:"success",output:y,endedAt:Date.now()},workflowState:{status:"running",steps:{...n,[g.id]:{..._,status:"success",output:y,endedAt:Date.now()}},result:null,error:null}},eventTimestamp:Date.now()}),await u.emit("watch-v2",{type:"workflow-step-result",payload:{id:g.id,status:"success",output:y,endedAt:Date.now()}}),await u.emit("watch-v2",{type:"workflow-step-finish",payload:{id:g.id,metadata:{}}}),S?.end({output:y}),{..._,status:"success",output:y,endedAt:Date.now()}}async persistStepUpdate({workflowId:e,runId:t,resourceId:r,stepResults:a,serializedStepGraph:s,executionContext:n,workflowStatus:i,result:o,error:l,runtimeContext:u}){if(!this.options?.shouldPersistSnapshot?.({stepResults:a,workflowStatus:i}))return;let d={};u.forEach((e,t)=>{d[t]=e}),await this.mastra?.getStorage()?.persistWorkflowSnapshot({workflowName:e,runId:t,resourceId:r,snapshot:{runId:t,status:i,value:n.state,context:a,activePaths:[],serializedStepGraph:s,suspendedPaths:n.suspendedPaths,waitingPaths:{},result:o,error:l,runtimeContext:d,timestamp:Date.now()}})}async executeEntry({workflowId:e,runId:t,resourceId:r,entry:a,prevStep:s,serializedStepGraph:n,stepResults:i,resume:o,executionContext:l,tracingContext:u,emitter:d,abortController:p,runtimeContext:c,writableStream:h,disableScorers:m}){let g,f=this.getStepOutput(i,s);if("step"===a.type){let{step:s}=a;g=await this.executeStep({workflowId:e,runId:t,resourceId:r,step:s,stepResults:i,executionContext:l,resume:o,prevOutput:f,tracingContext:u,emitter:d,abortController:p,runtimeContext:c,writableStream:h,disableScorers:m,serializedStepGraph:n})}else if(o?.resumePath?.length&&"parallel"===a.type){let f=o.resumePath.shift(),y=await this.executeEntry({workflowId:e,runId:t,resourceId:r,entry:a.steps[f],prevStep:s,serializedStepGraph:n,stepResults:i,resume:o,executionContext:{workflowId:e,runId:t,executionPath:[...l.executionPath,f],suspendedPaths:l.suspendedPaths,retryConfig:l.retryConfig,executionSpan:l.executionSpan,state:l.state},tracingContext:u,emitter:d,abortController:p,runtimeContext:c,writableStream:h,disableScorers:m});if(y.stepResults&&Object.assign(i,y.stepResults),a.steps.every(e=>{if("step"===e.type){let t=i[e.step.id];return t&&"success"===t.status}return!0}))g={status:"success",output:a.steps.reduce((e,t)=>{if("step"===t.type){let r=i[t.step.id];r&&"success"===r.status&&(e[t.step.id]=r.output)}return e},{})};else{let e=a.steps.find(e=>{if("step"===e.type){let t=i[e.step.id];return t&&"suspended"===t.status}return!1});g={status:"suspended",payload:e&&"step"===e.type?i[e.step.id]?.suspendPayload:{}}}let v={...l,...y.executionContext,suspendedPaths:{...l.suspendedPaths,...y.executionContext?.suspendedPaths}};return"suspended"===g.status&&a.steps.forEach((e,t)=>{if("step"===e.type){let r=i[e.step.id];r&&"suspended"===r.status&&(v.suspendedPaths[e.step.id]=[...l.executionPath,t])}}),{result:g,stepResults:y.stepResults,executionContext:v}}else if("parallel"===a.type)g=await this.executeParallel({workflowId:e,runId:t,entry:a,prevStep:s,stepResults:i,serializedStepGraph:n,resume:o,executionContext:l,tracingContext:u,emitter:d,abortController:p,runtimeContext:c,writableStream:h,disableScorers:m});else if("conditional"===a.type)g=await this.executeConditional({workflowId:e,runId:t,entry:a,prevStep:s,prevOutput:f,stepResults:i,serializedStepGraph:n,resume:o,executionContext:l,tracingContext:u,emitter:d,abortController:p,runtimeContext:c,writableStream:h,disableScorers:m});else if("loop"===a.type)g=await this.executeLoop({workflowId:e,runId:t,entry:a,prevStep:s,prevOutput:f,stepResults:i,resume:o,executionContext:l,tracingContext:u,emitter:d,abortController:p,runtimeContext:c,writableStream:h,disableScorers:m,serializedStepGraph:n});else if("foreach"===a.type)g=await this.executeForeach({workflowId:e,runId:t,entry:a,prevStep:s,prevOutput:f,stepResults:i,resume:o,executionContext:l,tracingContext:u,emitter:d,abortController:p,runtimeContext:c,writableStream:h,disableScorers:m,serializedStepGraph:n});else if("sleep"===a.type){let m=Date.now();await d.emit("watch",{type:"watch",payload:{currentStep:{id:a.id,status:"waiting",payload:f,startedAt:m},workflowState:{status:"waiting",steps:{...i,[a.id]:{status:"waiting",payload:f,startedAt:m}},result:null,error:null}},eventTimestamp:Date.now()}),await d.emit("watch-v2",{type:"workflow-step-waiting",payload:{id:a.id,payload:f,startedAt:m,status:"waiting"}}),await this.persistStepUpdate({workflowId:e,runId:t,resourceId:r,serializedStepGraph:n,stepResults:i,executionContext:l,workflowStatus:"waiting",runtimeContext:c}),await this.executeSleep({workflowId:e,runId:t,entry:a,prevStep:s,prevOutput:f,stepResults:i,serializedStepGraph:n,resume:o,executionContext:l,tracingContext:u,emitter:d,abortController:p,runtimeContext:c,writableStream:h}),await this.persistStepUpdate({workflowId:e,runId:t,resourceId:r,serializedStepGraph:n,stepResults:i,executionContext:l,workflowStatus:"running",runtimeContext:c});let y=Date.now(),v={payload:f,startedAt:m,endedAt:y};g={...v,status:"success",output:f},i[a.id]={...v,status:"success",output:f},await d.emit("watch",{type:"watch",payload:{currentStep:{id:a.id,...g},workflowState:{status:"running",steps:{...i,[a.id]:{...g}},result:null,error:null}},eventTimestamp:Date.now()}),await d.emit("watch-v2",{type:"workflow-step-result",payload:{id:a.id,endedAt:y,status:"success",output:f}}),await d.emit("watch-v2",{type:"workflow-step-finish",payload:{id:a.id,metadata:{}}})}else if("sleepUntil"===a.type){let m=Date.now();await d.emit("watch",{type:"watch",payload:{currentStep:{id:a.id,status:"waiting",payload:f,startedAt:m},workflowState:{status:"waiting",steps:{...i,[a.id]:{status:"waiting",payload:f,startedAt:m}},result:null,error:null}},eventTimestamp:Date.now()}),await d.emit("watch-v2",{type:"workflow-step-waiting",payload:{id:a.id,payload:f,startedAt:m,status:"waiting"}}),await this.persistStepUpdate({workflowId:e,runId:t,resourceId:r,serializedStepGraph:n,stepResults:i,executionContext:l,workflowStatus:"waiting",runtimeContext:c}),await this.executeSleepUntil({workflowId:e,runId:t,entry:a,prevStep:s,prevOutput:f,stepResults:i,serializedStepGraph:n,resume:o,executionContext:l,tracingContext:u,emitter:d,abortController:p,runtimeContext:c,writableStream:h}),await this.persistStepUpdate({workflowId:e,runId:t,resourceId:r,serializedStepGraph:n,stepResults:i,executionContext:l,workflowStatus:"running",runtimeContext:c});let y=Date.now(),v={payload:f,startedAt:m,endedAt:y};g={...v,status:"success",output:f},i[a.id]={...v,status:"success",output:f},await d.emit("watch",{type:"watch",payload:{currentStep:{id:a.id,...g},workflowState:{status:"running",steps:{...i,[a.id]:{...g}},result:null,error:null}},eventTimestamp:Date.now()}),await d.emit("watch-v2",{type:"workflow-step-result",payload:{id:a.id,endedAt:y,status:"success",output:f}}),await d.emit("watch-v2",{type:"workflow-step-finish",payload:{id:a.id,metadata:{}}})}else if("waitForEvent"===a.type){let s,o=Date.now();await d.emit("watch",{type:"watch",payload:{currentStep:{id:a.step.id,status:"waiting",payload:f,startedAt:o},workflowState:{status:"waiting",steps:{...i,[a.step.id]:{status:"waiting",payload:f,startedAt:o}},result:null,error:null}},eventTimestamp:Date.now()}),await d.emit("watch-v2",{type:"workflow-step-waiting",payload:{id:a.step.id,payload:f,startedAt:o,status:"waiting"}}),i[a.step.id]={status:"waiting",payload:f,startedAt:o},await this.persistStepUpdate({workflowId:e,runId:t,resourceId:r,serializedStepGraph:n,stepResults:i,executionContext:l,workflowStatus:"waiting",runtimeContext:c});try{s=await this.executeWaitForEvent({event:a.event,emitter:d,timeout:a.timeout,tracingContext:u});let{step:o}=a;g=await this.executeStep({workflowId:e,runId:t,resourceId:r,step:o,stepResults:i,executionContext:l,resume:{resumePayload:s,steps:[a.step.id]},prevOutput:f,tracingContext:u,emitter:d,abortController:p,runtimeContext:c,writableStream:h,disableScorers:m,serializedStepGraph:n})}catch(e){g={status:"failed",error:e}}let y=Date.now();g={...g,payload:f,startedAt:o,endedAt:y}}return("step"===a.type||"waitForEvent"===a.type||"loop"===a.type||"foreach"===a.type)&&(i[a.step.id]=g),p?.signal?.aborted&&(g={...g,status:"canceled"}),await this.persistStepUpdate({workflowId:e,runId:t,resourceId:r,serializedStepGraph:n,stepResults:i,executionContext:l,workflowStatus:"success"===g.status?"running":g.status,runtimeContext:c}),"canceled"===g.status&&await d.emit("watch-v2",{type:"workflow-canceled",payload:{}}),{result:g,stepResults:i,executionContext:l}}};function xk(e){if(e instanceof If)return{id:e.name,description:e.getDescription(),inputSchema:rb.z.object({prompt:rb.z.string()}),outputSchema:rb.z.object({text:rb.z.string()}),execute:async({inputData:t,[t6]:r,[t8]:a,runtimeContext:s,abortSignal:n,abort:i,writer:o})=>{let l,u={};u.promise=new Promise((e,t)=>{u.resolve=e,u.reject=t});let d={name:e.name,args:t};if("v1"===(await e.getModel()).specificationVersion){let{fullStream:r}=await e.streamLegacy(t.prompt,{runtimeContext:s,onFinish:e=>{u.resolve(e.text)},abortSignal:n});l=r}else l=(await e.stream(t.prompt,{runtimeContext:s,onFinish:e=>{u.resolve(e.text)},abortSignal:n})).fullStream;if("aisdk"===a){for await(let e of(await r.emit("watch-v2",{type:"tool-call-streaming-start",...d??{}}),l))"text-delta"===e.type&&await r.emit("watch-v2",{type:"tool-call-delta",...d??{},argsTextDelta:e.textDelta});await r.emit("watch-v2",{type:"tool-call-streaming-finish",...d??{}})}else for await(let e of l)await o.write(e);return n.aborted?i():{text:await u.promise}},component:e.component};if(e instanceof ra){if(!e.inputSchema||!e.outputSchema)throw Error("Tool must have input and output schemas defined");return{id:e.id,description:e.description,inputSchema:e.inputSchema,outputSchema:e.outputSchema,execute:async({inputData:t,mastra:r,runtimeContext:a,tracingContext:s,suspend:n,resumeData:i})=>e.execute({context:t,mastra:r,runtimeContext:a,tracingContext:s,suspend:n,resumeData:i}),component:"TOOL"}}return{id:e.id,description:e.description,inputSchema:e.inputSchema,stateSchema:e.stateSchema,outputSchema:e.outputSchema,resumeSchema:e.resumeSchema,suspendSchema:e.suspendSchema,scorers:e.scorers,retries:e.retries,execute:e.execute.bind(e)}}function xT(e){return new xE(e)}var xE=class extends tD{id;description;inputSchema;outputSchema;stateSchema;steps;stepDefs;stepFlow;serializedStepFlow;executionEngine;executionGraph;#r;retryConfig;#t;#i=new Map;constructor({mastra:e,id:t,inputSchema:r,outputSchema:a,stateSchema:s,description:n,executionEngine:i,retryConfig:o,steps:l,options:u={}}){super({name:t,component:tC}),this.id=t,this.description=n,this.inputSchema=r,this.outputSchema=a,this.stateSchema=s,this.retryConfig=o??{attempts:0,delay:0},this.executionGraph=this.buildExecutionGraph(),this.stepFlow=[],this.serializedStepFlow=[],this.#t=e,this.steps={},this.stepDefs=l,this.#r={validateInputs:u.validateInputs??!1,shouldPersistSnapshot:u.shouldPersistSnapshot??(()=>!0),tracingPolicy:u.tracingPolicy},i?this.executionEngine=i:this.executionEngine=new xI({mastra:this.#t,options:this.#r}),this.#i=new Map}get runs(){return this.#i}get mastra(){return this.#t}get options(){return this.#r}__registerMastra(e){this.#t=e,this.executionEngine.__registerMastra(e)}__registerPrimitives(e){e.telemetry&&this.__setTelemetry(e.telemetry),e.logger&&this.__setLogger(e.logger)}setStepFlow(e){this.stepFlow=e}then(e){return this.stepFlow.push({type:"step",step:e}),this.serializedStepFlow.push({type:"step",step:{id:e.id,description:e.description,component:e.component,serializedStepFlow:e.serializedStepFlow}}),this.steps[e.id]=e,this}sleep(e){let t=`sleep_${this.#t?.generateId()||(0,ri.randomUUID)()}`,r="function"==typeof e?{type:"sleep",id:t,fn:e}:{type:"sleep",id:t,duration:e},a="function"==typeof e?{type:"sleep",id:t,fn:e.toString()}:{type:"sleep",id:t,duration:e};return this.stepFlow.push(r),this.serializedStepFlow.push(a),this.steps[t]=xk({id:t,inputSchema:rb.z.object({}),outputSchema:rb.z.object({}),execute:async()=>({})}),this}sleepUntil(e){let t=`sleep_${this.#t?.generateId()||(0,ri.randomUUID)()}`,r="function"==typeof e?{type:"sleepUntil",id:t,fn:e}:{type:"sleepUntil",id:t,date:e},a="function"==typeof e?{type:"sleepUntil",id:t,fn:e.toString()}:{type:"sleepUntil",id:t,date:e};return this.stepFlow.push(r),this.serializedStepFlow.push(a),this.steps[t]=xk({id:t,inputSchema:rb.z.object({}),outputSchema:rb.z.object({}),execute:async()=>({})}),this}waitForEvent(e,t,r){return this.stepFlow.push({type:"waitForEvent",event:e,step:t,timeout:r?.timeout}),this.serializedStepFlow.push({type:"waitForEvent",event:e,step:{id:t.id,description:t.description,component:t.component,serializedStepFlow:t.serializedStepFlow},timeout:r?.timeout}),this.steps[t.id]=t,this}map(e,t){if("function"==typeof e){let r=xk({id:t?.id||`mapping_${this.#t?.generateId()||(0,ri.randomUUID)()}`,inputSchema:rb.z.object({}),outputSchema:rb.z.object({}),execute:e});return this.stepFlow.push({type:"step",step:r}),this.serializedStepFlow.push({type:"step",step:{id:r.id,mapConfig:e.toString()}}),this}let r=Object.entries(e).reduce((e,[t,r])=>(void 0!==r.value?e[t]=r:void 0!==r.fn?e[t]={fn:r.fn.toString(),schema:r.schema}:r.runtimeContextPath?e[t]={runtimeContextPath:r.runtimeContextPath,schema:r.schema}:e[t]=r,e),{}),a=xk({id:t?.id||`mapping_${this.#t?.generateId()||(0,ri.randomUUID)()}`,inputSchema:rb.z.any(),outputSchema:rb.z.any(),execute:async t=>{let{getStepResult:r,getInitData:a,runtimeContext:s}=t,n={};for(let[i,o]of Object.entries(e)){if(void 0!==o.value){n[i]=o.value;continue}if(void 0!==o.fn){n[i]=await o.fn(t);continue}if(o.runtimeContextPath){n[i]=s.get(o.runtimeContextPath);continue}let e=o.initData?a():r(Array.isArray(o.step)?o.step.find(e=>r(e)):o.step);if("."===o.path){n[i]=e;continue}let l=o.path.split("."),u=e;for(let e of l)if("object"==typeof u&&null!==u)u=u[e];else throw Error(`Invalid path ${o.path} in step ${o?.step?.id??"initData"}`);n[i]=u}return n}});return this.stepFlow.push({type:"step",step:a}),this.serializedStepFlow.push({type:"step",step:{id:a.id,mapConfig:JSON.stringify(r,null,2)}}),this}parallel(e){return this.stepFlow.push({type:"parallel",steps:e.map(e=>({type:"step",step:e}))}),this.serializedStepFlow.push({type:"parallel",steps:e.map(e=>({type:"step",step:{id:e.id,description:e.description,component:e.component,serializedStepFlow:e.serializedStepFlow}}))}),e.forEach(e=>{this.steps[e.id]=e}),this}branch(e){return this.stepFlow.push({type:"conditional",steps:e.map(([e,t])=>({type:"step",step:t})),conditions:e.map(([e])=>e),serializedConditions:e.map(([e,t])=>({id:`${t.id}-condition`,fn:e.toString()}))}),this.serializedStepFlow.push({type:"conditional",steps:e.map(([e,t])=>({type:"step",step:{id:t.id,description:t.description,component:t.component,serializedStepFlow:t.serializedStepFlow}})),serializedConditions:e.map(([e,t])=>({id:`${t.id}-condition`,fn:e.toString()}))}),e.forEach(([e,t])=>{this.steps[t.id]=t}),this}dowhile(e,t){return this.stepFlow.push({type:"loop",step:e,condition:t,loopType:"dowhile",serializedCondition:{id:`${e.id}-condition`,fn:t.toString()}}),this.serializedStepFlow.push({type:"loop",step:{id:e.id,description:e.description,component:e.component,serializedStepFlow:e.serializedStepFlow},serializedCondition:{id:`${e.id}-condition`,fn:t.toString()},loopType:"dowhile"}),this.steps[e.id]=e,this}dountil(e,t){return this.stepFlow.push({type:"loop",step:e,condition:t,loopType:"dountil",serializedCondition:{id:`${e.id}-condition`,fn:t.toString()}}),this.serializedStepFlow.push({type:"loop",step:{id:e.id,description:e.description,component:e.component,serializedStepFlow:e.serializedStepFlow},serializedCondition:{id:`${e.id}-condition`,fn:t.toString()},loopType:"dountil"}),this.steps[e.id]=e,this}foreach(e,t){return this.stepFlow.push({type:"foreach",step:e,opts:t??{concurrency:1}}),this.serializedStepFlow.push({type:"foreach",step:{id:e.id,description:e.description,component:e.component,serializedStepFlow:e.serializedStepFlow},opts:t??{concurrency:1}}),this.steps[e.id]=e,this}buildExecutionGraph(){return{id:this.id,steps:this.stepFlow}}commit(){return this.executionGraph=this.buildExecutionGraph(),this}get stepGraph(){return this.stepFlow}get serializedStepGraph(){return this.serializedStepFlow}createRun(e){throw Error("createRun() has been deprecated. Please use createRunAsync() instead.\n\nMigration guide:\n  Before: const run = workflow.createRun();\n  After:  const run = await workflow.createRunAsync();\n\nNote: createRunAsync() is an async method, so make sure your calling function is async.")}async createRunAsync(e){if(0===this.stepFlow.length)throw Error("Execution flow of workflow is not defined. Add steps to the workflow via .then(), .branch(), etc.");if(!this.executionGraph.steps)throw Error("Uncommitted step flow changes detected. Call .commit() to register the steps.");let t=e?.runId||this.#t?.generateId()||(0,ri.randomUUID)(),r=this.#i.get(t)??new xA({workflowId:this.id,stateSchema:this.stateSchema,runId:t,resourceId:e?.resourceId,executionEngine:this.executionEngine,executionGraph:this.executionGraph,mastra:this.#t,retryConfig:this.retryConfig,serializedStepGraph:this.serializedStepGraph,disableScorers:e?.disableScorers,cleanup:()=>this.#i.delete(t),tracingPolicy:this.#r?.tracingPolicy,workflowSteps:this.steps,validateInputs:this.#r?.validateInputs});this.#i.set(t,r);let a=this.#r.shouldPersistSnapshot({workflowStatus:r.workflowRunStatus,stepResults:{}});return!await this.getWorkflowRunExecutionResult(t,!1)&&a&&await this.mastra?.getStorage()?.persistWorkflowSnapshot({workflowName:this.id,runId:t,resourceId:e?.resourceId,snapshot:{runId:t,status:"pending",value:{},context:{},activePaths:[],serializedStepGraph:this.serializedStepGraph,suspendedPaths:{},waitingPaths:{},result:void 0,error:void 0,timestamp:Date.now()}}),r}async getScorers({runtimeContext:e=new t7}={}){let t=this.steps;if(!t||0===Object.keys(t).length)return{};let r={};for(let a of Object.values(t))if(a.scorers){let t=a.scorers;for(let[a,s]of("function"==typeof t&&(t=await t({runtimeContext:e})),Object.entries(t)))r[a]=s}return r}async execute({runId:e,inputData:t,resumeData:r,state:a,setState:s,suspend:n,resume:i,[t6]:o,mastra:l,runtimeContext:u,abort:d,abortSignal:p,runCount:c,tracingContext:h,writer:m,validateInputs:g}){this.__registerMastra(l),g&&(this.#r={...this.#r||{},validateInputs:g}),this.executionEngine.options={...this.executionEngine.options||{},validateInputs:g??!1};let f=!!(i?.steps&&i.steps.length>0),y=f?await this.createRunAsync({runId:i.runId}):await this.createRunAsync({runId:e}),v=()=>{d()};y.abortController.signal.addEventListener("abort",v),p.addEventListener("abort",async()=>{y.abortController.signal.removeEventListener("abort",v),await y.cancel()});let b=y.watch(e=>{o.emit("nested-watch-v2",{event:e,workflowId:this.id})},"watch-v2"),w=y.watch(e=>{o.emit("nested-watch",{event:e,workflowId:this.id,runId:y.runId,isResume:!!i?.steps?.length})},"watch");c&&c>0&&i?.steps?.length&&u&&u.set("__mastraWorflowInputData",t);let _=f?await y.resume({resumeData:r,step:i.steps,runtimeContext:u,tracingContext:h,outputOptions:{includeState:!0}}):await y.start({inputData:t,runtimeContext:u,tracingContext:h,writableStream:m,initialState:a,outputOptions:{includeState:!0}});w(),b();let S=Object.entries(_.steps).filter(([e,t])=>t?.status==="suspended");if(_.state&&s(_.state),S?.length)for(let[e,t]of S){let r=[e,...t?.suspendPayload?.__workflow_meta?.path??[]];await n({...t?.suspendPayload,__workflow_meta:{runId:y.runId,path:r}})}if("failed"===_.status)throw _.error;return"success"===_.status?_.result:void 0}async getWorkflowRuns(e){let t=this.#t?.getStorage();return t?t.getWorkflowRuns({workflowName:this.id,...e??{}}):(this.logger.debug("Cannot get workflow runs. Mastra storage is not initialized"),{runs:[],total:0})}async getWorkflowRunById(e){let t=this.#t?.getStorage();return t?await t.getWorkflowRunById({runId:e,workflowName:this.id})??(this.#i.get(e)?{...this.#i.get(e),workflowName:this.id}:null):(this.logger.debug("Cannot get workflow runs from storage. Mastra storage is not initialized"),this.#i.get(e)?{...this.#i.get(e),workflowName:this.id}:null)}async getWorkflowRunSteps({runId:e,workflowId:t}){let r=this.#t?.getStorage();if(!r)return this.logger.debug("Cannot get workflow run steps. Mastra storage is not initialized"),{};let a=await r.getWorkflowRunById({runId:e,workflowName:t}),s=a?.snapshot;if(!s)return{};if("string"==typeof s)try{s=JSON.parse(s)}catch(e){return this.logger.debug("Cannot get workflow run execution result. Snapshot is not a valid JSON string",e),{}}let{serializedStepGraph:n,context:i}=s,{input:o,...l}=i,u={};for(let t of Object.keys(l)){let r=n.find(e=>e?.step?.id===t);if(u[t]=l[t],r&&r?.step?.component==="WORKFLOW"){let r=await this.getWorkflowRunSteps({runId:e,workflowId:t});if(r){let e=Object.entries(r).reduce((e,[r,a])=>(e[`${t}.${r}`]=a,e),{});u={...u,...e}}}}return u}async getWorkflowRunExecutionResult(e,t=!0){let r=this.#t?.getStorage();if(!r)return this.logger.debug("Cannot get workflow run execution result. Mastra storage is not initialized"),null;let a=await r.getWorkflowRunById({runId:e,workflowName:this.id}),s=a?.snapshot;if(!s)return null;if("string"==typeof s)try{s=JSON.parse(s)}catch(e){return this.logger.debug("Cannot get workflow run execution result. Snapshot is not a valid JSON string",e),null}let n=t?await this.getWorkflowRunSteps({runId:e,workflowId:this.id}):s.context;return{status:s.status,result:s.result,error:s.error,payload:s.context?.input,steps:n}}},xA=class{#o;emitter;workflowId;runId;resourceId;disableScorers;tracingPolicy;validateInputs;state={};executionEngine;executionGraph;serializedStepGraph;workflowSteps;workflowRunStatus;#t;#l=[];get mastra(){return this.#t}closeStreamAction;activeStream;executionResults;stateSchema;cleanup;retryConfig;constructor(e){this.workflowId=e.workflowId,this.runId=e.runId,this.resourceId=e.resourceId,this.serializedStepGraph=e.serializedStepGraph,this.executionEngine=e.executionEngine,this.executionGraph=e.executionGraph,this.#t=e.mastra,this.emitter=new wU.default,this.retryConfig=e.retryConfig,this.cleanup=e.cleanup,this.disableScorers=e.disableScorers,this.tracingPolicy=e.tracingPolicy,this.workflowSteps=e.workflowSteps,this.validateInputs=e.validateInputs,this.stateSchema=e.stateSchema,this.workflowRunStatus="pending"}get abortController(){return this.#o||(this.#o=new AbortController),this.#o}async cancel(){this.abortController?.abort()}async sendEvent(e,t){this.emitter.emit(`user-event-${e}`,t)}async _validateInput(e){let t=this.executionGraph.steps[0],r=e;if(t&&this.validateInputs){let a;if("step"===t.type||"foreach"===t.type||"loop"===t.type)a=t.step.inputSchema;else if("conditional"===t.type||"parallel"===t.type){let e=t.steps[0];e&&"step"===e.type&&(a=e.step.inputSchema)}if(a){let t=await a.safeParseAsync(e);if(!t.success)throw Error("Invalid input data: \n"+t.error.errors.map(e=>`- ${e.path?.join(".")}: ${e.message}`).join("\n"));r=t.data}}return r}async _validateInitialState(e){let t=e;if(this.validateInputs){let r=this.stateSchema;if(r){let a=await r.safeParseAsync(e);if(!a.success)throw Error("Invalid input data: \n"+a.error.errors.map(e=>`- ${e.path?.join(".")}: ${e.message}`).join("\n"));t=a.data}}return t}async _validateResumeData(e,t){let r=e;if(t&&t.resumeSchema&&this.validateInputs){let a=t.resumeSchema,s=await a.safeParseAsync(e);if(!s.success)throw Error("Invalid resume data: \n"+s.error.errors.map(e=>`- ${e.path?.join(".")}: ${e.message}`).join("\n"));r=s.data}return r}async _start({inputData:e,initialState:t,runtimeContext:r,writableStream:a,tracingContext:s,tracingOptions:n,format:i,outputOptions:o}){let l=lY({type:"workflow_run",name:`workflow run: '${this.workflowId}'`,input:e,attributes:{workflowId:this.workflowId},tracingPolicy:this.tracingPolicy,tracingOptions:n,tracingContext:s,runtimeContext:r}),u=lH(l),d=await this._validateInput(e),p=await this._validateInitialState(t??{}),c=await this.executionEngine.execute({workflowId:this.workflowId,runId:this.runId,resourceId:this.resourceId,disableScorers:this.disableScorers,graph:this.executionGraph,serializedStepGraph:this.serializedStepGraph,input:d,initialState:p,emitter:{emit:async(e,t)=>{this.emitter.emit(e,t)},on:(e,t)=>{this.emitter.on(e,t)},off:(e,t)=>{this.emitter.off(e,t)},once:(e,t)=>{this.emitter.once(e,t)}},retryConfig:this.retryConfig,runtimeContext:r??new t7,abortController:this.abortController,writableStream:a,workflowAISpan:l,format:i,outputOptions:o});return"suspended"!==c.status&&this.cleanup?.(),c.traceId=u,c}async start({inputData:e,initialState:t,runtimeContext:r,writableStream:a,tracingContext:s,tracingOptions:n,outputOptions:i}){return this._start({inputData:e,initialState:t,runtimeContext:r,writableStream:a,tracingContext:s,tracingOptions:n,format:"aisdk",outputOptions:i})}stream({inputData:e,runtimeContext:t,onChunk:r,tracingContext:a,tracingOptions:s}={}){if(this.closeStreamAction)return{stream:this.observeStream().stream,getWorkflowState:()=>this.executionResults};let{readable:n,writable:i}=new wz.TransformStream,o=i.getWriter(),l=this.watch(async e=>{try{let t={...e,type:e.type.replace("workflow-","")};await o.write(t),r&&await r(t)}catch{}},"watch-v2");return this.closeStreamAction=async()=>{this.emitter.emit("watch-v2",{type:"workflow-finish",payload:{runId:this.runId}}),l(),await Promise.all(this.#l.map(e=>e())),this.#l=[];try{await o.close()}catch(e){console.error("Error closing stream:",e)}finally{o.releaseLock()}},this.emitter.emit("watch-v2",{type:"workflow-start",payload:{runId:this.runId}}),this.executionResults=this._start({inputData:e,runtimeContext:t,format:"aisdk",tracingContext:a,tracingOptions:s}).then(e=>("suspended"!==e.status&&this.closeStreamAction?.().catch(()=>{}),e)),{stream:n,getWorkflowState:()=>this.executionResults}}observeStream(){let{readable:e,writable:t}=new wz.TransformStream,r=t.getWriter(),a=this.watch(async e=>{try{let t={...e,type:e.type.replace("workflow-","")};await r.write(t)}catch{}},"watch-v2");return this.#l.push(async()=>{a();try{await r.close()}catch(e){console.error("Error closing stream:",e)}finally{r.releaseLock()}}),{stream:e}}observeStreamVNext(){let{readable:e,writable:t}=new wz.TransformStream({transform(e,t){t.enqueue(e)}}),r=[],a=!1,s=async()=>{let e=r;if(r=[],0===e.length||a)return;a=!0;let n=t.getWriter();try{for(let t of e)await n.write(t)}finally{n.releaseLock()}a=!1,setImmediate(s)},n=this.watch(async({type:e,from:t="WORKFLOW",payload:a})=>{r.push({type:e,runId:this.runId,from:t,payload:{stepName:a.id,...a}}),await s()},"watch-v2");return this.#l.push(async()=>{n();try{await t.close()}catch(e){console.error("Error closing stream:",e)}}),e}async streamAsync({inputData:e,runtimeContext:t}={}){return this.stream({inputData:e,runtimeContext:t})}streamVNext({inputData:e,runtimeContext:t,tracingContext:r,tracingOptions:a,format:s,closeOnSuspend:n=!0,onChunk:i}={}){return this.closeStreamAction&&this.activeStream||(this.closeStreamAction=async()=>{},this.activeStream=new xb({run:this,createStream:()=>{let{readable:o,writable:l}=new wz.TransformStream({transform(e,t){t.enqueue(e)}}),u=[],d=!1,p=async()=>{let e=u;if(u=[],0===e.length||d)return;d=!0;let t=l.getWriter();try{for(let r of e)await t.write(r),i&&await i(r)}finally{t.releaseLock()}d=!1,setImmediate(p)},c=this.watch(async({type:e,from:t="WORKFLOW",payload:r})=>{u.push({type:e,runId:this.runId,from:t,payload:{stepName:r.id,...r}}),await p()},"watch-v2");this.closeStreamAction=async()=>{c(),await Promise.all(this.#l.map(e=>e())),this.#l=[];try{await l.close()}catch(e){console.error("Error closing stream:",e)}};let h=this._start({inputData:e,runtimeContext:t,tracingContext:r,tracingOptions:a,writableStream:l,format:s}).then(e=>(n?this.closeStreamAction?.().catch(()=>{}):"suspended"!==e.status&&this.closeStreamAction?.().catch(()=>{}),e));return this.executionResults=h,o}})),this.activeStream}resumeStreamVNext({step:e,resumeData:t,runtimeContext:r,tracingContext:a,tracingOptions:s,format:n,onChunk:i}={}){return this.closeStreamAction=async()=>{},this.activeStream=new xb({run:this,createStream:()=>{let{readable:o,writable:l}=new wz.TransformStream({transform(e,t){t.enqueue(e)}}),u=[],d=!1,p=async()=>{let e=u;if(u=[],0===e.length||d)return;d=!0;let t=l.getWriter();try{for(let r of e)await t.write(r),i&&await i(r)}finally{t.releaseLock()}d=!1,setImmediate(p)},c=this.watch(async({type:e,from:t="WORKFLOW",payload:r})=>{u.push({type:e,runId:this.runId,from:t,payload:{stepName:r.id,...r}}),await p()},"watch-v2");this.closeStreamAction=async()=>{c(),await Promise.all(this.#l.map(e=>e())),this.#l=[];try{await l.close()}catch(e){console.error("Error closing stream:",e)}};let h=this._resume({resumeData:t,step:e,runtimeContext:r,tracingContext:a,tracingOptions:s,writableStream:l,format:n,isVNext:!0}).then(e=>(this.closeStreamAction?.().catch(()=>{}),e));return this.executionResults=h,o}}),this.activeStream}watch(e,t="watch"){let r=t=>{this.updateState(t.payload),e({type:t.type,payload:this.getState(),eventTimestamp:t.eventTimestamp})},a=({event:t,workflowId:r})=>{try{let{type:a,payload:s,eventTimestamp:n}=t,i=Object.fromEntries(Object.entries(s?.workflowState?.steps??{}).map(([e,t])=>[`${r}.${e}`,t])),o={currentStep:{...s?.currentStep,id:`${r}.${s?.currentStep?.id}`},workflowState:{steps:i}};this.updateState(o),e({type:a,payload:this.getState(),eventTimestamp:n})}catch(e){console.error(e)}},s=({event:e,workflowId:t})=>{this.emitter.emit("watch-v2",{...e,...e.payload?.id?{payload:{...e.payload,id:`${t}.${e.payload.id}`}}:{}})};return"watch"===t?(this.emitter.on("watch",r),this.emitter.on("nested-watch",a)):"watch-v2"===t&&(this.emitter.on("watch-v2",e),this.emitter.on("nested-watch-v2",s)),()=>{"watch-v2"===t?(this.emitter.off("watch-v2",e),this.emitter.off("nested-watch-v2",s)):(this.emitter.off("watch",r),this.emitter.off("nested-watch",a))}}async watchAsync(e,t="watch"){return this.watch(e,t)}async resume(e){return this._resume(e)}async _resume(e){let t,r,a=await this.#t?.getStorage()?.loadWorkflowSnapshot({workflowName:this.workflowId,runId:this.runId});if(!a)throw Error("No snapshot found for this workflow run: "+this.workflowId+" "+this.runId);if(e.step)t=(Array.isArray(e.step)?e.step:[e.step]).map(e=>"string"==typeof e?e:e?.id);else{let e=[];if(Object.entries(a?.suspendedPaths??{}).forEach(([t,r])=>{let s=a?.context?.[t];if(s&&"object"==typeof s&&"status"in s&&"suspended"===s.status){let r=s.suspendPayload?.__workflow_meta?.path;r&&Array.isArray(r)?e.push([t,...r]):e.push([t])}}),0===e.length)throw Error("No suspended steps found in this workflow run");if(1===e.length)t=e[0];else{let t=e.map(e=>`[${e.join(", ")}]`);throw Error(`Multiple suspended steps found: ${t.join(", ")}. Please specify which step to resume using the "step" parameter.`)}}if(!e.runCount){if("suspended"!==a.status)throw Error("This workflow run was not suspended");let e=Object.keys(a?.suspendedPaths??{});if(!e.includes(t?.[0]??""))throw Error(`This workflow step "${t?.[0]}" was not suspended. Available suspended steps: [${e.join(", ")}]`)}let s=this.workflowSteps[t?.[0]??""],n=await this._validateResumeData(e.resumeData,s);e.runCount&&e.runCount>0&&e.runtimeContext&&(r=e.runtimeContext.get("__mastraWorflowInputData"),e.runtimeContext.delete("__mastraWorflowInputData"));let i={...a?.context??{},input:r??a?.context?.input},o=e.runtimeContext??new t7;Object.entries(a?.runtimeContext??{}).forEach(([e,t])=>{o.has(e)||o.set(e,t)});let l=lY({type:"workflow_run",name:`workflow run: '${this.workflowId}'`,input:n,attributes:{workflowId:this.workflowId},tracingPolicy:this.tracingPolicy,tracingOptions:e.tracingOptions,tracingContext:e.tracingContext,runtimeContext:o}),u=lH(l),d=this.executionEngine.execute({workflowId:this.workflowId,runId:this.runId,resourceId:this.resourceId,graph:this.executionGraph,serializedStepGraph:this.serializedStepGraph,input:a?.context?.input,initialState:a?.value??{},resume:{steps:t,stepResults:i,resumePayload:n,resumePath:a?.suspendedPaths?.[t?.[0]]},format:e.format,emitter:{emit:(e,t)=>(this.emitter.emit(e,t),Promise.resolve()),on:(e,t)=>{this.emitter.on(e,t)},off:(e,t)=>{this.emitter.off(e,t)},once:(e,t)=>{this.emitter.once(e,t)}},runtimeContext:o,abortController:this.abortController,workflowAISpan:l,outputOptions:e.outputOptions}).then(t=>(e.isVNext||"suspended"===t.status||this.closeStreamAction?.().catch(()=>{}),t.traceId=u,t));return this.executionResults=d,d}getState(){return this.state}updateState(e){e.currentStep?this.state.currentStep=e.currentStep:e.workflowState?.status!=="running"&&delete this.state.currentStep,e.workflowState&&(this.state.workflowState=function e(t,r){if(!t||"object"!=typeof t)return r;if(!r||"object"!=typeof r)return t;let a={...t};for(let t in r)if(void 0!==r[t])if(null!==r[t]&&"object"==typeof r[t]){let s=a[t],n=r[t];Array.isArray(n)?a[t]=n.filter(e=>void 0!==e):"object"==typeof s&&null!==s?a[t]=e(s,n):a[t]=n}else a[t]=r[t];return a}(this.state.workflowState??{},e.workflowState??{}))}_getExecutionResults(){return this.executionResults}},xO=n_.object({inputTokens:n_.number(),outputTokens:n_.number(),totalTokens:n_.number(),reasoningTokens:n_.number().optional(),cachedInputTokens:n_.number().optional()}),xC=n_.object({reason:n_.string(),warnings:n_.array(n_.any()),isContinued:n_.boolean(),logprobs:n_.any().optional(),totalUsage:xO.optional(),headers:n_.record(n_.string()).optional(),messageId:n_.string().optional(),request:n_.record(n_.any()).optional()}),xR=n_.object({messageId:n_.string(),messages:n_.object({all:n_.array(n_.any()),user:n_.array(n_.any()),nonUser:n_.array(n_.any())}),output:n_.object({text:n_.string().optional(),reasoning:n_.array(n_.any()).optional(),reasoningText:n_.string().optional(),files:n_.array(n_.any()).optional(),toolCalls:n_.array(n_.any()).optional(),toolResults:n_.array(n_.any()).optional(),sources:n_.array(n_.any()).optional(),staticToolCalls:n_.array(n_.any()).optional(),dynamicToolCalls:n_.array(n_.any()).optional(),staticToolResults:n_.array(n_.any()).optional(),dynamicToolResults:n_.array(n_.any()).optional(),usage:xO,steps:n_.array(n_.any())}),metadata:n_.object({id:n_.string().optional(),model:n_.string().optional(),modelId:n_.string().optional(),modelMetadata:n_.object({modelId:n_.string(),modelVersion:n_.string(),modelProvider:n_.string()}).optional(),timestamp:n_.date().optional(),providerMetadata:n_.record(n_.any()).optional(),headers:n_.record(n_.string()).optional(),request:n_.record(n_.any()).optional()}),stepResult:xC}),xM=n_.object({toolCallId:n_.string(),toolName:n_.string(),args:n_.record(n_.any()),providerMetadata:n_.record(n_.any()).optional(),providerExecuted:n_.boolean().optional(),output:n_.any().optional()}),xN=xM.extend({result:n_.any(),error:n_.any().optional()});function xj(e){let t;if(!(t=function(e){if(e)return!e||"object"!=typeof e||e.safeParse||e.jsonSchema?h7(e).jsonSchema:e}(e)))return;let{$schema:r,...a}=t;return"array"===a.type?{jsonSchema:{$schema:r,type:"object",properties:{elements:{type:"array",items:a.items}},required:["elements"],additionalProperties:!1},outputFormat:"array"}:a.enum&&Array.isArray(a.enum)?{jsonSchema:{$schema:r,type:"object",properties:{result:{type:a.type||"string",enum:a.enum}},required:["result"],additionalProperties:!1},outputFormat:"enum"}:{jsonSchema:t,outputFormat:t.type}}var xP=class extends tD{initialize({runId:e,createStream:t,onResult:r}){let a=this;return new ReadableStream({async start(s){try{let n=await t();r({warnings:n.warnings,request:n.request,rawResponse:n.rawResponse||n.response||{}}),await a.transform({runId:e,stream:n.stream,controller:s}),s.close()}catch(e){s.error(e)}}})}};function x$({chunk:e,mode:t="stream"}){switch(e.type){case"start":return{type:"start"};case"step-start":let{messageId:r,...a}=e.payload;return{type:"start-step",request:a.request,warnings:a.warnings||[]};case"raw":return{type:"raw",rawValue:e.payload};case"finish":return{type:"finish",finishReason:e.payload.stepResult.reason,totalUsage:e.payload.output.usage};case"reasoning-start":return{type:"reasoning-start",id:e.payload.id,providerMetadata:e.payload.providerMetadata};case"reasoning-delta":return{type:"reasoning-delta",id:e.payload.id,text:e.payload.text,providerMetadata:e.payload.providerMetadata};case"reasoning-signature":throw Error('AISDKv5 chunk type "reasoning-signature" not supported');case"redacted-reasoning":throw Error('AISDKv5 chunk type "redacted-reasoning" not supported');case"reasoning-end":return{type:"reasoning-end",id:e.payload.id,providerMetadata:e.payload.providerMetadata};case"source":if("url"===e.payload.sourceType)return{type:"source",sourceType:"url",id:e.payload.id,url:e.payload.url,title:e.payload.title,providerMetadata:e.payload.providerMetadata};return{type:"source",sourceType:"document",id:e.payload.id,mediaType:e.payload.mimeType,title:e.payload.title,filename:e.payload.filename,providerMetadata:e.payload.providerMetadata};case"file":if("generate"===t)return{type:"file",file:new w_({data:e.payload.data,mediaType:e.payload.mimeType})};return{type:"file",file:new wS({data:e.payload.data,mediaType:e.payload.mimeType})};case"tool-call":return{type:"tool-call",toolCallId:e.payload.toolCallId,providerMetadata:e.payload.providerMetadata,providerExecuted:e.payload.providerExecuted,toolName:e.payload.toolName,input:e.payload.args};case"tool-call-input-streaming-start":return{type:"tool-input-start",id:e.payload.toolCallId,toolName:e.payload.toolName,dynamic:!!e.payload.dynamic,providerMetadata:e.payload.providerMetadata,providerExecuted:e.payload.providerExecuted};case"tool-call-input-streaming-end":return{type:"tool-input-end",id:e.payload.toolCallId,providerMetadata:e.payload.providerMetadata};case"tool-call-delta":return{type:"tool-input-delta",id:e.payload.toolCallId,delta:e.payload.argsTextDelta,providerMetadata:e.payload.providerMetadata};case"step-finish":{let{request:t,providerMetadata:r,...a}=e.payload.metadata;return{type:"finish-step",response:{id:e.payload.id||"",timestamp:new Date,modelId:a.modelId||"",...a},usage:e.payload.output.usage,finishReason:e.payload.stepResult.reason,providerMetadata:r}}case"text-delta":return{type:"text-delta",id:e.payload.id,text:e.payload.text,providerMetadata:e.payload.providerMetadata};case"text-end":return{type:"text-end",id:e.payload.id,providerMetadata:e.payload.providerMetadata};case"text-start":return{type:"text-start",id:e.payload.id,providerMetadata:e.payload.providerMetadata};case"tool-result":return{type:"tool-result",input:e.payload.args,toolCallId:e.payload.toolCallId,providerExecuted:e.payload.providerExecuted,toolName:e.payload.toolName,output:e.payload.result};case"tool-error":return{type:"tool-error",error:e.payload.error,input:e.payload.args,toolCallId:e.payload.toolCallId,providerExecuted:e.payload.providerExecuted,toolName:e.payload.toolName};case"abort":return{type:"abort"};case"error":return{type:"error",error:e.payload.error};case"object":return{type:"object",object:e.object};default:if(e.type&&"payload"in e&&e.payload)return{type:e.type,...e.payload||{}};return}}var xD=class extends xP{constructor({component:e,name:t}){super({component:e,name:t})}async transform({runId:e,stream:t,controller:r}){for await(let a of t){let t=function(e,t){switch(e.type){case"response-metadata":return{type:"response-metadata",runId:t.runId,from:"AGENT",payload:{...e}};case"text-start":return{type:"text-start",runId:t.runId,from:"AGENT",payload:{id:e.id,providerMetadata:e.providerMetadata}};case"text-delta":if(e.delta)return{type:"text-delta",runId:t.runId,from:"AGENT",payload:{id:e.id,providerMetadata:e.providerMetadata,text:e.delta}};break;case"text-end":return{type:"text-end",runId:t.runId,from:"AGENT",payload:e};case"reasoning-start":return{type:"reasoning-start",runId:t.runId,from:"AGENT",payload:{id:e.id,providerMetadata:e.providerMetadata}};case"reasoning-delta":return{type:"reasoning-delta",runId:t.runId,from:"AGENT",payload:{id:e.id,providerMetadata:e.providerMetadata,text:e.delta}};case"reasoning-end":return{type:"reasoning-end",runId:t.runId,from:"AGENT",payload:{id:e.id,providerMetadata:e.providerMetadata}};case"source":return{type:"source",runId:t.runId,from:"AGENT",payload:{id:e.id,sourceType:e.sourceType,title:e.title||"",mimeType:"document"===e.sourceType?e.mediaType:void 0,filename:"document"===e.sourceType?e.filename:void 0,url:"url"===e.sourceType?e.url:void 0,providerMetadata:e.providerMetadata}};case"file":return{type:"file",runId:t.runId,from:"AGENT",payload:{data:e.data,base64:"string"==typeof e.data?e.data:void 0,mimeType:e.mediaType}};case"tool-call":return{type:"tool-call",runId:t.runId,from:"AGENT",payload:{toolCallId:e.toolCallId,toolName:e.toolName,args:e.input?JSON.parse(e.input):void 0,providerExecuted:e.providerExecuted,providerMetadata:e.providerMetadata}};case"tool-result":return{type:"tool-result",runId:t.runId,from:"AGENT",payload:{toolCallId:e.toolCallId,toolName:e.toolName,result:e.result,isError:e.isError,providerExecuted:e.providerExecuted,providerMetadata:e.providerMetadata}};case"tool-input-start":return{type:"tool-call-input-streaming-start",runId:t.runId,from:"AGENT",payload:{toolCallId:e.id,toolName:e.toolName,providerExecuted:e.providerExecuted,providerMetadata:e.providerMetadata}};case"tool-input-delta":if(e.delta)return{type:"tool-call-delta",runId:t.runId,from:"AGENT",payload:{argsTextDelta:e.delta,toolCallId:e.id,providerMetadata:e.providerMetadata}};break;case"tool-input-end":return{type:"tool-call-input-streaming-end",runId:t.runId,from:"AGENT",payload:{toolCallId:e.id,providerMetadata:e.providerMetadata}};case"finish":let{finishReason:r,usage:a,providerMetadata:s,messages:n,...i}=e;return{type:"finish",runId:t.runId,from:"AGENT",payload:{stepResult:{reason:e.finishReason},output:{usage:{...e.usage??{},totalTokens:e?.usage?.totalTokens??(e.usage?.inputTokens??0)+(e.usage?.outputTokens??0)}},metadata:{providerMetadata:e.providerMetadata},messages:n,...i}};case"error":return{type:"error",runId:t.runId,from:"AGENT",payload:e};case"raw":return{type:"raw",runId:t.runId,from:"AGENT",payload:e.rawValue}}}(a,{runId:e});t&&r.enqueue(t)}}},xL=[],xU=class{content;finishReason;usage;warnings;request;response;providerMetadata;constructor({content:e,finishReason:t,usage:r,warnings:a,request:s,response:n,providerMetadata:i}){this.content=e,this.finishReason=t,this.usage=r,this.warnings=a,this.request=s,this.response=n,this.providerMetadata=i}get text(){return this.content.filter(e=>"text"===e.type).map(e=>e.text).join("")}get reasoning(){return this.content.filter(e=>"reasoning"===e.type)}get reasoningText(){return 0===this.reasoning.length?void 0:this.reasoning.map(e=>e.text).join("")}get files(){return this.content.filter(e=>"file"===e.type).map(e=>e.file)}get sources(){return this.content.filter(e=>"source"===e.type)}get toolCalls(){return this.content.filter(e=>"tool-call"===e.type)}get staticToolCalls(){return this.toolCalls.filter(e=>!1===e.dynamic)}get dynamicToolCalls(){return this.toolCalls.filter(e=>!0===e.dynamic)}get toolResults(){return this.content.filter(e=>"tool-result"===e.type)}get staticToolResults(){return this.toolResults.filter(e=>!1===e.dynamic)}get dynamicToolResults(){return this.toolResults.filter(e=>!0===e.dynamic)}},xz=class{#u;constructor({_internal:e,model:t}){this.#u={responseMetadata:{id:e?.generateId?.(),timestamp:e?.currentDate?.(),modelId:t.modelId,modelVersion:t.specificationVersion,modelProvider:t.provider,headers:void 0},modelMetadata:{modelId:t.modelId,modelVersion:t.specificationVersion,modelProvider:t.provider},isReasoning:!1,isStreaming:!1,providerOptions:void 0,hasToolCallStreaming:!1,hasErrored:!1,reasoningDeltas:[],textDeltas:[],stepResult:void 0}}setState(e){this.#u={...this.#u,...e}}get state(){return this.#u}};async function xq({tools:e,messageId:t,messageList:r,outputStream:a,runState:s,options:n,controller:i,responseFromModel:o,includeRawChunks:l}){for await(let u of a._getBaseStream())if(u){if("object"==u.type||"object-result"==u.type){i.enqueue(u);continue}if("reasoning-delta"!==u.type&&"reasoning-signature"!==u.type&&"redacted-reasoning"!==u.type&&s.state.isReasoning&&(s.state.reasoningDeltas.length&&r.add({id:t,role:"assistant",content:[{type:"reasoning",text:s.state.reasoningDeltas.join(""),signature:u.payload.signature,providerOptions:u.payload.providerMetadata??s.state.providerOptions}]},"response"),s.setState({isReasoning:!1,reasoningDeltas:[]})),"text-delta"!==u.type&&"tool-call"!==u.type&&"response-metadata"!==u.type&&s.state.isStreaming){if(s.state.textDeltas.length){let e=u.payload.providerMetadata??s.state.providerOptions;r.add({id:t,role:"assistant",content:[e?{type:"text",text:s.state.textDeltas.join(""),providerOptions:e}:{type:"text",text:s.state.textDeltas.join("")}]},"response")}s.setState({isStreaming:!1,textDeltas:[]})}switch(u.type){case"response-metadata":s.setState({responseMetadata:{id:u.payload.id,timestamp:u.payload.timestamp,modelId:u.payload.modelId,headers:u.payload.headers}});break;case"text-delta":{let e=s.state.textDeltas;e.push(u.payload.text),s.setState({textDeltas:e,isStreaming:!0}),xV(i)&&i.enqueue(u);break}case"tool-call-input-streaming-start":{let t=e?.[u.payload.toolName]||Object.values(e||{})?.find(e=>"id"in e&&e.id===u.payload.toolName);if(t&&"onInputStart"in t)try{await t?.onInputStart?.({toolCallId:u.payload.toolCallId,messages:r.get.input.aiV5.model(),abortSignal:n?.abortSignal})}catch(e){console.error("Error calling onInputStart",e)}xV(i)&&i.enqueue(u);break}case"tool-call-delta":{let t=e?.[u.payload.toolName||""]||Object.values(e||{})?.find(e=>"id"in e&&e.id===u.payload.toolName);if(t&&"onInputDelta"in t)try{await t?.onInputDelta?.({inputTextDelta:u.payload.argsTextDelta,toolCallId:u.payload.toolCallId,messages:r.get.input.aiV5.model(),abortSignal:n?.abortSignal})}catch(e){console.error("Error calling onInputDelta",e)}xV(i)&&i.enqueue(u);break}case"reasoning-start":if(s.setState({providerOptions:u.payload.providerMetadata??s.state.providerOptions}),Object.values(u.payload.providerMetadata||{}).find(e=>e?.redactedData)){r.add({id:t,role:"assistant",content:[{type:"reasoning",text:"",providerOptions:u.payload.providerMetadata??s.state.providerOptions}]},"response"),xV(i)&&i.enqueue(u);break}xV(i)&&i.enqueue(u);break;case"reasoning-delta":{let e=s.state.reasoningDeltas;e.push(u.payload.text),s.setState({isReasoning:!0,reasoningDeltas:e,providerOptions:u.payload.providerMetadata??s.state.providerOptions}),xV(i)&&i.enqueue(u);break}case"file":r.add({id:t,role:"assistant",content:[{type:"file",data:u.payload.data,mimeType:u.payload.mimeType}]},"response"),i.enqueue(u);break;case"source":r.add({id:t,role:"assistant",content:{format:2,parts:[{type:"source",source:{sourceType:"url",id:u.payload.id,url:u.payload.url||"",title:u.payload.title,providerMetadata:u.payload.providerMetadata}}]},createdAt:new Date},"response"),i.enqueue(u);break;case"finish":s.setState({providerOptions:u.payload.metadata.providerMetadata,stepResult:{reason:u.payload.reason,logprobs:u.payload.logprobs,warnings:o.warnings,totalUsage:u.payload.totalUsage,headers:o.rawResponse?.headers,messageId:t,isContinued:!["stop","error"].includes(u.payload.stepResult.reason),request:o.request}});break;case"error":if(wv(u.payload.error)&&n?.abortSignal?.aborted)break;s.setState({hasErrored:!0}),s.setState({stepResult:{isContinued:!1,reason:"error"}});let a=u.payload.error;"object"==typeof a&&Object.assign(a=Error(tm(a)),u.payload.error),i.enqueue({...u,payload:{...u.payload,error:a}}),await n?.onError?.({error:a});break;default:xV(i)&&i.enqueue(u)}if(["text-delta","reasoning-delta","source","tool-call","tool-call-input-streaming-start","tool-call-delta","raw"].includes(u.type)){let e=x$({chunk:u});if("raw"===u.type&&!l)return;await n?.onChunk?.({chunk:e})}if(s.state.hasErrored)break}}function xV(e){return 0!==e.desiredSize&&null!==e.desiredSize}var xF=class extends tD{#d;#t;#r;#p;constructor({mastra:e,models:t,options:r}){if(super({name:"aisdk"}),this.#r=r,e&&(this.#t=e,e.getLogger()&&this.__setLogger(this.#t.getLogger())),0!==t.length&&t[0])this.#d=t,this.#p=t[0];else{const e=new tv({id:"LLM_LOOP_MODELS_EMPTY",domain:"LLM",category:"USER"});throw this.logger.trackException(e),this.logger.error(e.toString()),e}}__registerPrimitives(e){e.telemetry&&this.__setTelemetry(e.telemetry),e.logger&&this.__setLogger(e.logger)}__registerMastra(e){this.#t=e}getProvider(){return this.#p.model.provider}getModelId(){return this.#p.model.modelId}getModel(){return this.#p.model}_applySchemaCompat(e){let t=this.#p.model,r=[];if(t){let e={modelId:t.modelId,supportsStructuredOutputs:!0,provider:t.provider};r.push(new lI(e),new lx(e),new l_(e),new lb(e),new lw(e),new lS(e))}return o7({schema:e,compatLayers:r,mode:"aiSdkSchema"})}convertToMessages(e){return Array.isArray(e)?e.map(e=>"string"==typeof e?{role:"user",content:e}:e):[{role:"user",content:e}]}stream({resumeContext:e,runId:t,stopWhen:r=bq(5),maxSteps:a,tools:s={},modelSettings:n,toolChoice:i="auto",telemetry_settings:o,threadId:l,resourceId:u,output:d,structuredOutput:p,options:c,outputProcessors:h,returnScorerData:m,providerOptions:g,tracingContext:f,messageList:y,requireToolApproval:v,_internal:b,agentId:w}){let _;_=a&&"number"==typeof a?bq(a):r;let S=d;p&&!p.model&&(S=p.schema);let I=y.get.all.aiV5.model(),k=this.#p.model;this.logger.debug("[LLM] - Streaming text",{runId:t,threadId:l,resourceId:u,messages:I,tools:Object.keys(s||{})});let T=f?.currentSpan?.createChildSpan({name:`llm: '${k.modelId}'`,type:"llm_generation",input:{messages:[...y.getSystemMessages(),...I]},attributes:{model:k.modelId,provider:k.provider,streaming:!0,parameters:n},metadata:{runId:t,threadId:l,resourceId:u},tracingPolicy:this.#r?.tracingPolicy});try{let r={mastra:this.#t,resumeContext:e,runId:t,messageList:y,models:this.#d,tools:s,stopWhen:_,toolChoice:i,modelSettings:n,providerOptions:g,telemetry_settings:{...this.experimental_telemetry,...o},_internal:b,output:S,outputProcessors:h,returnScorerData:m,llmAISpan:T,requireToolApproval:v,agentId:w,options:{...c,onStepFinish:async e=>{try{await c?.onStepFinish?.({...e,runId:t})}catch(a){let r=new tv({id:"LLM_STREAM_ON_STEP_FINISH_CALLBACK_EXECUTION_FAILED",domain:"LLM",category:"USER",details:{modelId:e.model?.modelId,modelProvider:e.model?.provider,runId:t??"unknown",threadId:l??"unknown",resourceId:u??"unknown",finishReason:e?.finishReason,toolCalls:e?.toolCalls?JSON.stringify(e.toolCalls):"",toolResults:e?.toolResults?JSON.stringify(e.toolResults):"",usage:e?.usage?JSON.stringify(e.usage):""}},a);throw T?.error({error:r}),this.logger.trackException(r),r}this.logger.debug("[LLM] - Stream Step Change:",{text:e?.text,toolCalls:e?.toolCalls,toolResults:e?.toolResults,finishReason:e?.finishReason,usage:e?.usage,runId:t}),e?.response?.headers?.["x-ratelimit-remaining-tokens"]&&2e3>parseInt(e?.response?.headers?.["x-ratelimit-remaining-tokens"],10)&&(this.logger.warn("Rate limit approaching, waiting 10 seconds",{runId:t}),await lD(1e4))},onFinish:async e=>{try{await c?.onFinish?.({...e,runId:t})}catch(a){let r=new tv({id:"LLM_STREAM_ON_FINISH_CALLBACK_EXECUTION_FAILED",domain:"LLM",category:"USER",details:{modelId:e.model?.modelId,modelProvider:e.model?.provider,runId:t??"unknown",threadId:l??"unknown",resourceId:u??"unknown",finishReason:e?.finishReason,toolCalls:e?.toolCalls?JSON.stringify(e.toolCalls):"",toolResults:e?.toolResults?JSON.stringify(e.toolResults):"",usage:e?.usage?JSON.stringify(e.usage):""}},a);throw T?.error({error:r}),this.logger.trackException(r),r}T?.end({output:{files:e?.files,object:e?.object,reasoning:e?.reasoning,reasoningText:e?.reasoningText,sources:e?.sources,text:e?.text,warnings:e?.warnings},attributes:{finishReason:e?.finishReason,usage:{inputTokens:e?.totalUsage?.inputTokens,outputTokens:e?.totalUsage?.outputTokens,totalTokens:e?.totalUsage?.totalTokens,reasoningTokens:e?.totalUsage?.reasoningTokens,cachedInputTokens:e?.totalUsage?.cachedInputTokens}}}),this.logger.debug("[LLM] - Stream Finished:",{text:e?.text,toolCalls:e?.toolCalls,toolResults:e?.toolResults,finishReason:e?.finishReason,usage:e?.usage,runId:t,threadId:l,resourceId:u})}}};return function({resumeContext:e,models:t,logger:r,runId:a,idGenerator:s,telemetry_settings:n,messageList:i,includeRawChunks:o,modelSettings:l,tools:u,_internal:d,mode:p="stream",outputProcessors:c,returnScorerData:h,llmAISpan:m,requireToolApproval:g,agentId:f,...y}){var v;let b,w=r||new t$({level:"debug"});if(0===t.length||!t[0]){let e=new tv({id:"LOOP_MODELS_EMPTY",domain:"LLM",category:"USER"});throw w.trackException(e),w.error(e.toString()),e}let _=t[0],S=a;S||(S=s?.()||crypto.randomUUID());let I={now:d?.now||(()=>Date.now()),generateId:d?.generateId||(()=>hi()),currentDate:d?.currentDate||(()=>new Date)},k=I.now?.(),{rootSpan:T}=xc({operationId:"stream"===p?"mastra.stream":"mastra.generate",model:{modelId:_.model.modelId,provider:_.model.provider},modelSettings:l,headers:l?.headers??y.headers,telemetry_settings:n});T.setAttributes({...n?.recordOutputs!==!1?{"stream.prompt.messages":JSON.stringify(i.get.input.aiV5.model())}:{}});let{rootSpan:E}=xc({operationId:`mastra.${p}.aisdk.doStream`,model:{modelId:_.model.modelId,provider:_.model.provider},modelSettings:l,headers:l?.headers??y.headers,telemetry_settings:n}),A=y.experimental_generateMessageId?.()||I.generateId?.(),O=c&&c.length>0?new Map:void 0,C=function({resumeContext:e,requireToolApproval:t,telemetry_settings:r,models:a,toolChoice:s,modelSettings:n,_internal:i,modelStreamSpan:o,llmAISpan:l,messageId:u,runId:d,messageList:p,startTimestamp:c,streamState:h,agentId:m,...g}){return new wz.ReadableStream({start:async f=>{let y=new WritableStream({write:e=>{f.enqueue(e)}});o.setAttributes({...r?.recordInputs!==!1?{"stream.prompt.toolChoice":s?JSON.stringify(s):"auto"}:{}});let v=function(e){let{models:t,_internal:r,messageId:a,runId:s,modelStreamSpan:n,telemetry_settings:i,toolChoice:o,messageList:l,modelSettings:u,controller:d,writer:p,...c}=e,h=[],m=0,g=function({models:e,telemetry_settings:t,_internal:r,modelStreamSpan:a,...s}){let n=function({models:e,_internal:t,messageId:r,runId:a,modelStreamSpan:s,telemetry_settings:n,tools:i,toolChoice:o,messageList:l,includeRawChunks:u,modelSettings:d,providerOptions:p,options:c,toolCallStreaming:h,controller:m,output:g,outputProcessors:f,headers:y,downloadRetries:v,downloadConcurrency:b,processorStates:w}){return xk({id:"llm-execution",inputSchema:xR,outputSchema:xR,execute:async({inputData:_,bail:S,tracingContext:I})=>{let k,T,E,A,{outputStream:O,callBail:C,runState:R}=await (async t=>{let r,a=0,s=!1;for(let n of e){a++;let i=n.maxRetries||0,o=0;if(s)break;for(;o<=i;)try{let l=o===i&&a===e.length;r=await t(n.model,l),s=!0;break}catch(e){if(o++,console.error(`Error executing model ${n.model.modelId}, attempt ${o}====`,e),o>i)break}}if(void 0===r)throw console.error("Exhausted all fallback models and reached the maximum number of retries."),Error("Exhausted all fallback models and reached the maximum number of retries.");return r})(async(e,S)=>{let O=new xz({_internal:t,model:e});if("v2"===e.specificationVersion){let t={downloadRetries:v,downloadConcurrency:b,supportedUrls:e?.supportedUrls},h=await l.get.all.aiV5.llmPrompt(t),f=e,w=o,I=i;if(c?.prepareStep)try{let r=await c.prepareStep({stepNumber:_.output?.steps?.length||0,steps:_.output?.steps||[],model:e,messages:l.get.all.aiV5.model()});if(r){if(r.model&&(f=r.model),r.toolChoice&&(w=r.toolChoice),r.activeTools&&I){let e=new Set(r.activeTools);I=Object.fromEntries(Object.entries(I).filter(([t])=>e.has(t)))}if(r.messages){let e=r.messages,a=new wP;for(let t of e)"system"===t.role?a.addSystem(t):"user"===t.role?a.add(t,"input"):("assistant"===t.role||"tool"===t.role)&&a.add(t,"response");h=await a.get.all.aiV5.llmPrompt(t)}}}catch(e){console.error("Error in prepareStep callback:",e)}k=function({runId:e,model:t,providerOptions:r,inputMessages:a,tools:s,toolChoice:n,options:i,onResult:o,modelStreamSpan:l,telemetry_settings:u,includeRawChunks:d,modelSettings:p,output:c,headers:h,shouldThrowError:m}){var g,f;let y=new xD({component:"LLM",name:t.modelId}),v=function({tools:e,toolChoice:t,activeTools:r}){return 0===Object.keys(e||{}).length?{tools:void 0,toolChoice:void 0}:{tools:(null!=r?Object.entries(e||{}).filter(([e])=>r.includes(e)):Object.entries(e||{})).map(([e,t])=>{try{let r;"inputSchema"in t?r=t.inputSchema:"parameters"in t&&(r=t.parameters);let a={type:"function",...t,inputSchema:r},s=a?.type??"function";switch(s){case void 0:case"dynamic":case"function":return{type:"function",name:e,description:a.description,inputSchema:h7(a.inputSchema).jsonSchema,providerOptions:a.providerOptions};case"provider-defined":return{type:"provider-defined",name:e,id:a.id,args:a.args};default:throw Error(`Unsupported tool type: ${s}`)}}catch(e){return console.error("Error preparing tool",e),null}}).filter(e=>null!==e),toolChoice:null==t?{type:"auto"}:"string"==typeof t?{type:t}:{type:"tool",toolName:t.toolName}}}({tools:s,toolChoice:n,activeTools:i?.activeTools});l&&v?.tools?.length&&u?.recordOutputs!==!1&&l.setAttributes({"stream.prompt.tools":v?.tools?.map(e=>JSON.stringify(e))});let b=(g=t.modelId,f=t.provider,xL.find(e=>e.modelId===g&&e.provider===f)),w=b?.capabilities.responseFormat?.support==="full",_=c?function(e){if(e){let t=xj(e);return{type:"json",schema:t?.jsonSchema}}return{type:"text"}}(c):void 0,S=a;return c&&_?.type==="json"&&!w&&(S=function({messages:e,schema:t,schemaPrefix:r,schemaSuffix:a}){var s,n;let i=(null==(s=e[0])?void 0:s.role)==="system"?{...e[0]}:{role:"system",content:""};return i.content=function({prompt:e,schema:t,schemaPrefix:r=null!=t?"JSON schema:":void 0,schemaSuffix:a=null!=t?"You MUST answer with a JSON object that matches the JSON schema above.":"You MUST answer with JSON."}){return[null!=e&&e.length>0?e:void 0,null!=e&&e.length>0?"":void 0,r,null!=t?JSON.stringify(t):void 0,a].filter(e=>null!=e).join("\n")}({prompt:i.content,schema:t,schemaPrefix:r,schemaSuffix:a}),[i,...(null==(n=e[0])?void 0:n.role)==="system"?e.slice(1):e]}({messages:a,schema:_.schema})),y.initialize({runId:e,onResult:o,createStream:async()=>{try{return await t.doStream({...v,prompt:S,providerOptions:r,abortSignal:i?.abortSignal,includeRawChunks:d,responseFormat:w?_:void 0,...p??{},headers:h})}catch(e){if(console.error("Error creating stream",e),e instanceof Error&&("AbortError"===e.name||"TimeoutError"===e.name)&&i?.abortSignal?.aborted&&console.error("Abort error",e),m)throw e;return{stream:new ReadableStream({start:async t=>{t.enqueue({type:"error",error:{message:e instanceof Error?e.message:JSON.stringify(e),stack:e instanceof Error?e.stack:void 0}}),t.close()}}),warnings:[],request:{},rawResponse:{}}}}})}({runId:a,model:f,providerOptions:p,inputMessages:h,tools:I,toolChoice:w,options:c,modelSettings:d,telemetry_settings:n,includeRawChunks:u,output:g,headers:y,onResult:({warnings:e,request:t,rawResponse:s})=>{T=e,E=t||{},A=s,xV(m)&&m.enqueue({runId:a,from:"AGENT",type:"step-start",payload:{request:E||{},warnings:T||[],messageId:r}})},modelStreamSpan:s,shouldThrowError:!S})}else throw Error(`Unsupported model version: ${e.specificationVersion}`);let C=new IS({model:{modelId:e.modelId,provider:e.provider,version:e.specificationVersion},stream:k,messageList:l,messageId:r,options:{runId:a,rootSpan:s,toolCallStreaming:h,telemetry_settings:n,includeRawChunks:u,output:g,outputProcessors:f,isLLMExecutionStep:!0,tracingContext:I,processorStates:w}});try{await xq({outputStream:C,includeRawChunks:u,tools:i,messageId:r,messageList:l,runState:O,options:c,controller:m,responseFromModel:{warnings:T,request:E,rawResponse:A}})}catch(e){if(console.error("Error in LLM Execution Step",e),wv(e)&&c?.abortSignal?.aborted)return await c?.onAbort?.({steps:_?.output?.steps??[]}),xV(m)&&m.enqueue({type:"abort",runId:a,from:"AGENT",payload:{}}),{callBail:!0,outputStream:C,runState:O};if(S)xV(m)&&m.enqueue({type:"error",runId:a,from:"AGENT",payload:{error:e}}),O.setState({hasErrored:!0,stepResult:{isContinued:!1,reason:"error"}});else throw e}return{outputStream:C,callBail:!1,runState:O}});if(C){let e=O._getImmediateUsage(),t=R.state.responseMetadata,a=O._getImmediateText();return S({messageId:r,stepResult:{reason:"abort",warnings:T,isContinued:!1},metadata:{providerMetadata:R.state.providerOptions,...t,modelMetadata:R.state.modelMetadata,headers:A?.headers,request:E},output:{text:a,toolCalls:[],usage:e??_.output?.usage,steps:[]},messages:{all:l.get.all.aiV5.model(),user:l.get.input.aiV5.model(),nonUser:l.get.response.aiV5.model()}})}O.tripwire&&R.setState({stepResult:{isContinued:!1,reason:"abort"}});let M=O._getImmediateToolCalls()?.map(e=>e.payload);if(M.length>0){let e=[...M.map(e=>({type:"tool-call",toolCallId:e.toolCallId,toolName:e.toolName,args:e.args}))];l.add({id:r,role:"assistant",content:e},"response")}let N=R?.state?.stepResult?.reason??O._getImmediateFinishReason(),j=R.state.hasErrored,P=O._getImmediateUsage(),$=R.state.responseMetadata,D=O._getImmediateText(),L=O._getImmediateObject(),U=O.tripwire,z=_.output?.steps||[],q=_.messages?.nonUser?.length||0,V=l.get.response.aiV5.modelContent(z.length).slice(q);z.push(new xU({warnings:O._getImmediateWarnings(),providerMetadata:R.state.providerOptions,finishReason:R.state.stepResult?.reason,content:V,response:{...$,...A,messages:l.get.response.aiV5.model()},request:E,usage:O._getImmediateUsage()}));let F={all:l.get.all.aiV5.model(),user:l.get.input.aiV5.model(),nonUser:l.get.response.aiV5.model()};return{messageId:r,stepResult:{reason:U?"abort":j?"error":N,warnings:T,isContinued:!U&&!["stop","error"].includes(N)},metadata:{providerMetadata:R.state.providerOptions,...$,...A,modelMetadata:R.state.modelMetadata,headers:A?.headers,request:E},output:{text:D,toolCalls:M,usage:P??_.output?.usage,steps:z,...L?{object:L}:{}},messages:F}}})}({models:e,_internal:r,modelStreamSpan:a,telemetry_settings:t,...s}),i=function({tools:e,messageList:t,options:r,telemetry_settings:a,writer:s,requireToolApproval:n,controller:i,runId:o,streamState:l}){return xk({id:"toolCallStep",inputSchema:xM,outputSchema:xN,execute:async({inputData:u,suspend:d,resumeData:p})=>{if(u.providerExecuted){let e=xd({isEnabled:a?.isEnabled,tracer:a?.tracer}).startSpan("mastra.stream.toolCall").setAttributes({...xp({operationId:"mastra.stream.toolCall",telemetry:a}),"stream.toolCall.toolName":u.toolName,"stream.toolCall.toolCallId":u.toolCallId,"stream.toolCall.args":JSON.stringify(u.args),"stream.toolCall.providerExecuted":!0});return u.output&&e.setAttributes({"stream.toolCall.result":JSON.stringify(u.output)}),e.end(),{...u,result:u.output}}let c=e?.[u.toolName]||Object.values(e||{})?.find(e=>"id"in e&&e.id===u.toolName);if(!c)throw Error(`Tool ${u.toolName} not found`);if(c&&"onInputAvailable"in c)try{await c?.onInputAvailable?.({toolCallId:u.toolCallId,input:u.args,messages:t.get.input.aiV5.model(),abortSignal:r?.abortSignal})}catch(e){console.error("Error calling onInputAvailable",e)}if(!c.execute)return u;let h=xd({isEnabled:a?.isEnabled,tracer:a?.tracer}).startSpan("mastra.stream.toolCall").setAttributes({...xp({operationId:"mastra.stream.toolCall",telemetry:a}),"stream.toolCall.toolName":u.toolName,"stream.toolCall.toolCallId":u.toolCallId,"stream.toolCall.args":JSON.stringify(u.args)});try{if(n||c.requireApproval)if(p){if(!p.approved)return{error:Error("Tool call was declined: "+JSON.stringify({toolCallId:u.toolCallId,toolName:u.toolName,args:u.args})),...u}}else i.enqueue({type:"tool-call-approval",runId:o,from:"AGENT",payload:{toolCallId:u.toolCallId,toolName:u.toolName,args:u.args}}),await d({requireToolApproval:{toolCallId:u.toolCallId,toolName:u.toolName,args:u.args},__streamState:l.serialize()});let e=await c.execute(u.args,{abortSignal:r?.abortSignal,toolCallId:u.toolCallId,messages:t.get.input.aiV5.model(),writableStream:s,suspend:async e=>(i.enqueue({type:"tool-call-suspended",runId:o,from:"AGENT",payload:{toolCallId:u.toolCallId,toolName:u.toolName,suspendPayload:e}}),await d({toolCallSuspended:e,__streamState:l.serialize()})),resumeData:p});return h.setAttributes({"stream.toolCall.result":JSON.stringify(e)}),h.end(),{result:e,...u}}catch(e){return h.setStatus({code:2,message:e?.message??e}),h.recordException(e),{error:e,...u}}}})}({telemetry_settings:t,...s}),o=function({models:e,telemetry_settings:t,_internal:r,modelStreamSpan:a,...s},n){return xk({id:"llmExecutionMappingStep",inputSchema:n_.array(xN),outputSchema:xR,execute:async({inputData:e,getStepResult:t,bail:a})=>{let i=t(n);if(e?.every(e=>e?.result===void 0)){let t=e.filter(e=>e?.error),n=s.experimental_generateMessageId?.()||r?.generateId?.();return t?.length&&(t.forEach(e=>{let t={type:"tool-error",runId:s.runId,from:"AGENT",payload:{error:e.error,args:e.args,toolCallId:e.toolCallId,toolName:e.toolName,providerMetadata:e.providerMetadata}};s.controller.enqueue(t)}),s.messageList.add({id:n,role:"tool",content:t.map(e=>({type:"tool-result",args:e.args,toolCallId:e.toolCallId,toolName:e.toolName,result:{tool_execution_error:e.error?.message??e.error}}))},"response")),i.stepResult.isContinued=!1,a(i)}if(e?.length){for(let t of e){let a={type:"tool-result",runId:s.runId,from:"AGENT",payload:{args:t.args,toolCallId:t.toolCallId,toolName:t.toolName,result:t.result,providerMetadata:t.providerMetadata,providerExecuted:t.providerExecuted}};s.controller.enqueue(a),i?.metadata?.modelVersion==="v2"&&await s.options?.onChunk?.({chunk:x$({chunk:a})});let n=s.experimental_generateMessageId?.()||r?.generateId?.();s.messageList.add({id:n,role:"tool",content:e.map(e=>({type:"tool-result",args:e.args,toolCallId:e.toolCallId,toolName:e.toolName,result:e.result}))},"response")}return{...i,messages:{all:s.messageList.get.all.aiV5.model(),user:s.messageList.get.input.aiV5.model(),nonUser:s.messageList.get.response.aiV5.model()}}}}})}({models:e,telemetry_settings:t,_internal:r,modelStreamSpan:a,...s},n);return xT({id:"executionWorkflow",inputSchema:xR,outputSchema:xR,options:{tracingPolicy:{internal:1},shouldPersistSnapshot:({workflowStatus:e})=>"suspended"===e}}).then(n).map(async({inputData:e})=>(a&&t?.recordOutputs!==!1&&e.output.toolCalls?.length&&a.setAttribute("stream.response.toolCalls",JSON.stringify(e.output.toolCalls?.map(e=>({toolCallId:e.toolCallId,args:e.args,toolName:e.toolName})))),e.output.toolCalls||[]),{id:"map-tool-calls"}).foreach(i,{concurrency:10}).then(o).commit()}({messageId:a,models:t,telemetry_settings:i,_internal:r,modelSettings:u,toolChoice:o,modelStreamSpan:n,controller:d,writer:p,messageList:l,runId:s,...c});return xT({id:"agentic-loop",inputSchema:xR,outputSchema:xR,options:{tracingPolicy:{internal:1},shouldPersistSnapshot:e=>"suspended"===e.workflowStatus}}).dowhile(g,async({inputData:e})=>{let t=!1,r=e.messages.nonUser.flatMap(e=>e.content),a=r.slice(m);m=r.length;let o={content:a,usage:e.output.usage||{inputTokens:0,outputTokens:0,totalTokens:0},finishReason:e.stepResult?.reason||"unknown",warnings:e.stepResult?.warnings||[],request:e.metadata?.request||{},response:{...e.metadata,modelId:e.metadata?.modelId||e.metadata?.model||"",messages:[]},text:e.output.text||"",reasoning:e.output.reasoning||[],reasoningText:e.output.reasoningText||"",files:e.output.files||[],toolCalls:e.output.toolCalls||[],toolResults:e.output.toolResults||[],sources:e.output.sources||[],staticToolCalls:e.output.staticToolCalls||[],dynamicToolCalls:e.output.dynamicToolCalls||[],staticToolResults:e.output.staticToolResults||[],dynamicToolResults:e.output.dynamicToolResults||[],providerMetadata:e.metadata?.providerMetadata};return h.push(o),c.stopWhen&&e.stepResult?.isContinued&&h.length>0&&(t=(await Promise.all((Array.isArray(c.stopWhen)?c.stopWhen:[c.stopWhen]).map(e=>e({steps:h})))).some(e=>e)),e.stepResult&&(e.stepResult.isContinued=!t&&e.stepResult.isContinued),e.stepResult?.reason!=="abort"&&xV(d)&&d.enqueue({type:"step-finish",runId:s,from:"AGENT",payload:e}),n.setAttributes({"stream.response.id":e.metadata?.id,"stream.response.model":e.metadata?.modelId,...e.metadata?.providerMetadata?{"stream.response.providerMetadata":JSON.stringify(e.metadata.providerMetadata)}:{},"stream.response.finishReason":e.stepResult?.reason,"stream.usage.inputTokens":e.output.usage?.inputTokens,"stream.usage.outputTokens":e.output.usage?.outputTokens,"stream.usage.totalTokens":e.output.usage?.totalTokens,...i?.recordOutputs!==!1?{"stream.response.text":e.output.text,"stream.prompt.messages":JSON.stringify(l.get.input.aiV5.model())}:{}}),n.end(),void 0!==e.stepResult?.reason&&(e.stepResult?.isContinued??!1)}).commit()}({resumeContext:e,requireToolApproval:t,messageId:u,models:a,telemetry_settings:r,_internal:i,modelSettings:n,toolChoice:s,modelStreamSpan:o,controller:f,writer:y,runId:d,messageList:p,startTimestamp:c,streamState:h,agentId:m,...g});g.mastra&&v.__registerMastra(g.mastra);let b={messageId:u,messages:{all:p.get.all.aiV5.model(),user:p.get.input.aiV5.model(),nonUser:[]},output:{steps:[],usage:{inputTokens:0,outputTokens:0,totalTokens:0}},metadata:{},stepResult:{reason:"undefined",warnings:[],isContinued:!0,totalUsage:{inputTokens:0,outputTokens:0,totalTokens:0}}},w=i?.now?.()-c;o.addEvent("ai.stream.firstChunk",{"ai.response.msToFirstChunk":w}),o.setAttributes({"stream.response.timestamp":new Date(c).toISOString(),"stream.response.msToFirstChunk":w}),e||f.enqueue({type:"start",runId:d,from:"AGENT",payload:{id:m}});let _=await g.mastra?.getStorage()?.loadWorkflowSnapshot({workflowName:"agentic-loop",runId:d});if(_)for(let e in _?.context){let t=_?.context[e];if(t&&"suspended"===t.status&&t.suspendPayload?.__streamState){h.deserialize(t.suspendPayload?.__streamState);break}}let S=await v.createRunAsync({runId:d}),I=e?await S.resume({resumeData:e,tracingContext:{currentSpan:l}}):await S.start({inputData:b,tracingContext:{currentSpan:l}});if("success"!==I.status||I.result.stepResult?.reason==="abort")return void f.close();f.enqueue({type:"finish",runId:d,from:"AGENT",payload:{...I.result,stepResult:{...I.result.stepResult,reason:I.result.stepResult.reason}}});let k=(i?.now?.()??Date.now())-c;o.addEvent("ai.stream.finish"),o.setAttributes({"stream.response.msToFinish":k,"stream.response.avgOutputTokensPerSecond":1e3*(I?.result?.output?.usage?.outputTokens??0)/k}),f.close()}})}({resumeContext:e,models:t,runId:S,logger:w,startTimestamp:k,messageList:i,includeRawChunks:!!o,_internal:I,tools:u,modelStreamSpan:E,telemetry_settings:n,modelSettings:l,outputProcessors:c,llmAISpan:m,messageId:A,agentId:f,requireToolApproval:g,streamState:{serialize:()=>b?.serializeState(),deserialize:e=>{b?.deserializeState(e)}},processorStates:O,...y});return v=b=new IS({model:{modelId:_.model.modelId,provider:_.model.provider,version:_.model.specificationVersion},stream:C,messageList:i,messageId:A,options:{runId:S,telemetry_settings:n,rootSpan:T,toolCallStreaming:y.toolCallStreaming,onFinish:y.options?.onFinish,onStepFinish:y.options?.onStepFinish,includeRawChunks:!!o,output:y.output,outputProcessors:c,returnScorerData:h,tracingContext:{currentSpan:m}}}),new Proxy(v,{get(e,t,r){let a=Reflect.get(e,t,e);return"function"==typeof a?a.bind(e):a}})}(r)}catch(r){let e=new tv({id:"LLM_STREAM_TEXT_AI_SDK_EXECUTION_FAILED",domain:"LLM",category:"THIRD_PARTY",details:{modelId:k.modelId,modelProvider:k.provider,runId:t??"unknown",threadId:l??"unknown",resourceId:u??"unknown"}},r);throw T?.error({error:e}),e}}},xZ=class extends wz.ReadableStream{#a={inputTokens:0,outputTokens:0,totalTokens:0};#s;#n;constructor({createStream:e,run:t}){const r={promise:null,resolve:null,reject:null};r.promise=new Promise((e,t)=>{r.resolve=e,r.reject=t});const a=e=>{this.#a.inputTokens+=parseInt(e?.inputTokens?.toString()??"0",10),this.#a.outputTokens+=parseInt(e?.outputTokens?.toString()??"0",10),this.#a.totalTokens+=parseInt(e?.totalTokens?.toString()??"0",10)};super({start:async t=>{let s=new WritableStream({write:e=>{if("step-output"===e.type&&e.payload?.output?.from==="AGENT"&&e.payload?.output?.type==="finish"||"step-output"===e.type&&e.payload?.output?.from==="WORKFLOW"&&e.payload?.output?.type==="finish"){let t=e.payload?.output;if(t&&"payload"in t&&t.payload){let e=t.payload;"usage"in e&&e.usage&&a(e.usage)}}t.enqueue(e)}});for await(let r of(await e(s)))if("workflow-step-output"===r.type){let e=r.payload.output;if(e&&"object"==typeof e&&"payload"in e){let r=e.payload;r&&"object"==typeof r&&"output"in r&&r.output&&t.enqueue(r.output)}}t.close(),r.resolve()}}),this.#n=t,this.#s=r}get status(){return this.#s.promise.then(()=>this.#n._getExecutionResults()).then(e=>e.status)}get result(){return this.#s.promise.then(()=>this.#n._getExecutionResults())}get usage(){return this.#s.promise.then(()=>this.#a)}},xW=n_.enum(["agent","workflow","none","tool"]);async function xG({runtimeContext:e,agent:t}){let r=await t.getInstructions({runtimeContext:e}),a=await t.listAgents({runtimeContext:e}),s=await t.getWorkflows({runtimeContext:e}),n=await t.getTools({runtimeContext:e}),i=await t.getModel({runtimeContext:e}),o=await t.getMemory({runtimeContext:e}),l=Object.entries(a).map(([e,t])=>` - **${e}**: ${t.getDescription()}`).join("\n"),u=Object.entries(s).map(([e,t])=>` - **${e}**: ${t.description}, input schema: ${JSON.stringify(sG(t.inputSchema))}`).join("\n"),d=await o?.getTools?.(),p=Object.entries({...n,...d}).map(([e,t])=>` - **${e}**: ${t.description}, input schema: ${JSON.stringify(sG(t.inputSchema||n_.object({})))}`).join("\n"),c=`
          You are a router in a network of specialized AI agents. 
          Your job is to decide which agent should handle each step of a task.
          If asking for completion of a task, make sure to follow system instructions closely.

          Every step will result in a prompt message. It will be a JSON object with a "selectionReason" and "finalResult" property. Make your decision based on previous decision history, as well as the overall task criteria. If you already called a primitive, you shouldn't need to call it again, unless you strongly believe it adds something to the task completion criteria. Make sure to call enough primitives to complete the task. 
            
          ## System Instructions
          ${r}
          You can only pick agents and workflows that are available in the lists below. Never call any agents or workflows that are not available in the lists below.
          ## Available Agents in Network
          ${l}
          ## Available Workflows in Network (make sure to use inputs corresponding to the input schema when calling a workflow)
          ${u}
          ## Available Tools in Network (make sure to use inputs corresponding to the input schema when calling a tool)
          ${p}
          If you have multiple entries that need to be called with a workflow or agent, call them separately with each input.
          When calling a workflow, the prompt should be a JSON value that corresponds to the input schema of the workflow. The JSON value is stringified.
          When calling a tool, the prompt should be a JSON value that corresponds to the input schema of the tool. The JSON value is stringified.
          When calling an agent, the prompt should be a text value, like you would call an LLM in a chat interface.
          Keep in mind that the user only sees the final result of the task. When reviewing completion, you should know that the user will not see the intermediate results.
        `;return new If({name:"routing-agent",instructions:c,model:i,memory:o,_agentNetworkAppend:!0})}async function xB({threadId:e,resourceId:t,messages:r,routingAgent:a,runtimeContext:s,generateId:n}){let i=await a.getMemory({runtimeContext:s}),o=await i?.getThreadById({threadId:e});if(o||(o=await i?.createThread({threadId:e,title:"",resourceId:t})),"string"==typeof r)await i?.saveMessages({messages:[{id:n(),type:"text",role:"user",content:{parts:[{type:"text",text:r}],format:2},createdAt:new Date,threadId:o?.id,resourceId:o?.resourceId}],format:"v2"});else{let e=new wP({threadId:o?.id,resourceId:o?.resourceId});e.add(r,"user");let t=e.get.all.v2();await i?.saveMessages({messages:t,format:"v2"})}return{thread:o}}async function xK({networkName:e,runtimeContext:t,runId:r,agent:a,generateId:s,routingAgentOptions:n}){let i=xk({id:"routing-agent-step",inputSchema:n_.object({task:n_.string(),primitiveId:n_.string(),primitiveType:xW,result:n_.string().optional(),iteration:n_.number(),threadId:n_.string().optional(),threadResourceId:n_.string().optional(),isOneOff:n_.boolean(),verboseIntrospection:n_.boolean()}),outputSchema:n_.object({task:n_.string(),primitiveId:n_.string(),primitiveType:xW,prompt:n_.string(),result:n_.string(),isComplete:n_.boolean().optional(),selectionReason:n_.string(),iteration:n_.number()}),execute:async({inputData:i,getInitData:o,writer:l})=>{let u,d=await o(),p=n_.object({isComplete:n_.boolean(),finalResult:n_.string(),completionReason:n_.string()}),c=await xG({runtimeContext:t,agent:a}),h=i.iteration?i.iteration+1:0;if(await l.write({type:"routing-agent-start",payload:{inputData:{...i,iteration:h}}}),"none"!==i.primitiveType&&i?.result){let o=`
                          The ${i.primitiveType} ${i.primitiveId} has contributed to the task.
                          This is the result from the agent: ${"object"==typeof i.result?JSON.stringify(i.result):i.result}
  
                          You need to evaluate that our task is complete. Pay very close attention to the SYSTEM INSTRUCTIONS for when the task is considered complete. Only return true if the task is complete according to the system instructions. Pay close attention to the finalResult and completionReason.
                          Original task: ${i.task}.

                          When generating the final result, make sure to take into account previous decision making history and results of all the previous iterations from conversation history. These are messages whose text is a JSON structure with "isNetwork" true.

                          You must return this JSON shape.
  
                          {
                              "isComplete": boolean,
                              "completionReason": string,
                              "finalResult": string
                          }
                      `;if(u=await c.generate([{role:"assistant",content:o}],{structuredOutput:{schema:p},runtimeContext:t,maxSteps:1,memory:{thread:d?.threadId??r,resource:d?.threadResourceId??e,readOnly:!0},...n}),u?.object?.isComplete){let n={task:i.task,primitiveId:"",primitiveType:"none",prompt:"",result:u.object.finalResult,isComplete:!0,selectionReason:u.object.completionReason||"",iteration:h};await l.write({type:"routing-agent-end",payload:n});let o=await a.getMemory({runtimeContext:t});return await o?.saveMessages({messages:[{id:s(),type:"text",role:"assistant",content:{parts:[{type:"text",text:u?.object?.finalResult||""}],format:2},createdAt:new Date,threadId:d?.threadId||r,resourceId:d?.threadResourceId||e}],format:"v2"}),n}}let m=[{role:"assistant",content:`
                    ${i.isOneOff?"You are executing just one primitive based on the user task. Make sure to pick the primitive that is the best suited to accomplish the whole task. Primitives that execute only part of the task should be avoided.":"You will be calling just *one* primitive at a time to accomplish the user task, every call to you is one decision in the process of accomplishing the user task. Make sure to pick primitives that are the best suited to accomplish the whole task. Completeness is the highest priority."}
  
                    The user has given you the following task: 
                    ${i.task}
                    ${u?`

${u?.object?.finalResult}`:""}

                    # Rules:

                    ## Agent:
                    - prompt should be a text value, like you would call an LLM in a chat interface.
                    - If you are calling the same agent again, make sure to adjust the prompt to be more specific.

                    ## Workflow/Tool:
                    - prompt should be a JSON value that corresponds to the input schema of the workflow or tool. The JSON value is stringified.
                    - Make sure to use inputs corresponding to the input schema when calling a workflow or tool.

                    DO NOT CALL THE PRIMITIVE YOURSELF. Make sure to not call the same primitive twice, unless you call it with different arguments and believe it adds something to the task completion criteria. Take into account previous decision making history and results in your decision making and final result. These are messages whose text is a JSON structure with "isNetwork" true.
  
                    Please select the most appropriate primitive to handle this task and the prompt to be sent to the primitive. If no primitive is appropriate, return "none" for the primitiveId and "none" for the primitiveType.
                    
                    {
                        "primitiveId": string,
                        "primitiveType": "agent" | "workflow" | "tool",
                        "prompt": string,
                        "selectionReason": string
                    }
  
                    The 'selectionReason' property should explain why you picked the primitive${i.verboseIntrospection?", as well as why the other primitives were not picked.":"."}
                    `}],g={structuredOutput:{schema:n_.object({primitiveId:n_.string().describe("The id of the primitive to be called"),primitiveType:xW.describe("The type of the primitive to be called"),prompt:n_.string().describe("The json string or text value to be sent to the primitive"),selectionReason:n_.string().describe("The reason you picked the primitive")})},runtimeContext:t,maxSteps:1,memory:{thread:d?.threadId??r,resource:d?.threadResourceId??e,readOnly:!0},...n},f=(await c.generate(m,g)).object,y={task:i.task,result:"",primitiveId:f.primitiveId,primitiveType:f.primitiveType,prompt:f.prompt,isComplete:"none"===f.primitiveId&&"none"===f.primitiveType,selectionReason:f.selectionReason,iteration:h};return await l.write({type:"routing-agent-end",payload:y}),y}}),o=xk({id:"agent-execution-step",inputSchema:n_.object({task:n_.string(),primitiveId:n_.string(),primitiveType:xW,prompt:n_.string(),result:n_.string(),isComplete:n_.boolean().optional(),selectionReason:n_.string(),iteration:n_.number()}),outputSchema:n_.object({task:n_.string(),primitiveId:n_.string(),primitiveType:xW,result:n_.string(),isComplete:n_.boolean().optional(),iteration:n_.number()}),execute:async({inputData:r,writer:n,getInitData:i})=>{let o=await a.listAgents({runtimeContext:t}),l=r.primitiveId,u=o[l];if(!u)throw new tv({id:"AGENT_NETWORK_AGENT_EXECUTION_STEP_INVALID_TASK_INPUT",domain:"AGENT_NETWORK",category:"USER",text:`Agent ${l} not found`});let d=s();await n.write({type:"agent-execution-start",payload:{agentId:r.primitiveId,args:r,runId:d}});let p=await u.stream(r.prompt,{runtimeContext:t,runId:d});for await(let e of p.fullStream)await n.write({type:`agent-execution-event-${e.type}`,payload:e});let c=await a.getMemory({runtimeContext:t}),h=await i(),m=p.messageList.get.all.v1();await c?.saveMessages({messages:[{id:s(),type:"text",role:"assistant",content:{parts:[{type:"text",text:JSON.stringify({isNetwork:!0,selectionReason:r.selectionReason,primitiveType:r.primitiveType,primitiveId:r.primitiveId,input:r.prompt,finalResult:{text:await p.text,toolCalls:await p.toolCalls,messages:m}})}],format:2},createdAt:new Date,threadId:h?.threadId||d,resourceId:h?.threadResourceId||e}],format:"v2"});let g={task:r.task,agentId:r.primitiveId,result:await p.text,isComplete:!1,iteration:r.iteration};return await n.write({type:"agent-execution-end",payload:g}),{task:r.task,primitiveId:r.primitiveId,primitiveType:r.primitiveType,result:await p.text,isComplete:!1,iteration:r.iteration}}}),l=xk({id:"workflow-execution-step",inputSchema:n_.object({task:n_.string(),primitiveId:n_.string(),primitiveType:xW,prompt:n_.string(),result:n_.string(),isComplete:n_.boolean().optional(),selectionReason:n_.string(),iteration:n_.number()}),outputSchema:n_.object({task:n_.string(),primitiveId:n_.string(),primitiveType:xW,result:n_.string(),isComplete:n_.boolean().optional(),iteration:n_.number()}),execute:async({inputData:n,writer:i,getInitData:o})=>{let l,u=await a.getWorkflows({runtimeContext:t}),d=n.primitiveId,p=u[d];if(!p)throw new tv({id:"AGENT_NETWORK_WORKFLOW_EXECUTION_STEP_INVALID_TASK_INPUT",domain:"AGENT_NETWORK",category:"USER",text:`Workflow ${d} not found`});try{l=JSON.parse(n.prompt)}catch(e){throw new tv({id:"WORKFLOW_EXECUTION_STEP_INVALID_TASK_INPUT",domain:"AGENT_NETWORK",category:"USER",text:`Invalid task input: ${n.task}`},e)}let c=await p.createRunAsync(),h={name:p.name,args:n,runId:c.runId};await i?.write({type:"workflow-execution-start",payload:h});let m=c.streamVNext({inputData:l,runtimeContext:t}),g=[];for await(let e of m)g.push(e),await i?.write({type:`workflow-execution-event-${e.type}`,payload:e});let f=!0,y=await m.result;y?.status&&y?.status!=="failed"||(f=!1);let v=JSON.stringify({isNetwork:!0,primitiveType:n.primitiveType,primitiveId:n.primitiveId,selectionReason:n.selectionReason,input:l,finalResult:{runId:c.runId,runResult:y,chunks:g,runSuccess:f}}),b=await a.getMemory({runtimeContext:t}),w=await o();await b?.saveMessages({messages:[{id:s(),type:"text",role:"assistant",content:{parts:[{type:"text",text:v}],format:2},createdAt:new Date,threadId:w?.threadId||r,resourceId:w?.threadResourceId||e}],format:"v2"});let _={task:n.task,primitiveId:n.primitiveId,primitiveType:n.primitiveType,result:v,isComplete:!1,iteration:n.iteration};return await i?.write({type:"workflow-execution-end",payload:_}),_}}),u=xk({id:"tool-execution-step",inputSchema:n_.object({task:n_.string(),primitiveId:n_.string(),primitiveType:xW,prompt:n_.string(),result:n_.string(),isComplete:n_.boolean().optional(),selectionReason:n_.string(),iteration:n_.number()}),outputSchema:n_.object({task:n_.string(),primitiveId:n_.string(),primitiveType:xW,result:n_.string(),isComplete:n_.boolean().optional(),iteration:n_.number()}),execute:async({inputData:n,getInitData:i,writer:o})=>{let l,u=await i(),d=await a.getTools({runtimeContext:t}),p=await a.getMemory({runtimeContext:t}),c=await p?.getTools?.(),h={...d,...c},m=n.primitiveId,g=h[m];if(!g)throw new tv({id:"AGENT_NETWORK_TOOL_EXECUTION_STEP_INVALID_TASK_INPUT",domain:"AGENT_NETWORK",category:"USER",text:`Tool ${m} not found`});if(!g.execute)throw new tv({id:"AGENT_NETWORK_TOOL_EXECUTION_STEP_INVALID_TASK_INPUT",domain:"AGENT_NETWORK",category:"USER",text:`Tool ${m} does not have an execute function`});try{l=JSON.parse(n.prompt)}catch(e){throw new tv({id:"AGENT_NETWORK_TOOL_EXECUTION_STEP_INVALID_TASK_INPUT",domain:"AGENT_NETWORK",category:"USER",text:`Invalid task input: ${n.task}`},e)}let f=s();await o?.write({type:"tool-execution-start",payload:{args:{...n,args:l,toolName:m,toolCallId:f},runId:r}});let y=await g.execute({runtimeContext:t,mastra:a.getMastraInstance(),resourceId:u.threadResourceId||e,threadId:u.threadId,runId:r,memory:p,context:l,tracingContext:{currentSpan:void 0},writer:o},{toolCallId:f,messages:[]});await p?.saveMessages({messages:[{id:s(),type:"text",role:"assistant",content:{parts:[{type:"text",text:JSON.stringify({isNetwork:!0,selectionReason:n.selectionReason,primitiveType:n.primitiveType,primitiveId:m,finalResult:{result:y,toolCallId:f},input:l})}],format:2},createdAt:new Date,threadId:u.threadId||r,resourceId:u.threadResourceId||e}],format:"v2"});let v={task:n.task,primitiveId:m,primitiveType:n.primitiveType,result:y,isComplete:!1,iteration:n.iteration,toolCallId:f,toolName:m};return await o?.write({type:"tool-execution-end",payload:v}),v}}),d=xk({id:"finish-step",inputSchema:n_.object({task:n_.string(),primitiveId:n_.string(),primitiveType:xW,prompt:n_.string(),result:n_.string(),isComplete:n_.boolean().optional(),selectionReason:n_.string(),iteration:n_.number()}),outputSchema:n_.object({task:n_.string(),result:n_.string(),isComplete:n_.boolean(),iteration:n_.number()}),execute:async({inputData:e,writer:t})=>{let r=e.result;"none"!==e.primitiveId||"none"!==e.primitiveType||e.result||(r=e.selectionReason);let a={task:e.task,result:r,isComplete:!!e.isComplete,iteration:e.iteration};return await t?.write({type:"network-execution-event-step-finish",payload:a}),a}}),p=xT({id:"Agent-Network-Outer-Workflow",inputSchema:n_.object({task:n_.string(),primitiveId:n_.string(),primitiveType:xW,result:n_.string().optional(),iteration:n_.number(),threadId:n_.string().optional(),threadResourceId:n_.string().optional(),isOneOff:n_.boolean(),verboseIntrospection:n_.boolean()}),outputSchema:n_.object({task:n_.string(),primitiveId:n_.string(),primitiveType:xW,prompt:n_.string(),result:n_.string(),isComplete:n_.boolean().optional(),completionReason:n_.string().optional(),iteration:n_.number(),threadId:n_.string().optional(),threadResourceId:n_.string().optional(),isOneOff:n_.boolean()}),options:{shouldPersistSnapshot:({workflowStatus:e})=>"suspended"===e}});return p.then(i).branch([[async({inputData:e})=>!e.isComplete&&"agent"===e.primitiveType,o],[async({inputData:e})=>!e.isComplete&&"workflow"===e.primitiveType,l],[async({inputData:e})=>!e.isComplete&&"tool"===e.primitiveType,u],[async({inputData:e})=>!!e.isComplete,d]]).map({task:{step:[i,o,l,u],path:"task"},isComplete:{step:[o,l,u,d],path:"isComplete"},completionReason:{step:[i,o,l,u,d],path:"completionReason"},result:{step:[o,l,u,d],path:"result"},primitiveId:{step:[i,o,l,u],path:"primitiveId"},primitiveType:{step:[i,o,l,u],path:"primitiveType"},iteration:{step:[i,o,l,u],path:"iteration"},isOneOff:{initData:p,path:"isOneOff"},threadId:{initData:p,path:"threadId"},threadResourceId:{initData:p,path:"threadResourceId"}}).commit(),{networkWorkflow:p}}async function xJ({networkName:e,runtimeContext:t,runId:r,routingAgent:a,routingAgentOptions:s,generateId:n,maxIterations:i,threadId:o,resourceId:l,messages:u}){if(!await a.getMemory({runtimeContext:t}))throw new tv({id:"AGENT_NETWORK_MEMORY_REQUIRED",domain:"AGENT_NETWORK",category:"USER",text:"Memory is required for the agent network to function properly. Please configure memory for the agent.",details:{status:400}});let{networkWorkflow:d}=await xK({networkName:e,runtimeContext:t,runId:r,agent:a,routingAgentOptions:s,generateId:n}),p=xk({id:"final-step",inputSchema:d.outputSchema,outputSchema:d.outputSchema,execute:async({inputData:e,writer:t})=>e.iteration>=i?(await t?.write({type:"network-execution-event-finish",payload:{...e,completionReason:`Max iterations reached: ${i}`}}),{...e,completionReason:`Max iterations reached: ${i}`}):e}),c=xT({id:"agent-loop-main-workflow",inputSchema:n_.object({iteration:n_.number(),task:n_.string(),primitiveId:n_.string(),primitiveType:xW,result:n_.string().optional(),threadId:n_.string().optional(),threadResourceId:n_.string().optional(),isOneOff:n_.boolean(),verboseIntrospection:n_.boolean()}),outputSchema:n_.object({task:n_.string(),primitiveId:n_.string(),primitiveType:xW,prompt:n_.string(),result:n_.string(),isComplete:n_.boolean().optional(),completionReason:n_.string().optional(),iteration:n_.number()}),options:{shouldPersistSnapshot:({workflowStatus:e})=>"suspended"===e}}).dountil(d,async({inputData:e})=>e.isComplete||e.iteration>=i).then(p).commit(),h=await c.createRunAsync({runId:r}),{thread:m}=await xB({runtimeContext:t,threadId:o||h.runId,resourceId:l||e,messages:u,routingAgent:a,generateId:n}),g=function(e){let t="";if("string"==typeof e)t=e;else{let r=Array.isArray(e)?e[e.length-1]:e;if("string"==typeof r)t=r;else if(r&&"content"in r&&r?.content){let e=r.content;if("string"==typeof e)t=e;else if(Array.isArray(e)){let r=e[e.length-1];r?.type==="text"&&(t=r.text)}}}return t}(u);return new xZ({run:h,createStream:()=>h.streamVNext({inputData:{task:g,primitiveId:"",primitiveType:"none",iteration:0,threadResourceId:m?.resourceId,threadId:m?.id,isOneOff:!1,verboseIntrospection:!0}})})}var xH=class{accumulatedText="";customState={};streamParts=[];constructor(e){}addPart(e){"text-delta"===e.type&&(this.accumulatedText+=e.payload.text),this.streamParts.push(e)}},xY=class{inputProcessors;outputProcessors;logger;agentName;constructor({inputProcessors:e,outputProcessors:t,logger:r,agentName:a}){this.inputProcessors=e??[],this.outputProcessors=t??[],this.logger=r,this.agentName=a}async runOutputProcessors(e,t,r){let a=[...e.clear.response.v2()],s={abort:()=>{throw new xh("Tripwire triggered")}};for(let[e,n]of this.outputProcessors.entries()){s.abort=e=>{throw new xh(e||`Tripwire triggered by ${n.name}`)};let i=n.processOutputResult?.bind(n);i&&(r?await r.traceMethod(async()=>a=await i({messages:a,abort:s.abort,tracingContext:t}),{spanName:`agent.outputProcessor.${n.name}`,attributes:{"processor.name":n.name,"processor.index":e.toString(),"processor.total":this.outputProcessors.length.toString()}})():a=await i({messages:a,abort:s.abort,tracingContext:t}))}return a.length>0&&e.add(a,"response"),e}async processPart(e,t,r){if(!this.outputProcessors.length)return{part:e,blocked:!1};try{let a=e;for(let e of this.outputProcessors)try{if(e.processOutputStream&&a){let s=t.get(e.name);s||(s=new xH(e.name),t.set(e.name,s)),s.addPart(a),a=await e.processOutputStream({part:a,streamParts:s.streamParts,state:s.customState,abort:t=>{throw new xh(t||`Stream part blocked by ${e.name}`)},tracingContext:r})}}catch(t){if(t instanceof xh)return{part:null,blocked:!0,reason:t.message};this.logger.error(`[Agent:${this.agentName}] - Output processor ${e.name} failed:`,t)}return{part:a,blocked:!1}}catch(t){return this.logger.error(`[Agent:${this.agentName}] - Stream part processing failed:`,t),{part:e,blocked:!1}}}async runOutputProcessorsForStream(e,t){return new ReadableStream({start:async r=>{let a=e.fullStream.getReader(),s=new Map;try{for(;;){let{done:e,value:n}=await a.read();if(e){r.close();break}let{part:i,blocked:o,reason:l}=await this.processPart(n,s,t);if(o){this.logger.debug(`[Agent:${this.agentName}] - Stream part blocked by output processor`,{reason:l,originalPart:n}),r.enqueue({type:"tripwire",tripwireReason:l||"Output processor blocked content"}),r.close();break}null!==i&&r.enqueue(i)}}catch(e){r.error(e)}}})}async runInputProcessors(e,t,r){let a=[...e.clear.input.v2()],s={abort:()=>{throw new xh("Tripwire triggered")}};for(let[e,n]of this.inputProcessors.entries()){s.abort=e=>{throw new xh(e||`Tripwire triggered by ${n.name}`)};let i=n.processInput?.bind(n);i&&(r?await r.traceMethod(async()=>a=await i({messages:a,abort:s.abort,tracingContext:t}),{spanName:`agent.inputProcessor.${n.name}`,attributes:{"processor.name":n.name,"processor.index":e.toString(),"processor.total":this.inputProcessors.length.toString()}})():a=await i({messages:a,abort:s.abort,tracingContext:t}))}return a.length>0&&e.add(a,"user"),e}},xQ=class{id;description;inputSchema;outputSchema;payload;execute;retryConfig;mastra;constructor({id:e,description:t,execute:r,payload:a,outputSchema:s,inputSchema:n,retryConfig:i}){this.id=e,this.description=t??"",this.inputSchema=n,this.payload=a,this.outputSchema=s,this.execute=r,this.retryConfig=i}},xX=((O=xX||{}).CONTINUE="continue",O.CONTINUE_FAILED="continue_failed",O.ABORT="abort",O.LIMBO="limbo",O);function x0(e){return e.type.startsWith("xstate.done.actor.")}function x1(e){return"object"==typeof e&&"step"in e&&"path"in e}function x2(e){if(e?.status==="success")return e.output}function x4(e){let t=[],r=(e,a=[])=>{for(let[s,n]of Object.entries(e)){let e=[...a,s];"string"==typeof n?t.push({stepPath:e,stepId:s,status:n}):"object"==typeof n&&null!==n&&r(n,e)}};return r(e),t}function x5(e,t,r){let a=t=>{let s={};for(let[n,i]of Object.entries(t))n===e?s[n]={...r}:"string"==typeof i?s[n]=i:"object"==typeof i&&null!==i&&(s[n]=a(i));return s};return a(t)}var x3=(e,t)=>{let r={};for(let a of Object.keys(e)){let s=e[a];a===t?r[a]="pending":"object"==typeof s&&null!==s?r[a]=x3(s,t):r[a]=s}return r};function x9(e){return x4(e.value).reduce((t,r)=>{let a={status:r.status,stepPath:r.stepPath};return"suspended"===r.status&&(a.suspendPayload=e.context.steps[r.stepId].suspendPayload,a.stepPath=r.stepPath),t.set(r.stepId,a),t},new Map)}function x6(e){return e instanceof Is}function x8(e){return e instanceof If}function x7(e,{mastra:t}={}){return{id:e.name,inputSchema:rb.z.object({prompt:rb.z.string(),resourceId:rb.z.string().optional(),threadId:rb.z.string().optional()}),outputSchema:rb.z.object({text:rb.z.string()}),execute:async({context:r,runId:a,mastra:s})=>{let n=s??t;if(!n)throw Error("Mastra instance not found");return e.__registerMastra(n),e.__registerPrimitives({logger:n.getLogger(),telemetry:n.getTelemetry()}),{text:(await e.generateLegacy(r.inputData.prompt,{runId:a,resourceId:r.inputData.resourceId,threadId:r.inputData.threadId})).text}}}}function Ie(e,{mastra:t}){var r;return e.setNested(!0),{id:e.name,workflow:e,workflowId:(r=e.name)?r.replace(/[-_]/g," ").split(" ").filter(e=>e.length>0).map((e,t)=>(e=e.replace(/[^a-zA-Z0-9]/g,""),0===t)?e.toLowerCase():e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()).join("")+function(e){let t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",r="";for(let e=0;e<3;e++){let e=Math.floor(Math.random()*t.length);r+=t.charAt(e)}return r}(3):"",execute:async({context:r,suspend:a,emit:s,mastra:n,runtimeContext:i})=>{let o=n??t;o&&(e.__registerMastra(o),e.__registerPrimitives({logger:o.getLogger(),telemetry:o.getTelemetry()}));let l=r.isResume?e.createRun({runId:r.isResume.runId}):e.createRun(),u=l.watch(t=>{s("state-update",e.name,t.results,{...r,...{[e.name]:t.results}})}),d=r.isResume&&r.isResume.stepId.includes(".")?await l.resume({stepId:r.isResume.stepId.split(".").slice(1).join("."),context:r.inputData,runtimeContext:i}):await l.start({triggerData:r.inputData,runtimeContext:i});if(u(),!d)throw Error("LegacyWorkflow run failed");if(d.activePaths?.size>0){let e=[...d.activePaths.entries()].find(([,{status:e}])=>"suspended"===e);e&&await a(e[1].suspendPayload,{...d,runId:l.runId})}return{...d,runId:l.runId}}}}function It(e){return e.startsWith("__")&&(e.includes("_if")||e.includes("_else"))}var Ir=class extends wU.default{logger;#t;#c;#h;#m;#g;#f;#y;#v;name;#b=null;#w={};#_;constructor({logger:e,mastra:t,runtimeContext:r,workflowInstance:a,executionSpan:s,name:n,runId:i,steps:o,stepGraph:l,retryConfig:u,startStepId:d}){super(),this.#t=t,this.#h=a,this.#c=r,this.#m=s,this.logger=e,this.#y=i,this.#v=d,this.name=n,this.#g=l,this.#w=o,this.#_=u,this.initializeMachine()}get startStepId(){return this.#v}async execute({stepId:e,input:t,snapshot:r,resumeData:a}={}){r&&this.logger.debug("Workflow snapshot received",{runId:this.#y,snapshot:r});let s=t.steps,n=this.#g?.initial[0]?.step?.id===e;n&&(r=void 0,t.steps={}),this.logger.debug("Machine input prepared",{runId:this.#y,input:t});let i=r?{...r,context:{...t,inputData:{...r?.context?.inputData||{},...a},isResume:{runId:r?.context?.steps[e.split(".")?.[0]]?.output?.runId||this.#y,stepId:e}}}:void 0;return this.logger.debug("Creating actor with configuration",{input:t,actorSnapshot:i,runId:this.#y,machineStates:this.#f.config.states}),this.#b=_2(this.#f,{inspect:e=>{this.logger.debug("XState inspection event",{type:e.type,event:e.event,runId:this.#y})},input:{...t,inputData:{...r?.context?.inputData||{},...a}},snapshot:i}),this.#b.start(),e&&this.#b.send({type:"RESET_TO_PENDING",stepId:e}),this.logger.debug("Actor started",{runId:this.#y}),new Promise((e,t)=>{if(!this.#b){this.logger.error("Actor not initialized",{runId:this.#y});let e=Error("Actor not initialized");this.#m?.recordException(e),this.#m?.end(),t(e);return}let r=new Set;this.#b.subscribe(async t=>{this.emit("state-update",this.#v,t),function e({value:t,path:r,suspendedPaths:a}){"string"==typeof t?"suspended"===t&&a.add(r):Object.keys(t).forEach(s=>e({value:t[s],path:r?`${r}.${s}`:s,suspendedPaths:a}))}({value:t.value,path:"",suspendedPaths:r});let a=function e({value:t,suspendedPaths:r,path:a}){return"string"==typeof t?["completed","failed"].includes(t)||"limbo"===t||r.has(a):Object.keys(t).every(s=>e({value:t[s],suspendedPaths:r,path:a?`${a}.${s}`:s}))}({value:t.value,suspendedPaths:r,path:""});if(this.logger.debug("State completion check",{allStatesComplete:a,suspendedPaths:Array.from(r),runId:this.#y}),!a)return void this.logger.debug("Not all states complete",{allStatesComplete:a,suspendedPaths:Array.from(r),runId:this.#y});try{this.logger.debug("All states complete",{runId:this.#y}),await this.#h.persistWorkflowSnapshot(),this.#S(),this.#m?.end(),e({runId:this.#y,results:n?{...s,...t.context.steps}:t.context.steps,activePaths:x9(t),timestamp:Date.now()})}catch(r){this.logger.debug("Failed to persist final snapshot",{error:r}),this.#S(),this.#m?.end(),e({runId:this.#y,results:n?{...s,...t.context.steps}:t.context.steps,activePaths:x9(t),timestamp:Date.now()})}})})}#S(){this.#b&&(this.#b.stop(),this.#b=null),this.removeAllListeners()}#x(){let e={};return Object.keys(this.#w).forEach(t=>{e[t]=this.#w[t]?.step?.retryConfig?.delay||this.#_?.delay||1e3}),e}#I(){return{updateStepResult:SV({steps:({context:e,event:t})=>{if(!x0(t))return e.steps;let{stepId:r,result:a}=t.output;return{...e.steps,[r]:{status:"success",output:a}}}}),setStepError:SV({steps:({context:e,event:t},r)=>{if(!t.type.startsWith("xstate.error.actor."))return e.steps;let{stepId:a}=r;return a?{...e.steps,[a]:{status:"failed",error:t.error.message}}:e.steps}}),notifyStepCompletion:async(e,t)=>{let{stepId:r}=t;this.logger.debug(`Step ${r} completed`)},snapshotStep:SV({_snapshot:({},e)=>{let{stepId:t}=e;return{stepId:t}}}),persistSnapshot:async({context:e})=>{e._snapshot&&await this.#h.persistWorkflowSnapshot()},decrementAttemptCount:SV({attempts:({context:e,event:t},r)=>{if(!x0(t))return e.attempts;let{stepId:a}=r,s=e.attempts[a];return void 0===s?e.attempts:{...e.attempts,[a]:s-1}}})}}#k(){return{resolverFunction:SG(async({input:e})=>{let t,r,{stepNode:a,context:s}=e,n=s.attempts[a.id],i=this.#T({stepConfig:a.config,context:s,stepId:a.id});this.logger.debug(`Resolved variables for ${a.id}`,{resolvedData:i,runId:this.#y});let o=this.logger;this.#t&&(t=lq({mastra:this.#t,logger:o}));try{r=await a.config.handler({context:{...s,inputData:{...s?.inputData||{},...i},getStepResult:e=>{let t="string"==typeof e?e:e.id;if("trigger"===t)return s.triggerData;let r=s.steps[t];if(r&&"success"===r.status)return r.output}},emit:(e,...t)=>{this.emit(e,...t)},suspend:async(e,t)=>{await this.#h.suspend(a.id,this),this.#b?(s.steps[a.id]={status:"suspended",suspendPayload:e,output:t},this.logger.debug(`Sending SUSPENDED event for step ${a.id}`),this.#b?.send({type:"SUSPENDED",suspendPayload:e,stepId:a.id,softSuspend:t})):this.logger.debug(`Actor not available for step ${a.id}`)},runId:this.#y,mastra:t,runtimeContext:this.#c})}catch(e){if(this.logger.debug(`Step ${a.id} failed`,{stepId:a.id,error:e,runId:this.#y}),this.logger.debug(`Attempt count for step ${a.id}`,{attemptCount:n,attempts:s.attempts,runId:this.#y,stepId:a.id}),!n||n<0)return{type:"STEP_FAILED",error:e instanceof Error?e.message:`Step:${a.id} failed with error: ${e}`,stepId:a.id};return{type:"STEP_WAITING",stepId:a.id}}return this.logger.debug(`Step ${a.id} result`,{stepId:a.id,result:r,runId:this.#y}),{type:"STEP_SUCCESS",result:r,stepId:a.id}}),conditionCheck:SG(async({input:e})=>{let{context:t,stepNode:r}=e,a=r.config;if(this.logger.debug(`Checking conditions for step ${r.id}`,{stepId:r.id,runId:this.#y}),!a?.when)return{type:"CONDITIONS_MET"};if(this.logger.debug(`Checking conditions for step ${r.id}`,{stepId:r.id,runId:this.#y}),"function"==typeof a?.when){let e=await a.when({context:{...t,getStepResult:e=>{let r="string"==typeof e?e:e.id;if("trigger"===r)return t.triggerData;let a=t.steps[r];if(a&&"success"===a.status)return a.output}},mastra:this.#t});if("abort"===e)e=!1;else if("continue_failed"===e)return{type:"CONDITIONS_SKIP_TO_COMPLETED"};else if("limbo"===e)return{type:"CONDITIONS_LIMBO"};else if(e)return this.logger.debug(`Condition met for step ${r.id}`,{stepId:r.id,runId:this.#y}),{type:"CONDITIONS_MET"};return It(r.id)?{type:"CONDITIONS_LIMBO"}:this.#h.hasSubscribers(r.id)?{type:"CONDITIONS_SKIPPED"}:{type:"CONDITIONS_LIMBO"}}return this.#E(a.when,t)?{type:"CONDITIONS_MET"}:{type:"CONDITION_FAILED",error:`Step:${r.id} condition check failed`}}),spawnSubscriberFunction:SG(async({input:e})=>{let{parentStepId:t,context:r}=e;return Promise.resolve({steps:(await this.#h.runMachine(t,r,this.#c)).reduce((e,t)=>({...e,...t?.results}),{})})})}}#T({stepConfig:e,context:t,stepId:r}){this.logger.debug(`Resolving variables for step ${r}`,{stepId:r,runId:this.#y});let a={};for(let[r,s]of Object.entries(e.data)){let e="trigger"===s.step?t.triggerData:x2(t.steps[s.step.id]);if(this.logger.debug(`Got source data for ${r} variable from ${"trigger"===s.step?"trigger":s.step.id}`,{sourceData:e,path:s.path,runId:this.#y}),!e&&"trigger"!==s.step){a[r]=void 0;continue}let n=""===s.path||"."===s.path?e:wY(e,s.path);this.logger.debug(`Resolved variable ${r}`,{value:n,runId:this.#y}),a[r]=n}return a}initializeMachine(){let e=(function e({schemas:t,actors:r,actions:a,guards:s,delays:n}){return{assign:SV,sendTo:S9,raise:Sz,log:xt,cancel:_3,stopChild:St,enqueueActions:S8,emit:S1,spawnChild:_8,createStateConfig:e=>e,createAction:e=>e,createMachine:e=>new SQ({...e,schemas:t},{actors:r,actions:a,guards:s,delays:n}),extend:i=>e({schemas:t,actors:r,actions:{...a,...i.actions},guards:{...s,...i.guards},delays:{...n,...i.delays}})}})({types:{},delays:this.#x(),actions:this.#I(),actors:this.#k()}).createMachine({id:this.name,type:"parallel",context:({input:e})=>({...e}),states:this.#A(this.#g)});return this.#f=e,e}#A(e){let t={};return e.initial.forEach(r=>{let a=[...e[r.id]||[]];t[r.id]={...this.#O(r,a)}}),t}#O(e,t=[]){let r=t.shift();return{initial:"pending",on:{RESET_TO_PENDING:{target:".pending"}},states:{pending:{entry:()=>{this.logger.debug(`Step ${e.id} pending`,{stepId:e.id,runId:this.#y})},exit:()=>{this.logger.debug(`Step ${e.id} finished pending`,{stepId:e.id,runId:this.#y})},invoke:{src:"conditionCheck",input:({context:t})=>({context:t,stepNode:e}),onDone:[{guard:({event:e})=>"SUSPENDED"===e.output.type,target:"suspended",actions:[SV({steps:({context:t,event:r})=>"SUSPENDED"!==r.output.type?t.steps:r.output.softSuspend?{...t.steps,[e.id]:{status:"suspended",...t.steps?.[e.id]||{},output:r.output.softSuspend}}:{...t.steps,[e.id]:{status:"suspended",...t.steps?.[e.id]||{}}},attempts:({context:t,event:r})=>"SUSPENDED"!==r.output.type?t.attempts:{...t.attempts,[e.id]:e.step.retryConfig?.attempts||0}})]},{guard:({event:e})=>"WAITING"===e.output.type,target:"waiting",actions:[{type:"decrementAttemptCount",params:{stepId:e.id}},SV({steps:({context:t,event:r})=>"WAITING"!==r.output.type?t.steps:{...t.steps,[e.id]:{status:"waiting"}}})]},{guard:({event:e})=>"CONDITIONS_MET"===e.output.type,target:"executing"},{guard:({event:e})=>"CONDITIONS_SKIP_TO_COMPLETED"===e.output.type,target:"completed"},{guard:({event:e})=>"CONDITIONS_SKIPPED"===e.output.type,actions:SV({steps:({context:t})=>{let r={...t.steps,[e.id]:{status:"skipped"}};return this.logger.debug(`Step ${e.id} skipped`,{stepId:e.id,runId:this.#y}),r}}),target:"runningSubscribers"},{guard:({event:e})=>"CONDITIONS_LIMBO"===e.output.type,target:"limbo",actions:SV({steps:({context:t})=>{let r={...t.steps,[e.id]:{status:"skipped"}};return this.logger.debug(`Step ${e.id} skipped`,{stepId:e.id,runId:this.#y}),r}})},{guard:({event:e})=>"CONDITION_FAILED"===e.output.type,target:"failed",actions:SV({steps:({context:t,event:r})=>"CONDITION_FAILED"!==r.output.type?t.steps:(this.logger.debug("Workflow condition check failed",{error:r.output.error,stepId:e.id}),{...t.steps,[e.id]:{status:"failed",error:r.output.error}})})}]}},waiting:{entry:()=>{this.logger.debug(`Step ${e.id} waiting`,{stepId:e.id,timestamp:new Date().toISOString(),runId:this.#y})},exit:()=>{this.logger.debug(`Step ${e.id} finished waiting`,{stepId:e.id,timestamp:new Date().toISOString(),runId:this.#y})},after:{[e.id]:{target:"pending"}}},limbo:{entry:()=>{this.logger.debug(`Step ${e.id} limbo`,{stepId:e.id,timestamp:new Date().toISOString(),runId:this.#y})},exit:()=>{this.logger.debug(`Step ${e.id} finished limbo`,{stepId:e.id,timestamp:new Date().toISOString(),runId:this.#y})}},suspended:{type:"final",entry:[()=>{this.logger.debug(`Step ${e.id} suspended`,{stepId:e.id,runId:this.#y})},SV({steps:({context:t,event:r})=>({...t.steps,[e.id]:{...t?.steps?.[e.id]||{},status:"suspended",suspendPayload:"SUSPENDED"===r.type?r.suspendPayload:void 0,output:"SUSPENDED"===r.type?r.softSuspend:void 0}})})]},executing:{entry:()=>{this.logger.debug(`Step ${e.id} executing`,{stepId:e.id,runId:this.#y})},on:{SUSPENDED:{target:"suspended",actions:[SV({steps:({context:t,event:r})=>({...t.steps,[e.id]:{status:"suspended",suspendPayload:"SUSPENDED"===r.type?r.suspendPayload:void 0,output:"SUSPENDED"===r.type?r.softSuspend:void 0}})})]}},invoke:{src:"resolverFunction",input:({context:t})=>({context:t,stepNode:e}),onDone:[{guard:({event:e})=>"STEP_FAILED"===e.output.type,target:"failed",actions:SV({steps:({context:t,event:r})=>{if("STEP_FAILED"!==r.output.type)return t.steps;let a={...t.steps,[e.id]:{status:"failed",error:r.output.error}};return this.logger.debug(`Step ${e.id} failed`,{error:r.output.error,stepId:e.id}),a}})},{guard:({event:e})=>"STEP_SUCCESS"===e.output.type,actions:[({event:t})=>{this.logger.debug(`Step ${e.id} finished executing`,{stepId:e.id,output:t.output,runId:this.#y})},{type:"updateStepResult",params:{stepId:e.id}},{type:"spawnSubscribers",params:{stepId:e.id}}],target:"runningSubscribers"},{guard:({event:e})=>"STEP_WAITING"===e.output.type,target:"waiting",actions:[{type:"decrementAttemptCount",params:{stepId:e.id}},SV({steps:({context:t,event:r})=>"STEP_WAITING"!==r.output.type?t.steps:{...t.steps,[e.id]:{status:"waiting"}}})]}],onError:{target:"failed",actions:[{type:"setStepError",params:{stepId:e.id}}]}}},runningSubscribers:{entry:()=>{this.logger.debug(`Step ${e.id} running subscribers`,{stepId:e.id,runId:this.#y})},exit:()=>{this.logger.debug(`Step ${e.id} finished running subscribers`,{stepId:e.id,runId:this.#y})},invoke:{src:"spawnSubscriberFunction",input:({context:t})=>({parentStepId:e.id,context:t}),onDone:{target:r?r.id:"completed",actions:[SV({steps:({context:e,event:t})=>({...e.steps,...t.output.steps})}),()=>this.logger.debug("Subscriber execution completed",{stepId:e.id})]},onError:{target:r?r.id:"completed",actions:({event:t})=>{this.logger.debug("Subscriber execution failed",{error:t.error,stepId:e.id})}}}},completed:{type:"final",entry:[{type:"notifyStepCompletion",params:{stepId:e.id}},{type:"snapshotStep",params:{stepId:e.id}},{type:"persistSnapshot"}]},failed:{type:"final",entry:[{type:"notifyStepCompletion",params:{stepId:e.id}},{type:"snapshotStep",params:{stepId:e.id}},{type:"persistSnapshot"}]},...r?{[r.id]:{...this.#O(r,t)}}:{}}}}#E(e,t){let r=!0,a=!0,s=!0,n=Object.entries(e).find(([e])=>e.includes("."));if(n){let[e,r]=n,[s,...i]=e.split("."),o=i.join("."),l="trigger"===s?t.triggerData:x2(t.steps[s]);if(this.logger.debug(`Got condition data from step ${s}`,{stepId:s,sourceData:l,runId:this.#y}),!l)return!1;let u=wY(l,o);"trigger"===s||"status"!==o||u||(u="success"),a="object"==typeof r&&null!==r?_R(r)(u):u===r}if("ref"in e){let{ref:r,query:s}=e,n="trigger"===r.step?t.triggerData:x2(t.steps[r.step.id]);if(this.logger.debug(`Got condition data from ${"trigger"===r.step?"trigger":r.step.id}`,{sourceData:n,runId:this.#y}),!n)return!1;let i=wY(n,r.path);"trigger"===r.step||"status"!==r.path||i||(i="success"),a=_R(s)(i)}"and"in e&&(r=e.and.every(e=>this.#E(e,t)),this.logger.debug("Evaluated AND condition",{andBranchResult:r,runId:this.#y})),"or"in e&&(s=e.or.some(e=>this.#E(e,t)),this.logger.debug("Evaluated OR condition",{orBranchResult:s,runId:this.#y})),"not"in e&&(a=!this.#E(e.not,t),this.logger.debug("Evaluated NOT condition",{baseResult:a,runId:this.#y}));let i=a&&r&&s;return this.logger.debug("Evaluated condition",{finalResult:i,runId:this.#y}),i}getSnapshot(){return this.#b?.getSnapshot()}},Ia=class{name;#t;#C={};logger;#w={};#g;#R={};#_;events;#y;#u=null;#m;#M=new Set;#N;#j;#P={};#$={};constructor({name:e,logger:t,steps:r,runId:a,retryConfig:s,mastra:n,stepGraph:i,stepSubscriberGraph:o,onFinish:l,onStepTransition:u,resultMapping:d,events:p}){this.name=e,this.logger=t,this.#w=r,this.#g=i,this.#R=o,this.#_=s,this.#t=n,this.#y=a??(this.#t?.generateId()||crypto.randomUUID()),this.#N=l,this.#j=d,this.events=p,u?.forEach(e=>this.#M.add(e)),this.#D()}setState(e){this.#u=e}get runId(){return this.#y}get executionSpan(){return this.#m}watch(e){return this.#M.add(e),()=>{this.#M.delete(e)}}async start({triggerData:e,runtimeContext:t}={}){let r=await this.execute({triggerData:e,runtimeContext:t??new t7});return this.#N&&(Object.values(Object.fromEntries(r.activePaths)).some(e=>"suspended"===e.status)||this.#N()),{...r,runId:this.runId}}isCompoundDependencyMet(e){if(!this.#L(e))return!0;let t=this.#$[e];return!t||Object.values(t).every(e=>!0===e)}async execute({triggerData:e,snapshot:t,stepId:r,resumeData:a,runtimeContext:s}={runtimeContext:new t7}){this.#m=this.#t?.getTelemetry()?.tracer.startSpan(`workflow.${this.name}.execute`,{attributes:{componentName:this.name,runId:this.runId}});let n={steps:{},triggerData:e||{},attempts:Object.keys(this.#w).reduce((e,t)=>(e[t]=this.#w[t]?.step?.retryConfig?.attempts||this.#_?.attempts||0,e),{})},i=this.#g,o="trigger";t&&r&&t?.suspendedSteps?.[r]&&(o=t.suspendedSteps[r],i=this.#R[o]??this.#g,n=t.context);let l=new Ir({logger:this.logger,mastra:this.#t,runtimeContext:s,workflowInstance:this,name:this.name,runId:this.runId,steps:this.#w,stepGraph:i,executionSpan:this.#m,startStepId:o,retryConfig:this.#_});this.#C[o]=l;let u=(e,t,r)=>{let a={value:{},context:{}};r?(a.value=t,a.context=r):a=t,"trigger"===e?this.#u=a.value:this.#u=x5(e,this.#u,a.value);let s=Date.now();this.#M&&this.#M.forEach(e=>{e({runId:this.#y,results:a.context.steps,activePaths:x9(a),timestamp:s})})};l.on("state-update",u);let{results:d,activePaths:p}=await l.execute({snapshot:t,stepId:r,input:n,resumeData:a});await this.persistWorkflowSnapshot();let c={results:d,activePaths:p,timestamp:Date.now()};return this.#j&&(c.result=function({runId:e,logger:t,variables:r,context:a}){let s={};for(let[n,i]of Object.entries(r)){let r="trigger"===i.step?a.triggerData:x2(a.steps[i.step.id??i.step.name]);if(t.debug(`Got source data for ${n} variable from ${"trigger"===i.step?"trigger":i.step.id??i.step.name}`,{sourceData:r,path:i.path,runId:e}),!r&&"trigger"!==i.step){s[n]=void 0;continue}let o=""===i.path||"."===i.path?r:wY(r,i.path);t.debug(`Resolved variable ${n}`,{value:o,runId:e}),s[n]=o}return s}({runId:this.#y,logger:this.logger,variables:this.#j,context:{steps:d,triggerData:e}})),c}hasSubscribers(e){return Object.keys(this.#R).some(t=>t.split("&&").includes(e))}async runMachine(e,t,r=new t7){let a=t.steps[e]?.status,s=Object.keys(this.#R).filter(t=>t.split("&&").includes(e));s.forEach(t=>{["success","failure","skipped"].includes(a)&&this.#L(t)&&(this.#$[t][e]=!0)});let n=(e,t,r)=>{let a={value:{},context:{}};r?(a.value=t,a.context=r):a=t,"trigger"===e?this.#u=a.value:this.#u=x5(e,this.#u,a.value);let s=Date.now();this.#M&&this.#M.forEach(e=>{e({runId:this.#y,results:a.context.steps,activePaths:x9(a),timestamp:s})})};return await Promise.all(s.map(async a=>{if(!this.#R[a]||!this.isCompoundDependencyMet(a))return;this.#U(a);let s=new Ir({logger:this.logger,mastra:this.#t,runtimeContext:r,workflowInstance:this,name:"trigger"===e?this.name:`${this.name}-${e}`,runId:this.runId,steps:this.#w,stepGraph:this.#R[a],executionSpan:this.#m,startStepId:e});return s.on("state-update",n),this.#C[e]=s,s.execute({input:t})}))}async suspend(e,t){this.#P[e]=t}async persistWorkflowSnapshot(){let e=this.#t?.getStorage();if(!e)return void this.logger.debug("Snapshot cannot be persisted. Mastra engine is not initialized",{runId:this.#y});let t=await e.loadWorkflowSnapshot({workflowName:this.name,runId:this.#y}),r={};for(let[e,t]of Object.entries(this.#C)){let a=t?.getSnapshot();a&&(r[e]={...a})}let a=r.trigger;delete r.trigger;let s=Object.entries(this.#P).reduce((e,[t,r])=>(e[t]=r.startStepId,e),{});if(!a&&t){t.childStates={...t.childStates,...r},t.suspendedSteps={...t.suspendedSteps,...s},await e.persistWorkflowSnapshot({workflowName:this.name,runId:this.#y,snapshot:t});return}if(a&&!t){a.suspendedSteps=s,a.childStates={...r},await e.persistWorkflowSnapshot({workflowName:this.name,runId:this.#y,snapshot:a});return}a?(a.suspendedSteps={...t.suspendedSteps,...s},t&&a!==t&&(t?.childStates?a.childStates={...t.childStates,...r}:a.childStates=r),await e.persistWorkflowSnapshot({workflowName:this.name,runId:this.#y,snapshot:a})):this.logger.debug("Snapshot cannot be persisted. No snapshot received.",{runId:this.#y})}async getState(){let e=await this.#t?.storage?.loadWorkflowSnapshot({workflowName:this.name,runId:this.runId}),t=e?{trigger:e,...Object.entries(e?.childStates??{}).reduce((e,[t,r])=>({...e,[t]:r}),{})}:{};Object.assign(t,Object.entries(this.#C).reduce((e,[t,r])=>{let a=r.getSnapshot();return a?{...e,[t]:a}:e},{}));let r=t.trigger;delete t.trigger;let a={...r},s=x4(t.value);return{runId:this.runId,value:a.value,context:a.context,activePaths:s,timestamp:Date.now()}}async resumeWithEvent(e,t,r=new t7){if(!this.events?.[e])throw Error(`Event ${e} not found`);return await this.resume({stepId:`__${e}_event`,context:{resumedEvent:t},runtimeContext:r})}async resume({stepId:e,context:t,runtimeContext:r=new t7}){return await new Promise(e=>setTimeout(e,0)),this._resume({stepId:e,context:t,runtimeContext:r})}async #z(e){let t=this.#t?.getStorage();return t?(await this.persistWorkflowSnapshot(),t.loadWorkflowSnapshot({runId:e,workflowName:this.name})):void this.logger.debug("Snapshot cannot be loaded. Mastra engine is not initialized",{runId:e})}async _resume({stepId:e,context:t,runtimeContext:r}){let a,s=await this.#z(this.runId);if(!s)throw Error(`No snapshot found for workflow run ${this.runId}`);let n=e.split("."),i=n.join(".");n.length>1&&(e=n[0]??e);try{a="string"==typeof s?JSON.parse(s):s}catch(e){throw this.logger.debug("Failed to parse workflow snapshot for resume",{error:e,runId:this.runId}),Error("Failed to parse workflow snapshot")}let o=a.suspendedSteps?.[e];if(o){if(!(a="trigger"===o?a:{...a?.childStates?.[o],...{suspendedSteps:a.suspendedSteps}}))throw Error(`No snapshot found for step: ${e} starting at ${o}`);return t&&(a.context.steps[e]={status:"success",output:{...a?.context?.steps?.[e]?.output||{},...t}}),a.children&&Object.entries(a.children).forEach(([,e])=>{if(e.snapshot?.input?.stepNode){let t=this.#q(e.snapshot.input.stepNode.step.id);e.snapshot.input.stepNode.config={...e.snapshot.input.stepNode.config,...t},e.snapshot.input.context=a.context}}),a.value=x3(a.value,e),a.context?.attempts&&(a.context.attempts[e]=this.#w[e]?.step?.retryConfig?.attempts||this.#_?.attempts||0),this.logger.debug("Resuming workflow with updated snapshot",{updatedSnapshot:a,runId:this.runId,stepId:e}),this.execute({snapshot:a,stepId:i,resumeData:t,runtimeContext:r})}}#D(){Object.keys(this.#R).forEach(e=>{if(this.#L(e)){let t=e.split("&&");this.#$[e]=t.reduce((e,t)=>(e[t]=!1,e),{})}})}#U(e){if(this.#L(e)){let t=e.split("&&");this.#$[e]=t.reduce((e,t)=>(e[t]=!1,e),{})}}#q(e){let t=(e,t,r)=>async a=>await t_.context.with(tb.trace.setSpan(t_.context.active(),this.#m),async()=>this.#t?.getTelemetry()?this.#t.getTelemetry()?.traceMethod(e,{spanName:t,attributes:r})(a):e(a)),r=async({context:r,...a})=>{let s=this.#w[e];if(!s)throw Error("Step not found");let{payload:n={},execute:i=async()=>{}}=s.step,o={...n,...r},l=this.#t?.getTelemetry()?t(i,`workflow.${this.name}.action.${e}`,{componentName:this.name,runId:a.runId}):i;return l?await l({context:o,...a}):{}};return{handler:({context:a,...s})=>this.#m?t(r,`workflow.${this.name}.step.${e}`,{componentName:this.name,runId:s?.runId})({context:a,...s}):r({context:a,...s}),data:{}}}#L(e){return e.includes("&&")}},Is=class extends tD{name;triggerSchema;resultSchema;resultMapping;events;#_;#t;#i=new Map;isNested=!1;#M=new Set;#V=[];#F=[];#Z=null;#W=[];#g={initial:[]};#G={initial:[]};#R={};#B={};#w={};#K=0;constructor({name:e,triggerSchema:t,result:r,retryConfig:a,mastra:s,events:n}){super({component:"WORKFLOW",name:e}),this.name=e,this.#_=a,this.triggerSchema=t,this.resultSchema=r?.schema,this.resultMapping=r?.mapping,this.events=n,s&&(this.__registerPrimitives({telemetry:s.getTelemetry(),logger:s.getLogger()}),this.#t=s)}step(e,t){let r=this;if(Array.isArray(e)){let r=e.map(e=>x6(e)?e.toStep():x8(e)?x7(e):e);return r.forEach(e=>this.step(e,t)),this.after(r),this.step(new xQ({id:`__after_${e.map(e=>t?.id??e?.id??e?.name).join("_")}`,execute:async()=>({success:!0})})),this}let{variables:a={}}=t||{},s={};for(let[e,t]of Object.entries(a))t&&x1(t)&&(s[e]=t);let n=x6(e)?Ie(e,{mastra:this.#t}):x8(e)?x7(e,{mastra:this.#t}):e,i=this.#J(n,t),o=t?.["#internal"]?.when||t?.when,l={step:n,config:{...this.#q(i),...t,loopLabel:t?.["#internal"]?.loopLabel,loopType:t?.["#internal"]?.loopType,serializedWhen:"function"==typeof o?o.toString():o,data:s},get id(){return r.#J(this.step,this.config)}};this.#w[i]=l;let u=this.#H({loop_check:!0}),d=this.#R[u||""],p=this.#B[u||""];return u&&d?(!d.initial.some(e=>e.config.id===i||e.step.id===i)&&(d.initial.push(l),p&&p.initial.push(l)),d[i]=[],p&&(p[i]=[])):(this.#g[i]||(this.#g[i]=[]),this.#g.initial.push(l),this.#G.initial.push(l)),this.#F.push(i),this.#Z="step",this}#Y(e,t,r){let a=this;if(Array.isArray(e)){let a=e.map(e=>x6(e)?e.toStep():e);return a.forEach(e=>this.#Y(e,t,r)),this.after(a),this.#Y(new xQ({id:`__after_${e.map(e=>e?.id??e?.name).join("_")}`,execute:async()=>({success:!0})}),void 0,r),this}let{variables:s={}}=t||{},n={};for(let[e,t]of Object.entries(s))t&&x1(t)&&(n[e]=t);let i=x6(e)?Ie(e,{mastra:this.#t}):e,o=this.#J(i,t),l=t?.["#internal"]?.when||t?.when,u={step:i,config:{...this.#q(o),...t,loopLabel:t?.["#internal"]?.loopLabel,loopType:t?.["#internal"]?.loopType,serializedWhen:"function"==typeof l?l.toString():l,data:n},get id(){return a.#J(this.step,this.config)}};this.#w[o]=u;let d=this.#H(),p=this.#R[d||""],c=this.#B[d||""];return d&&p?(!p.initial.some(e=>e.step.id===o)&&(p.initial.push(u),c&&c.initial.push(u)),p[o]=[],c&&(c[o]=[])):(this.#g[o]||(this.#g[o]=[]),this.#g.initial.push(u),this.#G.initial.push(u)),this.#F.push(o),this.#Z="step",this}#J(e,t){return"string"==typeof e?e:`${t?.id??e.id??e.name}`}then(e,t){let r=this;if(Array.isArray(e)){let r=this.#w[this.#F[this.#F.length-1]??""];if(!r)throw Error("Condition requires a step to be executed after");return this.after(r.step),e.map(e=>x6(e)?Ie(e,{mastra:this.#t}):x8(e)?x7(e):e).forEach(e=>this.step(e,t)),this.step(new xQ({id:`__after_${e.map(e=>e?.id??e?.name).join("_")}`,execute:async()=>({success:!0})})),this}let{variables:a={}}=t||{},s={};for(let[e,t]of Object.entries(a))t&&x1(t)&&(s[e]=t);let n=this.#F[this.#F.length-1],i=x6(e)?Ie(e,{mastra:this.#t}):x8(e)?x7(e):e,o=this.#J(i,t),l=t?.["#internal"]?.when||t?.when,u={step:i,config:{...this.#q(o),...t,loopLabel:t?.["#internal"]?.loopLabel,loopType:t?.["#internal"]?.loopType,serializedWhen:"function"==typeof l?l.toString():l,data:s},get id(){return r.#J(this.step,this.config)}};if(this.#w[o]=u,!n)return this;let d=this.#H(),p=this.#R[d||""],c=this.#B[d||""];return d&&"after"===this.#Z?this.step(i,t):(d&&p&&p[n]?(p[n].push(u),c&&c[n]&&c[n].push(u)):(this.#g[n]||(this.#g[n]=[]),this.#G[n]||(this.#G[n]=[]),this.#g[n].push(u),this.#G[n].push(u)),this.#Z="then",this)}loop(e,t,r,a,s){if(!this.#F[this.#F.length-1])return this;let n=this.#J(r),i={step:r,config:{...this.#q(n)},get id(){return n}};this.#w[n]=i;let o=`__${n}_${a}_loop_check`,l={id:o,execute:async({context:r})=>{if("function"==typeof t){let e=await t({context:r});switch(a){case"while":return{status:e?"continue":"complete"};case"until":return{status:e?"complete":"continue"};default:throw Error(`Invalid loop type: ${a}`)}}if(t&&"ref"in t){let{ref:a,query:s}=t,n="string"==typeof a.step?a.step:"id"in a.step?a.step.id:null;if(!n)return{status:"continue"};let i=r.steps?.[n]?.output;if(!i)return{status:"continue"};let o=a.path.split(".").reduce((e,t)=>e?.[t],i),l=Object.keys(s)[0],u=s[l];return e(l,o,u)}return{status:"continue"}},outputSchema:rb.z.object({status:rb.z.enum(["continue","complete"])})},u={step:l,config:{...this.#q(o)},get id(){return o}};this.#w[o]=u;let d=`__${n}_${a}_loop_finished`,p={id:d,execute:async()=>({success:!0})},c={step:p,config:{...this.#q(d)},get id(){return d}};return this.#w[d]=c,this.then(l,{id:o,"#internal":{loopLabel:`${n} ${a} loop check`}}),this.after(l),this.#Y(r,{when:async({context:e})=>{let t=e.steps?.[o];return t?.status!=="success"?"abort":"continue"===t?.output?.status?"continue":"continue_failed"},variables:s,"#internal":{when:t,loopType:a}}).then(l,{id:o,"#internal":{loopLabel:`${n} ${a} loop check`}}),this.#Y(p,{id:d,when:async({context:e})=>{let t=e.steps?.[o];return t?.status!=="success"?"continue_failed":"complete"===t?.output?.status?"continue":"continue_failed"},"#internal":{loopLabel:`${n} ${a} loop finished`,loopType:a}}),this}while(e,t,r){let a=this.loop((e,t,r)=>{switch(e){case"$eq":return{status:t!==r?"complete":"continue"};case"$ne":return{status:t===r?"complete":"continue"};case"$gt":return{status:t<=r?"complete":"continue"};case"$gte":return{status:t<r?"complete":"continue"};case"$lt":return{status:t>=r?"complete":"continue"};case"$lte":return{status:t>r?"complete":"continue"};default:return{status:"continue"}}},e,t,"while",r);return this.#Z="while",a}until(e,t,r){let a=this.loop((e,t,r)=>{switch(e){case"$eq":return{status:t===r?"complete":"continue"};case"$ne":return{status:t!==r?"complete":"continue"};case"$gt":return{status:t>r?"complete":"continue"};case"$gte":return{status:t>=r?"complete":"continue"};case"$lt":return{status:t<r?"complete":"continue"};case"$lte":return{status:t<=r?"complete":"continue"};default:return{status:"continue"}}},e,t,"until",r);return this.#Z="until",a}if(e,t,r){this.#K++;let a=this.#Q({if_else_check:"else"!==this.#Z});if(!a)throw Error("Condition requires a step to be executed after");if(this.after(a.step),t){let s=x6(t)?Ie(t,{mastra:this.#t}):t;if(this.step(s,{id:s.id,when:e}),r){let t=x6(r)?Ie(r,{mastra:this.#t}):r;this.step(t,{id:t.id,when:"function"==typeof e?async t=>!await e(t):{not:e}}),this.after([s,t])}else this.after(s);return this.step(new xQ({id:`${a.id}_if_else`,execute:async()=>({executed:!0})})),this}let s=`__${a.id}_if_${this.#K}`;this.step({id:s,execute:async()=>({executed:!0})},{id:s,when:e});let n=`__${a.id}_else_${this.#K}`;return this.#W.push({condition:e,elseStepKey:n,condStep:a.step}),this.#Z="if",this}else(){let e=this.#W.pop();if(!e)throw Error("No active condition found");return this.after(e.condStep).step({id:e.elseStepKey,execute:async()=>({executed:!0})},{id:e.elseStepKey,when:"function"==typeof e.condition?async t=>!await e.condition(t):{not:e.condition}}),this.#Z="else",this}after(e){let t=(Array.isArray(e)?e:[e]).map(e=>this.#J(e)).join("&&");return this.#V.push(t),this.#R[t]||(this.#R[t]={initial:[]},this.#B[t]={initial:[]}),this.#Z="after",this}afterEvent(e){if(!this.events?.[e])throw Error(`Event ${e} not found`);let t=this.#w[this.#F[this.#F.length-1]??""];if(!t)throw Error("Condition requires a step to be executed after");let r=new xQ({id:`__${e}_event`,execute:async({context:e,suspend:t})=>e.inputData?.resumedEvent?{executed:!0,resumedEvent:e.inputData?.resumedEvent}:(await t(),{executed:!1})});return this.after(t.step).step(r).after(r),this.#Z="afterEvent",this}createRun({runId:e,events:t}={}){let r=new Ia({logger:this.logger,name:this.name,mastra:this.#t,retryConfig:this.#_,steps:this.#w,runId:e,stepGraph:this.#g,stepSubscriberGraph:this.#R,onStepTransition:this.#M,resultMapping:this.resultMapping,onFinish:()=>{this.#i.delete(r.runId)},events:t});return this.#i.set(r.runId,r),{start:r.start.bind(r),runId:r.runId,watch:r.watch.bind(r),resume:r.resume.bind(r),resumeWithEvent:r.resumeWithEvent.bind(r)}}async getRun(e){let t=this.#i.get(e);if(t)return t;let r=this.#t?.getStorage();return r?await r.getWorkflowRunById({runId:e,workflowName:this.name}):(this.logger.debug("Cannot get workflow run. Mastra engine is not initialized"),null)}getMemoryRun(e){return this.#i.get(e)}commit(){return this}#X({value:e,path:t,suspendedPaths:r}){"string"==typeof e?"suspended"===e&&r.add(t):Object.keys(e).forEach(a=>this.#X({value:e[a],path:t?`${t}.${a}`:a,suspendedPaths:r}))}async getWorkflowRuns(e){let t=this.#t?.getStorage();return t?t.getWorkflowRuns({workflowName:this.name,...e??{}}):(this.logger.debug("Cannot get workflow runs. Mastra engine is not initialized"),{runs:[],total:0})}getExecutionSpan(e){return this.#i.get(e)?.executionSpan}#H({loop_check:e=!1,if_else_check:t=!1}={}){for(let r=this.#V.length-1;r>=0;r--){let a=this.#V[r];if(a&&this.#R[a]&&(!e||!a.includes("loop_check"))&&(!t||!It(a)))return a}}#Q({if_else_check:e}){for(let t=this.#F.length-1;t>=0;t--){let r=this.#F[t];if(!r)continue;let a=this.#w[r];if(!(!a||e&&It(r)))return a}}#q(e){let t=(e,t,r)=>async a=>await t_.context.with(tb.trace.setSpan(t_.context.active(),this.getExecutionSpan(r?.runId??a?.runId)),async()=>this?.telemetry?this.telemetry.traceMethod(e,{spanName:t,attributes:r})(a):e(a)),r=async({context:r,...a})=>{let s=this.#w[e];if(!s)throw Error("Step not found");let{payload:n={},execute:i=async()=>{}}=s.step,o=this.telemetry?t(i,`workflow.${this.name}.action.${e}`,{componentName:this.name,runId:a.runId}):i;return o?await o({context:{...r,inputData:{...r?.inputData||{},...n}},...a}):{}};return{handler:({context:a,...s})=>this.getExecutionSpan(s?.runId)?t(r,`workflow.${this.name}.step.${e}`,{componentName:this.name,runId:s?.runId})({context:a,...s}):r({context:a,...s}),data:{}}}#ee(e){let t=[],r=(e,a=[])=>{for(let[s,n]of Object.entries(e)){let e=[...a,s];"string"==typeof n?t.push({stepPath:e,stepId:s,status:n}):"object"==typeof n&&null!==n&&r(n,e)}};return r(e),t}async getState(e){let t=this.#i.get(e);if(t)return t.getState();let r=this.#t?.getStorage(),a=await r?.loadWorkflowSnapshot({runId:e,workflowName:this.name});if(a){let t=this.#ee(a.value);return{runId:e,value:a.value,context:a.context,activePaths:t,timestamp:Date.now()}}return null}async resume({runId:e,stepId:t,context:r,runtimeContext:a=new t7}){this.logger.warn("Please use 'resume' on the 'createRun' call instead, resume is deprecated");let s=this.#i.get(e);return s?s.resume({stepId:t,context:r,runtimeContext:a}):this.createRun({runId:e}).resume({stepId:t,context:r,runtimeContext:a})}watch(e){return this.logger.warn("Please use 'watch' on the 'createRun' call instead, watch is deprecated"),this.#M.add(e),()=>{this.#M.delete(e)}}async resumeWithEvent(e,t,r){if(this.logger.warn("Please use 'resumeWithEvent' on the 'createRun' call instead, resumeWithEvent is deprecated"),!this.events?.[t])throw Error(`Event ${t} not found`);return await this.resume({runId:e,stepId:`__${t}_event`,context:{resumedEvent:r},runtimeContext:new t7})}__registerMastra(e){this.#t=e}__registerPrimitives(e){e.telemetry&&this.__setTelemetry(e.telemetry),e.logger&&this.__setLogger(e.logger)}get stepGraph(){return this.#g}get stepSubscriberGraph(){return this.#R}get serializedStepGraph(){return this.#G}get serializedStepSubscriberGraph(){return this.#B}get steps(){return Object.entries(this.#w).reduce((e,[t,r])=>(e[t]=r.step,e),{})}setNested(e){this.isNested=e}toStep(){return new xQ(Ie(this,{mastra:this.#t}))}},In=class e{logger;debounceMs;memory;static MAX_STALENESS_MS=1e3;constructor({logger:e,debounceMs:t,memory:r}){this.logger=e,this.debounceMs=t||100,this.memory=r}saveQueues=new Map;saveDebounceTimers=new Map;debounceSave(e,t,r){this.saveDebounceTimers.has(e)&&clearTimeout(this.saveDebounceTimers.get(e)),this.saveDebounceTimers.set(e,setTimeout(()=>{this.enqueueSave(e,t,r).catch(t=>{this.logger?.error?.("Error in debounceSave",{err:t,threadId:e})}),this.saveDebounceTimers.delete(e)},this.debounceMs))}enqueueSave(e,t,r){let a=(this.saveQueues.get(e)||Promise.resolve()).then(()=>this.persistUnsavedMessages(t,r)).catch(t=>{this.logger?.error?.("Error in enqueueSave",{err:t,threadId:e})}).then(()=>{this.saveQueues.get(e)===a&&this.saveQueues.delete(e)});return this.saveQueues.set(e,a),a}clearDebounce(e){this.saveDebounceTimers.has(e)&&(clearTimeout(this.saveDebounceTimers.get(e)),this.saveDebounceTimers.delete(e))}async persistUnsavedMessages(e,t){let r=e.drainUnsavedMessages();r.length>0&&this.memory&&await this.memory.saveMessages({messages:r,memoryConfig:t})}async batchMessages(t,r,a){if(!r)return;let s=t.getEarliestUnsavedMessageTimestamp(),n=Date.now();return s&&n-s>e.MAX_STALENESS_MS?this.flushMessages(t,r,a):this.debounceSave(r,t,a)}async flushMessages(e,t,r){if(t)return this.clearDebounce(t),this.enqueueSave(t,e,r)}},Ii="structured-output",Io=class{name=Ii;schema;structuringAgent;errorStrategy;fallbackValue;isStructuringAgentStreamStarted=!1;constructor(e,t){this.schema=e.schema,this.errorStrategy=e.errorStrategy??"strict",this.fallbackValue=e.fallbackValue;const r=e.model||t;if(!r)throw Error("StructuredOutputProcessor requires a model to be provided either in options or as fallback");this.structuringAgent=new If({name:"structured-output-structurer",instructions:e.instructions||this.generateInstructions(),model:r,options:{tracingPolicy:{internal:15}}})}async processOutputStream(e){let{part:t,state:r,streamParts:a,abort:s}=e,n=r.controller;return"finish"===t.type&&await this.processAndEmitStructuredOutput(a,n,s),t}async processAndEmitStructuredOutput(e,t,r){if(!this.isStructuringAgentStreamStarted){this.isStructuringAgentStreamStarted=!0;try{let a=this.buildStructuringPrompt(e),s=`Extract and structure the key information from the following text according to the specified schema. Keep the original meaning and details:

${a}`,n=await this.structuringAgent.stream(s,{output:this.schema}),i=["start","finish","text-start","text-delta","text-end","step-start","step-finish"];for await(let e of n.fullStream){if(i.includes(e.type))continue;if("error"===e.type){if(this.handleError("Structuring failed","Internal agent did not generate structured output",r),"warn"===this.errorStrategy)break;if("fallback"===this.errorStrategy&&void 0!==this.fallbackValue){let r={runId:e.runId,from:"AGENT",type:"object-result",object:this.fallbackValue,metadata:{from:"structured-output",fallback:!0}};t.enqueue(r);break}}let a={...e,metadata:{from:"structured-output"}};t.enqueue(a)}}catch(e){this.handleError("Structured output processing failed",e instanceof Error?e.message:"Unknown error",r)}}}buildStructuringPrompt(e){let t=[],r=[],a=[],s=[];for(let n of e)switch(n.type){case"text-delta":t.push(n.payload.text);break;case"reasoning-delta":r.push(n.payload.text);break;case"tool-call":a.push(n);break;case"tool-result":s.push(n)}let n=[];if(r.length>0&&n.push(`# Assistant Reasoning
${r.join("")}`),a.length>0){let e=a.map(e=>{let t="object"==typeof e.payload.args?JSON.stringify(e.payload.args,null):e.payload.args,r=void 0!==e.payload.output?`${"object"==typeof e.payload.output?JSON.stringify(e.payload.output,null):e.payload.output}`:"";return`## ${e.payload.toolName}
### Input: ${t}
### Output: ${r}`}).join("\n");n.push(`# Tool Calls
${e}`)}if(s.length>0){let e=s.map(e=>{let t=e.payload.result;return null==t?`${e.payload.toolName}: null`:`${e.payload.toolName}: ${"object"==typeof t?JSON.stringify(t,null,2):t}`}).join("\n");n.push(`# Tool Results
${e}`)}return t.length>0&&n.push(`# Assistant Response
${t.join("")}`),n.join("\n\n")}generateInstructions(){return`You are a data structuring specialist. Your job is to convert unstructured text into a specific JSON format.

TASK: Convert the provided unstructured text into valid JSON that matches the following schema:

REQUIREMENTS:
- Return ONLY valid JSON, no additional text or explanation
- Extract relevant information from the input text
- If information is missing, use reasonable defaults or null values
- Maintain data types as specified in the schema
- Be consistent and accurate in your conversions

The input text may be in any format (sentences, bullet points, paragraphs, etc.). Extract the relevant data and structure it according to the schema.`}handleError(e,t,r){let a=`[StructuredOutputProcessor] ${e}: ${t}`;switch(this.errorStrategy){case"strict":console.error(a),r(a);break;case"warn":console.warn(a);break;case"fallback":console.info(`${a} (using fallback)`)}}},Il=tB(xn(),1),Iu=rb.z.object({id:rb.z.string().optional(),description:rb.z.string().optional(),parameters:rb.z.union([rb.z.record(rb.z.string(),rb.z.any()),rb.z.any()]),outputSchema:rb.z.union([rb.z.record(rb.z.string(),rb.z.any()),rb.z.any()]).optional(),execute:rb.z.function(rb.z.tuple([rb.z.any(),rb.z.any()]),rb.z.promise(rb.z.any())).optional(),type:rb.z.union([rb.z.literal("function"),rb.z.literal("provider-defined"),rb.z.undefined()]).optional(),args:rb.z.record(rb.z.string(),rb.z.any()).optional()}),Id=rb.z.object({id:rb.z.string(),title:rb.z.string().optional(),resourceId:rb.z.string(),createdAt:rb.z.date(),updatedAt:rb.z.date(),metadata:rb.z.record(rb.z.string(),rb.z.any()).optional()}),Ip=rb.z.object({convertedTools:rb.z.record(rb.z.string(),Iu)}),Ic=rb.z.object({threadExists:rb.z.boolean(),thread:Id.optional(),messageList:rb.z.instanceof(wP),tripwire:rb.z.boolean().optional(),tripwireReason:rb.z.string().optional()});function Ih(e,t,r){if(t)if(Array.isArray(t))for(let a of t)e.addSystem(a,r);else e.addSystem(t,r)}function Im(e,t){return e instanceof Promise?e.then(t):t(e)}function Ig(e){if(e?.memory?.thread){if("string"==typeof e.memory.thread)return{id:e.memory.thread};if("object"==typeof e.memory.thread&&e.memory.thread.id)return e.memory.thread}if(e?.threadId)return{id:e.threadId}}e0=[tE({prefix:"agent",excludeMethods:["hasOwnMemory","getMemory","__primitive","__registerMastra","__registerPrimitives","__runInputProcessors","__runOutputProcessors","_wrapToolsWithAITracing","getProcessorRunner","__setTools","__setLogger","__setTelemetry","log","listAgents","getModel","getInstructions","getTools","getLLM","getWorkflows","getDefaultGenerateOptions","getDefaultStreamOptions","getDescription","getScorers","getVoice"]})];var If=class extends(e2=tD){id;name;#et;#er;model;maxRetries;#t;#ea;#es;#en;#ei;#eo;#el;evals;#eu;#ed;#ep;#ec;#eh;#r;_agentNetworkAppend=!1;constructor(e){if(super({component:"AGENT"}),this.name=e.name,this.id=e.id??e.name,this.#et=e.instructions,this.#er=e.description,this.#r=e.options,!e.model){const t=new tv({id:"AGENT_CONSTRUCTOR_MODEL_REQUIRED",domain:"AGENT",category:"USER",details:{agentName:e.name},text:"LanguageModel is required to create an Agent. Please provide the 'model'."});throw this.logger.trackException(t),this.logger.error(t.toString()),t}if(Array.isArray(e.model)){if(0===e.model.length){const t=new tv({id:"AGENT_CONSTRUCTOR_MODEL_ARRAY_EMPTY",domain:"AGENT",category:"USER",details:{agentName:e.name},text:"Model array is empty. Please provide at least one model."});throw this.logger.trackException(t),this.logger.error(t.toString()),t}this.model=e.model.map(t=>({id:(0,ri.randomUUID)(),model:t.model,maxRetries:t.maxRetries??e?.maxRetries??0,enabled:t.enabled??!0}))}else this.model=e.model;this.maxRetries=e.maxRetries??0,e.workflows&&(this.#es=e.workflows),this.#en=e.defaultGenerateOptions||{},this.#ei=e.defaultStreamOptions||{},this.#eo=e.defaultVNextStreamOptions||{},this.#el=e.tools||{},this.evals={},e.mastra&&(this.__registerMastra(e.mastra),this.__registerPrimitives({telemetry:e.mastra.getTelemetry(),logger:e.mastra.getLogger()})),this.#eu=e.scorers||{},this.#ed=e.agents||{},e.evals&&(this.evals=e.evals),e.memory&&(this.#ea=e.memory),e.voice?(this.#ep=e.voice,"function"!=typeof e.tools&&this.#ep?.addTools(this.tools),"string"==typeof e.instructions&&this.#ep?.addInstructions(e.instructions)):this.#ep=new t9,e.inputProcessors&&(this.#ec=e.inputProcessors),e.outputProcessors&&(this.#eh=e.outputProcessors),this._agentNetworkAppend=e._agentNetworkAppend||!1}getMastraInstance(){return this.#t}listAgents({runtimeContext:e=new t7}={}){return Im(this.#ed?"function"==typeof this.#ed?this.#ed({runtimeContext:e}):this.#ed:{},e=>{if(!e){let e=new tv({id:"AGENT_GET_AGENTS_FUNCTION_EMPTY_RETURN",domain:"AGENT",category:"USER",details:{agentName:this.name},text:`[Agent:${this.name}] - Function-based agents returned empty value`});throw this.logger.trackException(e),this.logger.error(e.toString()),e}return e})}async getProcessorRunner({runtimeContext:e,inputProcessorOverrides:t,outputProcessorOverrides:r}){let a=t??(this.#ec?"function"==typeof this.#ec?await this.#ec({runtimeContext:e}):this.#ec:[]),s=r??(this.#eh?"function"==typeof this.#eh?await this.#eh({runtimeContext:e}):this.#eh:[]);return this.logger.debug("outputProcessors",s),new xY({inputProcessors:a,outputProcessors:s,logger:this.logger,agentName:this.name})}async getResolvedOutputProcessors(e){return this.#eh?"function"==typeof this.#eh?await this.#eh({runtimeContext:e||new t7}):this.#eh:[]}async getResolvedInputProcessors(e){return this.#ec?"function"==typeof this.#ec?await this.#ec({runtimeContext:e||new t7}):this.#ec:[]}async getInputProcessors(e){return this.getResolvedInputProcessors(e)}async getOutputProcessors(e){return this.getResolvedOutputProcessors(e)}hasOwnMemory(){return!!this.#ea}async getMemory({runtimeContext:e=new t7}={}){let t;if(this.#ea){if("function"!=typeof this.#ea)t=this.#ea;else{let r=this.#ea({runtimeContext:e,mastra:this.#t});if(!(t=await Promise.resolve(r))){let e=new tv({id:"AGENT_GET_MEMORY_FUNCTION_EMPTY_RETURN",domain:"AGENT",category:"USER",details:{agentName:this.name},text:`[Agent:${this.name}] - Function-based memory returned empty value`});throw this.logger.trackException(e),this.logger.error(e.toString()),e}}if(this.#t&&t&&(t.__registerMastra(this.#t),!t.hasOwnStorage)){let e=this.#t.getStorage();e&&t.setStorage(e)}return t}}get voice(){if("function"==typeof this.#et){let e=new tv({id:"AGENT_VOICE_INCOMPATIBLE_WITH_FUNCTION_INSTRUCTIONS",domain:"AGENT",category:"USER",details:{agentName:this.name},text:"Voice is not compatible when instructions are a function. Please use getVoice() instead."});throw this.logger.trackException(e),this.logger.error(e.toString()),e}return this.#ep}async getWorkflows({runtimeContext:e=new t7}={}){let t;return Object.entries((t="function"==typeof this.#es?await Promise.resolve(this.#es({runtimeContext:e,mastra:this.#t})):this.#es??{})||{}).forEach(([e,t])=>{this.#t&&t.__registerMastra(this.#t)}),t}async getScorers({runtimeContext:e=new t7}={}){return"function"!=typeof this.#eu?this.#eu:Im(this.#eu({runtimeContext:e,mastra:this.#t}),e=>{if(!e){let e=new tv({id:"AGENT_GET_SCORERS_FUNCTION_EMPTY_RETURN",domain:"AGENT",category:"USER",details:{agentName:this.name},text:`[Agent:${this.name}] - Function-based scorers returned empty value`});throw this.logger.trackException(e),this.logger.error(e.toString()),e}return e})}async getVoice({runtimeContext:e}={}){if(!this.#ep)return new t9;{let t=this.#ep;t?.addTools(await this.getTools({runtimeContext:e}));let r=await this.getInstructions({runtimeContext:e});return t?.addInstructions(this.#em(r)),t}}get instructions(){if(this.logger.warn("The instructions property is deprecated. Please use getInstructions() instead."),"function"==typeof this.#et){let e=new tv({id:"AGENT_INSTRUCTIONS_INCOMPATIBLE_WITH_FUNCTION_INSTRUCTIONS",domain:"AGENT",category:"USER",details:{agentName:this.name},text:"Instructions are not compatible when instructions are a function. Please use getInstructions() instead."});throw this.logger.trackException(e),this.logger.error(e.toString()),e}if("string"!=typeof this.#et){let e=new tv({id:"AGENT_INSTRUCTIONS_MUST_BE_STRING_FOR_DEPRECATED_GETTER",domain:"AGENT",category:"USER",details:{agentName:this.name,instructionsType:Array.isArray(this.#et)?"array":"object"},text:"The instructions getter is deprecated and only supports string instructions. For non-string instructions, please use getInstructions() instead."});throw this.logger.trackException(e),this.logger.error(e.toString()),e}return this.#et}getInstructions({runtimeContext:e=new t7}={}){return"function"==typeof this.#et?Im(this.#et({runtimeContext:e,mastra:this.#t}),e=>{if(!e){let e=new tv({id:"AGENT_GET_INSTRUCTIONS_FUNCTION_EMPTY_RETURN",domain:"AGENT",category:"USER",details:{agentName:this.name},text:"Instructions are required to use an Agent. The function-based instructions returned an empty value."});throw this.logger.trackException(e),this.logger.error(e.toString()),e}return e}):this.#et}#em(e){return"string"==typeof e?e:Array.isArray(e)?e.map(e=>"string"==typeof e?e:"string"==typeof e.content?e.content:"").filter(e=>e).join("\n\n"):"string"==typeof e.content?e.content:""}getDescription(){return this.#er??""}getDefaultGenerateOptions({runtimeContext:e=new t7}={}){return"function"!=typeof this.#en?this.#en:Im(this.#en({runtimeContext:e,mastra:this.#t}),e=>{if(!e){let e=new tv({id:"AGENT_GET_DEFAULT_GENERATE_OPTIONS_FUNCTION_EMPTY_RETURN",domain:"AGENT",category:"USER",details:{agentName:this.name},text:`[Agent:${this.name}] - Function-based default generate options returned empty value`});throw this.logger.trackException(e),this.logger.error(e.toString()),e}return e})}getDefaultStreamOptions({runtimeContext:e=new t7}={}){return"function"!=typeof this.#ei?this.#ei:Im(this.#ei({runtimeContext:e,mastra:this.#t}),e=>{if(!e){let e=new tv({id:"AGENT_GET_DEFAULT_STREAM_OPTIONS_FUNCTION_EMPTY_RETURN",domain:"AGENT",category:"USER",details:{agentName:this.name},text:`[Agent:${this.name}] - Function-based default stream options returned empty value`});throw this.logger.trackException(e),this.logger.error(e.toString()),e}return e})}getDefaultVNextStreamOptions({runtimeContext:e=new t7}={}){return"function"!=typeof this.#eo?this.#eo:Im(this.#eo({runtimeContext:e,mastra:this.#t}),e=>{if(!e){let e=new tv({id:"AGENT_GET_DEFAULT_VNEXT_STREAM_OPTIONS_FUNCTION_EMPTY_RETURN",domain:"AGENT",category:"USER",details:{agentName:this.name},text:`[Agent:${this.name}] - Function-based default vnext stream options returned empty value`});throw this.logger.trackException(e),this.logger.error(e.toString()),e}return e})}get tools(){if(this.logger.warn("The tools property is deprecated. Please use getTools() instead."),"function"==typeof this.#el){let e=new tv({id:"AGENT_GET_TOOLS_FUNCTION_INCOMPATIBLE_WITH_TOOL_FUNCTION_TYPE",domain:"AGENT",category:"USER",details:{agentName:this.name},text:"Tools are not compatible when tools are a function. Please use getTools() instead."});throw this.logger.trackException(e),this.logger.error(e.toString()),e}return lU(this.#el)}getTools({runtimeContext:e=new t7}={}){return"function"!=typeof this.#el?lU(this.#el):Im(this.#el({runtimeContext:e,mastra:this.#t}),e=>{if(!e){let e=new tv({id:"AGENT_GET_TOOLS_FUNCTION_EMPTY_RETURN",domain:"AGENT",category:"USER",details:{agentName:this.name},text:`[Agent:${this.name}] - Function-based tools returned empty value`});throw this.logger.trackException(e),this.logger.error(e.toString()),e}return lU(e)})}get llm(){if(this.logger.warn("The llm property is deprecated. Please use getLLM() instead."),"function"==typeof this.model){let e=new tv({id:"AGENT_LLM_GETTER_INCOMPATIBLE_WITH_FUNCTION_MODEL",domain:"AGENT",category:"USER",details:{agentName:this.name},text:"LLM is not compatible when model is a function. Please use getLLM() instead."});throw this.logger.trackException(e),this.logger.error(e.toString()),e}return this.getLLM()}getLLM({runtimeContext:e=new t7,model:t}={}){return Im(this.getModel({modelConfig:t,runtimeContext:e}),r=>Im("v2"===r.specificationVersion?(Array.isArray(this.model)&&!t?this.prepareModels(e):this.prepareModels(e,r)).then(e=>new xF({models:e.filter(e=>e.enabled),mastra:this.#t,options:{tracingPolicy:this.#r?.tracingPolicy}})):new cl({model:r,mastra:this.#t,options:{tracingPolicy:this.#r?.tracingPolicy}}),e=>(this.#eg&&e.__registerPrimitives(this.#eg),this.#t&&e.__registerMastra(this.#t),e)))}isOpenaiCompatibleObjectConfig(e){return("object"!=typeof e||!("specificationVersion"in e))&&"object"==typeof e&&"id"in e&&!("model"in e)}async resolveModelConfig(e,t){if("object"==typeof e&&"specificationVersion"in e)return e;if("string"==typeof e||this.isOpenaiCompatibleObjectConfig(e))return new vR(e);if("function"==typeof e){let r=await e({runtimeContext:t,mastra:this.#t});return"string"==typeof r||this.isOpenaiCompatibleObjectConfig(r)?new vR(r):r}let r=new tv({id:"AGENT_GET_MODEL_MISSING_MODEL_INSTANCE",domain:"AGENT",category:"USER",details:{agentName:this.name},text:`[Agent:${this.name}] - No model provided`});throw this.logger.trackException(r),this.logger.error(r.toString()),r}getModel({runtimeContext:e=new t7,modelConfig:t=this.model}={}){if(!Array.isArray(t))return this.resolveModelConfig(t,e);if(0===t.length||!t[0]){let e=new tv({id:"AGENT_GET_MODEL_MISSING_MODEL_INSTANCE",domain:"AGENT",category:"USER",details:{agentName:this.name},text:`[Agent:${this.name}] - Empty model list provided`});throw this.logger.trackException(e),this.logger.error(e.toString()),e}return this.resolveModelConfig(t[0].model,e)}async getModelList(e=new t7){return Array.isArray(this.model)?this.prepareModels(e):null}__updateInstructions(e){this.#et=e,this.logger.debug(`[Agents:${this.name}] Instructions updated.`,{model:this.model,name:this.name})}__updateModel({model:e}){this.model=e,this.logger.debug(`[Agents:${this.name}] Model updated.`,{model:this.model,name:this.name})}reorderModels(e){Array.isArray(this.model)?(this.model=this.model.sort((t,r)=>e.indexOf(t.id)-e.indexOf(r.id)),this.logger.debug(`[Agents:${this.name}] Models reordered`)):this.logger.warn(`[Agents:${this.name}] model is not an array`)}updateModelInModelList({id:e,model:t,enabled:r,maxRetries:a}){Array.isArray(this.model)?this.model.find(t=>t.id===e)?(this.model=this.model.map(s=>s.id===e?{...s,model:t??s.model,enabled:r??s.enabled,maxRetries:a??s.maxRetries}:s),this.logger.debug(`[Agents:${this.name}] model ${e} updated`)):this.logger.warn(`[Agents:${this.name}] model ${e} not found`):this.logger.warn(`[Agents:${this.name}] model is not an array`)}#eg;__registerPrimitives(e){e.telemetry&&this.__setTelemetry(e.telemetry),e.logger&&this.__setLogger(e.logger),this.#eg=e,this.logger.debug(`[Agents:${this.name}] initialized.`,{model:this.model,name:this.name})}__registerMastra(e){this.#t=e}__setTools(e){this.#el=e,this.logger.debug(`[Agents:${this.name}] Tools set for agent ${this.name}`,{model:this.model,name:this.name})}async generateTitleFromUserMessage({message:e,runtimeContext:t=new t7,tracingContext:r,model:a,instructions:s}){let n=await this.getLLM({runtimeContext:t,model:a}),i=new wP().add(e,"user").get.all.ui().at(-1);if(!i)throw Error(`Could not generate title from input ${JSON.stringify(e)}`);let o=[];for(let e of i.parts)"text"===e.type?o.push(e):"source"===e.type?o.push({type:"text",text:`User added URL: ${e.source.url.substring(0,100)}`}):"file"===e.type&&o.push({type:"text",text:`User added ${e.mimeType} file: ${e.data.substring(0,100)}`});let l=await this.resolveTitleInstructions(t,s),u="";if("v2"===n.getModel().specificationVersion){let e=new wP().add([{role:"system",content:l}],"system").add([{role:"user",content:JSON.stringify(o)}],"input"),a=n.stream({runtimeContext:t,tracingContext:r,messageList:e,agentId:this.id});u=await a.text}else u=(await n.__text({runtimeContext:t,tracingContext:r,messages:[{role:"system",content:l},{role:"user",content:JSON.stringify(o)}]})).text;return u.replace(/<think>[\s\S]*?<\/think>/g,"").trim()}getMostRecentUserMessage(e){return e.filter(e=>"user"===e.role).at(-1)}async genTitle(e,t,r,a,s){try{if(e){let n=new wP().add(e,"user").get.all.ui().at(-1);if(n)return await this.generateTitleFromUserMessage({message:n,runtimeContext:t,tracingContext:r,model:a,instructions:s})}return`New Thread ${new Date().toISOString()}`}catch(e){this.logger.error("Error generating title:",e);return}}async fetchMemory({threadId:e,thread:t,memoryConfig:r,resourceId:a,runId:s,userMessages:n,systemMessage:i,messageList:o=new wP({threadId:e,resourceId:a}),runtimeContext:l=new t7}){let u=await this.getMemory({runtimeContext:l});if(u){let l=t??await u.getThreadById({threadId:e});if(!l)return{threadId:e||"",messages:n||[]};n&&n.length>0&&o.add(n,"memory"),i?.role==="system"&&o.addSystem(i,"memory");let[d,p]=e&&u?await Promise.all([u.rememberMessages({threadId:e,resourceId:a,config:r,vectorMessageSearch:o.getLatestUserContent()||""}).then(e=>e.messagesV2),u.getSystemMessage({threadId:e,memoryConfig:r})]):[[],null];this.logger.debug("Fetched messages from memory",{threadId:e,runId:s,fetchedCount:d.length}),p&&o.addSystem(p,"memory"),o.add(d,"memory");let c=o.getSystemMessages()?.map(e=>e.content)?.join(`
`)??void 0,h=o.get.input.v1(),m=await u.processMessages({messages:o.get.remembered.v1(),newMessages:h,systemMessage:c,memorySystemMessage:p||void 0}),g=new wP().addSystem(c).add(m,"memory").add(h,"user");return{threadId:l.id,messages:g.get.all.prompt()}}return{threadId:e||"",messages:n||[]}}async getMemoryTools({runId:e,resourceId:t,threadId:r,runtimeContext:a,tracingContext:s,mastraProxy:n}){let i={},o=await this.getMemory({runtimeContext:a}),l=o?.getTools?.();if(l)for(let[u,d]of(this.logger.debug(`[Agent:${this.name}] - Adding tools from memory ${Object.keys(l||{}).join(", ")}`,{runId:e}),Object.entries(l))){let l=lz(d,{name:u,runId:e,threadId:r,resourceId:t,logger:this.logger,mastra:n,memory:o,agentName:this.name,runtimeContext:a,tracingContext:s,model:await this.getModel({runtimeContext:a}),tracingPolicy:this.#r?.tracingPolicy});i[u]=l}return i}async __runInputProcessors({runtimeContext:e,tracingContext:t,messageList:r,inputProcessorOverrides:a}){let s=!1,n="";if(a?.length||this.#ec){let i=await this.getProcessorRunner({runtimeContext:e,inputProcessorOverrides:a}),o=(e,t)=>{let r=this.#t?.getTelemetry();return r?r.traceMethod(async e=>i.runInputProcessors(e.messageList,t,r),{spanName:`agent.${this.name}.inputProcessors`,attributes:{"agent.name":this.name,"inputProcessors.count":i.inputProcessors.length.toString(),"inputProcessors.names":i.inputProcessors.map(e=>e.name).join(",")}})({messageList:e}):i.runInputProcessors(e,t,void 0)};try{r=await o(r,t)}catch(e){if(e instanceof xh)s=!0,n=e.message;else throw new tv({id:"AGENT_INPUT_PROCESSOR_ERROR",domain:"AGENT",category:"USER",text:`[Agent:${this.name}] - Input processor error`},e)}}return{messageList:r,tripwireTriggered:s,tripwireReason:n}}async __runOutputProcessors({runtimeContext:e,tracingContext:t,messageList:r,outputProcessorOverrides:a}){let s=!1,n="";if(a?.length||this.#eh){let i=await this.getProcessorRunner({runtimeContext:e,outputProcessorOverrides:a}),o=(e,t)=>{let r=this.#t?.getTelemetry();return r?r.traceMethod(async e=>i.runOutputProcessors(e.messageList,t,r),{spanName:`agent.${this.name}.outputProcessors`,attributes:{"agent.name":this.name,"outputProcessors.count":i.outputProcessors.length.toString(),"outputProcessors.names":i.outputProcessors.map(e=>e.name).join(",")}})({messageList:e}):i.runOutputProcessors(e,t,void 0)};try{r=await o(r,t)}catch(e){if(e instanceof xh)s=!0,n=e.message,this.logger.debug(`[Agent:${this.name}] - Output processor tripwire triggered: ${e.message}`);else throw e}}return{messageList:r,tripwireTriggered:s,tripwireReason:n}}async getMemoryMessages({resourceId:e,threadId:t,vectorMessageSearch:r,memoryConfig:a,runtimeContext:s}){let n=await this.getMemory({runtimeContext:s});return n?n.rememberMessages({threadId:t,resourceId:e,config:a,vectorMessageSearch:r}).then(e=>e.messagesV2):[]}async getAssignedTools({runId:e,resourceId:t,threadId:r,runtimeContext:a,tracingContext:s,mastraProxy:n,writableStream:i}){this.logger.debug(`[Agents:${this.name}] - Assembling assigned tools`,{runId:e,threadId:r,resourceId:t});let o=await this.getMemory({runtimeContext:a}),l=Object.entries(await this.getTools({runtimeContext:a})||{});return{...Object.fromEntries((await Promise.all(l.map(async([l,u])=>{if(!u)return;let d={name:l,runId:e,threadId:r,resourceId:t,logger:this.logger,mastra:n,memory:o,agentName:this.name,runtimeContext:a,tracingContext:s,model:await this.getModel({runtimeContext:a}),writableStream:i,tracingPolicy:this.#r?.tracingPolicy,requireApproval:u.requireApproval};return[l,lz(u,d)]}))).filter(e=>!!e))}}async getToolsets({runId:e,threadId:t,resourceId:r,toolsets:a,runtimeContext:s,tracingContext:n,mastraProxy:i}){let o={},l=await this.getMemory({runtimeContext:s}),u=Object.values(a||{});if(u.length>0)for(let d of(this.logger.debug(`[Agent:${this.name}] - Adding tools from toolsets ${Object.keys(a||{}).join(", ")}`,{runId:e}),u))for(let[a,u]of Object.entries(d)){let d=lz(u,{name:a,runId:e,threadId:t,resourceId:r,logger:this.logger,mastra:i,memory:l,agentName:this.name,runtimeContext:s,tracingContext:n,model:await this.getModel({runtimeContext:s}),tracingPolicy:this.#r?.tracingPolicy},"toolset");o[a]=d}return o}async getClientTools({runId:e,threadId:t,resourceId:r,runtimeContext:a,tracingContext:s,mastraProxy:n,clientTools:i}){let o={},l=await this.getMemory({runtimeContext:a}),u=Object.entries(i||{});if(u.length>0)for(let[d,p]of(this.logger.debug(`[Agent:${this.name}] - Adding client tools ${Object.keys(i||{}).join(", ")}`,{runId:e}),u)){let{execute:i,...u}=p,c=lz(u,{name:d,runId:e,threadId:t,resourceId:r,logger:this.logger,mastra:n,memory:l,agentName:this.name,runtimeContext:a,tracingContext:s,model:await this.getModel({runtimeContext:a}),tracingPolicy:this.#r?.tracingPolicy},"client-tool");o[d]=c}return o}async getWorkflowTools({runId:e,threadId:t,resourceId:r,runtimeContext:a,tracingContext:s,methodType:n,format:i}){let o={},l=await this.getWorkflows({runtimeContext:a});if(Object.keys(l).length>0)for(let[u,d]of Object.entries(l)){let l=rs({id:u,description:d.description||`Workflow: ${u}`,inputSchema:d.inputSchema,outputSchema:d.outputSchema,mastra:this.#t,execute:async({context:s,writer:o,tracingContext:l})=>{try{let p;this.logger.debug(`[Agent:${this.name}] - Executing workflow as tool ${u}`,{name:u,description:d.description,args:s,runId:e,threadId:t,resourceId:r});let c=await d.createRunAsync();if("generate"===n||"generateLegacy"===n)p=await c.start({inputData:s,runtimeContext:a,tracingContext:l});else if("streamLegacy"===n){let e=c.stream({inputData:s,runtimeContext:a,tracingContext:l});if(o)await e.stream.pipeTo(o);else for await(let t of e.stream);p=await e.getWorkflowState()}else if("stream"===n){let e=c.streamVNext({inputData:s,runtimeContext:a,tracingContext:l,format:i});o&&await e.pipeTo(o),p=await e.result}return{result:p,runId:c.runId}}catch(s){let a=new tv({id:"AGENT_WORKFLOW_TOOL_EXECUTION_FAILED",domain:"AGENT",category:"USER",details:{agentName:this.name,runId:e||"",threadId:t||"",resourceId:r||""},text:`[Agent:${this.name}] - Failed workflow tool execution`},s);throw this.logger.trackException(a),this.logger.error(a.toString()),a}}}),p={name:u,runId:e,threadId:t,resourceId:r,logger:this.logger,mastra:this.#t,memory:await this.getMemory({runtimeContext:a}),agentName:this.name,runtimeContext:a,model:await this.getModel({runtimeContext:a}),tracingContext:s,tracingPolicy:this.#r?.tracingPolicy};o[u]=lz(l,p)}return o}async convertTools({toolsets:e,clientTools:t,threadId:r,resourceId:a,runId:s,runtimeContext:n,tracingContext:i,writableStream:o,methodType:l,format:u}){let d,p=this.logger;this.#t&&(d=lq({mastra:this.#t,logger:p}));let c=await this.getAssignedTools({runId:s,resourceId:a,threadId:r,runtimeContext:n,tracingContext:i,mastraProxy:d,writableStream:o}),h=await this.getMemoryTools({runId:s,resourceId:a,threadId:r,runtimeContext:n,tracingContext:i,mastraProxy:d}),m=await this.getToolsets({runId:s,resourceId:a,threadId:r,runtimeContext:n,tracingContext:i,mastraProxy:d,toolsets:e}),g=await this.getClientTools({runId:s,resourceId:a,threadId:r,runtimeContext:n,tracingContext:i,mastraProxy:d,clientTools:t}),f=await this.getWorkflowTools({runId:s,resourceId:a,threadId:r,runtimeContext:n,methodType:l,format:u,tracingContext:i});return this.formatTools({...c,...h,...m,...g,...f})}formatTools(e){let t=/[^a-zA-Z0-9_\-]/g,r=/[a-zA-Z_]/;for(let a of Object.keys(e))if(e[a]&&(a.length>63||a.match(t)||!a[0].match(r))){let s=a.replace(t,"_");if(s[0].match(r)||(s="_"+s),e[s=s.slice(0,63)]){let e=new tv({id:"AGENT_TOOL_NAME_COLLISION",domain:"AGENT",category:"USER",details:{agentName:this.name,toolName:s},text:`Two or more tools resolve to the same name "${s}". Please rename one of the tools to avoid this collision.`});throw this.logger.trackException(e),this.logger.error(e.toString()),e}e[s]=e[a],delete e[a]}return e}async saveStepMessages({saveQueueManager:e,result:t,messageList:r,threadId:a,memoryConfig:s,runId:n}){try{r.add(t.response.messages,"response"),await e.batchMessages(r,a,s)}catch(t){throw await e.flushMessages(r,a,s),this.logger.error("Error saving memory on step finish",{error:t,runId:n}),t}}__primitive({instructions:e,messages:t,context:r,thread:a,memoryConfig:s,resourceId:n,runId:i,toolsets:o,clientTools:l,runtimeContext:u,saveQueueManager:d,writableStream:p,methodType:c,tracingContext:h,tracingOptions:m}){return{before:async()=>{let d;this.logger.debug(`[Agents:${this.name}] - Starting generation`,{runId:i});let g=lY({type:"agent_run",name:`agent run: '${this.id}'`,input:{messages:t},attributes:{agentId:this.id,instructions:this.#em(e),availableTools:[...o?Object.keys(o):[],...l?Object.keys(l):[]]},metadata:{runId:i,resourceId:n,threadId:a?a.id:void 0},tracingPolicy:this.#r?.tracingPolicy,tracingOptions:m,tracingContext:h,runtimeContext:u}),f={currentSpan:g},y=await this.getMemory({runtimeContext:u}),v=[o&&Object.keys(o||{}).length>0?`toolsets present (${Object.keys(o||{}).length} tools)`:void 0,y&&n?"memory and resourceId available":void 0].filter(Boolean).join(", ");this.logger.debug(`[Agent:${this.name}] - Enhancing tools: ${v}`,{runId:i,toolsets:o?Object.keys(o):void 0,clientTools:l?Object.keys(l):void 0,hasMemory:!!y,hasResourceId:!!n});let b=a?.id,w=await this.convertTools({toolsets:o,clientTools:l,threadId:b,resourceId:n,runId:i,runtimeContext:u,tracingContext:f,writableStream:p,methodType:c}),_=new wP({threadId:b,resourceId:n,generateMessageId:this.#t?.generateId?.bind(this.#t),_agentNetworkAppend:this._agentNetworkAppend}).addSystem(e||await this.getInstructions({runtimeContext:u})).add(r||[],"context");if(!y||!b&&!n){_.add(t,"user");let{tripwireTriggered:e,tripwireReason:r}=await this.__runInputProcessors({runtimeContext:u,tracingContext:f,messageList:_});return{messageObjects:_.get.all.prompt(),convertedTools:w,threadExists:!1,thread:void 0,messageList:_,agentAISpan:g,...e&&{tripwire:!0,tripwireReason:r}}}if(!b||!n){let e=new tv({id:"AGENT_MEMORY_MISSING_RESOURCE_ID",domain:"AGENT",category:"USER",details:{agentName:this.name,threadId:b||"",resourceId:n||""},text:`A resourceId and a threadId must be provided when using Memory. Saw threadId "${b}" and resourceId "${n}"`});throw this.logger.trackException(e),this.logger.error(e.toString()),g?.error({error:e}),e}let S=y.constructor.name;this.logger.debug(`[Agent:${this.name}] - Memory persistence enabled: store=${S}, resourceId=${n}`,{runId:i,resourceId:n,threadId:b,memoryStore:S});let I=await y.getThreadById({threadId:b});d=I?!I.metadata&&a.metadata||a.metadata&&!(0,xv.default)(I.metadata,a.metadata)?await y.saveThread({thread:{...I,metadata:a.metadata},memoryConfig:s}):I:await y.createThread({threadId:b,metadata:a.metadata,title:a.title,memoryConfig:s,resourceId:n,saveThread:!1});let k=y.getMergedThreadConfig(s||{}),T="object"==typeof k?.semanticRecall&&k?.semanticRecall?.scope==="resource",[E,A]=await Promise.all([I||T?this.getMemoryMessages({resourceId:n,threadId:d.id,vectorMessageSearch:new wP().add(t,"user").getLatestUserContent()||"",memoryConfig:s,runtimeContext:u}):[],y.getSystemMessage({threadId:d.id,resourceId:n,memoryConfig:s})]);this.logger.debug("Fetched messages from memory",{threadId:d.id,runId:i,fetchedCount:E.length});let O=E.filter(e=>e.threadId!==d.id);O.length&&!A&&(A=""),O.length&&(A+=`
The following messages were remembered from a different conversation:
<remembered_from_other_conversation>
${(()=>{let e="",t=new wP().add(O,"memory").get.all.v1(),r=null;for(let a of t){let t=a.createdAt,s=t.getUTCFullYear(),n=t.toLocaleString("default",{month:"short"}),i=t.getUTCDate(),o=`${s}, ${n}, ${i}`,l=t.getUTCHours(),u=t.getUTCMinutes(),p=l%12||12,c=l<12?"AM":"PM",h=`${p}:${u<10?"0":""}${u} ${c}`;r&&r===o||(e+=`
the following messages are from ${o}
`),e+=`
  Message ${a.threadId&&a.threadId!==d.id?"from previous conversation":""} at ${h}: ${JSON.stringify(a)}`,r=o}return e})()}
<end_remembered_from_other_conversation>`),A&&_.addSystem(A,"memory"),_.add(E.filter(e=>e.threadId===d.id),"memory").add(t,"user");let{tripwireTriggered:C,tripwireReason:R}=await this.__runInputProcessors({runtimeContext:u,tracingContext:f,messageList:_}),M=_.getSystemMessages(),N=[...M,..._.getSystemMessages("memory")].map(e=>e.content)?.join(`
`)??void 0,j=await y.processMessages({messages:_.get.remembered.v1(),newMessages:_.get.input.v1(),systemMessage:N,memorySystemMessage:A||void 0}),P=new wP({threadId:d.id,resourceId:n,generateMessageId:this.#t?.generateId?.bind(this.#t),_agentNetworkAppend:this._agentNetworkAppend}).addSystem(e||await this.getInstructions({runtimeContext:u})).addSystem(A).addSystem(M).add(r||[],"context").add(j,"memory").add(_.get.input.v2(),"user").get.all.prompt();return{convertedTools:w,thread:d,messageList:_,messageObjects:P,agentAISpan:g,...C&&{tripwire:!0,tripwireReason:R},threadExists:!!I}},after:async({result:t,thread:r,threadId:a,memoryConfig:s,outputText:i,runId:o,messageList:l,threadExists:p,structuredOutput:c=!1,overrideScorers:h,agentAISpan:m})=>{let g={text:t?.text,object:t?.object,toolResults:t?.toolResults,toolCalls:t?.toolCalls,usage:t?.usage,steps:t?.steps?.map(e=>({stepType:e?.stepType,text:t?.text,object:t?.object,toolResults:t?.toolResults,toolCalls:t?.toolCalls,usage:t?.usage}))};this.logger.debug(`[Agent:${this.name}] - Post processing LLM response`,{runId:o,result:g,threadId:a});let f=new wP({threadId:a,resourceId:n,generateMessageId:this.#t?.generateId?.bind(this.#t),_agentNetworkAppend:this._agentNetworkAppend}).add(t.response.messages,"response").get.all.core(),y=f?.some(e=>"tool"===e.role&&e?.content?.some(e=>e?.toolName==="updateWorkingMemory")),v=await this.getMemory({runtimeContext:u}),b=y?a?await v?.getThreadById({threadId:a}):void 0:r;if(v&&n&&b)try{let e=t.response.messages;!e&&t.object&&(e=[{role:"assistant",content:[{type:"text",text:i}]}]),e&&l.add(e,"response"),p||await v.createThread({threadId:b.id,metadata:b.metadata,title:b.title,memoryConfig:s,resourceId:b.resourceId});let r=[d.flushMessages(l,a,s)];if(b.title?.startsWith("New Thread")){let e=v.getMergedThreadConfig(s),t=this.getMostRecentUserMessage(l.get.all.ui()),{shouldGenerate:a,model:i,instructions:o}=this.resolveTitleGenerationConfig(e?.threads?.generateTitle);a&&t&&r.push(this.genTitle(t,u,{currentSpan:m},i,o).then(e=>{if(e)return v.createThread({threadId:b.id,resourceId:n,memoryConfig:s,title:e,metadata:b.metadata})}))}await Promise.all(r)}catch(t){if(await d.flushMessages(l,a,s),t instanceof tv)throw m?.error({error:t}),t;let e=new tv({id:"AGENT_MEMORY_PERSIST_RESPONSE_MESSAGES_FAILED",domain:"AGENT",category:"SYSTEM",details:{agentName:this.name,runId:o||"",threadId:a||"",result:JSON.stringify(g)}},t);throw this.logger.trackException(e),this.logger.error(e.toString()),m?.error({error:e}),e}else{let e=t.response.messages;!e&&t.object&&(e=[{role:"assistant",content:[{type:"text",text:i}]}]),e&&l.add(e,"response")}await this.#ef({messageList:l,runId:o,outputText:i,instructions:e,runtimeContext:u,structuredOutput:c,overrideScorers:h,threadId:a,resourceId:n,tracingContext:{currentSpan:m}});let w={input:{inputMessages:l.getPersisted.input.ui(),rememberedMessages:l.getPersisted.remembered.ui(),systemMessages:l.getSystemMessages(),taggedSystemMessages:l.getPersisted.taggedSystemMessages},output:l.getPersisted.response.ui()};return m?.end({output:{text:t?.text,object:t?.object,files:t?.files}}),{scoringData:w}}}}async #ef({messageList:e,runId:t,outputText:r,instructions:a,runtimeContext:s,structuredOutput:n,overrideScorers:i,threadId:o,resourceId:l,tracingContext:u}){let d=this.name,p=e.get.all.ui().filter(e=>"user"===e.role).map(e=>"string"==typeof e.content?e.content:"").join("\n"),c=t||this.#t?.generateId()||(0,ri.randomUUID)();if(Object.keys(this.evals||{}).length>0)for(let e of Object.values(this.evals||{}))wL("onGeneration",{input:p,output:r,runId:c,metric:e,agentName:d,instructions:this.#em(a)});let h={};try{h=i?this.resolveOverrideScorerReferences(i):await this.getScorers({runtimeContext:s})}catch(e){this.logger.warn(`[Agent:${this.name}] - Failed to get scorers: ${e}`);return}let m={inputMessages:e.getPersisted.input.ui(),rememberedMessages:e.getPersisted.remembered.ui(),systemMessages:e.getSystemMessages(),taggedSystemMessages:e.getPersisted.taggedSystemMessages},g=e.getPersisted.response.ui();if(Object.keys(h||{}).length>0)for(let[e,r]of Object.entries(h))xw({scorerId:r.scorer.name,scorerObject:r,runId:t,input:m,output:g,runtimeContext:s,entity:{id:this.id,name:this.name},source:"LIVE",entityType:"AGENT",structuredOutput:!!n,threadId:o,resourceId:l,tracingContext:u})}resolveOverrideScorerReferences(e){let t={};for(let[r,a]of Object.entries(e))if("string"==typeof a.scorer)try{if(!this.#t)throw new tv({id:"AGENT_GENEREATE_SCORER_NOT_FOUND",domain:"AGENT",category:"USER",text:"Mastra not found when fetching scorer. Make sure to fetch agent from mastra.getAgent()"});let e=this.#t.getScorerByName(a.scorer);t[r]={scorer:e,sampling:a.sampling}}catch(e){this.logger.warn(`[Agent:${this.name}] - Failed to get scorer ${a.scorer}: ${e}`)}else t[r]=a;if(0===Object.keys(t).length)throw new tv({id:"AGENT_GENEREATE_SCORER_NOT_FOUND",domain:"AGENT",category:"USER",text:"No scorers found in overrideScorers"});return t}async prepareLLMOptions(e,t,r){let a,s,n,{context:i,memoryOptions:o,resourceId:l,maxSteps:u,onStepFinish:d,toolsets:p,clientTools:c,temperature:h,toolChoice:m="auto",runtimeContext:g=new t7,tracingContext:f,tracingOptions:y,savePerStep:v,writableStream:b,...w}=t,_=Ig({threadId:w.threadId,memory:w.memory}),S=w.memory?.resource||l,I=w.memory?.options||o;S&&_&&!this.hasOwnMemory()&&this.logger.warn(`[Agent:${this.name}] - No memory is configured but resourceId and threadId were passed in args. This will not work.`);let k=w.runId||this.#t?.generateId()||(0,ri.randomUUID)(),T=w.instructions||await this.getInstructions({runtimeContext:g}),E=await this.getLLM({runtimeContext:g}),A=tA.getActiveSpan(),O={};_?.id&&(A&&A.setAttribute("threadId",_.id),O.threadId={value:_.id}),S&&(A&&A.setAttribute("resourceId",S),O.resourceId={value:S}),Object.keys(O).length>0&&tA.setBaggage(O);let C=await this.getMemory({runtimeContext:g}),R=new In({logger:this.logger,memory:C}),{before:M,after:N}=this.__primitive({messages:e,instructions:T,context:i,thread:_,memoryConfig:I,resourceId:S,runId:k,toolsets:p,clientTools:c,runtimeContext:g,saveQueueManager:R,writableStream:b,methodType:r,tracingContext:f,tracingOptions:y});return{llm:E,before:async()=>{let e=await M(),{messageObjects:r,convertedTools:i,agentAISpan:o}=e;n=e.threadExists||!1,a=e.messageList,s=e.thread;let l=s?.id;return{...t,messages:r,tools:i,runId:k,temperature:h,toolChoice:m,threadId:l,resourceId:S,runtimeContext:g,onStepFinish:async e=>(v&&(!n&&C&&s&&(await C.createThread({threadId:l,title:s.title,metadata:s.metadata,resourceId:s.resourceId,memoryConfig:I}),n=!0),await this.saveStepMessages({saveQueueManager:R,result:e,messageList:a,threadId:l,memoryConfig:I,runId:k})),d?.({...e,runId:k})),...e.tripwire&&{tripwire:e.tripwire,tripwireReason:e.tripwireReason},...w,agentAISpan:o}},after:async({result:e,outputText:t,structuredOutput:r=!1,agentAISpan:i,overrideScorers:o})=>await N({result:e,outputText:t,threadId:s?.id,thread:s,memoryConfig:I,runId:k,messageList:a,structuredOutput:r,threadExists:n,agentAISpan:i,overrideScorers:o})}}async prepareModels(e,t){if(t||!Array.isArray(this.model)){let r=t??this.model,a="function"==typeof r?await r({runtimeContext:e,mastra:this.#t}):r;if("v2"!==a.specificationVersion){let e=new tv({id:"AGENT_PREPARE_MODELS_INCOMPATIBLE_WITH_MODEL_ARRAY_V1",domain:"AGENT",category:"USER",details:{agentName:this.name},text:`[Agent:${this.name}] - Only v2 models are allowed when an array of models is provided`});throw this.logger.trackException(e),this.logger.error(e.toString()),e}return[{id:"main",model:a,maxRetries:this.maxRetries??0,enabled:!0}]}return await Promise.all(this.model.map(async t=>{let r=await this.resolveModelConfig(t.model,e);if("v2"!==r.specificationVersion){let e=new tv({id:"AGENT_PREPARE_MODELS_INCOMPATIBLE_WITH_MODEL_ARRAY_V1",domain:"AGENT",category:"USER",details:{agentName:this.name},text:`[Agent:${this.name}] - Only v2 models are allowed when an array of models is provided`});throw this.logger.trackException(e),this.logger.error(e.toString()),e}let a=t.id||r.modelId;if(!a){let e=new tv({id:"AGENT_PREPARE_MODELS_MISSING_MODEL_ID",domain:"AGENT",category:"USER",details:{agentName:this.name},text:`[Agent:${this.name}] - Unable to determine model ID. Please provide an explicit ID in the model configuration.`});throw this.logger.trackException(e),this.logger.error(e.toString()),e}return{id:a,model:r,maxRetries:t.maxRetries??0,enabled:t.enabled??!0}}))}#ey(e,t){let r=e?.onFinish||t.onFinish;if(e?.onFinish&&!1===e.onFinish.__hasOriginalOnFinish&&t.onFinish){let a=e.onFinish,s=t.onFinish;r=async e=>{await a(e),await s(e)}}return r}async #ev({methodType:e,format:t="mastra",resumeContext:r,...a}){let s=a.runtimeContext||new t7,n=Ig({threadId:a.threadId,memory:a.memory}),i=a.memory?.resource||a.resourceId,o=a.memory?.options;i&&n&&!this.hasOwnMemory()&&this.logger.warn(`[Agent:${this.name}] - No memory is configured but resourceId and threadId were passed in args. This will not work.`);let l=await this.getLLM({runtimeContext:s,model:a.model}),u=a.runId||this.#t?.generateId()||(0,ri.randomUUID)(),d=a.instructions||await this.getInstructions({runtimeContext:s}),p=lY({type:"agent_run",name:`agent run: '${this.id}'`,input:a.messages,attributes:{agentId:this.id,instructions:this.#em(d)},metadata:{runId:u,resourceId:i,threadId:n?.id},tracingPolicy:this.#r?.tracingPolicy,tracingOptions:a.tracingOptions,tracingContext:a.tracingContext,runtimeContext:s}),c=tA.getActiveSpan(),h={};n?.id&&(c&&c.setAttribute("threadId",n.id),h.threadId={value:n.id}),i&&(c&&c.setAttribute("resourceId",i),h.resourceId={value:i}),Object.keys(h).length>0&&tA.setBaggage(h);let m=await this.getMemory({runtimeContext:s}),g=new In({logger:this.logger,memory:m});this.logger.debug(`[Agents:${this.name}] - Starting generation`,{runId:u});let f=function({capabilities:e,options:t,threadFromArgs:r,resourceId:a,runId:s,runtimeContext:n,agentAISpan:i,methodType:o,format:l,instructions:u,memoryConfig:d,memory:p,saveQueueManager:c,returnScorerData:h,requireToolApproval:m,resumeContext:g,agentId:f}){let y=function({capabilities:e,options:t,threadFromArgs:r,resourceId:a,runId:s,runtimeContext:n,agentAISpan:i,methodType:o,format:l,memory:u}){return xk({id:"prepare-tools-step",inputSchema:rb.z.object({}),outputSchema:Ip,execute:async()=>{let d=[t?.toolsets&&Object.keys(t?.toolsets||{}).length>0?`toolsets present (${Object.keys(t?.toolsets||{}).length} tools)`:void 0,u&&a?"memory and resourceId available":void 0].filter(Boolean).join(", ");e.logger.debug(`[Agent:${e.agentName}] - Enhancing tools: ${d}`,{runId:s,toolsets:t?.toolsets?Object.keys(t?.toolsets):void 0,clientTools:t?.clientTools?Object.keys(t?.clientTools):void 0,hasMemory:!!u,hasResourceId:!!a});let p=r?.id;return{convertedTools:await e.convertTools({toolsets:t?.toolsets,clientTools:t?.clientTools,threadId:p,resourceId:a,runId:s,runtimeContext:n,tracingContext:{currentSpan:i},writableStream:t.writableStream,methodType:o,format:l})}}})}({capabilities:e,options:t,threadFromArgs:r,resourceId:a,runId:s,runtimeContext:n,agentAISpan:i,methodType:o,format:l,memory:p}),v=function({capabilities:e,options:t,threadFromArgs:r,resourceId:a,runId:s,runtimeContext:n,instructions:i,memoryConfig:o,memory:l}){return xk({id:"prepare-memory-step",inputSchema:rb.z.object({}),outputSchema:Ic,execute:async({tracingContext:u})=>{let d,p=new wP({threadId:r?.id,resourceId:a,generateMessageId:e.generateMessageId,_agentNetworkAppend:e._agentNetworkAppend});if(Ih(p,i),p.add(t.context||[],"context"),Ih(p,t.system,"user-provided"),!l||!r?.id&&!a){p.add(t.messages,"user");let{tripwireTriggered:r,tripwireReason:a}=await e.runInputProcessors({runtimeContext:n,tracingContext:u,messageList:p});return{threadExists:!1,thread:void 0,messageList:p,...r&&{tripwire:!0,tripwireReason:a}}}if(!r?.id||!a){let t=new tv({id:"AGENT_MEMORY_MISSING_RESOURCE_ID",domain:"AGENT",category:"USER",details:{agentName:e.agentName,threadId:r?.id||"",resourceId:a||""},text:`A resourceId and a threadId must be provided when using Memory. Saw threadId "${r?.id}" and resourceId "${a}"`});throw e.logger.error(t.toString()),e.logger.trackException(t),t}let c=l.constructor.name;e.logger.debug(`[Agent:${e.agentName}] - Memory persistence enabled: store=${c}, resourceId=${a}`,{runId:s,resourceId:a,threadId:r?.id,memoryStore:c});let h=await l.getThreadById({threadId:r?.id});d=h?!h.metadata&&r.metadata||r.metadata&&!(0,Il.default)(h.metadata,r.metadata)?await l.saveThread({thread:{...h,metadata:r.metadata},memoryConfig:o}):h:await l.createThread({threadId:r?.id,metadata:r.metadata,title:r.title,memoryConfig:o,resourceId:a,saveThread:!1});let m=l.getMergedThreadConfig(o||{}),g="object"==typeof m?.semanticRecall&&m?.semanticRecall?.scope==="resource",[f,y]=await Promise.all([h||g?e.getMemoryMessages({resourceId:a,threadId:d.id,vectorMessageSearch:new wP().add(t.messages,"user").getLatestUserContent()||"",memoryConfig:o,runtimeContext:n}):[],l.getSystemMessage({threadId:d.id,resourceId:a,memoryConfig:o})]);e.logger.debug("Fetched messages from memory",{threadId:d.id,runId:s,fetchedCount:f.length});let v=f.filter(e=>e.threadId!==d.id);v.length&&!y&&(y=""),v.length&&(y+=`
The following messages were remembered from a different conversation:
<remembered_from_other_conversation>
${(()=>{let e="",t=new wP().add(v,"memory").get.all.v1(),r=null;for(let a of t){let t=a.createdAt,s=t.getUTCFullYear(),n=t.toLocaleString("default",{month:"short"}),i=t.getUTCDate(),o=`${s}, ${n}, ${i}`,l=t.getUTCHours(),u=t.getUTCMinutes(),p=l%12||12,c=l<12?"AM":"PM",h=`${p}:${u<10?"0":""}${u} ${c}`;r&&r===o||(e+=`
the following messages are from ${o}
`),e+=`Message ${a.threadId&&a.threadId!==d.id?"from previous conversation":""} at ${h}: ${JSON.stringify(a)}`,r=o}return e})()}
<end_remembered_from_other_conversation>`),y&&p.addSystem(y,"memory"),p.add(f.filter(e=>e.threadId===d.id),"memory").add(t.messages,"user");let{tripwireTriggered:b,tripwireReason:w}=await e.runInputProcessors({runtimeContext:n,tracingContext:u,messageList:p}),_=p.getSystemMessages(),S=[..._,...p.getSystemMessages("memory")].map(e=>e.content)?.join(`
`)??void 0,I=await l.processMessages({messages:p.get.remembered.v1(),newMessages:p.get.input.v1(),systemMessage:S,memorySystemMessage:y||void 0}),k=new wP({threadId:d.id,resourceId:a,generateMessageId:e.generateMessageId,_agentNetworkAppend:e._agentNetworkAppend});return Ih(k,i),k.addSystem(y).addSystem(_).add(t.context||[],"context"),Ih(k,t.system,"user-provided"),k.add(I,"memory").add(p.get.input.v2(),"user"),{thread:d,messageList:k,...b&&{tripwire:!0,tripwireReason:w},threadExists:!!h}}})}({capabilities:e,options:t,threadFromArgs:r,resourceId:a,runId:s,runtimeContext:n,instructions:u,memoryConfig:d,memory:p}),b=function({capabilities:e,runId:t,returnScorerData:r,format:a="mastra",requireToolApproval:s,resumeContext:n,agentId:i}){return xk({id:"stream-text-step",inputSchema:rb.z.any(),outputSchema:rb.z.union([rb.z.instanceof(IS),rb.z.instanceof(Iy)]),execute:async({inputData:o,tracingContext:l})=>{e.logger.debug(`Starting agent ${e.agentName} llm stream call`,{runId:t});let u=o.outputProcessors||(e.outputProcessors?"function"==typeof e.outputProcessors?await e.outputProcessors({runtimeContext:o.runtimeContext||new t7}):e.outputProcessors:[]),d=e.llm.stream({...o,outputProcessors:u,returnScorerData:r,tracingContext:l,requireToolApproval:s,resumeContext:n,_internal:{generateId:e.generateMessageId},agentId:i});return"aisdk"===a?d.aisdk.v5:d}})}({capabilities:e,runId:s,returnScorerData:h,format:l,requireToolApproval:m,resumeContext:g,agentId:f}),w=function({capabilities:e,options:t,resourceId:r,runId:a,runtimeContext:s,memory:n,memoryConfig:i,saveQueueManager:o,agentAISpan:l,instructions:u,agentId:d}){return async({inputData:p,bail:c,tracingContext:h})=>{let m=p["prepare-tools-step"],g=p["prepare-memory-step"],f={...t,tools:m.convertedTools,toolChoice:t.toolChoice,thread:g.thread,threadId:g.thread?.id,resourceId:r,runtimeContext:s,onStepFinish:async r=>(t.savePerStep&&(!g.threadExists&&n&&g.thread&&(await n.createThread({threadId:g.thread?.id,title:g.thread?.title,metadata:g.thread?.metadata,resourceId:g.thread?.resourceId,memoryConfig:i}),g.threadExists=!0),await e.saveStepMessages({saveQueueManager:o,result:r,messageList:g.messageList,threadId:g.thread?.id,memoryConfig:i,runId:a})),t.onStepFinish?.({...r,runId:a})),...g.tripwire&&{tripwire:g.tripwire,tripwireReason:g.tripwireReason}};if(f.tripwire){let r=await e.getModel({runtimeContext:f.runtimeContext});return c(await xm({tripwireReason:f.tripwireReason,runId:a,tracingContext:h,options:t,model:r,messageList:g.messageList}))}let y=t.outputProcessors||(e.outputProcessors?"function"==typeof e.outputProcessors?await e.outputProcessors({runtimeContext:f.runtimeContext}):e.outputProcessors:[]);if(t.structuredOutput?.model){let e=new Io(t.structuredOutput);y=y?[...y,e]:[e]}let v=g.messageList;return{agentId:d,runtimeContext:f.runtimeContext,tracingContext:{currentSpan:l},runId:a,toolChoice:f.toolChoice,tools:f.tools,resourceId:f.resourceId,threadId:f.threadId,structuredOutput:f.structuredOutput,stopWhen:f.stopWhen,maxSteps:f.maxSteps,providerOptions:f.providerOptions,options:{...t.prepareStep&&{prepareStep:t.prepareStep},onFinish:async n=>{if("error"===n.finishReason)return void e.logger.error("Error in agent stream",{error:n.error,runId:a});try{let d=v.get.all.core().map(e=>e.content).join("\n");await e.executeOnFinish({result:n,outputText:d,instructions:u,thread:f.thread,threadId:f.threadId,readOnlyMemory:t.memory?.readOnly,resourceId:r,memoryConfig:i,runtimeContext:s,agentAISpan:l,runId:a,messageList:v,threadExists:g.threadExists,structuredOutput:!!t.output,saveQueueManager:o,overrideScorers:t.scorers})}catch(t){e.logger.error("Error saving memory on finish",{error:t,runId:a})}await t?.onFinish?.({...n,runId:a,messages:v.get.response.aiV5.model(),usage:n.usage,totalUsage:n.totalUsage})},onStepFinish:f.onStepFinish,onChunk:t.onChunk,onError:t.onError,onAbort:t.onAbort,activeTools:t.activeTools,abortSignal:t.abortSignal},output:t.output,outputProcessors:y,modelSettings:{temperature:0,...t.modelSettings||{}},messageList:g.messageList}}}({capabilities:e,options:t,resourceId:a,runId:s,runtimeContext:n,memory:p,memoryConfig:d,saveQueueManager:c,agentAISpan:i,instructions:u,agentId:f});return xT({id:"execution-workflow",inputSchema:rb.z.object({}),outputSchema:rb.z.union([rb.z.instanceof(IS),rb.z.instanceof(Iy)]),steps:[y,v,b],options:{tracingPolicy:{internal:1}}}).parallel([y,v]).map(w).then(b).commit()}({capabilities:{agentName:this.name,logger:this.logger,getMemory:this.getMemory.bind(this),getModel:this.getModel.bind(this),generateMessageId:this.#t?.generateId?.bind(this.#t)||(()=>(0,ri.randomUUID)()),_agentNetworkAppend:"_agentNetworkAppend"in this?!!this._agentNetworkAppend:void 0,saveStepMessages:this.saveStepMessages.bind(this),convertTools:this.convertTools.bind(this),getMemoryMessages:this.getMemoryMessages.bind(this),runInputProcessors:this.__runInputProcessors.bind(this),executeOnFinish:this.#eb.bind(this),outputProcessors:this.#eh,llm:l,getTelemetry:this.#t?.getTelemetry?.bind(this.#t)},options:{...a,methodType:e},threadFromArgs:n,resourceId:i,runId:u,runtimeContext:s,agentAISpan:p,methodType:e,format:t,instructions:d,memoryConfig:o,memory:m,saveQueueManager:g,returnScorerData:a.returnScorerData,requireToolApproval:a.requireToolApproval,resumeContext:r,agentId:this.id}),y=await f.createRunAsync();return await y.start({tracingContext:{currentSpan:p}})}async #eb({result:e,instructions:t,readOnlyMemory:r,thread:a,threadId:s,resourceId:n,memoryConfig:i,outputText:o,runtimeContext:l,agentAISpan:u,runId:d,messageList:p,threadExists:c,structuredOutput:h=!1,saveQueueManager:m,overrideScorers:g}){let f={text:e.text,object:e.object,toolResults:e.toolResults,toolCalls:e.toolCalls,usage:e.usage,steps:e.steps.map(e=>({stepType:e.stepType,text:e.text,toolResults:e.toolResults,toolCalls:e.toolCalls,usage:e.usage}))};this.logger.debug(`[Agent:${this.name}] - Post processing LLM response`,{runId:d,result:f,threadId:s,resourceId:n});let y=p.get.response.aiV4.core().some(e=>"tool"===e.role&&e.content.some(e=>"updateWorkingMemory"===e.toolName)),v=await this.getMemory({runtimeContext:l}),b=y?s?await v?.getThreadById({threadId:s}):void 0:a;if(v&&n&&b&&!r)try{let t=e.response.messages;!t&&e.object&&(t=[{id:e.response.id,role:"assistant",content:[{type:"text",text:o}]}]),t&&p.add(t,"response"),c||await v.createThread({threadId:b.id,metadata:b.metadata,title:b.title,memoryConfig:i,resourceId:b.resourceId});let r=[m.flushMessages(p,s,i)];if(b.title?.startsWith("New Thread")){let e=v.getMergedThreadConfig(i),t=this.getMostRecentUserMessage(p.get.all.ui()),{shouldGenerate:a,model:s,instructions:o}=this.resolveTitleGenerationConfig(e.threads?.generateTitle);a&&t&&r.push(this.genTitle(t,l,{currentSpan:u},s,o).then(e=>{if(e)return v.createThread({threadId:b.id,resourceId:n,memoryConfig:i,title:e,metadata:b.metadata})}))}await Promise.all(r)}catch(t){if(await m.flushMessages(p,s,i),t instanceof tv)throw t;let e=new tv({id:"AGENT_MEMORY_PERSIST_RESPONSE_MESSAGES_FAILED",domain:"AGENT",category:"SYSTEM",details:{agentName:this.name,runId:d||"",threadId:s||"",result:JSON.stringify(f)}},t);throw this.logger.trackException(e),this.logger.error(e.toString()),e}else{let t=e.response.messages;!t&&e.object&&(t=[{id:e.response.id,role:"assistant",content:[{type:"text",text:o}]}]),t&&p.add(t,"response")}await this.#ef({messageList:p,runId:d,outputText:o,instructions:t,runtimeContext:l,structuredOutput:h,overrideScorers:g,tracingContext:{currentSpan:u}}),u?.end({output:{text:e.text,object:e.object,files:e.files}})}async network(e,t){let r=t?.runId||this.#t?.generateId()||(0,ri.randomUUID)(),a=t?.runtimeContext||new t7;return await xJ({networkName:this.name,runtimeContext:a,runId:r,routingAgent:this,routingAgentOptions:{telemetry:t?.telemetry,modelSettings:t?.modelSettings},generateId:()=>this.#t?.generateId()||(0,ri.randomUUID)(),maxIterations:t?.maxSteps||1,messages:e,threadId:"string"==typeof t?.memory?.thread?t?.memory?.thread:t?.memory?.thread?.id,resourceId:t?.memory?.resource})}async generateVNext(e,t){throw new tv({id:"AGENT_GENERATE_VNEXT_DEPRECATED",domain:"AGENT",category:"USER",text:"generateVNext has been renamed to generate. Please use generate instead."})}async generate(e,t){let r=await this.stream(e,t),a=await r.getFullOutput(),s=a.error;if("error"===a.finishReason&&s)throw s;return a}async streamVNext(e,t){throw new tv({id:"AGENT_STREAM_VNEXT_DEPRECATED",domain:"AGENT",category:"USER",text:"streamVNext has been renamed to stream. Please use stream instead."})}async stream(e,t){let r=await this.getDefaultVNextStreamOptions({runtimeContext:t?.runtimeContext});if(r.structuredOutput&&r.output||t?.structuredOutput&&t.output)throw new tv({id:"AGENT_STREAM_STRUCTURED_OUTPUT_AND_OUTPUT_PROVIDED",domain:"AGENT",category:"USER",text:"structuredOutput and output cannot be provided at the same time"});let a={...r};if(t?.structuredOutput||t?.output){let{output:e,structuredOutput:t,...r}=a;a=r}let s={...a,...t??{},onFinish:this.#ey(t,r)},n=await this.getLLM({runtimeContext:s.runtimeContext});if("v2"!==n.getModel().specificationVersion){let e=n.getModel(),t=e.modelId||"unknown",r=e.provider||"unknown";throw new tv({id:"AGENT_STREAM_V1_MODEL_NOT_SUPPORTED",domain:"AGENT",category:"USER",text:`Agent "${this.name}" is using AI SDK v4 model (${r}:${t}) which is not compatible with stream(). Please use AI SDK v5 models or call the streamLegacy() method instead. See https://mastra.ai/en/docs/streaming/overview for more information.`,details:{agentName:this.name,modelId:t,provider:r,specificationVersion:e.specificationVersion}})}let i={...s,messages:e,methodType:"stream"},o=await this.#ev(i);if("success"!==o.status){if("failed"===o.status)throw new tv({id:"AGENT_STREAM_FAILED",domain:"AGENT",category:"USER",text:o.error.message,details:{error:o.error.message}});throw new tv({id:"AGENT_STREAM_UNKNOWN_ERROR",domain:"AGENT",category:"USER",text:"An unknown error occurred while streaming"})}return o.result}async resumeStreamVNext(e,t){let r=await this.getDefaultVNextStreamOptions({runtimeContext:t?.runtimeContext}),a={...r,...t,onFinish:this.#ey(t,r)};if("v2"!==(await this.getLLM({runtimeContext:a.runtimeContext})).getModel().specificationVersion)throw new tv({id:"AGENT_STREAM_VNEXT_V1_MODEL_NOT_SUPPORTED",domain:"AGENT",category:"USER",text:"V1 models are not supported for stream. Please use streamLegacy instead."});let s=await this.#ev({...a,messages:[],resumeContext:e,methodType:"stream"});if("success"!==s.status){if("failed"===s.status)throw new tv({id:"AGENT_STREAM_VNEXT_FAILED",domain:"AGENT",category:"USER",text:s.error.message,details:{error:s.error.message}});throw new tv({id:"AGENT_STREAM_VNEXT_UNKNOWN_ERROR",domain:"AGENT",category:"USER",text:"An unknown error occurred while streaming"})}return s.result}async approveToolCall(e){return this.resumeStreamVNext({approved:!0},e)}async declineToolCall(e){return this.resumeStreamVNext({approved:!1},e)}async generateLegacy(e,t={}){if("structuredOutput"in t&&t.structuredOutput)throw new tv({id:"AGENT_GENERATE_LEGACY_STRUCTURED_OUTPUT_NOT_SUPPORTED",domain:"AGENT",category:"USER",text:"This method does not support structured output. Please use generateVNext instead."});let r=await this.getDefaultGenerateOptions({runtimeContext:t.runtimeContext}),a={...r,...t,experimental_generateMessageId:r.experimental_generateMessageId||this.#t?.generateId?.bind(this.#t)},{llm:s,before:n,after:i}=await this.prepareLLMOptions(e,a,"generate");if("v1"!==s.getModel().specificationVersion)throw this.logger.error("V2 models are not supported for generateLegacy. Please use generate instead.",{modelId:s.getModel().modelId}),new tv({id:"AGENT_GENERATE_V2_MODEL_NOT_SUPPORTED",domain:"AGENT",category:"USER",details:{modelId:s.getModel().modelId},text:"V2 models are not supported for generateLegacy. Please use generate instead."});let o=await n(),l=lH(o.agentAISpan);if(o.tripwire)return{text:"",object:void 0,usage:{totalTokens:0,promptTokens:0,completionTokens:0},finishReason:"other",response:{id:(0,ri.randomUUID)(),timestamp:new Date,modelId:"tripwire",messages:[]},responseMessages:[],toolCalls:[],toolResults:[],warnings:void 0,request:{body:JSON.stringify({messages:[]})},experimental_output:void 0,steps:void 0,experimental_providerMetadata:void 0,tripwire:!0,tripwireReason:o.tripwireReason,traceId:l};let{experimental_output:u,output:d,agentAISpan:p,...c}=o,h={currentSpan:p},m=a.outputProcessors;if(!d||u){let e=await s.__text({...c,tracingContext:h,experimental_output:u}),r=await this.__runOutputProcessors({runtimeContext:a.runtimeContext||new t7,tracingContext:h,outputProcessorOverrides:m,messageList:new wP({threadId:c.threadId||"",resourceId:c.resourceId||""}).add({role:"assistant",content:[{type:"text",text:e.text}]},"response")});if(r.tripwireTriggered)return{text:"",object:void 0,usage:{totalTokens:0,promptTokens:0,completionTokens:0},finishReason:"other",response:{id:(0,ri.randomUUID)(),timestamp:new Date,modelId:"tripwire",messages:[]},responseMessages:[],toolCalls:[],toolResults:[],warnings:void 0,request:{body:JSON.stringify({messages:[]})},experimental_output:void 0,steps:void 0,experimental_providerMetadata:void 0,tripwire:!0,tripwireReason:r.tripwireReason,traceId:l};let n=r.messageList.get.response.v2().map(e=>e.content.parts.map(e=>"text"===e.type?e.text:"").join("")).join("");if(e.text=n,m&&m.length>0){let t=r.messageList.get.response.v2();this.logger.debug("Checking messages for experimentalOutput metadata:",t.map(e=>({role:e.role,hasContentMetadata:!!e.content.metadata,contentMetadata:e.content.metadata})));let a=t.filter(e=>e.content.metadata&&e.content.metadata.structuredOutput);if(this.logger.debug("Messages with structured data:",a.length),a[0]&&a[0].content.metadata?.structuredOutput)e.object=a[0].content.metadata.structuredOutput,this.logger.debug("Using structured data from processor metadata for result.object");else try{e.object=JSON.parse(n),this.logger.debug("Using fallback JSON parsing for result.object")}catch(e){this.logger.warn("Failed to parse processed output as JSON, updating text only",{error:e})}}let o=a.scorers,d=await i({result:e,outputText:n,agentAISpan:p,...o?{overrideScorers:o}:{}});return t.returnScorerData&&(e.scoringData=d.scoringData),e.traceId=l,e}let g=await s.__textObject({...c,tracingContext:h,structuredOutput:d}),f=JSON.stringify(g.object),y=await this.__runOutputProcessors({runtimeContext:a.runtimeContext||new t7,tracingContext:h,messageList:new wP({threadId:c.threadId||"",resourceId:c.resourceId||""}).add({role:"assistant",content:[{type:"text",text:f}]},"response")});if(y.tripwireTriggered)return{text:"",object:void 0,usage:{totalTokens:0,promptTokens:0,completionTokens:0},finishReason:"other",response:{id:(0,ri.randomUUID)(),timestamp:new Date,modelId:"tripwire",messages:[]},responseMessages:[],toolCalls:[],toolResults:[],warnings:void 0,request:{body:JSON.stringify({messages:[]})},experimental_output:void 0,steps:void 0,experimental_providerMetadata:void 0,tripwire:!0,tripwireReason:y.tripwireReason,traceId:l};let v=y.messageList.get.response.v2().map(e=>e.content.parts.map(e=>"text"===e.type?e.text:"").join("")).join("");try{g.object=JSON.parse(v)}catch(e){this.logger.warn("Failed to parse processed output as JSON, keeping original result",{error:e})}let b=await i({result:g,outputText:v,...t.scorers?{overrideScorers:t.scorers}:{},structuredOutput:!0,agentAISpan:p});return t.returnScorerData&&(g.scoringData=b.scoringData),g.traceId=l,g}async streamLegacy(e,t={}){let r=await this.getDefaultStreamOptions({runtimeContext:t.runtimeContext}),a={...r,...t,onFinish:this.#ey(t,r),experimental_generateMessageId:r.experimental_generateMessageId||this.#t?.generateId?.bind(this.#t)},{llm:s,before:n,after:i}=await this.prepareLLMOptions(e,a,"stream");if("v1"!==s.getModel().specificationVersion)throw this.logger.error("V2 models are not supported for streamLegacy. Please use stream instead.",{modelId:s.getModel().modelId}),new tv({id:"AGENT_STREAM_V2_MODEL_NOT_SUPPORTED",domain:"AGENT",category:"USER",details:{modelId:s.getModel().modelId},text:"V2 models are not supported for streamLegacy. Please use stream instead."});let o=await n(),l=lH(o.agentAISpan);if(o.tripwire)return{textStream:async function*(){}(),fullStream:Promise.resolve("").then(()=>new globalThis.ReadableStream({start(e){e.close()}})),text:Promise.resolve(""),usage:Promise.resolve({totalTokens:0,promptTokens:0,completionTokens:0}),finishReason:Promise.resolve("other"),tripwire:!0,tripwireReason:o.tripwireReason,response:{id:(0,ri.randomUUID)(),timestamp:new Date,modelId:"tripwire",messages:[]},toolCalls:Promise.resolve([]),toolResults:Promise.resolve([]),warnings:Promise.resolve(void 0),request:{body:JSON.stringify({messages:[]})},experimental_output:void 0,steps:void 0,experimental_providerMetadata:void 0,traceId:l,toAIStream:()=>Promise.resolve("").then(()=>new globalThis.ReadableStream({start(e){e.close()}})),get experimental_partialOutputStream(){return async function*(){}()},pipeDataStreamToResponse:()=>Promise.resolve(),pipeTextStreamToResponse:()=>Promise.resolve(),toDataStreamResponse:()=>new Response("",{status:200,headers:{"Content-Type":"text/plain"}}),toTextStreamResponse:()=>new Response("",{status:200,headers:{"Content-Type":"text/plain"}})};let{onFinish:u,runId:d,output:p,experimental_output:c,agentAISpan:h,...m}=o,g=a.scorers,f={currentSpan:h};if(!p||c){this.logger.debug(`Starting agent ${this.name} llm stream call`,{runId:d});let e=s.__stream({...m,experimental_output:c,tracingContext:f,outputProcessors:await this.getResolvedOutputProcessors(a.runtimeContext),onFinish:async e=>{try{let t=e.text;await i({result:e,outputText:t,agentAISpan:h,...g?{overrideScorers:g}:{}})}catch(e){this.logger.error("Error saving memory on finish",{error:e,runId:d})}await u?.({...e,runId:d})},runId:d});return e.traceId=l,e}this.logger.debug(`Starting agent ${this.name} llm streamObject call`,{runId:d});let y=s.__streamObject({...m,tracingContext:f,onFinish:async e=>{try{let t=JSON.stringify(e.object);await i({result:e,outputText:t,structuredOutput:!0,agentAISpan:h,...g?{overrideScorers:g}:{}})}catch(e){this.logger.error("Error saving memory on finish",{error:e,runId:d})}await u?.({...e,runId:d})},runId:d,structuredOutput:p});return y.traceId=l,y}async speak(e,t){if(!this.voice){let e=new tv({id:"AGENT_SPEAK_METHOD_VOICE_NOT_CONFIGURED",domain:"AGENT",category:"USER",details:{agentName:this.name},text:"No voice provider configured"});throw this.logger.trackException(e),this.logger.error(e.toString()),e}this.logger.warn("Warning: agent.speak() is deprecated. Please use agent.voice.speak() instead.");try{return this.voice.speak(e,t)}catch(t){let e;throw e=t instanceof tv?t:new tv({id:"AGENT_SPEAK_METHOD_ERROR",domain:"AGENT",category:"UNKNOWN",details:{agentName:this.name},text:"Error during agent speak"},t),this.logger.trackException(e),this.logger.error(e.toString()),e}}async listen(e,t){if(!this.voice){let e=new tv({id:"AGENT_LISTEN_METHOD_VOICE_NOT_CONFIGURED",domain:"AGENT",category:"USER",details:{agentName:this.name},text:"No voice provider configured"});throw this.logger.trackException(e),this.logger.error(e.toString()),e}this.logger.warn("Warning: agent.listen() is deprecated. Please use agent.voice.listen() instead");try{return this.voice.listen(e,t)}catch(t){let e;throw e=t instanceof tv?t:new tv({id:"AGENT_LISTEN_METHOD_ERROR",domain:"AGENT",category:"UNKNOWN",details:{agentName:this.name},text:"Error during agent listen"},t),this.logger.trackException(e),this.logger.error(e.toString()),e}}async getSpeakers(){if(!this.voice){let e=new tv({id:"AGENT_SPEAKERS_METHOD_VOICE_NOT_CONFIGURED",domain:"AGENT",category:"USER",details:{agentName:this.name},text:"No voice provider configured"});throw this.logger.trackException(e),this.logger.error(e.toString()),e}this.logger.warn("Warning: agent.getSpeakers() is deprecated. Please use agent.voice.getSpeakers() instead.");try{return await this.voice.getSpeakers()}catch(t){let e;throw e=t instanceof tv?t:new tv({id:"AGENT_GET_SPEAKERS_METHOD_ERROR",domain:"AGENT",category:"UNKNOWN",details:{agentName:this.name},text:"Error during agent getSpeakers"},t),this.logger.trackException(e),this.logger.error(e.toString()),e}}toStep(){return new xQ(x7(this))}resolveTitleGenerationConfig(e){return"boolean"==typeof e?{shouldGenerate:e}:"object"==typeof e&&null!==e?{shouldGenerate:!0,model:e.model,instructions:e.instructions}:{shouldGenerate:!1}}async resolveTitleInstructions(e,t){let r=`
      - you will generate a short title based on the first message a user begins a conversation with
      - ensure it is not more than 80 characters long
      - the title should be a summary of the user's message
      - do not use quotes or colons
      - the entire text you return will be used as the title`;return t?"string"==typeof t?t:Im(t({runtimeContext:e,mastra:this.#t}),e=>e||r):r}};If=tX(e1=tK(e2),0,"Agent",e0,If),tQ(e1,1,If);var Iy=class{#ew;#r;#e_;traceId;constructor({modelOutput:e,options:t,messageList:r}){this.#ew=e,this.#r=t,this.#e_=r,this.traceId=lH(t.tracingContext?.currentSpan)}toTextStreamResponse(e){return function({status:e,statusText:t,headers:r,textStream:a}){return new Response(a.pipeThrough(new TextEncoderStream),{status:null!=e?e:200,statusText:t,headers:bZ(r,{"content-type":"text/plain; charset=utf-8"})})}({textStream:this.#ew.textStream,...e})}toUIMessageStreamResponse({generateMessageId:e,originalMessages:t,sendFinish:r,sendReasoning:a,sendSources:s,onError:n,sendStart:i,messageMetadata:o,onFinish:l,...u}={}){return function({status:e,statusText:t,headers:r,stream:a,consumeSseStream:s}){let n=a.pipeThrough(new bW);if(s){let[e,t]=n.tee();n=e,s({stream:t})}return new Response(n.pipeThrough(new TextEncoderStream),{status:e,statusText:t,headers:bZ(r,bG)})}({stream:this.toUIMessageStream({generateMessageId:e,originalMessages:t,sendFinish:r,sendReasoning:a,sendSources:s,onError:n,sendStart:i,messageMetadata:o,onFinish:l}),...u})}toUIMessageStream({generateMessageId:e,originalMessages:t,sendFinish:r=!0,sendReasoning:a=!0,sendSources:s=!1,onError:n=wW,sendStart:i=!0,messageMetadata:o,onFinish:l}={}){let u=null!=e?function({originalMessages:e,responseMessageId:t}){if(null==e)return;let r=e[e.length-1];return r?.role==="assistant"?r.id:"function"==typeof t?t():t}({originalMessages:t,responseMessageId:e}):void 0;return function({execute:e,onError:t=function(e){return null==e?"unknown error":"string"==typeof e?e:e instanceof Error?e.message:JSON.stringify(e)},originalMessages:r,onFinish:a,generateId:s=hi}){let n,i=[],o=new ReadableStream({start(e){n=e}});function l(e){try{n.enqueue(e)}catch(e){}}try{let r=e({writer:{write(e){l(e)},merge(e){i.push((async()=>{let t=e.getReader();for(;;){let{done:e,value:r}=await t.read();if(e)break;l(r)}})().catch(e=>{l({type:"error",errorText:t(e)})}))},onError:t}});r&&i.push(r.catch(e=>{l({type:"error",errorText:t(e)})}))}catch(e){l({type:"error",errorText:t(e)})}return new Promise(async e=>{for(;i.length>0;)await i.shift();e()}).finally(()=>{try{n.close()}catch(e){}}),function({messageId:e,originalMessages:t=[],onFinish:r,onError:a,stream:s}){let n=null==t?void 0:t[t.length-1];(null==n?void 0:n.role)!=="assistant"?n=void 0:e=n.id;let i=!1,o=s.pipeThrough(new TransformStream({transform(t,r){"start"===t.type&&null==t.messageId&&null!=e&&(t.messageId=e),"abort"===t.type&&(i=!0),r.enqueue(t)}}));if(null==r)return o;let l=function({lastMessage:e,messageId:t}){return{message:(null==e?void 0:e.role)==="assistant"?e:{id:t,metadata:void 0,role:"assistant",parts:[]},activeTextParts:{},activeReasoningParts:{},partialToolCalls:{}}}({lastMessage:n?structuredClone(n):void 0,messageId:null!=e?e:""}),u=!1,d=async()=>{if(u||!r)return;u=!0;let e=l.message.id===(null==n?void 0:n.id);await r({isAborted:i,isContinuation:e,responseMessage:l.message,messages:[...e?t.slice(0,-1):t,l.message]})};return(function({stream:e,messageMetadataSchema:t,dataPartSchemas:r,runUpdateMessageJob:a,onError:s,onToolCall:n,onData:i}){return e.pipeThrough(new TransformStream({async transform(e,o){await a(async({state:a,write:l})=>{var u,d,p,c;function h(e){let t=a.message.parts.filter(bK).find(t=>t.toolCallId===e);if(null==t)throw Error("tool-output-error must be preceded by a tool-input-available");return t}function m(e){let t=a.message.parts.filter(e=>"dynamic-tool"===e.type).find(t=>t.toolCallId===e);if(null==t)throw Error("tool-output-error must be preceded by a tool-input-available");return t}function g(e){var t;let r=a.message.parts.find(t=>bK(t)&&t.toolCallId===e.toolCallId);null!=r?(r.state=e.state,r.input=e.input,r.output=e.output,r.errorText=e.errorText,r.rawInput=e.rawInput,r.preliminary=e.preliminary,r.providerExecuted=null!=(t=e.providerExecuted)?t:r.providerExecuted,null!=e.providerMetadata&&"input-available"===r.state&&(r.callProviderMetadata=e.providerMetadata)):a.message.parts.push({type:`tool-${e.toolName}`,toolCallId:e.toolCallId,state:e.state,input:e.input,output:e.output,rawInput:e.rawInput,errorText:e.errorText,providerExecuted:e.providerExecuted,preliminary:e.preliminary,...null!=e.providerMetadata?{callProviderMetadata:e.providerMetadata}:{}})}function f(e){var t;let r=a.message.parts.find(t=>"dynamic-tool"===t.type&&t.toolCallId===e.toolCallId);null!=r?(r.state=e.state,r.toolName=e.toolName,r.input=e.input,r.output=e.output,r.errorText=e.errorText,r.rawInput=null!=(t=e.rawInput)?t:r.rawInput,r.preliminary=e.preliminary,null!=e.providerMetadata&&"input-available"===r.state&&(r.callProviderMetadata=e.providerMetadata)):a.message.parts.push({type:"dynamic-tool",toolName:e.toolName,toolCallId:e.toolCallId,state:e.state,input:e.input,output:e.output,errorText:e.errorText,preliminary:e.preliminary,...null!=e.providerMetadata?{callProviderMetadata:e.providerMetadata}:{}})}async function y(e){if(null!=e){let r=null!=a.message.metadata?function e(t,r){if(void 0===t&&void 0===r)return;if(void 0===t)return r;if(void 0===r)return t;let a={...t};for(let s in r)if(Object.prototype.hasOwnProperty.call(r,s)){let n=r[s];if(void 0===n)continue;let i=s in t?t[s]:void 0,o=null!==n&&"object"==typeof n&&!Array.isArray(n)&&!(n instanceof Date)&&!(n instanceof RegExp),l=null!=i&&"object"==typeof i&&!Array.isArray(i)&&!(i instanceof Date)&&!(i instanceof RegExp);o&&l?a[s]=e(i,n):a[s]=n}return a}(a.message.metadata,e):e;null!=t&&await hb({value:r,schema:t}),a.message.metadata=r}}switch(e.type){case"text-start":{let t={type:"text",text:"",providerMetadata:e.providerMetadata,state:"streaming"};a.activeTextParts[e.id]=t,a.message.parts.push(t),l();break}case"text-delta":{let t=a.activeTextParts[e.id];t.text+=e.delta,t.providerMetadata=null!=(u=e.providerMetadata)?u:t.providerMetadata,l();break}case"text-end":{let t=a.activeTextParts[e.id];t.state="done",t.providerMetadata=null!=(d=e.providerMetadata)?d:t.providerMetadata,delete a.activeTextParts[e.id],l();break}case"reasoning-start":{let t={type:"reasoning",text:"",providerMetadata:e.providerMetadata,state:"streaming"};a.activeReasoningParts[e.id]=t,a.message.parts.push(t),l();break}case"reasoning-delta":{let t=a.activeReasoningParts[e.id];t.text+=e.delta,t.providerMetadata=null!=(p=e.providerMetadata)?p:t.providerMetadata,l();break}case"reasoning-end":{let t=a.activeReasoningParts[e.id];t.providerMetadata=null!=(c=e.providerMetadata)?c:t.providerMetadata,t.state="done",delete a.activeReasoningParts[e.id],l();break}case"file":a.message.parts.push({type:"file",mediaType:e.mediaType,url:e.url}),l();break;case"source-url":a.message.parts.push({type:"source-url",sourceId:e.sourceId,url:e.url,title:e.title,providerMetadata:e.providerMetadata}),l();break;case"source-document":a.message.parts.push({type:"source-document",sourceId:e.sourceId,mediaType:e.mediaType,title:e.title,filename:e.filename,providerMetadata:e.providerMetadata}),l();break;case"tool-input-start":{let t=a.message.parts.filter(bK);a.partialToolCalls[e.toolCallId]={text:"",toolName:e.toolName,index:t.length,dynamic:e.dynamic},e.dynamic?f({toolCallId:e.toolCallId,toolName:e.toolName,state:"input-streaming",input:void 0}):g({toolCallId:e.toolCallId,toolName:e.toolName,state:"input-streaming",input:void 0,providerExecuted:e.providerExecuted}),l();break}case"tool-input-delta":{let t=a.partialToolCalls[e.toolCallId];t.text+=e.inputTextDelta;let{value:r}=await bB(t.text);t.dynamic?f({toolCallId:e.toolCallId,toolName:t.toolName,state:"input-streaming",input:r}):g({toolCallId:e.toolCallId,toolName:t.toolName,state:"input-streaming",input:r}),l();break}case"tool-input-available":e.dynamic?f({toolCallId:e.toolCallId,toolName:e.toolName,state:"input-available",input:e.input,providerMetadata:e.providerMetadata}):g({toolCallId:e.toolCallId,toolName:e.toolName,state:"input-available",input:e.input,providerExecuted:e.providerExecuted,providerMetadata:e.providerMetadata}),l(),n&&!e.providerExecuted&&await n({toolCall:e});break;case"tool-input-error":e.dynamic?f({toolCallId:e.toolCallId,toolName:e.toolName,state:"output-error",input:e.input,errorText:e.errorText,providerMetadata:e.providerMetadata}):g({toolCallId:e.toolCallId,toolName:e.toolName,state:"output-error",input:void 0,rawInput:e.input,errorText:e.errorText,providerExecuted:e.providerExecuted,providerMetadata:e.providerMetadata}),l();break;case"tool-output-available":if(e.dynamic){let t=m(e.toolCallId);f({toolCallId:e.toolCallId,toolName:t.toolName,state:"output-available",input:t.input,output:e.output,preliminary:e.preliminary})}else{let t=h(e.toolCallId);g({toolCallId:e.toolCallId,toolName:bJ(t),state:"output-available",input:t.input,output:e.output,providerExecuted:e.providerExecuted,preliminary:e.preliminary})}l();break;case"tool-output-error":if(e.dynamic){let t=m(e.toolCallId);f({toolCallId:e.toolCallId,toolName:t.toolName,state:"output-error",input:t.input,errorText:e.errorText})}else{let t=h(e.toolCallId);g({toolCallId:e.toolCallId,toolName:bJ(t),state:"output-error",input:t.input,rawInput:t.rawInput,errorText:e.errorText})}l();break;case"start-step":a.message.parts.push({type:"step-start"});break;case"finish-step":a.activeTextParts={},a.activeReasoningParts={};break;case"start":null!=e.messageId&&(a.message.id=e.messageId),await y(e.messageMetadata),(null!=e.messageId||null!=e.messageMetadata)&&l();break;case"finish":case"message-metadata":await y(e.messageMetadata),null!=e.messageMetadata&&l();break;case"error":null==s||s(Error(e.errorText));break;default:if(e.type.startsWith("data-")){if((null==r?void 0:r[e.type])!=null&&await hb({value:e.data,schema:r[e.type]}),e.transient){null==i||i(e);break}let t=null!=e.id?a.message.parts.find(t=>e.type===t.type&&e.id===t.id):void 0;null!=t?t.data=e.data:a.message.parts.push(e),null==i||i(e),l()}}o.enqueue(e)})}}))})({stream:o,runUpdateMessageJob:async e=>{await e({state:l,write:()=>{}})},onError:a}).pipeThrough(new TransformStream({transform(e,t){t.enqueue(e)},async cancel(){await d()},async flush(){await d()}}))}({stream:o,messageId:s(),originalMessages:r,onFinish:a,onError:t})}({onError:n,onFinish:l,generateId:()=>u??e?.()??hi(),execute:async({writer:e})=>{for await(let t of this.fullStream){let l=o?.({part:t}),d=t.type,p=function({part:e,messageMetadataValue:t,sendReasoning:r,sendSources:a,onError:s,sendStart:n,sendFinish:i,responseMessageId:o}){let l=e.type;switch(l){case"text-start":return{type:"text-start",id:e.id,...null!=e.providerMetadata?{providerMetadata:e.providerMetadata}:{}};case"text-delta":return{type:"text-delta",id:e.id,delta:e.text,...null!=e.providerMetadata?{providerMetadata:e.providerMetadata}:{}};case"text-end":return{type:"text-end",id:e.id,...null!=e.providerMetadata?{providerMetadata:e.providerMetadata}:{}};case"reasoning-start":return{type:"reasoning-start",id:e.id,...null!=e.providerMetadata?{providerMetadata:e.providerMetadata}:{}};case"reasoning-delta":if(r)return{type:"reasoning-delta",id:e.id,delta:e.text,...null!=e.providerMetadata?{providerMetadata:e.providerMetadata}:{}};return;case"reasoning-end":return{type:"reasoning-end",id:e.id,...null!=e.providerMetadata?{providerMetadata:e.providerMetadata}:{}};case"file":return{type:"file",mediaType:e.file.mediaType,url:`data:${e.file.mediaType};base64,${e.file.base64}`};case"source":if(a&&"url"===e.sourceType)return{type:"source-url",sourceId:e.id,url:e.url,title:e.title,...null!=e.providerMetadata?{providerMetadata:e.providerMetadata}:{}};if(a&&"document"===e.sourceType)return{type:"source-document",sourceId:e.id,mediaType:e.mediaType,title:e.title,filename:e.filename,...null!=e.providerMetadata?{providerMetadata:e.providerMetadata}:{}};return;case"tool-input-start":return{type:"tool-input-start",toolCallId:e.id,toolName:e.toolName,...null!=e.providerExecuted?{providerExecuted:e.providerExecuted}:{},...null!=e.dynamic?{dynamic:e.dynamic}:{}};case"tool-input-delta":return{type:"tool-input-delta",toolCallId:e.id,inputTextDelta:e.delta};case"tool-call":return{type:"tool-input-available",toolCallId:e.toolCallId,toolName:e.toolName,input:e.input,...null!=e.providerExecuted?{providerExecuted:e.providerExecuted}:{},...null!=e.providerMetadata?{providerMetadata:e.providerMetadata}:{},...null!=e.dynamic?{dynamic:e.dynamic}:{}};case"tool-result":return{type:"tool-output-available",toolCallId:e.toolCallId,output:e.output,...null!=e.providerExecuted?{providerExecuted:e.providerExecuted}:{},...null!=e.dynamic?{dynamic:e.dynamic}:{}};case"tool-output":return{...e.output};case"tool-error":return{type:"tool-output-error",toolCallId:e.toolCallId,errorText:s(e.error),...null!=e.providerExecuted?{providerExecuted:e.providerExecuted}:{},...null!=e.dynamic?{dynamic:e.dynamic}:{}};case"error":return{type:"error",errorText:s(e.error)};case"start-step":return{type:"start-step"};case"finish-step":return{type:"finish-step"};case"start":if(n)return{type:"start",...null!=t?{messageMetadata:t}:{},...null!=o?{messageId:o}:{}};return;case"finish":if(i)return{type:"finish",...null!=t?{messageMetadata:t}:{}};return;case"abort":return e;case"tool-input-end":case"raw":return;default:throw Error(`Unknown chunk type: ${l}`)}}({part:t,sendReasoning:a,messageMetadataValue:l,sendSources:s,sendStart:i,sendFinish:r,responseMessageId:u=this.#ew.messageId,onError:n});p&&e.write(p),null!=l&&"start"!==d&&"finish"!==d&&e.write({type:"message-metadata",messageMetadata:l})}}})}async consumeStream(e){await this.#ew.consumeStream(e)}get sources(){return this.#ew.sources.then(e=>e.map(e=>x$({chunk:e})))}get files(){return this.#ew.files.then(e=>e.map(e=>{if("file"===e.type){let t=x$({chunk:e});return t&&"file"in t?t.file:void 0}}).filter(Boolean))}get text(){return this.#ew.text}get objectStream(){return this.#ew.objectStream}get toolCalls(){return this.#ew.toolCalls.then(e=>e.map(e=>x$({chunk:e})))}get toolResults(){return this.#ew.toolResults.then(e=>e.map(e=>x$({chunk:e})))}get reasoningText(){return this.#ew.reasoningText}get reasoning(){return this.#ew.reasoning.then(e=>e.map(e=>({providerMetadata:e.payload.providerMetadata,text:e.payload.text,type:"reasoning"})))}get warnings(){return this.#ew.warnings}get usage(){return this.#ew.usage}get finishReason(){return this.#ew.finishReason}get providerMetadata(){return this.#ew.providerMetadata}get request(){return this.#ew.request}get totalUsage(){return this.#ew.totalUsage}get response(){return this.#ew.response.then(e=>({...e}))}get steps(){return this.#ew.steps.then(e=>e)}get content(){return this.#e_.get.response.aiV5.modelContent()}get textStream(){return this.#ew.textStream}get elementStream(){return this.#ew.elementStream}get fullStream(){let e,t=!1;return this.#ew.fullStream.pipeThrough(new wz.TransformStream({transform(r,a){if("object"===r.type)return void a.enqueue(r);if("step-start"!==r.type||e)"error"!==r.type&&(t=!0);else{e=x$({chunk:r});return}if(e&&t&&(a.enqueue(e),e=void 0),"payload"in r){let e=x$({chunk:r});e&&a.enqueue(e)}}}))}async getFullOutput(){await this.consumeStream({onError:e=>{throw console.error(e),e}});let e=await this.object,t={text:await this.#ew.text,usage:await this.#ew.usage,steps:await this.steps,finishReason:await this.#ew.finishReason,warnings:await this.#ew.warnings,providerMetadata:await this.#ew.providerMetadata,request:await this.#ew.request,reasoning:await this.reasoning,reasoningText:await this.reasoningText,toolCalls:await this.toolCalls,toolResults:await this.toolResults,sources:await this.sources,files:await this.files,response:await this.response,content:this.content,totalUsage:await this.#ew.totalUsage,error:this.error,tripwire:this.#ew.tripwire,tripwireReason:this.#ew.tripwireReason,traceId:this.traceId,...e?{object:e}:{}};return t.response.messages=this.#ew.messageList.get.response.aiV5.model(),t}get tripwire(){return this.#ew.tripwire}get tripwireReason(){return this.#ew.tripwireReason}get error(){return this.#ew.error}get object(){return this.#ew.object}},Iv=class{schema;validatePartialChunks=!1;partialSchema;constructor(e,t={}){e?!e||"object"!=typeof e||e.safeParse||e.jsonSchema?this.schema=h7(e):this.schema=h8(e):this.schema=void 0,t.validatePartialChunks&&void 0!==e&&"partial"in e&&"function"==typeof e.partial&&(this.validatePartialChunks=!0,this.partialSchema=e.partial())}preprocessText(e){let t=e;if(t.includes("```json")){let e=t.match(/```json\s*\n?([\s\S]*?)\n?\s*```/);t=e&&e[1]?e[1].trim():t.replace(/^```json\s*\n?/,"")}return t}},Ib=class extends Iv{type="object";async processPartialChunk({accumulatedText:e,previousObject:t}){let r=this.preprocessText(e),{value:a,state:s}=await bB(r);if(this.validatePartialChunks&&this.partialSchema){let e=this.partialSchema?.safeParse(a);return e.success&&e.data&&void 0!==e.data&&!bY(t,e.data)?{shouldEmit:!0,emitValue:e.data,newPreviousResult:e.data}:{shouldEmit:!1}}return null==a||"object"!=typeof a||bY(t,a)?{shouldEmit:!1}:{shouldEmit:["successful-parse","repaired-parse"].includes(s),emitValue:a,newPreviousResult:a}}async validateAndTransformFinal(e){if(!e)return{success:!1,error:Error("No object generated: could not parse the response.")};let t=this.preprocessText(e),{value:r}=await bB(t);if(!this.schema)return{success:!0,value:r};try{let e=await xg({value:r,schema:this.schema});if(e.success)return{success:!0,value:e.value};return{success:!1,error:e.error??Error("Validation failed",{cause:e.error})}}catch(e){return{success:!1,error:e instanceof Error?e:Error("Validation failed",{cause:e})}}}},Iw=class extends Iv{type="array";textPreviousFilteredArray=[];hasEmittedInitialArray=!1;async processPartialChunk({accumulatedText:e,previousObject:t}){let r=this.preprocessText(e),{value:a,state:s}=await bB(r);if(void 0!==a&&!bY(t,a)){let e=a?.elements||[],t=[];for(let r=0;r<e.length;r++){let a=e[r];e.length,a&&"object"==typeof a&&Object.keys(a).length>0&&t.push(a)}if(!this.hasEmittedInitialArray&&(this.hasEmittedInitialArray=!0,0===t.length))return this.textPreviousFilteredArray=[],{shouldEmit:!0,emitValue:[],newPreviousResult:a};if(!bY(this.textPreviousFilteredArray,t))return this.textPreviousFilteredArray=[...t],{shouldEmit:!0,emitValue:t,newPreviousResult:a}}return{shouldEmit:!1}}async validateAndTransformFinal(e){let t=this.textPreviousFilteredArray;if(!t)return{success:!1,error:Error("No object generated: could not parse the response.")};if(!this.schema)return{success:!0,value:t};try{let e=await xg({value:t,schema:this.schema});if(e.success)return{success:!0,value:e.value};return{success:!1,error:e.error??Error("Validation failed",{cause:e.error})}}catch(e){return{success:!1,error:e instanceof Error?e:Error("Validation failed",{cause:e})}}}},I_=class extends Iv{type="enum";textPreviousEnumResult;findBestEnumMatch(e){if(!this.schema?.jsonSchema?.enum)return;let t=this.schema.jsonSchema.enum.filter(e=>"string"==typeof e).filter(t=>t.startsWith(e));if(0===t.length)return;let r=t[0];return 1===t.length&&void 0!==r?r:e}async processPartialChunk({accumulatedText:e,previousObject:t}){let r=this.preprocessText(e),{value:a}=await bB(r);if(null!=a&&"object"==typeof a&&!Array.isArray(a)&&"result"in a&&"string"==typeof a.result&&!bY(t,a)){let e=a.result,t=this.findBestEnumMatch(e);if(e.length>0&&t&&t!==this.textPreviousEnumResult)return this.textPreviousEnumResult=t,{shouldEmit:!0,emitValue:t,newPreviousResult:a}}return{shouldEmit:!1}}async validateAndTransformFinal(e){let t=this.preprocessText(e),{value:r}=await bB(t);if(!("object"==typeof r&&null!==r&&"result"in r)||!r||"object"!=typeof r||"string"!=typeof r.result)return{success:!1,error:Error("Invalid enum format: expected object with result property")};if(!this.schema)return{success:!0,value:r.result};try{let e=await xg({value:r.result,schema:this.schema});if(e.success)return{success:!0,value:e.value};return{success:!1,error:e.error??Error("Enum validation failed")}}catch(e){return{success:!1,error:e instanceof Error?e:Error("Validation failed")}}}},IS=class extends tD{#eS="running";#ex;#eI;#ek;#eT=[];#eE=!1;#eA=new wU.EventEmitter;#eO=[];#eC={};#eR={text:"",reasoning:[],sources:[],files:[],toolCalls:[],toolResults:[],dynamicToolCalls:[],dynamicToolResults:[],staticToolCalls:[],staticToolResults:[],content:[],usage:{inputTokens:void 0,outputTokens:void 0,totalTokens:void 0},warnings:[],request:{},response:{id:"",timestamp:new Date,modelId:"",messages:[],uiMessages:[]},reasoningText:"",providerMetadata:void 0,finishReason:void 0};#eM=[];#eN;#ej={};#eP=[];#e$=[];#eD=[];#eL={};#eU={};#ez=[];#eq=[];#eV=[];#eF=void 0;#eZ={};#a={inputTokens:void 0,outputTokens:void 0,totalTokens:void 0};#eW=!1;#eG="";#eB={suspendPayload:new xf,object:new xf,finishReason:new xf,usage:new xf,warnings:new xf,providerMetadata:new xf,response:new xf,request:new xf,text:new xf,reasoning:new xf,reasoningText:new xf,sources:new xf,files:new xf,toolCalls:new xf,toolResults:new xf,steps:new xf,totalUsage:new xf,content:new xf};#eK=!1;#eJ=!1;#e;runId;#r;processorRunner;messageList;traceId;messageId;constructor({model:e,stream:t,messageList:r,options:a,messageId:s}){super({component:"LLM",name:"MastraModelOutput"}),this.#r=a,this.#eJ=!!a.returnScorerData,this.runId=a.runId,this.traceId=lH(a.tracingContext?.currentSpan),this.#e=e,this.messageId=s,a.outputProcessors?.length&&(this.processorRunner=new xY({inputProcessors:[],outputProcessors:a.outputProcessors,logger:this.logger,agentName:"MastraModelOutput"})),this.messageList=r;const n=this;let i=t;const o=this.processorRunner;if(o&&a.isLLMExecutionStep){const e=a.processorStates||new Map;i=t.pipeThrough(new wz.TransformStream({async transform(t,r){if("finish"===t.type&&t.payload?.stepResult?.reason==="tool-calls")return void r.enqueue(t);{if(e.has(Ii)){let t=e.get(Ii);t&&(t.customState.controller=r)}else{let t=new xH(Ii);t.customState={controller:r},e.set(Ii,t)}let{part:a,blocked:s,reason:n}=await o.processPart(t,e);if(s)return void r.enqueue({type:"tripwire",payload:{tripwireReason:n||"Output processor blocked content"}});a&&r.enqueue(a)}}}))}i=i.pipeThrough(function({isLLMExecutionStep:e,schema:t}){let r,a,s,n=function({schema:e,transformedSchema:t}){switch(t?.outputFormat){case"array":return new Iw(e);case"enum":return new I_(e);default:return new Ib(e)}}({transformedSchema:xj(t),schema:t}),i="";return new wz.TransformStream({async transform(o,l){if(!e||!t)return void l.enqueue(o);if(o.runId&&(a=o.runId),"finish"===o.type){r=o.payload.stepResult.reason,l.enqueue(o);return}if("text-delta"===o.type&&"string"==typeof o.payload?.text){i+=o.payload.text;let e=await n.processPartialChunk({accumulatedText:i,previousObject:s});if(e.shouldEmit){s=e.newPreviousResult??s;let t={from:o.from,runId:o.runId,type:"object",object:e.emitValue};l.enqueue(t)}}l.enqueue(o)},async flush(s){if(!e||!t||["tool-calls"].includes(r??""))return;let o=await n.validateAndTransformFinal(i);o.success?s.enqueue({from:"AGENT",runId:a??"",type:"object-result",object:o.value}):s.enqueue({from:"AGENT",runId:a??"",type:"error",payload:{error:new tv({domain:"AGENT",category:"SYSTEM",id:"OUTPUT_SCHEMA_VALIDATION_FAILED",text:o.error.message},{cause:o.error})}})}})}({isLLMExecutionStep:n.#r.isLLMExecutionStep,schema:n.#r.output})),this.#ek=i.pipeThrough(new wz.TransformStream({transform:async(e,t)=>{switch(e.type){case"tool-call-suspended":case"tool-call-approval":n.#eS="suspended",n.#eB.suspendPayload.resolve(e.payload);break;case"raw":if(!n.#r.includeRawChunks)return;break;case"object-result":n.#eN=e.object,"pending"===n.#eB.object.status.type&&n.#eB.object.resolve(e.object);break;case"source":n.#eP.push(e),n.#eR.sources.push(e);break;case"text-delta":if(n.#eM.push(e.payload.text),n.#eR.text+=e.payload.text,e.payload.id){let t=n.#ej[e.payload.id]??[];t.push(e.payload.text),n.#ej[e.payload.id]=t}break;case"tool-call-input-streaming-start":n.#eU[e.payload.toolCallId]=e.payload.toolName;break;case"tool-call-delta":n.#eL[e.payload.toolCallId]||(n.#eL[e.payload.toolCallId]=[]),n.#eL?.[e.payload.toolCallId]?.push(e.payload.argsTextDelta),e.payload.toolName||=n.#eU[e.payload.toolCallId];break;case"file":n.#eD.push(e),n.#eR.files.push(e);break;case"reasoning-start":n.#eC[e.payload.id]={type:"reasoning",runId:e.runId,from:e.from,payload:{id:e.payload.id,providerMetadata:e.payload.providerMetadata,text:""}};break;case"reasoning-delta":{n.#e$.push({type:"reasoning",runId:e.runId,from:e.from,payload:e.payload}),n.#eR.reasoning.push({type:"reasoning",runId:e.runId,from:e.from,payload:e.payload});let t=n.#eC[e.payload.id];t&&(t.payload.text+=e.payload.text,e.payload.providerMetadata&&(t.payload.providerMetadata=e.payload.providerMetadata));break}case"reasoning-end":{let t=n.#eC[e.payload.id];e.payload.providerMetadata&&t&&(t.payload.providerMetadata=e.payload.providerMetadata);break}case"tool-call":n.#ez.push(e),n.#eR.toolCalls.push(e);let s=e.payload;if(s?.output?.from==="AGENT"&&s?.output?.type==="finish"){let e=s.output.payload;e?.usage&&n.updateUsageCount(e.usage)}break;case"tool-result":n.#eq.push(e),n.#eR.toolResults.push(e);break;case"step-finish":{n.updateUsageCount(e.payload.output.usage),n.#eV=e.payload.stepResult.warnings||[],e.payload.metadata.request&&(n.#eZ=e.payload.metadata.request);let{providerMetadata:t,request:s,...i}=e.payload.metadata,o={stepType:0===n.#eO.length?"initial":"tool-result",sources:n.#eR.sources,files:n.#eR.files,toolCalls:n.#eR.toolCalls,toolResults:n.#eR.toolResults,content:r.get.response.aiV5.modelContent(-1),text:n.#eR.text,reasoningText:n.#e$.map(e=>e.payload.text).join(""),reasoning:n.#eR.reasoning,get staticToolCalls(){return n.#eR.toolCalls.filter(e=>"tool-call"===e.type&&e.payload?.dynamic===!1)},get dynamicToolCalls(){return n.#eR.toolCalls.filter(e=>"tool-call"===e.type&&e.payload?.dynamic===!0)},get staticToolResults(){return n.#eR.toolResults.filter(e=>"tool-result"===e.type&&e.payload?.dynamic===!1)},get dynamicToolResults(){return n.#eR.toolResults.filter(e=>"tool-result"===e.type&&e.payload?.dynamic===!0)},finishReason:e.payload.stepResult.reason,usage:e.payload.output.usage,warnings:n.#eV,request:s||{},response:{id:e.payload.id||"",timestamp:e.payload.metadata?.timestamp||new Date,modelId:e.payload.metadata?.modelId||e.payload.metadata?.model||"",...i,messages:e.payload.messages?.nonUser||[],uiMessages:r.get.response.aiV5.ui()},providerMetadata:t};await a?.onStepFinish?.({...n.#e.modelId&&n.#e.provider&&n.#e.version?{model:n.#e}:{},...o}),n.#eO.push(o),n.#eR={text:"",reasoning:[],sources:[],files:[],toolCalls:[],toolResults:[],dynamicToolCalls:[],dynamicToolResults:[],staticToolCalls:[],staticToolResults:[],content:[],usage:{inputTokens:void 0,outputTokens:void 0,totalTokens:void 0},warnings:[],request:{},response:{id:"",timestamp:new Date,modelId:"",messages:[],uiMessages:[]},reasoningText:"",providerMetadata:void 0,finishReason:void 0};break}case"tripwire":n.#eW=!0,n.#eG=e.payload?.tripwireReason||"Content blocked",n.#eF="other",n.#eE=!0,n.#eB.text.resolve(n.#eM.join("")),n.#eB.finishReason.resolve("other"),n.#eB.object.resolve(void 0),n.#eB.usage.resolve(n.#a),n.#eB.warnings.resolve(n.#eV),n.#eB.providerMetadata.resolve(void 0),n.#eB.response.resolve({}),n.#eB.request.resolve({}),n.#eB.reasoning.resolve([]),n.#eB.reasoningText.resolve(void 0),n.#eB.sources.resolve([]),n.#eB.files.resolve([]),n.#eB.toolCalls.resolve([]),n.#eB.toolResults.resolve([]),n.#eB.steps.resolve(n.#eO),n.#eB.totalUsage.resolve(n.#a),n.#eB.content.resolve([]),n.#eH(e),t.enqueue(e),n.#eA.emit("finish"),t.terminate();return;case"finish":if(n.#eS="success",e.payload.stepResult.reason&&(n.#eF=e.payload.stepResult.reason),void 0!==n.#eN){let e=[...r.get.response.v2()].reverse().find(e=>"assistant"===e.role);e&&(e.content.metadata||(e.content.metadata={}),e.content.metadata.structuredOutput=n.#eN)}let i={};if(e.payload.metadata){let{providerMetadata:t,request:a,...s}=e.payload.metadata;i={...s,messages:r.get.response.aiV5.model(),uiMessages:r.get.response.aiV5.ui()}}this.populateUsageCount(e.payload.output.usage),e.payload.output.usage={inputTokens:n.#a.inputTokens??0,outputTokens:n.#a.outputTokens??0,totalTokens:n.#a.totalTokens??0,...void 0!==n.#a.reasoningTokens&&{reasoningTokens:n.#a.reasoningTokens},...void 0!==n.#a.cachedInputTokens&&{cachedInputTokens:n.#a.cachedInputTokens}};try{if(n.processorRunner&&!n.#r.isLLMExecutionStep){n.messageList=await n.processorRunner.runOutputProcessors(n.messageList);let t=n.messageList.get.response.aiV4.core().map(e=>wP.coreContentToString(e.content)).join("\n");if(n.#eB.text.resolve(t),n.#eB.finishReason.resolve(n.#eF),e.payload.metadata){let{providerMetadata:t,request:a,...s}=e.payload.metadata;i={...s,messages:r.get.response.aiV5.model(),uiMessages:r.get.response.aiV5.ui()}}}else{let e=n.#eM.join("");n.#eB.text.resolve(e),n.#eB.finishReason.resolve(n.#eF)}}catch(e){e instanceof xh?(n.#eW=!0,n.#eG=e.message,n.#eB.finishReason.resolve("other")):(n.#eI=e instanceof Error?e.message:String(e),n.#eB.finishReason.resolve("error")),n.#eB.text.resolve(""),"resolved"!==n.#eB.object.status.type&&n.#eB.object.resolve(void 0)}n.#eB.usage.resolve(n.#a),n.#eB.warnings.resolve(n.#eV),n.#eB.providerMetadata.resolve(e.payload.metadata?.providerMetadata),n.#eB.response.resolve(i),n.#eB.request.resolve(n.#eZ||{}),n.#eB.text.resolve(n.#eM.join(""));let o=n.#e$.length>0?n.#e$.map(e=>e.payload.text).join(""):void 0;n.#eB.reasoningText.resolve(o),n.#eB.reasoning.resolve(Object.values(n.#eC||{})),n.#eB.sources.resolve(n.#eP),n.#eB.files.resolve(n.#eD),n.#eB.toolCalls.resolve(n.#ez),n.#eB.toolResults.resolve(n.#eq),n.#eB.steps.resolve(n.#eO),n.#eB.totalUsage.resolve(n.#eY()),n.#eB.content.resolve(r.get.response.aiV5.stepContent()),n.#eB.suspendPayload.resolve(void 0);let l=n.#eO[n.#eO.length-1];if(l){let t={providerMetadata:l.providerMetadata,text:l.text,warnings:l.warnings??[],finishReason:e.payload.stepResult.reason,content:r.get.response.aiV5.stepContent(),request:await n.request,error:n.error,reasoning:await n.reasoning,reasoningText:await n.reasoningText,sources:await n.sources,files:await n.files,steps:n.#eO,response:{...await n.response,...l.response,messages:r.get.response.aiV5.model()},usage:e.payload.output.usage,totalUsage:n.#eY(),toolCalls:await n.toolCalls,toolResults:await n.toolResults,staticToolCalls:(await n.toolCalls).filter(e=>e?.payload?.dynamic===!1),staticToolResults:(await n.toolResults).filter(e=>e?.payload?.dynamic===!1),dynamicToolCalls:(await n.toolCalls).filter(e=>e?.payload?.dynamic===!0),dynamicToolResults:(await n.toolResults).filter(e=>e?.payload?.dynamic===!0),...n.#e.modelId&&n.#e.provider&&n.#e.version?{model:n.#e}:{},object:"rejected"===n.#eB.object.status.type?void 0:"resolved"===n.#eB.object.status.type?n.#eB.object.status.value:n.#r.output&&l.text?(()=>{try{return JSON.parse(l.text)}catch{return}})():void 0};await a?.onFinish?.(t)}a?.rootSpan&&(a.rootSpan.setAttributes({...n.#e.modelId?{"aisdk.model.id":n.#e.modelId}:{},...n.#e.provider?{"aisdk.model.provider":n.#e.provider}:{},...l?.usage?.reasoningTokens?{"stream.usage.reasoningTokens":l.usage.reasoningTokens}:{},...l?.usage?.totalTokens?{"stream.usage.totalTokens":l.usage.totalTokens}:{},...l?.usage?.inputTokens?{"stream.usage.inputTokens":l.usage.inputTokens}:{},...l?.usage?.outputTokens?{"stream.usage.outputTokens":l.usage.outputTokens}:{},...l?.usage?.cachedInputTokens?{"stream.usage.cachedInputTokens":l.usage.cachedInputTokens}:{},...l?.providerMetadata?{"stream.response.providerMetadata":JSON.stringify(l?.providerMetadata)}:{},...l?.finishReason?{"stream.response.finishReason":l?.finishReason}:{},...a?.telemetry_settings?.recordOutputs!==!1?{"stream.response.text":l?.text}:{},...l?.toolCalls&&a?.telemetry_settings?.recordOutputs!==!1?{"stream.response.toolCalls":JSON.stringify(l?.toolCalls?.map(e=>({type:"tool-call",toolCallId:e.payload?.toolCallId,args:e.payload?.args,toolName:e.payload?.toolName})).filter(Boolean))}:{}}),a.rootSpan.end());break;case"error":n.#eI=e.payload.error,n.#eS="failed",n.#eE=!0;let u=Error(n.#eI?.message||tm(n.#eI));Object.values(n.#eB).forEach(e=>{"pending"===e.status.type&&e.reject(u)})}n.#eH(e),t.enqueue(e)},flush:()=>{"resolved"!==n.#eB.object.status.type&&n.#eB.object.resolve(void 0),Object.entries(n.#eB).forEach(([e,t])=>{"pending"===t.status.type&&t.reject(Error(`promise '${e}' was not resolved or rejected when stream finished`))}),n.#eE=!0,n.#eA.emit("finish")}})),this.#ex=new Iy({modelOutput:this,messageList:r,options:{toolCallStreaming:a?.toolCallStreaming,output:a?.output,tracingContext:a?.tracingContext}})}#eQ(e){return this.#eK||this.consumeStream(),e.promise}get text(){return this.#eQ(this.#eB.text)}get reasoning(){return this.#eQ(this.#eB.reasoning)}get reasoningText(){return this.#eQ(this.#eB.reasoningText)}get sources(){return this.#eQ(this.#eB.sources)}get files(){return this.#eQ(this.#eB.files)}get steps(){return this.#eQ(this.#eB.steps)}get suspendPayload(){return this.#eQ(this.#eB.suspendPayload)}get fullStream(){return this.#eX()}get finishReason(){return this.#eQ(this.#eB.finishReason)}get toolCalls(){return this.#eQ(this.#eB.toolCalls)}get toolResults(){return this.#eQ(this.#eB.toolResults)}get usage(){return this.#eQ(this.#eB.usage)}get warnings(){return this.#eQ(this.#eB.warnings)}get providerMetadata(){return this.#eQ(this.#eB.providerMetadata)}get response(){return this.#eQ(this.#eB.response)}get request(){return this.#eQ(this.#eB.request)}get error(){if("object"==typeof this.#eI){let e=Error(this.#eI.message);return e.stack=this.#eI.stack,e}return this.#eI}updateUsageCount(e){e&&(void 0!==e.inputTokens&&(this.#a.inputTokens=(this.#a.inputTokens??0)+e.inputTokens),void 0!==e.outputTokens&&(this.#a.outputTokens=(this.#a.outputTokens??0)+e.outputTokens),void 0!==e.totalTokens&&(this.#a.totalTokens=(this.#a.totalTokens??0)+e.totalTokens),void 0!==e.reasoningTokens&&(this.#a.reasoningTokens=(this.#a.reasoningTokens??0)+e.reasoningTokens),void 0!==e.cachedInputTokens&&(this.#a.cachedInputTokens=(this.#a.cachedInputTokens??0)+e.cachedInputTokens))}populateUsageCount(e){e&&(void 0!==e.inputTokens&&void 0===this.#a.inputTokens&&(this.#a.inputTokens=e.inputTokens),void 0!==e.outputTokens&&void 0===this.#a.outputTokens&&(this.#a.outputTokens=e.outputTokens),void 0!==e.totalTokens&&void 0===this.#a.totalTokens&&(this.#a.totalTokens=e.totalTokens),void 0!==e.reasoningTokens&&void 0===this.#a.reasoningTokens&&(this.#a.reasoningTokens=e.reasoningTokens),void 0!==e.cachedInputTokens&&void 0===this.#a.cachedInputTokens&&(this.#a.cachedInputTokens=e.cachedInputTokens))}async consumeStream(e){if(!this.#eK){this.#eK=!0;try{await xy({stream:this.#ek,onError:e?.onError})}catch(t){e?.onError?.(t)}}}async getFullOutput(){let e;return await this.consumeStream({onError:e=>{throw console.error(e),e}}),this.#eJ&&(e={input:{inputMessages:this.messageList.getPersisted.input.ui(),rememberedMessages:this.messageList.getPersisted.remembered.ui(),systemMessages:this.messageList.getSystemMessages(),taggedSystemMessages:this.messageList.getPersisted.taggedSystemMessages},output:this.messageList.getPersisted.response.ui()}),{text:await this.text,usage:await this.usage,steps:await this.steps,finishReason:await this.finishReason,warnings:await this.warnings,providerMetadata:await this.providerMetadata,request:await this.request,reasoning:await this.reasoning,reasoningText:await this.reasoningText,toolCalls:await this.toolCalls,toolResults:await this.toolResults,sources:await this.sources,files:await this.files,response:await this.response,totalUsage:await this.totalUsage,object:await this.object,error:this.error,tripwire:this.#eW,tripwireReason:this.#eG,...e?{scoringData:e}:{},traceId:this.traceId}}get tripwire(){return this.#eW}get tripwireReason(){return this.#eG}get totalUsage(){return this.#eQ(this.#eB.totalUsage)}get content(){return this.#eQ(this.#eB.content)}get aisdk(){return{v5:this.#ex}}get objectStream(){return this.#eX().pipeThrough(new wz.TransformStream({transform(e,t){"object"===e.type&&t.enqueue(e.object)}}))}get elementStream(){let e=0;return this.#eX().pipeThrough(new wz.TransformStream({transform(t,r){if("object"===t.type&&Array.isArray(t.object))for(;e<t.object.length;e++)r.enqueue(t.object[e])}}))}get textStream(){let e=xj(this.#r.output);if(e?.outputFormat==="array"){var t;let e,r,a,s;return this.#eX().pipeThrough((t=this.#r.output,e=0,r=!1,a=0,s=xj(t),new wz.TransformStream({transform(t,n){if("object"===t.type&&t.object)if(s?.outputFormat==="array"){if(1==++a&&t.object.length>0){n.enqueue(JSON.stringify(t.object)),e=t.object.length,r=!0;return}r||(n.enqueue("["),r=!0);for(let r=e;r<t.object.length;r++){let e=JSON.stringify(t.object[r]);r>0?n.enqueue(","+e):n.enqueue(e)}e=t.object.length}else n.enqueue(JSON.stringify(t.object))},flush(e){r&&s?.outputFormat==="array"&&a>1&&e.enqueue("]")}})))}return this.#eX().pipeThrough(new wz.TransformStream({transform(e,t){"text-delta"===e.type&&t.enqueue(e.payload.text)}}))}get object(){return this.processorRunner||this.#r.output||"pending"!==this.#eB.object.status.type||this.#eB.object.resolve(void 0),this.#eQ(this.#eB.object)}_getImmediateToolCalls(){return this.#ez}_getImmediateToolResults(){return this.#eq}_getImmediateText(){return this.#eM.join("")}_getImmediateObject(){return this.#eN}_getImmediateUsage(){return this.#a}_getImmediateWarnings(){return this.#eV}_getImmediateFinishReason(){return this.#eF}_getBaseStream(){return this.#ek}#eY(){let e=this.#a.totalTokens;return void 0===e&&(e=(this.#a.inputTokens??0)+(this.#a.outputTokens??0)+(this.#a.reasoningTokens??0)),{inputTokens:this.#a.inputTokens,outputTokens:this.#a.outputTokens,totalTokens:e,reasoningTokens:this.#a.reasoningTokens,cachedInputTokens:this.#a.cachedInputTokens}}#eH(e){this.#eT.push(e),this.#eA.emit("chunk",e)}#eX(){let e=this;return new wz.ReadableStream({start(t){if(e.#eT.forEach(e=>{t.enqueue(e)}),e.#eE)return void t.close();let r=e=>{t.enqueue(e)},a=()=>{e.#eA.off("chunk",r),e.#eA.off("finish",a),t.close()};e.#eA.on("chunk",r),e.#eA.on("finish",a)},pull(t){e.#eK||e.consumeStream()},cancel(){e.#eA.removeAllListeners()}})}get status(){return this.#eS}serializeState(){return{status:this.#eS,bufferedSteps:this.#eO,bufferedReasoningDetails:this.#eC,bufferedByStep:this.#eR,bufferedText:this.#eM,bufferedTextChunks:this.#ej,bufferedSources:this.#eP,bufferedReasoning:this.#e$,bufferedFiles:this.#eD,toolCallArgsDeltas:this.#eL,toolCallDeltaIdNameMap:this.#eU,toolCalls:this.#ez,toolResults:this.#eq,warnings:this.#eV,finishReason:this.#eF,request:this.#eZ,usageCount:this.#a,tripwire:this.#eW,tripwireReason:this.#eG}}deserializeState(e){this.#eS=e.status,this.#eO=e.bufferedSteps,this.#eC=e.bufferedReasoningDetails,this.#eR=e.bufferedByStep,this.#eM=e.bufferedText,this.#ej=e.bufferedTextChunks,this.#eP=e.bufferedSources,this.#e$=e.bufferedReasoning,this.#eD=e.bufferedFiles,this.#eL=e.toolCallArgsDeltas,this.#eU=e.toolCallDeltaIdNameMap,this.#ez=e.toolCalls,this.#eq=e.toolResults,this.#eV=e.warnings,this.#eF=e.finishReason,this.#eZ=e.request,this.#a=e.usageCount,this.#eW=e.tripwire,this.#eG=e.tripwireReason}},Ix=class extends tD{mastra;constructor({mastra:e}){super({name:"StepExecutor",component:tC}),this.mastra=e}__registerMastra(e){this.mastra=e}async execute(e){let t,r,{step:a,stepResults:s,runId:n,runtimeContext:i,runCount:o=0}=e,l=new AbortController,u=Date.now(),{inputData:d,validationError:p}=await xx({prevOutput:"number"==typeof e.foreachIdx?e.input?.[e.foreachIdx]:e.input,step:a,validateInputs:e.validateInputs??!1}),c={...s[a.id],startedAt:u,payload:("number"==typeof e.foreachIdx?e.input:d)??{}};e.resumeData&&(delete c.suspendPayload?.__workflow_meta,c.resumePayload=e.resumeData,c.resumedAt=Date.now());try{let u;if(p)throw p;let h=await a.execute({workflowId:e.workflowId,runId:n,mastra:this.mastra,runtimeContext:i,inputData:d,state:e.state,setState:t=>{e.state=t},runCount:o,resumeData:e.resumeData,getInitData:()=>s?.input,getStepResult:xS.bind(this,s),suspend:async e=>{t={payload:{...e,__workflow_meta:{runId:n,path:[a.id]}}}},bail:e=>{r={payload:e}},writer:void 0,abort:()=>{l?.abort()},[t6]:e.emitter,[t8]:void 0,engine:{},abortSignal:l?.signal,tracingContext:{}}),m=Date.now();return t?(u={...c,status:"suspended",suspendedAt:m},t.payload&&(u.suspendPayload=t.payload)):u=r?{...c,status:"bailed",endedAt:m,output:r.payload}:{...c,status:"success",endedAt:m,output:h},u}catch(t){let e=Date.now();return{...c,status:"failed",endedAt:e,error:t instanceof Error?t?.stack??t.message:t}}}async evaluateConditions(e){let{step:t,stepResults:r,runId:a,runtimeContext:s,runCount:n=0}=e,i=new AbortController,o=new wU.default;return(await Promise.all(t.conditions.map(t=>{try{return this.evaluateCondition({workflowId:e.workflowId,condition:t,runId:a,runtimeContext:s,inputData:e.input,state:e.state,runCount:n,resumeData:e.resumeData,abortController:i,stepResults:r,emitter:o,iterationCount:0})}catch(e){return console.error("error evaluating condition",e),!1}}))).reduce((e,t,r)=>(t&&e.push(r),e),[])}async evaluateCondition({workflowId:e,condition:t,runId:r,inputData:a,resumeData:s,stepResults:n,state:i,runtimeContext:o,emitter:l,abortController:u,runCount:d=0,iterationCount:p}){return t({workflowId:e,runId:r,mastra:this.mastra,runtimeContext:o,inputData:a,state:i,setState:e=>{},runCount:d,resumeData:s,getInitData:()=>n?.input,getStepResult:xS.bind(this,n),suspend:async e=>{throw Error("Not implemented")},bail:e=>{throw Error("Not implemented")},writer:void 0,abort:()=>{u?.abort()},[t6]:l,[t8]:void 0,engine:{},abortSignal:u?.signal,tracingContext:{},iterationCount:p})}async resolveSleep(e){let{step:t,stepResults:r,runId:a,runtimeContext:s,runCount:n=0}=e,i=new AbortController,o=new wU.default;if(t.duration)return t.duration;if(!t.fn)return 0;try{return await t.fn({workflowId:e.workflowId,runId:a,mastra:this.mastra,runtimeContext:s,inputData:e.input,state:{},setState:e=>{},runCount:n,resumeData:e.resumeData,getInitData:()=>r?.input,getStepResult:xS.bind(this,r),suspend:async e=>{throw Error("Not implemented")},bail:e=>{throw Error("Not implemented")},abort:()=>{i?.abort()},writer:void 0,[t6]:o,[t8]:void 0,engine:{},abortSignal:i?.signal,tracingContext:{}})}catch(e){return console.error("error evaluating condition",e),0}}async resolveSleepUntil(e){let{step:t,stepResults:r,runId:a,runtimeContext:s,runCount:n=0}=e,i=new AbortController,o=new wU.default;if(t.date)return t.date.getTime()-Date.now();if(!t.fn)return 0;try{return(await t.fn({workflowId:e.workflowId,runId:a,mastra:this.mastra,runtimeContext:s,inputData:e.input,state:{},setState:e=>{},runCount:n,resumeData:e.resumeData,getInitData:()=>r?.input,getStepResult:xS.bind(this,r),suspend:async e=>{throw Error("Not implemented")},bail:e=>{throw Error("Not implemented")},abort:()=>{i?.abort()},writer:void 0,[t6]:o,[t8]:void 0,engine:{},abortSignal:i?.signal,tracingContext:{}})).getTime()-Date.now()}catch(e){return console.error("error evaluating condition",e),0}}},II=class{mastra;__registerMastra(e){this.mastra=e}constructor({mastra:e}){this.mastra=e}};async function Ik({workflowId:e,prevResult:t,runId:r,executionPath:a,stepResults:s,activeSteps:n,resumeSteps:i,resumeData:o,parentWorkflow:l,runtimeContext:u,runCount:d=0},{pubsub:p,stepExecutor:c,step:h,stepResult:m}){let g=await c.evaluateCondition({workflowId:e,condition:h.condition,runId:r,stepResults:s,state:{},emitter:new wU.default,runtimeContext:new t7,inputData:t?.status==="success"?t.output:void 0,resumeData:o,abortController:new AbortController,runCount:d,iterationCount:0});"dountil"===h.loopType?g?await p.publish("workflows",{type:"workflow.step.end",runId:r,data:{parentWorkflow:l,workflowId:e,runId:r,executionPath:a,resumeSteps:i,stepResults:s,prevResult:m,resumeData:o,activeSteps:n,runtimeContext:u}}):await p.publish("workflows",{type:"workflow.step.run",runId:r,data:{parentWorkflow:l,workflowId:e,runId:r,executionPath:a,resumeSteps:i,stepResults:s,prevResult:m,resumeData:o,activeSteps:n,runtimeContext:u,runCount:d}}):g?await p.publish("workflows",{type:"workflow.step.run",runId:r,data:{parentWorkflow:l,workflowId:e,runId:r,executionPath:a,resumeSteps:i,stepResults:s,prevResult:m,resumeData:o,activeSteps:n,runtimeContext:u,runCount:d}}):await p.publish("workflows",{type:"workflow.step.end",runId:r,data:{parentWorkflow:l,workflowId:e,runId:r,executionPath:a,resumeSteps:i,stepResults:s,prevResult:m,resumeData:o,activeSteps:n,runtimeContext:u}})}async function IT({workflowId:e,prevResult:t,runId:r,executionPath:a,stepResults:s,activeSteps:n,resumeSteps:i,resumeData:o,parentWorkflow:l,runtimeContext:u},{pubsub:d,mastra:p,step:c}){let h=s[c.step.id],m=h?.output?.length??0,g=t?.output?.length??0;if(m>=g&&h.output.filter(e=>null!==e).length>=g)return void await d.publish("workflows",{type:"workflow.step.run",runId:r,data:{parentWorkflow:l,workflowId:e,runId:r,executionPath:a.slice(0,-1).concat([a[a.length-1]+1]),resumeSteps:i,stepResults:s,prevResult:h,resumeData:o,activeSteps:n,runtimeContext:u}});if(!(m>=g)){if(1===a.length&&0===m){let h=Math.min(c.opts.concurrency??1,g),m=Array.from({length:h},()=>null);await p.getStorage()?.updateWorkflowResults({workflowName:e,runId:r,stepId:c.step.id,result:{status:"succcess",output:m,startedAt:Date.now(),payload:t?.output},runtimeContext:u});for(let p=0;p<h;p++)await d.publish("workflows",{type:"workflow.step.run",runId:r,data:{parentWorkflow:l,workflowId:e,runId:r,executionPath:[a[0],p],resumeSteps:i,stepResults:s,prevResult:t,resumeData:o,activeSteps:n,runtimeContext:u}});return}h.output.push(null),await p.getStorage()?.updateWorkflowResults({workflowName:e,runId:r,stepId:c.step.id,result:{status:"succcess",output:h.output,startedAt:Date.now(),payload:t?.output},runtimeContext:u}),await d.publish("workflows",{type:"workflow.step.run",runId:r,data:{parentWorkflow:l,workflowId:e,runId:r,executionPath:[a[0],m],resumeSteps:i,stepResults:s,prevResult:t,resumeData:o,activeSteps:n,runtimeContext:u}})}}async function IE({workflowId:e,runId:t,executionPath:r,stepResults:a,activeSteps:s,resumeSteps:n,prevResult:i,resumeData:o,parentWorkflow:l,runtimeContext:u},{pubsub:d,step:p}){for(let e=0;e<p.steps.length;e++){let t=p.steps[e];t?.type==="step"&&(s[t.step.id]=!0)}await Promise.all(p.steps.map(async(p,c)=>d.publish("workflows",{type:"workflow.step.run",runId:t,data:{workflowId:e,runId:t,executionPath:r.concat([c]),resumeSteps:n,stepResults:a,prevResult:i,resumeData:o,parentWorkflow:l,activeSteps:s,runtimeContext:u}})))}async function IA({workflowId:e,runId:t,executionPath:r,stepResults:a,activeSteps:s,resumeSteps:n,prevResult:i,resumeData:o,parentWorkflow:l,runtimeContext:u},{pubsub:d,stepExecutor:p,step:c}){let h=await p.evaluateConditions({workflowId:e,step:c,runId:t,stepResults:a,state:{},emitter:new wU.default,runtimeContext:new t7,input:i?.status==="success"?i.output:void 0,resumeData:o}),m={};for(let e=0;e<h.length;e++)m[h[e]]=!0;await Promise.all(c.steps.map(async(p,c)=>m[c]?(p?.type==="step"&&(s[p.step.id]=!0),d.publish("workflows",{type:"workflow.step.run",runId:t,data:{workflowId:e,runId:t,executionPath:r.concat([c]),resumeSteps:n,stepResults:a,prevResult:i,resumeData:o,parentWorkflow:l,activeSteps:s,runtimeContext:u}})):d.publish("workflows",{type:"workflow.step.end",runId:t,data:{workflowId:e,runId:t,executionPath:r.concat([c]),resumeSteps:n,stepResults:a,prevResult:{status:"skipped"},resumeData:o,parentWorkflow:l,activeSteps:s,runtimeContext:u}})))}async function IO(e,{pubsub:t,eventName:r,currentState:a}){let s=a?.waitingPaths[r];if(!s)return;let n=IP(e.workflow,s),i={status:"success",output:a?.context[n?.id??"input"]?.payload};await t.publish("workflows",{type:"workflow.step.run",runId:e.runId,data:{workflowId:e.workflowId,runId:e.runId,executionPath:s,resumeSteps:[],resumeData:e.resumeData,parentWorkflow:e.parentWorkflow,stepResults:a?.context,prevResult:i,activeSteps:[],runtimeContext:a?.runtimeContext}})}async function IC({workflowId:e,runId:t,executionPath:r,stepResults:a,activeSteps:s,resumeSteps:n,prevResult:i,resumeData:o,parentWorkflow:l,runtimeContext:u},{pubsub:d,stepExecutor:p,step:c}){let h=Date.now();await d.publish(`workflow.events.v2.${t}`,{type:"watch",runId:t,data:{type:"workflow-step-waiting",payload:{id:c.id,status:"waiting",payload:"success"===i.status?i.output:void 0,startedAt:h}}});let m=await p.resolveSleep({workflowId:e,step:c,runId:t,stepResults:a,emitter:new wU.default,runtimeContext:new t7,input:i?.status==="success"?i.output:void 0,resumeData:o});setTimeout(async()=>{await d.publish(`workflow.events.v2.${t}`,{type:"watch",runId:t,data:{type:"workflow-step-result",payload:{id:c.id,status:"success",payload:"success"===i.status?i.output:void 0,output:"success"===i.status?i.output:void 0,startedAt:h,endedAt:Date.now()}}}),await d.publish(`workflow.events.v2.${t}`,{type:"watch",runId:t,data:{type:"workflow-step-finish",payload:{id:c.id,metadata:{}}}}),await d.publish("workflows",{type:"workflow.step.run",runId:t,data:{workflowId:e,runId:t,executionPath:r.slice(0,-1).concat([r[r.length-1]+1]),resumeSteps:n,stepResults:a,prevResult:i,resumeData:o,parentWorkflow:l,activeSteps:s,runtimeContext:u}})},m<0?0:m)}async function IR({workflowId:e,runId:t,executionPath:r,stepResults:a,activeSteps:s,resumeSteps:n,prevResult:i,resumeData:o,parentWorkflow:l,runtimeContext:u},{pubsub:d,stepExecutor:p,step:c}){let h=Date.now(),m=await p.resolveSleepUntil({workflowId:e,step:c,runId:t,stepResults:a,emitter:new wU.default,runtimeContext:new t7,input:i?.status==="success"?i.output:void 0,resumeData:o});await d.publish(`workflow.events.v2.${t}`,{type:"watch",runId:t,data:{type:"workflow-step-waiting",payload:{id:c.id,status:"waiting",payload:"success"===i.status?i.output:void 0,startedAt:h}}}),setTimeout(async()=>{await d.publish(`workflow.events.v2.${t}`,{type:"watch",runId:t,data:{type:"workflow-step-result",payload:{id:c.id,status:"success",payload:"success"===i.status?i.output:void 0,output:"success"===i.status?i.output:void 0,startedAt:h,endedAt:Date.now()}}}),await d.publish(`workflow.events.v2.${t}`,{type:"watch",runId:t,data:{type:"workflow-step-finish",payload:{id:c.id,metadata:{}}}}),await d.publish("workflows",{type:"workflow.step.run",runId:t,data:{workflowId:e,runId:t,executionPath:r.slice(0,-1).concat([r[r.length-1]+1]),resumeSteps:n,stepResults:a,prevResult:i,resumeData:o,parentWorkflow:l,activeSteps:s,runtimeContext:u}})},m<0?0:m)}var IM=class extends II{stepExecutor;constructor({mastra:e}){super({mastra:e}),this.stepExecutor=new Ix({mastra:e})}__registerMastra(e){super.__registerMastra(e),this.stepExecutor.__registerMastra(e)}async errorWorkflow({parentWorkflow:e,workflowId:t,runId:r,resumeSteps:a,stepResults:s,resumeData:n,runtimeContext:i},o){await this.mastra.pubsub.publish("workflows",{type:"workflow.fail",runId:r,data:{workflowId:t,runId:r,executionPath:[],resumeSteps:a,stepResults:s,prevResult:{status:"failed",error:o.stack??o.message},runtimeContext:i,resumeData:n,activeSteps:{},parentWorkflow:e}})}async processWorkflowCancel({workflowId:e,runId:t}){let r=await this.mastra.getStorage()?.updateWorkflowState({workflowName:e,runId:t,opts:{status:"canceled"}});await this.endWorkflow({workflow:void 0,workflowId:e,runId:t,stepResults:r?.context,prevResult:{status:"canceled"},runtimeContext:r?.runtimeContext,executionPath:[],activeSteps:{},resumeSteps:[],resumeData:void 0,parentWorkflow:void 0})}async processWorkflowStart({workflow:e,parentWorkflow:t,workflowId:r,runId:a,resumeSteps:s,prevResult:n,resumeData:i,executionPath:o,stepResults:l,runtimeContext:u}){await this.mastra.getStorage()?.persistWorkflowSnapshot({workflowName:e.id,runId:a,snapshot:{activePaths:[],suspendedPaths:{},waitingPaths:{},serializedStepGraph:e.serializedStepGraph,timestamp:Date.now(),runId:a,status:"running",context:l??{input:n?.status==="success"?n.output:void 0},value:{}}}),await this.mastra.pubsub.publish("workflows",{type:"workflow.step.run",runId:a,data:{parentWorkflow:t,workflowId:r,runId:a,executionPath:o??[0],resumeSteps:s,stepResults:l??{input:n?.status==="success"?n.output:void 0},prevResult:n,runtimeContext:u,resumeData:i,activeSteps:{}}})}async endWorkflow(e){let{stepResults:t,workflowId:r,runId:a,prevResult:s}=e;await this.mastra.getStorage()?.updateWorkflowState({workflowName:r,runId:a,opts:{status:"success",result:s}}),await this.mastra.pubsub.publish(`workflow.events.${a}`,{type:"watch",runId:a,data:{type:"watch",payload:{currentStep:void 0,workflowState:{status:s.status,steps:t,result:"success"===s.status?s.output:null,error:s.error??null}},eventTimestamp:Date.now()}}),await this.mastra.pubsub.publish(`workflow.events.v2.${a}`,{type:"watch",runId:a,data:{type:"workflow-finish",payload:{runId:a}}}),await this.mastra.pubsub.publish("workflows",{type:"workflow.end",runId:a,data:{...e,workflow:void 0}})}async processWorkflowEnd(e){let{resumeSteps:t,prevResult:r,resumeData:a,parentWorkflow:s,activeSteps:n,runtimeContext:i,runId:o}=e;s&&await this.mastra.pubsub.publish("workflows",{type:"workflow.step.end",runId:o,data:{workflowId:s.workflowId,runId:s.runId,executionPath:s.executionPath,resumeSteps:t,stepResults:s.stepResults,prevResult:r,resumeData:a,activeSteps:n,parentWorkflow:s.parentWorkflow,parentContext:s,runtimeContext:i}}),await this.mastra.pubsub.publish("workflows-finish",{type:"workflow.end",runId:o,data:{...e,workflow:void 0}})}async processWorkflowSuspend(e){let{resumeSteps:t,prevResult:r,resumeData:a,parentWorkflow:s,activeSteps:n,runId:i,runtimeContext:o}=e;s&&await this.mastra.pubsub.publish("workflows",{type:"workflow.step.end",runId:i,data:{workflowId:s.workflowId,runId:s.runId,executionPath:s.executionPath,resumeSteps:t,stepResults:s.stepResults,prevResult:{...r,suspendPayload:{...r.suspendPayload,__workflow_meta:{runId:i,path:s?.stepId?[s.stepId].concat(r.suspendPayload?.__workflow_meta?.path??[]):r.suspendPayload?.__workflow_meta?.path??[]}}},resumeData:a,activeSteps:n,runtimeContext:o,parentWorkflow:s.parentWorkflow,parentContext:s}}),await this.mastra.pubsub.publish("workflows-finish",{type:"workflow.suspend",runId:i,data:{...e,workflow:void 0}})}async processWorkflowFail(e){let{workflowId:t,runId:r,resumeSteps:a,prevResult:s,resumeData:n,parentWorkflow:i,activeSteps:o,runtimeContext:l}=e;await this.mastra.getStorage()?.updateWorkflowState({workflowName:t,runId:r,opts:{status:"failed",error:s.error}}),i&&await this.mastra.pubsub.publish("workflows",{type:"workflow.step.end",runId:r,data:{workflowId:i.workflowId,runId:i.runId,executionPath:i.executionPath,resumeSteps:a,stepResults:i.stepResults,prevResult:s,resumeData:n,activeSteps:o,runtimeContext:l,parentWorkflow:i.parentWorkflow,parentContext:i}}),await this.mastra.pubsub.publish("workflows-finish",{type:"workflow.fail",runId:r,data:{...e,workflow:void 0}})}async processWorkflowStepRun({workflow:e,workflowId:t,runId:r,executionPath:a,stepResults:s,activeSteps:n,resumeSteps:i,prevResult:o,resumeData:l,parentWorkflow:u,runtimeContext:d,runCount:p=0}){let c=e.stepGraph;if(!a?.length)return this.errorWorkflow({workflowId:t,runId:r,executionPath:a,stepResults:s,activeSteps:n,resumeSteps:i,prevResult:o,resumeData:l,parentWorkflow:u,runtimeContext:d},new tv({id:"MASTRA_WORKFLOW",text:`Execution path is empty: ${JSON.stringify(a)}`,domain:"MASTRA_WORKFLOW",category:"SYSTEM"}));let h=c[a[0]];if(!h)return this.errorWorkflow({workflowId:t,runId:r,executionPath:a,stepResults:s,activeSteps:n,resumeSteps:i,prevResult:o,resumeData:l,parentWorkflow:u,runtimeContext:d},new tv({id:"MASTRA_WORKFLOW",text:`Step not found in step graph: ${JSON.stringify(a)}`,domain:"MASTRA_WORKFLOW",category:"SYSTEM"}));if(("parallel"===h.type||"conditional"===h.type)&&a.length>1)h=h.steps[a[1]];else if("parallel"===h.type)return IE({workflowId:t,runId:r,executionPath:a,stepResults:s,activeSteps:n,resumeSteps:i,prevResult:o,resumeData:l,parentWorkflow:u,runtimeContext:d},{pubsub:this.mastra.pubsub,step:h});else if(h?.type==="conditional")return IA({workflowId:t,runId:r,executionPath:a,stepResults:s,activeSteps:n,resumeSteps:i,prevResult:o,resumeData:l,parentWorkflow:u,runtimeContext:d},{pubsub:this.mastra.pubsub,stepExecutor:this.stepExecutor,step:h});else if(h?.type==="sleep")return IC({workflowId:t,runId:r,executionPath:a,stepResults:s,activeSteps:n,resumeSteps:i,prevResult:o,resumeData:l,parentWorkflow:u,runtimeContext:d},{pubsub:this.mastra.pubsub,stepExecutor:this.stepExecutor,step:h});else if(h?.type==="sleepUntil")return IR({workflowId:t,runId:r,executionPath:a,stepResults:s,activeSteps:n,resumeSteps:i,prevResult:o,resumeData:l,parentWorkflow:u,runtimeContext:d},{pubsub:this.mastra.pubsub,stepExecutor:this.stepExecutor,step:h});else if(h?.type!=="waitForEvent"||l){if(h?.type==="foreach"&&1===a.length)return IT({workflowId:t,runId:r,executionPath:a,stepResults:s,activeSteps:n,resumeSteps:i,prevResult:o,resumeData:l,parentWorkflow:u,runtimeContext:d},{pubsub:this.mastra.pubsub,mastra:this.mastra,step:h})}else{await this.mastra.getStorage()?.updateWorkflowResults({workflowName:t,runId:r,stepId:h.step.id,result:{startedAt:Date.now(),status:"waiting",payload:"success"===o.status?o.output:void 0},runtimeContext:d}),await this.mastra.getStorage()?.updateWorkflowState({workflowName:t,runId:r,opts:{status:"waiting",waitingPaths:{[h.event]:a}}}),await this.mastra.pubsub.publish(`workflow.events.v2.${r}`,{type:"watch",runId:r,data:{type:"workflow-step-waiting",payload:{id:h.step.id,status:"waiting",payload:"success"===o.status?o.output:void 0,startedAt:Date.now()}}});return}if(!I$(h))return this.errorWorkflow({workflowId:t,runId:r,executionPath:a,stepResults:s,activeSteps:n,resumeSteps:i,prevResult:o,resumeData:l,parentWorkflow:u,runtimeContext:d},new tv({id:"MASTRA_WORKFLOW",text:`Step is not executable: ${h?.type} -- ${JSON.stringify(a)}`,domain:"MASTRA_WORKFLOW",category:"SYSTEM"}));if(n[h.step.id]=!0,h.step instanceof IN){if(i?.length>1){let e=s[h.step.id],p=e?.suspendPayload?.__workflow_meta?.runId;if(!p)return this.errorWorkflow({workflowId:t,runId:r,executionPath:a,stepResults:s,activeSteps:n,resumeSteps:i,prevResult:o,resumeData:l,parentWorkflow:u,runtimeContext:d},new tv({id:"MASTRA_WORKFLOW",text:`Nested workflow run id not found: ${JSON.stringify(s)}`,domain:"MASTRA_WORKFLOW",category:"SYSTEM"}));let c=await this.mastra?.getStorage()?.loadWorkflowSnapshot({workflowName:h.step.id,runId:p}),m=c?.context,g=i.slice(1);await this.mastra.pubsub.publish("workflows",{type:"workflow.resume",runId:r,data:{workflowId:h.step.id,parentWorkflow:{stepId:h.step.id,workflowId:t,runId:r,executionPath:a,resumeSteps:i,stepResults:s,input:o,parentWorkflow:u},executionPath:c?.suspendedPaths?.[g[0]],runId:p,resumeSteps:g,stepResults:m,prevResult:o,resumeData:l,activeSteps:n,runtimeContext:d}})}else await this.mastra.pubsub.publish("workflows",{type:"workflow.start",runId:r,data:{workflowId:h.step.id,parentWorkflow:{stepId:h.step.id,workflowId:t,runId:r,executionPath:a,resumeSteps:i,stepResults:s,input:o,parentWorkflow:u},executionPath:[0],runId:(0,ri.randomUUID)(),resumeSteps:i,prevResult:o,resumeData:l,activeSteps:n,runtimeContext:d}});return}("step"===h.type||"waitForEvent"===h.type)&&(await this.mastra.pubsub.publish(`workflow.events.${r}`,{type:"watch",runId:r,data:{type:"watch",payload:{currentStep:{id:h.step.id,status:"running"},workflowState:{status:"running",steps:s,error:null,result:null}},eventTimestamp:Date.now()}}),await this.mastra.pubsub.publish(`workflow.events.v2.${r}`,{type:"watch",runId:r,data:{type:"workflow-step-start",payload:{id:h.step.id,startedAt:Date.now(),payload:"success"===o.status?o.output:void 0,status:"running"}}}));let m=new wU.default;m.on("watch-v2",async e=>{await this.mastra.pubsub.publish(`workflow.events.v2.${r}`,{type:"watch",runId:r,data:e})});let g=new t7;for(let[e,t]of Object.entries(d))g.set(e,t);let f=await this.stepExecutor.execute({workflowId:t,step:h.step,runId:r,stepResults:s,state:{},emitter:m,runtimeContext:g,input:o?.output,resumeData:"waitForEvent"===h.type||i?.length===1&&i?.[0]===h.step.id?l:void 0,runCount:p,foreachIdx:"foreach"===h.type?a[1]:void 0,validateInputs:e.options.validateInputs});if(d=Object.fromEntries(g.entries()),"bailed"===f.status){f.status="success",await this.endWorkflow({workflow:e,resumeData:l,parentWorkflow:u,workflowId:t,runId:r,executionPath:a,resumeSteps:i,stepResults:{...s,[h.step.id]:f},prevResult:f,activeSteps:n,runtimeContext:d});return}if("failed"===f.status)if(!(p>=(e.retryConfig.attempts??0)))return this.mastra.pubsub.publish("workflows",{type:"workflow.step.run",runId:r,data:{parentWorkflow:u,workflowId:t,runId:r,executionPath:a,resumeSteps:i,stepResults:s,prevResult:o,activeSteps:n,runtimeContext:d,runCount:p+1}});else await this.mastra.pubsub.publish("workflows",{type:"workflow.step.end",runId:r,data:{parentWorkflow:u,workflowId:t,runId:r,executionPath:a,resumeSteps:i,stepResults:s,prevResult:f,activeSteps:n,runtimeContext:d}});"loop"===h.type?await Ik({workflowId:t,prevResult:f,runId:r,executionPath:a,stepResults:s,activeSteps:n,resumeSteps:i,resumeData:l,parentWorkflow:u,runtimeContext:d,runCount:p+1},{pubsub:this.mastra.pubsub,stepExecutor:this.stepExecutor,step:h,stepResult:f}):await this.mastra.pubsub.publish("workflows",{type:"workflow.step.end",runId:r,data:{parentWorkflow:u,workflowId:t,runId:r,executionPath:a,resumeSteps:i,stepResults:s,prevResult:f,activeSteps:n,runtimeContext:d}})}async processWorkflowStepEnd({workflow:e,workflowId:t,runId:r,executionPath:a,resumeSteps:s,prevResult:n,parentWorkflow:i,stepResults:o,activeSteps:l,parentContext:u,runtimeContext:d}){let p=e.stepGraph[a[0]];if((p?.type==="parallel"||p?.type==="conditional")&&a.length>1&&(p=p.steps[a[1]]),!p)return this.errorWorkflow({workflowId:t,runId:r,executionPath:a,resumeSteps:s,prevResult:n,stepResults:o,activeSteps:l,runtimeContext:d},new tv({id:"MASTRA_WORKFLOW",text:`Step not found: ${JSON.stringify(a)}`,domain:"MASTRA_WORKFLOW",category:"SYSTEM"}));if("foreach"===p.type){let s=await this.mastra.getStorage()?.loadWorkflowSnapshot({workflowName:t,runId:r}),i=a[1],l=s?.context?.[p.step.id]?.output,u=n;void 0!==i&&(l?(l[i]=n.output,u={...n,output:l}):u={...n,output:[n.output]});let c=await this.mastra.getStorage()?.updateWorkflowResults({workflowName:e.id,runId:r,stepId:p.step.id,result:u,runtimeContext:d});if(!c)return;o=c}else if(I$(p)){delete l[p.step.id],u&&(n=o[p.step.id]={...n,payload:u.input?.output??{}});let t=await this.mastra.getStorage()?.updateWorkflowResults({workflowName:e.id,runId:r,stepId:p.step.id,result:n,runtimeContext:d});if(!t)return;o=t}if(!n?.status||"failed"===n.status)return void await this.mastra.pubsub.publish("workflows",{type:"workflow.fail",runId:r,data:{workflowId:t,runId:r,executionPath:a,resumeSteps:s,parentWorkflow:i,stepResults:o,prevResult:n,activeSteps:l,runtimeContext:d}});if("suspended"===n.status){let u={},c=IP(e,a);c&&(u[c.id]=a),await this.mastra.getStorage()?.updateWorkflowState({workflowName:t,runId:r,opts:{status:"suspended",result:n,suspendedPaths:u}}),await this.mastra.pubsub.publish("workflows",{type:"workflow.suspend",runId:r,data:{workflowId:t,runId:r,executionPath:a,resumeSteps:s,parentWorkflow:i,stepResults:o,prevResult:n,activeSteps:l,runtimeContext:d}}),await this.mastra.pubsub.publish(`workflow.events.${r}`,{type:"watch",runId:r,data:{type:"watch",payload:{currentStep:{...n,id:p?.step?.id},workflowState:{status:"suspended",steps:o,suspendPayload:n.suspendPayload}}}}),await this.mastra.pubsub.publish(`workflow.events.v2.${r}`,{type:"watch",runId:r,data:{type:"workflow-step-suspended",payload:{id:p?.step?.id,...n,suspendedAt:Date.now(),suspendPayload:n.suspendPayload}}});return}if((p?.type==="step"||p?.type==="waitForEvent")&&(await this.mastra.pubsub.publish(`workflow.events.${r}`,{type:"watch",runId:r,data:{type:"watch",payload:{currentStep:{...n,id:p.step.id},workflowState:{status:"running",steps:o,error:null,result:null}},eventTimestamp:Date.now()}}),await this.mastra.pubsub.publish(`workflow.events.v2.${r}`,{type:"watch",runId:r,data:{type:"workflow-step-result",payload:{id:p.step.id,...n}}}),"success"===n.status&&await this.mastra.pubsub.publish(`workflow.events.v2.${r}`,{type:"watch",runId:r,data:{type:"workflow-step-finish",payload:{id:p.step.id,metadata:{}}}})),p=e.stepGraph[a[0]],(p?.type==="parallel"||p?.type==="conditional")&&a.length>1){let e=0,n=p.steps.reduce((t,r)=>{if(I$(r)){let a=o?.[r.step.id];a&&"success"===a.status?t[r.step.id]=a?.output:a?.status==="skipped"&&e++}return t},{});if(Object.keys(n).length+e<p.steps.length)return;await this.mastra.pubsub.publish("workflows",{type:"workflow.step.end",runId:r,data:{parentWorkflow:i,workflowId:t,runId:r,executionPath:a.slice(0,-1),resumeSteps:s,stepResults:o,prevResult:{status:"success",output:n},activeSteps:l,runtimeContext:d}})}else p?.type==="foreach"?await this.mastra.pubsub.publish("workflows",{type:"workflow.step.run",runId:r,data:{workflowId:t,runId:r,executionPath:a.slice(0,-1),resumeSteps:s,parentWorkflow:i,stepResults:o,prevResult:{...n,output:n?.payload},activeSteps:l,runtimeContext:d}}):a[0]>=e.stepGraph.length-1?await this.endWorkflow({workflow:e,parentWorkflow:i,workflowId:t,runId:r,executionPath:a,resumeSteps:s,stepResults:o,prevResult:n,activeSteps:l,runtimeContext:d}):await this.mastra.pubsub.publish("workflows",{type:"workflow.step.run",runId:r,data:{workflowId:t,runId:r,executionPath:a.slice(0,-1).concat([a[a.length-1]+1]),resumeSteps:s,parentWorkflow:i,stepResults:o,prevResult:n,activeSteps:l,runtimeContext:d}})}async loadData({workflowId:e,runId:t}){return await this.mastra.getStorage()?.loadWorkflowSnapshot({workflowName:e,runId:t})}async process(e,t){let r,{type:a,data:s}=e,n=await this.loadData({workflowId:s.workflowId,runId:s.runId});if(n?.status!=="canceled"||"workflow.end"===a){if(a.startsWith("workflow.user-event."))return void await IO({...s,workflow:this.mastra.getWorkflow(s.workflowId)},{pubsub:this.mastra.pubsub,eventName:a.split(".").slice(2).join("."),currentState:n});if(!(r=this.mastra.__hasInternalWorkflow(s.workflowId)?this.mastra.__getInternalWorkflow(s.workflowId):s.parentWorkflow?function e(t,{workflowId:r,executionPath:a,parentWorkflow:s}){let n=null;if(s){let r=e(t,s);if(!r)return null;n=r}let i=(n=n??t.getWorkflow(r)).stepGraph[a[0]];return((i?.type==="parallel"||i?.type==="conditional")&&(i=i.steps[a[1]]),i?.type==="step"||i?.type==="loop")?i.step:null}(this.mastra,s.parentWorkflow):this.mastra.getWorkflow(s.workflowId)))return this.errorWorkflow(s,new tv({id:"MASTRA_WORKFLOW",text:`Workflow not found: ${s.workflowId}`,domain:"MASTRA_WORKFLOW",category:"SYSTEM"}));if("workflow.start"===a||"workflow.resume"===a){let{runId:e}=s;await this.mastra.pubsub.publish(`workflow.events.v2.${e}`,{type:"watch",runId:e,data:{type:"workflow-start",payload:{runId:e}}})}switch(a){case"workflow.cancel":await this.processWorkflowCancel({workflow:r,...s});break;case"workflow.start":case"workflow.resume":await this.processWorkflowStart({workflow:r,...s});break;case"workflow.end":await this.processWorkflowEnd({workflow:r,...s});break;case"workflow.step.end":await this.processWorkflowStepEnd({workflow:r,...s});break;case"workflow.step.run":await this.processWorkflowStepRun({workflow:r,...s});break;case"workflow.suspend":await this.processWorkflowSuspend({workflow:r,...s});break;case"workflow.fail":await this.processWorkflowFail({workflow:r,...s})}try{await t?.()}catch(e){console.error("Error acking event",e)}}}},IN=class extends xE{constructor(e){super(e)}__registerMastra(e){super.__registerMastra(e),this.executionEngine.__registerMastra(e)}async createRunAsync(e){let t=e?.runId||(0,ri.randomUUID)(),r=this.runs.get(t)??new Ij({workflowId:this.id,runId:t,executionEngine:this.executionEngine,executionGraph:this.executionGraph,serializedStepGraph:this.serializedStepGraph,mastra:this.mastra,retryConfig:this.retryConfig,cleanup:()=>this.runs.delete(t),workflowSteps:this.steps});this.runs.set(t,r);let a=this.options?.shouldPersistSnapshot?.({workflowStatus:r.workflowRunStatus,stepResults:{}});return!await this.getWorkflowRunExecutionResult(t,!1)&&a&&await this.mastra?.getStorage()?.persistWorkflowSnapshot({workflowName:this.id,runId:t,snapshot:{runId:t,status:"pending",value:{},context:{},activePaths:[],serializedStepGraph:this.serializedStepGraph,suspendedPaths:{},waitingPaths:{},result:void 0,error:void 0,timestamp:Date.now()}}),r}},Ij=class extends xA{constructor(e){super(e),this.serializedStepGraph=e.serializedStepGraph}async start({inputData:e,initialState:t,runtimeContext:r}){if(0===this.serializedStepGraph.length)throw Error("Execution flow of workflow is not defined. Add steps to the workflow via .then(), .branch(), etc.");if(!this.executionGraph.steps)throw Error("Uncommitted step flow changes detected. Call .commit() to register the steps.");r=r??new t7,await this.mastra?.getStorage()?.persistWorkflowSnapshot({workflowName:this.workflowId,runId:this.runId,snapshot:{runId:this.runId,serializedStepGraph:this.serializedStepGraph,value:{},context:{},runtimeContext:Object.fromEntries(r.entries()),activePaths:[],suspendedPaths:{},waitingPaths:{},timestamp:Date.now(),status:"running"}});let a=await this._validateInput(e),s=await this._validateInitialState(t??{}),n=await this.executionEngine.execute({workflowId:this.workflowId,runId:this.runId,graph:this.executionGraph,serializedStepGraph:this.serializedStepGraph,input:a,initialState:s,emitter:{emit:async(e,t)=>{this.emitter.emit(e,t)},on:(e,t)=>{this.emitter.on(e,t)},off:(e,t)=>{this.emitter.off(e,t)},once:(e,t)=>{this.emitter.once(e,t)}},retryConfig:this.retryConfig,runtimeContext:r,abortController:this.abortController});return console.dir({startResult:n},{depth:null}),"suspended"!==n.status&&this.cleanup?.(),n}async resume(e){let t=(Array.isArray(e.step)?e.step:[e.step]).map(e=>"string"==typeof e?e:e?.id);if(0===t.length)throw Error("No steps provided to resume");let r=await this.mastra?.getStorage()?.loadWorkflowSnapshot({workflowName:this.workflowId,runId:this.runId}),a=r?.suspendedPaths?.[t[0]];if(!a)throw Error(`No resume path found for step ${JSON.stringify(t)}, currently suspended paths are ${JSON.stringify(r?.suspendedPaths)}`);console.dir({resume:{runtimeContextObj:r?.runtimeContext,runtimeContext:e.runtimeContext}},{depth:null});let s=r?.runtimeContext??{},n=new t7;for(let[e,t]of Object.entries(s))n.set(e,t);if(e.runtimeContext)for(let[t,r]of e.runtimeContext.entries())n.set(t,r);let i=this.workflowSteps[t?.[0]??""],o=await this._validateResumeData(e.resumeData,i),l=this.executionEngine.execute({workflowId:this.workflowId,runId:this.runId,graph:this.executionGraph,serializedStepGraph:this.serializedStepGraph,input:o,resume:{steps:t,stepResults:r?.context,resumePayload:o,resumePath:a},emitter:{emit:(e,t)=>(this.emitter.emit(e,t),Promise.resolve()),on:(e,t)=>{this.emitter.on(e,t)},off:(e,t)=>{this.emitter.off(e,t)},once:(e,t)=>{this.emitter.once(e,t)}},runtimeContext:n,abortController:this.abortController}).then(e=>("suspended"!==e.status&&this.closeStreamAction?.().catch(()=>{}),e));return this.executionResults=l,l}watch(e,t="watch"){let r=async(t,r)=>{t.runId===this.runId&&(e(t.data),await r?.())};return"watch-v2"===t?this.mastra?.pubsub.subscribe(`workflow.events.v2.${this.runId}`,r).catch(()=>{}):this.mastra?.pubsub.subscribe(`workflow.events.${this.runId}`,r).catch(()=>{}),()=>{"watch-v2"===t?this.mastra?.pubsub.unsubscribe(`workflow.events.v2.${this.runId}`,r).catch(()=>{}):this.mastra?.pubsub.unsubscribe(`workflow.events.${this.runId}`,r).catch(()=>{})}}async watchAsync(e,t="watch"){let r=async(t,r)=>{t.runId===this.runId&&(e(t.data),await r?.())};return"watch-v2"===t?await this.mastra?.pubsub.subscribe(`workflow.events.v2.${this.runId}`,r).catch(()=>{}):await this.mastra?.pubsub.subscribe(`workflow.events.${this.runId}`,r).catch(()=>{}),async()=>{"watch-v2"===t?await this.mastra?.pubsub.unsubscribe(`workflow.events.v2.${this.runId}`,r).catch(()=>{}):await this.mastra?.pubsub.unsubscribe(`workflow.events.${this.runId}`,r).catch(()=>{})}}async cancel(){await this.mastra?.pubsub.publish("workflows",{type:"workflow.cancel",runId:this.runId,data:{workflowId:this.workflowId,runId:this.runId}})}async sendEvent(e,t){await this.mastra?.pubsub.publish("workflows",{type:`workflow.user-event.${e}`,runId:this.runId,data:{workflowId:this.workflowId,runId:this.runId,resumeData:t}})}};function IP(e,t){let r=0,a=e.stepGraph[t[0]];if(a?.type==="parallel"||a?.type==="conditional")a=a.steps[t[1]],r++;else if(a?.type==="foreach")return a.step;return a?.type!=="step"&&a?.type!=="loop"&&a?.type!=="waitForEvent"?null:a instanceof IN?IP(a,t.slice(r+1)):a.step}function I$(e){return"step"===e.type||"loop"===e.type||"waitForEvent"===e.type||"foreach"===e.type}rb.z.record(rb.z.string(),rb.z.any()).optional();var ID=rb.z.number();rb.z.object({result:rb.z.record(rb.z.string(),rb.z.any()).optional(),score:ID,prompt:rb.z.string().optional()});var IL=rb.z.object({runId:rb.z.string(),scorerId:rb.z.string(),entityId:rb.z.string(),score:rb.z.number(),input:rb.z.any().optional(),output:rb.z.any(),source:rb.z.enum(["LIVE","TEST"]),entityType:rb.z.enum(["AGENT","WORKFLOW",...Object.values(lk)]).optional(),scorer:rb.z.record(rb.z.string(),rb.z.any()),traceId:rb.z.string().optional(),spanId:rb.z.string().optional(),preprocessStepResult:rb.z.record(rb.z.string(),rb.z.any()).optional(),extractStepResult:rb.z.record(rb.z.string(),rb.z.any()).optional(),analyzeStepResult:rb.z.record(rb.z.string(),rb.z.any()).optional(),reason:rb.z.string().optional(),metadata:rb.z.record(rb.z.string(),rb.z.any()).optional(),preprocessPrompt:rb.z.string().optional(),extractPrompt:rb.z.string().optional(),generateScorePrompt:rb.z.string().optional(),generateReasonPrompt:rb.z.string().optional(),analyzePrompt:rb.z.string().optional(),additionalContext:rb.z.record(rb.z.string(),rb.z.any()).optional(),runtimeContext:rb.z.record(rb.z.string(),rb.z.any()).optional(),entity:rb.z.record(rb.z.string(),rb.z.any()).optional(),resourceId:rb.z.string().optional(),threadId:rb.z.string().optional()}),IU=Symbol("isAugmented");function Iz(e){let t=null,r=async()=>{t||(t=e.init()),await t};return e[IU]?e:new Proxy(e,{get(e,t){if(t===IU)return!0;let a=e[t];return"function"==typeof a&&"init"!==t?async(...t)=>(await r(),Reflect.apply(a,e,t)):Reflect.get(e,t)}})}var Iq=class{},IV=e.i(688947),IF={debug:()=>{},info:()=>{},warn:()=>{},error:()=>{},cleanup:async()=>{},getTransports:()=>new Map,trackException:()=>{},getLogs:async()=>({logs:[],total:0,page:1,perPage:100,hasMore:!1}),getLogsByRunId:async()=>({logs:[],total:0,page:1,perPage:100,hasMore:!1})};IV.Transform;var IZ=class extends Iq{emitter;constructor(){super(),this.emitter=new wU.default}async publish(e,t){let r=crypto.randomUUID(),a=new Date;this.emitter.emit(e,{...t,id:r,createdAt:a})}async subscribe(e,t){this.emitter.on(e,t)}async unsubscribe(e,t){this.emitter.off(e,t)}async flush(){}};async function IW(e,t){let r=IL.parse(t);await e?.saveScore(r)}async function IG(e,t,r,a){let s;if("AGENT"===r){for(let[r,n]of Object.entries(await e.getAgentById(t).getScorers()))if(n.scorer.name===a){s=n;break}}else if("WORKFLOW"===r){for(let[r,n]of Object.entries(await e.getWorkflowById(t).getScorers()))if(n.scorer.name===a){s=n;break}}if(!s){let t=e.getScorerByName(a);s=t?{scorer:t}:void 0}return s}e4=[tE({prefix:"mastra",excludeMethods:["getLogger","getTelemetry"]})];var IB=class{#e0;#ed;#e1;#e2;#es;#e4;#e5;#e3=[];#e9;#e6;#ea;#eu;#e8;#e7;#te;#tt;#tr;#ta={};#ts={};#tn;get telemetry(){return this.#e9}get storage(){return this.#e6}get memory(){return this.#ea}get pubsub(){return this.#tr}getIdGenerator(){return this.#tt}generateId(){if(this.#tt){let e=this.#tt();if(!e){let e=new tv({id:"MASTRA_ID_GENERATOR_RETURNED_EMPTY_STRING",domain:"MASTRA",category:"USER",text:"ID generator returned an empty string, which is not allowed"});throw this.#e1?.trackException(e),e}return e}return(0,ri.randomUUID)()}setIdGenerator(e){this.#tt=e}constructor(e){var t;let r;for(const t in e?.serverMiddleware&&(this.#e3=e.serverMiddleware.map(e=>({handler:e.handler,path:e.path||"/api/*"}))),this.#tn=new cp,e?.pubsub?this.#tr=e.pubsub:this.#tr=new IZ,this.#ta={},e?.events??{})Array.isArray(e?.events?.[t])?this.#ta[t]=e?.events?.[t]??[]:this.#ta[t]=[e?.events?.[t]];const a=new IM({mastra:this}),s=async(e,t)=>{try{await a.process(e,t)}catch(e){console.error("Error processing event",e)}};this.#ta.workflows?this.#ta.workflows.push(s):this.#ta.workflows=[s],r=e?.logger===!1?IF:e?.logger?e.logger:new t$({name:"Mastra",level:"true"!==process.env.MASTRA_DEV?tN:tM}),this.#e1=r,this.#tt=e?.idGenerator;let n=e?.storage;if(n&&(n=Iz(n)),this.#e9=tA.init(e?.telemetry),e?.telemetry?.enabled!==!1&&"undefined"!=typeof globalThis&&!0!==globalThis.___MASTRA_TELEMETRY___&&this.#e1?.warn("Mastra telemetry is enabled, but the required instrumentation file was not loaded. If you are using Mastra outside of the mastra server environment, see: https://mastra.ai/en/docs/observability/tracing#tracing-outside-mastra-server-environment","If you are using a custom instrumentation file or want to disable this warning, set the globalThis.___MASTRA_TELEMETRY___ variable to true in your instrumentation file."),e?.telemetry?.enabled!==!1&&this.#e1?.warn("Mastra telemetry is deprecated and will be removed on the Nov 4th release. Instead use AI Tracing. More info can be found here: https://github.com/mastra-ai/mastra/issues/8577 and here: https://mastra.ai/en/docs/observability/ai-tracing/overview"),e?.observability&&function(e){if(e){var t;if(e.default?.enabled&&e.configs?.default)throw Error("Cannot use 'default' as a custom config name when default tracing is enabled. Please rename your custom config to avoid conflicts.");e.default?.enabled&&lB("default",new lP({serviceName:"mastra",name:"default",sampling:{type:"always"},exporters:[new lZ,new lF],processors:[new lW]}),!0),e.configs&&Object.entries(e.configs).forEach(([t,r],a)=>{let s=r instanceof lj?r:new lP({...r,name:t});lB(t,s,!e.default?.enabled&&0===a)}),e.configSelector&&(t=e.configSelector,lG.setSelector(t))}}(e.observability),this.#e9&&n?(this.#e6=this.#e9.traceClass(n,{excludeMethods:["__setTelemetry","__getTelemetry","batchTraceInsert","getTraces","getEvalsByAgentName"]}),this.#e6.__setTelemetry(this.#e9)):this.#e6=n,e?.vectors){let t={};Object.entries(e.vectors).forEach(([e,r])=>{this.#e9?(t[e]=this.#e9.traceClass(r,{excludeMethods:["__setTelemetry","__getTelemetry"]}),t[e].__setTelemetry(this.#e9)):t[e]=r}),this.#e0=t}if(e?.mcpServers&&(this.#e7=e.mcpServers,Object.entries(this.#e7).forEach(([e,t])=>{t.setId(e),this.#e9&&t.__setTelemetry(this.#e9),t.__registerMastra(this),t.__setLogger(this.getLogger())})),e&&"memory"in e){const e=new tv({id:"MASTRA_CONSTRUCTOR_INVALID_MEMORY_CONFIG",domain:"MASTRA",category:"USER",text:`
  Memory should be added to Agents, not to Mastra.

Instead of:
  new Mastra({ memory: new Memory() })

do:
  new Agent({ memory: new Memory() })
`});throw this.#e1?.trackException(e),e}e?.tts&&(this.#e4=e.tts,Object.entries(this.#e4).forEach(([e,t])=>{this.#e4?.[e]&&this.#e9&&(this.#e4[e]=this.#e9.traceClass(t,{excludeMethods:["__setTelemetry","__getTelemetry"]}),this.#e4[e].__setTelemetry(this.#e9))}));const i={};e?.agents&&Object.entries(e.agents).forEach(([e,t])=>{if(i[e]){let t=new tv({id:"MASTRA_AGENT_REGISTRATION_DUPLICATE_ID",domain:"MASTRA",category:"USER",text:`Agent with name ID:${e} already exists`,details:{agentId:e}});throw this.#e1?.trackException(t),t}t.__registerMastra(this),t.__registerPrimitives({logger:this.getLogger(),telemetry:this.#e9,storage:this.storage,memory:this.memory,agents:i,tts:this.#e4,vectors:this.#e0}),i[e]=t}),this.#ed=i;const o={};e?.scorers&&Object.entries(e.scorers).forEach(([e,t])=>{o[e]=t}),this.#eu=o,this.#e2={},e?.legacy_workflows&&Object.entries(e.legacy_workflows).forEach(([e,t])=>{t.__registerMastra(this),t.__registerPrimitives({logger:this.getLogger(),telemetry:this.#e9,storage:this.storage,memory:this.memory,agents:i,tts:this.#e4,vectors:this.#e0}),this.#e2[e]=t;let r=Object.values(t.steps).filter(e=>!!e.workflowId&&!!e.workflow);r.length>0&&r.forEach(e=>{this.#e2[e.workflowId]=e.workflow})}),this.#es={},e?.workflows&&Object.entries(e.workflows).forEach(([e,t])=>{t.__registerMastra(this),t.__registerPrimitives({logger:this.getLogger(),telemetry:this.#e9,storage:this.storage,memory:this.memory,agents:i,tts:this.#e4,vectors:this.#e0}),this.#es[e]=t}),e?.server&&(this.#e8=e.server),t=function(e){return async t=>{let r=e.getStorage();if(!r)return void e.getLogger()?.warn("Storage not found, skipping score validation and saving");let a=t.entity.id,s=t.entityType,n=t.scorer;try{let i=await IG(e,a,s,n.name);if(!i)throw new tv({id:"MASTRA_SCORER_NOT_FOUND",domain:"MASTRA",category:"USER",text:`Scorer with ID ${t.scorer.id} not found`});let o=t.input,l=t.output,{structuredOutput:u,...d}=t,p=await i.scorer.run({...d,input:o,output:l}),c={...d,...p,entityId:a,scorerId:t.scorer.name,metadata:{structuredOutput:!!u}};await IW(r,c)}catch(r){let t=new tv({id:"MASTRA_SCORER_FAILED_TO_RUN_HOOK",domain:"SCORER",category:"USER",details:{scorerId:n.id,entityId:a,entityType:s}},r);e.getLogger()?.trackException(t),e.getLogger()?.error(t.toString())}}}(this),wD.on("onScorerRun",t),e?.observability&&(this.registerAITracingExporters(),this.initAITracingExporters()),this.setLogger({logger:r})}registerAITracingExporters(){lJ().forEach(e=>{e.getExporters().forEach(e=>{"__registerMastra"in e&&"function"==typeof e.__registerMastra&&e.__registerMastra(this)})})}initAITracingExporters(){lJ().forEach(e=>{let t=e.getConfig();e.getExporters().forEach(e=>{if("init"in e&&"function"==typeof e.init)try{e.init(t)}catch(t){this.#e1?.warn("Failed to initialize AI tracing exporter",{exporterName:e.name,error:t instanceof Error?t.message:String(t)})}})})}getAgent(e){if(!this.#ed?.[e]){let t=new tv({id:"MASTRA_GET_AGENT_BY_NAME_NOT_FOUND",domain:"MASTRA",category:"USER",text:`Agent with name ${String(e)} not found`,details:{status:404,agentName:String(e),agents:Object.keys(this.#ed??{}).join(", ")}});throw this.#e1?.trackException(t),t}return this.#ed[e]}getAgentById(e){let t=Object.values(this.#ed).find(t=>t.id===e);if(!t)try{t=this.getAgent(e)}catch{}if(!t){let t=new tv({id:"MASTRA_GET_AGENT_BY_AGENT_ID_NOT_FOUND",domain:"MASTRA",category:"USER",text:`Agent with id ${String(e)} not found`,details:{status:404,agentId:String(e),agents:Object.keys(this.#ed??{}).join(", ")}});throw this.#e1?.trackException(t),t}return t}getAgents(){return this.#ed}getVector(e){let t=this.#e0?.[e];if(!t){let t=new tv({id:"MASTRA_GET_VECTOR_BY_NAME_NOT_FOUND",domain:"MASTRA",category:"USER",text:`Vector with name ${String(e)} not found`,details:{status:404,vectorName:String(e),vectors:Object.keys(this.#e0??{}).join(", ")}});throw this.#e1?.trackException(t),t}return t}getVectors(){return this.#e0}getDeployer(){return this.#e5}legacy_getWorkflow(e,{serialized:t}={}){let r=this.#e2?.[e];if(!r){let t=new tv({id:"MASTRA_GET_LEGACY_WORKFLOW_BY_ID_NOT_FOUND",domain:"MASTRA",category:"USER",text:`Workflow with ID ${String(e)} not found`,details:{status:404,workflowId:String(e),workflows:Object.keys(this.#e2??{}).join(", ")}});throw this.#e1?.trackException(t),t}return t?{name:r.name}:r}getWorkflow(e,{serialized:t}={}){let r=this.#es?.[e];if(!r){let t=new tv({id:"MASTRA_GET_WORKFLOW_BY_ID_NOT_FOUND",domain:"MASTRA",category:"USER",text:`Workflow with ID ${String(e)} not found`,details:{status:404,workflowId:String(e),workflows:Object.keys(this.#es??{}).join(", ")}});throw this.#e1?.trackException(t),t}return t?{name:r.name}:r}__registerInternalWorkflow(e){e.__registerMastra(this),e.__registerPrimitives({logger:this.getLogger(),storage:this.storage}),this.#ts[e.id]=e}__hasInternalWorkflow(e){return Object.values(this.#ts).some(t=>t.id===e)}__getInternalWorkflow(e){let t=Object.values(this.#ts).find(t=>t.id===e);if(!t)throw new tv({id:"MASTRA_GET_INTERNAL_WORKFLOW_BY_ID_NOT_FOUND",domain:"MASTRA",category:"SYSTEM",text:`Workflow with id ${String(e)} not found`,details:{status:404,workflowId:String(e)}});return t}getWorkflowById(e){let t=Object.values(this.#es).find(t=>t.id===e);if(!t)try{t=this.getWorkflow(e)}catch{}if(!t){let t=new tv({id:"MASTRA_GET_WORKFLOW_BY_ID_NOT_FOUND",domain:"MASTRA",category:"USER",text:`Workflow with id ${String(e)} not found`,details:{status:404,workflowId:String(e),workflows:Object.keys(this.#es??{}).join(", ")}});throw this.#e1?.trackException(t),t}return t}legacy_getWorkflows(e={}){return e.serialized?Object.entries(this.#e2).reduce((e,[t,r])=>({...e,[t]:{name:r.name}}),{}):this.#e2}getScorers(){return this.#eu}getScorer(e){let t=this.#eu?.[e];if(!t){let t=new tv({id:"MASTRA_GET_SCORER_NOT_FOUND",domain:"MASTRA",category:"USER",text:`Scorer with ${String(e)} not found`});throw this.#e1?.trackException(t),t}return t}getScorerByName(e){for(let[t,r]of Object.entries(this.#eu??{}))if(r.name===e)return r;let t=new tv({id:"MASTRA_GET_SCORER_BY_NAME_NOT_FOUND",domain:"MASTRA",category:"USER",text:`Scorer with name ${String(e)} not found`});throw this.#e1?.trackException(t),t}getWorkflows(e={}){return e.serialized?Object.entries(this.#es).reduce((e,[t,r])=>({...e,[t]:{name:r.name}}),{}):this.#es}setStorage(e){this.#e6=Iz(e)}setLogger({logger:e}){this.#e1=e,this.#ed&&Object.keys(this.#ed).forEach(e=>{this.#ed?.[e]?.__setLogger(this.#e1)}),this.#ea&&this.#ea.__setLogger(this.#e1),this.#e5&&this.#e5.__setLogger(this.#e1),this.#e4&&Object.keys(this.#e4).forEach(e=>{this.#e4?.[e]?.__setLogger(this.#e1)}),this.#e6&&this.#e6.__setLogger(this.#e1),this.#e0&&Object.keys(this.#e0).forEach(e=>{this.#e0?.[e]?.__setLogger(this.#e1)}),this.#e7&&Object.keys(this.#e7).forEach(e=>{this.#e7?.[e]?.__setLogger(this.#e1)}),lJ().forEach(e=>{e.__setLogger(this.#e1)})}setTelemetry(e){if(this.#e9=tA.init(e),this.#ed&&Object.keys(this.#ed).forEach(e=>{this.#e9&&this.#ed?.[e]?.__setTelemetry(this.#e9)}),this.#ea&&(this.#ea=this.#e9.traceClass(this.#ea,{excludeMethods:["__setTelemetry","__getTelemetry"]}),this.#ea.__setTelemetry(this.#e9)),this.#e5&&(this.#e5=this.#e9.traceClass(this.#e5,{excludeMethods:["__setTelemetry","__getTelemetry"]}),this.#e5.__setTelemetry(this.#e9)),this.#e4){let e={};Object.entries(this.#e4).forEach(([t,r])=>{this.#e9&&(e[t]=this.#e9.traceClass(r,{excludeMethods:["__setTelemetry","__getTelemetry"]}),e[t].__setTelemetry(this.#e9))}),this.#e4=e}if(this.#e6&&(this.#e6=this.#e9.traceClass(this.#e6,{excludeMethods:["__setTelemetry","__getTelemetry"]}),this.#e6.__setTelemetry(this.#e9)),this.#e0){let e={};Object.entries(this.#e0).forEach(([t,r])=>{this.#e9&&(e[t]=this.#e9.traceClass(r,{excludeMethods:["__setTelemetry","__getTelemetry"]}),e[t].__setTelemetry(this.#e9))}),this.#e0=e}}getTTS(){return this.#e4}getLogger(){return this.#e1}getTelemetry(){return this.#e9}getMemory(){return this.#ea}getStorage(){return this.#e6}getServerMiddleware(){return this.#e3}getServerCache(){return this.#tn}setServerMiddleware(e){if("function"==typeof e){this.#e3=[{handler:e,path:"/api/*"}];return}if(!Array.isArray(e)){let t=new tv({id:"MASTRA_SET_SERVER_MIDDLEWARE_INVALID_TYPE",domain:"MASTRA",category:"USER",text:`Invalid middleware: expected a function or array, received ${typeof e}`});throw this.#e1?.trackException(t),t}this.#e3=e.map(e=>"function"==typeof e?{handler:e,path:"/api/*"}:{handler:e.handler,path:e.path||"/api/*"})}getServer(){return this.#e8}getBundlerConfig(){return this.#te}async getLogsByRunId({runId:e,transportId:t,fromDate:r,toDate:a,logLevel:s,filters:n,page:i,perPage:o}){if(!t){let r=new tv({id:"MASTRA_GET_LOGS_BY_RUN_ID_MISSING_TRANSPORT",domain:"MASTRA",category:"USER",text:"Transport ID is required",details:{runId:e,transportId:t}});throw this.#e1?.trackException(r),r}if(!this.#e1?.getLogsByRunId){let r=new tv({id:"MASTRA_GET_LOGS_BY_RUN_ID_LOGGER_NOT_CONFIGURED",domain:"MASTRA",category:"SYSTEM",text:"Logger is not configured or does not support getLogsByRunId operation",details:{runId:e,transportId:t}});throw this.#e1?.trackException(r),r}return await this.#e1.getLogsByRunId({runId:e,transportId:t,fromDate:r,toDate:a,logLevel:s,filters:n,page:i,perPage:o})}async getLogs(e,t){if(!e){let t=new tv({id:"MASTRA_GET_LOGS_MISSING_TRANSPORT",domain:"MASTRA",category:"USER",text:"Transport ID is required",details:{transportId:e}});throw this.#e1?.trackException(t),t}if(!this.#e1)throw new tv({id:"MASTRA_GET_LOGS_LOGGER_NOT_CONFIGURED",domain:"MASTRA",category:"SYSTEM",text:"Logger is not set",details:{transportId:e}});return await this.#e1.getLogs(e,t)}getMCPServers(){return this.#e7}getMCPServer(e,t){if(!this.#e7)return;let r=Object.values(this.#e7||{}).filter(t=>t.id===e);if(0===r.length)return void this.#e1?.debug(`No MCP servers found with logical ID: ${e}`);if(t){let a=r.find(e=>e.version===t);return a||this.#e1?.debug(`MCP server with logical ID '${e}' found, but not version '${t}'.`),a}if(1===r.length)return r[0];if(r.sort((e,t)=>{let r=e.releaseDate&&"string"==typeof e.releaseDate?new Date(e.releaseDate).getTime():NaN,a=t.releaseDate&&"string"==typeof t.releaseDate?new Date(t.releaseDate).getTime():NaN;return isNaN(r)&&isNaN(a)?0:isNaN(r)?1:isNaN(a)?-1:a-r}),r.length>0){let e=r[0];if(e&&e.releaseDate&&"string"==typeof e.releaseDate&&!isNaN(new Date(e.releaseDate).getTime()))return e}this.#e1?.warn(`Could not determine the latest server for logical ID '${e}' due to invalid or missing release dates, or no servers left after filtering.`)}async addTopicListener(e,t){await this.#tr.subscribe(e,t)}async removeTopicListener(e,t){await this.#tr.unsubscribe(e,t)}async startEventEngine(){for(let e in this.#ta)if(this.#ta[e])for(let t of Array.isArray(this.#ta[e])?this.#ta[e]:[this.#ta[e]])await this.#tr.subscribe(e,t)}async stopEventEngine(){for(let e in this.#ta)if(this.#ta[e])for(let t of Array.isArray(this.#ta[e])?this.#ta[e]:[this.#ta[e]])await this.#tr.unsubscribe(e,t);await this.#tr.flush()}async shutdown(){await lK(),await this.stopEventEngine(),this.#e1?.info("Mastra shutdown completed")}get serverCache(){return this.#tn}};IB=tX(e5=tK(null),0,"Mastra",e4,IB),tQ(e5,1,IB);var IK=e.i(713439);let IJ=rs({id:"parse-csv",description:"Parse CSV data and extract headers, sample rows, and basic statistics",inputSchema:rb.z.object({csvContent:rb.z.string().describe("Raw CSV file content as a string"),sampleSize:rb.z.number().optional().default(5).describe("Number of sample rows to extract (default: 5)")}),outputSchema:rb.z.object({headers:rb.z.array(rb.z.string()).describe("Column headers from the CSV"),sampleRows:rb.z.array(rb.z.record(rb.z.string(),rb.z.string())).describe("Sample data rows from the CSV"),totalRows:rb.z.number().describe("Total number of data rows in the CSV"),dataTypes:rb.z.record(rb.z.string(),rb.z.string()).describe("Detected data types for each column")}),execute:async({context:e})=>{let{csvContent:t,sampleSize:r}=e;return new Promise((e,a)=>{IK.default.parse(t,{header:!0,skipEmptyLines:!0,dynamicTyping:!0,complete:t=>{let a=t.meta.fields||[],s=t.data,n=s.slice(0,r),i=n.map(e=>{let t={};return Object.entries(e).forEach(([e,r])=>{t[e]=String(r??"")}),t}),o={};a.forEach(e=>{let t=n.map(t=>t[e]).filter(e=>null!=e&&""!==e);if(0===t.length)o[e]="unknown";else{let r=t[0];"number"==typeof r?o[e]="number":"boolean"==typeof r?o[e]="boolean":"string"!=typeof r||isNaN(Date.parse(r))?o[e]="string":o[e]="date"}}),e({headers:a,sampleRows:i,totalRows:s.length,dataTypes:o})},error:e=>{a(Error(`Failed to parse CSV: ${e.message}`))}})})}}),IH={companyName:{type:"string",required:!0},status:{type:"enum",required:!0,options:["lead","prospect","active","inactive","archived"]},emailOptIn:{type:"boolean",required:!0},smsOptIn:{type:"boolean",required:!0},industry:{type:"string",required:!1},companyDescription:{type:"string",required:!1},leadSource:{type:"enum",required:!1,options:["word-of-mouth","website","social-media","referral","advertising","trade-show","cold-outreach","other"]},category:{type:"enum",required:!1,options:["design","development","consulting","maintenance","marketing","other"]},clientSize:{type:"enum",required:!1,options:["small","medium","large","enterprise"]},clientType:{type:"enum",required:!1,options:["new-client","existing-client","partner","vendor","contractor"]},isActive:{type:"boolean",required:!1},priorityLevel:{type:"enum",required:!1,options:["low","medium","high","urgent"]},projectDimensions:{type:"string",required:!1},communicationPreference:{type:"enum",required:!1,options:["email","phone","both"]},servicesNeeded:{type:"array",required:!1},tags:{type:"array",required:!1},notes:{type:"string",required:!1}},IY={title:{type:"string",required:!0},status:{type:"enum",required:!0,options:["planned","in-progress","completed","cancelled"]},projectType:{type:"enum",required:!0,options:["one-off","recurring"]},clientId:{type:"id",required:!0},description:{type:"string",required:!1},instructions:{type:"string",required:!1},projectNumber:{type:"string",required:!1},startDate:{type:"number",required:!1},endDate:{type:"number",required:!1},salespersonId:{type:"id",required:!1},assignedUserIds:{type:"array",required:!1},invoiceReminderEnabled:{type:"boolean",required:!1},scheduleForLater:{type:"boolean",required:!1}},IQ=rs({id:"map-schema",description:"Map CSV column headers to Convex schema fields for clients or projects. Returns field mappings with confidence scores.",inputSchema:rb.z.object({entityType:rb.z.enum(["clients","projects"]).describe("Type of entity to map (clients or projects)"),headers:rb.z.array(rb.z.string()).describe("CSV column headers to map to schema fields"),sampleRows:rb.z.array(rb.z.record(rb.z.string(),rb.z.string())).optional().describe("Optional sample data rows for context")}),outputSchema:rb.z.object({mappings:rb.z.array(rb.z.object({csvColumn:rb.z.string(),schemaField:rb.z.string(),confidence:rb.z.number().min(0).max(1),dataType:rb.z.string(),isRequired:rb.z.boolean(),sampleValue:rb.z.string().optional()})).describe("Proposed mappings from CSV columns to schema fields"),unmappedColumns:rb.z.array(rb.z.string()).describe("CSV columns that couldn't be mapped"),missingRequiredFields:rb.z.array(rb.z.string()).describe("Required schema fields not found in CSV")}),execute:async({context:e})=>{let{entityType:t,headers:r,sampleRows:a}=e,s="clients"===t?IH:IY,n=[],i=[],o=new Set;return r.forEach(e=>{let t=e.toLowerCase().trim().replace(/[_\s\-?]/g,""),r=null;if(Object.entries(s).forEach(([e,a])=>{let s=e.toLowerCase().replace(/[_\s]/g,""),n=0;t===s?n=1:t.includes(s)||s.includes(t)?n=.8:("name"===t||"company"===t)&&"companyName"===e?n=.9:"client"===t&&("clientId"===e||"companyName"===e)&&(n=.7);let i="object"==typeof a&&"type"in a?a.type:"string",o="object"==typeof a&&"required"in a&&a.required;n>0&&(!r||n>r.confidence)&&(r={field:e,confidence:n,dataType:String(i),isRequired:!!o})}),r){let t=r;if(t.confidence>=.7){let r=a?.[0]?.[e];n.push({csvColumn:e,schemaField:t.field,confidence:t.confidence,dataType:t.dataType,isRequired:t.isRequired,sampleValue:null!=r?String(r):void 0}),o.add(t.field)}else i.push(e)}else i.push(e)}),{mappings:n,unmappedColumns:i,missingRequiredFields:Object.entries(s).filter(([e,t])=>t.required&&!o.has(e)).map(([e])=>e)}}}),IX=rs({id:"validate-data",description:"Validate mapped CSV data against schema requirements. Checks for required fields, data types, and enum values.",inputSchema:rb.z.object({entityType:rb.z.enum(["clients","projects"]).describe("Type of entity being validated"),mappings:rb.z.array(rb.z.object({csvColumn:rb.z.string(),schemaField:rb.z.string(),confidence:rb.z.number(),dataType:rb.z.string(),isRequired:rb.z.boolean()})).describe("Field mappings to validate"),sampleRows:rb.z.array(rb.z.record(rb.z.string(),rb.z.string())).optional().describe("Optional sample data rows for validation")}),outputSchema:rb.z.object({isValid:rb.z.boolean().describe("Whether the data passes all validations"),errors:rb.z.array(rb.z.object({field:rb.z.string(),message:rb.z.string(),severity:rb.z.enum(["error","warning"])})).describe("Validation errors found"),missingRequiredFields:rb.z.array(rb.z.string()).describe("Required fields that are missing"),suggestedDefaults:rb.z.record(rb.z.string(),rb.z.union([rb.z.string(),rb.z.boolean(),rb.z.number()])).describe("Suggested default values for missing fields")}),execute:async({context:e})=>{let{entityType:t,mappings:r,sampleRows:a}=e,s="clients"===t?IH:IY,n=[],i=[],o={};Object.entries(s).forEach(([e,t])=>{t.required&&(r.some(t=>t.schemaField===e&&t.confidence>=.7)||(i.push(e),n.push({field:e,message:`Required field "${e}" is not mapped`,severity:"error"})))}),a&&a.length>0&&r.forEach(e=>{let t=s[e.schemaField];if(t&&"options"in t&&Array.isArray(t.options)){let r=a[0]?.[e.csvColumn],s=t.options;r&&!s.includes(r)&&n.push({field:e.schemaField,message:`Value "${r}" is not valid for ${e.schemaField}. Expected one of: ${s.join(", ")}`,severity:"warning"})}}),"clients"===t?(i.includes("status")&&(o.status="lead"),i.includes("emailOptIn")&&(o.emailOptIn=!1),i.includes("smsOptIn")&&(o.smsOptIn=!1)):"projects"===t&&(i.includes("status")&&(o.status="planned"),i.includes("projectType")&&(o.projectType="one-off")),r.forEach(e=>{e.confidence<.8&&e.isRequired&&n.push({field:e.schemaField,message:`Low confidence mapping (${Math.round(100*e.confidence)}%) for required field "${e.schemaField}"`,severity:"warning"})});let l=n.filter(e=>"error"===e.severity),u=n.filter(e=>"warning"===e.severity);return{isValid:0===i.length&&0===l.length,errors:l,warnings:u,missingRequiredFields:i,suggestedDefaults:o}}}),I0=new IB({agents:{csvImportAgent:new If({name:"CSV Import Agent",instructions:`You are an AI assistant specialized in analyzing CSV files and mapping them to database schemas.

Your primary responsibilities:
1. Parse CSV files and understand their structure
2. Intelligently map CSV columns to schema fields for clients or projects
3. Validate data against schema requirements
4. Suggest sensible defaults for missing required fields
5. Identify potential data quality issues

When analyzing a CSV file:
- Use the parse-csv tool to extract headers and sample data
- Determine if the data represents clients or projects based on the columns
- Use the map-schema tool to create field mappings with confidence scores
- Use the validate-data tool to check for required fields and data validity
- Provide clear feedback about any issues or missing required fields

For client data, required fields are:
- companyName (string)
- status (enum: lead, prospect, active, inactive, archived)
- emailOptIn (boolean)
- smsOptIn (boolean)

Optional client fields include:
- industry, companyDescription, notes (strings)
- leadSource, category, clientSize, clientType, priorityLevel, communicationPreference (enums)
- isActive (boolean)
- projectDimensions (string)
- servicesNeeded, tags (arrays - can be semicolon, comma, or pipe-separated in CSV)

For project data, required fields are:
- title (string)
- status (enum: planned, in-progress, completed, cancelled)
- projectType (enum: one-off, recurring)
- clientId (can be resolved from client name)

Always suggest appropriate defaults for missing required fields:
- For clients: status="lead", emailOptIn=false, smsOptIn=false
- For projects: status="planned", projectType="one-off"

For array fields (servicesNeeded, tags, assignedUserIds):
- These should be comma, semicolon, or pipe-separated values in the CSV
- They will be automatically split into arrays during import

Be helpful and provide actionable feedback to users about their data quality.`,model:"openai/gpt-4o",tools:{parseCsv:IJ,mapSchema:IQ,validateData:IX}})}});async function I1(e){try{let{csvContent:t,entityType:r}=await e.json();if(!t||"string"!=typeof t)return th.NextResponse.json({error:"CSV content is required"},{status:400});if(t.length>5242880)return th.NextResponse.json({error:"File size exceeds 5MB limit"},{status:400});if(r&&!["clients","projects"].includes(r))return th.NextResponse.json({error:'Entity type must be "clients" or "projects"'},{status:400});let a=I0.getAgent("csvImportAgent");if(!a)return th.NextResponse.json({error:"CSV import agent not found"},{status:500});let s=r?`Analyze this CSV file for ${r} data. Parse the CSV, map the columns to the schema fields, and validate the data. Here's the CSV content:

${t}`:`Analyze this CSV file and determine if it contains client or project data. Then parse, map, and validate accordingly. Here's the CSV content:

${t}`;console.log("Calling agent with prompt length:",s.length);let n=await a.generate(s,{maxSteps:10});console.log("Agent response received");let i=n.toolResults?.find(e=>e.payload?.toolName==="parseCsv")?.payload?.result,o=n.toolResults?.find(e=>e.payload?.toolName==="mapSchema")?.payload?.result,l=n.toolResults?.find(e=>e.payload?.toolName==="validateData")?.payload?.result;console.log("Parse result:",i),console.log("Map result:",o),console.log("Validate result:",l);let u={entityType:r||"clients",detectedFields:o?.mappings||[],validation:l?{isValid:l.isValid,errors:l.errors,warnings:l.warnings,missingRequiredFields:l.missingRequiredFields}:{isValid:!1,errors:[],warnings:[],missingRequiredFields:o?.missingRequiredFields||[]},suggestedDefaults:l?.suggestedDefaults||{},confidence:.8,sampleData:i?.sampleRows||[]};return th.NextResponse.json(u)}catch(e){return console.error("Error analyzing CSV:",e),console.error("Error stack:",e instanceof Error?e.stack:"No stack"),console.error("Error details:",JSON.stringify(e,null,2)),th.NextResponse.json({error:"Failed to analyze CSV",details:e instanceof Error?e.message:"Unknown error",errorType:e instanceof Error?e.constructor.name:typeof e},{status:500})}}e.s(["POST",()=>I1],303259);var I2=e.i(303259);let I4=new e3.AppRouteRouteModule({definition:{kind:e9.RouteKind.APP_ROUTE,page:"/api/analyze-csv/route",pathname:"/api/analyze-csv",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/apps/web/src/app/api/analyze-csv/route.ts",nextConfigOutput:"",userland:I2}),{workAsyncStorage:I5,workUnitAsyncStorage:I3,serverHooks:I9}=I4;function I6(){return(0,e6.patchFetch)({workAsyncStorage:I5,workUnitAsyncStorage:I3})}async function I8(e,t,r){I4.isDev&&(0,e8.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let a="/api/analyze-csv/route";a=a.replace(/\/index$/,"")||"/";let s=await I4.prepare(e,t,{srcPage:a,multiZoneDraftMode:!1});if(!s)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:n,params:i,nextConfig:o,parsedUrl:l,isDraftMode:u,prerenderManifest:d,routerServerContext:p,isOnDemandRevalidate:c,revalidateOnlyGenerated:h,resolvedPathname:m,clientReferenceManifest:g,serverActionsManifest:f}=s,y=(0,tr.normalizeAppPath)(a),v=!!(d.dynamicRoutes[y]||d.routes[m]),b=async()=>((null==p?void 0:p.render404)?await p.render404(e,t,l,!1):t.end("This page could not be found"),null);if(v&&!u){let e=!!d.routes[m],t=d.dynamicRoutes[y];if(t&&!1===t.fallback&&!e){if(o.experimental.adapterPath)return await b();throw new tp.NoFallbackError}}let w=null;!v||I4.isDev||u||(w="/index"===(w=m)?"/":w);let _=!0===I4.isDev||!v,S=v&&!_;f&&g&&(0,te.setReferenceManifestsSingleton)({page:a,clientReferenceManifest:g,serverActionsManifest:f,serverModuleMap:(0,tt.createServerModuleMap)({serverActionsManifest:f})});let I=e.method||"GET",k=(0,e7.getTracer)(),T=k.getActiveScopeSpan(),E={params:i,prerenderManifest:d,renderOpts:{experimental:{authInterrupts:!!o.experimental.authInterrupts},cacheComponents:!!o.cacheComponents,supportsDynamicResponse:_,incrementalCache:(0,e8.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:o.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>I4.onRequestError(e,t,a,p)},sharedContext:{buildId:n}},A=new ta.NodeNextRequest(e),O=new ta.NodeNextResponse(t),C=ts.NextRequestAdapter.fromNodeNextRequest(A,(0,ts.signalFromNodeResponse)(t));try{let s=async e=>I4.handle(C,E).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=k.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==tn.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let s=r.get("next.route");if(s){let t=`${I} ${s}`;e.setAttributes({"next.route":s,"http.route":s,"next.span_name":t}),e.updateName(t)}else e.updateName(`${I} ${a}`)}),n=!!(0,e8.getRequestMeta)(e,"minimalMode"),i=async i=>{var l,m;let g=async({previousCacheEntry:o})=>{try{if(!n&&c&&h&&!o)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await s(i);e.fetchMetrics=E.renderOpts.fetchMetrics;let l=E.renderOpts.pendingWaitUntil;l&&r.waitUntil&&(r.waitUntil(l),l=void 0);let u=E.renderOpts.collectedTags;if(!v)return await (0,to.sendResponse)(A,O,a,E.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,tl.toNodeOutgoingHttpHeaders)(a.headers);u&&(t[td.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==E.renderOpts.collectedRevalidate&&!(E.renderOpts.collectedRevalidate>=td.INFINITE_CACHE)&&E.renderOpts.collectedRevalidate,s=void 0===E.renderOpts.collectedExpire||E.renderOpts.collectedExpire>=td.INFINITE_CACHE?void 0:E.renderOpts.collectedExpire;return{value:{kind:tc.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:s}}}}catch(t){throw(null==o?void 0:o.isStale)&&await I4.onRequestError(e,t,{routerKind:"App Router",routePath:a,routeType:"route",revalidateReason:(0,ti.getRevalidateReason)({isStaticGeneration:S,isOnDemandRevalidate:c})},p),t}},f=await I4.handleResponse({req:e,nextConfig:o,cacheKey:w,routeKind:e9.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:d,isRoutePPREnabled:!1,isOnDemandRevalidate:c,revalidateOnlyGenerated:h,responseGenerator:g,waitUntil:r.waitUntil,isMinimalMode:n});if(!v)return null;if((null==f||null==(l=f.value)?void 0:l.kind)!==tc.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==f||null==(m=f.value)?void 0:m.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});n||t.setHeader("x-nextjs-cache",c?"REVALIDATED":f.isMiss?"MISS":f.isStale?"STALE":"HIT"),u&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let y=(0,tl.fromNodeOutgoingHttpHeaders)(f.value.headers);return n&&v||y.delete(td.NEXT_CACHE_TAGS_HEADER),!f.cacheControl||t.getHeader("Cache-Control")||y.get("Cache-Control")||y.set("Cache-Control",(0,tu.getCacheControlHeader)(f.cacheControl)),await (0,to.sendResponse)(A,O,new Response(f.value.body,{headers:y,status:f.value.status||200})),null};T?await i(T):await k.withPropagatedContext(e.headers,()=>k.trace(tn.BaseServerSpan.handleRequest,{spanName:`${I} ${a}`,kind:e7.SpanKind.SERVER,attributes:{"http.method":I,"http.target":e.url}},i))}catch(t){if(t instanceof tp.NoFallbackError||await I4.onRequestError(e,t,{routerKind:"App Router",routePath:y,routeType:"route",revalidateReason:(0,ti.getRevalidateReason)({isStaticGeneration:S,isOnDemandRevalidate:c})}),v)throw t;return await (0,to.sendResponse)(A,O,new Response(null,{status:500})),null}}e.s(["handler",()=>I8,"patchFetch",()=>I6,"routeModule",()=>I4,"serverHooks",()=>I9,"workAsyncStorage",()=>I5,"workUnitAsyncStorage",()=>I3],805201)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__c8f55cad._.js.map